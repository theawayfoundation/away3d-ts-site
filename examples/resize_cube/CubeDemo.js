var away;(function(away){(function(events){var Event=(function(){function Event(type){this.type=undefined;this.target=undefined;this.type=type}Event.prototype.clone=function(){return new Event(this.type)};Event.COMPLETE="Event_Complete";Event.OPEN="Event_Open";Event.ENTER_FRAME="enterframe";Event.EXIT_FRAME="exitframe";Event.RESIZE="resize";Event.CONTEXT3D_CREATE="context3DCreate";Event.ERROR="error";Event.CHANGE="change";return Event})();events.Event=Event})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(events){var EventDispatcher=(function(){function EventDispatcher(){this.listeners=new Array()}EventDispatcher.prototype.addEventListener=function(type,listener,target){if(this.listeners[type]===undefined){this.listeners[type]=new Array()}if(this.getEventListenerIndex(type,listener,target)===-1){var d=new EventData();d.listener=listener;d.type=type;d.target=target;this.listeners[type].push(d)}};EventDispatcher.prototype.removeEventListener=function(type,listener,target){var index=this.getEventListenerIndex(type,listener,target);if(index!==-1){this.listeners[type].splice(index,1)}};EventDispatcher.prototype.dispatchEvent=function(event){var listenerArray=this.listeners[event.type];if(listenerArray!==undefined){this.lFncLength=listenerArray.length;event.target=this;var eventData;for(var i=0,l=this.lFncLength;i<l;i++){eventData=listenerArray[i];eventData.listener.call(eventData.target,event)}}};EventDispatcher.prototype.getEventListenerIndex=function(type,listener,target){if(this.listeners[type]!==undefined){var a=this.listeners[type];var l=a.length;var d;for(var c=0;c<l;c++){d=a[c];if(target==d.target&&listener==d.listener){return c}}}return -1};EventDispatcher.prototype.hasEventListener=function(type,listener,target){if(typeof listener==="undefined"){listener=null}if(typeof target==="undefined"){target=null}if(this.listeners!=null&&target!=null){return(this.getEventListenerIndex(type,listener,target)!==-1)}else{if(this.listeners[type]!==undefined){var a=this.listeners[type];return(a.length>0)}return false}return false};return EventDispatcher})();events.EventDispatcher=EventDispatcher;var EventData=(function(){function EventData(){}return EventData})()})(away.events||(away.events={}));var events=away.events})(away||(away={}));var __extends=this.__extends||function(d,b){for(var p in b){if(b.hasOwnProperty(p)){d[p]=b[p]}}function __(){this.constructor=d}__.prototype=b.prototype;d.prototype=new __()};var away;(function(away){(function(events){var LightEvent=(function(_super){__extends(LightEvent,_super);function LightEvent(type){_super.call(this,type)}LightEvent.prototype.clone=function(){return new away.events.LightEvent(this.type)};LightEvent.CASTS_SHADOW_CHANGE="castsShadowChange";return LightEvent})(away.events.Event);events.LightEvent=LightEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(events){var AssetEvent=(function(_super){__extends(AssetEvent,_super);function AssetEvent(type,asset,prevName){if(typeof asset==="undefined"){asset=null}if(typeof prevName==="undefined"){prevName=null}_super.call(this,type);this._asset=asset;this._prevName=prevName||(this._asset?this._asset.name:null)}Object.defineProperty(AssetEvent.prototype,"asset",{get:function(){return this._asset},enumerable:true,configurable:true});Object.defineProperty(AssetEvent.prototype,"assetPrevName",{get:function(){return this._prevName},enumerable:true,configurable:true});AssetEvent.prototype.clone=function(){return new away.events.AssetEvent(this.type,this.asset,this.assetPrevName)};AssetEvent.ASSET_COMPLETE="assetComplete";AssetEvent.ENTITY_COMPLETE="entityComplete";AssetEvent.SKYBOX_COMPLETE="skyboxComplete";AssetEvent.CAMERA_COMPLETE="cameraComplete";AssetEvent.MESH_COMPLETE="meshComplete";AssetEvent.GEOMETRY_COMPLETE="geometryComplete";AssetEvent.SKELETON_COMPLETE="skeletonComplete";AssetEvent.SKELETON_POSE_COMPLETE="skeletonPoseComplete";AssetEvent.CONTAINER_COMPLETE="containerComplete";AssetEvent.TEXTURE_COMPLETE="textureComplete";AssetEvent.TEXTURE_PROJECTOR_COMPLETE="textureProjectorComplete";AssetEvent.MATERIAL_COMPLETE="materialComplete";AssetEvent.ANIMATOR_COMPLETE="animatorComplete";AssetEvent.ANIMATION_SET_COMPLETE="animationSetComplete";AssetEvent.ANIMATION_STATE_COMPLETE="animationStateComplete";AssetEvent.ANIMATION_NODE_COMPLETE="animationNodeComplete";AssetEvent.STATE_TRANSITION_COMPLETE="stateTransitionComplete";AssetEvent.SEGMENT_SET_COMPLETE="segmentSetComplete";AssetEvent.LIGHT_COMPLETE="lightComplete";AssetEvent.LIGHTPICKER_COMPLETE="lightPickerComplete";AssetEvent.EFFECTMETHOD_COMPLETE="effectMethodComplete";AssetEvent.SHADOWMAPMETHOD_COMPLETE="shadowMapMethodComplete";AssetEvent.ASSET_RENAME="assetRename";AssetEvent.ASSET_CONFLICT_RESOLVED="assetConflictResolved";AssetEvent.TEXTURE_SIZE_ERROR="textureSizeError";return AssetEvent})(away.events.Event);events.AssetEvent=AssetEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(library){var NamedAssetBase=(function(_super){__extends(NamedAssetBase,_super);function NamedAssetBase(name){if(typeof name==="undefined"){name=null}_super.call(this);if(name==null){name="null"}this._name=name;this._originalName=name;this.updateFullPath()}Object.defineProperty(NamedAssetBase.prototype,"originalName",{get:function(){return this._originalName},enumerable:true,configurable:true});Object.defineProperty(NamedAssetBase.prototype,"id",{get:function(){return this._id},set:function(newID){this._id=newID},enumerable:true,configurable:true});Object.defineProperty(NamedAssetBase.prototype,"assetType",{get:function(){return this._assetType},set:function(type){this._assetType=type},enumerable:true,configurable:true});Object.defineProperty(NamedAssetBase.prototype,"name",{get:function(){return this._name},set:function(val){var prev;prev=this._name;this._name=val;if(this._name==null){this._name="null"}this.updateFullPath();this.dispatchEvent(new away.events.AssetEvent(away.events.AssetEvent.ASSET_RENAME,this,prev))},enumerable:true,configurable:true});NamedAssetBase.prototype.dispose=function(){throw new away.errors.AbstractMethodError()};Object.defineProperty(NamedAssetBase.prototype,"assetNamespace",{get:function(){return this._namespace},enumerable:true,configurable:true});Object.defineProperty(NamedAssetBase.prototype,"assetFullPath",{get:function(){return this._full_path},enumerable:true,configurable:true});NamedAssetBase.prototype.assetPathEquals=function(name,ns){return(this._name==name&&(!ns||this._namespace==ns))};NamedAssetBase.prototype.resetAssetPath=function(name,ns,overrideOriginal){if(typeof ns==="undefined"){ns=null}if(typeof overrideOriginal==="undefined"){overrideOriginal=true}this._name=name?name:"null";this._namespace=ns?ns:NamedAssetBase.DEFAULT_NAMESPACE;if(overrideOriginal){this._originalName=this._name}this.updateFullPath()};NamedAssetBase.prototype.updateFullPath=function(){this._full_path=[this._namespace,this._name]};NamedAssetBase.DEFAULT_NAMESPACE="default";return NamedAssetBase})(away.events.EventDispatcher);library.NamedAssetBase=NamedAssetBase})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(geom){var Vector3D=(function(){function Vector3D(x,y,z,w){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}if(typeof z==="undefined"){z=0}if(typeof w==="undefined"){w=0}this.x=x;this.y=y;this.z=z;this.w=w}Object.defineProperty(Vector3D.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:true,configurable:true});Object.defineProperty(Vector3D.prototype,"lengthSquared",{get:function(){return(this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:true,configurable:true});Vector3D.prototype.add=function(a){return new Vector3D(this.x+a.x,this.y+a.y,this.z+a.z,this.w+a.w)};Vector3D.angleBetween=function(a,b){return Math.acos(a.dotProduct(b)/(a.length*b.length))};Vector3D.prototype.clone=function(){return new Vector3D(this.x,this.y,this.z,this.w)};Vector3D.prototype.copyFrom=function(src){return new Vector3D(src.x,src.y,src.z,src.w)};Vector3D.prototype.crossProduct=function(a){return new Vector3D(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)};Vector3D.prototype.decrementBy=function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z};Vector3D.distance=function(pt1,pt2){var x=(pt1.x-pt2.x);var y=(pt1.y-pt2.y);var z=(pt1.z-pt2.z);return Math.sqrt(x*x+y*y+z*z)};Vector3D.prototype.dotProduct=function(a){return this.x*a.x+this.y*a.y+this.z*a.z};Vector3D.prototype.equals=function(cmp,allFour){if(typeof allFour==="undefined"){allFour=false}return(this.x==cmp.x&&this.y==cmp.y&&this.z==cmp.z&&(!allFour||this.w==cmp.w))};Vector3D.prototype.incrementBy=function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z};Vector3D.prototype.nearEquals=function(cmp,epsilon,allFour){if(typeof allFour==="undefined"){allFour=true}return((Math.abs(this.x-cmp.x)<epsilon)&&(Math.abs(this.y-cmp.y)<epsilon)&&(Math.abs(this.z-cmp.z)<epsilon)&&(!allFour||Math.abs(this.w-cmp.w)<epsilon))};Vector3D.prototype.negate=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z};Vector3D.prototype.normalize=function(){var invLength=1/this.length;if(invLength!=0){this.x*=invLength;this.y*=invLength;this.z*=invLength;return}throw"Cannot divide by zero."};Vector3D.prototype.project=function(){this.x/=this.w;this.y/=this.w;this.z/=this.w};Vector3D.prototype.scaleBy=function(s){this.x*=s;this.y*=s;this.z*=s};Vector3D.prototype.setTo=function(xa,ya,za){this.x=xa;this.y=ya;this.z=za};Vector3D.prototype.subtract=function(a){return new Vector3D(this.x-a.x,this.y-a.y,this.z-a.z)};Vector3D.prototype.toString=function(){return"[Vector3D] (x:"+this.x+" ,y:"+this.y+", z"+this.z+", w:"+this.w+")"};Vector3D.X_AXIS=new Vector3D(1,0,0);Vector3D.Y_AXIS=new Vector3D(0,1,0);Vector3D.Z_AXIS=new Vector3D(0,0,1);return Vector3D})();geom.Vector3D=Vector3D})(away.geom||(away.geom={}));var geom=away.geom})(away||(away={}));var away;(function(away){(function(errors){var Error=(function(){function Error(message,id,_name){if(typeof message==="undefined"){message=""}if(typeof id==="undefined"){id=0}if(typeof _name==="undefined"){_name=""}this._errorID=0;this._messsage="";this._name="";this._messsage=message;this._name=name;this._errorID=id}Object.defineProperty(Error.prototype,"message",{get:function(){return this._messsage},set:function(value){this._messsage=value},enumerable:true,configurable:true});Object.defineProperty(Error.prototype,"name",{get:function(){return this._name},set:function(value){this._name=value},enumerable:true,configurable:true});Object.defineProperty(Error.prototype,"errorID",{get:function(){return this._errorID},enumerable:true,configurable:true});return Error})();errors.Error=Error})(away.errors||(away.errors={}));var errors=away.errors})(away||(away={}));var away;(function(away){(function(errors){var ArgumentError=(function(_super){__extends(ArgumentError,_super);function ArgumentError(message,id){if(typeof message==="undefined"){message=null}if(typeof id==="undefined"){id=0}_super.call(this,message||"ArgumentError",id)}return ArgumentError})(errors.Error);errors.ArgumentError=ArgumentError})(away.errors||(away.errors={}));var errors=away.errors})(away||(away={}));var away;(function(away){(function(geom){var Matrix3D=(function(){function Matrix3D(v){if(typeof v==="undefined"){v=null}if(v!=null&&v.length==16){this.rawData=v}else{this.rawData=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}}Matrix3D.prototype.append=function(lhs){var m111=this.rawData[0],m121=this.rawData[4],m131=this.rawData[8],m141=this.rawData[12],m112=this.rawData[1],m122=this.rawData[5],m132=this.rawData[9],m142=this.rawData[13],m113=this.rawData[2],m123=this.rawData[6],m133=this.rawData[10],m143=this.rawData[14],m114=this.rawData[3],m124=this.rawData[7],m134=this.rawData[11],m144=this.rawData[15],m211=lhs.rawData[0],m221=lhs.rawData[4],m231=lhs.rawData[8],m241=lhs.rawData[12],m212=lhs.rawData[1],m222=lhs.rawData[5],m232=lhs.rawData[9],m242=lhs.rawData[13],m213=lhs.rawData[2],m223=lhs.rawData[6],m233=lhs.rawData[10],m243=lhs.rawData[14],m214=lhs.rawData[3],m224=lhs.rawData[7],m234=lhs.rawData[11],m244=lhs.rawData[15];this.rawData[0]=m111*m211+m112*m221+m113*m231+m114*m241;this.rawData[1]=m111*m212+m112*m222+m113*m232+m114*m242;this.rawData[2]=m111*m213+m112*m223+m113*m233+m114*m243;this.rawData[3]=m111*m214+m112*m224+m113*m234+m114*m244;this.rawData[4]=m121*m211+m122*m221+m123*m231+m124*m241;this.rawData[5]=m121*m212+m122*m222+m123*m232+m124*m242;this.rawData[6]=m121*m213+m122*m223+m123*m233+m124*m243;this.rawData[7]=m121*m214+m122*m224+m123*m234+m124*m244;this.rawData[8]=m131*m211+m132*m221+m133*m231+m134*m241;this.rawData[9]=m131*m212+m132*m222+m133*m232+m134*m242;this.rawData[10]=m131*m213+m132*m223+m133*m233+m134*m243;this.rawData[11]=m131*m214+m132*m224+m133*m234+m134*m244;this.rawData[12]=m141*m211+m142*m221+m143*m231+m144*m241;this.rawData[13]=m141*m212+m142*m222+m143*m232+m144*m242;this.rawData[14]=m141*m213+m142*m223+m143*m233+m144*m243;this.rawData[15]=m141*m214+m142*m224+m143*m234+m144*m244};Matrix3D.prototype.appendRotation=function(degrees,axis){var m=Matrix3D.getAxisRotation(axis.x,axis.y,axis.z,degrees);this.append(m)};Matrix3D.prototype.appendScale=function(xScale,yScale,zScale){this.append(new Matrix3D([xScale,0,0,0,0,yScale,0,0,0,0,zScale,0,0,0,0,1]))};Matrix3D.prototype.appendTranslation=function(x,y,z){this.rawData[12]+=x;this.rawData[13]+=y;this.rawData[14]+=z};Matrix3D.prototype.clone=function(){return new Matrix3D(this.rawData.slice(0))};Matrix3D.prototype.copyColumnFrom=function(column,vector3D){switch(column){case 0:this.rawData[0]=vector3D.x;this.rawData[1]=vector3D.y;this.rawData[2]=vector3D.z;this.rawData[3]=vector3D.w;break;case 1:this.rawData[4]=vector3D.x;this.rawData[5]=vector3D.y;this.rawData[6]=vector3D.z;this.rawData[7]=vector3D.w;break;case 2:this.rawData[8]=vector3D.x;this.rawData[9]=vector3D.y;this.rawData[10]=vector3D.z;this.rawData[11]=vector3D.w;break;case 3:this.rawData[12]=vector3D.x;this.rawData[13]=vector3D.y;this.rawData[14]=vector3D.z;this.rawData[15]=vector3D.w;break;default:throw new away.errors.ArgumentError("ArgumentError, Column "+column+" out of bounds [0, ..., 3]")}};Matrix3D.prototype.copyColumnTo=function(column,vector3D){switch(column){case 0:vector3D.x=this.rawData[0];vector3D.y=this.rawData[1];vector3D.z=this.rawData[2];vector3D.w=this.rawData[3];break;case 1:vector3D.x=this.rawData[4];vector3D.y=this.rawData[5];vector3D.z=this.rawData[6];vector3D.w=this.rawData[7];break;case 2:vector3D.x=this.rawData[8];vector3D.y=this.rawData[9];vector3D.z=this.rawData[10];vector3D.w=this.rawData[11];break;case 3:vector3D.x=this.rawData[12];vector3D.y=this.rawData[13];vector3D.z=this.rawData[14];vector3D.w=this.rawData[15];break;default:throw new away.errors.ArgumentError("ArgumentError, Column "+column+" out of bounds [0, ..., 3]")}};Matrix3D.prototype.copyFrom=function(sourceMatrix3D){this.rawData=sourceMatrix3D.rawData.slice(0)};Matrix3D.prototype.copyRawDataFrom=function(vector){this.rawData=vector.splice(0)};Matrix3D.prototype.copyRawDataTo=function(vector,index,transpose){if(typeof index==="undefined"){index=0}if(typeof transpose==="undefined"){transpose=false}if(transpose){this.transpose()}var l=this.rawData.length;for(var c=0;c<l;c++){vector[c+index]=this.rawData[c]}if(transpose){this.transpose()}};Matrix3D.prototype.copyRowFrom=function(row,vector3D){switch(row){case 0:this.rawData[0]=vector3D.x;this.rawData[4]=vector3D.y;this.rawData[8]=vector3D.z;this.rawData[12]=vector3D.w;break;case 1:this.rawData[1]=vector3D.x;this.rawData[5]=vector3D.y;this.rawData[9]=vector3D.z;this.rawData[13]=vector3D.w;break;case 2:this.rawData[2]=vector3D.x;this.rawData[6]=vector3D.y;this.rawData[10]=vector3D.z;this.rawData[14]=vector3D.w;break;case 3:this.rawData[3]=vector3D.x;this.rawData[7]=vector3D.y;this.rawData[11]=vector3D.z;this.rawData[15]=vector3D.w;break;default:throw new away.errors.ArgumentError("ArgumentError, Row "+row+" out of bounds [0, ..., 3]")}};Matrix3D.prototype.copyRowTo=function(row,vector3D){switch(row){case 0:vector3D.x=this.rawData[0];vector3D.y=this.rawData[4];vector3D.z=this.rawData[8];vector3D.w=this.rawData[12];break;case 1:vector3D.x=this.rawData[1];vector3D.y=this.rawData[5];vector3D.z=this.rawData[9];vector3D.w=this.rawData[13];break;case 2:vector3D.x=this.rawData[2];vector3D.y=this.rawData[6];vector3D.z=this.rawData[10];vector3D.w=this.rawData[14];break;case 3:vector3D.x=this.rawData[3];vector3D.y=this.rawData[7];vector3D.z=this.rawData[11];vector3D.w=this.rawData[15];break;default:throw new away.errors.ArgumentError("ArgumentError, Row "+row+" out of bounds [0, ..., 3]")}};Matrix3D.prototype.copyToMatrix3D=function(dest){dest.rawData=this.rawData.slice(0)};Matrix3D.prototype.decompose=function(){var vec=[];var m=this.clone();var mr=m.rawData;var pos=new geom.Vector3D(mr[12],mr[13],mr[14]);mr[12]=0;mr[13]=0;mr[14]=0;var scale=new geom.Vector3D();scale.x=Math.sqrt(mr[0]*mr[0]+mr[1]*mr[1]+mr[2]*mr[2]);scale.y=Math.sqrt(mr[4]*mr[4]+mr[5]*mr[5]+mr[6]*mr[6]);scale.z=Math.sqrt(mr[8]*mr[8]+mr[9]*mr[9]+mr[10]*mr[10]);if(mr[0]*(mr[5]*mr[10]-mr[6]*mr[9])-mr[1]*(mr[4]*mr[10]-mr[6]*mr[8])+mr[2]*(mr[4]*mr[9]-mr[5]*mr[8])<0){scale.z=-scale.z}mr[0]/=scale.x;mr[1]/=scale.x;mr[2]/=scale.x;mr[4]/=scale.y;mr[5]/=scale.y;mr[6]/=scale.y;mr[8]/=scale.z;mr[9]/=scale.z;mr[10]/=scale.z;var rot=new geom.Vector3D();rot.y=Math.asin(-mr[2]);var cos=Math.cos(rot.y);if(cos>0){rot.x=Math.atan2(mr[6],mr[10]);rot.z=Math.atan2(mr[1],mr[0])}else{rot.z=0;rot.x=Math.atan2(mr[4],mr[5])}vec.push(pos);vec.push(rot);vec.push(scale);return vec};Matrix3D.prototype.deltaTransformVector=function(v){var x=v.x,y=v.y,z=v.z;return new geom.Vector3D((x*this.rawData[0]+y*this.rawData[1]+z*this.rawData[2]+this.rawData[3]),(x*this.rawData[4]+y*this.rawData[5]+z*this.rawData[6]+this.rawData[7]),(x*this.rawData[8]+y*this.rawData[9]+z*this.rawData[10]+this.rawData[11]),0)};Matrix3D.prototype.identity=function(){this.rawData=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]};Matrix3D.interpolate=function(thisMat,toMat,percent){var m=new Matrix3D();for(var i=0;i<16;++i){m.rawData[i]=thisMat.rawData[i]+(toMat.rawData[i]-thisMat.rawData[i])*percent}return m};Matrix3D.prototype.interpolateTo=function(toMat,percent){for(var i=0;i<16;++i){this.rawData[i]=this.rawData[i]+(toMat.rawData[i]-this.rawData[i])*percent}};Matrix3D.prototype.invert=function(){var d=this.determinant;var invertable=Math.abs(d)>1e-11;if(invertable){d=1/d;var m11=this.rawData[0];var m21=this.rawData[4];var m31=this.rawData[8];var m41=this.rawData[12];var m12=this.rawData[1];var m22=this.rawData[5];var m32=this.rawData[9];var m42=this.rawData[13];var m13=this.rawData[2];var m23=this.rawData[6];var m33=this.rawData[10];var m43=this.rawData[14];var m14=this.rawData[3];var m24=this.rawData[7];var m34=this.rawData[11];var m44=this.rawData[15];this.rawData[0]=d*(m22*(m33*m44-m43*m34)-m32*(m23*m44-m43*m24)+m42*(m23*m34-m33*m24));this.rawData[1]=-d*(m12*(m33*m44-m43*m34)-m32*(m13*m44-m43*m14)+m42*(m13*m34-m33*m14));this.rawData[2]=d*(m12*(m23*m44-m43*m24)-m22*(m13*m44-m43*m14)+m42*(m13*m24-m23*m14));this.rawData[3]=-d*(m12*(m23*m34-m33*m24)-m22*(m13*m34-m33*m14)+m32*(m13*m24-m23*m14));this.rawData[4]=-d*(m21*(m33*m44-m43*m34)-m31*(m23*m44-m43*m24)+m41*(m23*m34-m33*m24));this.rawData[5]=d*(m11*(m33*m44-m43*m34)-m31*(m13*m44-m43*m14)+m41*(m13*m34-m33*m14));this.rawData[6]=-d*(m11*(m23*m44-m43*m24)-m21*(m13*m44-m43*m14)+m41*(m13*m24-m23*m14));this.rawData[7]=d*(m11*(m23*m34-m33*m24)-m21*(m13*m34-m33*m14)+m31*(m13*m24-m23*m14));this.rawData[8]=d*(m21*(m32*m44-m42*m34)-m31*(m22*m44-m42*m24)+m41*(m22*m34-m32*m24));this.rawData[9]=-d*(m11*(m32*m44-m42*m34)-m31*(m12*m44-m42*m14)+m41*(m12*m34-m32*m14));this.rawData[10]=d*(m11*(m22*m44-m42*m24)-m21*(m12*m44-m42*m14)+m41*(m12*m24-m22*m14));this.rawData[11]=-d*(m11*(m22*m34-m32*m24)-m21*(m12*m34-m32*m14)+m31*(m12*m24-m22*m14));this.rawData[12]=-d*(m21*(m32*m43-m42*m33)-m31*(m22*m43-m42*m23)+m41*(m22*m33-m32*m23));this.rawData[13]=d*(m11*(m32*m43-m42*m33)-m31*(m12*m43-m42*m13)+m41*(m12*m33-m32*m13));this.rawData[14]=-d*(m11*(m22*m43-m42*m23)-m21*(m12*m43-m42*m13)+m41*(m12*m23-m22*m13));this.rawData[15]=d*(m11*(m22*m33-m32*m23)-m21*(m12*m33-m32*m13)+m31*(m12*m23-m22*m13))}return invertable};Matrix3D.prototype.prepend=function(rhs){var m111=rhs.rawData[0],m121=rhs.rawData[4],m131=rhs.rawData[8],m141=rhs.rawData[12],m112=rhs.rawData[1],m122=rhs.rawData[5],m132=rhs.rawData[9],m142=rhs.rawData[13],m113=rhs.rawData[2],m123=rhs.rawData[6],m133=rhs.rawData[10],m143=rhs.rawData[14],m114=rhs.rawData[3],m124=rhs.rawData[7],m134=rhs.rawData[11],m144=rhs.rawData[15],m211=this.rawData[0],m221=this.rawData[4],m231=this.rawData[8],m241=this.rawData[12],m212=this.rawData[1],m222=this.rawData[5],m232=this.rawData[9],m242=this.rawData[13],m213=this.rawData[2],m223=this.rawData[6],m233=this.rawData[10],m243=this.rawData[14],m214=this.rawData[3],m224=this.rawData[7],m234=this.rawData[11],m244=this.rawData[15];this.rawData[0]=m111*m211+m112*m221+m113*m231+m114*m241;this.rawData[1]=m111*m212+m112*m222+m113*m232+m114*m242;this.rawData[2]=m111*m213+m112*m223+m113*m233+m114*m243;this.rawData[3]=m111*m214+m112*m224+m113*m234+m114*m244;this.rawData[4]=m121*m211+m122*m221+m123*m231+m124*m241;this.rawData[5]=m121*m212+m122*m222+m123*m232+m124*m242;this.rawData[6]=m121*m213+m122*m223+m123*m233+m124*m243;this.rawData[7]=m121*m214+m122*m224+m123*m234+m124*m244;this.rawData[8]=m131*m211+m132*m221+m133*m231+m134*m241;this.rawData[9]=m131*m212+m132*m222+m133*m232+m134*m242;this.rawData[10]=m131*m213+m132*m223+m133*m233+m134*m243;this.rawData[11]=m131*m214+m132*m224+m133*m234+m134*m244;this.rawData[12]=m141*m211+m142*m221+m143*m231+m144*m241;this.rawData[13]=m141*m212+m142*m222+m143*m232+m144*m242;this.rawData[14]=m141*m213+m142*m223+m143*m233+m144*m243;this.rawData[15]=m141*m214+m142*m224+m143*m234+m144*m244};Matrix3D.prototype.prependRotation=function(degrees,axis){var m=Matrix3D.getAxisRotation(axis.x,axis.y,axis.z,degrees);this.prepend(m)};Matrix3D.prototype.prependScale=function(xScale,yScale,zScale){this.prepend(new Matrix3D([xScale,0,0,0,0,yScale,0,0,0,0,zScale,0,0,0,0,1]))};Matrix3D.prototype.prependTranslation=function(x,y,z){var m=new Matrix3D();m.position=new geom.Vector3D(x,y,z);this.prepend(m)};Matrix3D.prototype.recompose=function(components){if(components.length<3){return false}this.identity();this.appendScale(components[2].x,components[2].y,components[2].z);var angle;angle=-components[1].x;this.append(new Matrix3D([1,0,0,0,0,Math.cos(angle),-Math.sin(angle),0,0,Math.sin(angle),Math.cos(angle),0,0,0,0,0]));angle=-components[1].y;this.append(new Matrix3D([Math.cos(angle),0,Math.sin(angle),0,0,1,0,0,-Math.sin(angle),0,Math.cos(angle),0,0,0,0,0]));angle=-components[1].z;this.append(new Matrix3D([Math.cos(angle),-Math.sin(angle),0,0,Math.sin(angle),Math.cos(angle),0,0,0,0,1,0,0,0,0,0]));this.position=components[0];this.rawData[15]=1;return true};Matrix3D.prototype.transformVector=function(v){var x=v.x;var y=v.y;var z=v.z;return new away.geom.Vector3D((x*this.rawData[0]+y*this.rawData[4]+z*this.rawData[8]+this.rawData[12]),(x*this.rawData[1]+y*this.rawData[5]+z*this.rawData[9]+this.rawData[13]),(x*this.rawData[2]+y*this.rawData[6]+z*this.rawData[10]+this.rawData[14]),(x*this.rawData[3]+y*this.rawData[7]+z*this.rawData[11]+this.rawData[15]))};Matrix3D.prototype.transformVectors=function(vin,vout){var i=0;var x=0,y=0,z=0;while(i+3<=vin.length){x=vin[i];y=vin[i+1];z=vin[i+2];vout[i]=x*this.rawData[0]+y*this.rawData[4]+z*this.rawData[8]+this.rawData[12];vout[i+1]=x*this.rawData[1]+y*this.rawData[5]+z*this.rawData[9]+this.rawData[13];vout[i+2]=x*this.rawData[2]+y*this.rawData[6]+z*this.rawData[10]+this.rawData[14];i+=3}};Matrix3D.prototype.transpose=function(){var oRawData=this.rawData.slice(0);this.rawData[1]=oRawData[4];this.rawData[2]=oRawData[8];this.rawData[3]=oRawData[12];this.rawData[4]=oRawData[1];this.rawData[6]=oRawData[9];this.rawData[7]=oRawData[13];this.rawData[8]=oRawData[2];this.rawData[9]=oRawData[6];this.rawData[11]=oRawData[14];this.rawData[12]=oRawData[3];this.rawData[13]=oRawData[7];this.rawData[14]=oRawData[11]};Matrix3D.getAxisRotation=function(x,y,z,degrees){var m=new Matrix3D();var a1=new geom.Vector3D(x,y,z);var rad=-degrees*(Math.PI/180);var c=Math.cos(rad);var s=Math.sin(rad);var t=1-c;m.rawData[0]=c+a1.x*a1.x*t;m.rawData[5]=c+a1.y*a1.y*t;m.rawData[10]=c+a1.z*a1.z*t;var tmp1=a1.x*a1.y*t;var tmp2=a1.z*s;m.rawData[4]=tmp1+tmp2;m.rawData[1]=tmp1-tmp2;tmp1=a1.x*a1.z*t;tmp2=a1.y*s;m.rawData[8]=tmp1-tmp2;m.rawData[2]=tmp1+tmp2;tmp1=a1.y*a1.z*t;tmp2=a1.x*s;m.rawData[9]=tmp1+tmp2;m.rawData[6]=tmp1-tmp2;return m};Object.defineProperty(Matrix3D.prototype,"determinant",{get:function(){return((this.rawData[0]*this.rawData[5]-this.rawData[4]*this.rawData[1])*(this.rawData[10]*this.rawData[15]-this.rawData[14]*this.rawData[11])-(this.rawData[0]*this.rawData[9]-this.rawData[8]*this.rawData[1])*(this.rawData[6]*this.rawData[15]-this.rawData[14]*this.rawData[7])+(this.rawData[0]*this.rawData[13]-this.rawData[12]*this.rawData[1])*(this.rawData[6]*this.rawData[11]-this.rawData[10]*this.rawData[7])+(this.rawData[4]*this.rawData[9]-this.rawData[8]*this.rawData[5])*(this.rawData[2]*this.rawData[15]-this.rawData[14]*this.rawData[3])-(this.rawData[4]*this.rawData[13]-this.rawData[12]*this.rawData[5])*(this.rawData[2]*this.rawData[11]-this.rawData[10]*this.rawData[3])+(this.rawData[8]*this.rawData[13]-this.rawData[12]*this.rawData[9])*(this.rawData[2]*this.rawData[7]-this.rawData[6]*this.rawData[3]))},enumerable:true,configurable:true});Object.defineProperty(Matrix3D.prototype,"position",{get:function(){return new geom.Vector3D(this.rawData[12],this.rawData[13],this.rawData[14])},set:function(value){this.rawData[12]=value.x;this.rawData[13]=value.y;this.rawData[14]=value.z},enumerable:true,configurable:true});return Matrix3D})();geom.Matrix3D=Matrix3D})(away.geom||(away.geom={}));var geom=away.geom})(away||(away={}));var away;(function(away){(function(math){var MathConsts=(function(){function MathConsts(){}MathConsts.RADIANS_TO_DEGREES=180/Math.PI;MathConsts.DEGREES_TO_RADIANS=Math.PI/180;return MathConsts})();math.MathConsts=MathConsts})(away.math||(away.math={}));var math=away.math})(away||(away={}));var away;(function(away){(function(math){var Quaternion=(function(){function Quaternion(x,y,z,w){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}if(typeof z==="undefined"){z=0}if(typeof w==="undefined"){w=1}this.x=0;this.y=0;this.z=0;this.w=1;this.x=x;this.y=y;this.z=z;this.w=w}Object.defineProperty(Quaternion.prototype,"magnitude",{get:function(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:true,configurable:true});Quaternion.prototype.multiply=function(qa,qb){var w1=qa.w,x1=qa.x,y1=qa.y,z1=qa.z;var w2=qb.w,x2=qb.x,y2=qb.y,z2=qb.z;this.w=w1*w2-x1*x2-y1*y2-z1*z2;this.x=w1*x2+x1*w2+y1*z2-z1*y2;this.y=w1*y2-x1*z2+y1*w2+z1*x2;this.z=w1*z2+x1*y2-y1*x2+z1*w2};Quaternion.prototype.multiplyVector=function(vector,target){if(typeof target==="undefined"){target=null}if(target===null){target=new Quaternion()}var x2=vector.x;var y2=vector.y;var z2=vector.z;target.w=-this.x*x2-this.y*y2-this.z*z2;target.x=this.w*x2+this.y*z2-this.z*y2;target.y=this.w*y2-this.x*z2+this.z*x2;target.z=this.w*z2+this.x*y2-this.y*x2;return target};Quaternion.prototype.fromAxisAngle=function(axis,angle){var sin_a=Math.sin(angle/2);var cos_a=Math.cos(angle/2);this.x=axis.x*sin_a;this.y=axis.y*sin_a;this.z=axis.z*sin_a;this.w=cos_a;this.normalize()};Quaternion.prototype.slerp=function(qa,qb,t){var w1=qa.w,x1=qa.x,y1=qa.y,z1=qa.z;var w2=qb.w,x2=qb.x,y2=qb.y,z2=qb.z;var dot=w1*w2+x1*x2+y1*y2+z1*z2;if(dot<0){dot=-dot;w2=-w2;x2=-x2;y2=-y2;z2=-z2}if(dot<0.95){var angle=Math.acos(dot);var s=1/Math.sin(angle);var s1=Math.sin(angle*(1-t))*s;var s2=Math.sin(angle*t)*s;this.w=w1*s1+w2*s2;this.x=x1*s1+x2*s2;this.y=y1*s1+y2*s2;this.z=z1*s1+z2*s2}else{this.w=w1+t*(w2-w1);this.x=x1+t*(x2-x1);this.y=y1+t*(y2-y1);this.z=z1+t*(z2-z1);var len=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=len;this.x*=len;this.y*=len;this.z*=len}};Quaternion.prototype.lerp=function(qa,qb,t){var w1=qa.w,x1=qa.x,y1=qa.y,z1=qa.z;var w2=qb.w,x2=qb.x,y2=qb.y,z2=qb.z;var len;if(w1*w2+x1*x2+y1*y2+z1*z2<0){w2=-w2;x2=-x2;y2=-y2;z2=-z2}this.w=w1+t*(w2-w1);this.x=x1+t*(x2-x1);this.y=y1+t*(y2-y1);this.z=z1+t*(z2-z1);len=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=len;this.x*=len;this.y*=len;this.z*=len};Quaternion.prototype.fromEulerAngles=function(ax,ay,az){var halfX=ax*0.5,halfY=ay*0.5,halfZ=az*0.5;var cosX=Math.cos(halfX),sinX=Math.sin(halfX);var cosY=Math.cos(halfY),sinY=Math.sin(halfY);var cosZ=Math.cos(halfZ),sinZ=Math.sin(halfZ);this.w=cosX*cosY*cosZ+sinX*sinY*sinZ;this.x=sinX*cosY*cosZ-cosX*sinY*sinZ;this.y=cosX*sinY*cosZ+sinX*cosY*sinZ;this.z=cosX*cosY*sinZ-sinX*sinY*cosZ};Quaternion.prototype.toEulerAngles=function(target){if(typeof target==="undefined"){target=null}if(target===null){target=new away.geom.Vector3D()}target.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y));target.y=Math.asin(2*(this.w*this.y-this.z*this.x));target.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z));return target};Quaternion.prototype.normalize=function(val){if(typeof val==="undefined"){val=1}var mag=val/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=mag;this.y*=mag;this.z*=mag;this.w*=mag};Quaternion.prototype.toString=function(){return"{x:"+this.x+" y:"+this.y+" z:"+this.z+" w:"+this.w+"}"};Quaternion.prototype.toMatrix3D=function(target){if(typeof target==="undefined"){target=null}var rawData=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;var xy2=2*this.x*this.y,xz2=2*this.x*this.z,xw2=2*this.x*this.w;var yz2=2*this.y*this.z,yw2=2*this.y*this.w,zw2=2*this.z*this.w;var xx=this.x*this.x,yy=this.y*this.y,zz=this.z*this.z,ww=this.w*this.w;rawData[0]=xx-yy-zz+ww;rawData[4]=xy2-zw2;rawData[8]=xz2+yw2;rawData[12]=0;rawData[1]=xy2+zw2;rawData[5]=-xx+yy-zz+ww;rawData[9]=yz2-xw2;rawData[13]=0;rawData[2]=xz2-yw2;rawData[6]=yz2+xw2;rawData[10]=-xx-yy+zz+ww;rawData[14]=0;rawData[3]=0;rawData[7]=0;rawData[11]=0;rawData[15]=1;if(!target){return new away.geom.Matrix3D(rawData)}target.copyRawDataFrom(rawData);return target};Quaternion.prototype.fromMatrix=function(matrix){var v=matrix.decompose()[1];this.x=v.x;this.y=v.y;this.z=v.z;this.w=v.w};Quaternion.prototype.toRawData=function(target,exclude4thRow){if(typeof exclude4thRow==="undefined"){exclude4thRow=false}var xy2=2*this.x*this.y,xz2=2*this.x*this.z,xw2=2*this.x*this.w;var yz2=2*this.y*this.z,yw2=2*this.y*this.w,zw2=2*this.z*this.w;var xx=this.x*this.x,yy=this.y*this.y,zz=this.z*this.z,ww=this.w*this.w;target[0]=xx-yy-zz+ww;target[1]=xy2-zw2;target[2]=xz2+yw2;target[4]=xy2+zw2;target[5]=-xx+yy-zz+ww;target[6]=yz2-xw2;target[8]=xz2-yw2;target[9]=yz2+xw2;target[10]=-xx-yy+zz+ww;target[3]=target[7]=target[11]=0;if(!exclude4thRow){target[12]=target[13]=target[14]=0;target[15]=1}};Quaternion.prototype.clone=function(){return new Quaternion(this.x,this.y,this.z,this.w)};Quaternion.prototype.rotatePoint=function(vector,target){if(typeof target==="undefined"){target=null}var x1,y1,z1,w1;var x2=vector.x,y2=vector.y,z2=vector.z;if(target===null){target=new away.geom.Vector3D()}w1=-this.x*x2-this.y*y2-this.z*z2;x1=this.w*x2+this.y*z2-this.z*y2;y1=this.w*y2-this.x*z2+this.z*x2;z1=this.w*z2+this.x*y2-this.y*x2;target.x=-w1*this.x+x1*this.w-y1*this.z+z1*this.y;target.y=-w1*this.y+x1*this.z+y1*this.w-z1*this.x;target.z=-w1*this.z-x1*this.y+y1*this.x+z1*this.w;return target};Quaternion.prototype.copyFrom=function(q){this.x=q.x;this.y=q.y;this.z=q.z;this.w=q.w};return Quaternion})();math.Quaternion=Quaternion})(away.math||(away.math={}));var math=away.math})(away||(away={}));var away;(function(away){(function(math){var PlaneClassification=(function(){function PlaneClassification(){}PlaneClassification.BACK=0;PlaneClassification.FRONT=1;PlaneClassification.IN=0;PlaneClassification.OUT=1;PlaneClassification.INTERSECT=2;return PlaneClassification})();math.PlaneClassification=PlaneClassification})(away.math||(away.math={}));var math=away.math})(away||(away={}));var away;(function(away){(function(math){var Plane3D=(function(){function Plane3D(a,b,c,d){if(typeof a==="undefined"){a=0}if(typeof b==="undefined"){b=0}if(typeof c==="undefined"){c=0}if(typeof d==="undefined"){d=0}this.a=a;this.b=b;this.c=c;this.d=d;if(a==0&&b==0){this._iAlignment=Plane3D.ALIGN_XY_AXIS}else{if(b==0&&c==0){this._iAlignment=Plane3D.ALIGN_YZ_AXIS}else{if(a==0&&c==0){this._iAlignment=Plane3D.ALIGN_XZ_AXIS}else{this._iAlignment=Plane3D.ALIGN_ANY}}}}Plane3D.prototype.fromPoints=function(p0,p1,p2){var d1x=p1.x-p0.x;var d1y=p1.y-p0.y;var d1z=p1.z-p0.z;var d2x=p2.x-p0.x;var d2y=p2.y-p0.y;var d2z=p2.z-p0.z;this.a=d1y*d2z-d1z*d2y;this.b=d1z*d2x-d1x*d2z;this.c=d1x*d2y-d1y*d2x;this.d=this.a*p0.x+this.b*p0.y+this.c*p0.z;if(this.a==0&&this.b==0){this._iAlignment=Plane3D.ALIGN_XY_AXIS}else{if(this.b==0&&this.c==0){this._iAlignment=Plane3D.ALIGN_YZ_AXIS}else{if(this.a==0&&this.c==0){this._iAlignment=Plane3D.ALIGN_XZ_AXIS}else{this._iAlignment=Plane3D.ALIGN_ANY}}}};Plane3D.prototype.fromNormalAndPoint=function(normal,point){this.a=normal.x;this.b=normal.y;this.c=normal.z;this.d=this.a*point.x+this.b*point.y+this.c*point.z;if(this.a==0&&this.b==0){this._iAlignment=Plane3D.ALIGN_XY_AXIS}else{if(this.b==0&&this.c==0){this._iAlignment=Plane3D.ALIGN_YZ_AXIS}else{if(this.a==0&&this.c==0){this._iAlignment=Plane3D.ALIGN_XZ_AXIS}else{this._iAlignment=Plane3D.ALIGN_ANY}}}};Plane3D.prototype.normalize=function(){var len=1/Math.sqrt(this.a*this.a+this.b*this.b+this.c*this.c);this.a*=len;this.b*=len;this.c*=len;this.d*=len;return this};Plane3D.prototype.distance=function(p){if(this._iAlignment==Plane3D.ALIGN_YZ_AXIS){return this.a*p.x-this.d}else{if(this._iAlignment==Plane3D.ALIGN_XZ_AXIS){return this.b*p.y-this.d}else{if(this._iAlignment==Plane3D.ALIGN_XY_AXIS){return this.c*p.z-this.d}else{return this.a*p.x+this.b*p.y+this.c*p.z-this.d}}}};Plane3D.prototype.classifyPoint=function(p,epsilon){if(typeof epsilon==="undefined"){epsilon=0.01}if(this.d!=this.d){return away.math.PlaneClassification.FRONT}var len;if(this._iAlignment==Plane3D.ALIGN_YZ_AXIS){len=this.a*p.x-this.d}else{if(this._iAlignment==Plane3D.ALIGN_XZ_AXIS){len=this.b*p.y-this.d}else{if(this._iAlignment==Plane3D.ALIGN_XY_AXIS){len=this.c*p.z-this.d}else{len=this.a*p.x+this.b*p.y+this.c*p.z-this.d}}}if(len<-epsilon){return away.math.PlaneClassification.BACK}else{if(len>epsilon){return away.math.PlaneClassification.FRONT}else{return away.math.PlaneClassification.INTERSECT}}};Plane3D.prototype.toString=function(){return"Plane3D [a:"+this.a+", b:"+this.b+", c:"+this.c+", d:"+this.d+"]"};Plane3D.ALIGN_ANY=0;Plane3D.ALIGN_XY_AXIS=1;Plane3D.ALIGN_YZ_AXIS=2;Plane3D.ALIGN_XZ_AXIS=3;return Plane3D})();math.Plane3D=Plane3D})(away.math||(away.math={}));var math=away.math})(away||(away={}));var away;(function(away){(function(math){var Matrix3DUtils=(function(){function Matrix3DUtils(){}Matrix3DUtils.quaternion2matrix=function(quarternion,m){if(typeof m==="undefined"){m=null}var x=quarternion.x;var y=quarternion.y;var z=quarternion.z;var w=quarternion.w;var xx=x*x;var xy=x*y;var xz=x*z;var xw=x*w;var yy=y*y;var yz=y*z;var yw=y*w;var zz=z*z;var zw=z*w;var raw=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;raw[0]=1-2*(yy+zz);raw[1]=2*(xy+zw);raw[2]=2*(xz-yw);raw[4]=2*(xy-zw);raw[5]=1-2*(xx+zz);raw[6]=2*(yz+xw);raw[8]=2*(xz+yw);raw[9]=2*(yz-xw);raw[10]=1-2*(xx+yy);raw[3]=raw[7]=raw[11]=raw[12]=raw[13]=raw[14]=0;raw[15]=1;if(m){m.copyRawDataFrom(raw);return m}else{return new away.geom.Matrix3D(raw)}};Matrix3DUtils.getForward=function(m,v){if(typeof v==="undefined"){v=null}if(v===null){v=new away.geom.Vector3D(0,0,0)}m.copyColumnTo(2,v);v.normalize();return v};Matrix3DUtils.getUp=function(m,v){if(typeof v==="undefined"){v=null}if(v===null){v=new away.geom.Vector3D(0,0,0)}m.copyColumnTo(1,v);v.normalize();return v};Matrix3DUtils.getRight=function(m,v){if(typeof v==="undefined"){v=null}if(v===null){v=new away.geom.Vector3D(0,0,0)}m.copyColumnTo(0,v);v.normalize();return v};Matrix3DUtils.compare=function(m1,m2){var r1=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;var r2=m2.rawData;m1.copyRawDataTo(r1);for(var i=0;i<16;++i){if(r1[i]!=r2[i]){return false}}return true};Matrix3DUtils.lookAt=function(matrix,pos,dir,up){var dirN;var upN;var lftN;var raw=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;lftN=dir.crossProduct(up);lftN.normalize();upN=lftN.crossProduct(dir);upN.normalize();dirN=dir.clone();dirN.normalize();raw[0]=lftN.x;raw[1]=upN.x;raw[2]=-dirN.x;raw[3]=0;raw[4]=lftN.y;raw[5]=upN.y;raw[6]=-dirN.y;raw[7]=0;raw[8]=lftN.z;raw[9]=upN.z;raw[10]=-dirN.z;raw[11]=0;raw[12]=-lftN.dotProduct(pos);raw[13]=-upN.dotProduct(pos);raw[14]=dirN.dotProduct(pos);raw[15]=1;matrix.copyRawDataFrom(raw)};Matrix3DUtils.reflection=function(plane,target){if(typeof target==="undefined"){target=null}if(target===null){target=new away.geom.Matrix3D()}var a=plane.a,b=plane.b,c=plane.c,d=plane.d;var rawData=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;var ab2=-2*a*b;var ac2=-2*a*c;var bc2=-2*b*c;rawData[0]=1-2*a*a;rawData[4]=ab2;rawData[8]=ac2;rawData[12]=-2*a*d;rawData[1]=ab2;rawData[5]=1-2*b*b;rawData[9]=bc2;rawData[13]=-2*b*d;rawData[2]=ac2;rawData[6]=bc2;rawData[10]=1-2*c*c;rawData[14]=-2*c*d;rawData[3]=0;rawData[7]=0;rawData[11]=0;rawData[15]=1;target.copyRawDataFrom(rawData);return target};Matrix3DUtils.RAW_DATA_CONTAINER=new Array(16);Matrix3DUtils.CALCULATION_MATRIX=new away.geom.Matrix3D();return Matrix3DUtils})();math.Matrix3DUtils=Matrix3DUtils})(away.math||(away.math={}));var math=away.math})(away||(away={}));var away;(function(away){(function(events){var Object3DEvent=(function(_super){__extends(Object3DEvent,_super);function Object3DEvent(type,object){_super.call(this,type);this.object=object}Object3DEvent.VISIBLITY_UPDATED="visiblityUpdated";Object3DEvent.SCENETRANSFORM_CHANGED="scenetransformChanged";Object3DEvent.SCENE_CHANGED="sceneChanged";Object3DEvent.POSITION_CHANGED="positionChanged";Object3DEvent.ROTATION_CHANGED="rotationChanged";Object3DEvent.SCALE_CHANGED="scaleChanged";return Object3DEvent})(events.Event);events.Object3DEvent=Object3DEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(base){var Object3D=(function(_super){__extends(Object3D,_super);function Object3D(){_super.call(this);this._smallestNumber=1e-22;this._transformDirty=true;this._positionDirty=true;this._rotationDirty=true;this._scaleDirty=true;this._rotationX=0;this._rotationY=0;this._rotationZ=0;this._eulers=new away.geom.Vector3D();this._flipY=new away.geom.Matrix3D();this._zOffset=0;this._pTransform=new away.geom.Matrix3D();this._pScaleX=1;this._pScaleY=1;this._pScaleZ=1;this._x=0;this._y=0;this._z=0;this._pivotPoint=new away.geom.Vector3D();this._pivotZero=true;this._pPos=new away.geom.Vector3D();this._rot=new away.geom.Vector3D();this._sca=new away.geom.Vector3D();this._transformComponents=new Array(3);this._transformComponents[0]=this._pPos;this._transformComponents[1]=this._rot;this._transformComponents[2]=this._sca;this._pTransform.identity();this._flipY.appendScale(1,-1,1)}Object3D.prototype.invalidatePivot=function(){this._pivotZero=(this._pivotPoint.x==0)&&(this._pivotPoint.y==0)&&(this._pivotPoint.z==0);this.iInvalidateTransform()};Object3D.prototype.invalidatePosition=function(){if(this._positionDirty){return}this._positionDirty=true;this.iInvalidateTransform();if(this._listenToPositionChanged){this.notifyPositionChanged()}};Object3D.prototype.notifyPositionChanged=function(){if(!this._positionChanged){this._positionChanged=new away.events.Object3DEvent(away.events.Object3DEvent.POSITION_CHANGED,this)}this.dispatchEvent(this._positionChanged)};Object3D.prototype.addEventListener=function(type,listener,target){_super.prototype.addEventListener.call(this,type,listener,target);switch(type){case away.events.Object3DEvent.POSITION_CHANGED:this._listenToPositionChanged=true;break;case away.events.Object3DEvent.ROTATION_CHANGED:this._listenToRotationChanged=true;break;case away.events.Object3DEvent.SCALE_CHANGED:this._listenToRotationChanged=true;break}};Object3D.prototype.removeEventListener=function(type,listener,target){_super.prototype.removeEventListener.call(this,type,listener,target);if(this.hasEventListener(type,listener,target)){return}switch(type){case away.events.Object3DEvent.POSITION_CHANGED:this._listenToPositionChanged=false;break;case away.events.Object3DEvent.ROTATION_CHANGED:this._listenToRotationChanged=false;break;case away.events.Object3DEvent.SCALE_CHANGED:this._listenToScaleChanged=false;break}};Object3D.prototype.invalidateRotation=function(){if(this._rotationDirty){return}this._rotationDirty=true;this.iInvalidateTransform();if(this._listenToRotationChanged){this.notifyRotationChanged()}};Object3D.prototype.notifyRotationChanged=function(){if(!this._rotationChanged){this._rotationChanged=new away.events.Object3DEvent(away.events.Object3DEvent.ROTATION_CHANGED,this)}this.dispatchEvent(this._rotationChanged)};Object3D.prototype.invalidateScale=function(){if(this._scaleDirty){return}this._scaleDirty=true;this.iInvalidateTransform();if(this._listenToScaleChanged){this.notifyScaleChanged()}};Object3D.prototype.notifyScaleChanged=function(){if(!this._scaleChanged){this._scaleChanged=new away.events.Object3DEvent(away.events.Object3DEvent.SCALE_CHANGED,this)}this.dispatchEvent(this._scaleChanged)};Object.defineProperty(Object3D.prototype,"x",{get:function(){return this._x},set:function(val){if(this._x==val){return}this._x=val;this.invalidatePosition()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"y",{get:function(){return this._y},set:function(val){if(this._y==val){return}this._y=val;this.invalidatePosition()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"z",{get:function(){return this._z},set:function(val){if(this._z==val){return}this._z=val;this.invalidatePosition()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"rotationX",{get:function(){return this._rotationX*away.math.MathConsts.RADIANS_TO_DEGREES},set:function(val){if(this.rotationX==val){return}this._rotationX=val*away.math.MathConsts.DEGREES_TO_RADIANS;this.invalidateRotation()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"rotationY",{get:function(){return this._rotationY*away.math.MathConsts.RADIANS_TO_DEGREES},set:function(val){if(this.rotationY==val){return}this._rotationY=val*away.math.MathConsts.DEGREES_TO_RADIANS;this.invalidateRotation()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"rotationZ",{get:function(){return this._rotationZ*away.math.MathConsts.RADIANS_TO_DEGREES},set:function(val){if(this.rotationZ==val){return}this._rotationZ=val*away.math.MathConsts.DEGREES_TO_RADIANS;this.invalidateRotation()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"scaleX",{get:function(){return this._pScaleX},set:function(val){if(this._pScaleX==val){return}this._pScaleX=val;this.invalidateScale()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"scaleY",{get:function(){return this._pScaleY},set:function(val){if(this._pScaleY==val){return}this._pScaleY=val;this.invalidateScale()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"scaleZ",{get:function(){return this._pScaleZ},set:function(val){if(this._pScaleZ==val){return}this._pScaleZ=val;this.invalidateScale()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"eulers",{get:function(){this._eulers.x=this._rotationX*away.math.MathConsts.RADIANS_TO_DEGREES;this._eulers.y=this._rotationY*away.math.MathConsts.RADIANS_TO_DEGREES;this._eulers.z=this._rotationZ*away.math.MathConsts.RADIANS_TO_DEGREES;return this._eulers},set:function(value){this._rotationX=value.x*away.math.MathConsts.DEGREES_TO_RADIANS;this._rotationY=value.y*away.math.MathConsts.DEGREES_TO_RADIANS;this._rotationZ=value.z*away.math.MathConsts.DEGREES_TO_RADIANS;this.invalidateRotation()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"transform",{get:function(){if(this._transformDirty){this.pUpdateTransform()}return this._pTransform},set:function(val){if(!val.rawData[0]){var raw=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;val.copyRawDataTo(raw);raw[0]=this._smallestNumber;val.copyRawDataFrom(raw)}var elements=val.decompose();var vec;vec=elements[0];if(this._x!=vec.x||this._y!=vec.y||this._z!=vec.z){this._x=vec.x;this._y=vec.y;this._z=vec.z;this.invalidatePosition()}vec=elements[1];if(this._rotationX!=vec.x||this._rotationY!=vec.y||this._rotationZ!=vec.z){this._rotationX=vec.x;this._rotationY=vec.y;this._rotationZ=vec.z;this.invalidateRotation()}vec=elements[2];if(this._pScaleX!=vec.x||this._pScaleY!=vec.y||this._pScaleZ!=vec.z){this._pScaleX=vec.x;this._pScaleY=vec.y;this._pScaleZ=vec.z;this.invalidateScale()}},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(pivot){this._pivotPoint=pivot.clone();this.invalidatePivot()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"position",{get:function(){this._pTransform.copyColumnTo(3,this._pPos);return this._pPos.clone()},set:function(value){this._x=value.x;this._y=value.y;this._z=value.z;this.invalidatePosition()},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"forwardVector",{get:function(){return away.math.Matrix3DUtils.getForward(this.transform)},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"rightVector",{get:function(){return away.math.Matrix3DUtils.getRight(this.transform)},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"upVector",{get:function(){return away.math.Matrix3DUtils.getUp(this.transform)},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"backVector",{get:function(){var director=away.math.Matrix3DUtils.getForward(this.transform);director.negate();return director},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"leftVector",{get:function(){var director=away.math.Matrix3DUtils.getRight(this.transform);director.negate();return director},enumerable:true,configurable:true});Object.defineProperty(Object3D.prototype,"downVector",{get:function(){var director=away.math.Matrix3DUtils.getUp(this.transform);director.negate();return director},enumerable:true,configurable:true});Object3D.prototype.scale=function(value){this._pScaleX*=value;this._pScaleY*=value;this._pScaleZ*=value;this.invalidateScale()};Object3D.prototype.moveForward=function(distance){this.translateLocal(away.geom.Vector3D.Z_AXIS,distance)};Object3D.prototype.moveBackward=function(distance){this.translateLocal(away.geom.Vector3D.Z_AXIS,-distance)};Object3D.prototype.moveLeft=function(distance){this.translateLocal(away.geom.Vector3D.X_AXIS,-distance)};Object3D.prototype.moveRight=function(distance){this.translateLocal(away.geom.Vector3D.X_AXIS,distance)};Object3D.prototype.moveUp=function(distance){this.translateLocal(away.geom.Vector3D.Y_AXIS,distance)};Object3D.prototype.moveDown=function(distance){this.translateLocal(away.geom.Vector3D.Y_AXIS,-distance)};Object3D.prototype.moveTo=function(dx,dy,dz){if(this._x==dx&&this._y==dy&&this._z==dz){return}this._x=dx;this._y=dy;this._z=dz;this.invalidatePosition()};Object3D.prototype.movePivot=function(dx,dy,dz){if(this._pivotPoint==null){this._pivotPoint=new away.geom.Vector3D()}this._pivotPoint.x+=dx;this._pivotPoint.y+=dy;this._pivotPoint.z+=dz;this.invalidatePivot()};Object3D.prototype.translate=function(axis,distance){var x=axis.x,y=axis.y,z=axis.z;var len=distance/Math.sqrt(x*x+y*y+z*z);this._x+=x*len;this._y+=y*len;this._z+=z*len;this.invalidatePosition()};Object3D.prototype.translateLocal=function(axis,distance){var x=axis.x,y=axis.y,z=axis.z;var len=distance/Math.sqrt(x*x+y*y+z*z);this.transform.prependTranslation(x*len,y*len,z*len);this._pTransform.copyColumnTo(3,this._pPos);this._x=this._pPos.x;this._y=this._pPos.y;this._z=this._pPos.z;this.invalidatePosition()};Object3D.prototype.pitch=function(angle){this.rotate(away.geom.Vector3D.X_AXIS,angle)};Object3D.prototype.yaw=function(angle){this.rotate(away.geom.Vector3D.Y_AXIS,angle)};Object3D.prototype.roll=function(angle){this.rotate(away.geom.Vector3D.Z_AXIS,angle)};Object3D.prototype.clone=function(){var clone=new away.base.Object3D();clone.pivotPoint=this.pivotPoint;clone.transform=this.transform;clone.name=name;return clone};Object3D.prototype.rotateTo=function(ax,ay,az){this._rotationX=ax*away.math.MathConsts.DEGREES_TO_RADIANS;this._rotationY=ay*away.math.MathConsts.DEGREES_TO_RADIANS;this._rotationZ=az*away.math.MathConsts.DEGREES_TO_RADIANS;this.invalidateRotation()};Object3D.prototype.rotate=function(axis,angle){this.transform.prependRotation(angle,axis);this.transform=this.transform};Object3D.prototype.lookAt=function(target,upAxis){if(typeof upAxis==="undefined"){upAxis=null}var yAxis;var zAxis;var xAxis;var raw;if(upAxis==null){upAxis=away.geom.Vector3D.Y_AXIS}zAxis=target.subtract(this.position);zAxis.normalize();xAxis=upAxis.crossProduct(zAxis);xAxis.normalize();if(xAxis.length<0.05){xAxis=upAxis.crossProduct(away.geom.Vector3D.Z_AXIS)}yAxis=zAxis.crossProduct(xAxis);raw=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;raw[0]=this._pScaleX*xAxis.x;raw[1]=this._pScaleX*xAxis.y;raw[2]=this._pScaleX*xAxis.z;raw[3]=0;raw[4]=this._pScaleY*yAxis.x;raw[5]=this._pScaleY*yAxis.y;raw[6]=this._pScaleY*yAxis.z;raw[7]=0;raw[8]=this._pScaleZ*zAxis.x;raw[9]=this._pScaleZ*zAxis.y;raw[10]=this._pScaleZ*zAxis.z;raw[11]=0;raw[12]=this._x;raw[13]=this._y;raw[14]=this._z;raw[15]=1;this._pTransform.copyRawDataFrom(raw);this.transform=this.transform;if(zAxis.z<0){this.rotationY=(180-this.rotationY);this.rotationX-=180;this.rotationZ-=180}};Object3D.prototype.dispose=function(){};Object3D.prototype.disposeAsset=function(){this.dispose()};Object3D.prototype.iInvalidateTransform=function(){this._transformDirty=true};Object3D.prototype.pUpdateTransform=function(){this._pPos.x=this._x;this._pPos.y=this._y;this._pPos.z=this._z;this._rot.x=this._rotationX;this._rot.y=this._rotationY;this._rot.z=this._rotationZ;this._sca.x=this._pScaleX;this._sca.y=this._pScaleY;this._sca.z=this._pScaleZ;this._pTransform.recompose(this._transformComponents);if(!this._pivotZero){this._pTransform.prependTranslation(-this._pivotPoint.x,-this._pivotPoint.y,-this._pivotPoint.z);this._pTransform.appendTranslation(this._pivotPoint.x,this._pivotPoint.y,this._pivotPoint.z)}this._transformDirty=false;this._positionDirty=false;this._rotationDirty=false;this._scaleDirty=false};Object.defineProperty(Object3D.prototype,"zOffset",{get:function(){return this._zOffset},set:function(value){this._zOffset=value},enumerable:true,configurable:true});return Object3D})(away.library.NamedAssetBase);base.Object3D=Object3D})(away.base||(away.base={}));var base=away.base})(away||(away={}));var away;(function(away){(function(errors){var AbstractMethodError=(function(_super){__extends(AbstractMethodError,_super);function AbstractMethodError(message,id){if(typeof message==="undefined"){message=null}if(typeof id==="undefined"){id=0}_super.call(this,message||"An abstract method was called! Either an instance of an abstract class was created, or an abstract method was not overridden by the subclass.",id)}return AbstractMethodError})(errors.Error);errors.AbstractMethodError=AbstractMethodError})(away.errors||(away.errors={}));var errors=away.errors})(away||(away={}));var away;(function(away){(function(events){var Scene3DEvent=(function(_super){__extends(Scene3DEvent,_super);function Scene3DEvent(type,objectContainer){this.objectContainer3D=objectContainer;_super.call(this,type)}Object.defineProperty(Scene3DEvent.prototype,"target",{get:function(){return this.objectContainer3D},enumerable:true,configurable:true});Scene3DEvent.ADDED_TO_SCENE="addedToScene";Scene3DEvent.REMOVED_FROM_SCENE="removedFromScene";Scene3DEvent.PARTITION_CHANGED="partitionChanged";return Scene3DEvent})(away.events.Event);events.Scene3DEvent=Scene3DEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(containers){var Scene3D=(function(_super){__extends(Scene3D,_super);function Scene3D(){_super.call(this);this._partitions=[];this._iSceneGraphRoot=new away.containers.ObjectContainer3D();this._iSceneGraphRoot.scene=this;this._iSceneGraphRoot._iIsRoot=true;this._iSceneGraphRoot.partition=new away.partition.Partition3D(new away.partition.NodeBase())}Scene3D.prototype.traversePartitions=function(traverser){var i=0;var len=this._partitions.length;traverser.scene=this;while(i<len){this._partitions[i++].traverse(traverser)}};Object.defineProperty(Scene3D.prototype,"partition",{get:function(){return this._iSceneGraphRoot.partition},set:function(value){this._iSceneGraphRoot.partition=value;this.dispatchEvent(new away.events.Scene3DEvent(away.events.Scene3DEvent.PARTITION_CHANGED,this._iSceneGraphRoot))},enumerable:true,configurable:true});Scene3D.prototype.contains=function(child){return this._iSceneGraphRoot.contains(child)};Scene3D.prototype.addChild=function(child){return this._iSceneGraphRoot.addChild(child)};Scene3D.prototype.removeChild=function(child){this._iSceneGraphRoot.removeChild(child)};Scene3D.prototype.removeChildAt=function(index){this._iSceneGraphRoot.removeChildAt(index)};Scene3D.prototype.getChildAt=function(index){return this._iSceneGraphRoot.getChildAt(index)};Object.defineProperty(Scene3D.prototype,"numChildren",{get:function(){return this._iSceneGraphRoot.numChildren},enumerable:true,configurable:true});Scene3D.prototype.iRegisterEntity=function(entity){var partition=entity.iGetImplicitPartition();this.iAddPartitionUnique(partition);this.partition.iMarkForUpdate(entity)};Scene3D.prototype.iUnregisterEntity=function(entity){entity.iGetImplicitPartition().iRemoveEntity(entity)};Scene3D.prototype.iInvalidateEntityBounds=function(entity){entity.iGetImplicitPartition().iMarkForUpdate(entity)};Scene3D.prototype.iRegisterPartition=function(entity){this.iAddPartitionUnique(entity.iGetImplicitPartition())};Scene3D.prototype.iUnregisterPartition=function(entity){entity.iGetImplicitPartition().iRemoveEntity(entity)};Scene3D.prototype.iAddPartitionUnique=function(partition){if(this._partitions.indexOf(partition)==-1){this._partitions.push(partition)}};return Scene3D})(away.events.EventDispatcher);containers.Scene3D=Scene3D})(away.containers||(away.containers={}));var containers=away.containers})(away||(away={}));var away;(function(away){(function(display){var BlendMode=(function(){function BlendMode(){}BlendMode.ADD="add";BlendMode.ALPHA="alpha";BlendMode.DARKEN="darken";BlendMode.DIFFERENCE="difference";BlendMode.ERASE="erase";BlendMode.HARDLIGHT="hardlight";BlendMode.INVERT="invert";BlendMode.LAYER="layer";BlendMode.LIGHTEN="lighten";BlendMode.MULTIPLY="multiply";BlendMode.NORMAL="normal";BlendMode.OVERLAY="overlay";BlendMode.SCREEN="screen";BlendMode.SHADER="shader";BlendMode.SUBTRACT="subtract";return BlendMode})();display.BlendMode=BlendMode})(away.display||(away.display={}));var display=away.display})(away||(away={}));var away;(function(away){(function(display3D){var Context3DClearMask=(function(){function Context3DClearMask(){}Context3DClearMask.COLOR=8<<11;Context3DClearMask.DEPTH=8<<5;Context3DClearMask.STENCIL=8<<7;Context3DClearMask.ALL=Context3DClearMask.COLOR|Context3DClearMask.DEPTH|Context3DClearMask.STENCIL;return Context3DClearMask})();display3D.Context3DClearMask=Context3DClearMask})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var VertexBuffer3D=(function(){function VertexBuffer3D(gl,numVertices,data32PerVertex){this._gl=gl;this._buffer=this._gl.createBuffer();this._numVertices=numVertices;this._data32PerVertex=data32PerVertex}VertexBuffer3D.prototype.uploadFromArray=function(vertices,startVertex,numVertices){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._buffer);console.log("** WARNING upload not fully implemented, startVertex & numVertices not considered.");this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(vertices),this._gl.STATIC_DRAW)};Object.defineProperty(VertexBuffer3D.prototype,"numVertices",{get:function(){return this._numVertices},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer3D.prototype,"data32PerVertex",{get:function(){return this._data32PerVertex},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer3D.prototype,"glBuffer",{get:function(){return this._buffer},enumerable:true,configurable:true});VertexBuffer3D.prototype.dispose=function(){this._gl.deleteBuffer(this._buffer)};return VertexBuffer3D})();display3D.VertexBuffer3D=VertexBuffer3D})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var IndexBuffer3D=(function(){function IndexBuffer3D(gl,numIndices){this._gl=gl;this._buffer=this._gl.createBuffer();this._numIndices=numIndices}IndexBuffer3D.prototype.uploadFromArray=function(data,startOffset,count){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._buffer);this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(data),this._gl.STATIC_DRAW)};IndexBuffer3D.prototype.dispose=function(){this._gl.deleteBuffer(this._buffer)};Object.defineProperty(IndexBuffer3D.prototype,"numIndices",{get:function(){return this._numIndices},enumerable:true,configurable:true});Object.defineProperty(IndexBuffer3D.prototype,"glBuffer",{get:function(){return this._buffer},enumerable:true,configurable:true});return IndexBuffer3D})();display3D.IndexBuffer3D=IndexBuffer3D})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Program3D=(function(){function Program3D(gl){this._gl=gl;this._program=this._gl.createProgram()}Program3D.prototype.upload=function(vertexProgram,fragmentProgram){this._vertexShader=this._gl.createShader(this._gl.VERTEX_SHADER);this._fragmentShader=this._gl.createShader(this._gl.FRAGMENT_SHADER);this._gl.shaderSource(this._vertexShader,vertexProgram);this._gl.compileShader(this._vertexShader);if(!this._gl.getShaderParameter(this._vertexShader,this._gl.COMPILE_STATUS)){alert(this._gl.getShaderInfoLog(this._vertexShader));return null}this._gl.shaderSource(this._fragmentShader,fragmentProgram);this._gl.compileShader(this._fragmentShader);if(!this._gl.getShaderParameter(this._fragmentShader,this._gl.COMPILE_STATUS)){alert(this._gl.getShaderInfoLog(this._fragmentShader));return null}this._gl.attachShader(this._program,this._vertexShader);this._gl.attachShader(this._program,this._fragmentShader);this._gl.linkProgram(this._program);if(!this._gl.getProgramParameter(this._program,this._gl.LINK_STATUS)){alert("Could not link the program.")}};Program3D.prototype.dispose=function(){this._gl.deleteProgram(this._program)};Program3D.prototype.focusProgram=function(){this._gl.useProgram(this._program)};Object.defineProperty(Program3D.prototype,"glProgram",{get:function(){return this._program},enumerable:true,configurable:true});return Program3D})();display3D.Program3D=Program3D})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(geom){var Point=(function(){function Point(x,y){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}this.x=x;this.y=y}return Point})();geom.Point=Point})(away.geom||(away.geom={}));var geom=away.geom})(away||(away={}));var away;(function(away){(function(geom){var Rectangle=(function(){function Rectangle(x,y,width,height){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}if(typeof width==="undefined"){width=0}if(typeof height==="undefined"){height=0}this.x=x;this.y=y;this.width=width;this.height=height}Object.defineProperty(Rectangle.prototype,"left",{get:function(){return this.x},enumerable:true,configurable:true});Object.defineProperty(Rectangle.prototype,"right",{get:function(){return this.x+this.width},enumerable:true,configurable:true});Object.defineProperty(Rectangle.prototype,"top",{get:function(){return this.y},enumerable:true,configurable:true});Object.defineProperty(Rectangle.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:true,configurable:true});Object.defineProperty(Rectangle.prototype,"topLeft",{get:function(){return new away.geom.Point(this.x,this.y)},enumerable:true,configurable:true});Object.defineProperty(Rectangle.prototype,"bottomRight",{get:function(){return new away.geom.Point(this.x+this.width,this.y+this.height)},enumerable:true,configurable:true});Rectangle.prototype.clone=function(){return new Rectangle(this.x,this.y,this.width,this.height)};return Rectangle})();geom.Rectangle=Rectangle})(away.geom||(away.geom={}));var geom=away.geom})(away||(away={}));var away;(function(away){(function(display3D){var Context3DTextureFormat=(function(){function Context3DTextureFormat(){}Context3DTextureFormat.BGRA="bgra";Context3DTextureFormat.BGRA_PACKED="bgraPacked4444";Context3DTextureFormat.BGR_PACKED="bgrPacked565";Context3DTextureFormat.COMPRESSED="compressed";Context3DTextureFormat.COMPRESSED_ALPHA="compressedAlpha";return Context3DTextureFormat})();display3D.Context3DTextureFormat=Context3DTextureFormat})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var TextureBase=(function(){function TextureBase(gl){this._gl=gl;this._glTexture=this._gl.createTexture()}TextureBase.prototype.dispose=function(){this._gl.deleteTexture(this._glTexture)};Object.defineProperty(TextureBase.prototype,"glTexture",{get:function(){return this._glTexture},enumerable:true,configurable:true});return TextureBase})();display3D.TextureBase=TextureBase})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(geom){var Matrix=(function(){function Matrix(a,b,c,d,tx,ty){if(typeof a==="undefined"){a=1}if(typeof b==="undefined"){b=0}if(typeof c==="undefined"){c=0}if(typeof d==="undefined"){d=1}if(typeof tx==="undefined"){tx=0}if(typeof ty==="undefined"){ty=0}this.a=a;this.b=b;this.c=c;this.d=d;this.tx=tx;this.ty=ty}Matrix.prototype.clone=function(){return new Matrix(this.a,this.b,this.c,this.d,this.tx,this.ty)};Matrix.prototype.concat=function(m){var a1=this.a*m.a+this.b*m.c;this.b=this.a*m.b+this.b*m.d;this.a=a1;var c1=this.c*m.a+this.d*m.c;this.d=this.c*m.b+this.d*m.d;this.c=c1;var tx1=this.tx*m.a+this.ty*m.c+m.tx;this.ty=this.tx*m.b+this.ty*m.d+m.ty;this.tx=tx1};Matrix.prototype.copyColumnFrom=function(column,vector3D){if(column>2){throw"Column "+column+" out of bounds (2)"}else{if(column==0){this.a=vector3D.x;this.c=vector3D.y}else{if(column==1){this.b=vector3D.x;this.d=vector3D.y}else{this.tx=vector3D.x;this.ty=vector3D.y}}}};Matrix.prototype.copyColumnTo=function(column,vector3D){if(column>2){throw new away.errors.ArgumentError("ArgumentError, Column "+column+" out of bounds [0, ..., 2]")}else{if(column==0){vector3D.x=this.a;vector3D.y=this.c;vector3D.z=0}else{if(column==1){vector3D.x=this.b;vector3D.y=this.d;vector3D.z=0}else{vector3D.x=this.tx;vector3D.y=this.ty;vector3D.z=1}}}};Matrix.prototype.copyFrom=function(other){this.a=other.a;this.b=other.b;this.c=other.c;this.d=other.d;this.tx=other.tx;this.ty=other.ty};Matrix.prototype.copyRowFrom=function(row,vector3D){if(row>2){throw new away.errors.ArgumentError("ArgumentError, Row "+row+" out of bounds [0, ..., 2]")}else{if(row==0){this.a=vector3D.x;this.c=vector3D.y}else{if(row==1){this.b=vector3D.x;this.d=vector3D.y}else{this.tx=vector3D.x;this.ty=vector3D.y}}}};Matrix.prototype.copyRowTo=function(row,vector3D){if(row>2){throw new away.errors.ArgumentError("ArgumentError, Row "+row+" out of bounds [0, ..., 2]")}else{if(row==0){vector3D.x=this.a;vector3D.y=this.b;vector3D.z=this.tx}else{if(row==1){vector3D.x=this.c;vector3D.y=this.d;vector3D.z=this.ty}else{vector3D.setTo(0,0,1)}}}};Matrix.prototype.createBox=function(scaleX,scaleY,rotation,tx,ty){if(typeof rotation==="undefined"){rotation=0}if(typeof tx==="undefined"){tx=0}if(typeof ty==="undefined"){ty=0}this.a=scaleX;this.d=scaleY;this.b=rotation;this.tx=tx;this.ty=ty};Matrix.prototype.createGradientBox=function(width,height,rotation,tx,ty){if(typeof rotation==="undefined"){rotation=0}if(typeof tx==="undefined"){tx=0}if(typeof ty==="undefined"){ty=0}this.a=width/1638.4;this.d=height/1638.4;if(rotation!=0){var cos=Math.cos(rotation);var sin=Math.sin(rotation);this.b=sin*this.d;this.c=-sin*this.a;this.a*=cos;this.d*=cos}else{this.b=this.c=0}this.tx=tx+width/2;this.ty=ty+height/2};Matrix.prototype.deltaTransformPoint=function(point){return new away.geom.Point(point.x*this.a+point.y*this.c,point.x*this.b+point.y*this.d)};Matrix.prototype.identity=function(){this.a=1;this.b=0;this.c=0;this.d=1;this.tx=0;this.ty=0};Matrix.prototype.invert=function(){var norm=this.a*this.d-this.b*this.c;if(norm==0){this.a=this.b=this.c=this.d=0;this.tx=-this.tx;this.ty=-this.ty}else{norm=1/norm;var a1=this.d*norm;this.d=this.a*norm;this.a=a1;this.b*=-norm;this.c*=-norm;var tx1=-this.a*this.tx-this.c*this.ty;this.ty=-this.b*this.tx-this.d*this.ty;this.tx=tx1}return this};Matrix.prototype.mult=function(m){var result=new Matrix();result.a=this.a*m.a+this.b*m.c;result.b=this.a*m.b+this.b*m.d;result.c=this.c*m.a+this.d*m.c;result.d=this.c*m.b+this.d*m.d;result.tx=this.tx*m.a+this.ty*m.c+m.tx;result.ty=this.tx*m.b+this.ty*m.d+m.ty;return result};Matrix.prototype.rotate=function(angle){var cos=Math.cos(angle);var sin=Math.sin(angle);var a1=this.a*cos-this.b*sin;this.b=this.a*sin+this.b*cos;this.a=a1;var c1=this.c*cos-this.d*sin;this.d=this.c*sin+this.d*cos;this.c=c1;var tx1=this.tx*cos-this.ty*sin;this.ty=this.tx*sin+this.ty*cos;this.tx=tx1};Matrix.prototype.scale=function(x,y){this.a*=x;this.b*=y;this.c*=x;this.d*=y;this.tx*=x;this.ty*=y};Matrix.prototype.setRotation=function(angle,scale){if(typeof scale==="undefined"){scale=1}this.a=Math.cos(angle)*scale;this.c=Math.sin(angle)*scale;this.b=-this.c;this.d=this.a};Matrix.prototype.setTo=function(a,b,c,d,tx,ty){this.a=a;this.b=b;this.c=c;this.d=d;this.tx=tx;this.ty=ty};Matrix.prototype.toString=function(){return"[Matrix] (a="+this.a+", b="+this.b+", c="+this.c+", d="+this.d+", tx="+this.tx+", ty="+this.ty+")"};Matrix.prototype.transformPoint=function(point){return new away.geom.Point(point.x*this.a+point.y*this.c+this.tx,point.x*this.b+point.y*this.d+this.ty)};Matrix.prototype.translate=function(x,y){this.tx+=x;this.ty+=y};return Matrix})();geom.Matrix=Matrix})(away.geom||(away.geom={}));var geom=away.geom})(away||(away={}));var away;(function(away){(function(display){var BitmapData=(function(){function BitmapData(width,height,transparent,fillColor){if(typeof transparent==="undefined"){transparent=true}if(typeof fillColor==="undefined"){fillColor=null}this._alpha=1;this._locked=false;this._transparent=transparent;this._imageCanvas=document.createElement("canvas");this._imageCanvas.width=width;this._imageCanvas.height=height;this._context=this._imageCanvas.getContext("2d");this._rect=new away.geom.Rectangle(0,0,width,height);if(fillColor!=null){if(this._transparent){this._alpha=away.utils.ColorUtils.float32ColorToARGB(fillColor)[0]/255}else{this._alpha=1}this.fillRect(this._rect,fillColor)}}BitmapData.prototype.dispose=function(){this._context=null;this._imageCanvas=null;this._imageData=null;this._rect=null;this._transparent=null;this._locked=null};BitmapData.prototype.lock=function(){this._locked=true;this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height)};BitmapData.prototype.unlock=function(){this._locked=false;if(this._imageData){this._context.putImageData(this._imageData,0,0);this._imageData=null}};BitmapData.prototype.getPixel=function(x,y){var r;var g;var b;var a;var index=(x+y*this._imageCanvas.width)*4;if(!this._locked){this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height);r=this._imageData.data[index+0];g=this._imageData.data[index+1];b=this._imageData.data[index+2];a=this._imageData.data[index+3]}else{if(this._imageData){this._context.putImageData(this._imageData,0,0)}this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height);r=this._imageData.data[index+0];g=this._imageData.data[index+1];b=this._imageData.data[index+2];a=this._imageData.data[index+3]}if(!this._locked){this._imageData=null}return(a<<24)|(r<<16)|(g<<8)|b};BitmapData.prototype.setPixel=function(x,y,color){var argb=away.utils.ColorUtils.float32ColorToARGB(color);if(!this._locked){this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height)}if(this._imageData){var index=(x+y*this._imageCanvas.width)*4;this._imageData.data[index+0]=argb[1];this._imageData.data[index+1]=argb[2];this._imageData.data[index+2]=argb[3];this._imageData.data[index+3]=255}if(!this._locked){this._context.putImageData(this._imageData,0,0);this._imageData=null}};BitmapData.prototype.setPixel32=function(x,y,color){var argb=away.utils.ColorUtils.float32ColorToARGB(color);if(!this._locked){this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height)}if(this._imageData){var index=(x+y*this._imageCanvas.width)*4;this._imageData.data[index+0]=argb[1];this._imageData.data[index+1]=argb[2];this._imageData.data[index+2]=argb[3];this._imageData.data[index+3]=argb[0]}if(!this._locked){this._context.putImageData(this._imageData,0,0);this._imageData=null}};BitmapData.prototype.drawImage=function(img,sourceRect,destRect){if(this._locked){if(this._imageData){this._context.putImageData(this._imageData,0,0)}this._drawImage(img,sourceRect,destRect);if(this._imageData){this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height)}}else{this._drawImage(img,sourceRect,destRect)}};BitmapData.prototype._drawImage=function(img,sourceRect,destRect){if(img instanceof away.display.BitmapData){this._context.drawImage(img.canvas,sourceRect.x,sourceRect.y,sourceRect.width,sourceRect.height,destRect.x,destRect.y,destRect.width,destRect.height)}else{if(img instanceof HTMLImageElement){this._context.drawImage(img,sourceRect.x,sourceRect.y,sourceRect.width,sourceRect.height,destRect.x,destRect.y,destRect.width,destRect.height)}}};BitmapData.prototype.copyPixels=function(bmpd,sourceRect,destRect){if(this._locked){if(this._imageData){this._context.putImageData(this._imageData,0,0)}this._copyPixels(bmpd,sourceRect,destRect);if(this._imageData){this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height)}}else{this._copyPixels(bmpd,sourceRect,destRect)}};BitmapData.prototype._copyPixels=function(bmpd,sourceRect,destRect){if(bmpd instanceof away.display.BitmapData){this._context.drawImage(bmpd.canvas,sourceRect.x,sourceRect.y,sourceRect.width,sourceRect.height,destRect.x,destRect.y,destRect.width,destRect.height)}else{if(bmpd instanceof HTMLImageElement){this._context.drawImage(bmpd,sourceRect.x,sourceRect.y,sourceRect.width,sourceRect.height,destRect.x,destRect.y,destRect.width,destRect.height)}}};BitmapData.prototype.fillRect=function(rect,color){if(this._locked){if(this._imageData){this._context.putImageData(this._imageData,0,0)}this._context.fillStyle=this.hexToRGBACSS(color);this._context.fillRect(rect.x,rect.y,rect.width,rect.height);if(this._imageData){this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height)}}else{this._context.fillStyle=this.hexToRGBACSS(color);this._context.fillRect(rect.x,rect.y,rect.width,rect.height)}};BitmapData.prototype.draw=function(source,matrix){if(this._locked){if(this._imageData){this._context.putImageData(this._imageData,0,0)}this._draw(source,matrix);if(this._imageData){this._imageData=this._context.getImageData(0,0,this._rect.width,this._rect.height)}}else{this._draw(source,matrix)}};BitmapData.prototype._draw=function(source,matrix){if(source instanceof away.display.BitmapData){this._context.save();this._context.setTransform(matrix.a,matrix.b,matrix.c,matrix.d,matrix.tx,matrix.ty);this._context.drawImage(source.canvas,0,0);this._context.restore()}else{if(source instanceof HTMLImageElement){this._context.save();this._context.setTransform(matrix.a,matrix.b,matrix.c,matrix.d,matrix.tx,matrix.ty);this._context.drawImage(source,0,0);this._context.restore()}}};Object.defineProperty(BitmapData.prototype,"imageData",{get:function(){return this._context.getImageData(0,0,this._rect.width,this._rect.height)},set:function(value){this._context.putImageData(value,0,0)},enumerable:true,configurable:true});Object.defineProperty(BitmapData.prototype,"width",{get:function(){return this._imageCanvas.width},set:function(value){this._rect.width=value;this._imageCanvas.width=value},enumerable:true,configurable:true});Object.defineProperty(BitmapData.prototype,"height",{get:function(){return this._imageCanvas.height},set:function(value){this._rect.height=value;this._imageCanvas.height=value},enumerable:true,configurable:true});Object.defineProperty(BitmapData.prototype,"rect",{get:function(){return this._rect},enumerable:true,configurable:true});Object.defineProperty(BitmapData.prototype,"canvas",{get:function(){return this._imageCanvas},enumerable:true,configurable:true});Object.defineProperty(BitmapData.prototype,"context",{get:function(){return this._context},enumerable:true,configurable:true});BitmapData.prototype.hexToRGBACSS=function(d){var argb=away.utils.ColorUtils.float32ColorToARGB(d);if(this._transparent==false){argb[0]=1;return"rgba("+argb[1]+","+argb[2]+","+argb[3]+","+argb[0]+")"}return"rgba("+argb[1]+","+argb[2]+","+argb[3]+","+argb[0]/255+")"};return BitmapData})();display.BitmapData=BitmapData})(away.display||(away.display={}));var display=away.display})(away||(away={}));var away;(function(away){(function(display3D){var Texture=(function(_super){__extends(Texture,_super);function Texture(gl,width,height){_super.call(this,gl);this._width=width;this._height=height;this._gl.bindTexture(this._gl.TEXTURE_2D,this.glTexture);this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,width,height,0,this._gl.RGBA,this._gl.UNSIGNED_BYTE,null)}Object.defineProperty(Texture.prototype,"width",{get:function(){return this._width},enumerable:true,configurable:true});Object.defineProperty(Texture.prototype,"height",{get:function(){return this._height},enumerable:true,configurable:true});Texture.prototype.uploadFromHTMLImageElement=function(image,miplevel){if(typeof miplevel==="undefined"){miplevel=0}this._gl.texImage2D(this._gl.TEXTURE_2D,miplevel,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,image)};Texture.prototype.uploadFromBitmapData=function(data,miplevel){if(typeof miplevel==="undefined"){miplevel=0}this._gl.texImage2D(this._gl.TEXTURE_2D,miplevel,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,data.imageData)};return Texture})(display3D.TextureBase);display3D.Texture=Texture})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var CubeTexture=(function(_super){__extends(CubeTexture,_super);function CubeTexture(gl,size){_super.call(this,gl);this._size=size}CubeTexture.prototype.uploadFromHTMLImageElement=function(image,miplevel){if(typeof miplevel==="undefined"){miplevel=0}this._gl.texImage2D(this._gl.TEXTURE_2D,miplevel,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,image)};CubeTexture.prototype.uploadFromBitmapData=function(data,miplevel){if(typeof miplevel==="undefined"){miplevel=0}this._gl.texImage2D(this._gl.TEXTURE_2D,miplevel,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,data.imageData)};return CubeTexture})(away.display3D.TextureBase);display3D.CubeTexture=CubeTexture})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DTriangleFace=(function(){function Context3DTriangleFace(){}Context3DTriangleFace.BACK="back";Context3DTriangleFace.FRONT="front";Context3DTriangleFace.FRONT_AND_BACK="frontAndBack";Context3DTriangleFace.NONE="none";return Context3DTriangleFace})();display3D.Context3DTriangleFace=Context3DTriangleFace})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DVertexBufferFormat=(function(){function Context3DVertexBufferFormat(){}Context3DVertexBufferFormat.BYTES_4="bytes4";Context3DVertexBufferFormat.FLOAT_1="float1";Context3DVertexBufferFormat.FLOAT_2="float2";Context3DVertexBufferFormat.FLOAT_3="float3";Context3DVertexBufferFormat.FLOAT_4="float4";return Context3DVertexBufferFormat})();display3D.Context3DVertexBufferFormat=Context3DVertexBufferFormat})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DProgramType=(function(){function Context3DProgramType(){}Context3DProgramType.FRAGMENT="fragment";Context3DProgramType.VERTEX="vertex";return Context3DProgramType})();display3D.Context3DProgramType=Context3DProgramType})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DBlendFactor=(function(){function Context3DBlendFactor(){}Context3DBlendFactor.DESTINATION_ALPHA="destinationAlpha";Context3DBlendFactor.DESTINATION_COLOR="destinationColor";Context3DBlendFactor.ONE="one";Context3DBlendFactor.ONE_MINUS_DESTINATION_ALPHA="oneMinusDestinationAlpha";Context3DBlendFactor.ONE_MINUS_DESTINATION_COLOR="oneMinusDestinationColor";Context3DBlendFactor.ONE_MINUS_SOURCE_ALPHA="oneMinusSourceAlpha";Context3DBlendFactor.ONE_MINUS_SOURCE_COLOR="oneMinusSourceColor";Context3DBlendFactor.SOURCE_ALPHA="sourceAlpha";Context3DBlendFactor.SOURCE_COLOR="sourceColor";Context3DBlendFactor.ZERO="zero";return Context3DBlendFactor})();display3D.Context3DBlendFactor=Context3DBlendFactor})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DCompareMode=(function(){function Context3DCompareMode(){}Context3DCompareMode.ALWAYS="always";Context3DCompareMode.EQUAL="equal";Context3DCompareMode.GREATER="greater";Context3DCompareMode.GREATER_EQUAL="greaterEqual";Context3DCompareMode.LESS="less";Context3DCompareMode.LESS_EQUAL="lessEqual";Context3DCompareMode.NEVER="never";Context3DCompareMode.NOT_EQUAL="notEqual";return Context3DCompareMode})();display3D.Context3DCompareMode=Context3DCompareMode})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DMipFilter=(function(){function Context3DMipFilter(){}Context3DMipFilter.MIPLINEAR="miplinear";Context3DMipFilter.MIPNEAREST="mipnearest";Context3DMipFilter.MIPNONE="mipnone";return Context3DMipFilter})();display3D.Context3DMipFilter=Context3DMipFilter})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DProfile=(function(){function Context3DProfile(){}Context3DProfile.BASELINE="baseline";Context3DProfile.BASELINE_CONSTRAINED="baselineConstrained";Context3DProfile.BASELINE_EXTENDED="baselineExtended";return Context3DProfile})();display3D.Context3DProfile=Context3DProfile})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DStencilAction=(function(){function Context3DStencilAction(){}Context3DStencilAction.DECREMENT_SATURATE="decrementSaturate";Context3DStencilAction.DECREMENT_WRAP="decrementWrap";Context3DStencilAction.INCREMENT_SATURATE="incrementSaturate";Context3DStencilAction.INCREMENT_WRAP="incrementWrap";Context3DStencilAction.INVERT="invert";Context3DStencilAction.KEEP="keep";Context3DStencilAction.SET="set";Context3DStencilAction.ZERO="zero";return Context3DStencilAction})();display3D.Context3DStencilAction=Context3DStencilAction})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DTextureFilter=(function(){function Context3DTextureFilter(){}Context3DTextureFilter.LINEAR="linear";Context3DTextureFilter.NEAREST="nearest";return Context3DTextureFilter})();display3D.Context3DTextureFilter=Context3DTextureFilter})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3DWrapMode=(function(){function Context3DWrapMode(){}Context3DWrapMode.CLAMP="clamp";Context3DWrapMode.REPEAT="repeat";return Context3DWrapMode})();display3D.Context3DWrapMode=Context3DWrapMode})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var Context3D=(function(){function Context3D(canvas){this._indexBufferList=[];this._vertexBufferList=[];this._textureList=[];this._programList=[];try{this._gl=canvas.getContext("experimental-webgl");if(!this._gl){this._gl=canvas.getContext("webgl")}}catch(e){}if(this._gl){}else{alert("WebGL is not available.")}}Context3D.prototype.gl=function(){return this._gl};Context3D.prototype.clear=function(red,green,blue,alpha,depth,stencil,mask){if(typeof red==="undefined"){red=0}if(typeof green==="undefined"){green=0}if(typeof blue==="undefined"){blue=0}if(typeof alpha==="undefined"){alpha=1}if(typeof depth==="undefined"){depth=1}if(typeof stencil==="undefined"){stencil=0}if(typeof mask==="undefined"){mask=display3D.Context3DClearMask.ALL}if(!this._drawing){this.updateBlendStatus();this._drawing=true}this._gl.clearColor(red,green,blue,alpha);this._gl.clearDepth(depth);this._gl.clearStencil(stencil);this._gl.clear(mask)};Context3D.prototype.configureBackBuffer=function(width,height,antiAlias,enableDepthAndStencil){if(typeof enableDepthAndStencil==="undefined"){enableDepthAndStencil=true}if(enableDepthAndStencil){this._gl.enable(this._gl.STENCIL_TEST);this._gl.enable(this._gl.DEPTH_TEST)}this._gl.viewport.width=width;this._gl.viewport.height=height;this._gl.viewport(0,0,width,height)};Context3D.prototype.createCubeTexture=function(size,format,optimizeForRenderToTexture,streamingLevels){if(typeof streamingLevels==="undefined"){streamingLevels=0}var texture=new away.display3D.CubeTexture(this._gl,size);this._textureList.push(texture);return texture};Context3D.prototype.createIndexBuffer=function(numIndices){var indexBuffer=new away.display3D.IndexBuffer3D(this._gl,numIndices);this._indexBufferList.push(indexBuffer);return indexBuffer};Context3D.prototype.createProgram=function(){var program=new away.display3D.Program3D(this._gl);this._programList.push(program);return program};Context3D.prototype.createTexture=function(width,height,format,optimizeForRenderToTexture,streamingLevels){if(typeof streamingLevels==="undefined"){streamingLevels=0}var texture=new away.display3D.Texture(this._gl,width,height);this._textureList.push(texture);return texture};Context3D.prototype.createVertexBuffer=function(numVertices,data32PerVertex){var vertexBuffer=new away.display3D.VertexBuffer3D(this._gl,numVertices,data32PerVertex);this._vertexBufferList.push(vertexBuffer);return vertexBuffer};Context3D.prototype.dispose=function(){var i;for(i=0;i<this._indexBufferList.length;++i){this._indexBufferList[i].dispose()}this._indexBufferList=null;for(i=0;i<this._vertexBufferList.length;++i){this._vertexBufferList[i].dispose()}this._vertexBufferList=null;for(i=0;i<this._textureList.length;++i){this._textureList[i].dispose()}this._textureList=null;for(i=0;i<this._programList.length;++i){this._programList[i].dispose()}this._programList=null};Context3D.prototype.drawToBitmapData=function(destination){throw new away.errors.PartialImplementationError()};Context3D.prototype.drawTriangles=function(indexBuffer,firstIndex,numTriangles){if(typeof firstIndex==="undefined"){firstIndex=0}if(typeof numTriangles==="undefined"){numTriangles=-1}if(!this._drawing){throw"Need to clear before drawing if the buffer has not been cleared since the last present() call."}var numIndices=0;if(numTriangles==-1){numIndices=indexBuffer.numIndices}else{numIndices=numTriangles*3}this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,indexBuffer.glBuffer);this._gl.drawElements(this._gl.TRIANGLES,numIndices,this._gl.UNSIGNED_SHORT,firstIndex)};Context3D.prototype.present=function(){this._drawing=false};Context3D.prototype.setBlendFactors=function(sourceFactor,destinationFactor){this._blendEnabled=true;switch(sourceFactor){case away.display3D.Context3DBlendFactor.ONE:this._blendSourceFactor=this._gl.ONE;break;case away.display3D.Context3DBlendFactor.DESTINATION_ALPHA:this._blendSourceFactor=this._gl.DST_ALPHA;break;case away.display3D.Context3DBlendFactor.DESTINATION_COLOR:this._blendSourceFactor=this._gl.DST_COLOR;break;case away.display3D.Context3DBlendFactor.ONE:this._blendSourceFactor=this._gl.ONE;break;case away.display3D.Context3DBlendFactor.ONE_MINUS_DESTINATION_ALPHA:this._blendSourceFactor=this._gl.ONE_MINUS_DST_ALPHA;break;case away.display3D.Context3DBlendFactor.ONE_MINUS_DESTINATION_COLOR:this._blendSourceFactor=this._gl.ONE_MINUS_DST_COLOR;break;case away.display3D.Context3DBlendFactor.ONE_MINUS_SOURCE_ALPHA:this._blendSourceFactor=this._gl.ONE_MINUS_SRC_ALPHA;break;case away.display3D.Context3DBlendFactor.ONE_MINUS_SOURCE_COLOR:this._blendSourceFactor=this._gl.ONE_MINUS_SRC_COLOR;break;case away.display3D.Context3DBlendFactor.SOURCE_ALPHA:this._blendSourceFactor=this._gl.SRC_ALPHA;break;case away.display3D.Context3DBlendFactor.SOURCE_COLOR:this._blendSourceFactor=this._gl.SRC_COLOR;break;case away.display3D.Context3DBlendFactor.ZERO:this._blendSourceFactor=this._gl.ZERO;break;default:throw"Unknown blend source factor";break}switch(destinationFactor){case away.display3D.Context3DBlendFactor.ONE:this._blendDestinationFactor=this._gl.ONE;break;case away.display3D.Context3DBlendFactor.DESTINATION_ALPHA:this._blendDestinationFactor=this._gl.DST_ALPHA;break;case away.display3D.Context3DBlendFactor.DESTINATION_COLOR:this._blendDestinationFactor=this._gl.DST_COLOR;break;case away.display3D.Context3DBlendFactor.ONE:this._blendDestinationFactor=this._gl.ONE;break;case away.display3D.Context3DBlendFactor.ONE_MINUS_DESTINATION_ALPHA:this._blendDestinationFactor=this._gl.ONE_MINUS_DST_ALPHA;break;case away.display3D.Context3DBlendFactor.ONE_MINUS_DESTINATION_COLOR:this._blendDestinationFactor=this._gl.ONE_MINUS_DST_COLOR;break;case away.display3D.Context3DBlendFactor.ONE_MINUS_SOURCE_ALPHA:this._blendDestinationFactor=this._gl.ONE_MINUS_SRC_ALPHA;break;case away.display3D.Context3DBlendFactor.ONE_MINUS_SOURCE_COLOR:this._blendDestinationFactor=this._gl.ONE_MINUS_SRC_COLOR;break;case away.display3D.Context3DBlendFactor.SOURCE_ALPHA:this._blendDestinationFactor=this._gl.SRC_ALPHA;break;case away.display3D.Context3DBlendFactor.SOURCE_COLOR:this._blendDestinationFactor=this._gl.SRC_COLOR;break;case away.display3D.Context3DBlendFactor.ZERO:this._blendDestinationFactor=this._gl.ZERO;break;default:throw"Unknown blend destination factor";break}this.updateBlendStatus()};Context3D.prototype.setColorMask=function(red,green,blue,alpha){this._gl.colorMask(red,green,blue,alpha)};Context3D.prototype.setCulling=function(triangleFaceToCull){if(triangleFaceToCull==display3D.Context3DTriangleFace.NONE){this._gl.disable(this._gl.CULL_FACE)}else{this._gl.enable(this._gl.CULL_FACE);switch(triangleFaceToCull){case display3D.Context3DTriangleFace.FRONT:this._gl.cullFace(this._gl.FRONT);break;case display3D.Context3DTriangleFace.BACK:this._gl.cullFace(this._gl.BACK);break;case display3D.Context3DTriangleFace.FRONT_AND_BACK:this._gl.cullFace(this._gl.FRONT_AND_BACK);break;default:throw"Unknown Context3DTriangleFace type."}}};Context3D.prototype.setDepthTest=function(depthMask,passCompareMode){switch(passCompareMode){case display3D.Context3DCompareMode.ALWAYS:this._gl.depthFunc(this._gl.ALWAYS);break;case display3D.Context3DCompareMode.EQUAL:this._gl.depthFunc(this._gl.EQUAL);break;case display3D.Context3DCompareMode.GREATER:this._gl.depthFunc(this._gl.GREATER);break;case display3D.Context3DCompareMode.GREATER_EQUAL:this._gl.depthFunc(this._gl.GEQUAL);break;case display3D.Context3DCompareMode.LESS:this._gl.depthFunc(this._gl.LESS);break;case display3D.Context3DCompareMode.LESS_EQUAL:this._gl.depthFunc(this._gl.LEQUAL);break;case display3D.Context3DCompareMode.NEVER:this._gl.depthFunc(this._gl.NEVER);break;case display3D.Context3DCompareMode.NOT_EQUAL:this._gl.depthFunc(this._gl.NOTEQUAL);break;default:throw"Unknown Context3DCompareMode type.";break}this._gl.depthMask(depthMask)};Context3D.prototype.setProgram=function(program3D){this._currentProgram=program3D;program3D.focusProgram()};Context3D.prototype.getUniformLocationNameFromAgalRegisterIndex=function(programType,firstRegister){switch(programType){case display3D.Context3DProgramType.VERTEX:return"vc";break;case display3D.Context3DProgramType.FRAGMENT:return"fc";break;default:throw"Program Type "+programType+" not supported"}};Context3D.prototype.setProgramConstantsFromMatrix=function(programType,firstRegister,matrix,transposedMatrix){if(typeof transposedMatrix==="undefined"){transposedMatrix=false}var locationName=this.getUniformLocationNameFromAgalRegisterIndex(programType,firstRegister);this.setGLSLProgramConstantsFromMatrix(locationName,matrix,transposedMatrix)};Context3D.prototype.setProgramConstantsFromArray=function(programType,firstRegister,data,numRegisters){if(typeof numRegisters==="undefined"){numRegisters=-1}for(var i=0;i<numRegisters;++i){var currentIndex=i*4;var locationName=this.getUniformLocationNameFromAgalRegisterIndex(programType,firstRegister+i)+(i+firstRegister);this.setGLSLProgramConstantsFromArray(locationName,data,currentIndex)}};Context3D.prototype.setGLSLProgramConstantsFromMatrix=function(locationName,matrix,transposedMatrix){if(typeof transposedMatrix==="undefined"){transposedMatrix=false}var location=this._gl.getUniformLocation(this._currentProgram.glProgram,locationName);this._gl.uniformMatrix4fv(location,!transposedMatrix,new Float32Array(matrix.rawData))};Context3D.prototype.setGLSLProgramConstantsFromArray=function(locationName,data,startIndex){if(typeof startIndex==="undefined"){startIndex=0}var location=this._gl.getUniformLocation(this._currentProgram.glProgram,locationName);this._gl.uniform4f(location,data[startIndex],data[startIndex+1],data[startIndex+2],data[startIndex+3])};Context3D.prototype.setScissorRectangle=function(rectangle){if(!rectangle){this._gl.disable(this._gl.SCISSOR_TEST);return}this._gl.enable(this._gl.SCISSOR_TEST);this._gl.scissor(rectangle.x,rectangle.y,rectangle.width,rectangle.height)};Context3D.prototype.setTextureAt=function(sampler,texture){var locationName="fs"+sampler;this.setGLSLTextureAt(locationName,texture,sampler)};Context3D.prototype.setGLSLTextureAt=function(locationName,texture,textureIndex){if(!texture){this._gl.activeTexture(this._gl.TEXTURE0+(textureIndex));this._gl.bindTexture(this._gl.TEXTURE_2D,null);return}var location=this._gl.getUniformLocation(this._currentProgram.glProgram,locationName);switch(textureIndex){case 0:this._gl.activeTexture(this._gl.TEXTURE0);break;case 1:this._gl.activeTexture(this._gl.TEXTURE1);break;case 2:this._gl.activeTexture(this._gl.TEXTURE2);break;case 3:this._gl.activeTexture(this._gl.TEXTURE3);break;case 4:this._gl.activeTexture(this._gl.TEXTURE4);break;case 5:this._gl.activeTexture(this._gl.TEXTURE5);break;case 6:this._gl.activeTexture(this._gl.TEXTURE6);break;case 7:this._gl.activeTexture(this._gl.TEXTURE7);break;default:throw"Texture "+textureIndex+" is out of bounds."}this._gl.bindTexture(this._gl.TEXTURE_2D,texture.glTexture);this._gl.uniform1i(location,textureIndex);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR)};Context3D.prototype.setVertexBufferAt=function(index,buffer,bufferOffset,format){if(typeof bufferOffset==="undefined"){bufferOffset=0}if(typeof format==="undefined"){format=null}var locationName="va"+index;this.setGLSLVertexBufferAt(locationName,buffer,bufferOffset,format)};Context3D.prototype.setGLSLVertexBufferAt=function(locationName,buffer,bufferOffset,format){if(typeof bufferOffset==="undefined"){bufferOffset=0}if(typeof format==="undefined"){format=null}var location=this._gl.getAttribLocation(this._currentProgram.glProgram,locationName);if(!buffer){if(location>-1){this._gl.disableVertexAttribArray(location)}return}this._gl.bindBuffer(this._gl.ARRAY_BUFFER,buffer.glBuffer);var dimension;var type=this._gl.FLOAT;var numBytes=4;switch(format){case display3D.Context3DVertexBufferFormat.BYTES_4:dimension=4;break;case display3D.Context3DVertexBufferFormat.FLOAT_1:dimension=1;break;case display3D.Context3DVertexBufferFormat.FLOAT_2:dimension=2;break;case display3D.Context3DVertexBufferFormat.FLOAT_3:dimension=3;break;case display3D.Context3DVertexBufferFormat.FLOAT_4:dimension=4;break;default:throw"Buffer format "+format+" is not supported."}this._gl.enableVertexAttribArray(location);this._gl.vertexAttribPointer(location,dimension,type,false,buffer.data32PerVertex*numBytes,bufferOffset*numBytes)};Context3D.prototype.updateBlendStatus=function(){if(this._blendEnabled){this._gl.enable(this._gl.BLEND);this._gl.blendEquation(this._gl.FUNC_ADD);this._gl.blendFunc(this._blendSourceFactor,this._blendDestinationFactor)}else{this._gl.disable(this._gl.BLEND)}};Context3D.modulo=0;return Context3D})();display3D.Context3D=Context3D})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(display3D){var AGLSLContext3D=(function(_super){__extends(AGLSLContext3D,_super);function AGLSLContext3D(canvas){_super.call(this,canvas)}AGLSLContext3D.prototype.setProgramConstantsFromMatrix=function(programType,firstRegister,matrix,transposedMatrix){if(typeof transposedMatrix==="undefined"){transposedMatrix=false}var d=matrix.rawData;if(transposedMatrix){this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[4],d[8],d[12]],1);this.setProgramConstantsFromArray(programType,firstRegister+1,[d[1],d[5],d[9],d[13]],1);this.setProgramConstantsFromArray(programType,firstRegister+2,[d[2],d[6],d[10],d[14]],1);this.setProgramConstantsFromArray(programType,firstRegister+3,[d[3],d[7],d[11],d[15]],1)}else{this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[1],d[2],d[3]],1);this.setProgramConstantsFromArray(programType,firstRegister+1,[d[4],d[5],d[6],d[7]],1);this.setProgramConstantsFromArray(programType,firstRegister+2,[d[8],d[9],d[10],d[11]],1);this.setProgramConstantsFromArray(programType,firstRegister+3,[d[12],d[13],d[14],d[15]],1)}};AGLSLContext3D.prototype.drawTriangles=function(indexBuffer,firstIndex,numTriangles){if(typeof firstIndex==="undefined"){firstIndex=0}if(typeof numTriangles==="undefined"){numTriangles=-1}var location=this._gl.getUniformLocation(this._currentProgram.glProgram,"yflip");this._gl.uniform1f(location,-1);_super.prototype.drawTriangles.call(this,indexBuffer,firstIndex,numTriangles)};return AGLSLContext3D})(display3D.Context3D);display3D.AGLSLContext3D=AGLSLContext3D})(away.display3D||(away.display3D={}));var display3D=away.display3D})(away||(away={}));var away;(function(away){(function(materials){var MaterialBase=(function(_super){__extends(MaterialBase,_super);function MaterialBase(){_super.call(this);this._iRenderOrderId=0;this._bothSides=false;this._pBlendMode=away.display.BlendMode.NORMAL;this._numPasses=0;this._pMipmap=true;this._smooth=true;this._repeat=false;this._pDepthCompareMode=away.display3D.Context3DCompareMode.LESS_EQUAL;this._owners=new Array();this._passes=new Array();this._pDepthPass=new away.materials.DepthMapPass();this._pDistancePass=new away.materials.DistanceMapPass();this._pDepthPass.addEventListener(away.events.Event.CHANGE,this.onDepthPassChange,this);this._pDistancePass.addEventListener(away.events.Event.CHANGE,this.onDistancePassChange,this);this.alphaPremultiplied=true;this._iUniqueId=away.materials.MaterialBase.MATERIAL_ID_COUNT++}Object.defineProperty(MaterialBase.prototype,"assetType",{get:function(){return away.library.AssetType.MATERIAL},enumerable:true,configurable:true});Object.defineProperty(MaterialBase.prototype,"lightPicker",{get:function(){return this._pLightPicker},set:function(value){this.setLightPicker(value)},enumerable:true,configurable:true});MaterialBase.prototype.setLightPicker=function(value){if(value!=this._pLightPicker){this._pLightPicker=value;var len=this._passes.length;for(var i=0;i<len;++i){this._passes[i].lightPicker=this._pLightPicker}}};Object.defineProperty(MaterialBase.prototype,"mipmap",{get:function(){return this._pMipmap},set:function(value){this.setMipMap(value)},enumerable:true,configurable:true});MaterialBase.prototype.setMipMap=function(value){this._pMipmap=value;for(var i=0;i<this._numPasses;++i){this._passes[i].mipmap=value}};Object.defineProperty(MaterialBase.prototype,"smooth",{get:function(){return this._smooth},set:function(value){this._smooth=value;for(var i=0;i<this._numPasses;++i){this._passes[i].smooth=value}},enumerable:true,configurable:true});Object.defineProperty(MaterialBase.prototype,"depthCompareMode",{get:function(){return this._pDepthCompareMode},set:function(value){this.setDepthCompareMode(value)},enumerable:true,configurable:true});MaterialBase.prototype.setDepthCompareMode=function(value){this._pDepthCompareMode=value};Object.defineProperty(MaterialBase.prototype,"repeat",{get:function(){return this._repeat},set:function(value){this._repeat=value;for(var i=0;i<this._numPasses;++i){this._passes[i].repeat=value}},enumerable:true,configurable:true});MaterialBase.prototype.dispose=function(){var i;for(i=0;i<this._numPasses;++i){this._passes[i].dispose()}this._pDepthPass.dispose();this._pDistancePass.dispose();this._pDepthPass.removeEventListener(away.events.Event.CHANGE,this.onDepthPassChange,this);this._pDistancePass.removeEventListener(away.events.Event.CHANGE,this.onDistancePassChange,this)};Object.defineProperty(MaterialBase.prototype,"bothSides",{get:function(){return this._bothSides},set:function(value){this._bothSides=value;for(var i=0;i<this._numPasses;++i){this._passes[i].bothSides=value}this._pDepthPass.bothSides=value;this._pDistancePass.bothSides=value},enumerable:true,configurable:true});Object.defineProperty(MaterialBase.prototype,"blendMode",{get:function(){return this.getBlendMode()},set:function(value){this.setBlendMode(value)},enumerable:true,configurable:true});MaterialBase.prototype.getBlendMode=function(){return this._pBlendMode};MaterialBase.prototype.setBlendMode=function(value){this._pBlendMode=value};Object.defineProperty(MaterialBase.prototype,"alphaPremultiplied",{get:function(){return this._alphaPremultiplied},set:function(value){this._alphaPremultiplied=value;for(var i=0;i<this._numPasses;++i){this._passes[i].alphaPremultiplied=value}},enumerable:true,configurable:true});Object.defineProperty(MaterialBase.prototype,"requiresBlending",{get:function(){return this.getRequiresBlending()},enumerable:true,configurable:true});MaterialBase.prototype.getRequiresBlending=function(){return this._pBlendMode!=away.display.BlendMode.NORMAL};Object.defineProperty(MaterialBase.prototype,"uniqueId",{get:function(){return this._iUniqueId},enumerable:true,configurable:true});Object.defineProperty(MaterialBase.prototype,"_iNumPasses",{get:function(){return this._numPasses},enumerable:true,configurable:true});MaterialBase.prototype.iHasDepthAlphaThreshold=function(){return this._pDepthPass.alphaThreshold>0};MaterialBase.prototype.iActivateForDepth=function(stage3DProxy,camera,distanceBased){if(typeof distanceBased==="undefined"){distanceBased=false}this._distanceBasedDepthRender=distanceBased;if(distanceBased){this._pDistancePass.iActivate(stage3DProxy,camera)}else{this._pDepthPass.iActivate(stage3DProxy,camera)}};MaterialBase.prototype.iDeactivateForDepth=function(stage3DProxy){if(this._distanceBasedDepthRender){this._pDistancePass.iDeactivate(stage3DProxy)}else{this._pDepthPass.iDeactivate(stage3DProxy)}};MaterialBase.prototype.iRenderDepth=function(renderable,stage3DProxy,camera,viewProjection){if(this._distanceBasedDepthRender){if(renderable.animator){this._pDistancePass.iUpdateAnimationState(renderable,stage3DProxy,camera)}this._pDistancePass.iRender(renderable,stage3DProxy,camera,viewProjection)}else{if(renderable.animator){this._pDepthPass.iUpdateAnimationState(renderable,stage3DProxy,camera)}this._pDepthPass.iRender(renderable,stage3DProxy,camera,viewProjection)}};MaterialBase.prototype.iPassRendersToTexture=function(index){return this._passes[index].renderToTexture};MaterialBase.prototype.iActivatePass=function(index,stage3DProxy,camera){this._passes[index].iActivate(stage3DProxy,camera)};MaterialBase.prototype.iDeactivatePass=function(index,stage3DProxy){this._passes[index].iDeactivate(stage3DProxy)};MaterialBase.prototype.iRenderPass=function(index,renderable,stage3DProxy,entityCollector,viewProjection){if(this._pLightPicker){this._pLightPicker.collectLights(renderable,entityCollector)}var pass=this._passes[index];if(renderable.animator){pass.iUpdateAnimationState(renderable,stage3DProxy,entityCollector.camera)}pass.iRender(renderable,stage3DProxy,entityCollector.camera,viewProjection)};MaterialBase.prototype.iAddOwner=function(owner){this._owners.push(owner);if(owner.animator){if(this._animationSet&&owner.animator.animationSet!=this._animationSet){throw new Error("A Material instance cannot be shared across renderables with different animator libraries")}else{if(this._animationSet!=owner.animator.animationSet){this._animationSet=owner.animator.animationSet;for(var i=0;i<this._numPasses;++i){this._passes[i].animationSet=this._animationSet}this._pDepthPass.animationSet=this._animationSet;this._pDistancePass.animationSet=this._animationSet;this.iInvalidatePasses(null)}}}};MaterialBase.prototype.iRemoveOwner=function(owner){this._owners.splice(this._owners.indexOf(owner),1);if(this._owners.length==0){this._animationSet=null;for(var i=0;i<this._numPasses;++i){this._passes[i].animationSet=this._animationSet}this._pDepthPass.animationSet=this._animationSet;this._pDistancePass.animationSet=this._animationSet;this.iInvalidatePasses(null)}};Object.defineProperty(MaterialBase.prototype,"iOwners",{get:function(){return this._owners},enumerable:true,configurable:true});MaterialBase.prototype.iUpdateMaterial=function(context){throw new away.errors.AbstractMethodError()};MaterialBase.prototype.iDeactivate=function(stage3DProxy){this._passes[this._numPasses-1].iDeactivate(stage3DProxy)};MaterialBase.prototype.iInvalidatePasses=function(triggerPass){var owner;var l;var c;this._pDepthPass.iInvalidateShaderProgram();this._pDistancePass.iInvalidateShaderProgram();if(this._animationSet){this._animationSet.resetGPUCompatibility();l=this._owners.length;for(c=0;c<l;c++){owner=this._owners[c];if(owner.animator){owner.animator.testGPUCompatibility(this._pDepthPass);owner.animator.testGPUCompatibility(this._pDistancePass)}}}for(var i=0;i<this._numPasses;++i){if(this._passes[i]!=triggerPass){this._passes[i].iInvalidateShaderProgram(false)}if(this._animationSet){l=this._owners.length;for(c=0;c<l;c++){owner=this._owners[c];if(owner.animator){owner.animator.testGPUCompatibility(this._passes[i])}}}}};MaterialBase.prototype.pRemovePass=function(pass){this._passes.splice(this._passes.indexOf(pass),1);--this._numPasses};MaterialBase.prototype.pClearPasses=function(){for(var i=0;i<this._numPasses;++i){this._passes[i].removeEventListener(away.events.Event.CHANGE,this.onPassChange,this)}this._passes.length=0;this._numPasses=0};MaterialBase.prototype.pAddPass=function(pass){this._passes[this._numPasses++]=pass;pass.animationSet=this._animationSet;pass.alphaPremultiplied=this._alphaPremultiplied;pass.mipmap=this._pMipmap;pass.smooth=this._smooth;pass.repeat=this._repeat;pass.lightPicker=this._pLightPicker;pass.bothSides=this._bothSides;pass.addEventListener(away.events.Event.CHANGE,this.onPassChange,this);this.iInvalidatePasses(null)};MaterialBase.prototype.onPassChange=function(event){var mult=1;var ids;var len;this._iRenderOrderId=0;for(var i=0;i<this._numPasses;++i){ids=this._passes[i]._iProgram3Dids;len=ids.length;for(var j=0;j<len;++j){if(ids[j]!=-1){this._iRenderOrderId+=mult*ids[j];j=len}}mult*=1000}};MaterialBase.prototype.onDistancePassChange=function(event){var ids=this._pDistancePass._iProgram3Dids;var len=ids.length;this._iDepthPassId=0;for(var j=0;j<len;++j){if(ids[j]!=-1){this._iDepthPassId+=ids[j];j=len}}};MaterialBase.prototype.onDepthPassChange=function(event){var ids=this._pDepthPass._iProgram3Dids;var len=ids.length;this._iDepthPassId=0;for(var j=0;j<len;++j){if(ids[j]!=-1){this._iDepthPassId+=ids[j];j=len}}};MaterialBase.MATERIAL_ID_COUNT=0;return MaterialBase})(away.library.NamedAssetBase);materials.MaterialBase=MaterialBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(primitives){var Segment=(function(){function Segment(start,end,anchor,colorStart,colorEnd,thickness){if(typeof colorStart==="undefined"){colorStart=3355443}if(typeof colorEnd==="undefined"){colorEnd=3355443}if(typeof thickness==="undefined"){thickness=1}this._index=-1;this._subSetIndex=-1;anchor=null;this._pThickness=thickness*0.5;this._pStart=start;this._pEnd=end;this.startColor=colorStart;this.endColor=colorEnd}Segment.prototype.updateSegment=function(start,end,anchor,colorStart,colorEnd,thickness){if(typeof colorStart==="undefined"){colorStart=3355443}if(typeof colorEnd==="undefined"){colorEnd=3355443}if(typeof thickness==="undefined"){thickness=1}anchor=null;this._pStart=start;this._pEnd=end;if(this._startColor!=colorStart){this.startColor=colorStart}if(this._endColor!=colorEnd){this.endColor=colorEnd}this._pThickness=thickness*0.5;this.update()};Object.defineProperty(Segment.prototype,"start",{get:function(){return this._pStart},set:function(value){this._pStart=value;this.update()},enumerable:true,configurable:true});Object.defineProperty(Segment.prototype,"end",{get:function(){return this._pEnd},set:function(value){this._pEnd=value;this.update()},enumerable:true,configurable:true});Object.defineProperty(Segment.prototype,"thickness",{get:function(){return this._pThickness*2},set:function(value){this._pThickness=value*0.5;this.update()},enumerable:true,configurable:true});Object.defineProperty(Segment.prototype,"startColor",{get:function(){return this._startColor},set:function(color){this._pStartR=((color>>16)&255)/255;this._pStartG=((color>>8)&255)/255;this._pStartB=(color&255)/255;this._startColor=color;this.update()},enumerable:true,configurable:true});Object.defineProperty(Segment.prototype,"endColor",{get:function(){return this._endColor},set:function(color){this._pEndR=((color>>16)&255)/255;this._pEndG=((color>>8)&255)/255;this._pEndB=(color&255)/255;this._endColor=color;this.update()},enumerable:true,configurable:true});Segment.prototype.dispose=function(){this._pStart=null;this._pEnd=null};Object.defineProperty(Segment.prototype,"iIndex",{get:function(){return this._index},set:function(ind){this._index=ind},enumerable:true,configurable:true});Object.defineProperty(Segment.prototype,"iSubSetIndex",{get:function(){return this._subSetIndex},set:function(ind){this._subSetIndex=ind},enumerable:true,configurable:true});Object.defineProperty(Segment.prototype,"iSegmentsBase",{set:function(segBase){this._pSegmentsBase=segBase},enumerable:true,configurable:true});Segment.prototype.update=function(){if(!this._pSegmentsBase){return}this._pSegmentsBase.iUpdateSegment(this)};return Segment})();primitives.Segment=Segment})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(bounds){var BoundingVolumeBase=(function(){function BoundingVolumeBase(){this._pAabbPoints=[];this._pAabbPointsDirty=true;this._pMin=new away.geom.Vector3D();this._pMax=new away.geom.Vector3D()}Object.defineProperty(BoundingVolumeBase.prototype,"max",{get:function(){return this._pMax},enumerable:true,configurable:true});Object.defineProperty(BoundingVolumeBase.prototype,"min",{get:function(){return this._pMin},enumerable:true,configurable:true});Object.defineProperty(BoundingVolumeBase.prototype,"aabbPoints",{get:function(){if(this._pAabbPointsDirty){this.pUpdateAABBPoints()}return this._pAabbPoints},enumerable:true,configurable:true});Object.defineProperty(BoundingVolumeBase.prototype,"boundingRenderable",{get:function(){if(!this._pBoundingRenderable){this._pBoundingRenderable=this.pCreateBoundingRenderable();this.pUpdateBoundingRenderable()}return this._pBoundingRenderable},enumerable:true,configurable:true});BoundingVolumeBase.prototype.nullify=function(){this._pMin.x=this._pMin.y=this._pMin.z=0;this._pMax.x=this._pMax.y=this._pMax.z=0;this._pAabbPointsDirty=true;if(this._pBoundingRenderable){this.pUpdateBoundingRenderable()}};BoundingVolumeBase.prototype.disposeRenderable=function(){if(this._pBoundingRenderable){this._pBoundingRenderable.dispose()}this._pBoundingRenderable=null};BoundingVolumeBase.prototype.fromVertices=function(vertices){var i;var len=vertices.length;var minX,minY,minZ;var maxX,maxY,maxZ;if(len==0){this.nullify();return}var v;minX=maxX=vertices[i++];minY=maxY=vertices[i++];minZ=maxZ=vertices[i++];while(i<len){v=vertices[i++];if(v<minX){minX=v}else{if(v>maxX){maxX=v}}v=vertices[i++];if(v<minY){minY=v}else{if(v>maxY){maxY=v}}v=vertices[i++];if(v<minZ){minZ=v}else{if(v>maxZ){maxZ=v}}}this.fromExtremes(minX,minY,minZ,maxX,maxY,maxZ)};BoundingVolumeBase.prototype.fromGeometry=function(geometry){var subGeoms=geometry.subGeometries;var numSubGeoms=subGeoms.length;var minX,minY,minZ;var maxX,maxY,maxZ;if(numSubGeoms>0){var j=0;minX=minY=minZ=Number.POSITIVE_INFINITY;maxX=maxY=maxZ=Number.NEGATIVE_INFINITY;while(j<numSubGeoms){var subGeom=subGeoms[j++];var vertices=subGeom.vertexData;var vertexDataLen=vertices.length;var i=subGeom.vertexOffset;var stride=subGeom.vertexStride;while(i<vertexDataLen){var v=vertices[i];if(v<minX){minX=v}else{if(v>maxX){maxX=v}}v=vertices[i+1];if(v<minY){minY=v}else{if(v>maxY){maxY=v}}v=vertices[i+2];if(v<minZ){minZ=v}else{if(v>maxZ){maxZ=v}}i+=stride}}this.fromExtremes(minX,minY,minZ,maxX,maxY,maxZ)}else{this.fromExtremes(0,0,0,0,0,0)}};BoundingVolumeBase.prototype.fromSphere=function(center,radius){this.fromExtremes(center.x-radius,center.y-radius,center.z-radius,center.x+radius,center.y+radius,center.z+radius)};BoundingVolumeBase.prototype.fromExtremes=function(minX,minY,minZ,maxX,maxY,maxZ){this._pMin.x=minX;this._pMin.y=minY;this._pMin.z=minZ;this._pMax.x=maxX;this._pMax.y=maxY;this._pMax.z=maxZ;this._pAabbPointsDirty=true;if(this._pBoundingRenderable){this.pUpdateBoundingRenderable()}};BoundingVolumeBase.prototype.isInFrustum=function(planes,numPlanes){throw new away.errors.AbstractMethodError()};BoundingVolumeBase.prototype.overlaps=function(bounds){var min=bounds._pMin;var max=bounds._pMax;return this._pMax.x>min.x&&this._pMin.x<max.x&&this._pMax.y>min.y&&this._pMin.y<max.y&&this._pMax.z>min.z&&this._pMin.z<max.z};BoundingVolumeBase.prototype.clone=function(){throw new away.errors.AbstractMethodError()};BoundingVolumeBase.prototype.rayIntersection=function(position,direction,targetNormal){position=position;direction=direction;targetNormal=targetNormal;return -1};BoundingVolumeBase.prototype.containsPoint=function(position){position=position;return false};BoundingVolumeBase.prototype.pUpdateAABBPoints=function(){var maxX=this._pMax.x;var maxY=this._pMax.y;var maxZ=this._pMax.z;var minX=this._pMin.x;var minY=this._pMin.y;var minZ=this._pMin.z;this._pAabbPoints[0]=minX;this._pAabbPoints[1]=minY;this._pAabbPoints[2]=minZ;this._pAabbPoints[3]=maxX;this._pAabbPoints[4]=minY;this._pAabbPoints[5]=minZ;this._pAabbPoints[6]=minX;this._pAabbPoints[7]=maxY;this._pAabbPoints[8]=minZ;this._pAabbPoints[9]=maxX;this._pAabbPoints[10]=maxY;this._pAabbPoints[11]=minZ;this._pAabbPoints[12]=minX;this._pAabbPoints[13]=minY;this._pAabbPoints[14]=maxZ;this._pAabbPoints[15]=maxX;this._pAabbPoints[16]=minY;this._pAabbPoints[17]=maxZ;this._pAabbPoints[18]=minX;this._pAabbPoints[19]=maxY;this._pAabbPoints[20]=maxZ;this._pAabbPoints[21]=maxX;this._pAabbPoints[22]=maxY;this._pAabbPoints[23]=maxZ;this._pAabbPointsDirty=false};BoundingVolumeBase.prototype.pUpdateBoundingRenderable=function(){throw new away.errors.AbstractMethodError()};BoundingVolumeBase.prototype.pCreateBoundingRenderable=function(){throw new away.errors.AbstractMethodError()};BoundingVolumeBase.prototype.classifyToPlane=function(plane){throw new away.errors.AbstractMethodError()};BoundingVolumeBase.prototype.transformFrom=function(bounds,matrix){throw new away.errors.AbstractMethodError()};return BoundingVolumeBase})();bounds.BoundingVolumeBase=BoundingVolumeBase})(away.bounds||(away.bounds={}));var bounds=away.bounds})(away||(away={}));var away;(function(away){(function(events){var LensEvent=(function(_super){__extends(LensEvent,_super);function LensEvent(type,lens){_super.call(this,type);this._lens=lens}Object.defineProperty(LensEvent.prototype,"lens",{get:function(){return this._lens},enumerable:true,configurable:true});LensEvent.MATRIX_CHANGED="matrixChanged";return LensEvent})(away.events.Event);events.LensEvent=LensEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(cameras){var LensBase=(function(_super){__extends(LensBase,_super);function LensBase(){_super.call(this);this._pScissorRect=new away.geom.Rectangle();this._pViewPort=new away.geom.Rectangle();this._pNear=20;this._pFar=3000;this._pAspectRatio=1;this._pMatrixInvalid=true;this._pFrustumCorners=[];this._unprojectionInvalid=true;this._pMatrix=new away.geom.Matrix3D()}Object.defineProperty(LensBase.prototype,"frustumCorners",{get:function(){return this._pFrustumCorners},set:function(frustumCorners){this._pFrustumCorners=frustumCorners},enumerable:true,configurable:true});Object.defineProperty(LensBase.prototype,"matrix",{get:function(){if(this._pMatrixInvalid){this.pUpdateMatrix();this._pMatrixInvalid=false}return this._pMatrix},set:function(value){this._pMatrix=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(LensBase.prototype,"near",{get:function(){return this._pNear},set:function(value){if(value==this._pNear){return}this._pNear=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(LensBase.prototype,"far",{get:function(){return this._pFar},set:function(value){if(value==this._pFar){return}this._pFar=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});LensBase.prototype.project=function(point3d){var v=this.matrix.transformVector(point3d);v.x=v.x/v.w;v.y=-v.y/v.w;v.z=point3d.z;return v};Object.defineProperty(LensBase.prototype,"unprojectionMatrix",{get:function(){if(this._unprojectionInvalid){if(!this._unprojection){this._unprojection=new away.geom.Matrix3D()}this._unprojection.copyFrom(this.matrix);this._unprojection.invert();this._unprojectionInvalid=false}return this._unprojection},enumerable:true,configurable:true});LensBase.prototype.unproject=function(nX,nY,sZ){throw new away.errors.AbstractMethodError()};LensBase.prototype.clone=function(){throw new away.errors.AbstractMethodError()};Object.defineProperty(LensBase.prototype,"iAspectRatio",{get:function(){return this._pAspectRatio},set:function(value){if(this._pAspectRatio==value){return}this._pAspectRatio=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});LensBase.prototype.pInvalidateMatrix=function(){this._pMatrixInvalid=true;this._unprojectionInvalid=true;this.dispatchEvent(new away.events.LensEvent(away.events.LensEvent.MATRIX_CHANGED,this))};LensBase.prototype.pUpdateMatrix=function(){throw new away.errors.AbstractMethodError()};LensBase.prototype.iUpdateScissorRect=function(x,y,width,height){this._pScissorRect.x=x;this._pScissorRect.y=y;this._pScissorRect.width=width;this._pScissorRect.height=height;this.pInvalidateMatrix()};LensBase.prototype.iUpdateViewport=function(x,y,width,height){this._pViewPort.x=x;this._pViewPort.y=y;this._pViewPort.width=width;this._pViewPort.height=height;this.pInvalidateMatrix()};return LensBase})(away.events.EventDispatcher);cameras.LensBase=LensBase})(away.cameras||(away.cameras={}));var cameras=away.cameras})(away||(away={}));var away;(function(away){(function(cameras){var PerspectiveLens=(function(_super){__extends(PerspectiveLens,_super);function PerspectiveLens(fieldOfView){if(typeof fieldOfView==="undefined"){fieldOfView=60}_super.call(this);this.fieldOfView=fieldOfView}Object.defineProperty(PerspectiveLens.prototype,"fieldOfView",{get:function(){return this._fieldOfView},set:function(value){if(value==this._fieldOfView){return}this._fieldOfView=value;this._focalLengthInv=Math.tan(this._fieldOfView*Math.PI/360);this._focalLength=1/this._focalLengthInv;this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(PerspectiveLens.prototype,"focalLength",{get:function(){return this._focalLength},set:function(value){if(value==this._focalLength){return}this._focalLength=value;this._focalLengthInv=1/this._focalLength;this._fieldOfView=Math.atan(this._focalLengthInv)*360/Math.PI;this.pInvalidateMatrix()},enumerable:true,configurable:true});PerspectiveLens.prototype.unproject=function(nX,nY,sZ){var v=new away.geom.Vector3D(nX,-nY,sZ,1);v.x*=sZ;v.y*=sZ;v.z=sZ;v=this.unprojectionMatrix.transformVector(v);return v};PerspectiveLens.prototype.clone=function(){var clone=new PerspectiveLens(this._fieldOfView);clone._pNear=this._pNear;clone._pFar=this._pFar;clone._pAspectRatio=this._pAspectRatio;return clone};PerspectiveLens.prototype.pUpdateMatrix=function(){var raw=[];this._yMax=this._pNear*this._focalLengthInv;this._xMax=this._yMax*this._pAspectRatio;var left,right,top,bottom;if(this._pScissorRect.x==0&&this._pScissorRect.y==0&&this._pScissorRect.width==this._pViewPort.width&&this._pScissorRect.height==this._pViewPort.height){left=-this._xMax;right=this._xMax;top=-this._yMax;bottom=this._yMax;raw[0]=this._pNear/this._xMax;raw[5]=this._pNear/this._yMax;raw[10]=this._pFar/(this._pFar-this._pNear);raw[11]=1;raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[8]=raw[9]=raw[12]=raw[13]=raw[15]=0;raw[14]=-this._pNear*raw[10]}else{var xWidth=this._xMax*(this._pViewPort.width/this._pScissorRect.width);var yHgt=this._yMax*(this._pViewPort.height/this._pScissorRect.height);var center=this._xMax*(this._pScissorRect.x*2-this._pViewPort.width)/this._pScissorRect.width+this._xMax;var middle=-this._yMax*(this._pScissorRect.y*2-this._pViewPort.height)/this._pScissorRect.height-this._yMax;left=center-xWidth;right=center+xWidth;top=middle-yHgt;bottom=middle+yHgt;raw[0]=2*this._pNear/(right-left);raw[5]=2*this._pNear/(bottom-top);raw[8]=(right+left)/(right-left);raw[9]=(bottom+top)/(bottom-top);raw[10]=(this._pFar+this._pNear)/(this._pFar-this._pNear);raw[11]=1;raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[12]=raw[13]=raw[15]=0;raw[14]=-2*this._pFar*this._pNear/(this._pFar-this._pNear)}this._pMatrix.copyRawDataFrom(raw);var yMaxFar=this._pFar*this._focalLengthInv;var xMaxFar=yMaxFar*this._pAspectRatio;this._pFrustumCorners[0]=this._pFrustumCorners[9]=left;this._pFrustumCorners[3]=this._pFrustumCorners[6]=right;this._pFrustumCorners[1]=this._pFrustumCorners[4]=top;this._pFrustumCorners[7]=this._pFrustumCorners[10]=bottom;this._pFrustumCorners[12]=this._pFrustumCorners[21]=-xMaxFar;this._pFrustumCorners[15]=this._pFrustumCorners[18]=xMaxFar;this._pFrustumCorners[13]=this._pFrustumCorners[16]=-yMaxFar;this._pFrustumCorners[19]=this._pFrustumCorners[22]=yMaxFar;this._pFrustumCorners[2]=this._pFrustumCorners[5]=this._pFrustumCorners[8]=this._pFrustumCorners[11]=this._pNear;this._pFrustumCorners[14]=this._pFrustumCorners[17]=this._pFrustumCorners[20]=this._pFrustumCorners[23]=this._pFar;this._pMatrixInvalid=false};return PerspectiveLens})(away.cameras.LensBase);cameras.PerspectiveLens=PerspectiveLens})(away.cameras||(away.cameras={}));var cameras=away.cameras})(away||(away={}));var away;(function(away){(function(cameras){var FreeMatrixLens=(function(_super){__extends(FreeMatrixLens,_super);function FreeMatrixLens(){_super.call(this);this._pMatrix.copyFrom(new away.cameras.PerspectiveLens().matrix)}Object.defineProperty(FreeMatrixLens.prototype,"near",{set:function(value){this._pNear=value},enumerable:true,configurable:true});Object.defineProperty(FreeMatrixLens.prototype,"far",{set:function(value){this._pFar=value},enumerable:true,configurable:true});Object.defineProperty(FreeMatrixLens.prototype,"iAspectRatio",{set:function(value){this._pAspectRatio=value},enumerable:true,configurable:true});FreeMatrixLens.prototype.clone=function(){var clone=new away.cameras.FreeMatrixLens();clone._pMatrix.copyFrom(this._pMatrix);clone._pNear=this._pNear;clone._pFar=this._pFar;clone._pAspectRatio=this._pAspectRatio;clone.pInvalidateMatrix();return clone};FreeMatrixLens.prototype.pUpdateMatrix=function(){this._pMatrixInvalid=false};return FreeMatrixLens})(away.cameras.LensBase);cameras.FreeMatrixLens=FreeMatrixLens})(away.cameras||(away.cameras={}));var cameras=away.cameras})(away||(away={}));var away;(function(away){(function(cameras){var OrthographicLens=(function(_super){__extends(OrthographicLens,_super);function OrthographicLens(projectionHeight){if(typeof projectionHeight==="undefined"){projectionHeight=500}_super.call(this);this._projectionHeight=projectionHeight}Object.defineProperty(OrthographicLens.prototype,"projectionHeight",{get:function(){return this._projectionHeight},set:function(value){if(value==this._projectionHeight){return}this._projectionHeight=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});OrthographicLens.prototype.unproject=function(nX,nY,sZ){var v=new away.geom.Vector3D(nX+this.matrix.rawData[12],-nY+this.matrix.rawData[13],sZ,1);v=this.unprojectionMatrix.transformVector(v);v.z=sZ;return v};OrthographicLens.prototype.clone=function(){var clone=new away.cameras.OrthographicLens();clone._pNear=this._pNear;clone._pFar=this._pFar;clone._pAspectRatio=this._pAspectRatio;clone.projectionHeight=this._projectionHeight;return clone};OrthographicLens.prototype.pUpdateMatrix=function(){var raw=[];this._yMax=this._projectionHeight*0.5;this._xMax=this._yMax*this._pAspectRatio;var left;var right;var top;var bottom;if(this._pScissorRect.x==0&&this._pScissorRect.y==0&&this._pScissorRect.width==this._pViewPort.width&&this._pScissorRect.height==this._pViewPort.height){left=-this._xMax;right=this._xMax;top=-this._yMax;bottom=this._yMax;raw[0]=2/(this._projectionHeight*this._pAspectRatio);raw[5]=2/this._projectionHeight;raw[10]=1/(this._pFar-this._pNear);raw[14]=this._pNear/(this._pNear-this._pFar);raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[8]=raw[9]=raw[11]=raw[12]=raw[13]=0;raw[15]=1}else{var xWidth=this._xMax*(this._pViewPort.width/this._pScissorRect.width);var yHgt=this._yMax*(this._pViewPort.height/this._pScissorRect.height);var center=this._xMax*(this._pScissorRect.x*2-this._pViewPort.width)/this._pScissorRect.width+this._xMax;var middle=-this._yMax*(this._pScissorRect.y*2-this._pViewPort.height)/this._pScissorRect.height-this._yMax;left=center-xWidth;right=center+xWidth;top=middle-yHgt;bottom=middle+yHgt;raw[0]=2*1/(right-left);raw[5]=-2*1/(top-bottom);raw[10]=1/(this._pFar-this._pNear);raw[12]=(right+left)/(right-left);raw[13]=(bottom+top)/(bottom-top);raw[14]=this._pNear/(this.near-this.far);raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[8]=raw[9]=raw[11]=0;raw[15]=1}this._pFrustumCorners[0]=this._pFrustumCorners[9]=this._pFrustumCorners[12]=this._pFrustumCorners[21]=left;this._pFrustumCorners[3]=this._pFrustumCorners[6]=this._pFrustumCorners[15]=this._pFrustumCorners[18]=right;this._pFrustumCorners[1]=this._pFrustumCorners[4]=this._pFrustumCorners[13]=this._pFrustumCorners[16]=top;this._pFrustumCorners[7]=this._pFrustumCorners[10]=this._pFrustumCorners[19]=this._pFrustumCorners[22]=bottom;this._pFrustumCorners[2]=this._pFrustumCorners[5]=this._pFrustumCorners[8]=this._pFrustumCorners[11]=this._pNear;this._pFrustumCorners[14]=this._pFrustumCorners[17]=this._pFrustumCorners[20]=this._pFrustumCorners[23]=this._pFar;this._pMatrix.copyRawDataFrom(raw);this._pMatrixInvalid=false};return OrthographicLens})(away.cameras.LensBase);cameras.OrthographicLens=OrthographicLens})(away.cameras||(away.cameras={}));var cameras=away.cameras})(away||(away={}));var away;(function(away){(function(cameras){var OrthographicOffCenterLens=(function(_super){__extends(OrthographicOffCenterLens,_super);function OrthographicOffCenterLens(minX,maxX,minY,maxY){_super.call(this);this._minX=minX;this._maxX=maxX;this._minY=minY;this._maxY=maxY}Object.defineProperty(OrthographicOffCenterLens.prototype,"minX",{get:function(){return this._minX},set:function(value){this._minX=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(OrthographicOffCenterLens.prototype,"maxX",{get:function(){return this._maxX},set:function(value){this._maxX=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(OrthographicOffCenterLens.prototype,"minY",{get:function(){return this._minY},set:function(value){this._minY=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(OrthographicOffCenterLens.prototype,"maxY",{get:function(){return this._maxY},set:function(value){this._maxY=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});OrthographicOffCenterLens.prototype.unproject=function(nX,nY,sZ){var v=new away.geom.Vector3D(nX,-nY,sZ,1);v=this.unprojectionMatrix.transformVector(v);v.z=sZ;return v};OrthographicOffCenterLens.prototype.clone=function(){var clone=new away.cameras.OrthographicOffCenterLens(this._minX,this._maxX,this._minY,this._maxY);clone._pNear=this._pNear;clone._pFar=this._pFar;clone._pAspectRatio=this._pAspectRatio;return clone};OrthographicOffCenterLens.prototype.pUpdateMatrix=function(){var raw=[];var w=1/(this._maxX-this._minX);var h=1/(this._maxY-this._minY);var d=1/(this._pFar-this._pNear);raw[0]=2*w;raw[5]=2*h;raw[10]=d;raw[12]=-(this._maxX+this._minX)*w;raw[13]=-(this._maxY+this._minY)*h;raw[14]=-this._pNear*d;raw[15]=1;raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[8]=raw[9]=raw[11]=0;this._pMatrix.copyRawDataFrom(raw);this._pFrustumCorners[0]=this._pFrustumCorners[9]=this._pFrustumCorners[12]=this._pFrustumCorners[21]=this._minX;this._pFrustumCorners[3]=this._pFrustumCorners[6]=this._pFrustumCorners[15]=this._pFrustumCorners[18]=this._maxX;this._pFrustumCorners[1]=this._pFrustumCorners[4]=this._pFrustumCorners[13]=this._pFrustumCorners[16]=this._minY;this._pFrustumCorners[7]=this._pFrustumCorners[10]=this._pFrustumCorners[19]=this._pFrustumCorners[22]=this._maxY;this._pFrustumCorners[2]=this._pFrustumCorners[5]=this._pFrustumCorners[8]=this._pFrustumCorners[11]=this._pNear;this._pFrustumCorners[14]=this._pFrustumCorners[17]=this._pFrustumCorners[20]=this._pFrustumCorners[23]=this._pFar;this._pMatrixInvalid=false};return OrthographicOffCenterLens})(away.cameras.LensBase);cameras.OrthographicOffCenterLens=OrthographicOffCenterLens})(away.cameras||(away.cameras={}));var cameras=away.cameras})(away||(away={}));var away;(function(away){(function(cameras){var PerspectiveOffCenterLens=(function(_super){__extends(PerspectiveOffCenterLens,_super);function PerspectiveOffCenterLens(minAngleX,maxAngleX,minAngleY,maxAngleY){if(typeof minAngleX==="undefined"){minAngleX=-40}if(typeof maxAngleX==="undefined"){maxAngleX=40}if(typeof minAngleY==="undefined"){minAngleY=-40}if(typeof maxAngleY==="undefined"){maxAngleY=40}_super.call(this);this.minAngleX=minAngleX;this.maxAngleX=maxAngleX;this.minAngleY=minAngleY;this.maxAngleY=maxAngleY}Object.defineProperty(PerspectiveOffCenterLens.prototype,"minAngleX",{get:function(){return this._minAngleX},set:function(value){this._minAngleX=value;this._tanMinX=Math.tan(this._minAngleX*Math.PI/180);this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(PerspectiveOffCenterLens.prototype,"maxAngleX",{get:function(){return this._maxAngleX},set:function(value){this._maxAngleX=value;this._tanMaxX=Math.tan(this._maxAngleX*Math.PI/180);this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(PerspectiveOffCenterLens.prototype,"minAngleY",{get:function(){return this._minAngleY},set:function(value){this._minAngleY=value;this._tanMinY=Math.tan(this._minAngleY*Math.PI/180);this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(PerspectiveOffCenterLens.prototype,"maxAngleY",{get:function(){return this._maxAngleY},set:function(value){this._maxAngleY=value;this._tanMaxY=Math.tan(this._maxAngleY*Math.PI/180);this.pInvalidateMatrix()},enumerable:true,configurable:true});PerspectiveOffCenterLens.prototype.unproject=function(nX,nY,sZ){var v=new away.geom.Vector3D(nX,-nY,sZ,1);v.x*=sZ;v.y*=sZ;v=this.unprojectionMatrix.transformVector(v);v.z=sZ;return v};PerspectiveOffCenterLens.prototype.clone=function(){var clone=new away.cameras.PerspectiveOffCenterLens(this._minAngleX,this._maxAngleX,this._minAngleY,this._maxAngleY);clone._pNear=this._pNear;clone._pFar=this._pFar;clone._pAspectRatio=this._pAspectRatio;return clone};PerspectiveOffCenterLens.prototype.pUpdateMatrix=function(){var raw=[];this._minLengthX=this._pNear*this._tanMinX;this._maxLengthX=this._pNear*this._tanMaxX;this._minLengthY=this._pNear*this._tanMinY;this._maxLengthY=this._pNear*this._tanMaxY;var minLengthFracX=-this._minLengthX/(this._maxLengthX-this._minLengthX);var minLengthFracY=-this._minLengthY/(this._maxLengthY-this._minLengthY);var left;var right;var top;var bottom;var center=-this._minLengthX*(this._pScissorRect.x+this._pScissorRect.width*minLengthFracX)/(this._pScissorRect.width*minLengthFracX);var middle=this._minLengthY*(this._pScissorRect.y+this._pScissorRect.height*minLengthFracY)/(this._pScissorRect.height*minLengthFracY);left=center-(this._maxLengthX-this._minLengthX)*(this._pViewPort.width/this._pScissorRect.width);right=center;top=middle;bottom=middle+(this._maxLengthY-this._minLengthY)*(this._pViewPort.height/this._pScissorRect.height);raw[0]=2*this._pNear/(right-left);raw[5]=2*this._pNear/(bottom-top);raw[8]=(right+left)/(right-left);raw[9]=(bottom+top)/(bottom-top);raw[10]=(this._pFar+this._pNear)/(this._pFar-this._pNear);raw[11]=1;raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[12]=raw[13]=raw[15]=0;raw[14]=-2*this._pFar*this._pNear/(this._pFar-this._pNear);this._pMatrix.copyRawDataFrom(raw);this._minLengthX=this._pFar*this._tanMinX;this._maxLengthX=this._pFar*this._tanMaxX;this._minLengthY=this._pFar*this._tanMinY;this._maxLengthY=this._pFar*this._tanMaxY;this._pFrustumCorners[0]=this._pFrustumCorners[9]=left;this._pFrustumCorners[3]=this._pFrustumCorners[6]=right;this._pFrustumCorners[1]=this._pFrustumCorners[4]=top;this._pFrustumCorners[7]=this._pFrustumCorners[10]=bottom;this._pFrustumCorners[12]=this._pFrustumCorners[21]=this._minLengthX;this._pFrustumCorners[15]=this._pFrustumCorners[18]=this._maxLengthX;this._pFrustumCorners[13]=this._pFrustumCorners[16]=this._minLengthY;this._pFrustumCorners[19]=this._pFrustumCorners[22]=this._maxLengthY;this._pFrustumCorners[2]=this._pFrustumCorners[5]=this._pFrustumCorners[8]=this._pFrustumCorners[11]=this._pNear;this._pFrustumCorners[14]=this._pFrustumCorners[17]=this._pFrustumCorners[20]=this._pFrustumCorners[23]=this._pFar;this._pMatrixInvalid=false};return PerspectiveOffCenterLens})(away.cameras.LensBase);cameras.PerspectiveOffCenterLens=PerspectiveOffCenterLens})(away.cameras||(away.cameras={}));var cameras=away.cameras})(away||(away={}));var away;(function(away){(function(cameras){var ObliqueNearPlaneLens=(function(_super){__extends(ObliqueNearPlaneLens,_super);function ObliqueNearPlaneLens(baseLens,plane){_super.call(this);this.baseLens=baseLens;this.plane=plane}Object.defineProperty(ObliqueNearPlaneLens.prototype,"frustumCorners",{get:function(){return this._baseLens.frustumCorners},enumerable:true,configurable:true});Object.defineProperty(ObliqueNearPlaneLens.prototype,"near",{get:function(){return this._baseLens.near},set:function(value){this._baseLens.near=value},enumerable:true,configurable:true});Object.defineProperty(ObliqueNearPlaneLens.prototype,"far",{get:function(){return this._baseLens.far},set:function(value){this._baseLens.far=value},enumerable:true,configurable:true});Object.defineProperty(ObliqueNearPlaneLens.prototype,"iAspectRatio",{get:function(){return this._baseLens.iAspectRatio},set:function(value){this._baseLens.iAspectRatio=value},enumerable:true,configurable:true});Object.defineProperty(ObliqueNearPlaneLens.prototype,"plane",{get:function(){return this._plane},set:function(value){this._plane=value;this.pInvalidateMatrix()},enumerable:true,configurable:true});Object.defineProperty(ObliqueNearPlaneLens.prototype,"baseLens",{set:function(value){if(this._baseLens){this._baseLens.removeEventListener(away.events.LensEvent.MATRIX_CHANGED,this.onLensMatrixChanged,this)}this._baseLens=value;if(this._baseLens){this._baseLens.addEventListener(away.events.LensEvent.MATRIX_CHANGED,this.onLensMatrixChanged,this)}this.pInvalidateMatrix()},enumerable:true,configurable:true});ObliqueNearPlaneLens.prototype.onLensMatrixChanged=function(event){this.pInvalidateMatrix()};ObliqueNearPlaneLens.prototype.pUpdateMatrix=function(){this._pMatrix.copyFrom(this._baseLens.matrix);var cx=this._plane.a;var cy=this._plane.b;var cz=this._plane.c;var cw=-this._plane.d+0.05;var signX=cx>=0?1:-1;var signY=cy>=0?1:-1;var p=new away.geom.Vector3D(signX,signY,1,1);var inverse=this._pMatrix.clone();inverse.invert();var q=inverse.transformVector(p);this._pMatrix.copyRowTo(3,p);var a=(q.x*p.x+q.y*p.y+q.z*p.z+q.w*p.w)/(cx*q.x+cy*q.y+cz*q.z+cw*q.w);this._pMatrix.copyRowFrom(2,new away.geom.Vector3D(cx*a,cy*a,cz*a,cw*a))};return ObliqueNearPlaneLens})(away.cameras.LensBase);cameras.ObliqueNearPlaneLens=ObliqueNearPlaneLens})(away.cameras||(away.cameras={}));var cameras=away.cameras})(away||(away={}));var away;(function(away){(function(events){var CameraEvent=(function(_super){__extends(CameraEvent,_super);function CameraEvent(type,camera){_super.call(this,type);this._camera=camera}Object.defineProperty(CameraEvent.prototype,"camera",{get:function(){return this._camera},enumerable:true,configurable:true});CameraEvent.LENS_CHANGED="lensChanged";return CameraEvent})(away.events.Event);events.CameraEvent=CameraEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(bounds){var NullBounds=(function(_super){__extends(NullBounds,_super);function NullBounds(alwaysIn,renderable){if(typeof alwaysIn==="undefined"){alwaysIn=true}if(typeof renderable==="undefined"){renderable=null}_super.call(this);this._alwaysIn=alwaysIn;this._renderable=renderable;this._pMax.x=this._pMax.y=this._pMax.z=Number.POSITIVE_INFINITY;this._pMin.x=this._pMin.y=this._pMin.z=this._alwaysIn?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY}NullBounds.prototype.clone=function(){return new away.bounds.NullBounds(this._alwaysIn)};NullBounds.prototype.pCreateBoundingRenderable=function(){return null};NullBounds.prototype.isInFrustum=function(planes,numPlanes){planes=planes;numPlanes=numPlanes;return this._alwaysIn};NullBounds.prototype.fromGeometry=function(geometry){};NullBounds.prototype.fromSphere=function(center,radius){};NullBounds.prototype.fromExtremes=function(minX,minY,minZ,maxX,maxY,maxZ){};NullBounds.prototype.classifyToPlane=function(plane){plane=plane;return away.math.PlaneClassification.INTERSECT};NullBounds.prototype.transformFrom=function(bounds,matrix){matrix=matrix;var nullBounds=bounds;this._alwaysIn=nullBounds._alwaysIn};return NullBounds})(away.bounds.BoundingVolumeBase);bounds.NullBounds=NullBounds})(away.bounds||(away.bounds={}));var bounds=away.bounds})(away||(away={}));var away;(function(away){(function(bounds){var BoundingSphere=(function(_super){__extends(BoundingSphere,_super);function BoundingSphere(){_super.call(this);this._radius=0;this._centerX=0;this._centerY=0;this._centerZ=0}Object.defineProperty(BoundingSphere.prototype,"radius",{get:function(){return this._radius},enumerable:true,configurable:true});BoundingSphere.prototype.nullify=function(){_super.prototype.nullify.call(this);this._centerX=this._centerY=this._centerZ=0;this._radius=0};BoundingSphere.prototype.isInFrustum=function(planes,numPlanes){for(var i=0;i<numPlanes;++i){var plane=planes[i];var flippedExtentX=plane.a<0?-this._radius:this._radius;var flippedExtentY=plane.b<0?-this._radius:this._radius;var flippedExtentZ=plane.c<0?-this._radius:this._radius;var projDist=plane.a*(this._centerX+flippedExtentX)+plane.b*(this._centerY+flippedExtentY)+plane.c*(this._centerZ+flippedExtentZ)-plane.d;if(projDist<0){return false}}return true};BoundingSphere.prototype.fromSphere=function(center,radius){this._centerX=center.x;this._centerY=center.y;this._centerZ=center.z;this._radius=radius;this._pMax.x=this._centerX+radius;this._pMax.y=this._centerY+radius;this._pMax.z=this._centerZ+radius;this._pMin.x=this._centerX-radius;this._pMin.y=this._centerY-radius;this._pMin.z=this._centerZ-radius;this._pAabbPointsDirty=true;if(this._pBoundingRenderable){this.pUpdateBoundingRenderable()}};BoundingSphere.prototype.fromExtremes=function(minX,minY,minZ,maxX,maxY,maxZ){this._centerX=(maxX+minX)*0.5;this._centerY=(maxY+minY)*0.5;this._centerZ=(maxZ+minZ)*0.5;var d=maxX-minX;var y=maxY-minY;var z=maxZ-minZ;if(y>d){d=y}if(z>d){d=z}this._radius=d*Math.sqrt(0.5);_super.prototype.fromExtremes.call(this,minX,minY,minZ,maxX,maxY,maxZ)};BoundingSphere.prototype.clone=function(){var clone=new BoundingSphere();clone.fromSphere(new away.geom.Vector3D(this._centerX,this._centerY,this._centerZ),this._radius);return clone};BoundingSphere.prototype.rayIntersection=function(position,direction,targetNormal){if(this.containsPoint(position)){return 0}var px=position.x-this._centerX,py=position.y-this._centerY,pz=position.z-this._centerZ;var vx=direction.x,vy=direction.y,vz=direction.z;var rayEntryDistance;var a=vx*vx+vy*vy+vz*vz;var b=2*(px*vx+py*vy+pz*vz);var c=px*px+py*py+pz*pz-this._radius*this._radius;var det=b*b-4*a*c;if(det>=0){var sqrtDet=Math.sqrt(det);rayEntryDistance=(-b-sqrtDet)/(2*a);if(rayEntryDistance>=0){targetNormal.x=px+rayEntryDistance*vx;targetNormal.y=py+rayEntryDistance*vy;targetNormal.z=pz+rayEntryDistance*vz;targetNormal.normalize();return rayEntryDistance}}return -1};BoundingSphere.prototype.containsPoint=function(position){var px=position.x-this._centerX;var py=position.y-this._centerY;var pz=position.z-this._centerZ;var distance=Math.sqrt(px*px+py*py+pz*pz);return distance<=this._radius};BoundingSphere.prototype.pUpdateBoundingRenderable=function(){var sc=this._radius;if(sc==0){sc=0.001}this._pBoundingRenderable.scaleX=sc;this._pBoundingRenderable.scaleY=sc;this._pBoundingRenderable.scaleZ=sc;this._pBoundingRenderable.x=this._centerX;this._pBoundingRenderable.y=this._centerY;this._pBoundingRenderable.z=this._centerZ};BoundingSphere.prototype.pCreateBoundingRenderable=function(){return new away.primitives.WireframeSphere(1,16,12,16777215,0.5)};BoundingSphere.prototype.classifyToPlane=function(plane){var a=plane.a;var b=plane.b;var c=plane.c;var dd=a*this._centerX+b*this._centerY+c*this._centerZ-plane.d;if(a<0){a=-a}if(b<0){b=-b}if(c<0){c=-c}var rr=(a+b+c)*this._radius;return dd>rr?away.math.PlaneClassification.FRONT:dd<-rr?away.math.PlaneClassification.BACK:away.math.PlaneClassification.INTERSECT};BoundingSphere.prototype.transformFrom=function(bounds,matrix){var sphere=bounds;var cx=sphere._centerX;var cy=sphere._centerY;var cz=sphere._centerZ;var raw=[];matrix.copyRawDataTo(raw);var m11=raw[0],m12=raw[4],m13=raw[8],m14=raw[12];var m21=raw[1],m22=raw[5],m23=raw[9],m24=raw[13];var m31=raw[2],m32=raw[6],m33=raw[10],m34=raw[14];this._centerX=cx*m11+cy*m12+cz*m13+m14;this._centerY=cx*m21+cy*m22+cz*m23+m24;this._centerZ=cx*m31+cy*m32+cz*m33+m34;if(m11<0){m11=-m11}if(m12<0){m12=-m12}if(m13<0){m13=-m13}if(m21<0){m21=-m21}if(m22<0){m22=-m22}if(m23<0){m23=-m23}if(m31<0){m31=-m31}if(m32<0){m32=-m32}if(m33<0){m33=-m33}var r=sphere._radius;var rx=m11+m12+m13;var ry=m21+m22+m23;var rz=m31+m32+m33;this._radius=r*Math.sqrt(rx*rx+ry*ry+rz*rz);this._pMin.x=this._centerX-this._radius;this._pMin.y=this._centerY-this._radius;this._pMin.z=this._centerZ-this._radius;this._pMax.x=this._centerX+this._radius;this._pMax.y=this._centerY+this._radius;this._pMax.z=this._centerZ+this._radius};return BoundingSphere})(away.bounds.BoundingVolumeBase);bounds.BoundingSphere=BoundingSphere})(away.bounds||(away.bounds={}));var bounds=away.bounds})(away||(away={}));var away;(function(away){(function(bounds){var AxisAlignedBoundingBox=(function(_super){__extends(AxisAlignedBoundingBox,_super);function AxisAlignedBoundingBox(){_super.call(this);this._centerX=0;this._centerY=0;this._centerZ=0;this._halfExtentsX=0;this._halfExtentsY=0;this._halfExtentsZ=0}AxisAlignedBoundingBox.prototype.nullify=function(){_super.prototype.nullify.call(this);this._centerX=this._centerY=this._centerZ=0;this._halfExtentsX=this._halfExtentsY=this._halfExtentsZ=0};AxisAlignedBoundingBox.prototype.isInFrustum=function(planes,numPlanes){for(var i=0;i<numPlanes;++i){var plane=planes[i];var a=plane.a;var b=plane.b;var c=plane.c;var flippedExtentX=a<0?-this._halfExtentsX:this._halfExtentsX;var flippedExtentY=b<0?-this._halfExtentsY:this._halfExtentsY;var flippedExtentZ=c<0?-this._halfExtentsZ:this._halfExtentsZ;var projDist=a*(this._centerX+flippedExtentX)+b*(this._centerY+flippedExtentY)+c*(this._centerZ+flippedExtentZ)-plane.d;if(projDist<0){return false}}return true};AxisAlignedBoundingBox.prototype.rayIntersection=function(position,direction,targetNormal){if(this.containsPoint(position)){return 0}var px=position.x-this._centerX;var py=position.y-this._centerY;var pz=position.z-this._centerZ;var vx=direction.x;var vy=direction.y;var vz=direction.z;var ix;var iy;var iz;var rayEntryDistance;var intersects;if(vx<0){rayEntryDistance=(this._halfExtentsX-px)/vx;if(rayEntryDistance>0){iy=py+rayEntryDistance*vy;iz=pz+rayEntryDistance*vz;if(iy>-this._halfExtentsY&&iy<this._halfExtentsY&&iz>-this._halfExtentsZ&&iz<this._halfExtentsZ){targetNormal.x=1;targetNormal.y=0;targetNormal.z=0;intersects=true}}}if(!intersects&&vx>0){rayEntryDistance=(-this._halfExtentsX-px)/vx;if(rayEntryDistance>0){iy=py+rayEntryDistance*vy;iz=pz+rayEntryDistance*vz;if(iy>-this._halfExtentsY&&iy<this._halfExtentsY&&iz>-this._halfExtentsZ&&iz<this._halfExtentsZ){targetNormal.x=-1;targetNormal.y=0;targetNormal.z=0;intersects=true}}}if(!intersects&&vy<0){rayEntryDistance=(this._halfExtentsY-py)/vy;if(rayEntryDistance>0){ix=px+rayEntryDistance*vx;iz=pz+rayEntryDistance*vz;if(ix>-this._halfExtentsX&&ix<this._halfExtentsX&&iz>-this._halfExtentsZ&&iz<this._halfExtentsZ){targetNormal.x=0;targetNormal.y=1;targetNormal.z=0;intersects=true}}}if(!intersects&&vy>0){rayEntryDistance=(-this._halfExtentsY-py)/vy;if(rayEntryDistance>0){ix=px+rayEntryDistance*vx;iz=pz+rayEntryDistance*vz;if(ix>-this._halfExtentsX&&ix<this._halfExtentsX&&iz>-this._halfExtentsZ&&iz<this._halfExtentsZ){targetNormal.x=0;targetNormal.y=-1;targetNormal.z=0;intersects=true}}}if(!intersects&&vz<0){rayEntryDistance=(this._halfExtentsZ-pz)/vz;if(rayEntryDistance>0){ix=px+rayEntryDistance*vx;iy=py+rayEntryDistance*vy;if(iy>-this._halfExtentsY&&iy<this._halfExtentsY&&ix>-this._halfExtentsX&&ix<this._halfExtentsX){targetNormal.x=0;targetNormal.y=0;targetNormal.z=1;intersects=true}}}if(!intersects&&vz>0){rayEntryDistance=(-this._halfExtentsZ-pz)/vz;if(rayEntryDistance>0){ix=px+rayEntryDistance*vx;iy=py+rayEntryDistance*vy;if(iy>-this._halfExtentsY&&iy<this._halfExtentsY&&ix>-this._halfExtentsX&&ix<this._halfExtentsX){targetNormal.x=0;targetNormal.y=0;targetNormal.z=-1;intersects=true}}}return intersects?rayEntryDistance:-1};AxisAlignedBoundingBox.prototype.containsPoint=function(position){var px=position.x-this._centerX,py=position.y-this._centerY,pz=position.z-this._centerZ;return px<=this._halfExtentsX&&px>=-this._halfExtentsX&&py<=this._halfExtentsY&&py>=-this._halfExtentsY&&pz<=this._halfExtentsZ&&pz>=-this._halfExtentsZ};AxisAlignedBoundingBox.prototype.fromExtremes=function(minX,minY,minZ,maxX,maxY,maxZ){this._centerX=(maxX+minX)*0.5;this._centerY=(maxY+minY)*0.5;this._centerZ=(maxZ+minZ)*0.5;this._halfExtentsX=(maxX-minX)*0.5;this._halfExtentsY=(maxY-minY)*0.5;this._halfExtentsZ=(maxZ-minZ)*0.5;_super.prototype.fromExtremes.call(this,minX,minY,minZ,maxX,maxY,maxZ)};AxisAlignedBoundingBox.prototype.clone=function(){var clone=new AxisAlignedBoundingBox();clone.fromExtremes(this._pMin.x,this._pMin.y,this._pMin.z,this._pMax.x,this._pMax.y,this._pMax.z);return clone};Object.defineProperty(AxisAlignedBoundingBox.prototype,"halfExtentsX",{get:function(){return this._halfExtentsX},enumerable:true,configurable:true});Object.defineProperty(AxisAlignedBoundingBox.prototype,"halfExtentsY",{get:function(){return this._halfExtentsY},enumerable:true,configurable:true});Object.defineProperty(AxisAlignedBoundingBox.prototype,"halfExtentsZ",{get:function(){return this._halfExtentsZ},enumerable:true,configurable:true});AxisAlignedBoundingBox.prototype.closestPointToPoint=function(point,target){if(typeof target==="undefined"){target=null}var p;if(target==null){target=new away.geom.Vector3D()}p=point.x;if(p<this._pMin.x){p=this._pMin.x}if(p>this._pMax.x){p=this._pMax.x}target.x=p;p=point.y;if(p<this._pMin.y){p=this._pMin.y}if(p>this._pMax.y){p=this._pMax.y}target.y=p;p=point.z;if(p<this._pMin.z){p=this._pMin.z}if(p>this._pMax.z){p=this._pMax.z}target.z=p;return target};AxisAlignedBoundingBox.prototype.pUpdateBoundingRenderable=function(){this._pBoundingRenderable.scaleX=Math.max(this._halfExtentsX*2,0.001);this._pBoundingRenderable.scaleY=Math.max(this._halfExtentsY*2,0.001);this._pBoundingRenderable.scaleZ=Math.max(this._halfExtentsZ*2,0.001);this._pBoundingRenderable.x=this._centerX;this._pBoundingRenderable.y=this._centerY;this._pBoundingRenderable.z=this._centerZ};AxisAlignedBoundingBox.prototype.pCreateBoundingRenderable=function(){return new away.primitives.WireframeCube(1,1,1,16777215,0.5)};AxisAlignedBoundingBox.prototype.classifyToPlane=function(plane){var a=plane.a;var b=plane.b;var c=plane.c;var centerDistance=a*this._centerX+b*this._centerY+c*this._centerZ-plane.d;if(a<0){a=-a}if(b<0){b=-b}if(c<0){c=-c}var boundOffset=a*this._halfExtentsX+b*this._halfExtentsY+c*this._halfExtentsZ;return centerDistance>boundOffset?away.math.PlaneClassification.FRONT:centerDistance<-boundOffset?away.math.PlaneClassification.BACK:away.math.PlaneClassification.INTERSECT};AxisAlignedBoundingBox.prototype.transformFrom=function(bounds,matrix){var aabb=bounds;var cx=aabb._centerX;var cy=aabb._centerY;var cz=aabb._centerZ;var raw=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;matrix.copyRawDataTo(raw);var m11=raw[0],m12=raw[4],m13=raw[8],m14=raw[12];var m21=raw[1],m22=raw[5],m23=raw[9],m24=raw[13];var m31=raw[2],m32=raw[6],m33=raw[10],m34=raw[14];this._centerX=cx*m11+cy*m12+cz*m13+m14;this._centerY=cx*m21+cy*m22+cz*m23+m24;this._centerZ=cx*m31+cy*m32+cz*m33+m34;if(m11<0){m11=-m11}if(m12<0){m12=-m12}if(m13<0){m13=-m13}if(m21<0){m21=-m21}if(m22<0){m22=-m22}if(m23<0){m23=-m23}if(m31<0){m31=-m31}if(m32<0){m32=-m32}if(m33<0){m33=-m33}var hx=aabb._halfExtentsX;var hy=aabb._halfExtentsY;var hz=aabb._halfExtentsZ;this._halfExtentsX=hx*m11+hy*m12+hz*m13;this._halfExtentsY=hx*m21+hy*m22+hz*m23;this._halfExtentsZ=hx*m31+hy*m32+hz*m33;this._pMin.x=this._centerX-this._halfExtentsX;this._pMin.y=this._centerY-this._halfExtentsY;this._pMin.z=this._centerZ-this._halfExtentsZ;this._pMax.x=this._centerX+this._halfExtentsX;this._pMax.y=this._centerY+this._halfExtentsY;this._pMax.z=this._centerZ+this._halfExtentsZ};return AxisAlignedBoundingBox})(away.bounds.BoundingVolumeBase);bounds.AxisAlignedBoundingBox=AxisAlignedBoundingBox})(away.bounds||(away.bounds={}));var bounds=away.bounds})(away||(away={}));var away;(function(away){(function(containers){var ObjectContainer3D=(function(_super){__extends(ObjectContainer3D,_super);function ObjectContainer3D(){_super.call(this);this._pSceneTransform=new away.geom.Matrix3D();this._pSceneTransformDirty=true;this._children=[];this._mouseChildren=true;this._inverseSceneTransform=new away.geom.Matrix3D();this._inverseSceneTransformDirty=true;this._scenePosition=new away.geom.Vector3D();this._scenePositionDirty=true;this._explicitVisibility=true;this._implicitVisibility=true;this._pIgnoreTransform=false}ObjectContainer3D.prototype.getIgnoreTransform=function(){return this._pIgnoreTransform};ObjectContainer3D.prototype.setIgnoreTransform=function(value){this._pIgnoreTransform=value;this._pSceneTransformDirty=!value;this._inverseSceneTransformDirty=!value;this._scenePositionDirty=!value;if(value){this._pSceneTransform.identity();this._scenePosition.setTo(0,0,0)}};ObjectContainer3D.prototype.iGetImplicitPartition=function(){return this._pImplicitPartition};ObjectContainer3D.prototype.iSetImplicitPartition=function(value){if(value==this._pImplicitPartition){return}var i=0;var len=this._children.length;var child;this._pImplicitPartition=value;while(i<len){child=this._children[i++];if(!child._pExplicitPartition){child._pImplicitPartition=value}}};Object.defineProperty(ObjectContainer3D.prototype,"_iIsVisible",{get:function(){return this._implicitVisibility&&this._explicitVisibility},enumerable:true,configurable:true});ObjectContainer3D.prototype.iSetParent=function(value){this._pParent=value;this.pUpdateMouseChildren();if(value==null){this.scene=null;return}this.notifySceneTransformChange();this.notifySceneChange()};ObjectContainer3D.prototype.notifySceneTransformChange=function(){if(this._pSceneTransformDirty||this._pIgnoreTransform){return}this.pInvalidateSceneTransform();var i;var len=this._children.length;while(i<len){this._children[i++].notifySceneTransformChange()}if(this._listenToSceneTransformChanged){if(!this._sceneTransformChanged){this._sceneTransformChanged=new away.events.Object3DEvent(away.events.Object3DEvent.SCENETRANSFORM_CHANGED,this)}this.dispatchEvent(this._sceneTransformChanged)}};ObjectContainer3D.prototype.notifySceneChange=function(){this.notifySceneTransformChange();var i;var len=this._children.length;while(i<len){this._children[i++].notifySceneChange()}if(this._listenToSceneChanged){if(!this._scenechanged){this._scenechanged=new away.events.Object3DEvent(away.events.Object3DEvent.SCENE_CHANGED,this)}this.dispatchEvent(this._scenechanged)}};ObjectContainer3D.prototype.pUpdateMouseChildren=function(){if(this._pParent&&!this._pParent._iIsRoot){this._iAncestorsAllowMouseEnabled=this._pParent._iAncestorsAllowMouseEnabled&&this._pParent.mouseChildren}else{this._iAncestorsAllowMouseEnabled=this.mouseChildren}var len=this._children.length;for(var i=0;i<len;++i){this._children[i].pUpdateMouseChildren()}};Object.defineProperty(ObjectContainer3D.prototype,"mouseEnabled",{get:function(){return this._pMouseEnabled},set:function(value){this._pMouseEnabled=value;this.pUpdateMouseChildren()},enumerable:true,configurable:true});ObjectContainer3D.prototype.iInvalidateTransform=function(){_super.prototype.iInvalidateTransform.call(this);this.notifySceneTransformChange()};ObjectContainer3D.prototype.pInvalidateSceneTransform=function(){this._pSceneTransformDirty=!this._pIgnoreTransform;this._inverseSceneTransformDirty=!this._pIgnoreTransform;this._scenePositionDirty=!this._pIgnoreTransform};ObjectContainer3D.prototype.pUpdateSceneTransform=function(){if(this._pParent&&!this._pParent._iIsRoot){this._pSceneTransform.copyFrom(this._pParent.sceneTransform);this._pSceneTransform.prepend(this.transform)}else{this._pSceneTransform.copyFrom(this.transform)}this._pSceneTransformDirty=false};Object.defineProperty(ObjectContainer3D.prototype,"mouseChildren",{get:function(){return this._mouseChildren},set:function(value){this._mouseChildren=value;this.pUpdateMouseChildren()},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"visible",{get:function(){return this._explicitVisibility},set:function(value){var len=this._children.length;this._explicitVisibility=value;for(var i=0;i<len;++i){this._children[i].updateImplicitVisibility()}},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"assetType",{get:function(){return away.library.AssetType.CONTAINER},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"scenePosition",{get:function(){if(this._scenePositionDirty){this.sceneTransform.copyColumnTo(3,this._scenePosition);this._scenePositionDirty=false}return this._scenePosition},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"minX",{get:function(){var i;var len=this._children.length;var min=Number.POSITIVE_INFINITY;var m;while(i<len){var child=this._children[i++];m=child.minX+child.x;if(m<min){min=m}}return min},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"minY",{get:function(){var i;var len=this._children.length;var min=Number.POSITIVE_INFINITY;var m;while(i<len){var child=this._children[i++];m=child.minY+child.y;if(m<min){min=m}}return min},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"minZ",{get:function(){var i;var len=this._children.length;var min=Number.POSITIVE_INFINITY;var m;while(i<len){var child=this._children[i++];m=child.minZ+child.z;if(m<min){min=m}}return min},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"maxX",{get:function(){var i;var len=this._children.length;var max=Number.NEGATIVE_INFINITY;var m;while(i<len){var child=this._children[i++];m=child.maxX+child.x;if(m>max){max=m}}return max},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"maxY",{get:function(){var i;var len=this._children.length;var max=Number.NEGATIVE_INFINITY;var m;while(i<len){var child=this._children[i++];m=child.maxY+child.y;if(m>max){max=m}}return max},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"maxZ",{get:function(){var i;var len=this._children.length;var max=Number.NEGATIVE_INFINITY;var m;while(i<len){var child=this._children[i++];m=child.maxZ+child.z;if(m>max){max=m}}return max},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"partition",{get:function(){return this._pExplicitPartition},set:function(value){this._pExplicitPartition=value;this.iSetImplicitPartition(value?value:(this._pParent?this._pParent.iGetImplicitPartition():null))},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"sceneTransform",{get:function(){if(this._pSceneTransformDirty){this.pUpdateSceneTransform()}return this._pSceneTransform},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"scene",{get:function(){return this._pScene},set:function(value){this.setScene(value)},enumerable:true,configurable:true});ObjectContainer3D.prototype.setScene=function(value){var i=0;var len=this._children.length;while(i<len){this._children[i++].scene=value}if(this._pScene==value){return}if(value==null){this._oldScene=this._pScene}if(this._pExplicitPartition&&this._oldScene&&this._oldScene!=this._pScene){this.partition=null}if(value){this._oldScene=null}this._pScene=value;if(this._pScene){this._pScene.dispatchEvent(new away.events.Scene3DEvent(away.events.Scene3DEvent.ADDED_TO_SCENE,this))}else{if(this._oldScene){this._oldScene.dispatchEvent(new away.events.Scene3DEvent(away.events.Scene3DEvent.REMOVED_FROM_SCENE,this))}}};Object.defineProperty(ObjectContainer3D.prototype,"inverseSceneTransform",{get:function(){if(this._inverseSceneTransformDirty){this._inverseSceneTransform.copyFrom(this.sceneTransform);this._inverseSceneTransform.invert();this._inverseSceneTransformDirty=false}return this._inverseSceneTransform},enumerable:true,configurable:true});Object.defineProperty(ObjectContainer3D.prototype,"parent",{get:function(){return this._pParent},enumerable:true,configurable:true});ObjectContainer3D.prototype.contains=function(child){return this._children.indexOf(child)>=0};ObjectContainer3D.prototype.addChild=function(child){if(child==null){throw new away.errors.Error("Parameter child cannot be null.")}if(child._pParent){child._pParent.removeChild(child)}if(!child._pExplicitPartition){child.iSetImplicitPartition(this._pImplicitPartition)}child.iSetParent(this);child.scene=this._pScene;child.notifySceneTransformChange();child.pUpdateMouseChildren();child.updateImplicitVisibility();this._children.push(child);return child};ObjectContainer3D.prototype.addChildren=function(childarray){for(var child in childarray){this.addChild(child)}};ObjectContainer3D.prototype.removeChild=function(child){if(child==null){throw new away.errors.Error("Parameter child cannot be null")}var childIndex=this._children.indexOf(child);if(childIndex==-1){throw new away.errors.Error("Parameter is not a child of the caller")}this.removeChildInternal(childIndex,child)};ObjectContainer3D.prototype.removeChildAt=function(index){var child=this._children[index];this.removeChildInternal(index,child)};ObjectContainer3D.prototype.removeChildInternal=function(childIndex,child){this._children.splice(childIndex,1);child.iSetParent(null);if(!child._pExplicitPartition){child.iSetImplicitPartition(null)}};ObjectContainer3D.prototype.getChildAt=function(index){return this._children[index]};Object.defineProperty(ObjectContainer3D.prototype,"numChildren",{get:function(){return this._children.length},enumerable:true,configurable:true});ObjectContainer3D.prototype.lookAt=function(target,upAxis){if(typeof upAxis==="undefined"){upAxis=null}_super.prototype.lookAt.call(this,target,upAxis);this.notifySceneTransformChange()};ObjectContainer3D.prototype.translateLocal=function(axis,distance){_super.prototype.translateLocal.call(this,axis,distance);this.notifySceneTransformChange()};ObjectContainer3D.prototype.dispose=function(){if(this.parent){this.parent.removeChild(this)}};ObjectContainer3D.prototype.disposeWithChildren=function(){this.dispose();while(this.numChildren>0){this.getChildAt(0).dispose()}};ObjectContainer3D.prototype.clone=function(){var clone=new away.containers.ObjectContainer3D();clone.pivotPoint=this.pivotPoint;clone.transform=this.transform;clone.partition=this.partition;clone.name=name;var len=this._children.length;for(var i=0;i<len;++i){clone.addChild(this._children[i].clone())}return clone};ObjectContainer3D.prototype.rotate=function(axis,angle){_super.prototype.rotate.call(this,axis,angle);this.notifySceneTransformChange()};ObjectContainer3D.prototype.updateImplicitVisibility=function(){var len=this._children.length;this._implicitVisibility=this._pParent._explicitVisibility&&this._pParent._implicitVisibility;for(var i=0;i<len;++i){this._children[i].updateImplicitVisibility()}};return ObjectContainer3D})(away.base.Object3D);containers.ObjectContainer3D=ObjectContainer3D})(away.containers||(away.containers={}));var containers=away.containers})(away||(away={}));var away;(function(away){(function(entities){var Entity=(function(_super){__extends(Entity,_super);function Entity(){_super.call(this);this._pBoundsInvalid=true;this._worldBoundsInvalid=true;this._pBounds=this.pGetDefaultBoundingVolume();this._worldBounds=this.pGetDefaultBoundingVolume()}Entity.prototype.setIgnoreTransform=function(value){if(this._pScene){this._pScene.iInvalidateEntityBounds(this)}_super.prototype.setIgnoreTransform.call(this,value)};Object.defineProperty(Entity.prototype,"shaderPickingDetails",{get:function(){return this._shaderPickingDetails},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"staticNode",{get:function(){return this._iStaticNode},set:function(value){this._iStaticNode=value},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"pickingCollisionVO",{get:function(){if(!this._iPickingCollisionVO){this._iPickingCollisionVO=new away.pick.PickingCollisionVO(this)}return this._iPickingCollisionVO},enumerable:true,configurable:true});Entity.prototype.iCollidesBefore=function(shortestCollisionDistance,findClosest){shortestCollisionDistance=shortestCollisionDistance;findClosest=findClosest;return true};Object.defineProperty(Entity.prototype,"showBounds",{get:function(){return this._showBounds},set:function(value){if(value==this._showBounds){return}this._showBounds=value;if(this._showBounds){this.addBounds()}else{this.removeBounds()}},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"minX",{get:function(){if(this._pBoundsInvalid){this.pUpdateBounds()}return this._pBounds.min.x},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"minY",{get:function(){if(this._pBoundsInvalid){this.pUpdateBounds()}return this._pBounds.min.y},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"minZ",{get:function(){if(this._pBoundsInvalid){this.pUpdateBounds()}return this._pBounds.min.z},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"maxX",{get:function(){if(this._pBoundsInvalid){this.pUpdateBounds()}return this._pBounds.max.x},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"maxY",{get:function(){if(this._pBoundsInvalid){this.pUpdateBounds()}return this._pBounds.max.y},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"maxZ",{get:function(){if(this._pBoundsInvalid){this.pUpdateBounds()}return this._pBounds.max.z},enumerable:true,configurable:true});Entity.prototype.getBounds=function(){if(this._pBoundsInvalid){this.pUpdateBounds()}return this._pBounds};Object.defineProperty(Entity.prototype,"bounds",{get:function(){return this.getBounds()},set:function(value){this.removeBounds();this._pBounds=value;this._worldBounds=value.clone();this.pInvalidateBounds();if(this._showBounds){this.addBounds()}},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"worldBounds",{get:function(){if(this._worldBoundsInvalid){this.updateWorldBounds()}return this._worldBounds},enumerable:true,configurable:true});Entity.prototype.updateWorldBounds=function(){this._worldBounds.transformFrom(this.getBounds(),this.sceneTransform);this._worldBoundsInvalid=false};Entity.prototype.iSetImplicitPartition=function(value){if(value==this._pImplicitPartition){return}if(this._pImplicitPartition){this.notifyPartitionUnassigned()}_super.prototype.iSetImplicitPartition.call(this,value);this.notifyPartitionAssigned()};Object.defineProperty(Entity.prototype,"scene",{set:function(value){if(value==this._pScene){return}if(this._pScene){this._pScene.iUnregisterEntity(this)}if(value){value.iRegisterEntity(this)}_super.prototype.setScene.call(this,value)},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"assetType",{get:function(){return away.library.AssetType.ENTITY},enumerable:true,configurable:true});Object.defineProperty(Entity.prototype,"pickingCollider",{get:function(){return this._iPickingCollider},set:function(value){this.setPickingCollider(value)},enumerable:true,configurable:true});Entity.prototype.setPickingCollider=function(value){this._iPickingCollider=value};Entity.prototype.getEntityPartitionNode=function(){if(!this._partitionNode){this._partitionNode=this.pCreateEntityPartitionNode()}return this._partitionNode};Entity.prototype.isIntersectingRay=function(rayPosition,rayDirection){var localRayPosition=this.inverseSceneTransform.transformVector(rayPosition);var localRayDirection=this.inverseSceneTransform.deltaTransformVector(rayDirection);if(!this._iPickingCollisionVO.localNormal){this._iPickingCollisionVO.localNormal=new away.geom.Vector3D()}var rayEntryDistance=this._pBounds.rayIntersection(localRayPosition,localRayDirection,this._iPickingCollisionVO.localNormal);if(rayEntryDistance<0){return false}this._iPickingCollisionVO.rayEntryDistance=rayEntryDistance;this._iPickingCollisionVO.localRayPosition=localRayPosition;this._iPickingCollisionVO.localRayDirection=localRayDirection;this._iPickingCollisionVO.rayPosition=rayPosition;this._iPickingCollisionVO.rayDirection=rayDirection;this._iPickingCollisionVO.rayOriginIsInsideBounds=rayEntryDistance==0;return true};Entity.prototype.pCreateEntityPartitionNode=function(){throw new away.errors.AbstractMethodError()};Entity.prototype.pGetDefaultBoundingVolume=function(){return new away.bounds.AxisAlignedBoundingBox()};Entity.prototype.pUpdateBounds=function(){throw new away.errors.AbstractMethodError()};Entity.prototype.pInvalidateSceneTransform=function(){if(!this._pIgnoreTransform){_super.prototype.pInvalidateSceneTransform.call(this);this._worldBoundsInvalid=true;this.notifySceneBoundsInvalid()}};Entity.prototype.pInvalidateBounds=function(){this._pBoundsInvalid=true;this._worldBoundsInvalid=true;this.notifySceneBoundsInvalid()};Entity.prototype.pUpdateMouseChildren=function(){if(this._pParent&&!this.pickingCollider){if(this._pParent instanceof away.entities.Entity){var parentEntity=this._pParent;var collider=parentEntity.pickingCollider;if(collider){this.pickingCollider=collider}}}_super.prototype.pUpdateMouseChildren.call(this)};Entity.prototype.notifySceneBoundsInvalid=function(){if(this._pScene){this._pScene.iInvalidateEntityBounds(this)}};Entity.prototype.notifyPartitionAssigned=function(){if(this._pScene){this._pScene.iRegisterPartition(this)}};Entity.prototype.notifyPartitionUnassigned=function(){if(this._pScene){this._pScene.iUnregisterPartition(this)}};Entity.prototype.addBounds=function(){if(!this._boundsIsShown){this._boundsIsShown=true;this.addChild(this._pBounds.boundingRenderable)}};Entity.prototype.removeBounds=function(){if(!this._boundsIsShown){this._boundsIsShown=false;this.removeChild(this._pBounds.boundingRenderable);this._pBounds.disposeRenderable()}};Entity.prototype.iInternalUpdate=function(){if(this._iController){this._iController.update()}};return Entity})(away.containers.ObjectContainer3D);entities.Entity=Entity})(away.entities||(away.entities={}));var entities=away.entities})(away||(away={}));var away;(function(away){(function(cameras){var Camera3D=(function(_super){__extends(Camera3D,_super);function Camera3D(lens){if(typeof lens==="undefined"){lens=null}_super.call(this);this._viewProjection=new away.geom.Matrix3D();this._viewProjectionDirty=true;this._frustumPlanesDirty=true;this._lens=lens||new away.cameras.PerspectiveLens();this._lens.addEventListener(away.events.LensEvent.MATRIX_CHANGED,this.onLensMatrixChanged,this);this._frustumPlanes=[];for(var i=0;i<6;++i){this._frustumPlanes[i]=new away.math.Plane3D()}this.z=-1000}Camera3D.prototype.pGetDefaultBoundingVolume=function(){return new away.bounds.NullBounds()};Object.defineProperty(Camera3D.prototype,"assetType",{get:function(){return away.library.AssetType.CAMERA},enumerable:true,configurable:true});Camera3D.prototype.onLensMatrixChanged=function(event){this._viewProjectionDirty=true;this._frustumPlanesDirty=true;this.dispatchEvent(event)};Object.defineProperty(Camera3D.prototype,"frustumPlanes",{get:function(){if(this._frustumPlanesDirty){this.updateFrustum()}return this._frustumPlanes},enumerable:true,configurable:true});Camera3D.prototype.updateFrustum=function(){var a,b,c;var c11,c12,c13,c14;var c21,c22,c23,c24;var c31,c32,c33,c34;var c41,c42,c43,c44;var p;var raw=new Array(16);var invLen;this.viewProjection.copyRawDataTo(raw);c11=raw[0];c12=raw[4];c13=raw[8];c14=raw[12];c21=raw[1];c22=raw[5];c23=raw[9];c24=raw[13];c31=raw[2];c32=raw[6];c33=raw[10];c34=raw[14];c41=raw[3];c42=raw[7];c43=raw[11];c44=raw[15];p=this._frustumPlanes[0];a=c41+c11;b=c42+c12;c=c43+c13;invLen=1/Math.sqrt(a*a+b*b+c*c);p.a=a*invLen;p.b=b*invLen;p.c=c*invLen;p.d=-(c44+c14)*invLen;p=this._frustumPlanes[1];a=c41-c11;b=c42-c12;c=c43-c13;invLen=1/Math.sqrt(a*a+b*b+c*c);p.a=a*invLen;p.b=b*invLen;p.c=c*invLen;p.d=(c14-c44)*invLen;p=this._frustumPlanes[2];a=c41+c21;b=c42+c22;c=c43+c23;invLen=1/Math.sqrt(a*a+b*b+c*c);p.a=a*invLen;p.b=b*invLen;p.c=c*invLen;p.d=-(c44+c24)*invLen;p=this._frustumPlanes[3];a=c41-c21;b=c42-c22;c=c43-c23;invLen=1/Math.sqrt(a*a+b*b+c*c);p.a=a*invLen;p.b=b*invLen;p.c=c*invLen;p.d=(c24-c44)*invLen;p=this._frustumPlanes[4];a=c31;b=c32;c=c33;invLen=1/Math.sqrt(a*a+b*b+c*c);p.a=a*invLen;p.b=b*invLen;p.c=c*invLen;p.d=-c34*invLen;p=this._frustumPlanes[5];a=c41-c31;b=c42-c32;c=c43-c33;invLen=1/Math.sqrt(a*a+b*b+c*c);p.a=a*invLen;p.b=b*invLen;p.c=c*invLen;p.d=(c34-c44)*invLen;this._frustumPlanesDirty=false};Camera3D.prototype.pInvalidateSceneTransform=function(){_super.prototype.pInvalidateSceneTransform.call(this);this._viewProjectionDirty=true;this._frustumPlanesDirty=true};Camera3D.prototype.pUpdateBounds=function(){this._pBounds.nullify();this._pBoundsInvalid=false};Camera3D.prototype.pCreateEntityPartitionNode=function(){return new away.partition.CameraNode(this)};Object.defineProperty(Camera3D.prototype,"lens",{get:function(){return this._lens},set:function(value){if(this._lens==value){return}if(!value){throw new Error("Lens cannot be null!")}this._lens.removeEventListener(away.events.LensEvent.MATRIX_CHANGED,this.onLensMatrixChanged,this);this._lens=value;this._lens.addEventListener(away.events.LensEvent.MATRIX_CHANGED,this.onLensMatrixChanged,this);this.dispatchEvent(new away.events.CameraEvent(away.events.CameraEvent.LENS_CHANGED,this))},enumerable:true,configurable:true});Object.defineProperty(Camera3D.prototype,"viewProjection",{get:function(){if(this._viewProjectionDirty){this._viewProjection.copyFrom(this.inverseSceneTransform);this._viewProjection.append(this._lens.matrix);this._viewProjectionDirty=false}return this._viewProjection},enumerable:true,configurable:true});Camera3D.prototype.getRay=function(nX,nY,sZ){return this.sceneTransform.deltaTransformVector(this._lens.unproject(nX,nY,sZ))};Camera3D.prototype.project=function(point3d){return this._lens.project(this.inverseSceneTransform.transformVector(point3d))};Camera3D.prototype.unproject=function(nX,nY,sZ){return this.sceneTransform.transformVector(this._lens.unproject(nX,nY,sZ))};return Camera3D})(away.entities.Entity);cameras.Camera3D=Camera3D})(away.cameras||(away.cameras={}));var cameras=away.cameras})(away||(away={}));var away;(function(away){(function(entities){var SegmentSet=(function(_super){__extends(SegmentSet,_super);function SegmentSet(){_super.call(this);this.LIMIT=3*65535;this._subSetCount=0;this._subSets=[];this.addSubSet();this._pSegments=new Object();this.material=new away.materials.SegmentMaterial()}SegmentSet.prototype.addSegment=function(segment){segment.iSegmentsBase=this;this._hasData=true;var subSetIndex=this._subSets.length-1;var subSet=this._subSets[subSetIndex];if(subSet.vertices.length+44>this.LIMIT){subSet=this.addSubSet();subSetIndex++}segment.iIndex=subSet.vertices.length;segment.iSubSetIndex=subSetIndex;this.iUpdateSegment(segment);var index=subSet.lineCount<<2;subSet.indices.push(index,index+1,index+2,index+3,index+2,index+1);subSet.numVertices=subSet.vertices.length/11;subSet.numIndices=subSet.indices.length;subSet.lineCount++;var segRef=new SegRef();segRef.index=index;segRef.subSetIndex=subSetIndex;segRef.segment=segment;this._pSegments[this._indexSegments]=segRef;this._indexSegments++};SegmentSet.prototype.removeSegmentByIndex=function(index,dispose){if(typeof dispose==="undefined"){dispose=false}var segRef;if(index>=this._indexSegments){return}if(this._pSegments[index]){segRef=this._pSegments[index]}else{return}var subSet;if(!this._subSets[segRef.subSetIndex]){return}var subSetIndex=segRef.subSetIndex;subSet=this._subSets[segRef.subSetIndex];var segment=segRef.segment;var indices=subSet.indices;var ind=index*6;for(var i=ind;i<indices.length;++i){indices[i]-=4}subSet.indices.splice(index*6,6);subSet.vertices.splice(index*44,44);subSet.numVertices=subSet.vertices.length/11;subSet.numIndices=indices.length;subSet.vertexBufferDirty=true;subSet.indexBufferDirty=true;subSet.lineCount--;if(dispose){segment.dispose();segment=null}else{segment.iIndex=-1;segment.iSegmentsBase=null}if(subSet.lineCount==0){if(subSetIndex==0){this._hasData=false}else{subSet.dispose();this._subSets[subSetIndex]=null;this._subSets.splice(subSetIndex,1)}}this.reOrderIndices(subSetIndex,index);segRef=null;this._pSegments[this._indexSegments]=null;this._indexSegments--};SegmentSet.prototype.removeSegment=function(segment,dispose){if(typeof dispose==="undefined"){dispose=false}if(segment.iIndex==-1){return}this.removeSegmentByIndex(segment.iIndex/44)};SegmentSet.prototype.removeAllSegments=function(){var subSet;for(var i=0;i<this._subSetCount;++i){subSet=this._subSets[i];subSet.vertices=null;subSet.indices=null;if(subSet.vertexBuffer){subSet.vertexBuffer.dispose()}if(subSet.indexBuffer){subSet.indexBuffer.dispose()}subSet=null}for(var segRef in this._pSegments){segRef=null}this._pSegments=null;this._subSetCount=0;this._activeSubSet=null;this._indexSegments=0;this._subSets=[];this._pSegments=new Object();this.addSubSet();this._hasData=false};SegmentSet.prototype.getSegment=function(index){if(index>this._indexSegments-1){return null}return this._pSegments[index].segment};Object.defineProperty(SegmentSet.prototype,"segmentCount",{get:function(){return this._indexSegments},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"iSubSetCount",{get:function(){return this._subSetCount},enumerable:true,configurable:true});SegmentSet.prototype.iUpdateSegment=function(segment){var start=segment._pStart;var end=segment._pEnd;var startX=start.x,startY=start.y,startZ=start.z;var endX=end.x,endY=end.y,endZ=end.z;var startR=segment._pStartR,startG=segment._pStartG,startB=segment._pStartB;var endR=segment._pEndR,endG=segment._pEndG,endB=segment._pEndB;var index=segment.iIndex;var t=segment.thickness;var subSet=this._subSets[segment.iSubSetIndex];var vertices=subSet.vertices;vertices[index++]=startX;vertices[index++]=startY;vertices[index++]=startZ;vertices[index++]=endX;vertices[index++]=endY;vertices[index++]=endZ;vertices[index++]=t;vertices[index++]=startR;vertices[index++]=startG;vertices[index++]=startB;vertices[index++]=1;vertices[index++]=endX;vertices[index++]=endY;vertices[index++]=endZ;vertices[index++]=startX;vertices[index++]=startY;vertices[index++]=startZ;vertices[index++]=-t;vertices[index++]=endR;vertices[index++]=endG;vertices[index++]=endB;vertices[index++]=1;vertices[index++]=startX;vertices[index++]=startY;vertices[index++]=startZ;vertices[index++]=endX;vertices[index++]=endY;vertices[index++]=endZ;vertices[index++]=-t;vertices[index++]=startR;vertices[index++]=startG;vertices[index++]=startB;vertices[index++]=1;vertices[index++]=endX;vertices[index++]=endY;vertices[index++]=endZ;vertices[index++]=startX;vertices[index++]=startY;vertices[index++]=startZ;vertices[index++]=t;vertices[index++]=endR;vertices[index++]=endG;vertices[index++]=endB;vertices[index++]=1;subSet.vertexBufferDirty=true;this._pBoundsInvalid=true};Object.defineProperty(SegmentSet.prototype,"hasData",{get:function(){return this._hasData},enumerable:true,configurable:true});SegmentSet.prototype.getIndexBuffer=function(stage3DProxy){if(this._activeSubSet.indexContext3D!=stage3DProxy.context3D||this._activeSubSet.indexBufferDirty){this._activeSubSet.indexBuffer=stage3DProxy._iContext3D.createIndexBuffer(this._activeSubSet.numIndices);this._activeSubSet.indexBuffer.uploadFromArray(this._activeSubSet.indices,0,this._activeSubSet.numIndices);this._activeSubSet.indexBufferDirty=false;this._activeSubSet.indexContext3D=stage3DProxy.context3D}return this._activeSubSet.indexBuffer};SegmentSet.prototype.activateVertexBuffer=function(index,stage3DProxy){var subSet=this._subSets[index];this._activeSubSet=subSet;this._numIndices=subSet.numIndices;var vertexBuffer=subSet.vertexBuffer;if(subSet.vertexContext3D!=stage3DProxy.context3D||subSet.vertexBufferDirty){subSet.vertexBuffer=stage3DProxy._iContext3D.createVertexBuffer(subSet.numVertices,11);subSet.vertexBuffer.uploadFromArray(subSet.vertices,0,subSet.numVertices);subSet.vertexBufferDirty=false;subSet.vertexContext3D=stage3DProxy.context3D}var context3d=stage3DProxy._iContext3D;context3d.setVertexBufferAt(0,vertexBuffer,0,away.display3D.Context3DVertexBufferFormat.FLOAT_3);context3d.setVertexBufferAt(1,vertexBuffer,3,away.display3D.Context3DVertexBufferFormat.FLOAT_3);context3d.setVertexBufferAt(2,vertexBuffer,6,away.display3D.Context3DVertexBufferFormat.FLOAT_1);context3d.setVertexBufferAt(3,vertexBuffer,7,away.display3D.Context3DVertexBufferFormat.FLOAT_4)};SegmentSet.prototype.activateUVBuffer=function(index,stage3DProxy){};SegmentSet.prototype.activateVertexNormalBuffer=function(index,stage3DProxy){};SegmentSet.prototype.activateVertexTangentBuffer=function(index,stage3DProxy){};SegmentSet.prototype.activateSecondaryUVBuffer=function(index,stage3DProxy){};SegmentSet.prototype.reOrderIndices=function(subSetIndex,index){var segRef;for(var i=index;i<this._indexSegments-1;++i){segRef=this._pSegments[i+1];segRef.index=i;if(segRef.subSetIndex==subSetIndex){segRef.segment.iIndex-=44}this._pSegments[i]=segRef}};SegmentSet.prototype.addSubSet=function(){var subSet=new SubSet();this._subSets.push(subSet);subSet.vertices=[];subSet.numVertices=0;subSet.indices=[];subSet.numIndices=0;subSet.vertexBufferDirty=true;subSet.indexBufferDirty=true;subSet.lineCount=0;this._subSetCount++;return subSet};SegmentSet.prototype.dispose=function(){_super.prototype.dispose.call(this);this.removeAllSegments();this._pSegments=null;this._material=null;var subSet=this._subSets[0];subSet.vertices=null;subSet.indices=null;this._subSets=null};Object.defineProperty(SegmentSet.prototype,"mouseEnabled",{get:function(){return false},enumerable:true,configurable:true});SegmentSet.prototype.pGetDefaultBoundingVolume=function(){return new away.bounds.BoundingSphere()};SegmentSet.prototype.pUpdateBounds=function(){var subSet;var len;var v;var index;var minX=Infinity;var minY=Infinity;var minZ=Infinity;var maxX=-Infinity;var maxY=-Infinity;var maxZ=-Infinity;var vertices;for(var i=0;i<this._subSetCount;++i){subSet=this._subSets[i];index=0;vertices=subSet.vertices;len=vertices.length;if(len==0){continue}while(index<len){v=vertices[index++];if(v<minX){minX=v}else{if(v>maxX){maxX=v}}v=vertices[index++];if(v<minY){minY=v}else{if(v>maxY){maxY=v}}v=vertices[index++];if(v<minZ){minZ=v}else{if(v>maxZ){maxZ=v}}index+=8}}if(minX!=Infinity){this._pBounds.fromExtremes(minX,minY,minZ,maxX,maxY,maxZ)}else{var min=0.5;this._pBounds.fromExtremes(-min,-min,-min,min,min,min)}this._pBoundsInvalid=false};SegmentSet.prototype.pCreateEntityPartitionNode=function(){return new away.partition.RenderableNode(this)};Object.defineProperty(SegmentSet.prototype,"numTriangles",{get:function(){return this._numIndices/3},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"sourceEntity",{get:function(){return this},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"castsShadows",{get:function(){return false},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"material",{get:function(){return this._material},set:function(value){if(value==this._material){return}if(this._material){this._material.iRemoveOwner(this)}this._material=value;if(this._material){this._material.iAddOwner(this)}},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"animator",{get:function(){return this._animator},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"uvTransform",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"vertexData",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"indexData",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"UVData",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"numVertices",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"vertexStride",{get:function(){return 11},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"vertexNormalData",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"vertexTangentData",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"vertexOffset",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"vertexNormalOffset",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"vertexTangentOffset",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(SegmentSet.prototype,"assetType",{get:function(){return away.library.AssetType.SEGMENT_SET},enumerable:true,configurable:true});SegmentSet.prototype.getRenderSceneTransform=function(camera){return this._pSceneTransform};return SegmentSet})(away.entities.Entity);entities.SegmentSet=SegmentSet;var SegRef=(function(){function SegRef(){}return SegRef})();var SubSet=(function(){function SubSet(){}SubSet.prototype.dispose=function(){this.vertices=null;if(this.vertexBuffer){this.vertexBuffer.dispose()}if(this.indexBuffer){this.indexBuffer.dispose()}};return SubSet})()})(away.entities||(away.entities={}));var entities=away.entities})(away||(away={}));var away;(function(away){(function(entities){var Mesh=(function(_super){__extends(Mesh,_super);function Mesh(geometry,material){if(typeof material==="undefined"){material=null}_super.call(this);this._castsShadows=true;this._shareAnimationGeometry=true;this._subMeshes=new Array();if(geometry==null){this.geometry=new away.base.Geometry()}else{this.geometry=geometry}if(material==null){this.material=away.materials.DefaultMaterialManager.getDefaultMaterial(this)}else{this.material=material}}Mesh.prototype.bakeTransformations=function(){this.geometry.applyTransformation(this.transform);this.transform.identity()};Object.defineProperty(Mesh.prototype,"assetType",{get:function(){return away.library.AssetType.MESH},enumerable:true,configurable:true});Mesh.prototype.onGeometryBoundsInvalid=function(event){this.pInvalidateBounds()};Object.defineProperty(Mesh.prototype,"castsShadows",{get:function(){return this._castsShadows},set:function(value){this._castsShadows=value},enumerable:true,configurable:true});Object.defineProperty(Mesh.prototype,"animator",{get:function(){return this._animator},set:function(value){away.Debug.throwPIR("Mesh","set animator","Partial Implementation")},enumerable:true,configurable:true});Object.defineProperty(Mesh.prototype,"geometry",{get:function(){return this._geometry},set:function(value){var i;if(this._geometry){this._geometry.removeEventListener(away.events.GeometryEvent.BOUNDS_INVALID,this.onGeometryBoundsInvalid,this);this._geometry.removeEventListener(away.events.GeometryEvent.SUB_GEOMETRY_ADDED,this.onSubGeometryAdded,this);this._geometry.removeEventListener(away.events.GeometryEvent.SUB_GEOMETRY_REMOVED,this.onSubGeometryRemoved,this);for(i=0;i<this._subMeshes.length;++i){this._subMeshes[i].dispose()}this._subMeshes.length=0}this._geometry=value;if(this._geometry){this._geometry.addEventListener(away.events.GeometryEvent.BOUNDS_INVALID,this.onGeometryBoundsInvalid,this);this._geometry.addEventListener(away.events.GeometryEvent.SUB_GEOMETRY_ADDED,this.onSubGeometryAdded,this);this._geometry.addEventListener(away.events.GeometryEvent.SUB_GEOMETRY_REMOVED,this.onSubGeometryRemoved,this);var subGeoms=this._geometry.subGeometries;for(i=0;i<subGeoms.length;++i){this.addSubMesh(subGeoms[i])}}if(this._material){this._material.iRemoveOwner(this);this._material.iAddOwner(this)}},enumerable:true,configurable:true});Object.defineProperty(Mesh.prototype,"material",{get:function(){return this._material},set:function(value){if(value==this._material){return}if(this._material){this._material.iRemoveOwner(this)}this._material=value;if(this._material){this._material.iAddOwner(this)}},enumerable:true,configurable:true});Object.defineProperty(Mesh.prototype,"subMeshes",{get:function(){this._geometry.iValidate();return this._subMeshes},enumerable:true,configurable:true});Object.defineProperty(Mesh.prototype,"shareAnimationGeometry",{get:function(){return this._shareAnimationGeometry},set:function(value){this._shareAnimationGeometry=value},enumerable:true,configurable:true});Mesh.prototype.clearAnimationGeometry=function(){away.Debug.throwPIR("away.entities.Mesh","away.entities.Mesh","Missing Dependency: IAnimator")};Mesh.prototype.dispose=function(){_super.prototype.dispose.call(this);this.material=null;this.geometry=null};Mesh.prototype.disposeWithAnimatorAndChildren=function(){this.disposeWithChildren();away.Debug.throwPIR("away.entities.Mesh","away.entities.Mesh","Missing Dependency: IAnimator")};Mesh.prototype.clone=function(){var clone=new away.entities.Mesh(this._geometry,this._material);clone.transform=this.transform;clone.pivotPoint=this.pivotPoint;clone.partition=this.partition;clone.bounds=this._pBounds.clone();clone.name=this.name;clone.castsShadows=this.castsShadows;clone.shareAnimationGeometry=this.shareAnimationGeometry;clone.mouseEnabled=this.mouseEnabled;clone.mouseChildren=this.mouseChildren;clone.extra=this.extra;var len=this._subMeshes.length;for(var i=0;i<len;++i){clone._subMeshes[i].material=this._subMeshes[i].material}len=this.numChildren;var obj;for(i=0;i<len;++i){obj=this.getChildAt(i).clone();clone.addChild(obj)}away.Debug.throwPIR("away.entities.Mesh","away.entities.Mesh","Missing Dependency: IAnimator");return clone};Mesh.prototype.pUpdateBounds=function(){this._pBounds.fromGeometry(this._geometry);this._pBoundsInvalid=false};Mesh.prototype.pCreateEntityPartitionNode=function(){return new away.partition.MeshNode(this)};Mesh.prototype.onSubGeometryAdded=function(event){this.addSubMesh(event.subGeometry)};Mesh.prototype.onSubGeometryRemoved=function(event){var subMesh;var subGeom=event.subGeometry;var len=this._subMeshes.length;var i;for(i=0;i<len;++i){subMesh=this._subMeshes[i];if(subMesh.subGeometry==subGeom){subMesh.dispose();this._subMeshes.splice(i,1);break}}--len;for(;i<len;++i){this._subMeshes[i]._iIndex=i}};Mesh.prototype.addSubMesh=function(subGeometry){var subMesh=new away.base.SubMesh(subGeometry,this,null);var len=this._subMeshes.length;subMesh._iIndex=len;this._subMeshes[len]=subMesh;this.pInvalidateBounds()};Mesh.prototype.getSubMeshForSubGeometry=function(subGeometry){return this._subMeshes[this._geometry.subGeometries.indexOf(subGeometry)]};Mesh.prototype.iCollidesBefore=function(shortestCollisionDistance,findClosest){this._iPickingCollider.setLocalRay(this._iPickingCollisionVO.localRayPosition,this._iPickingCollisionVO.localRayDirection);this._iPickingCollisionVO.renderable=null;var len=this._subMeshes.length;for(var i=0;i<len;++i){var subMesh=this._subMeshes[i];if(this._iPickingCollider.testSubMeshCollision(subMesh,this._iPickingCollisionVO,shortestCollisionDistance)){shortestCollisionDistance=this._iPickingCollisionVO.rayEntryDistance;this._iPickingCollisionVO.renderable=subMesh;if(!findClosest){return true}}}return this._iPickingCollisionVO.renderable!=null};return Mesh})(away.entities.Entity);entities.Mesh=Mesh})(away.entities||(away.entities={}));var entities=away.entities})(away||(away={}));var away;(function(away){(function(entities){var SkyBox=(function(_super){__extends(SkyBox,_super);function SkyBox(cubeMap){_super.call(this);this._uvTransform=new away.geom.Matrix();this._material=new away.materials.SkyBoxMaterial(cubeMap);this._material.iAddOwner(this);this._geometry=new away.base.SubGeometry();this.buildGeometry(this._geometry)}Object.defineProperty(SkyBox.prototype,"animator",{get:function(){return this._animator},enumerable:true,configurable:true});SkyBox.prototype.pGetDefaultBoundingVolume=function(){return new away.bounds.NullBounds()};SkyBox.prototype.activateVertexBuffer=function(index,stage3DProxy){this._geometry.activateVertexBuffer(index,stage3DProxy)};SkyBox.prototype.activateUVBuffer=function(index,stage3DProxy){};SkyBox.prototype.activateVertexNormalBuffer=function(index,stage3DProxy){};SkyBox.prototype.activateVertexTangentBuffer=function(index,stage3DProxy){};SkyBox.prototype.activateSecondaryUVBuffer=function(index,stage3DProxy){};SkyBox.prototype.getIndexBuffer=function(stage3DProxy){return this._geometry.getIndexBuffer(stage3DProxy)};Object.defineProperty(SkyBox.prototype,"numTriangles",{get:function(){return this._geometry.numTriangles},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"sourceEntity",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"material",{get:function(){return this._material},set:function(value){throw new away.errors.AbstractMethodError("Unsupported method!")},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"assetType",{get:function(){return away.library.AssetType.SKYBOX},enumerable:true,configurable:true});SkyBox.prototype.pInvalidateBounds=function(){};SkyBox.prototype.pCreateEntityPartitionNode=function(){return new away.partition.SkyBoxNode(this)};SkyBox.prototype.pUpdateBounds=function(){this._pBoundsInvalid=false};SkyBox.prototype.buildGeometry=function(target){var vertices=new Array(-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1);var indices=new Array(0,1,2,2,3,0,6,5,4,4,7,6,2,6,7,7,3,2,4,5,1,1,0,4,4,0,3,3,7,4,2,1,5,5,6,2);target.updateVertexData(vertices);target.updateIndexData(indices)};Object.defineProperty(SkyBox.prototype,"castsShadows",{get:function(){return false},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"uvTransform",{get:function(){return this._uvTransform},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"vertexData",{get:function(){return this._geometry.vertexData},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"indexData",{get:function(){return this._geometry.indexData},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"UVData",{get:function(){return this._geometry.UVData},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"numVertices",{get:function(){return this._geometry.numVertices},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"vertexStride",{get:function(){return this._geometry.vertexStride},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"vertexNormalData",{get:function(){return this._geometry.vertexNormalData},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"vertexTangentData",{get:function(){return this._geometry.vertexTangentData},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"vertexOffset",{get:function(){return this._geometry.vertexOffset},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"vertexNormalOffset",{get:function(){return this._geometry.vertexNormalOffset},enumerable:true,configurable:true});Object.defineProperty(SkyBox.prototype,"vertexTangentOffset",{get:function(){return this._geometry.vertexTangentOffset},enumerable:true,configurable:true});SkyBox.prototype.getRenderSceneTransform=function(camera){return this._pSceneTransform};return SkyBox})(away.entities.Entity);entities.SkyBox=SkyBox})(away.entities||(away.entities={}));var entities=away.entities})(away||(away={}));var away;(function(away){(function(entities){var Sprite3D=(function(_super){__extends(Sprite3D,_super);function Sprite3D(material,width,height){_super.call(this);this._shadowCaster=false;this.material=material;this._width=width;this._height=height;this._spriteMatrix=new away.geom.Matrix3D();if(!Sprite3D._geometry){Sprite3D._geometry=new away.base.SubGeometry();Sprite3D._geometry.updateVertexData(Array(-0.5,0.5,0,0.5,0.5,0,0.5,-0.5,0,-0.5,-0.5,0));Sprite3D._geometry.updateUVData(Array(0,0,1,0,1,1,0,1));Sprite3D._geometry.updateIndexData(Array(0,1,2,0,2,3));Sprite3D._geometry.updateVertexTangentData(Array(1,0,0,1,0,0,1,0,0,1,0,0));Sprite3D._geometry.updateVertexNormalData(Array(0,0,-1,0,0,-1,0,0,-1,0,0,-1))}}Object.defineProperty(Sprite3D.prototype,"pickingCollider",{set:function(value){_super.prototype.setPickingCollider.call(this,value);if(value){this._pickingSubMesh=new away.base.SubMesh(Sprite3D._geometry,null);this._pickingTransform=new away.geom.Matrix3D()}},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"width",{get:function(){return this._width},set:function(value){if(this._width==value){return}this._width=value;this.iInvalidateTransform()},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"height",{get:function(){return this._height},set:function(value){if(this._height==value){return}this._height=value;this.iInvalidateTransform()},enumerable:true,configurable:true});Sprite3D.prototype.activateVertexBuffer=function(index,stage3DProxy){Sprite3D._geometry.activateVertexBuffer(index,stage3DProxy)};Sprite3D.prototype.activateUVBuffer=function(index,stage3DProxy){Sprite3D._geometry.activateUVBuffer(index,stage3DProxy)};Sprite3D.prototype.activateSecondaryUVBuffer=function(index,stage3DProxy){Sprite3D._geometry.activateSecondaryUVBuffer(index,stage3DProxy)};Sprite3D.prototype.activateVertexNormalBuffer=function(index,stage3DProxy){Sprite3D._geometry.activateVertexNormalBuffer(index,stage3DProxy)};Sprite3D.prototype.activateVertexTangentBuffer=function(index,stage3DProxy){Sprite3D._geometry.activateVertexTangentBuffer(index,stage3DProxy)};Sprite3D.prototype.getIndexBuffer=function(stage3DProxy){return Sprite3D._geometry.getIndexBuffer(stage3DProxy)};Object.defineProperty(Sprite3D.prototype,"numTriangles",{get:function(){return 2},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"sourceEntity",{get:function(){return this},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"material",{get:function(){return this._material},set:function(value){if(value==this._material){return}if(this._material){this._material.iRemoveOwner(this)}this._material=value;if(this._material){this._material.iAddOwner(this)}},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"animator",{get:function(){return this._animator},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"castsShadows",{get:function(){return this._shadowCaster},enumerable:true,configurable:true});Sprite3D.prototype.pGetDefaultBoundingVolume=function(){return new away.bounds.AxisAlignedBoundingBox()};Sprite3D.prototype.pUpdateBounds=function(){this._pBounds.fromExtremes(-0.5*this._pScaleX,-0.5*this._pScaleY,-0.5*this._pScaleZ,0.5*this._pScaleX,0.5*this._pScaleY,0.5*this._pScaleZ);this._pBoundsInvalid=false};Sprite3D.prototype.pCreateEntityPartitionNode=function(){return new away.partition.RenderableNode(this)};Sprite3D.prototype.pUpdateTransform=function(){_super.prototype.pUpdateTransform.call(this);this._pTransform.prependScale(this._width,this._height,Math.max(this._width,this._height))};Object.defineProperty(Sprite3D.prototype,"uvTransform",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"vertexData",{get:function(){return Sprite3D._geometry.vertexData},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"indexData",{get:function(){return Sprite3D._geometry.indexData},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"UVData",{get:function(){return Sprite3D._geometry.UVData},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"numVertices",{get:function(){return Sprite3D._geometry.numVertices},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"vertexStride",{get:function(){return Sprite3D._geometry.vertexStride},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"vertexNormalData",{get:function(){return Sprite3D._geometry.vertexNormalData},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"vertexTangentData",{get:function(){return Sprite3D._geometry.vertexTangentData},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"vertexOffset",{get:function(){return Sprite3D._geometry.vertexOffset},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"vertexNormalOffset",{get:function(){return Sprite3D._geometry.vertexNormalOffset},enumerable:true,configurable:true});Object.defineProperty(Sprite3D.prototype,"vertexTangentOffset",{get:function(){return Sprite3D._geometry.vertexTangentOffset},enumerable:true,configurable:true});Sprite3D.prototype.iCollidesBefore=function(shortestCollisionDistance,findClosest){findClosest=findClosest;var viewTransform=this._camera.inverseSceneTransform.clone();viewTransform.transpose();var rawViewTransform=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;viewTransform.copyRawDataTo(rawViewTransform);rawViewTransform[3]=0;rawViewTransform[7]=0;rawViewTransform[11]=0;rawViewTransform[12]=0;rawViewTransform[13]=0;rawViewTransform[14]=0;this._pickingTransform.copyRawDataFrom(rawViewTransform);this._pickingTransform.prependScale(this._width,this._height,Math.max(this._width,this._height));this._pickingTransform.appendTranslation(this.scenePosition.x,this.scenePosition.y,this.scenePosition.z);this._pickingTransform.invert();var localRayPosition=this._pickingTransform.transformVector(this._iPickingCollisionVO.rayPosition);var localRayDirection=this._pickingTransform.deltaTransformVector(this._iPickingCollisionVO.rayDirection);this._iPickingCollider.setLocalRay(localRayPosition,localRayDirection);this._iPickingCollisionVO.renderable=null;if(this._iPickingCollider.testSubMeshCollision(this._pickingSubMesh,this._iPickingCollisionVO,shortestCollisionDistance)){this._iPickingCollisionVO.renderable=this._pickingSubMesh}return this._iPickingCollisionVO.renderable!=null};Sprite3D.prototype.getRenderSceneTransform=function(camera){var comps=camera.sceneTransform.decompose();var scale=comps[2];comps[0]=this.scenePosition;scale.x=this._width*this._pScaleX;scale.y=this._height*this._pScaleY;this._spriteMatrix.recompose(comps);return this._spriteMatrix};return Sprite3D})(away.entities.Entity);entities.Sprite3D=Sprite3D})(away.entities||(away.entities={}));var entities=away.entities})(away||(away={}));var away;(function(away){(function(base){var SubMesh=(function(){function SubMesh(subGeometry,parentMesh,material){if(typeof material==="undefined"){material=null}this._iIndex=0;this._uvRotation=0;this._scaleU=1;this._scaleV=1;this._offsetU=0;this._offsetV=0;this._parentMesh=parentMesh;this._subGeometry=subGeometry;this.material=material}Object.defineProperty(SubMesh.prototype,"shaderPickingDetails",{get:function(){return this.sourceEntity.shaderPickingDetails},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"offsetU",{get:function(){return this._offsetU},set:function(value){if(value==this._offsetU){return}this._offsetU=value;this._uvTransformDirty=true},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"offsetV",{get:function(){return this._offsetV},set:function(value){if(value==this._offsetV){return}this._offsetV=value;this._uvTransformDirty=true},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"scaleU",{get:function(){return this._scaleU},set:function(value){if(value==this._scaleU){return}this._scaleU=value;this._uvTransformDirty=true},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"scaleV",{get:function(){return this._scaleV},set:function(value){if(value==this._scaleV){return}this._scaleV=value;this._uvTransformDirty=true},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"uvRotation",{get:function(){return this._uvRotation},set:function(value){if(value==this._uvRotation){return}this._uvRotation=value;this._uvTransformDirty=true},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"sourceEntity",{get:function(){return this._parentMesh},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"subGeometry",{get:function(){return this._subGeometry},set:function(value){this._subGeometry=value},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"material",{get:function(){return this._iMaterial||this._parentMesh.material},set:function(value){if(this._iMaterial){this._iMaterial.iRemoveOwner(this)}this._iMaterial=value;if(this._iMaterial){this._iMaterial.iAddOwner(this)}},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"sceneTransform",{get:function(){return this._parentMesh.sceneTransform},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"inverseSceneTransform",{get:function(){return this._parentMesh.inverseSceneTransform},enumerable:true,configurable:true});SubMesh.prototype.activateVertexBuffer=function(index,stage3DProxy){this._subGeometry.activateVertexBuffer(index,stage3DProxy)};SubMesh.prototype.activateVertexNormalBuffer=function(index,stage3DProxy){this._subGeometry.activateVertexNormalBuffer(index,stage3DProxy)};SubMesh.prototype.activateVertexTangentBuffer=function(index,stage3DProxy){this._subGeometry.activateVertexTangentBuffer(index,stage3DProxy)};SubMesh.prototype.activateUVBuffer=function(index,stage3DProxy){this._subGeometry.activateUVBuffer(index,stage3DProxy)};SubMesh.prototype.activateSecondaryUVBuffer=function(index,stage3DProxy){this._subGeometry.activateSecondaryUVBuffer(index,stage3DProxy)};SubMesh.prototype.getIndexBuffer=function(stage3DProxy){return this._subGeometry.getIndexBuffer(stage3DProxy)};Object.defineProperty(SubMesh.prototype,"numTriangles",{get:function(){return this._subGeometry.numTriangles},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"animator",{get:function(){return this._parentMesh.animator},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"mouseEnabled",{get:function(){return this._parentMesh.mouseEnabled||this._parentMesh._iAncestorsAllowMouseEnabled},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"castsShadows",{get:function(){return this._parentMesh.castsShadows},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"iParentMesh",{get:function(){return this._parentMesh},set:function(value){this._parentMesh=value},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"uvTransform",{get:function(){if(this._uvTransformDirty){this.updateUVTransform()}return this._uvTransform},enumerable:true,configurable:true});SubMesh.prototype.updateUVTransform=function(){if(this._uvTransform==null){this._uvTransform=new away.geom.Matrix()}this._uvTransform.identity();if(this._uvRotation!=0){this._uvTransform.rotate(this._uvRotation)}if(this._scaleU!=1||this._scaleV!=1){this._uvTransform.scale(this._scaleU,this._scaleV)}this._uvTransform.translate(this._offsetU,this._offsetV);this._uvTransformDirty=false};SubMesh.prototype.dispose=function(){this.material=null};Object.defineProperty(SubMesh.prototype,"vertexData",{get:function(){return this._subGeometry.vertexData},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"indexData",{get:function(){return this._subGeometry.indexData},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"UVData",{get:function(){return this._subGeometry.UVData},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"bounds",{get:function(){return this._parentMesh.getBounds()},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"visible",{get:function(){return this._parentMesh.visible},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"numVertices",{get:function(){return this._subGeometry.numVertices},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"vertexStride",{get:function(){return this._subGeometry.vertexStride},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"UVStride",{get:function(){return this._subGeometry.UVStride},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"vertexNormalData",{get:function(){return this._subGeometry.vertexNormalData},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"vertexTangentData",{get:function(){return this._subGeometry.vertexTangentData},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"UVOffset",{get:function(){return this._subGeometry.UVOffset},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"vertexOffset",{get:function(){return this._subGeometry.vertexOffset},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"vertexNormalOffset",{get:function(){return this._subGeometry.vertexNormalOffset},enumerable:true,configurable:true});Object.defineProperty(SubMesh.prototype,"vertexTangentOffset",{get:function(){return this._subGeometry.vertexTangentOffset},enumerable:true,configurable:true});SubMesh.prototype.getRenderSceneTransform=function(camera){return this._parentMesh.sceneTransform};return SubMesh})();base.SubMesh=SubMesh})(away.base||(away.base={}));var base=away.base})(away||(away={}));var away;(function(away){(function(primitives){var WireframePrimitiveBase=(function(_super){__extends(WireframePrimitiveBase,_super);function WireframePrimitiveBase(color,thickness){if(typeof color==="undefined"){color=16777215}if(typeof thickness==="undefined"){thickness=1}_super.call(this);this._geomDirty=true;if(thickness<=0){thickness=1}this._color=color;this._thickness=thickness;this.mouseEnabled=this.mouseChildren=false}Object.defineProperty(WireframePrimitiveBase.prototype,"color",{get:function(){return this._color},set:function(value){this._color=value;for(var segRef in this._pSegments){segRef.segment.startColor=segRef.segment.endColor=value}},enumerable:true,configurable:true});Object.defineProperty(WireframePrimitiveBase.prototype,"thickness",{get:function(){return this._thickness},set:function(value){this._thickness=value;for(var segRef in this._pSegments){segRef.segment.thickness=segRef.segment.thickness=value}},enumerable:true,configurable:true});WireframePrimitiveBase.prototype.removeAllSegments=function(){_super.prototype.removeAllSegments.call(this)};WireframePrimitiveBase.prototype.getBounds=function(){if(this._geomDirty){this.updateGeometry()}return _super.prototype.getBounds.call(this)};WireframePrimitiveBase.prototype.pBuildGeometry=function(){throw new away.errors.AbstractMethodError()};WireframePrimitiveBase.prototype.pInvalidateGeometry=function(){this._geomDirty=true;this.pInvalidateBounds()};WireframePrimitiveBase.prototype.updateGeometry=function(){this.pBuildGeometry();this._geomDirty=false};WireframePrimitiveBase.prototype.pUpdateOrAddSegment=function(index,v0,v1){var segment;var s;var e;if((segment=this.getSegment(index))!=null){s=segment.start;e=segment.end;s.x=v0.x;s.y=v0.y;s.z=v0.z;e.x=v1.x;e.y=v1.y;e.z=v1.z;segment.updateSegment(s,e,null,this._color,this._color,this._thickness)}else{this.addSegment(new away.primitives.LineSegment(v0.clone(),v1.clone(),this._color,this._color,this._thickness))}};WireframePrimitiveBase.prototype.pUpdateMouseChildren=function(){this._iAncestorsAllowMouseEnabled=false};return WireframePrimitiveBase})(away.entities.SegmentSet);primitives.WireframePrimitiveBase=WireframePrimitiveBase})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var WireframeSphere=(function(_super){__extends(WireframeSphere,_super);function WireframeSphere(radius,segmentsW,segmentsH,color,thickness){if(typeof radius==="undefined"){radius=50}if(typeof segmentsW==="undefined"){segmentsW=16}if(typeof segmentsH==="undefined"){segmentsH=12}if(typeof color==="undefined"){color=16777215}if(typeof thickness==="undefined"){thickness=1}_super.call(this,color,thickness);this._radius=radius;this._segmentsW=segmentsW;this._segmentsH=segmentsH}WireframeSphere.prototype.pBuildGeometry=function(){var vertices=new Array();var v0=new away.geom.Vector3D();var v1=new away.geom.Vector3D();var i,j;var numVerts=0;var index=0;for(j=0;j<=this._segmentsH;++j){var horangle=Math.PI*j/this._segmentsH;var z=-this._radius*Math.cos(horangle);var ringradius=this._radius*Math.sin(horangle);for(i=0;i<=this._segmentsW;++i){var verangle=2*Math.PI*i/this._segmentsW;var x=ringradius*Math.cos(verangle);var y=ringradius*Math.sin(verangle);vertices[numVerts++]=x;vertices[numVerts++]=-z;vertices[numVerts++]=y}}for(j=1;j<=this._segmentsH;++j){for(i=1;i<=this._segmentsW;++i){var a=((this._segmentsW+1)*j+i)*3;var b=((this._segmentsW+1)*j+i-1)*3;var c=((this._segmentsW+1)*(j-1)+i-1)*3;var d=((this._segmentsW+1)*(j-1)+i)*3;if(j==this._segmentsH){v0.x=vertices[c];v0.y=vertices[c+1];v0.z=vertices[c+2];v1.x=vertices[d];v1.y=vertices[d+1];v1.z=vertices[d+2];this.pUpdateOrAddSegment(index++,v0,v1);v0.x=vertices[a];v0.y=vertices[a+1];v0.z=vertices[a+2];this.pUpdateOrAddSegment(index++,v0,v1)}else{if(j==1){v1.x=vertices[b];v1.y=vertices[b+1];v1.z=vertices[b+2];v0.x=vertices[c];v0.y=vertices[c+1];v0.z=vertices[c+2];this.pUpdateOrAddSegment(index++,v0,v1)}else{v1.x=vertices[b];v1.y=vertices[b+1];v1.z=vertices[b+2];v0.x=vertices[c];v0.y=vertices[c+1];v0.z=vertices[c+2];this.pUpdateOrAddSegment(index++,v0,v1);v1.x=vertices[d];v1.y=vertices[d+1];v1.z=vertices[d+2];this.pUpdateOrAddSegment(index++,v0,v1)}}}}};return WireframeSphere})(away.primitives.WireframePrimitiveBase);primitives.WireframeSphere=WireframeSphere})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var WireframeCube=(function(_super){__extends(WireframeCube,_super);function WireframeCube(width,height,depth,color,thickness){if(typeof width==="undefined"){width=100}if(typeof height==="undefined"){height=100}if(typeof depth==="undefined"){depth=100}if(typeof color==="undefined"){color=16777215}if(typeof thickness==="undefined"){thickness=1}_super.call(this,color,thickness);this._width=width;this._height=height;this._depth=depth}Object.defineProperty(WireframeCube.prototype,"width",{get:function(){return this._width},set:function(value){this._width=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframeCube.prototype,"height",{get:function(){return this._height},set:function(value){if(value<=0){throw new Error("Value needs to be greater than 0")}this._height=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframeCube.prototype,"depth",{get:function(){return this._depth},set:function(value){this._depth=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});WireframeCube.prototype.pBuildGeometry=function(){var v0=new away.geom.Vector3D();var v1=new away.geom.Vector3D();var hw=this._width*0.5;var hh=this._height*0.5;var hd=this._depth*0.5;v0.x=-hw;v0.y=hh;v0.z=-hd;v1.x=-hw;v1.y=-hh;v1.z=-hd;this.pUpdateOrAddSegment(0,v0,v1);v0.z=hd;v1.z=hd;this.pUpdateOrAddSegment(1,v0,v1);v0.x=hw;v1.x=hw;this.pUpdateOrAddSegment(2,v0,v1);v0.z=-hd;v1.z=-hd;this.pUpdateOrAddSegment(3,v0,v1);v0.x=-hw;v0.y=-hh;v0.z=-hd;v1.x=hw;v1.y=-hh;v1.z=-hd;this.pUpdateOrAddSegment(4,v0,v1);v0.y=hh;v1.y=hh;this.pUpdateOrAddSegment(5,v0,v1);v0.z=hd;v1.z=hd;this.pUpdateOrAddSegment(6,v0,v1);v0.y=-hh;v1.y=-hh;this.pUpdateOrAddSegment(7,v0,v1);v0.x=-hw;v0.y=-hh;v0.z=-hd;v1.x=-hw;v1.y=-hh;v1.z=hd;this.pUpdateOrAddSegment(8,v0,v1);v0.y=hh;v1.y=hh;this.pUpdateOrAddSegment(9,v0,v1);v0.x=hw;v1.x=hw;this.pUpdateOrAddSegment(10,v0,v1);v0.y=-hh;v1.y=-hh;this.pUpdateOrAddSegment(11,v0,v1)};return WireframeCube})(away.primitives.WireframePrimitiveBase);primitives.WireframeCube=WireframeCube})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var WireframeCylinder=(function(_super){__extends(WireframeCylinder,_super);function WireframeCylinder(topRadius,bottomRadius,height,segmentsW,segmentsH,color,thickness){if(typeof topRadius==="undefined"){topRadius=50}if(typeof bottomRadius==="undefined"){bottomRadius=50}if(typeof height==="undefined"){height=100}if(typeof segmentsW==="undefined"){segmentsW=16}if(typeof segmentsH==="undefined"){segmentsH=1}if(typeof color==="undefined"){color=16777215}if(typeof thickness==="undefined"){thickness=1}_super.call(this,color,thickness);this._topRadius=topRadius;this._bottomRadius=bottomRadius;this._height=height;this._segmentsW=segmentsW;this._segmentsH=segmentsH}WireframeCylinder.prototype.pBuildGeometry=function(){var i,j;var radius=this._topRadius;var revolutionAngle;var revolutionAngleDelta=WireframeCylinder.TWO_PI/this._segmentsW;var nextVertexIndex=0;var x,y,z;var lastLayer=new Array(this._segmentsH+1);for(j=0;j<=this._segmentsH;++j){lastLayer[j]=new Array(this._segmentsW+1);radius=this._topRadius-((j/this._segmentsH)*(this._topRadius-this._bottomRadius));z=-(this._height/2)+(j/this._segmentsH*this._height);var previousV=null;for(i=0;i<=this._segmentsW;++i){revolutionAngle=i*revolutionAngleDelta;x=radius*Math.cos(revolutionAngle);y=radius*Math.sin(revolutionAngle);var vertex;if(previousV){vertex=new away.geom.Vector3D(x,-z,y);this.pUpdateOrAddSegment(nextVertexIndex++,vertex,previousV);previousV=vertex}else{previousV=new away.geom.Vector3D(x,-z,y)}if(j>0){this.pUpdateOrAddSegment(nextVertexIndex++,vertex,lastLayer[j-1][i])}lastLayer[j][i]=previousV}}};Object.defineProperty(WireframeCylinder.prototype,"topRadius",{get:function(){return this._topRadius},set:function(value){this._topRadius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframeCylinder.prototype,"bottomRadius",{get:function(){return this._bottomRadius},set:function(value){this._bottomRadius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframeCylinder.prototype,"height",{get:function(){return this._height},set:function(value){if(this.height<=0){throw new Error("Height must be a value greater than zero.")}this._height=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});WireframeCylinder.TWO_PI=2*Math.PI;return WireframeCylinder})(away.primitives.WireframePrimitiveBase);primitives.WireframeCylinder=WireframeCylinder})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var WireframePlane=(function(_super){__extends(WireframePlane,_super);function WireframePlane(width,height,segmentsW,segmentsH,color,thickness,orientation){if(typeof segmentsW==="undefined"){segmentsW=10}if(typeof segmentsH==="undefined"){segmentsH=10}if(typeof color==="undefined"){color=16777215}if(typeof thickness==="undefined"){thickness=1}if(typeof orientation==="undefined"){orientation="yz"}_super.call(this,color,thickness);this._width=width;this._height=height;this._segmentsW=segmentsW;this._segmentsH=segmentsH;this._orientation=orientation}Object.defineProperty(WireframePlane.prototype,"orientation",{get:function(){return this._orientation},set:function(value){this._orientation=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframePlane.prototype,"width",{get:function(){return this._width},set:function(value){this._width=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframePlane.prototype,"height",{get:function(){return this._height},set:function(value){if(value<=0){throw new Error("Value needs to be greater than 0")}this._height=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframePlane.prototype,"segmentsW",{get:function(){return this._segmentsW},set:function(value){this._segmentsW=value;this.removeAllSegments();this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframePlane.prototype,"segmentsH",{get:function(){return this._segmentsH},set:function(value){this._segmentsH=value;this.removeAllSegments();this.pInvalidateGeometry()},enumerable:true,configurable:true});WireframePlane.prototype.pBuildGeometry=function(){var v0=new away.geom.Vector3D();var v1=new away.geom.Vector3D();var hw=this._width*0.5;var hh=this._height*0.5;var index=0;var ws,hs;if(this._orientation==WireframePlane.ORIENTATION_XY){v0.y=hh;v0.z=0;v1.y=-hh;v1.z=0;for(ws=0;ws<=this._segmentsW;++ws){v0.x=v1.x=(ws/this._segmentsW-0.5)*this._width;this.pUpdateOrAddSegment(index++,v0,v1)}v0.x=-hw;v1.x=hw;for(hs=0;hs<=this._segmentsH;++hs){v0.y=v1.y=(hs/this._segmentsH-0.5)*this._height;this.pUpdateOrAddSegment(index++,v0,v1)}}else{if(this._orientation==WireframePlane.ORIENTATION_XZ){v0.z=hh;v0.y=0;v1.z=-hh;v1.y=0;for(ws=0;ws<=this._segmentsW;++ws){v0.x=v1.x=(ws/this._segmentsW-0.5)*this._width;this.pUpdateOrAddSegment(index++,v0,v1)}v0.x=-hw;v1.x=hw;for(hs=0;hs<=this._segmentsH;++hs){v0.z=v1.z=(hs/this._segmentsH-0.5)*this._height;this.pUpdateOrAddSegment(index++,v0,v1)}}else{if(this._orientation==WireframePlane.ORIENTATION_YZ){v0.y=hh;v0.x=0;v1.y=-hh;v1.x=0;for(ws=0;ws<=this._segmentsW;++ws){v0.z=v1.z=(ws/this._segmentsW-0.5)*this._width;this.pUpdateOrAddSegment(index++,v0,v1)}v0.z=hw;v1.z=-hw;for(hs=0;hs<=this._segmentsH;++hs){v0.y=v1.y=(hs/this._segmentsH-0.5)*this._height;this.pUpdateOrAddSegment(index++,v0,v1)}}}}};WireframePlane.ORIENTATION_YZ="yz";WireframePlane.ORIENTATION_XY="xy";WireframePlane.ORIENTATION_XZ="xz";return WireframePlane})(away.primitives.WireframePrimitiveBase);primitives.WireframePlane=WireframePlane})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var WireframeRegularPolygon=(function(_super){__extends(WireframeRegularPolygon,_super);function WireframeRegularPolygon(radius,sides,color,thickness,orientation){if(typeof color==="undefined"){color=16777215}if(typeof thickness==="undefined"){thickness=1}if(typeof orientation==="undefined"){orientation="yz"}_super.call(this,color,thickness);this._radius=radius;this._sides=sides;this._orientation=orientation}Object.defineProperty(WireframeRegularPolygon.prototype,"orientation",{get:function(){return this._orientation},set:function(value){this._orientation=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframeRegularPolygon.prototype,"radius",{get:function(){return this._radius},set:function(value){this._radius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframeRegularPolygon.prototype,"sides",{get:function(){return this._sides},set:function(value){this._sides=value;this.removeAllSegments();this.pInvalidateGeometry()},enumerable:true,configurable:true});WireframeRegularPolygon.prototype.pBuildGeometry=function(){var v0=new away.geom.Vector3D();var v1=new away.geom.Vector3D();var index=0;var s;if(this._orientation==WireframeRegularPolygon.ORIENTATION_XY){v0.z=0;v1.z=0;for(s=0;s<this._sides;++s){v0.x=this._radius*Math.cos(2*Math.PI*s/this._sides);v0.y=this._radius*Math.sin(2*Math.PI*s/this._sides);v1.x=this._radius*Math.cos(2*Math.PI*(s+1)/this._sides);v1.y=this._radius*Math.sin(2*Math.PI*(s+1)/this._sides);this.pUpdateOrAddSegment(index++,v0,v1)}}else{if(this._orientation==WireframeRegularPolygon.ORIENTATION_XZ){v0.y=0;v1.y=0;for(s=0;s<this._sides;++s){v0.x=this._radius*Math.cos(2*Math.PI*s/this._sides);v0.z=this._radius*Math.sin(2*Math.PI*s/this._sides);v1.x=this._radius*Math.cos(2*Math.PI*(s+1)/this._sides);v1.z=this._radius*Math.sin(2*Math.PI*(s+1)/this._sides);this.pUpdateOrAddSegment(index++,v0,v1)}}else{if(this._orientation==WireframeRegularPolygon.ORIENTATION_YZ){v0.x=0;v1.x=0;for(s=0;s<this._sides;++s){v0.z=this._radius*Math.cos(2*Math.PI*s/this._sides);v0.y=this._radius*Math.sin(2*Math.PI*s/this._sides);v1.z=this._radius*Math.cos(2*Math.PI*(s+1)/this._sides);v1.y=this._radius*Math.sin(2*Math.PI*(s+1)/this._sides);this.pUpdateOrAddSegment(index++,v0,v1)}}}}};WireframeRegularPolygon.ORIENTATION_YZ="yz";WireframeRegularPolygon.ORIENTATION_XY="xy";WireframeRegularPolygon.ORIENTATION_XZ="xz";return WireframeRegularPolygon})(away.primitives.WireframePrimitiveBase);primitives.WireframeRegularPolygon=WireframeRegularPolygon})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var WireframeTetrahedron=(function(_super){__extends(WireframeTetrahedron,_super);function WireframeTetrahedron(width,height,color,thickness,orientation){if(typeof color==="undefined"){color=16777215}if(typeof thickness==="undefined"){thickness=1}if(typeof orientation==="undefined"){orientation="yz"}_super.call(this,color,thickness);this._width=width;this._height=height;this._orientation=orientation}Object.defineProperty(WireframeTetrahedron.prototype,"orientation",{get:function(){return this._orientation},set:function(value){this._orientation=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframeTetrahedron.prototype,"width",{get:function(){return this._width},set:function(value){if(value<=0){throw new Error("Value needs to be greater than 0")}this._width=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(WireframeTetrahedron.prototype,"height",{get:function(){return this._height},set:function(value){if(value<=0){throw new Error("Value needs to be greater than 0")}this._height=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});WireframeTetrahedron.prototype.pBuildGeometry=function(){var bv0;var bv1;var bv2;var bv3;var top;var hw=this._width*0.5;switch(this._orientation){case WireframeTetrahedron.ORIENTATION_XY:bv0=new away.geom.Vector3D(-hw,hw,0);bv1=new away.geom.Vector3D(hw,hw,0);bv2=new away.geom.Vector3D(hw,-hw,0);bv3=new away.geom.Vector3D(-hw,-hw,0);top=new away.geom.Vector3D(0,0,this._height);break;case WireframeTetrahedron.ORIENTATION_XZ:bv0=new away.geom.Vector3D(-hw,0,hw);bv1=new away.geom.Vector3D(hw,0,hw);bv2=new away.geom.Vector3D(hw,0,-hw);bv3=new away.geom.Vector3D(-hw,0,-hw);top=new away.geom.Vector3D(0,this._height,0);break;case WireframeTetrahedron.ORIENTATION_YZ:bv0=new away.geom.Vector3D(0,-hw,hw);bv1=new away.geom.Vector3D(0,hw,hw);bv2=new away.geom.Vector3D(0,hw,-hw);bv3=new away.geom.Vector3D(0,-hw,-hw);top=new away.geom.Vector3D(this._height,0,0);break}this.pUpdateOrAddSegment(0,bv0,bv1);this.pUpdateOrAddSegment(1,bv1,bv2);this.pUpdateOrAddSegment(2,bv2,bv3);this.pUpdateOrAddSegment(3,bv3,bv0);this.pUpdateOrAddSegment(4,bv0,top);this.pUpdateOrAddSegment(5,bv1,top);this.pUpdateOrAddSegment(6,bv2,top);this.pUpdateOrAddSegment(7,bv3,top)};WireframeTetrahedron.ORIENTATION_YZ="yz";WireframeTetrahedron.ORIENTATION_XY="xy";WireframeTetrahedron.ORIENTATION_XZ="xz";return WireframeTetrahedron})(away.primitives.WireframePrimitiveBase);primitives.WireframeTetrahedron=WireframeTetrahedron})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(partition){var NodeBase=(function(){function NodeBase(){this._pNumChildNodes=0;this._iNumEntities=0;this._pChildNodes=[]}Object.defineProperty(NodeBase.prototype,"showDebugBounds",{get:function(){return this._pDebugPrimitive!=null},set:function(value){if(this._pDebugPrimitive&&value==true){return}if(!this._pDebugPrimitive&&value==false){return}if(value){throw new away.errors.PartialImplementationError();this._pDebugPrimitive=this.pCreateDebugBounds()}else{this._pDebugPrimitive.dispose();this._pDebugPrimitive=null}for(var i=0;i<this._pNumChildNodes;++i){this._pChildNodes[i].showDebugBounds=value}},enumerable:true,configurable:true});Object.defineProperty(NodeBase.prototype,"parent",{get:function(){return this._iParent},enumerable:true,configurable:true});NodeBase.prototype.iAddNode=function(node){node._iParent=this;this._iNumEntities+=node._pNumEntities;this._pChildNodes[this._pNumChildNodes++]=node;node.showDebugBounds=this._pDebugPrimitive!=null;var numEntities=node._pNumEntities;node=this;do{node._iNumEntities+=numEntities}while((node=node._iParent)!=null)};NodeBase.prototype.iRemoveNode=function(node){var index=this._pChildNodes.indexOf(node);this._pChildNodes[index]=this._pChildNodes[--this._pNumChildNodes];this._pChildNodes.pop();var numEntities=node._pNumEntities;node=this;do{node._pNumEntities-=numEntities}while((node=node._iParent)!=null)};NodeBase.prototype.isInFrustum=function(planes,numPlanes){planes=planes;numPlanes=numPlanes;return true};NodeBase.prototype.isIntersectingRay=function(rayPosition,rayDirection){rayPosition=rayPosition;rayDirection=rayDirection;return true};NodeBase.prototype.findPartitionForEntity=function(entity){entity=entity;return this};NodeBase.prototype.acceptTraverser=function(traverser){if(this._pNumEntities==0&&!this._pDebugPrimitive){return}if(traverser.enterNode(this)){var i=0;while(i<this._pNumChildNodes){this._pChildNodes[i++].acceptTraverser(traverser)}if(this._pDebugPrimitive){traverser.applyRenderable(this._pDebugPrimitive)}}};NodeBase.prototype.pCreateDebugBounds=function(){return null};Object.defineProperty(NodeBase.prototype,"_pNumEntities",{get:function(){return this._iNumEntities},enumerable:true,configurable:true});NodeBase.prototype._pUpdateNumEntities=function(value){var diff=value-this._pNumEntities;var node=this;do{node._pNumEntities+=diff}while((node=node._iParent)!=null)};return NodeBase})();partition.NodeBase=NodeBase})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var NullNode=(function(){function NullNode(){}return NullNode})();partition.NullNode=NullNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var Partition3D=(function(){function Partition3D(rootNode){this._updatesMade=false;this._rootNode=rootNode||new away.partition.NullNode()}Object.defineProperty(Partition3D.prototype,"showDebugBounds",{get:function(){return this._rootNode.showDebugBounds},set:function(value){this._rootNode.showDebugBounds=value},enumerable:true,configurable:true});Partition3D.prototype.traverse=function(traverser){if(this._updatesMade){this.updateEntities()}++away.traverse.PartitionTraverser._iCollectionMark;this._rootNode.acceptTraverser(traverser)};Partition3D.prototype.iMarkForUpdate=function(entity){var node=entity.getEntityPartitionNode();var t=this._updateQueue;while(t){if(node==t){return}t=t._iUpdateQueueNext}node._iUpdateQueueNext=this._updateQueue;this._updateQueue=node;this._updatesMade=true};Partition3D.prototype.iRemoveEntity=function(entity){var node=entity.getEntityPartitionNode();var t;node.removeFromParent();if(node==this._updateQueue){this._updateQueue=node._iUpdateQueueNext}else{t=this._updateQueue;while(t&&t._iUpdateQueueNext!=node){t=t._iUpdateQueueNext}if(t){t._iUpdateQueueNext=node._iUpdateQueueNext}}node._iUpdateQueueNext=null;if(!this._updateQueue){this._updatesMade=false}};Partition3D.prototype.updateEntities=function(){var node=this._updateQueue;var targetNode;var t;this._updateQueue=null;this._updatesMade=false;do{targetNode=this._rootNode.findPartitionForEntity(node.entity);if(node.parent!=targetNode){if(node){node.removeFromParent()}targetNode.iAddNode(node)}t=node._iUpdateQueueNext;node._iUpdateQueueNext=null;node.entity.iInternalUpdate()}while((node=t)!=null)};return Partition3D})();partition.Partition3D=Partition3D})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(pick){var PickingCollisionVO=(function(){function PickingCollisionVO(entity){this.entity=entity}return PickingCollisionVO})();pick.PickingCollisionVO=PickingCollisionVO})(away.pick||(away.pick={}));var pick=away.pick})(away||(away={}));var away;(function(away){(function(partition){var EntityNode=(function(_super){__extends(EntityNode,_super);function EntityNode(entity){_super.call(this);this._entity=entity;this._iNumEntities=1}Object.defineProperty(EntityNode.prototype,"entity",{get:function(){return this._entity},enumerable:true,configurable:true});EntityNode.prototype.removeFromParent=function(){if(this._iParent){this._iParent.iRemoveNode(this)}this._iParent=null};EntityNode.prototype.isInFrustum=function(planes,numPlanes){if(!this._entity._iIsVisible){return false}return this._entity.worldBounds.isInFrustum(planes,numPlanes)};EntityNode.prototype.acceptTraverser=function(traverser){traverser.applyEntity(this._entity)};EntityNode.prototype.isIntersectingRay=function(rayPosition,rayDirection){if(!this._entity._iIsVisible){return false}return this._entity.isIntersectingRay(rayPosition,rayDirection)};return EntityNode})(partition.NodeBase);partition.EntityNode=EntityNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var CameraNode=(function(_super){__extends(CameraNode,_super);function CameraNode(camera){_super.call(this,camera)}CameraNode.prototype.acceptTraverser=function(traverser){};return CameraNode})(away.partition.EntityNode);partition.CameraNode=CameraNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var LightNode=(function(_super){__extends(LightNode,_super);function LightNode(light){_super.call(this,light);this._light=light}Object.defineProperty(LightNode.prototype,"light",{get:function(){return this._light},enumerable:true,configurable:true});LightNode.prototype.acceptTraverser=function(traverser){if(traverser.enterNode(this)){_super.prototype.acceptTraverser.call(this,traverser);traverser.applyUnknownLight(this._light)}};return LightNode})(away.partition.EntityNode);partition.LightNode=LightNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var DirectionalLightNode=(function(_super){__extends(DirectionalLightNode,_super);function DirectionalLightNode(light){_super.call(this,light);this._light=light}Object.defineProperty(DirectionalLightNode.prototype,"light",{get:function(){return this._light},enumerable:true,configurable:true});DirectionalLightNode.prototype.acceptTraverser=function(traverser){if(traverser.enterNode(this)){_super.prototype.acceptTraverser.call(this,traverser);traverser.applyDirectionalLight(this._light)}};return DirectionalLightNode})(away.partition.EntityNode);partition.DirectionalLightNode=DirectionalLightNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var PointLightNode=(function(_super){__extends(PointLightNode,_super);function PointLightNode(light){_super.call(this,light);this._light=light}Object.defineProperty(PointLightNode.prototype,"light",{get:function(){return this._light},enumerable:true,configurable:true});PointLightNode.prototype.acceptTraverser=function(traverser){if(traverser.enterNode(this)){_super.prototype.acceptTraverser.call(this,traverser);traverser.applyPointLight(this._light)}};return PointLightNode})(away.partition.EntityNode);partition.PointLightNode=PointLightNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var LightProbeNode=(function(_super){__extends(LightProbeNode,_super);function LightProbeNode(light){_super.call(this,light);this._light=light}Object.defineProperty(LightProbeNode.prototype,"light",{get:function(){return this._light},enumerable:true,configurable:true});LightProbeNode.prototype.acceptTraverser=function(traverser){if(traverser.enterNode(this)){_super.prototype.acceptTraverser.call(this,traverser);traverser.applyLightProbe(this._light)}};return LightProbeNode})(away.partition.EntityNode);partition.LightProbeNode=LightProbeNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var MeshNode=(function(_super){__extends(MeshNode,_super);function MeshNode(mesh){_super.call(this,mesh);this._mesh=mesh}Object.defineProperty(MeshNode.prototype,"mesh",{get:function(){return this._mesh},enumerable:true,configurable:true});MeshNode.prototype.acceptTraverser=function(traverser){if(traverser.enterNode(this)){_super.prototype.acceptTraverser.call(this,traverser);var subs=this._mesh.subMeshes;var i=0;var len=subs.length;while(i<len){traverser.applyRenderable(subs[i++])}}};return MeshNode})(away.partition.EntityNode);partition.MeshNode=MeshNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(partition){var SkyBoxNode=(function(_super){__extends(SkyBoxNode,_super);function SkyBoxNode(skyBox){_super.call(this,skyBox);this._skyBox=skyBox}SkyBoxNode.prototype.acceptTraverser=function(traverser){if(traverser.enterNode(this)){_super.prototype.acceptTraverser.call(this,traverser);traverser.applySkyBox(this._skyBox)}};SkyBoxNode.prototype.isInFrustum=function(planes,numPlanes){planes=planes;numPlanes=numPlanes;return true};return SkyBoxNode})(away.partition.EntityNode);partition.SkyBoxNode=SkyBoxNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(errors){var PartialImplementationError=(function(_super){__extends(PartialImplementationError,_super);function PartialImplementationError(dependency,id){if(typeof dependency==="undefined"){dependency=""}if(typeof id==="undefined"){id=0}_super.call(this,"PartialImplementationError - this function is in development. Required Dependency: "+dependency,id)}return PartialImplementationError})(errors.Error);errors.PartialImplementationError=PartialImplementationError})(away.errors||(away.errors={}));var errors=away.errors})(away||(away={}));var away;(function(away){(function(library){var AssetType=(function(){function AssetType(){}AssetType.ENTITY="entity";AssetType.SKYBOX="skybox";AssetType.CAMERA="camera";AssetType.SEGMENT_SET="segmentSet";AssetType.MESH="mesh";AssetType.GEOMETRY="geometry";AssetType.SKELETON="skeleton";AssetType.SKELETON_POSE="skeletonPose";AssetType.CONTAINER="container";AssetType.TEXTURE="texture";AssetType.TEXTURE_PROJECTOR="textureProjector";AssetType.MATERIAL="material";AssetType.ANIMATION_SET="animationSet";AssetType.ANIMATION_STATE="animationState";AssetType.ANIMATION_NODE="animationNode";AssetType.ANIMATOR="animator";AssetType.STATE_TRANSITION="stateTransition";AssetType.LIGHT="light";AssetType.LIGHT_PICKER="lightPicker";AssetType.SHADOW_MAP_METHOD="shadowMapMethod";AssetType.EFFECTS_METHOD="effectsMethod";return AssetType})();library.AssetType=AssetType})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(display){var Stage3D=(function(_super){__extends(Stage3D,_super);function Stage3D(canvas){_super.call(this);this._canvas=canvas}Stage3D.prototype.requestContext=function(aglslContext){if(typeof aglslContext==="undefined"){aglslContext=false}try{if(aglslContext){this._context3D=new away.display3D.AGLSLContext3D(this._canvas)}else{this._context3D=new away.display3D.Context3D(this._canvas)}}catch(e){this.dispatchEvent(new away.events.Event(away.events.Event.ERROR))}if(this._context3D){this.dispatchEvent(new away.events.Event(away.events.Event.CONTEXT3D_CREATE))}};Object.defineProperty(Stage3D.prototype,"width",{get:function(){return this._width},set:function(v){this._width=v;away.utils.CSS.setCanvasWidth(this._canvas,v)},enumerable:true,configurable:true});Object.defineProperty(Stage3D.prototype,"height",{get:function(){return this._height},set:function(v){this._height=v;away.utils.CSS.setCanvasHeight(this._canvas,v)},enumerable:true,configurable:true});Object.defineProperty(Stage3D.prototype,"x",{get:function(){return this._x},set:function(v){this._x=v;away.utils.CSS.setCanvasX(this._canvas,v)},enumerable:true,configurable:true});Object.defineProperty(Stage3D.prototype,"y",{get:function(){return this._y},set:function(v){this._y=v;away.utils.CSS.setCanvasY(this._canvas,v)},enumerable:true,configurable:true});Object.defineProperty(Stage3D.prototype,"visible",{get:function(){return away.utils.CSS.getCanvasVisibility(this._canvas)},set:function(v){away.utils.CSS.setCanvasVisibility(this._canvas,v)},enumerable:true,configurable:true});Object.defineProperty(Stage3D.prototype,"canvas",{get:function(){return this._canvas},enumerable:true,configurable:true});Object.defineProperty(Stage3D.prototype,"context3D",{get:function(){return this._context3D},enumerable:true,configurable:true});return Stage3D})(away.events.EventDispatcher);display.Stage3D=Stage3D})(away.display||(away.display={}));var display=away.display})(away||(away={}));var away;(function(away){(function(utils){var CSS=(function(){function CSS(){}CSS.setCanvasSize=function(canvas,width,height){canvas.style.width=width+"px";canvas.style.height=height+"px";canvas.width=width;canvas.height=height};CSS.setCanvasWidth=function(canvas,width){canvas.style.width=width+"px";canvas.width=width};CSS.setCanvasHeight=function(canvas,height){canvas.style.height=height+"px";canvas.height=height};CSS.setCanvasX=function(canvas,x){canvas.style.position="absolute";canvas.style.left=x+"px"};CSS.setCanvasY=function(canvas,y){canvas.style.position="absolute";canvas.style.top=y+"px"};CSS.getCanvasVisibility=function(canvas){return canvas.style.visibility=="visible"};CSS.setCanvasVisibility=function(canvas,visible){if(visible){canvas.style.visibility="visible"}else{canvas.style.visibility="hidden"}};CSS.setCanvasAlpha=function(canvas,alpha){var context=canvas.getContext("2d");context.globalAlpha=alpha};CSS.setCanvasPosition=function(canvas,x,y,absolute){if(typeof absolute==="undefined"){absolute=false}if(absolute){canvas.style.position="absolute"}else{canvas.style.position="relative"}canvas.style.left=x+"px";canvas.style.top=y+"px"};return CSS})();utils.CSS=CSS})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(errors){var DocumentError=(function(_super){__extends(DocumentError,_super);function DocumentError(message,id){if(typeof message==="undefined"){message="DocumentError"}if(typeof id==="undefined"){id=0}_super.call(this,message,id)}DocumentError.DOCUMENT_DOES_NOT_EXIST="documentDoesNotExist";return DocumentError})(errors.Error);errors.DocumentError=DocumentError})(away.errors||(away.errors={}));var errors=away.errors})(away||(away={}));var away;(function(away){(function(pick){var PickingColliderBase=(function(){function PickingColliderBase(){}PickingColliderBase.prototype._pPetCollisionNormal=function(indexData,vertexData,triangleIndex){var normal=new away.geom.Vector3D();var i0=indexData[triangleIndex]*3;var i1=indexData[triangleIndex+1]*3;var i2=indexData[triangleIndex+2]*3;var p0=new away.geom.Vector3D(vertexData[i0],vertexData[i0+1],vertexData[i0+2]);var p1=new away.geom.Vector3D(vertexData[i1],vertexData[i1+1],vertexData[i1+2]);var p2=new away.geom.Vector3D(vertexData[i2],vertexData[i2+1],vertexData[i2+2]);var side0=p1.subtract(p0);var side1=p2.subtract(p0);normal=side0.crossProduct(side1);normal.normalize();return normal};PickingColliderBase.prototype._pGetCollisionUV=function(indexData,uvData,triangleIndex,v,w,u,uvOffset,uvStride){var uv=new away.geom.Point();var uIndex=indexData[triangleIndex]*uvStride+uvOffset;var uv0=new away.geom.Vector3D(uvData[uIndex],uvData[uIndex+1]);uIndex=indexData[triangleIndex+1]*uvStride+uvOffset;var uv1=new away.geom.Vector3D(uvData[uIndex],uvData[uIndex+1]);uIndex=indexData[triangleIndex+2]*uvStride+uvOffset;var uv2=new away.geom.Vector3D(uvData[uIndex],uvData[uIndex+1]);uv.x=u*uv0.x+v*uv1.x+w*uv2.x;uv.y=u*uv0.y+v*uv1.y+w*uv2.y;return uv};PickingColliderBase.prototype.pGetMeshSubgeometryIndex=function(subGeometry){away.Debug.throwPIR("away.pick.PickingColliderBase","pGetMeshSubMeshIndex","GeometryUtils.getMeshSubMeshIndex");return 0};PickingColliderBase.prototype.pGetMeshSubMeshIndex=function(subMesh){away.Debug.throwPIR("away.pick.PickingColliderBase","pGetMeshSubMeshIndex","GeometryUtils.getMeshSubMeshIndex");return 0};PickingColliderBase.prototype.setLocalRay=function(localPosition,localDirection){this.rayPosition=localPosition;this.rayDirection=localDirection};return PickingColliderBase})();pick.PickingColliderBase=PickingColliderBase})(away.pick||(away.pick={}));var pick=away.pick})(away||(away={}));var away;(function(away){(function(pick){var AS3PickingCollider=(function(_super){__extends(AS3PickingCollider,_super);function AS3PickingCollider(findClosestCollision){if(typeof findClosestCollision==="undefined"){findClosestCollision=false}_super.call(this);this._findClosestCollision=findClosestCollision}AS3PickingCollider.prototype.testSubMeshCollision=function(subMesh,pickingCollisionVO,shortestCollisionDistance){var t;var i0,i1,i2;var rx,ry,rz;var nx,ny,nz;var cx,cy,cz;var coeff,u,v,w;var p0x,p0y,p0z;var p1x,p1y,p1z;var p2x,p2y,p2z;var s0x,s0y,s0z;var s1x,s1y,s1z;var nl,nDotV,D,disToPlane;var Q1Q2,Q1Q1,Q2Q2,RQ1,RQ2;var indexData=subMesh.indexData;var vertexData=subMesh.vertexData;var uvData=subMesh.UVData;var collisionTriangleIndex=-1;var bothSides=subMesh.material.bothSides;var vertexStride=subMesh.vertexStride;var vertexOffset=subMesh.vertexOffset;var uvStride=subMesh.UVStride;var uvOffset=subMesh.UVOffset;var numIndices=indexData.length;for(var index=0;index<numIndices;index+=3){i0=vertexOffset+indexData[index]*vertexStride;i1=vertexOffset+indexData[(index+1)]*vertexStride;i2=vertexOffset+indexData[(index+2)]*vertexStride;p0x=vertexData[i0];p0y=vertexData[(i0+1)];p0z=vertexData[(i0+2)];p1x=vertexData[i1];p1y=vertexData[(i1+1)];p1z=vertexData[(i1+2)];p2x=vertexData[i2];p2y=vertexData[(i2+1)];p2z=vertexData[(i2+2)];s0x=p1x-p0x;s0y=p1y-p0y;s0z=p1z-p0z;s1x=p2x-p0x;s1y=p2y-p0y;s1z=p2z-p0z;nx=s0y*s1z-s0z*s1y;ny=s0z*s1x-s0x*s1z;nz=s0x*s1y-s0y*s1x;nl=1/Math.sqrt(nx*nx+ny*ny+nz*nz);nx*=nl;ny*=nl;nz*=nl;nDotV=nx*this.rayDirection.x+ny*+this.rayDirection.y+nz*this.rayDirection.z;if((!bothSides&&nDotV<0)||(bothSides&&nDotV!=0)){D=-(nx*p0x+ny*p0y+nz*p0z);disToPlane=-(nx*this.rayPosition.x+ny*this.rayPosition.y+nz*this.rayPosition.z+D);t=disToPlane/nDotV;cx=this.rayPosition.x+t*this.rayDirection.x;cy=this.rayPosition.y+t*this.rayDirection.y;cz=this.rayPosition.z+t*this.rayDirection.z;Q1Q2=s0x*s1x+s0y*s1y+s0z*s1z;Q1Q1=s0x*s0x+s0y*s0y+s0z*s0z;Q2Q2=s1x*s1x+s1y*s1y+s1z*s1z;rx=cx-p0x;ry=cy-p0y;rz=cz-p0z;RQ1=rx*s0x+ry*s0y+rz*s0z;RQ2=rx*s1x+ry*s1y+rz*s1z;coeff=1/(Q1Q1*Q2Q2-Q1Q2*Q1Q2);v=coeff*(Q2Q2*RQ1-Q1Q2*RQ2);w=coeff*(-Q1Q2*RQ1+Q1Q1*RQ2);if(v<0){continue}if(w<0){continue}u=1-v-w;if(!(u<0)&&t>0&&t<shortestCollisionDistance){shortestCollisionDistance=t;collisionTriangleIndex=index/3;pickingCollisionVO.rayEntryDistance=t;pickingCollisionVO.localPosition=new away.geom.Vector3D(cx,cy,cz);pickingCollisionVO.localNormal=new away.geom.Vector3D(nx,ny,nz);pickingCollisionVO.uv=this._pGetCollisionUV(indexData,uvData,index,v,w,u,uvOffset,uvStride);pickingCollisionVO.index=index;pickingCollisionVO.subGeometryIndex=this.pGetMeshSubMeshIndex(subMesh);if(!this._findClosestCollision){return true}}}}if(collisionTriangleIndex>=0){return true}return false};return AS3PickingCollider})(away.pick.PickingColliderBase);pick.AS3PickingCollider=AS3PickingCollider})(away.pick||(away.pick={}));var pick=away.pick})(away||(away={}));var away;(function(away){(function(pick){var PickingColliderType=(function(){function PickingColliderType(){}PickingColliderType.BOUNDS_ONLY=null;PickingColliderType.AS3_FIRST_ENCOUNTERED=new away.pick.AS3PickingCollider(false);PickingColliderType.AS3_BEST_HIT=new away.pick.AS3PickingCollider(true);return PickingColliderType})();pick.PickingColliderType=PickingColliderType})(away.pick||(away.pick={}));var pick=away.pick})(away||(away={}));var away;(function(away){(function(containers){var View3D=(function(){function View3D(scene,camera,renderer,forceSoftware,profile){if(typeof scene==="undefined"){scene=null}if(typeof camera==="undefined"){camera=null}if(typeof renderer==="undefined"){renderer=null}if(typeof forceSoftware==="undefined"){forceSoftware=false}if(typeof profile==="undefined"){profile="baseline"}this._pBackBufferInvalid=true;this._pShareContext=false;this._width=0;this._height=0;this._localPos=new away.geom.Point();this._globalPos=new away.geom.Point();this._time=0;this._deltaTime=0;this._backgroundColor=0;this._backgroundAlpha=1;this._depthTextureInvalid=true;this._antiAlias=0;this._scissorRectDirty=true;this._viewportDirty=true;this._depthPrepass=false;this._layeredView=false;if(View3D.sStage==null){View3D.sStage=new away.display.Stage()}this._profile=profile;this._pScene=scene||new containers.Scene3D();this._pScene.addEventListener(away.events.Scene3DEvent.PARTITION_CHANGED,this.onScenePartitionChanged,this);this._pCamera=camera||new away.cameras.Camera3D();this._pRenderer=renderer||new away.render.DefaultRenderer();this._depthRenderer=new away.render.DepthRenderer();this._forceSoftware=forceSoftware;this._pEntityCollector=this._pRenderer.iCreateEntityCollector();this._pEntityCollector.camera=this._pCamera;this._pScissorRect=new away.geom.Rectangle();this._pCamera.addEventListener(away.events.CameraEvent.LENS_CHANGED,this.onLensChanged,this);this._pCamera.partition=this._pScene.partition;this.stage=View3D.sStage;this.onAddedToStage()}View3D.prototype.onScenePartitionChanged=function(e){if(this._pCamera){this._pCamera.partition=this.scene.partition}};Object.defineProperty(View3D.prototype,"stage3DProxy",{get:function(){return this._pStage3DProxy},set:function(stage3DProxy){if(this._pStage3DProxy){this._pStage3DProxy.removeEventListener(away.events.Stage3DEvent.VIEWPORT_UPDATED,this.onViewportUpdated,this)}this._pStage3DProxy=stage3DProxy;this._pStage3DProxy.addEventListener(away.events.Stage3DEvent.VIEWPORT_UPDATED,this.onViewportUpdated,this);this._pRenderer.iStage3DProxy=this._depthRenderer.iStage3DProxy=this._pStage3DProxy;this._globalPosDirty=true;this._pBackBufferInvalid=true},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"layeredView",{get:function(){return this._layeredView},set:function(value){this._layeredView=value},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"filters3d",{get:function(){return this._pFilter3DRenderer?this._pFilter3DRenderer.filters:null},set:function(value){if(value&&value.length==0){value=null}if(this._pFilter3DRenderer&&!value){this._pFilter3DRenderer.dispose();this._pFilter3DRenderer=null}else{if(!this._pFilter3DRenderer&&value){this._pFilter3DRenderer=new away.render.Filter3DRenderer(this._pStage3DProxy);this._pFilter3DRenderer.filters=value}}if(this._pFilter3DRenderer){this._pFilter3DRenderer.filters=value;this._pRequireDepthRender=this._pFilter3DRenderer.requireDepthRender}else{this._pRequireDepthRender=false;if(this._pDepthRender){this._pDepthRender.dispose();this._pDepthRender=null}}},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"renderer",{get:function(){return this._pRenderer},set:function(value){this._pRenderer.iDispose();this._pRenderer=value;this._pEntityCollector=this._pRenderer.iCreateEntityCollector();this._pEntityCollector.camera=this._pCamera;this._pRenderer.iStage3DProxy=this._pStage3DProxy;this._pRenderer.antiAlias=this._antiAlias;this._pRenderer.iBackgroundR=((this._backgroundColor>>16)&255)/255;this._pRenderer.iBackgroundG=((this._backgroundColor>>8)&255)/255;this._pRenderer.iBackgroundB=(this._backgroundColor&255)/255;this._pRenderer.iBackgroundAlpha=this._backgroundAlpha;this._pRenderer.iViewWidth=this._width;this._pRenderer.iViewHeight=this._height;this._pBackBufferInvalid=true},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"backgroundColor",{get:function(){return this._backgroundColor},set:function(value){this._backgroundColor=value;this._pRenderer.iBackgroundR=((value>>16)&255)/255;this._pRenderer.iBackgroundG=((value>>8)&255)/255;this._pRenderer.iBackgroundB=(value&255)/255},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"backgroundAlpha",{get:function(){return this._backgroundAlpha},set:function(value){if(value>1){value=1}else{if(value<0){value=0}}this._pRenderer.iBackgroundAlpha=value;this._backgroundAlpha=value},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"camera",{get:function(){return this._pCamera},set:function(camera){this._pCamera.removeEventListener(away.events.CameraEvent.LENS_CHANGED,this.onLensChanged,this);this._pCamera=camera;this._pEntityCollector.camera=this._pCamera;if(this._pScene){this._pCamera.partition=this._pScene.partition}this._pCamera.addEventListener(away.events.CameraEvent.LENS_CHANGED,this.onLensChanged,this);this._scissorRectDirty=true;this._viewportDirty=true},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"scene",{get:function(){return this._pScene},set:function(scene){this._pScene.removeEventListener(away.events.Scene3DEvent.PARTITION_CHANGED,this.onScenePartitionChanged,this);this._pScene=scene;this._pScene.addEventListener(away.events.Scene3DEvent.PARTITION_CHANGED,this.onScenePartitionChanged,this);if(this._pCamera){this._pCamera.partition=this._pScene.partition}},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"deltaTime",{get:function(){return this._deltaTime},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"width",{get:function(){return this._width},set:function(value){if(this._width==value){return}if(this._pRttBufferManager){this._pRttBufferManager.viewWidth=value}this._width=value;this._aspectRatio=this._width/this._height;this._pCamera.lens.iAspectRatio=this._aspectRatio;this._depthTextureInvalid=true;this._pRenderer.iViewWidth=value;this._pScissorRect.width=value;this._pBackBufferInvalid=true;this._scissorRectDirty=true},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"height",{get:function(){return this._height},set:function(value){if(this._height==value){return}if(this._pRttBufferManager){this._pRttBufferManager.viewHeight=value}this._height=value;this._aspectRatio=this._width/this._height;this._pCamera.lens.iAspectRatio=this._aspectRatio;this._depthTextureInvalid=true;this._pRenderer.iViewHeight=value;this._pScissorRect.height=value;this._pBackBufferInvalid=true;this._scissorRectDirty=true},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"x",{get:function(){return this._localPos.x},set:function(value){if(this.x==value){return}this._globalPos.x=this._localPos.x=value;this._globalPosDirty=true},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"y",{get:function(){return this._localPos.y},set:function(value){if(this.y==value){return}this._globalPos.y=this._localPos.y=value;this._globalPosDirty=true},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"visible",{get:function(){return true},set:function(v){},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"canvas",{get:function(){return this._pStage3DProxy.canvas},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"antiAlias",{get:function(){return this._antiAlias},set:function(value){this._antiAlias=value;this._pRenderer.antiAlias=value;this._pBackBufferInvalid=true},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"renderedFacesCount",{get:function(){return this._pEntityCollector._pNumTriangles},enumerable:true,configurable:true});Object.defineProperty(View3D.prototype,"shareContext",{get:function(){return this._pShareContext},set:function(value){if(this._pShareContext==value){return}this._pShareContext=value;this._globalPosDirty=true},enumerable:true,configurable:true});View3D.prototype.pUpdateBackBuffer=function(){if(this._pStage3DProxy._iContext3D&&!this._pShareContext){if(this._width&&this._height){this._pStage3DProxy.configureBackBuffer(this._width,this._height,this._antiAlias,true);this._pBackBufferInvalid=false}}};View3D.prototype.render=function(){if(!this._pStage3DProxy.recoverFromDisposal()){this._pBackBufferInvalid=true;return}if(this._pBackBufferInvalid){this.pUpdateBackBuffer()}if(this._pShareContext&&this._layeredView){this._pStage3DProxy.clearDepthBuffer()}if(this._globalPosDirty){this.pUpdateGlobalPos()}this.pUpdateTime();this.pUpdateViewSizeData();this._pEntityCollector.clear();this._pScene.traversePartitions(this._pEntityCollector);if(this._pRequireDepthRender){this.pRenderSceneDepthToTexture(this._pEntityCollector)}if(this._depthPrepass){this.pRenderDepthPrepass(this._pEntityCollector)}this._pRenderer.iClearOnRender=!this._depthPrepass;if(this._pFilter3DRenderer&&this._pStage3DProxy._iContext3D){this._pRenderer.iRender(this._pEntityCollector,this._pFilter3DRenderer.getMainInputTexture(this._pStage3DProxy),this._pRttBufferManager.renderToTextureRect);this._pFilter3DRenderer.render(this._pStage3DProxy,this._pCamera,this._pDepthRender)}else{this._pRenderer.iShareContext=this._pShareContext;if(this._pShareContext){this._pRenderer.iRender(this._pEntityCollector,null,this._pScissorRect)}else{this._pRenderer.iRender(this._pEntityCollector)}}if(!this._pShareContext){this._pStage3DProxy.present()}this._pEntityCollector.cleanUp();this._pStage3DProxy.bufferClear=false};View3D.prototype.pUpdateGlobalPos=function(){this._globalPosDirty=false;if(!this._pStage3DProxy){return}if(this._pShareContext){this._pScissorRect.x=this._globalPos.x-this._pStage3DProxy.x;this._pScissorRect.y=this._globalPos.y-this._pStage3DProxy.y}else{this._pScissorRect.x=0;this._pScissorRect.y=0;this._pStage3DProxy.x=this._globalPos.x;this._pStage3DProxy.y=this._globalPos.y}this._scissorRectDirty=true};View3D.prototype.pUpdateTime=function(){var time=away.utils.getTimer();if(this._time==0){this._time=time}this._deltaTime=time-this._time;this._time=time};View3D.prototype.pUpdateViewSizeData=function(){this._pCamera.lens.iAspectRatio=this._aspectRatio;if(this._scissorRectDirty){this._scissorRectDirty=false;this._pCamera.lens.iUpdateScissorRect(this._pScissorRect.x,this._pScissorRect.y,this._pScissorRect.width,this._pScissorRect.height)}if(this._viewportDirty){this._viewportDirty=false;this._pCamera.lens.iUpdateViewport(this._pStage3DProxy.viewPort.x,this._pStage3DProxy.viewPort.y,this._pStage3DProxy.viewPort.width,this._pStage3DProxy.viewPort.height)}if(this._pFilter3DRenderer||this._pRenderer.iRenderToTexture){this._pRenderer.iTextureRatioX=this._pRttBufferManager.textureRatioX;this._pRenderer.iTextureRatioY=this._pRttBufferManager.textureRatioY}else{this._pRenderer.iTextureRatioX=1;this._pRenderer.iTextureRatioY=1}};View3D.prototype.pRenderDepthPrepass=function(entityCollector){this._depthRenderer.disableColor=true;if(this._pFilter3DRenderer||this._pRenderer.iRenderToTexture){this._depthRenderer.iTextureRatioX=this._pRttBufferManager.textureRatioX;this._depthRenderer.iTextureRatioY=this._pRttBufferManager.textureRatioY;this._depthRenderer.iRender(entityCollector,this._pFilter3DRenderer.getMainInputTexture(this._pStage3DProxy),this._pRttBufferManager.renderToTextureRect)}else{this._depthRenderer.iTextureRatioX=1;this._depthRenderer.iTextureRatioY=1;this._depthRenderer.iRender(entityCollector)}this._depthRenderer.disableColor=false};View3D.prototype.pRenderSceneDepthToTexture=function(entityCollector){if(this._depthTextureInvalid||!this._pDepthRender){this.initDepthTexture(this._pStage3DProxy._iContext3D)}this._depthRenderer.iTextureRatioX=this._pRttBufferManager.textureRatioX;this._depthRenderer.iTextureRatioY=this._pRttBufferManager.textureRatioY;this._depthRenderer.iRender(entityCollector,this._pDepthRender)};View3D.prototype.initDepthTexture=function(context){this._depthTextureInvalid=false;if(this._pDepthRender){this._pDepthRender.dispose()}this._pDepthRender=context.createTexture(this._pRttBufferManager.textureWidth,this._pRttBufferManager.textureHeight,away.display3D.Context3DTextureFormat.BGRA,true)};View3D.prototype.dispose=function(){this._pStage3DProxy.removeEventListener(away.events.Stage3DEvent.VIEWPORT_UPDATED,this.onViewportUpdated,this);if(!this.shareContext){this._pStage3DProxy.dispose()}this._pRenderer.iDispose();if(this._pDepthRender){this._pDepthRender.dispose()}if(this._pRttBufferManager){this._pRttBufferManager.dispose()}this._pRttBufferManager=null;this._pDepthRender=null;this._depthRenderer=null;this._pStage3DProxy=null;this._pRenderer=null;this._pEntityCollector=null};Object.defineProperty(View3D.prototype,"iEntityCollector",{get:function(){return this._pEntityCollector},enumerable:true,configurable:true});View3D.prototype.onLensChanged=function(event){this._scissorRectDirty=true;this._viewportDirty=true};View3D.prototype.onViewportUpdated=function(event){if(this._pShareContext){this._pScissorRect.x=this._globalPos.x-this._pStage3DProxy.x;this._pScissorRect.y=this._globalPos.y-this._pStage3DProxy.y;this._scissorRectDirty=true}this._viewportDirty=true};Object.defineProperty(View3D.prototype,"depthPrepass",{get:function(){return this._depthPrepass},set:function(value){this._depthPrepass=value},enumerable:true,configurable:true});View3D.prototype.onAddedToStage=function(){this._addedToStage=true;if(this._pStage3DProxy==null){this._pStage3DProxy=away.managers.Stage3DManager.getInstance(this.stage).getFreeStage3DProxy(this._forceSoftware,this._profile);this._pStage3DProxy.addEventListener(away.events.Stage3DEvent.VIEWPORT_UPDATED,this.onViewportUpdated,this)}this._globalPosDirty=true;this._pRttBufferManager=away.managers.RTTBufferManager.getInstance(this._pStage3DProxy);this._pRenderer.iStage3DProxy=this._depthRenderer.iStage3DProxy=this._pStage3DProxy;if(this._width==0){this.width=this.stage.stageWidth}else{this._pRttBufferManager.viewWidth=this._width}if(this._height==0){this.height=this.stage.stageHeight}else{this._pRttBufferManager.viewHeight=this._height}};View3D.prototype.project=function(point3d){var v=this._pCamera.project(point3d);v.x=(v.x+1)*this._width/2;v.y=(v.y+1)*this._height/2;return v};View3D.prototype.unproject=function(sX,sY,sZ){return this._pCamera.unproject((sX*2-this._width)/this._pStage3DProxy.width,(sY*2-this._height)/this._pStage3DProxy.height,sZ)};View3D.prototype.getRay=function(sX,sY,sZ){return this._pCamera.getRay((sX*2-this._width)/this._width,(sY*2-this._height)/this._height,sZ)};return View3D})();containers.View3D=View3D})(away.containers||(away.containers={}));var containers=away.containers})(away||(away={}));var away;(function(away){(function(library){var ConflictStrategyBase=(function(){function ConflictStrategyBase(){}ConflictStrategyBase.prototype.resolveConflict=function(changedAsset,oldAsset,assetsDictionary,precedence){throw new away.errors.AbstractMethodError()};ConflictStrategyBase.prototype.create=function(){throw new away.errors.AbstractMethodError()};ConflictStrategyBase.prototype._pUpdateNames=function(ns,nonConflictingName,oldAsset,newAsset,assetsDictionary,precedence){var loser_prev_name;var winner;var loser;winner=(precedence===away.library.ConflictPrecedence.FAVOR_NEW)?newAsset:oldAsset;loser=(precedence===away.library.ConflictPrecedence.FAVOR_NEW)?oldAsset:newAsset;loser_prev_name=loser.name;assetsDictionary[winner.name]=winner;assetsDictionary[nonConflictingName]=loser;loser.resetAssetPath(nonConflictingName,ns,false);loser.dispatchEvent(new away.events.AssetEvent(away.events.AssetEvent.ASSET_CONFLICT_RESOLVED,loser,loser_prev_name))};return ConflictStrategyBase})();library.ConflictStrategyBase=ConflictStrategyBase})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(library){var NumSuffixConflictStrategy=(function(_super){__extends(NumSuffixConflictStrategy,_super);function NumSuffixConflictStrategy(separator){if(typeof separator==="undefined"){separator="."}_super.call(this);this._separator=separator;this._next_suffix={}}NumSuffixConflictStrategy.prototype.resolveConflict=function(changedAsset,oldAsset,assetsDictionary,precedence){var orig;var new_name;var base;var suffix;orig=changedAsset.name;if(orig.indexOf(this._separator)>=0){base=orig.substring(0,orig.lastIndexOf(this._separator));suffix=parseInt(orig.substring(base.length-1));if(isNaN(suffix)){base=orig;suffix=0}}else{base=orig;suffix=0}if(suffix==0&&this._next_suffix.hasOwnProperty(base)){suffix=this._next_suffix[base]}do{suffix++;new_name=base.concat(this._separator,suffix.toString())}while(assetsDictionary.hasOwnProperty(new_name));this._next_suffix[base]=suffix;this._pUpdateNames(oldAsset.assetNamespace,new_name,oldAsset,changedAsset,assetsDictionary,precedence)};NumSuffixConflictStrategy.prototype.create=function(){return new away.library.NumSuffixConflictStrategy(this._separator)};return NumSuffixConflictStrategy})(away.library.ConflictStrategyBase);library.NumSuffixConflictStrategy=NumSuffixConflictStrategy})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(library){var IgnoreConflictStrategy=(function(_super){__extends(IgnoreConflictStrategy,_super);function IgnoreConflictStrategy(){_super.call(this)}IgnoreConflictStrategy.prototype.resolveConflict=function(changedAsset,oldAsset,assetsDictionary,precedence){return};IgnoreConflictStrategy.prototype.create=function(){return new away.library.IgnoreConflictStrategy()};return IgnoreConflictStrategy})(away.library.ConflictStrategyBase);library.IgnoreConflictStrategy=IgnoreConflictStrategy})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(library){var ErrorConflictStrategy=(function(_super){__extends(ErrorConflictStrategy,_super);function ErrorConflictStrategy(){_super.call(this)}ErrorConflictStrategy.prototype.resolveConflict=function(changedAsset,oldAsset,assetsDictionary,precedence){throw new away.errors.Error("Asset name collision while AssetLibrary.namingStrategy set to AssetLibrary.THROW_ERROR. Asset path: "+changedAsset.assetFullPath)};ErrorConflictStrategy.prototype.create=function(){return new ErrorConflictStrategy()};return ErrorConflictStrategy})(away.library.ConflictStrategyBase);library.ErrorConflictStrategy=ErrorConflictStrategy})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(library){var ConflictPrecedence=(function(){function ConflictPrecedence(){}ConflictPrecedence.FAVOR_OLD="favorOld";ConflictPrecedence.FAVOR_NEW="favorNew";return ConflictPrecedence})();library.ConflictPrecedence=ConflictPrecedence})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(library){var AssetLibraryBundle=(function(_super){__extends(AssetLibraryBundle,_super);function AssetLibraryBundle(me){_super.call(this);this._loadingSessionsGarbage=new Array();this._assets=new Array();this._assetDictionary=new Object();this._loadingSessions=new Array();this.conflictStrategy=away.library.ConflictStrategy.IGNORE.create();this.conflictPrecedence=away.library.ConflictPrecedence.FAVOR_NEW}AssetLibraryBundle.getInstance=function(key){if(typeof key==="undefined"){key="default"}if(!key){key="default"}if(!away.library.AssetLibrary._iInstances.hasOwnProperty(key)){away.library.AssetLibrary._iInstances[key]=new away.library.AssetLibraryBundle(new AssetLibraryBundleSingletonEnforcer())}return away.library.AssetLibrary._iInstances[key]};AssetLibraryBundle.prototype.enableParser=function(parserClass){away.loaders.SingleFileLoader.enableParser(parserClass)};AssetLibraryBundle.prototype.enableParsers=function(parserClasses){away.loaders.SingleFileLoader.enableParsers(parserClasses)};Object.defineProperty(AssetLibraryBundle.prototype,"conflictStrategy",{get:function(){return this._strategy},set:function(val){if(!val){throw new away.errors.Error("namingStrategy must not be null. To ignore naming, use AssetLibrary.IGNORE")}this._strategy=val.create()},enumerable:true,configurable:true});Object.defineProperty(AssetLibraryBundle.prototype,"conflictPrecedence",{get:function(){return this._strategyPreference},set:function(val){this._strategyPreference=val},enumerable:true,configurable:true});AssetLibraryBundle.prototype.createIterator=function(assetTypeFilter,namespaceFilter,filterFunc){if(typeof assetTypeFilter==="undefined"){assetTypeFilter=null}if(typeof namespaceFilter==="undefined"){namespaceFilter=null}if(typeof filterFunc==="undefined"){filterFunc=null}return new away.library.AssetLibraryIterator(this._assets,assetTypeFilter,namespaceFilter,filterFunc)};AssetLibraryBundle.prototype.load=function(req,context,ns,parser){if(typeof context==="undefined"){context=null}if(typeof ns==="undefined"){ns=null}if(typeof parser==="undefined"){parser=null}return this.loadResource(req,context,ns,parser)};AssetLibraryBundle.prototype.loadData=function(data,context,ns,parser){if(typeof context==="undefined"){context=null}if(typeof ns==="undefined"){ns=null}if(typeof parser==="undefined"){parser=null}return this.parseResource(data,context,ns,parser)};AssetLibraryBundle.prototype.getAsset=function(name,ns){if(typeof ns==="undefined"){ns=null}if(this._assetDictDirty){this.rehashAssetDict()}if(ns==null){ns=away.library.NamedAssetBase.DEFAULT_NAMESPACE}if(!this._assetDictionary.hasOwnProperty(ns)){return null}return this._assetDictionary[ns][name]};AssetLibraryBundle.prototype.addAsset=function(asset){var ns;var old;if(this._assets.indexOf(asset)>=0){return}old=this.getAsset(asset.name,asset.assetNamespace);ns=asset.assetNamespace||library.NamedAssetBase.DEFAULT_NAMESPACE;if(old!=null){this._strategy.resolveConflict(asset,old,this._assetDictionary[ns],this._strategyPreference)}asset.id=away.library.IDUtil.createUID();this._assets.push(asset);if(!this._assetDictionary.hasOwnProperty(ns)){this._assetDictionary[ns]=new Object()}this._assetDictionary[ns][asset.name]=asset;asset.addEventListener(away.events.AssetEvent.ASSET_RENAME,this.onAssetRename,this);asset.addEventListener(away.events.AssetEvent.ASSET_CONFLICT_RESOLVED,this.onAssetConflictResolved,this)};AssetLibraryBundle.prototype.removeAsset=function(asset,dispose){if(typeof dispose==="undefined"){dispose=true}var idx;this.removeAssetFromDict(asset);asset.removeEventListener(away.events.AssetEvent.ASSET_RENAME,this.onAssetRename,this);asset.removeEventListener(away.events.AssetEvent.ASSET_CONFLICT_RESOLVED,this.onAssetConflictResolved,this);idx=this._assets.indexOf(asset);if(idx>=0){this._assets.splice(idx,1)}if(dispose){asset.dispose()}};AssetLibraryBundle.prototype.removeAssetByName=function(name,ns,dispose){if(typeof ns==="undefined"){ns=null}if(typeof dispose==="undefined"){dispose=true}var asset=this.getAsset(name,ns);if(asset){this.removeAsset(asset,dispose)}return asset};AssetLibraryBundle.prototype.removeAllAssets=function(dispose){if(typeof dispose==="undefined"){dispose=true}if(dispose){var asset;for(var c=0;c<this._assets.length;c++){asset=this._assets[c];asset.dispose()}}this._assets.length=0;this.rehashAssetDict()};AssetLibraryBundle.prototype.removeNamespaceAssets=function(ns,dispose){if(typeof ns==="undefined"){ns=null}if(typeof dispose==="undefined"){dispose=true}var idx=0;var asset;var old_assets;old_assets=this._assets.concat();this._assets.length=0;if(ns==null){ns=away.library.NamedAssetBase.DEFAULT_NAMESPACE}for(var d=0;d<old_assets.length;d++){asset=old_assets[d];if(asset.assetNamespace==ns){if(dispose){asset.dispose()}this.removeAssetFromDict(asset,false)}else{this._assets[idx++]=asset}}if(this._assetDictionary.hasOwnProperty(ns)){delete this._assetDictionary[ns]}};AssetLibraryBundle.prototype.removeAssetFromDict=function(asset,autoRemoveEmptyNamespace){if(typeof autoRemoveEmptyNamespace==="undefined"){autoRemoveEmptyNamespace=true}if(this._assetDictDirty){this.rehashAssetDict()}if(this._assetDictionary.hasOwnProperty(asset.assetNamespace)){if(this._assetDictionary[asset.assetNamespace].hasOwnProperty(asset.name)){delete this._assetDictionary[asset.assetNamespace][asset.name]}if(autoRemoveEmptyNamespace){var key;var empty=true;for(key in this._assetDictionary[asset.assetNamespace]){empty=false;break}if(empty){delete this._assetDictionary[asset.assetNamespace]}}}};AssetLibraryBundle.prototype.loadResource=function(req,context,ns,parser){if(typeof context==="undefined"){context=null}if(typeof ns==="undefined"){ns=null}if(typeof parser==="undefined"){parser=null}var loader=new away.loaders.AssetLoader();if(!this._loadingSessions){this._loadingSessions=new Array()}this._loadingSessions.push(loader);loader.addEventListener(away.events.LoaderEvent.RESOURCE_COMPLETE,this.onResourceRetrieved,this);loader.addEventListener(away.events.LoaderEvent.DEPENDENCY_COMPLETE,this.onDependencyRetrieved,this);loader.addEventListener(away.events.AssetEvent.TEXTURE_SIZE_ERROR,this.onTextureSizeError,this);loader.addEventListener(away.events.AssetEvent.ASSET_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_SET_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_STATE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_NODE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.STATE_TRANSITION_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.TEXTURE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.CONTAINER_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.GEOMETRY_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.MATERIAL_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.MESH_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ENTITY_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.SKELETON_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.SKELETON_POSE_COMPLETE,this.onAssetComplete,this);loader._iAddErrorHandler(this.onDependencyRetrievingError);loader._iAddParseErrorHandler(this.onDependencyRetrievingParseError);return loader.load(req,context,ns,parser)};AssetLibraryBundle.prototype.stopAllLoadingSessions=function(){var i;if(!this._loadingSessions){this._loadingSessions=new Array()}var length=this._loadingSessions.length;for(i=0;i<length;i++){this.killLoadingSession(this._loadingSessions[i])}this._loadingSessions=null};AssetLibraryBundle.prototype.parseResource=function(data,context,ns,parser){if(typeof context==="undefined"){context=null}if(typeof ns==="undefined"){ns=null}if(typeof parser==="undefined"){parser=null}var loader=new away.loaders.AssetLoader();if(!this._loadingSessions){this._loadingSessions=new Array()}this._loadingSessions.push(loader);loader.addEventListener(away.events.LoaderEvent.RESOURCE_COMPLETE,this.onResourceRetrieved,this);loader.addEventListener(away.events.LoaderEvent.DEPENDENCY_COMPLETE,this.onDependencyRetrieved,this);loader.addEventListener(away.events.AssetEvent.TEXTURE_SIZE_ERROR,this.onTextureSizeError,this);loader.addEventListener(away.events.AssetEvent.ASSET_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_SET_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_STATE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_NODE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.STATE_TRANSITION_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.TEXTURE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.CONTAINER_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.GEOMETRY_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.MATERIAL_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.MESH_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ENTITY_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.SKELETON_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.SKELETON_POSE_COMPLETE,this.onAssetComplete,this);loader._iAddErrorHandler(this.onDependencyRetrievingError);loader._iAddParseErrorHandler(this.onDependencyRetrievingParseError);return loader.loadData(data,"",context,ns,parser)};AssetLibraryBundle.prototype.rehashAssetDict=function(){var asset;this._assetDictionary={};var l=this._assets.length;for(var c=0;c<l;c++){asset=this._assets[c];if(!this._assetDictionary.hasOwnProperty(asset.assetNamespace)){this._assetDictionary[asset.assetNamespace]={}}this._assetDictionary[asset.assetNamespace][asset.name]=asset}this._assetDictDirty=false};AssetLibraryBundle.prototype.onDependencyRetrieved=function(event){this.dispatchEvent(event)};AssetLibraryBundle.prototype.onDependencyRetrievingError=function(event){if(this.hasEventListener(away.events.LoaderEvent.LOAD_ERROR,this.onDependencyRetrievingError,this)){this.dispatchEvent(event);return true}else{return false}};AssetLibraryBundle.prototype.onDependencyRetrievingParseError=function(event){if(this.hasEventListener(away.events.ParserEvent.PARSE_ERROR,this.onDependencyRetrievingParseError,this)){this.dispatchEvent(event);return true}else{return false}};AssetLibraryBundle.prototype.onAssetComplete=function(event){if(event.type==away.events.AssetEvent.ASSET_COMPLETE){this.addAsset(event.asset)}this.dispatchEvent(event.clone())};AssetLibraryBundle.prototype.onTextureSizeError=function(event){this.dispatchEvent(event.clone())};AssetLibraryBundle.prototype.onResourceRetrieved=function(event){var _this=this;var loader=event.target;this.dispatchEvent(event.clone());var index=this._loadingSessions.indexOf(loader);this._loadingSessions.splice(index,1);this._loadingSessionsGarbage.push(loader);this._gcTimeoutIID=setTimeout(function(){_this.loadingSessionGC()},100)};AssetLibraryBundle.prototype.loadingSessionGC=function(){var loader;while(this._loadingSessionsGarbage.length>0){loader=this._loadingSessionsGarbage.pop();this.killLoadingSession(loader)}clearTimeout(this._gcTimeoutIID);this._gcTimeoutIID=null};AssetLibraryBundle.prototype.killLoadingSession=function(loader){loader.removeEventListener(away.events.LoaderEvent.LOAD_ERROR,this.onDependencyRetrievingError,this);loader.removeEventListener(away.events.LoaderEvent.RESOURCE_COMPLETE,this.onResourceRetrieved,this);loader.removeEventListener(away.events.LoaderEvent.DEPENDENCY_COMPLETE,this.onDependencyRetrieved,this);loader.removeEventListener(away.events.AssetEvent.TEXTURE_SIZE_ERROR,this.onTextureSizeError,this);loader.removeEventListener(away.events.AssetEvent.ASSET_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.ANIMATION_SET_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.ANIMATION_STATE_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.ANIMATION_NODE_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.STATE_TRANSITION_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.TEXTURE_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.CONTAINER_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.GEOMETRY_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.MATERIAL_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.MESH_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.ENTITY_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.SKELETON_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.SKELETON_POSE_COMPLETE,this.onAssetComplete,this);loader.stop()};AssetLibraryBundle.prototype.onAssetRename=function(ev){var asset=ev.target;var old=this.getAsset(asset.assetNamespace,asset.name);if(old!=null){this._strategy.resolveConflict(asset,old,this._assetDictionary[asset.assetNamespace],this._strategyPreference)}else{var dict=this._assetDictionary[ev.asset.assetNamespace];if(dict==null){return}dict[ev.assetPrevName]=null;dict[ev.asset.name]=ev.asset}};AssetLibraryBundle.prototype.onAssetConflictResolved=function(ev){this.dispatchEvent(ev.clone())};return AssetLibraryBundle})(away.events.EventDispatcher);library.AssetLibraryBundle=AssetLibraryBundle})(away.library||(away.library={}));var library=away.library})(away||(away={}));var AssetLibraryBundleSingletonEnforcer=(function(){function AssetLibraryBundleSingletonEnforcer(){}return AssetLibraryBundleSingletonEnforcer})();var away;(function(away){(function(loaders){var AssetLoaderContext=(function(){function AssetLoaderContext(includeDependencies,dependencyBaseUrl){if(typeof includeDependencies==="undefined"){includeDependencies=true}if(typeof dependencyBaseUrl==="undefined"){dependencyBaseUrl=null}this._includeDependencies=includeDependencies;this._dependencyBaseUrl=dependencyBaseUrl||"";this._embeddedDataByUrl={};this._remappedUrls={};this._materialMode=AssetLoaderContext.UNDEFINED}Object.defineProperty(AssetLoaderContext.prototype,"includeDependencies",{get:function(){return this._includeDependencies},set:function(val){this._includeDependencies=val},enumerable:true,configurable:true});Object.defineProperty(AssetLoaderContext.prototype,"materialMode",{get:function(){return this._materialMode},set:function(materialMode){this._materialMode=materialMode},enumerable:true,configurable:true});Object.defineProperty(AssetLoaderContext.prototype,"dependencyBaseUrl",{get:function(){return this._dependencyBaseUrl},set:function(val){this._dependencyBaseUrl=val},enumerable:true,configurable:true});Object.defineProperty(AssetLoaderContext.prototype,"overrideAbsolutePaths",{get:function(){return this._overrideAbsPath},set:function(val){this._overrideAbsPath=val},enumerable:true,configurable:true});Object.defineProperty(AssetLoaderContext.prototype,"overrideFullURLs",{get:function(){return this._overrideFullUrls},set:function(val){this._overrideFullUrls=val},enumerable:true,configurable:true});AssetLoaderContext.prototype.mapUrl=function(originalUrl,newUrl){this._remappedUrls[originalUrl]=newUrl};AssetLoaderContext.prototype.mapUrlToData=function(originalUrl,data){this._embeddedDataByUrl[originalUrl]=data};AssetLoaderContext.prototype._iHasDataForUrl=function(url){return this._embeddedDataByUrl.hasOwnProperty(url)};AssetLoaderContext.prototype._iGetDataForUrl=function(url){return this._embeddedDataByUrl[url]};AssetLoaderContext.prototype._iHasMappingForUrl=function(url){return this._remappedUrls.hasOwnProperty(url)};AssetLoaderContext.prototype._iGetRemappedUrl=function(originalUrl){return this._remappedUrls[originalUrl]};AssetLoaderContext.UNDEFINED=0;AssetLoaderContext.SINGLEPASS_MATERIALS=1;AssetLoaderContext.MULTIPASS_MATERIALS=2;return AssetLoaderContext})();loaders.AssetLoaderContext=AssetLoaderContext})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(library){var AssetLibraryIterator=(function(){function AssetLibraryIterator(assets,assetTypeFilter,namespaceFilter,filterFunc){this._assets=assets;this.filter(assetTypeFilter,namespaceFilter,filterFunc)}Object.defineProperty(AssetLibraryIterator.prototype,"currentAsset",{get:function(){return(this._idx<this._filtered.length)?this._filtered[this._idx]:null},enumerable:true,configurable:true});Object.defineProperty(AssetLibraryIterator.prototype,"numAssets",{get:function(){return this._filtered.length},enumerable:true,configurable:true});AssetLibraryIterator.prototype.next=function(){var next=null;if(this._idx<this._filtered.length){next=this._filtered[this._idx]}this._idx++;return next};AssetLibraryIterator.prototype.reset=function(){this._idx=0};AssetLibraryIterator.prototype.setIndex=function(index){this._idx=index};AssetLibraryIterator.prototype.filter=function(assetTypeFilter,namespaceFilter,filterFunc){if(assetTypeFilter||namespaceFilter){var idx;var asset;idx=0;this._filtered=new Array();var l=this._assets.length;for(var c=0;c<l;c++){asset=this._assets[c];if(assetTypeFilter&&asset.assetType!=assetTypeFilter){continue}if(namespaceFilter&&asset.assetNamespace!=namespaceFilter){continue}if(filterFunc!=null&&!filterFunc(asset)){continue}this._filtered[idx++]=asset}}else{this._filtered=this._assets}};return AssetLibraryIterator})();library.AssetLibraryIterator=AssetLibraryIterator})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(loaders){var AssetLoader=(function(_super){__extends(AssetLoader,_super);function AssetLoader(){_super.call(this);this._stack=new Array();this._errorHandlers=new Array();this._parseErrorHandlers=new Array()}Object.defineProperty(AssetLoader.prototype,"baseDependency",{get:function(){return this._baseDependency},enumerable:true,configurable:true});AssetLoader.enableParser=function(parserClass){away.loaders.SingleFileLoader.enableParser(parserClass)};AssetLoader.enableParsers=function(parserClasses){away.loaders.SingleFileLoader.enableParsers(parserClasses)};AssetLoader.prototype.load=function(req,context,ns,parser){if(typeof context==="undefined"){context=null}if(typeof ns==="undefined"){ns=null}if(typeof parser==="undefined"){parser=null}if(!this._token){this._token=new away.loaders.AssetLoaderToken(this);this._uri=req.url=req.url.replace(/\\/g,"/");this._context=context;this._namespace=ns;this._baseDependency=new away.loaders.ResourceDependency("",req,null,null);this.retrieveDependency(this._baseDependency,parser);return this._token}return null};AssetLoader.prototype.loadData=function(data,id,context,ns,parser){if(typeof context==="undefined"){context=null}if(typeof ns==="undefined"){ns=null}if(typeof parser==="undefined"){parser=null}if(!this._token){this._token=new away.loaders.AssetLoaderToken(this);this._uri=id;this._context=context;this._namespace=ns;this._baseDependency=new loaders.ResourceDependency(id,null,data,null);this.retrieveDependency(this._baseDependency,parser);return this._token}return null};AssetLoader.prototype.retrieveNext=function(parser){if(typeof parser==="undefined"){parser=null}if(this._loadingDependency.dependencies.length){var dep=this._loadingDependency.dependencies.pop();this._stack.push(this._loadingDependency);this.retrieveDependency(dep)}else{if(this._loadingDependency._iLoader.parser&&this._loadingDependency._iLoader.parser.parsingPaused){this._loadingDependency._iLoader.parser._iResumeParsingAfterDependencies();this._stack.pop()}else{if(this._stack.length){var prev=this._loadingDependency;this._loadingDependency=this._stack.pop();if(prev._iSuccess){prev.resolve()}this.retrieveNext(parser)}else{this.dispatchEvent(new away.events.LoaderEvent(away.events.LoaderEvent.RESOURCE_COMPLETE,this._uri))}}}};AssetLoader.prototype.retrieveDependency=function(dependency,parser){if(typeof parser==="undefined"){parser=null}var data;var matMode=0;if(this._context&&this._context.materialMode!=0){matMode=this._context.materialMode}this._loadingDependency=dependency;this._loadingDependency._iLoader=new away.loaders.SingleFileLoader(matMode);this.addEventListeners(this._loadingDependency._iLoader);data=this._loadingDependency.data;if(this._context&&this._loadingDependency.request&&this._context._iHasDataForUrl(this._loadingDependency.request.url)){data=this._context._iGetDataForUrl(this._loadingDependency.request.url)}if(data){if(this._loadingDependency.retrieveAsRawData){this.dispatchEvent(new away.events.LoaderEvent(away.events.LoaderEvent.DEPENDENCY_COMPLETE,this._loadingDependency.request.url,true));this._loadingDependency._iSetData(data);this._loadingDependency.resolve();this.retrieveNext()}else{this._loadingDependency._iLoader.parseData(data,parser,this._loadingDependency.request)}}else{dependency.request.url=this.resolveDependencyUrl(dependency);this._loadingDependency._iLoader.load(dependency.request,parser,this._loadingDependency.retrieveAsRawData)}};AssetLoader.prototype.joinUrl=function(base,end){if(end.charAt(0)=="/"){end=end.substr(1)}if(base.length==0){return end}if(base.charAt(base.length-1)=="/"){base=base.substr(0,base.length-1)}return base.concat("/",end)};AssetLoader.prototype.resolveDependencyUrl=function(dependency){var scheme_re;var base;var url=dependency.request.url;if(this._context&&this._context._iHasMappingForUrl(url)){return this._context._iGetRemappedUrl(url)}if(url==this._uri){return url}scheme_re=new RegExp("/^[a-zA-Z]{3,4}:///");if(url.charAt(0)=="/"){if(this._context&&this._context.overrideAbsolutePaths){return this.joinUrl(this._context.dependencyBaseUrl,url)}else{return url}}else{if(scheme_re.test(url)){if(this._context&&this._context.overrideFullURLs){var noscheme_url;noscheme_url=url.replace(scheme_re);return this.joinUrl(this._context.dependencyBaseUrl,noscheme_url)}}}if(this._context&&this._context.dependencyBaseUrl){base=this._context.dependencyBaseUrl;return this.joinUrl(base,url)}else{base=this._uri.substring(0,this._uri.lastIndexOf("/")+1);return this.joinUrl(base,url)}};AssetLoader.prototype.retrieveLoaderDependencies=function(loader){if(!this._loadingDependency){return}var i,len=loader.dependencies.length;for(i=0;i<len;i++){this._loadingDependency.dependencies[i]=loader.dependencies[i]}loader.dependencies.length=0;this._stack.push(this._loadingDependency);this.retrieveNext()};AssetLoader.prototype.onRetrievalFailed=function(event){var handled;var isDependency=(this._loadingDependency!=this._baseDependency);var loader=event.target;this.removeEventListeners(loader);event=new away.events.LoaderEvent(away.events.LoaderEvent.LOAD_ERROR,this._uri,isDependency,event.message);this.dispatchEvent(event);handled=true;var i,len=this._errorHandlers.length;for(i=0;i<len;i++){var handlerFunction=this._errorHandlers[i];handled=handled||handlerFunction(event)}if(handled){if(isDependency){this._loadingDependency.resolveFailure();this.retrieveNext()}else{this.dispose();return}}else{throw new away.errors.Error(event.message)}};AssetLoader.prototype.onParserError=function(event){var handled;var isDependency=(this._loadingDependency!=this._baseDependency);var loader=event.target;this.removeEventListeners(loader);event=new away.events.ParserEvent(away.events.ParserEvent.PARSE_ERROR,event.message);this.dispatchEvent(event);handled=true;var i,len=this._parseErrorHandlers.length;for(i=0;i<len;i++){var handlerFunction=this._parseErrorHandlers[i];handled=handled||handlerFunction(event)}if(handled){this.dispose();return}else{throw new Error(event.message)}};AssetLoader.prototype.onAssetComplete=function(event){if(event.type==away.events.AssetEvent.ASSET_COMPLETE){if(this._loadingDependency){this._loadingDependency.assets.push(event.asset)}event.asset.resetAssetPath(event.asset.name,this._namespace)}if(!this._loadingDependency.suppresAssetEvents){this.dispatchEvent(event.clone())}};AssetLoader.prototype.onReadyForDependencies=function(event){var loader=event.target;if(this._context&&!this._context.includeDependencies){loader.parser._iResumeParsingAfterDependencies()}else{this.retrieveLoaderDependencies(loader)}};AssetLoader.prototype.onRetrievalComplete=function(event){var loader=event.target;this._loadingDependency._iSetData(loader.data);this._loadingDependency._iSuccess=true;this.dispatchEvent(new away.events.LoaderEvent(away.events.LoaderEvent.DEPENDENCY_COMPLETE,event.url));this.removeEventListeners(loader);if(loader.dependencies.length&&(!this._context||this._context.includeDependencies)){this.retrieveLoaderDependencies(loader)}else{this.retrieveNext()}};AssetLoader.prototype.onTextureSizeError=function(event){event.asset.name=this._loadingDependency.resolveName(event.asset);this.dispatchEvent(event)};AssetLoader.prototype.addEventListeners=function(loader){loader.addEventListener(away.events.LoaderEvent.DEPENDENCY_COMPLETE,this.onRetrievalComplete,this);loader.addEventListener(away.events.LoaderEvent.LOAD_ERROR,this.onRetrievalFailed,this);loader.addEventListener(away.events.AssetEvent.TEXTURE_SIZE_ERROR,this.onTextureSizeError,this);loader.addEventListener(away.events.AssetEvent.ASSET_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_SET_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_STATE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ANIMATION_NODE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.STATE_TRANSITION_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.TEXTURE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.CONTAINER_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.GEOMETRY_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.MATERIAL_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.MESH_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.ENTITY_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.SKELETON_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.AssetEvent.SKELETON_POSE_COMPLETE,this.onAssetComplete,this);loader.addEventListener(away.events.ParserEvent.READY_FOR_DEPENDENCIES,this.onReadyForDependencies,this);loader.addEventListener(away.events.ParserEvent.PARSE_ERROR,this.onParserError,this)};AssetLoader.prototype.removeEventListeners=function(loader){loader.removeEventListener(away.events.ParserEvent.READY_FOR_DEPENDENCIES,this.onReadyForDependencies,this);loader.removeEventListener(away.events.LoaderEvent.DEPENDENCY_COMPLETE,this.onRetrievalComplete,this);loader.removeEventListener(away.events.LoaderEvent.LOAD_ERROR,this.onRetrievalFailed,this);loader.removeEventListener(away.events.AssetEvent.TEXTURE_SIZE_ERROR,this.onTextureSizeError,this);loader.removeEventListener(away.events.AssetEvent.ASSET_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.ANIMATION_SET_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.ANIMATION_STATE_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.ANIMATION_NODE_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.STATE_TRANSITION_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.TEXTURE_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.CONTAINER_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.GEOMETRY_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.MATERIAL_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.MESH_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.ENTITY_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.SKELETON_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.AssetEvent.SKELETON_POSE_COMPLETE,this.onAssetComplete,this);loader.removeEventListener(away.events.ParserEvent.PARSE_ERROR,this.onParserError,this)};AssetLoader.prototype.stop=function(){this.dispose()};AssetLoader.prototype.dispose=function(){this._errorHandlers=null;this._parseErrorHandlers=null;this._context=null;this._token=null;this._stack=null;if(this._loadingDependency&&this._loadingDependency._iLoader){this.removeEventListeners(this._loadingDependency._iLoader)}this._loadingDependency=null};AssetLoader.prototype._iAddParseErrorHandler=function(handler){if(this._parseErrorHandlers.indexOf(handler)<0){this._parseErrorHandlers.push(handler)}};AssetLoader.prototype._iAddErrorHandler=function(handler){if(this._errorHandlers.indexOf(handler)<0){this._errorHandlers.push(handler)}};return AssetLoader})(away.events.EventDispatcher);loaders.AssetLoader=AssetLoader})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(library){var ConflictStrategy=(function(){function ConflictStrategy(){}ConflictStrategy.APPEND_NUM_SUFFIX=new away.library.NumSuffixConflictStrategy();ConflictStrategy.IGNORE=new away.library.IgnoreConflictStrategy();ConflictStrategy.THROW_ERROR=new away.library.ErrorConflictStrategy();return ConflictStrategy})();library.ConflictStrategy=ConflictStrategy})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(net){var URLRequest=(function(){function URLRequest(url){if(typeof url==="undefined"){url=null}this.method=away.net.URLRequestMethod.GET;this.async=true;this._url=url}Object.defineProperty(URLRequest.prototype,"url",{get:function(){return this._url},set:function(value){this._url=value},enumerable:true,configurable:true});URLRequest.prototype.dispose=function(){this.data=null;this._url=null;this.method=null;this.async=null};return URLRequest})();net.URLRequest=URLRequest})(away.net||(away.net={}));var net=away.net})(away||(away={}));var away;(function(away){(function(loaders){var AssetLoaderToken=(function(_super){__extends(AssetLoaderToken,_super);function AssetLoaderToken(loader){_super.call(this);this._iLoader=loader}AssetLoaderToken.prototype.addEventListener=function(type,listener,target){this._iLoader.addEventListener(type,listener,target)};AssetLoaderToken.prototype.removeEventListener=function(type,listener,target){this._iLoader.removeEventListener(type,listener,target)};AssetLoaderToken.prototype.hasEventListener=function(type,listener,target){if(typeof listener==="undefined"){listener=null}if(typeof target==="undefined"){target=null}return this._iLoader.hasEventListener(type,listener,target)};return AssetLoaderToken})(away.events.EventDispatcher);loaders.AssetLoaderToken=AssetLoaderToken})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(loaders){var ParserBase=(function(_super){__extends(ParserBase,_super);function ParserBase(format,loaderType){if(typeof loaderType==="undefined"){loaderType=null}_super.call(this);this._loaderType=away.loaders.ParserLoaderType.URL_LOADER;if(loaderType){this._loaderType=loaderType}this._materialMode=0;this._dataFormat=format;this._dependencies=new Array()}ParserBase.supportsType=function(extension){throw new away.errors.AbstractMethodError();return false};ParserBase.prototype.isBitmapDataValid=function(bitmapData){var isValid=away.utils.TextureUtils.isBitmapDataValid(bitmapData);if(!isValid){console.log(">> Bitmap loaded is not having power of 2 dimensions or is higher than 2048")}return isValid};Object.defineProperty(ParserBase.prototype,"parsingFailure",{get:function(){return this._parsingFailure},set:function(b){this._parsingFailure=b},enumerable:true,configurable:true});Object.defineProperty(ParserBase.prototype,"parsingPaused",{get:function(){return this._parsingPaused},enumerable:true,configurable:true});Object.defineProperty(ParserBase.prototype,"parsingComplete",{get:function(){return this._parsingComplete},enumerable:true,configurable:true});Object.defineProperty(ParserBase.prototype,"materialMode",{get:function(){return this._materialMode},set:function(newMaterialMode){this._materialMode=newMaterialMode},enumerable:true,configurable:true});Object.defineProperty(ParserBase.prototype,"loaderType",{get:function(){return this._loaderType},set:function(value){this._loaderType=value},enumerable:true,configurable:true});Object.defineProperty(ParserBase.prototype,"data",{get:function(){return this._data},enumerable:true,configurable:true});Object.defineProperty(ParserBase.prototype,"dataFormat",{get:function(){return this._dataFormat},enumerable:true,configurable:true});ParserBase.prototype.parseAsync=function(data,frameLimit){if(typeof frameLimit==="undefined"){frameLimit=30}this._data=data;this.startParsing(frameLimit)};Object.defineProperty(ParserBase.prototype,"dependencies",{get:function(){return this._dependencies},enumerable:true,configurable:true});ParserBase.prototype._iResolveDependency=function(resourceDependency){throw new away.errors.AbstractMethodError()};ParserBase.prototype._iResolveDependencyFailure=function(resourceDependency){throw new away.errors.AbstractMethodError()};ParserBase.prototype._iResolveDependencyName=function(resourceDependency,asset){return asset.name};ParserBase.prototype._iResumeParsingAfterDependencies=function(){this._parsingPaused=false;if(this._timer){this._timer.start()}};ParserBase.prototype._pFinalizeAsset=function(asset,name){if(typeof name==="undefined"){name=null}var type_event;var type_name;if(name!=null){asset.name=name}switch(asset.assetType){case away.library.AssetType.LIGHT_PICKER:type_name="lightPicker";type_event=away.events.AssetEvent.LIGHTPICKER_COMPLETE;break;case away.library.AssetType.LIGHT:type_name="light";type_event=away.events.AssetEvent.LIGHT_COMPLETE;break;case away.library.AssetType.ANIMATOR:type_name="animator";type_event=away.events.AssetEvent.ANIMATOR_COMPLETE;break;case away.library.AssetType.ANIMATION_SET:type_name="animationSet";type_event=away.events.AssetEvent.ANIMATION_SET_COMPLETE;break;case away.library.AssetType.ANIMATION_STATE:type_name="animationState";type_event=away.events.AssetEvent.ANIMATION_STATE_COMPLETE;break;case away.library.AssetType.ANIMATION_NODE:type_name="animationNode";type_event=away.events.AssetEvent.ANIMATION_NODE_COMPLETE;break;case away.library.AssetType.STATE_TRANSITION:type_name="stateTransition";type_event=away.events.AssetEvent.STATE_TRANSITION_COMPLETE;break;case away.library.AssetType.TEXTURE:type_name="texture";type_event=away.events.AssetEvent.TEXTURE_COMPLETE;break;case away.library.AssetType.TEXTURE_PROJECTOR:type_name="textureProjector";type_event=away.events.AssetEvent.TEXTURE_PROJECTOR_COMPLETE;break;case away.library.AssetType.CONTAINER:type_name="container";type_event=away.events.AssetEvent.CONTAINER_COMPLETE;break;case away.library.AssetType.GEOMETRY:type_name="geometry";type_event=away.events.AssetEvent.GEOMETRY_COMPLETE;break;case away.library.AssetType.MATERIAL:type_name="material";type_event=away.events.AssetEvent.MATERIAL_COMPLETE;break;case away.library.AssetType.MESH:type_name="mesh";type_event=away.events.AssetEvent.MESH_COMPLETE;break;case away.library.AssetType.SKELETON:type_name="skeleton";type_event=away.events.AssetEvent.SKELETON_COMPLETE;break;case away.library.AssetType.SKELETON_POSE:type_name="skelpose";type_event=away.events.AssetEvent.SKELETON_POSE_COMPLETE;break;case away.library.AssetType.ENTITY:type_name="entity";type_event=away.events.AssetEvent.ENTITY_COMPLETE;break;case away.library.AssetType.SKYBOX:type_name="skybox";type_event=away.events.AssetEvent.SKYBOX_COMPLETE;break;case away.library.AssetType.CAMERA:type_name="camera";type_event=away.events.AssetEvent.CAMERA_COMPLETE;break;case away.library.AssetType.SEGMENT_SET:type_name="segmentSet";type_event=away.events.AssetEvent.SEGMENT_SET_COMPLETE;break;case away.library.AssetType.EFFECTS_METHOD:type_name="effectsMethod";type_event=away.events.AssetEvent.EFFECTMETHOD_COMPLETE;break;case away.library.AssetType.SHADOW_MAP_METHOD:type_name="effectsMethod";type_event=away.events.AssetEvent.SHADOWMAPMETHOD_COMPLETE;break;default:throw new away.errors.Error("Unhandled asset type "+asset.assetType+". Report as bug!");break}if(!asset.name){asset.name=type_name}this.dispatchEvent(new away.events.AssetEvent(away.events.AssetEvent.ASSET_COMPLETE,asset));this.dispatchEvent(new away.events.AssetEvent(type_event,asset))};ParserBase.prototype._pProceedParsing=function(){throw new away.errors.AbstractMethodError();return true};ParserBase.prototype._pDieWithError=function(message){if(typeof message==="undefined"){message="Unknown parsing error"}if(this._timer){this._timer.removeEventListener(away.events.TimerEvent.TIMER,this._pOnInterval,this);this._timer.stop();this._timer=null}this.dispatchEvent(new away.events.ParserEvent(away.events.ParserEvent.PARSE_ERROR,message))};ParserBase.prototype._pAddDependency=function(id,req,retrieveAsRawData,data,suppressErrorEvents){if(typeof retrieveAsRawData==="undefined"){retrieveAsRawData=false}if(typeof data==="undefined"){data=null}if(typeof suppressErrorEvents==="undefined"){suppressErrorEvents=false}this._dependencies.push(new away.loaders.ResourceDependency(id,req,data,this,retrieveAsRawData,suppressErrorEvents))};ParserBase.prototype._pPauseAndRetrieveDependencies=function(){if(this._timer){this._timer.stop()}this._parsingPaused=true;this.dispatchEvent(new away.events.ParserEvent(away.events.ParserEvent.READY_FOR_DEPENDENCIES))};ParserBase.prototype._pHasTime=function(){return((away.utils.getTimer()-this._lastFrameTime)<this._frameLimit)};ParserBase.prototype._pOnInterval=function(event){if(typeof event==="undefined"){event=null}this._lastFrameTime=away.utils.getTimer();if(this._pProceedParsing()&&!this._parsingFailure){this._pFinishParsing()}};ParserBase.prototype.startParsing=function(frameLimit){this._frameLimit=frameLimit;this._timer=new away.utils.Timer(this._frameLimit,0);this._timer.addEventListener(away.events.TimerEvent.TIMER,this._pOnInterval,this);this._timer.start()};ParserBase.prototype._pFinishParsing=function(){if(this._timer){this._timer.removeEventListener(away.events.TimerEvent.TIMER,this._pOnInterval,this);this._timer.stop()}this._timer=null;this._parsingComplete=true;this.dispatchEvent(new away.events.ParserEvent(away.events.ParserEvent.PARSE_COMPLETE))};ParserBase.PARSING_DONE=true;ParserBase.MORE_TO_PARSE=false;return ParserBase})(away.events.EventDispatcher);loaders.ParserBase=ParserBase})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(library){var IDUtil=(function(){function IDUtil(){}IDUtil.createUID=function(){var uid=new Array(36);var index=0;var i;var j;for(i=0;i<8;i++){uid[index++]=IDUtil.ALPHA_CHAR_CODES[Math.floor(Math.random()*16)]}for(i=0;i<3;i++){uid[index++]=45;for(j=0;j<4;j++){uid[index++]=IDUtil.ALPHA_CHAR_CODES[Math.floor(Math.random()*16)]}}uid[index++]=45;var time=new Date().getTime();var timeString=("0000000"+time.toString(16).toUpperCase()).substr(-8);for(i=0;i<8;i++){uid[index++]=timeString.charCodeAt(i)}for(i=0;i<4;i++){uid[index++]=IDUtil.ALPHA_CHAR_CODES[Math.floor(Math.random()*16)]}return String.fromCharCode.apply(null,uid)};IDUtil.ALPHA_CHAR_CODES=[48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70];return IDUtil})();library.IDUtil=IDUtil})(away.library||(away.library={}));var library=away.library})(away||(away={}));var away;(function(away){(function(events){var LoaderEvent=(function(_super){__extends(LoaderEvent,_super);function LoaderEvent(type,url,isDependency,errmsg){if(typeof url==="undefined"){url=null}if(typeof isDependency==="undefined"){isDependency=false}if(typeof errmsg==="undefined"){errmsg=null}_super.call(this,type);this._url=url;this._message=errmsg;this._isDependency=isDependency}Object.defineProperty(LoaderEvent.prototype,"url",{get:function(){return this._url},enumerable:true,configurable:true});Object.defineProperty(LoaderEvent.prototype,"message",{get:function(){return this._message},enumerable:true,configurable:true});Object.defineProperty(LoaderEvent.prototype,"isDependency",{get:function(){return this._isDependency},enumerable:true,configurable:true});LoaderEvent.prototype.clone=function(){return new LoaderEvent(this.type,this._url,this._isDependency,this._message)};LoaderEvent.LOAD_ERROR="loadError";LoaderEvent.RESOURCE_COMPLETE="resourceComplete";LoaderEvent.DEPENDENCY_COMPLETE="dependencyComplete";return LoaderEvent})(away.events.Event);events.LoaderEvent=LoaderEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(library){var AssetLibrary=(function(){function AssetLibrary(se){se=se}AssetLibrary.getBundle=function(key){if(typeof key==="undefined"){key="default"}return away.library.AssetLibraryBundle.getInstance(key)};AssetLibrary.enableParser=function(parserClass){away.loaders.SingleFileLoader.enableParser(parserClass)};AssetLibrary.enableParsers=function(parserClasses){away.loaders.SingleFileLoader.enableParsers(parserClasses)};Object.defineProperty(AssetLibrary,"conflictStrategy",{get:function(){return away.library.AssetLibrary.getBundle().conflictStrategy},set:function(val){away.library.AssetLibrary.getBundle().conflictStrategy=val},enumerable:true,configurable:true});Object.defineProperty(AssetLibrary,"conflictPrecedence",{get:function(){return away.library.AssetLibrary.getBundle().conflictPrecedence},set:function(val){away.library.AssetLibrary.getBundle().conflictPrecedence=val},enumerable:true,configurable:true});AssetLibrary.createIterator=function(assetTypeFilter,namespaceFilter,filterFunc){if(typeof assetTypeFilter==="undefined"){assetTypeFilter=null}if(typeof namespaceFilter==="undefined"){namespaceFilter=null}if(typeof filterFunc==="undefined"){filterFunc=null}return away.library.AssetLibrary.getBundle().createIterator(assetTypeFilter,namespaceFilter,filterFunc)};AssetLibrary.load=function(req,context,ns,parser){if(typeof context==="undefined"){context=null}if(typeof ns==="undefined"){ns=null}if(typeof parser==="undefined"){parser=null}return away.library.AssetLibrary.getBundle().load(req,context,ns,parser)};AssetLibrary.loadData=function(data,context,ns,parser){if(typeof context==="undefined"){context=null}if(typeof ns==="undefined"){ns=null}if(typeof parser==="undefined"){parser=null}return away.library.AssetLibrary.getBundle().loadData(data,context,ns,parser)};AssetLibrary.stopLoad=function(){away.library.AssetLibrary.getBundle().stopAllLoadingSessions()};AssetLibrary.getAsset=function(name,ns){if(typeof ns==="undefined"){ns=null}return away.library.AssetLibrary.getBundle().getAsset(name,ns)};AssetLibrary.addEventListener=function(type,listener,target){away.library.AssetLibrary.getBundle().addEventListener(type,listener,target)};AssetLibrary.removeEventListener=function(type,listener,target){away.library.AssetLibrary.getBundle().removeEventListener(type,listener,target)};AssetLibrary.addAsset=function(asset){away.library.AssetLibrary.getBundle().addAsset(asset)};AssetLibrary.removeAsset=function(asset,dispose){if(typeof dispose==="undefined"){dispose=true}away.library.AssetLibrary.getBundle().removeAsset(asset,dispose)};AssetLibrary.removeAssetByName=function(name,ns,dispose){if(typeof ns==="undefined"){ns=null}if(typeof dispose==="undefined"){dispose=true}return away.library.AssetLibrary.getBundle().removeAssetByName(name,ns,dispose)};AssetLibrary.removeAllAssets=function(dispose){if(typeof dispose==="undefined"){dispose=true}away.library.AssetLibrary.getBundle().removeAllAssets(dispose)};AssetLibrary.removeNamespaceAssets=function(ns,dispose){if(typeof ns==="undefined"){ns=null}if(typeof dispose==="undefined"){dispose=true}away.library.AssetLibrary.getBundle().removeNamespaceAssets(ns,dispose)};AssetLibrary._iInstances={};return AssetLibrary})();library.AssetLibrary=AssetLibrary})(away.library||(away.library={}));var library=away.library})(away||(away={}));var AssetLibrarySingletonEnforcer=(function(){function AssetLibrarySingletonEnforcer(){}return AssetLibrarySingletonEnforcer})();var away;(function(away){(function(net){var IMGLoader=(function(_super){__extends(IMGLoader,_super);function IMGLoader(imageName){if(typeof imageName==="undefined"){imageName=""}_super.call(this);this._name="";this._loaded=false;this._name=imageName;this.initImage()}IMGLoader.prototype.load=function(request){this._loaded=false;this._request=request;if(this._crossOrigin){if(this._image.crossOrigin!=null){this._image.crossOrigin=this._crossOrigin}}this._image.src=this._request.url};IMGLoader.prototype.dispose=function(){if(this._image){this._image.onabort=null;this._image.onerror=null;this._image.onload=null;this._image=null}if(this._request){this._request=null}};Object.defineProperty(IMGLoader.prototype,"image",{get:function(){return this._image},enumerable:true,configurable:true});Object.defineProperty(IMGLoader.prototype,"loaded",{get:function(){return this._loaded},enumerable:true,configurable:true});Object.defineProperty(IMGLoader.prototype,"crossOrigin",{get:function(){return this._crossOrigin},set:function(value){this._crossOrigin=value},enumerable:true,configurable:true});Object.defineProperty(IMGLoader.prototype,"width",{get:function(){if(this._image){return this._image.width}return null},enumerable:true,configurable:true});Object.defineProperty(IMGLoader.prototype,"height",{get:function(){if(this._image){return this._image.height}return null},enumerable:true,configurable:true});Object.defineProperty(IMGLoader.prototype,"request",{get:function(){return this._request},enumerable:true,configurable:true});Object.defineProperty(IMGLoader.prototype,"name",{get:function(){if(this._image){return this._image.name}return this._name},set:function(value){if(this._image){this._image.name=value}this._name=value},enumerable:true,configurable:true});IMGLoader.prototype.initImage=function(){var _this=this;if(!this._image){this._image=new Image();this._image.onabort=function(event){return _this.onAbort(event)};this._image.onerror=function(event){return _this.onError(event)};this._image.onload=function(event){return _this.onLoadComplete(event)};this._image.name=this._name}};IMGLoader.prototype.onAbort=function(event){this.dispatchEvent(new away.events.Event(away.events.IOErrorEvent.IO_ERROR))};IMGLoader.prototype.onError=function(event){this.dispatchEvent(new away.events.Event(away.events.IOErrorEvent.IO_ERROR))};IMGLoader.prototype.onLoadComplete=function(event){this._loaded=true;this.dispatchEvent(new away.events.Event(away.events.Event.COMPLETE))};return IMGLoader})(away.events.EventDispatcher);net.IMGLoader=IMGLoader})(away.net||(away.net={}));var net=away.net})(away||(away={}));var away;(function(away){(function(events){var IOErrorEvent=(function(_super){__extends(IOErrorEvent,_super);function IOErrorEvent(type){_super.call(this,type)}IOErrorEvent.IO_ERROR="IOErrorEvent_IO_ERROR";return IOErrorEvent})(away.events.Event);events.IOErrorEvent=IOErrorEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(events){var HTTPStatusEvent=(function(_super){__extends(HTTPStatusEvent,_super);function HTTPStatusEvent(type,status){if(typeof status==="undefined"){status=null}_super.call(this,type);this.status=status}HTTPStatusEvent.HTTP_STATUS="HTTPStatusEvent_HTTP_STATUS";return HTTPStatusEvent})(away.events.Event);events.HTTPStatusEvent=HTTPStatusEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(events){var ProgressEvent=(function(_super){__extends(ProgressEvent,_super);function ProgressEvent(type){_super.call(this,type)}ProgressEvent.PROGRESS="ProgressEvent_progress";return ProgressEvent})(away.events.Event);events.ProgressEvent=ProgressEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(net){var URLLoaderDataFormat=(function(){function URLLoaderDataFormat(){}URLLoaderDataFormat.TEXT="text";URLLoaderDataFormat.VARIABLES="variables";URLLoaderDataFormat.BLOB="blob";URLLoaderDataFormat.ARRAY_BUFFER="arraybuffer";URLLoaderDataFormat.BINARY="binary";return URLLoaderDataFormat})();net.URLLoaderDataFormat=URLLoaderDataFormat})(away.net||(away.net={}));var net=away.net})(away||(away={}));var away;(function(away){(function(net){var URLRequestMethod=(function(){function URLRequestMethod(){}URLRequestMethod.POST="POST";URLRequestMethod.GET="GET";return URLRequestMethod})();net.URLRequestMethod=URLRequestMethod})(away.net||(away.net={}));var net=away.net})(away||(away={}));var away;(function(away){(function(net){var URLLoader=(function(_super){__extends(URLLoader,_super);function URLLoader(){_super.call(this);this._bytesLoaded=0;this._bytesTotal=0;this._dataFormat=away.net.URLLoaderDataFormat.TEXT;this._loadError=false}URLLoader.prototype.load=function(request){this.initXHR();this._request=request;if(request.method===away.net.URLRequestMethod.POST){this.postRequest(request)}else{this.getRequest(request)}};URLLoader.prototype.close=function(){this._XHR.abort();this.disposeXHR()};URLLoader.prototype.dispose=function(){if(this._XHR){this._XHR.abort()}this.disposeXHR();this._data=null;this._dataFormat=null;this._bytesLoaded=null;this._bytesTotal=null;this._request=null};Object.defineProperty(URLLoader.prototype,"dataFormat",{get:function(){return this._dataFormat},set:function(format){if(format===away.net.URLLoaderDataFormat.BLOB||format===away.net.URLLoaderDataFormat.ARRAY_BUFFER||format===away.net.URLLoaderDataFormat.BINARY||format===away.net.URLLoaderDataFormat.TEXT||format===away.net.URLLoaderDataFormat.VARIABLES){this._dataFormat=format}else{throw new away.errors.Error("URLLoader error: incompatible dataFormat")}},enumerable:true,configurable:true});Object.defineProperty(URLLoader.prototype,"data",{get:function(){return this._data},enumerable:true,configurable:true});Object.defineProperty(URLLoader.prototype,"bytesLoaded",{get:function(){return this._bytesLoaded},enumerable:true,configurable:true});Object.defineProperty(URLLoader.prototype,"bytesTotal",{get:function(){return this._bytesTotal},enumerable:true,configurable:true});Object.defineProperty(URLLoader.prototype,"request",{get:function(){return this._request},enumerable:true,configurable:true});URLLoader.prototype.setResponseType=function(xhr,responseType){switch(responseType){case away.net.URLLoaderDataFormat.ARRAY_BUFFER:case away.net.URLLoaderDataFormat.BLOB:case away.net.URLLoaderDataFormat.TEXT:xhr.responseType=responseType;break;case away.net.URLLoaderDataFormat.VARIABLES:xhr.responseType=away.net.URLLoaderDataFormat.TEXT;break;case away.net.URLLoaderDataFormat.BINARY:xhr.responseType="";break}};URLLoader.prototype.getRequest=function(request){try{this._XHR.open(request.method,request.url,request.async);this.setResponseType(this._XHR,this._dataFormat);this._XHR.send()}catch(e){this.handleXmlHttpRequestException(e)}};URLLoader.prototype.postRequest=function(request){this._loadError=false;this._XHR.open(request.method,request.url,request.async);if(request.data!=null){if(request.data instanceof away.net.URLVariables){var urlVars=request.data;try{this._XHR.responseType="text";this._XHR.send(urlVars.formData)}catch(e){this.handleXmlHttpRequestException(e)}}else{this.setResponseType(this._XHR,this._dataFormat);if(request.data){this._XHR.send(request.data)}else{this._XHR.send()}}}else{this._XHR.send()}};URLLoader.prototype.handleXmlHttpRequestException=function(error){switch(error.code){case 101:break}};URLLoader.prototype.initXHR=function(){var _this=this;if(!this._XHR){this._XHR=new XMLHttpRequest();this._XHR.onloadstart=function(event){return _this.onLoadStart(event)};this._XHR.onprogress=function(event){return _this.onProgress(event)};this._XHR.onabort=function(event){return _this.onAbort(event)};this._XHR.onerror=function(event){return _this.onLoadError(event)};this._XHR.onload=function(event){return _this.onLoadComplete(event)};this._XHR.ontimeout=function(event){return _this.onTimeOut(event)};this._XHR.onloadend=function(event){return _this.onLoadEnd(event)};this._XHR.onreadystatechange=function(event){return _this.onReadyStateChange(event)}}};URLLoader.prototype.disposeXHR=function(){if(this._XHR!==null){this._XHR.onloadstart=null;this._XHR.onprogress=null;this._XHR.onabort=null;this._XHR.onerror=null;this._XHR.onload=null;this._XHR.ontimeout=null;this._XHR.onloadend=null;this._XHR=null}};URLLoader.prototype.decodeURLVariables=function(source){var result=new Object();source=source.split("+").join(" ");var tokens,re=/[?&]?([^=]+)=([^&]*)/g;while(tokens=re.exec(source)){result[decodeURIComponent(tokens[1])]=decodeURIComponent(tokens[2])}return result};URLLoader.prototype.onReadyStateChange=function(event){if(this._XHR.readyState==4){if(this._XHR.status==404){this._loadError=true;this.dispatchEvent(new away.events.IOErrorEvent(away.events.IOErrorEvent.IO_ERROR))}this.dispatchEvent(new away.events.HTTPStatusEvent(away.events.HTTPStatusEvent.HTTP_STATUS,this._XHR.status))}};URLLoader.prototype.onLoadEnd=function(event){if(this._loadError===true){return}};URLLoader.prototype.onTimeOut=function(event){};URLLoader.prototype.onAbort=function(event){};URLLoader.prototype.onProgress=function(event){this._bytesTotal=event.total;this._bytesLoaded=event.loaded;var progressEvent=new away.events.ProgressEvent(away.events.ProgressEvent.PROGRESS);progressEvent.bytesLoaded=this._bytesLoaded;progressEvent.bytesTotal=this._bytesTotal;this.dispatchEvent(progressEvent)};URLLoader.prototype.onLoadStart=function(event){this.dispatchEvent(new away.events.Event(away.events.Event.OPEN))};URLLoader.prototype.onLoadComplete=function(event){if(this._loadError===true){return}switch(this._dataFormat){case away.net.URLLoaderDataFormat.TEXT:this._data=this._XHR.responseText;break;case away.net.URLLoaderDataFormat.VARIABLES:this._data=this.decodeURLVariables(this._XHR.responseText);break;case away.net.URLLoaderDataFormat.BLOB:case away.net.URLLoaderDataFormat.ARRAY_BUFFER:case away.net.URLLoaderDataFormat.BINARY:this._data=this._XHR.response;break;default:this._data=this._XHR.responseText;break}this.dispatchEvent(new away.events.Event(away.events.Event.COMPLETE))};URLLoader.prototype.onLoadError=function(event){this._loadError=true;this.dispatchEvent(new away.events.IOErrorEvent(away.events.IOErrorEvent.IO_ERROR))};return URLLoader})(away.events.EventDispatcher);net.URLLoader=URLLoader})(away.net||(away.net={}));var net=away.net})(away||(away={}));var away;(function(away){(function(loaders){var ParserDataFormat=(function(){function ParserDataFormat(){}ParserDataFormat.BINARY="binary";ParserDataFormat.PLAIN_TEXT="plainText";ParserDataFormat.IMAGE="image";return ParserDataFormat})();loaders.ParserDataFormat=ParserDataFormat})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(loaders){var ImageParser=(function(_super){__extends(ImageParser,_super);function ImageParser(){_super.call(this,away.loaders.ParserDataFormat.IMAGE,away.loaders.ParserLoaderType.IMG_LOADER)}ImageParser.supportsType=function(extension){extension=extension.toLowerCase();return extension=="jpg"||extension=="jpeg"||extension=="png"||extension=="gif"};ImageParser.supportsData=function(data){if(data instanceof HTMLImageElement){return true}return false};ImageParser.prototype._pProceedParsing=function(){var asset;if(this.data instanceof HTMLImageElement){asset=new away.textures.HTMLImageElementTexture(this.data);if(away.utils.TextureUtils.isHTMLImageElementValid(this.data)){this._pFinalizeAsset(asset,this._iFileName)}else{this.dispatchEvent(new away.events.AssetEvent(away.events.AssetEvent.TEXTURE_SIZE_ERROR,asset))}return away.loaders.ParserBase.PARSING_DONE}return away.loaders.ParserBase.PARSING_DONE};return ImageParser})(away.loaders.ParserBase);loaders.ImageParser=ImageParser})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(loaders){var SingleFileLoader=(function(_super){__extends(SingleFileLoader,_super);function SingleFileLoader(materialMode){if(typeof materialMode==="undefined"){materialMode=0}_super.call(this);this._materialMode=materialMode}SingleFileLoader.enableParser=function(parser){if(SingleFileLoader._parsers.indexOf(parser)<0){SingleFileLoader._parsers.push(parser)}};SingleFileLoader.enableParsers=function(parsers){var pc;for(var c=0;c<parsers.length;c++){SingleFileLoader.enableParser(parsers[c])}};Object.defineProperty(SingleFileLoader.prototype,"url",{get:function(){return this._req?this._req.url:""},enumerable:true,configurable:true});Object.defineProperty(SingleFileLoader.prototype,"data",{get:function(){return this._data},enumerable:true,configurable:true});Object.defineProperty(SingleFileLoader.prototype,"loadAsRawData",{get:function(){return this._loadAsRawData},enumerable:true,configurable:true});SingleFileLoader.prototype.load=function(urlRequest,parser,loadAsRawData){if(typeof parser==="undefined"){parser=null}if(typeof loadAsRawData==="undefined"){loadAsRawData=false}var dataFormat;var loaderType=away.loaders.ParserLoaderType.URL_LOADER;this._loadAsRawData=loadAsRawData;this._req=urlRequest;this.decomposeFilename(this._req.url);if(this._loadAsRawData){dataFormat=away.net.URLLoaderDataFormat.BINARY}else{if(parser){this._parser=parser}if(!this._parser){this._parser=this.getParserFromSuffix()}if(this._parser){switch(this._parser.dataFormat){case away.loaders.ParserDataFormat.BINARY:dataFormat=away.net.URLLoaderDataFormat.BINARY;break;case away.loaders.ParserDataFormat.PLAIN_TEXT:dataFormat=away.net.URLLoaderDataFormat.TEXT;break}switch(this._parser.loaderType){case away.loaders.ParserLoaderType.IMG_LOADER:loaderType=away.loaders.ParserLoaderType.IMG_LOADER;break;case away.loaders.ParserLoaderType.URL_LOADER:loaderType=away.loaders.ParserLoaderType.URL_LOADER;break}}else{dataFormat=away.net.URLLoaderDataFormat.BINARY}}var loader=this.getLoader(loaderType);loader.dataFormat=dataFormat;loader.addEventListener(away.events.Event.COMPLETE,this.handleUrlLoaderComplete,this);loader.addEventListener(away.events.IOErrorEvent.IO_ERROR,this.handleUrlLoaderError,this);loader.load(urlRequest)};SingleFileLoader.prototype.parseData=function(data,parser,req){if(typeof parser==="undefined"){parser=null}if(typeof req==="undefined"){req=null}if(data.constructor===Function){data=new data()}if(parser){this._parser=parser}this._req=req;this.parse(data)};Object.defineProperty(SingleFileLoader.prototype,"parser",{get:function(){return this._parser},enumerable:true,configurable:true});Object.defineProperty(SingleFileLoader.prototype,"dependencies",{get:function(){return this._parser?this._parser.dependencies:new Array()},enumerable:true,configurable:true});SingleFileLoader.prototype.getLoader=function(loaderType){var loader;switch(loaderType){case away.loaders.ParserLoaderType.IMG_LOADER:loader=new away.loaders.SingleFileImageLoader();break;case away.loaders.ParserLoaderType.URL_LOADER:loader=new away.loaders.SingleFileURLLoader();break}return loader};SingleFileLoader.prototype.decomposeFilename=function(url){var base=(url.indexOf("?")>0)?url.split("?")[0]:url;var i=base.lastIndexOf(".");this._fileExtension=base.substr(i+1).toLowerCase();this._fileName=base.substr(0,i)};SingleFileLoader.prototype.getParserFromSuffix=function(){var len=SingleFileLoader._parsers.length;for(var i=len-1;i>=0;i--){var currentParser=SingleFileLoader._parsers[i];var supportstype=SingleFileLoader._parsers[i].supportsType(this._fileExtension);if(SingleFileLoader._parsers[i]["supportsType"](this._fileExtension)){return new SingleFileLoader._parsers[i]()}}return null};SingleFileLoader.prototype.getParserFromData=function(data){var len=SingleFileLoader._parsers.length;for(var i=len-1;i>=0;i--){if(SingleFileLoader._parsers[i].supportsData(data)){return new SingleFileLoader._parsers[i]()}}return null};SingleFileLoader.prototype.removeListeners=function(urlLoader){urlLoader.removeEventListener(away.events.Event.COMPLETE,this.handleUrlLoaderComplete,this);urlLoader.removeEventListener(away.events.IOErrorEvent.IO_ERROR,this.handleUrlLoaderError,this)};SingleFileLoader.prototype.handleUrlLoaderError=function(event){var urlLoader=event.target;this.removeListeners(urlLoader);this.dispatchEvent(new away.events.LoaderEvent(away.events.LoaderEvent.LOAD_ERROR,this._req.url,true))};SingleFileLoader.prototype.handleUrlLoaderComplete=function(event){var urlLoader=event.target;this.removeListeners(urlLoader);this._data=urlLoader.data;if(this._loadAsRawData){this.dispatchEvent(new away.events.LoaderEvent(away.events.LoaderEvent.DEPENDENCY_COMPLETE))}else{this.parse(this._data)}};SingleFileLoader.prototype.parse=function(data){if(!this._parser){this._parser=this.getParserFromData(data)}if(this._parser){this._parser.addEventListener(away.events.ParserEvent.READY_FOR_DEPENDENCIES,this.onReadyForDependencies,this);this._parser.addEventListener(away.events.ParserEvent.PARSE_ERROR,this.onParseError,this);this._parser.addEventListener(away.events.ParserEvent.PARSE_COMPLETE,this.onParseComplete,this);this._parser.addEventListener(away.events.AssetEvent.TEXTURE_SIZE_ERROR,this.onTextureSizeError,this);this._parser.addEventListener(away.events.AssetEvent.ASSET_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.ANIMATION_SET_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.ANIMATION_STATE_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.ANIMATION_NODE_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.STATE_TRANSITION_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.TEXTURE_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.CONTAINER_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.GEOMETRY_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.MATERIAL_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.MESH_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.ENTITY_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.SKELETON_COMPLETE,this.onAssetComplete,this);this._parser.addEventListener(away.events.AssetEvent.SKELETON_POSE_COMPLETE,this.onAssetComplete,this);if(this._req&&this._req.url){this._parser._iFileName=this._req.url}this._parser.materialMode=this._materialMode;this._parser.parseAsync(data)}else{var msg="No parser defined. To enable all parsers for auto-detection, use Parsers.enableAllBundled()";this.dispatchEvent(new away.events.LoaderEvent(away.events.LoaderEvent.LOAD_ERROR,"",true,msg))}};SingleFileLoader.prototype.onParseError=function(event){this.dispatchEvent(event.clone())};SingleFileLoader.prototype.onReadyForDependencies=function(event){this.dispatchEvent(event.clone())};SingleFileLoader.prototype.onAssetComplete=function(event){this.dispatchEvent(event.clone())};SingleFileLoader.prototype.onTextureSizeError=function(event){this.dispatchEvent(event.clone())};SingleFileLoader.prototype.onParseComplete=function(event){this.dispatchEvent(new away.events.LoaderEvent(away.events.LoaderEvent.DEPENDENCY_COMPLETE,this.url));this._parser.removeEventListener(away.events.ParserEvent.READY_FOR_DEPENDENCIES,this.onReadyForDependencies,this);this._parser.removeEventListener(away.events.ParserEvent.PARSE_COMPLETE,this.onParseComplete,this);this._parser.removeEventListener(away.events.ParserEvent.PARSE_ERROR,this.onParseError,this);this._parser.removeEventListener(away.events.AssetEvent.TEXTURE_SIZE_ERROR,this.onTextureSizeError,this);this._parser.removeEventListener(away.events.AssetEvent.ASSET_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.ANIMATION_SET_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.ANIMATION_STATE_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.ANIMATION_NODE_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.STATE_TRANSITION_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.TEXTURE_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.CONTAINER_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.GEOMETRY_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.MATERIAL_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.MESH_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.ENTITY_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.SKELETON_COMPLETE,this.onAssetComplete,this);this._parser.removeEventListener(away.events.AssetEvent.SKELETON_POSE_COMPLETE,this.onAssetComplete,this)};SingleFileLoader._parsers=new Array(away.loaders.ImageParser);return SingleFileLoader})(away.events.EventDispatcher);loaders.SingleFileLoader=SingleFileLoader})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(loaders){var SingleFileImageLoader=(function(_super){__extends(SingleFileImageLoader,_super);function SingleFileImageLoader(){_super.call(this);this.initLoader()}SingleFileImageLoader.prototype.load=function(req){this._loader.load(req)};SingleFileImageLoader.prototype.dispose=function(){this.disposeLoader();this._data=null};Object.defineProperty(SingleFileImageLoader.prototype,"data",{get:function(){return this._loader.image},enumerable:true,configurable:true});Object.defineProperty(SingleFileImageLoader.prototype,"dataFormat",{get:function(){return this._dataFormat},set:function(value){this._dataFormat=value},enumerable:true,configurable:true});SingleFileImageLoader.prototype.initLoader=function(){if(!this._loader){this._loader=new away.net.IMGLoader();this._loader.addEventListener(away.events.Event.COMPLETE,this.onLoadComplete,this);this._loader.addEventListener(away.events.IOErrorEvent.IO_ERROR,this.onLoadError,this)}};SingleFileImageLoader.prototype.disposeLoader=function(){if(this._loader){this._loader.dispose();this._loader.removeEventListener(away.events.Event.COMPLETE,this.onLoadComplete,this);this._loader.removeEventListener(away.events.IOErrorEvent.IO_ERROR,this.onLoadError,this);this._loader=null}};SingleFileImageLoader.prototype.onLoadComplete=function(event){this.dispatchEvent(event)};SingleFileImageLoader.prototype.onLoadError=function(event){this.dispatchEvent(event)};return SingleFileImageLoader})(away.events.EventDispatcher);loaders.SingleFileImageLoader=SingleFileImageLoader})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(loaders){var SingleFileURLLoader=(function(_super){__extends(SingleFileURLLoader,_super);function SingleFileURLLoader(){_super.call(this);this.initLoader()}SingleFileURLLoader.prototype.load=function(req){this._loader.load(req)};SingleFileURLLoader.prototype.dispose=function(){this.disposeLoader();this._data=null};Object.defineProperty(SingleFileURLLoader.prototype,"data",{get:function(){return this._loader.data},enumerable:true,configurable:true});Object.defineProperty(SingleFileURLLoader.prototype,"dataFormat",{get:function(){return this._loader.dataFormat},set:function(value){this._loader.dataFormat=value},enumerable:true,configurable:true});SingleFileURLLoader.prototype.initLoader=function(){if(!this._loader){this._loader=new away.net.URLLoader();this._loader.addEventListener(away.events.Event.COMPLETE,this.onLoadComplete,this);this._loader.addEventListener(away.events.IOErrorEvent.IO_ERROR,this.onLoadError,this)}};SingleFileURLLoader.prototype.disposeLoader=function(){if(this._loader){this._loader.dispose();this._loader.removeEventListener(away.events.Event.COMPLETE,this.onLoadComplete,this);this._loader.removeEventListener(away.events.IOErrorEvent.IO_ERROR,this.onLoadError,this);this._loader=null}};SingleFileURLLoader.prototype.onLoadComplete=function(event){this.dispatchEvent(event)};SingleFileURLLoader.prototype.onLoadError=function(event){this.dispatchEvent(event)};return SingleFileURLLoader})(away.events.EventDispatcher);loaders.SingleFileURLLoader=SingleFileURLLoader})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(loaders){var ParserLoaderType=(function(){function ParserLoaderType(){}ParserLoaderType.URL_LOADER="ParserLoaderType_URLLoader";ParserLoaderType.IMG_LOADER="ParserLoaderType_IMGLoader";return ParserLoaderType})();loaders.ParserLoaderType=ParserLoaderType})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(textures){var TextureProxyBase=(function(_super){__extends(TextureProxyBase,_super);function TextureProxyBase(){_super.call(this);this._format=away.display3D.Context3DTextureFormat.BGRA;this._hasMipmaps=true;this._textures=new Array(8);this._dirty=new Array(8)}Object.defineProperty(TextureProxyBase.prototype,"hasMipMaps",{get:function(){return this._hasMipmaps},enumerable:true,configurable:true});Object.defineProperty(TextureProxyBase.prototype,"format",{get:function(){return this._format},enumerable:true,configurable:true});Object.defineProperty(TextureProxyBase.prototype,"assetType",{get:function(){return away.library.AssetType.TEXTURE},enumerable:true,configurable:true});Object.defineProperty(TextureProxyBase.prototype,"width",{get:function(){return this._pWidth},enumerable:true,configurable:true});Object.defineProperty(TextureProxyBase.prototype,"height",{get:function(){return this._pHeight},enumerable:true,configurable:true});TextureProxyBase.prototype.getTextureForStage3D=function(stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var tex=this._textures[contextIndex];var context=stage3DProxy._iContext3D;if(!tex||this._dirty[contextIndex]!=context){this._textures[contextIndex]=tex=this.pCreateTexture(context);this._dirty[contextIndex]=context;this.pUploadContent(tex)}return tex};TextureProxyBase.prototype.pUploadContent=function(texture){throw new away.errors.AbstractMethodError()};TextureProxyBase.prototype.pSetSize=function(width,height){if(this._pWidth!=width||this._pHeight!=height){this.pInvalidateSize()}this._pWidth=width;this._pHeight=height};TextureProxyBase.prototype.invalidateContent=function(){for(var i=0;i<8;++i){this._dirty[i]=null}};TextureProxyBase.prototype.pInvalidateSize=function(){var tex;for(var i=0;i<8;++i){tex=this._textures[i];if(tex){tex.dispose();this._textures[i]=null;this._dirty[i]=null}}};TextureProxyBase.prototype.pCreateTexture=function(context){throw new away.errors.AbstractMethodError()};TextureProxyBase.prototype.dispose=function(){for(var i=0;i<8;++i){if(this._textures[i]){this._textures[i].dispose()}}};return TextureProxyBase})(away.library.NamedAssetBase);textures.TextureProxyBase=TextureProxyBase})(away.textures||(away.textures={}));var textures=away.textures})(away||(away={}));var away;(function(away){(function(textures){var Texture2DBase=(function(_super){__extends(Texture2DBase,_super);function Texture2DBase(){_super.call(this)}Texture2DBase.prototype.pCreateTexture=function(context){return context.createTexture(this.width,this.height,away.display3D.Context3DTextureFormat.BGRA,false)};return Texture2DBase})(away.textures.TextureProxyBase);textures.Texture2DBase=Texture2DBase})(away.textures||(away.textures={}));var textures=away.textures})(away||(away={}));var away;(function(away){(function(textures){var HTMLImageElementTexture=(function(_super){__extends(HTMLImageElementTexture,_super);function HTMLImageElementTexture(htmlImageElement,generateMipmaps){if(typeof generateMipmaps==="undefined"){generateMipmaps=true}_super.call(this);this._htmlImageElement=htmlImageElement;this._generateMipmaps=generateMipmaps}Object.defineProperty(HTMLImageElementTexture.prototype,"htmlImageElement",{get:function(){return this._htmlImageElement},set:function(value){if(value==this._htmlImageElement){return}if(!away.utils.TextureUtils.isHTMLImageElementValid(value)){throw new away.errors.Error("Invalid bitmapData: Width and height must be power of 2 and cannot exceed 2048")}this.invalidateContent();this.pSetSize(value.width,value.height);this._htmlImageElement=value;if(this._generateMipmaps){this.getMipMapHolder()}},enumerable:true,configurable:true});HTMLImageElementTexture.prototype.pUploadContent=function(texture){if(this._generateMipmaps){away.materials.MipmapGenerator.generateHTMLImageElementMipMaps(this._htmlImageElement,texture,this._mipMapHolder,true)}else{var tx=texture;tx.uploadFromHTMLImageElement(this._htmlImageElement,0)}};HTMLImageElementTexture.prototype.getMipMapHolder=function(){var newW=this._htmlImageElement.width;var newH=this._htmlImageElement.height;if(this._mipMapHolder){if(this._mipMapHolder.width==newW&&this._htmlImageElement.height==newH){return}this.freeMipMapHolder()}if(!HTMLImageElementTexture._mipMaps[newW]){HTMLImageElementTexture._mipMaps[newW]=[];HTMLImageElementTexture._mipMapUses[newW]=[]}if(!HTMLImageElementTexture._mipMaps[newW][newH]){this._mipMapHolder=HTMLImageElementTexture._mipMaps[newW][newH]=new away.display.BitmapData(newW,newH,true);HTMLImageElementTexture._mipMapUses[newW][newH]=1}else{HTMLImageElementTexture._mipMapUses[newW][newH]=HTMLImageElementTexture._mipMapUses[newW][newH]+1;this._mipMapHolder=HTMLImageElementTexture._mipMaps[newW][newH]}};HTMLImageElementTexture.prototype.freeMipMapHolder=function(){var holderWidth=this._mipMapHolder.width;var holderHeight=this._mipMapHolder.height;if(--HTMLImageElementTexture._mipMapUses[holderWidth][holderHeight]==0){HTMLImageElementTexture._mipMaps[holderWidth][holderHeight].dispose();HTMLImageElementTexture._mipMaps[holderWidth][holderHeight]=null}};HTMLImageElementTexture.prototype.dispose=function(){_super.prototype.dispose.call(this);if(this._mipMapHolder){this.freeMipMapHolder()}};HTMLImageElementTexture._mipMaps=[];HTMLImageElementTexture._mipMapUses=[];return HTMLImageElementTexture})(away.textures.Texture2DBase);textures.HTMLImageElementTexture=HTMLImageElementTexture})(away.textures||(away.textures={}));var textures=away.textures})(away||(away={}));var away;(function(away){(function(textures){var BitmapTexture=(function(_super){__extends(BitmapTexture,_super);function BitmapTexture(bitmapData,generateMipmaps){if(typeof generateMipmaps==="undefined"){generateMipmaps=true}_super.call(this);this.bitmapData=bitmapData;this._generateMipmaps=generateMipmaps}Object.defineProperty(BitmapTexture.prototype,"bitmapData",{get:function(){return this._bitmapData},set:function(value){if(value==this._bitmapData){return}if(!away.utils.TextureUtils.isBitmapDataValid(value)){throw new Error("Invalid bitmapData: Width and height must be power of 2 and cannot exceed 2048")}this.invalidateContent();this.pSetSize(value.width,value.height);this._bitmapData=value;if(this._generateMipmaps){this.getMipMapHolder()}},enumerable:true,configurable:true});BitmapTexture.prototype.pUploadContent=function(texture){if(this._generateMipmaps){away.materials.MipmapGenerator.generateMipMaps(this._bitmapData,texture,this._mipMapHolder,true)}else{var tx=texture;tx.uploadFromBitmapData(this._bitmapData,0)}};BitmapTexture.prototype.getMipMapHolder=function(){var newW,newH;newW=this._bitmapData.width;newH=this._bitmapData.height;if(this._mipMapHolder){if(this._mipMapHolder.width==newW&&this._bitmapData.height==newH){return}this.freeMipMapHolder()}if(!BitmapTexture._mipMaps[newW]){BitmapTexture._mipMaps[newW]=[];BitmapTexture._mipMapUses[newW]=[]}if(!BitmapTexture._mipMaps[newW][newH]){this._mipMapHolder=BitmapTexture._mipMaps[newW][newH]=new away.display.BitmapData(newW,newH,true);BitmapTexture._mipMapUses[newW][newH]=1}else{BitmapTexture._mipMapUses[newW][newH]=BitmapTexture._mipMapUses[newW][newH]+1;this._mipMapHolder=BitmapTexture._mipMaps[newW][newH]}};BitmapTexture.prototype.freeMipMapHolder=function(){var holderWidth=this._mipMapHolder.width;var holderHeight=this._mipMapHolder.height;if(--BitmapTexture._mipMapUses[holderWidth][holderHeight]==0){BitmapTexture._mipMaps[holderWidth][holderHeight].dispose();BitmapTexture._mipMaps[holderWidth][holderHeight]=null}};BitmapTexture.prototype.dispose=function(){_super.prototype.dispose.call(this);if(this._mipMapHolder){this.freeMipMapHolder()}};BitmapTexture._mipMaps=[];BitmapTexture._mipMapUses=[];return BitmapTexture})(away.textures.Texture2DBase);textures.BitmapTexture=BitmapTexture})(away.textures||(away.textures={}));var textures=away.textures})(away||(away={}));var away;(function(away){(function(textures){var CubeTextureBase=(function(_super){__extends(CubeTextureBase,_super);function CubeTextureBase(){_super.call(this)}Object.defineProperty(CubeTextureBase.prototype,"size",{get:function(){return this.width},enumerable:true,configurable:true});CubeTextureBase.prototype.pCreateTexture=function(context){return context.createCubeTexture(this.width,away.display3D.Context3DTextureFormat.BGRA,false)};return CubeTextureBase})(away.textures.TextureProxyBase);textures.CubeTextureBase=CubeTextureBase})(away.textures||(away.textures={}));var textures=away.textures})(away||(away={}));var away;(function(away){(function(textures){var RenderTexture=(function(_super){__extends(RenderTexture,_super);function RenderTexture(width,height){_super.call(this);this.pSetSize(width,height)}Object.defineProperty(RenderTexture.prototype,"width",{set:function(value){if(value==this._pWidth){return}if(!away.utils.TextureUtils.isDimensionValid(value)){throw new Error("Invalid size: Width and height must be power of 2 and cannot exceed 2048")}this.invalidateContent();this.pSetSize(value,this._pHeight)},enumerable:true,configurable:true});Object.defineProperty(RenderTexture.prototype,"height",{set:function(value){if(value==this._pHeight){return}if(!away.utils.TextureUtils.isDimensionValid(value)){throw new Error("Invalid size: Width and height must be power of 2 and cannot exceed 2048")}this.invalidateContent();this.pSetSize(this._pWidth,value)},enumerable:true,configurable:true});RenderTexture.prototype.pUploadContent=function(texture){var bmp=new away.display.BitmapData(this.width,this.height,false,16711680);away.materials.MipmapGenerator.generateMipMaps(bmp,texture);bmp.dispose()};RenderTexture.prototype.pCreateTexture=function(context){return context.createTexture(this.width,this.height,away.display3D.Context3DTextureFormat.BGRA,true)};return RenderTexture})(away.textures.Texture2DBase);textures.RenderTexture=RenderTexture})(away.textures||(away.textures={}));var textures=away.textures})(away||(away={}));var away;(function(away){(function(utils){var TextureUtils=(function(){function TextureUtils(){}TextureUtils.isBitmapDataValid=function(bitmapData){if(bitmapData==null){return true}return TextureUtils.isDimensionValid(bitmapData.width)&&TextureUtils.isDimensionValid(bitmapData.height)};TextureUtils.isHTMLImageElementValid=function(image){if(image==null){return true}return TextureUtils.isDimensionValid(image.width)&&TextureUtils.isDimensionValid(image.height)};TextureUtils.isDimensionValid=function(d){return d>=1&&d<=TextureUtils.MAX_SIZE&&TextureUtils.isPowerOfTwo(d)};TextureUtils.isPowerOfTwo=function(value){return value?((value&-value)==value):false};TextureUtils.getBestPowerOf2=function(value){var p=1;while(p<value){p<<=1}if(p>TextureUtils.MAX_SIZE){p=TextureUtils.MAX_SIZE}return p};TextureUtils.MAX_SIZE=2048;return TextureUtils})();utils.TextureUtils=TextureUtils})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(events){var TimerEvent=(function(_super){__extends(TimerEvent,_super);function TimerEvent(type){_super.call(this,type)}TimerEvent.TIMER="timer";TimerEvent.TIMER_COMPLETE="timerComplete";return TimerEvent})(away.events.Event);events.TimerEvent=TimerEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(events){var ParserEvent=(function(_super){__extends(ParserEvent,_super);function ParserEvent(type,message){if(typeof message==="undefined"){message=""}_super.call(this,type);this._message=message}Object.defineProperty(ParserEvent.prototype,"message",{get:function(){return this._message},enumerable:true,configurable:true});ParserEvent.prototype.clone=function(){return new away.events.ParserEvent(this.type,this.message)};ParserEvent.PARSE_COMPLETE="parseComplete";ParserEvent.PARSE_ERROR="parseError";ParserEvent.READY_FOR_DEPENDENCIES="readyForDependencies";return ParserEvent})(away.events.Event);events.ParserEvent=ParserEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(loaders){var ResourceDependency=(function(){function ResourceDependency(id,req,data,parentParser,retrieveAsRawData,suppressAssetEvents){if(typeof retrieveAsRawData==="undefined"){retrieveAsRawData=false}if(typeof suppressAssetEvents==="undefined"){suppressAssetEvents=false}this._id=id;this._req=req;this._parentParser=parentParser;this._data=data;this._retrieveAsRawData=retrieveAsRawData;this._suppressAssetEvents=suppressAssetEvents;this._assets=new Array();this._dependencies=new Array()}Object.defineProperty(ResourceDependency.prototype,"id",{get:function(){return this._id},enumerable:true,configurable:true});Object.defineProperty(ResourceDependency.prototype,"assets",{get:function(){return this._assets},enumerable:true,configurable:true});Object.defineProperty(ResourceDependency.prototype,"dependencies",{get:function(){return this._dependencies},enumerable:true,configurable:true});Object.defineProperty(ResourceDependency.prototype,"request",{get:function(){return this._req},enumerable:true,configurable:true});Object.defineProperty(ResourceDependency.prototype,"retrieveAsRawData",{get:function(){return this._retrieveAsRawData},enumerable:true,configurable:true});Object.defineProperty(ResourceDependency.prototype,"suppresAssetEvents",{get:function(){return this._suppressAssetEvents},enumerable:true,configurable:true});Object.defineProperty(ResourceDependency.prototype,"data",{get:function(){return this._data},enumerable:true,configurable:true});ResourceDependency.prototype._iSetData=function(data){this._data=data};Object.defineProperty(ResourceDependency.prototype,"parentParser",{get:function(){return this._parentParser},enumerable:true,configurable:true});ResourceDependency.prototype.resolve=function(){if(this._parentParser){this._parentParser._iResolveDependency(this)}};ResourceDependency.prototype.resolveFailure=function(){if(this._parentParser){this._parentParser._iResolveDependencyFailure(this)}};ResourceDependency.prototype.resolveName=function(asset){if(this._parentParser){return this._parentParser._iResolveDependencyName(this,asset)}return asset.name};return ResourceDependency})();loaders.ResourceDependency=ResourceDependency})(away.loaders||(away.loaders={}));var loaders=away.loaders})(away||(away={}));var away;(function(away){(function(utils){var Timer=(function(_super){__extends(Timer,_super);function Timer(delay,repeatCount){if(typeof repeatCount==="undefined"){repeatCount=0}_super.call(this);this._repeatCount=0;this._currentCount=0;this._running=false;this._delay=delay;this._repeatCount=repeatCount;if(isNaN(delay)||delay<0){throw new away.errors.Error("Delay is negative or not a number")}}Object.defineProperty(Timer.prototype,"currentCount",{get:function(){return this._currentCount},enumerable:true,configurable:true});Object.defineProperty(Timer.prototype,"delay",{get:function(){return this._delay},set:function(value){this._delay=value;if(this._running){this.stop();this.start()}},enumerable:true,configurable:true});Object.defineProperty(Timer.prototype,"repeatCount",{get:function(){return this._repeatCount},set:function(value){this._repeatCount=value},enumerable:true,configurable:true});Timer.prototype.reset=function(){if(this._running){this.stop()}this._currentCount=0};Object.defineProperty(Timer.prototype,"running",{get:function(){return this._running},enumerable:true,configurable:true});Timer.prototype.start=function(){var _this=this;this._running=true;clearInterval(this._iid);this._iid=setInterval(function(){return _this.tick()},this._delay)};Timer.prototype.stop=function(){this._running=false;clearInterval(this._iid)};Timer.prototype.tick=function(){this._currentCount++;if((this._repeatCount>0)&&this._currentCount>=this._repeatCount){this.stop();this.dispatchEvent(new away.events.TimerEvent(away.events.TimerEvent.TIMER));this.dispatchEvent(new away.events.TimerEvent(away.events.TimerEvent.TIMER_COMPLETE))}else{this.dispatchEvent(new away.events.TimerEvent(away.events.TimerEvent.TIMER))}};return Timer})(away.events.EventDispatcher);utils.Timer=Timer})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(utils){function getTimer(){return Date.now()}utils.getTimer=getTimer})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(events){var MouseEvent3D=(function(_super){__extends(MouseEvent3D,_super);function MouseEvent3D(type){_super.call(this,type);this._iAllowedToPropagate=true}Object.defineProperty(MouseEvent3D.prototype,"bubbles",{get:function(){var doesBubble=this._iAllowedToPropagate;this._iAllowedToPropagate=true;return doesBubble},enumerable:true,configurable:true});MouseEvent3D.prototype.stopPropagation=function(){this._iAllowedToPropagate=false;if(this._iParentEvent){this._iParentEvent.stopPropagation()}};MouseEvent3D.prototype.stopImmediatePropagation=function(){this._iAllowedToPropagate=false;if(this._iParentEvent){this._iParentEvent.stopImmediatePropagation()}};MouseEvent3D.prototype.clone=function(){var result=new away.events.MouseEvent3D(this.type);result.screenX=this.screenX;result.screenY=this.screenY;result.view=this.view;result.object=this.object;result.renderable=this.renderable;result.material=this.material;result.uv=this.uv;result.localPosition=this.localPosition;result.localNormal=this.localNormal;result.index=this.index;result.subGeometryIndex=this.subGeometryIndex;result.delta=this.delta;result.ctrlKey=this.ctrlKey;result.shiftKey=this.shiftKey;result._iParentEvent=this;result._iAllowedToPropagate=this._iAllowedToPropagate;return result};Object.defineProperty(MouseEvent3D.prototype,"scenePosition",{get:function(){if(this.object instanceof away.containers.ObjectContainer3D){var objContainer=this.object;return objContainer.sceneTransform.transformVector(this.localPosition)}else{return this.localPosition}},enumerable:true,configurable:true});Object.defineProperty(MouseEvent3D.prototype,"sceneNormal",{get:function(){if(this.object instanceof away.containers.ObjectContainer3D){var objContainer=this.object;var sceneNormal=objContainer.sceneTransform.deltaTransformVector(this.localNormal);sceneNormal.normalize();return sceneNormal}else{return this.localNormal}},enumerable:true,configurable:true});MouseEvent3D.MOUSE_OVER="mouseOver3d";MouseEvent3D.MOUSE_OUT="mouseOut3d";MouseEvent3D.MOUSE_UP="mouseUp3d";MouseEvent3D.MOUSE_DOWN="mouseDown3d";MouseEvent3D.MOUSE_MOVE="mouseMove3d";MouseEvent3D.CLICK="click3d";MouseEvent3D.DOUBLE_CLICK="doubleClick3d";MouseEvent3D.MOUSE_WHEEL="mouseWheel3d";return MouseEvent3D})(events.Event);events.MouseEvent3D=MouseEvent3D})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(managers){var Stage3DProxy=(function(_super){__extends(Stage3DProxy,_super);function Stage3DProxy(stage3DIndex,stage3D,stage3DManager,forceSoftware,profile){if(typeof forceSoftware==="undefined"){forceSoftware=false}if(typeof profile==="undefined"){profile="baseline"}_super.call(this);this._iStage3DIndex=-1;this._antiAlias=0;this._renderTarget=null;this._renderSurfaceSelector=0;this._iStage3DIndex=stage3DIndex;this._stage3D=stage3D;this._stage3D.x=0;this._stage3D.y=0;this._stage3D.visible=true;this._stage3DManager=stage3DManager;this._viewPort=new away.geom.Rectangle();this._enableDepthAndStencil=true;this._stage3D.addEventListener(away.events.Event.CONTEXT3D_CREATE,this.onContext3DUpdate,this);this.requestContext(forceSoftware,this.profile)}Stage3DProxy.prototype.notifyViewportUpdated=function(){if(this._viewportDirty){return}this._viewportDirty=true;this._viewportUpdated=new away.events.Stage3DEvent(away.events.Stage3DEvent.VIEWPORT_UPDATED);this.dispatchEvent(this._viewportUpdated)};Stage3DProxy.prototype.notifyEnterFrame=function(){if(!this._enterFrame){this._enterFrame=new away.events.Event(away.events.Event.ENTER_FRAME)}this.dispatchEvent(this._enterFrame)};Stage3DProxy.prototype.notifyExitFrame=function(){if(!this._exitFrame){this._exitFrame=new away.events.Event(away.events.Event.EXIT_FRAME)}this.dispatchEvent(this._exitFrame)};Object.defineProperty(Stage3DProxy.prototype,"profile",{get:function(){return this._profile},enumerable:true,configurable:true});Stage3DProxy.prototype.dispose=function(){this._stage3DManager.iRemoveStage3DProxy(this);this._stage3D.removeEventListener(away.events.Event.CONTEXT3D_CREATE,this.onContext3DUpdate,this);this.freeContext3D();this._stage3D=null;this._stage3DManager=null;this._iStage3DIndex=-1};Stage3DProxy.prototype.configureBackBuffer=function(backBufferWidth,backBufferHeight,antiAlias,enableDepthAndStencil){var oldWidth=this._backBufferWidth;var oldHeight=this._backBufferHeight;this._backBufferWidth=this._viewPort.width=backBufferWidth;this._backBufferHeight=this._viewPort.height=backBufferHeight;if(oldWidth!=this._backBufferWidth||oldHeight!=this._backBufferHeight){this.notifyViewportUpdated()}this._antiAlias=antiAlias;this._enableDepthAndStencil=enableDepthAndStencil;if(this._iContext3D){this._iContext3D.configureBackBuffer(backBufferWidth,backBufferHeight,antiAlias,enableDepthAndStencil)}this._stage3D.width=backBufferWidth;this._stage3D.height=backBufferHeight};Object.defineProperty(Stage3DProxy.prototype,"enableDepthAndStencil",{get:function(){return this._enableDepthAndStencil},set:function(enableDepthAndStencil){this._enableDepthAndStencil=enableDepthAndStencil;this._backBufferDirty=true},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"renderTarget",{get:function(){return this._renderTarget},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"renderSurfaceSelector",{get:function(){return this._renderSurfaceSelector},enumerable:true,configurable:true});Stage3DProxy.prototype.setRenderTarget=function(target,enableDepthAndStencil,surfaceSelector){if(typeof enableDepthAndStencil==="undefined"){enableDepthAndStencil=false}if(typeof surfaceSelector==="undefined"){surfaceSelector=0}if(this._renderTarget===target&&surfaceSelector==this._renderSurfaceSelector&&this._enableDepthAndStencil==enableDepthAndStencil){return}this._renderTarget=target;this._renderSurfaceSelector=surfaceSelector;this._enableDepthAndStencil=enableDepthAndStencil;away.Debug.throwPIR("Stage3DProxy","setRenderTarget","away.display3D.Context3D: setRenderToTexture , setRenderToBackBuffer")};Stage3DProxy.prototype.clear=function(){if(!this._iContext3D){return}if(this._backBufferDirty){this.configureBackBuffer(this._backBufferWidth,this._backBufferHeight,this._antiAlias,this._enableDepthAndStencil);this._backBufferDirty=false}this._iContext3D.clear((this._color&4278190080)>>>24,(this._color&16711680)>>>16,(this._color&65280)>>>8,this._color&255);this._bufferClear=true};Stage3DProxy.prototype.present=function(){if(!this._iContext3D){return}this._iContext3D.present();this._activeProgram3D=null;if(this._mouse3DManager){this._mouse3DManager.fireMouseEvents()}};Stage3DProxy.prototype.addEventListener=function(type,listener,target){_super.prototype.addEventListener.call(this,type,listener,target);away.Debug.throwPIR("Stage3DProxy","addEventListener","EnterFrame, ExitFrame");if((type==away.events.Event.ENTER_FRAME||type==away.events.Event.EXIT_FRAME)){}};Stage3DProxy.prototype.removeEventListener=function(type,listener,target){_super.prototype.removeEventListener.call(this,type,listener,target);away.Debug.throwPIR("Stage3DProxy","removeEventListener","EnterFrame, ExitFrame");if(!this.hasEventListener(away.events.Event.ENTER_FRAME,this.onEnterFrame,this)&&!this.hasEventListener(away.events.Event.EXIT_FRAME,this.onEnterFrame,this)){}};Object.defineProperty(Stage3DProxy.prototype,"scissorRect",{get:function(){return this._scissorRect},set:function(value){this._scissorRect=value;this._iContext3D.setScissorRectangle(this._scissorRect)},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"stage3DIndex",{get:function(){return this._iStage3DIndex},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"stage3D",{get:function(){return this._stage3D},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"context3D",{get:function(){return this._iContext3D},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"usesSoftwareRendering",{get:function(){return this._usesSoftwareRendering},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"x",{get:function(){return this._stage3D.x},set:function(value){if(this._viewPort.x==value){return}this._stage3D.x=this._viewPort.x=value;this.notifyViewportUpdated()},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"y",{get:function(){return this._stage3D.y},set:function(value){if(this._viewPort.y==value){return}this._stage3D.y=this._viewPort.y=value;this.notifyViewportUpdated()},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"canvas",{get:function(){return this._stage3D.canvas},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"width",{get:function(){return this._backBufferWidth},set:function(width){if(this._viewPort.width==width){return}this._stage3D.width=this._backBufferWidth=this._viewPort.width=width;this._backBufferDirty=true;this.notifyViewportUpdated()},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"height",{get:function(){return this._backBufferHeight},set:function(height){if(this._viewPort.height==height){return}this._stage3D.height=this._backBufferHeight=this._viewPort.height=height;this._backBufferDirty=true;this.notifyViewportUpdated()},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"antiAlias",{get:function(){return this._antiAlias},set:function(antiAlias){this._antiAlias=antiAlias;this._backBufferDirty=true},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"viewPort",{get:function(){this._viewportDirty=false;return this._viewPort},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"color",{get:function(){return this._color},set:function(color){this._color=color},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"visible",{get:function(){return this._stage3D.visible},set:function(value){this._stage3D.visible=value},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"bufferClear",{get:function(){return this._bufferClear},set:function(newBufferClear){this._bufferClear=newBufferClear},enumerable:true,configurable:true});Object.defineProperty(Stage3DProxy.prototype,"mouse3DManager",{get:function(){return this._mouse3DManager},set:function(value){this._mouse3DManager=value},enumerable:true,configurable:true});Stage3DProxy.prototype.freeContext3D=function(){if(this._iContext3D){away.Debug.throwPIR("Stage3DProxy","freeContext3D","Context3D.dispose()");this.dispatchEvent(new away.events.Stage3DEvent(away.events.Stage3DEvent.CONTEXT3D_DISPOSED))}this._iContext3D=null};Stage3DProxy.prototype.onContext3DUpdate=function(event){if(this._stage3D.context3D){var hadContext=(this._iContext3D!=null);this._iContext3D=this._stage3D.context3D;away.Debug.log("Stage3DProxy","onContext3DUpdate this._stage3D.context3D: ",this._stage3D.context3D);away.Debug.throwPIR("Stage3DProxy","onContext3DUpdate","Context3D.enableErrorChecking");if(this._backBufferWidth&&this._backBufferHeight){this._iContext3D.configureBackBuffer(this._backBufferWidth,this._backBufferHeight,this._antiAlias,this._enableDepthAndStencil)}this.dispatchEvent(new away.events.Stage3DEvent(hadContext?away.events.Stage3DEvent.CONTEXT3D_RECREATED:away.events.Stage3DEvent.CONTEXT3D_CREATED))}else{throw new Error("Rendering context lost!")}};Stage3DProxy.prototype.requestContext=function(forceSoftware,profile){if(typeof forceSoftware==="undefined"){forceSoftware=false}if(typeof profile==="undefined"){profile="baseline"}if(this._usesSoftwareRendering!=null){this._usesSoftwareRendering=forceSoftware}this._profile=profile;this._stage3D.requestContext(true);away.Debug.throwPIR("Stage3DProxy","requestContext","Context3DRenderMode")};Stage3DProxy.prototype.onEnterFrame=function(event){if(!this._iContext3D){return}this.clear();this.notifyEnterFrame();this.present();this.notifyExitFrame()};Stage3DProxy.prototype.recoverFromDisposal=function(){if(!this._iContext3D){return false}away.Debug.throwPIR("Stage3DProxy","recoverFromDisposal","");return true};Stage3DProxy.prototype.clearDepthBuffer=function(){if(!this._iContext3D){return}this._iContext3D.clear(0,0,0,1,1,0,away.display3D.Context3DClearMask.DEPTH)};return Stage3DProxy})(away.events.EventDispatcher);managers.Stage3DProxy=Stage3DProxy})(away.managers||(away.managers={}));var managers=away.managers})(away||(away={}));var away;(function(away){(function(display){var Stage=(function(_super){__extends(Stage,_super);function Stage(width,height){if(typeof width==="undefined"){width=640}if(typeof height==="undefined"){height=480}_super.call(this);if(!document){throw new away.errors.DocumentError("A root document object does not exist.")}this.initStage3DObjects();this.resize(width,height)}Stage.prototype.resize=function(width,height){this._stageHeight=height;this._stageWidth=width;var s3d;for(var i=0;i<Stage.STAGE3D_MAX_QUANTITY;++i){s3d=this.stage3Ds[i];s3d.width=width;s3d.height=height;s3d.x=0;s3d.y=0}this.dispatchEvent(new away.events.Event(away.events.Event.RESIZE))};Stage.prototype.getStage3DAt=function(index){if(0<=index&&index<Stage.STAGE3D_MAX_QUANTITY){return this.stage3Ds[index]}throw new away.errors.ArgumentError("Index is out of bounds [0.."+Stage.STAGE3D_MAX_QUANTITY+"]")};Stage.prototype.initStage3DObjects=function(){this.stage3Ds=[];for(var i=0;i<Stage.STAGE3D_MAX_QUANTITY;++i){var canvas=this.createHTMLCanvasElement();var stage3D=new away.display.Stage3D(canvas);stage3D.addEventListener(away.events.Event.CONTEXT3D_CREATE,this.onContextCreated,this);this.stage3Ds.push(stage3D)}};Stage.prototype.onContextCreated=function(e){var stage3D=e.target;this.addChildHTMLElement(stage3D.canvas)};Stage.prototype.createHTMLCanvasElement=function(){return document.createElement("canvas")};Stage.prototype.addChildHTMLElement=function(canvas){document.body.appendChild(canvas)};Object.defineProperty(Stage.prototype,"stageWidth",{get:function(){return this._stageWidth},enumerable:true,configurable:true});Object.defineProperty(Stage.prototype,"stageHeight",{get:function(){return this._stageHeight},enumerable:true,configurable:true});Object.defineProperty(Stage.prototype,"rect",{get:function(){return new away.geom.Rectangle(0,0,this._stageWidth,this._stageHeight)},enumerable:true,configurable:true});Stage.STAGE3D_MAX_QUANTITY=8;return Stage})(away.events.EventDispatcher);display.Stage=Stage})(away.display||(away.display={}));var display=away.display})(away||(away={}));var away;(function(away){(function(managers){var Mouse3DManager=(function(){function Mouse3DManager(){this._updateDirty=true;this._nullVector=new away.geom.Vector3D();this._mousePicker=away.pick.PickingType.RAYCAST_FIRST_ENCOUNTERED;this._childDepth=0;if(!Mouse3DManager._view3Ds){Mouse3DManager._view3Ds=new Object();Mouse3DManager._view3DLookup=new Array()}}Mouse3DManager.prototype.updateCollider=function(view){throw new away.errors.PartialImplementationError("stage3DProxy")};Mouse3DManager.prototype.fireMouseEvents=function(){throw new away.errors.PartialImplementationError("View3D().layeredView")};Mouse3DManager.prototype.addViewLayer=function(view){throw new away.errors.PartialImplementationError("Stage3DProxy, Stage, DisplayObjectContainer ( as3 / native ) ")};Mouse3DManager.prototype.enableMouseListeners=function(view){throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.disableMouseListeners=function(view){throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.dispose=function(){this._mousePicker.dispose()};Mouse3DManager.prototype.queueDispatch=function(event,sourceEvent,collider){if(typeof collider==="undefined"){collider=null}throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.reThrowEvent=function(event){throw new away.errors.PartialImplementationError("MouseEvent - AS3 <> JS Conversion")};Mouse3DManager.prototype.hasKey=function(view){for(var v in Mouse3DManager._view3Ds){if(v===view){return true}}return false};Mouse3DManager.prototype.traverseDisplayObjects=function(container){throw new away.errors.PartialImplementationError("DisplayObjectContainer ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.onMouseMove=function(event){throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.onMouseOut=function(event){this._activeView=null;if(Mouse3DManager._pCollidingObject){this.queueDispatch(Mouse3DManager._mouseOut,event,Mouse3DManager._pCollidingObject)}this._updateDirty=true;throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.onMouseOver=function(event){throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.onClick=function(event){throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.onDoubleClick=function(event){if(Mouse3DManager._pCollidingObject){this.queueDispatch(Mouse3DManager._mouseDoubleClick,event)}else{this.reThrowEvent(event)}this._updateDirty=true};Mouse3DManager.prototype.onMouseDown=function(event){throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.onMouseUp=function(event){throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Mouse3DManager.prototype.onMouseWheel=function(event){throw new away.errors.PartialImplementationError("MouseEvent ( as3 / native ) as3 <> JS Conversion")};Object.defineProperty(Mouse3DManager.prototype,"forceMouseMove",{get:function(){return this._forceMouseMove},set:function(value){this._forceMouseMove=value},enumerable:true,configurable:true});Object.defineProperty(Mouse3DManager.prototype,"mousePicker",{get:function(){return this._mousePicker},set:function(value){this._mousePicker=value},enumerable:true,configurable:true});Mouse3DManager._viewCount=0;Mouse3DManager._queuedEvents=new Array();Mouse3DManager._mouseUp=new away.events.MouseEvent3D(away.events.MouseEvent3D.MOUSE_UP);Mouse3DManager._mouseClick=new away.events.MouseEvent3D(away.events.MouseEvent3D.CLICK);Mouse3DManager._mouseOut=new away.events.MouseEvent3D(away.events.MouseEvent3D.MOUSE_OUT);Mouse3DManager._mouseDown=new away.events.MouseEvent3D(away.events.MouseEvent3D.MOUSE_DOWN);Mouse3DManager._mouseMove=new away.events.MouseEvent3D(away.events.MouseEvent3D.MOUSE_MOVE);Mouse3DManager._mouseOver=new away.events.MouseEvent3D(away.events.MouseEvent3D.MOUSE_OVER);Mouse3DManager._mouseWheel=new away.events.MouseEvent3D(away.events.MouseEvent3D.MOUSE_WHEEL);Mouse3DManager._mouseDoubleClick=new away.events.MouseEvent3D(away.events.MouseEvent3D.DOUBLE_CLICK);Mouse3DManager._previousCollidingView=-1;Mouse3DManager._collidingView=-1;return Mouse3DManager})();managers.Mouse3DManager=Mouse3DManager})(away.managers||(away.managers={}));var managers=away.managers})(away||(away={}));var away;(function(away){(function(events){var Stage3DEvent=(function(_super){__extends(Stage3DEvent,_super);function Stage3DEvent(type){_super.call(this,type)}Stage3DEvent.CONTEXT3D_CREATED="Context3DCreated";Stage3DEvent.CONTEXT3D_DISPOSED="Context3DDisposed";Stage3DEvent.CONTEXT3D_RECREATED="Context3DRecreated";Stage3DEvent.VIEWPORT_UPDATED="ViewportUpdated";return Stage3DEvent})(events.Event);events.Stage3DEvent=Stage3DEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(managers){var Stage3DManager=(function(){function Stage3DManager(stage,Stage3DManagerSingletonEnforcer){if(!Stage3DManagerSingletonEnforcer){throw new Error("This class is a multiton and cannot be instantiated manually. Use Stage3DManager.getInstance instead.")}this._stage=stage;if(!Stage3DManager._stageProxies){Stage3DManager._stageProxies=new Array(this._stage.stage3Ds.length)}}Stage3DManager.getInstance=function(stage){var stage3dManager=Stage3DManager.getStage3DManagerByStageRef(stage);if(stage3dManager==null){stage3dManager=new away.managers.Stage3DManager(stage,new Stage3DManagerSingletonEnforcer());var stageInstanceData=new Stage3DManagerInstanceData();stageInstanceData.stage=stage;stageInstanceData.stage3DManager=stage3dManager;Stage3DManager._instances.push(stageInstanceData)}return stage3dManager};Stage3DManager.getStage3DManagerByStageRef=function(stage){if(Stage3DManager._instances==null){Stage3DManager._instances=new Array()}var l=Stage3DManager._instances.length;var s;for(var c=0;c<l;c++){s=Stage3DManager._instances[c];if(s.stage==stage){return s.stage3DManager}}return null};Stage3DManager.prototype.getStage3DProxy=function(index,forceSoftware,profile){if(typeof forceSoftware==="undefined"){forceSoftware=false}if(typeof profile==="undefined"){profile="baseline"}if(!Stage3DManager._stageProxies[index]){Stage3DManager._numStageProxies++;Stage3DManager._stageProxies[index]=new away.managers.Stage3DProxy(index,this._stage.stage3Ds[index],this,forceSoftware,profile)}return Stage3DManager._stageProxies[index]};Stage3DManager.prototype.iRemoveStage3DProxy=function(stage3DProxy){Stage3DManager._numStageProxies--;Stage3DManager._stageProxies[stage3DProxy._iStage3DIndex]=null};Stage3DManager.prototype.getFreeStage3DProxy=function(forceSoftware,profile){if(typeof forceSoftware==="undefined"){forceSoftware=false}if(typeof profile==="undefined"){profile="baseline"}var i=0;var len=Stage3DManager._stageProxies.length;while(i<len){if(!Stage3DManager._stageProxies[i]){this.getStage3DProxy(i,forceSoftware,profile);Stage3DManager._stageProxies[i].width=this._stage.stageWidth;Stage3DManager._stageProxies[i].height=this._stage.stageHeight;return Stage3DManager._stageProxies[i]}++i}throw new Error("Too many Stage3D instances used!");return null};Object.defineProperty(Stage3DManager.prototype,"hasFreeStage3DProxy",{get:function(){return Stage3DManager._numStageProxies<Stage3DManager._stageProxies.length?true:false},enumerable:true,configurable:true});Object.defineProperty(Stage3DManager.prototype,"numProxySlotsFree",{get:function(){return Stage3DManager._stageProxies.length-Stage3DManager._numStageProxies},enumerable:true,configurable:true});Object.defineProperty(Stage3DManager.prototype,"numProxySlotsUsed",{get:function(){return Stage3DManager._numStageProxies},enumerable:true,configurable:true});Object.defineProperty(Stage3DManager.prototype,"numProxySlotsTotal",{get:function(){return Stage3DManager._stageProxies.length},enumerable:true,configurable:true});Stage3DManager._numStageProxies=0;return Stage3DManager})();managers.Stage3DManager=Stage3DManager})(away.managers||(away.managers={}));var managers=away.managers})(away||(away={}));var Stage3DManagerInstanceData=(function(){function Stage3DManagerInstanceData(){}return Stage3DManagerInstanceData})();var Stage3DManagerSingletonEnforcer=(function(){function Stage3DManagerSingletonEnforcer(){}return Stage3DManagerSingletonEnforcer})();var away;(function(away){(function(managers){var AGALProgram3DCache=(function(){function AGALProgram3DCache(stage3DProxy,agalProgram3DCacheSingletonEnforcer){if(!agalProgram3DCacheSingletonEnforcer){throw new Error("This class is a multiton and cannot be instantiated manually. Use Stage3DManager.getInstance instead.")}this._stage3DProxy=stage3DProxy;this._program3Ds=new Object();this._ids=new Object();this._usages=new Object();this._keys=new Object()}AGALProgram3DCache.getInstance=function(stage3DProxy){var index=stage3DProxy._iStage3DIndex;if(AGALProgram3DCache._instances==null){AGALProgram3DCache._instances=new Array(8)}if(!AGALProgram3DCache._instances[index]){AGALProgram3DCache._instances[index]=new AGALProgram3DCache(stage3DProxy,new AGALProgram3DCacheSingletonEnforcer());stage3DProxy.addEventListener(away.events.Stage3DEvent.CONTEXT3D_DISPOSED,AGALProgram3DCache.onContext3DDisposed,AGALProgram3DCache);stage3DProxy.addEventListener(away.events.Stage3DEvent.CONTEXT3D_CREATED,AGALProgram3DCache.onContext3DDisposed,AGALProgram3DCache);stage3DProxy.addEventListener(away.events.Stage3DEvent.CONTEXT3D_RECREATED,AGALProgram3DCache.onContext3DDisposed,AGALProgram3DCache)}return AGALProgram3DCache._instances[index]};AGALProgram3DCache.getInstanceFromIndex=function(index){if(!AGALProgram3DCache._instances[index]){throw new Error("Instance not created yet!")}return AGALProgram3DCache._instances[index]};AGALProgram3DCache.onContext3DDisposed=function(event){var stage3DProxy=event.target;var index=stage3DProxy._iStage3DIndex;AGALProgram3DCache._instances[index].dispose();AGALProgram3DCache._instances[index]=null;stage3DProxy.removeEventListener(away.events.Stage3DEvent.CONTEXT3D_DISPOSED,AGALProgram3DCache.onContext3DDisposed,AGALProgram3DCache);stage3DProxy.removeEventListener(away.events.Stage3DEvent.CONTEXT3D_CREATED,AGALProgram3DCache.onContext3DDisposed,AGALProgram3DCache);stage3DProxy.removeEventListener(away.events.Stage3DEvent.CONTEXT3D_RECREATED,AGALProgram3DCache.onContext3DDisposed,AGALProgram3DCache)};AGALProgram3DCache.prototype.dispose=function(){for(var key in this._program3Ds){this.destroyProgram(key)}this._keys=null;this._program3Ds=null;this._usages=null};AGALProgram3DCache.prototype.setProgram3D=function(pass,vertexCode,fragmentCode){var stageIndex=this._stage3DProxy._iStage3DIndex;var program;var key=this.getKey(vertexCode,fragmentCode);if(this._program3Ds[key]==null){this._keys[AGALProgram3DCache._currentId]=key;this._usages[AGALProgram3DCache._currentId]=0;this._ids[key]=AGALProgram3DCache._currentId;++AGALProgram3DCache._currentId;program=this._stage3DProxy._iContext3D.createProgram();var vertCompiler=new aglsl.AGLSLCompiler();var fragCompiler=new aglsl.AGLSLCompiler();var vertString=vertCompiler.compile(away.display3D.Context3DProgramType.VERTEX,vertexCode);var fragString=fragCompiler.compile(away.display3D.Context3DProgramType.FRAGMENT,fragmentCode);program.upload(vertString,fragString);this._program3Ds[key]=program}var oldId=pass._iProgram3Dids[stageIndex];var newId=this._ids[key];if(oldId!=newId){if(oldId>=0){this.freeProgram3D(oldId)}this._usages[newId]++}pass._iProgram3Dids[stageIndex]=newId;pass._iProgram3Ds[stageIndex]=this._program3Ds[key]};AGALProgram3DCache.prototype.freeProgram3D=function(programId){this._usages[programId]--;if(this._usages[programId]==0){this.destroyProgram(this._keys[programId])}};AGALProgram3DCache.prototype.destroyProgram=function(key){this._program3Ds[key].dispose();this._program3Ds[key]=null;delete this._program3Ds[key];this._ids[key]=-1};AGALProgram3DCache.prototype.getKey=function(vertexCode,fragmentCode){return vertexCode+"---"+fragmentCode};AGALProgram3DCache._currentId=0;return AGALProgram3DCache})();managers.AGALProgram3DCache=AGALProgram3DCache})(away.managers||(away.managers={}));var managers=away.managers})(away||(away={}));var AGALProgram3DCacheSingletonEnforcer=(function(){function AGALProgram3DCacheSingletonEnforcer(){}return AGALProgram3DCacheSingletonEnforcer})();var away;(function(away){(function(materials){var MipmapGenerator=(function(){function MipmapGenerator(){}MipmapGenerator.generateHTMLImageElementMipMaps=function(source,target,mipmap,alpha,side){if(typeof mipmap==="undefined"){mipmap=null}if(typeof alpha==="undefined"){alpha=false}if(typeof side==="undefined"){side=-1}MipmapGenerator._rect.width=source.width;MipmapGenerator._rect.height=source.height;MipmapGenerator._source=new away.display.BitmapData(source.width,source.height,alpha);MipmapGenerator._source.drawImage(source,MipmapGenerator._rect,MipmapGenerator._rect);MipmapGenerator.generateMipMaps(MipmapGenerator._source,target,mipmap);MipmapGenerator._source.dispose();MipmapGenerator._source=null};MipmapGenerator.generateMipMaps=function(source,target,mipmap,alpha,side){if(typeof mipmap==="undefined"){mipmap=null}if(typeof alpha==="undefined"){alpha=false}if(typeof side==="undefined"){side=-1}var w=source.width;var h=source.height;var regen=mipmap!=null;var i;if(!mipmap){mipmap=new away.display.BitmapData(w,h,alpha)}MipmapGenerator._rect.width=w;MipmapGenerator._rect.height=h;var tx;while(w>=1||h>=1){if(alpha){mipmap.fillRect(MipmapGenerator._rect,0)}MipmapGenerator._matrix.a=MipmapGenerator._rect.width/source.width;MipmapGenerator._matrix.d=MipmapGenerator._rect.height/source.height;mipmap.width=MipmapGenerator._rect.width;mipmap.height=MipmapGenerator._rect.height;mipmap.copyPixels(source,source.rect,MipmapGenerator._rect);if(target instanceof away.display3D.Texture){tx=target;tx.uploadFromBitmapData(mipmap,i++)}else{away.Debug.throwPIR("MipMapGenerator","generateMipMaps","Dependency: CubeTexture")}w>>=1;h>>=1;MipmapGenerator._rect.width=w>1?w:1;MipmapGenerator._rect.height=h>1?h:1}if(!regen){mipmap.dispose()}};MipmapGenerator._matrix=new away.geom.Matrix();MipmapGenerator._rect=new away.geom.Rectangle();return MipmapGenerator})();materials.MipmapGenerator=MipmapGenerator})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(net){var URLVariables=(function(){function URLVariables(source){if(typeof source==="undefined"){source=null}this._variables=new Object();if(source!==null){this.decode(source)}}URLVariables.prototype.decode=function(source){source=source.split("+").join(" ");var tokens,re=/[?&]?([^=]+)=([^&]*)/g;while(tokens=re.exec(source)){this._variables[decodeURIComponent(tokens[1])]=decodeURIComponent(tokens[2])}};URLVariables.prototype.toString=function(){return""};Object.defineProperty(URLVariables.prototype,"variables",{get:function(){return this._variables},set:function(obj){this._variables=obj},enumerable:true,configurable:true});Object.defineProperty(URLVariables.prototype,"formData",{get:function(){var fd=new FormData();for(var s in this._variables){fd.append(s,this._variables[s])}return fd},enumerable:true,configurable:true});return URLVariables})();net.URLVariables=URLVariables})(away.net||(away.net={}));var net=away.net})(away||(away={}));var away;(function(away){(function(utils){var PerspectiveMatrix3D=(function(_super){__extends(PerspectiveMatrix3D,_super);function PerspectiveMatrix3D(v){if(typeof v==="undefined"){v=null}_super.call(this,v)}PerspectiveMatrix3D.prototype.perspectiveFieldOfViewLH=function(fieldOfViewY,aspectRatio,zNear,zFar){var yScale=1/Math.tan(fieldOfViewY/2);var xScale=yScale/aspectRatio;this.copyRawDataFrom([xScale,0,0,0,0,yScale,0,0,0,0,zFar/(zFar-zNear),1,0,0,(zNear*zFar)/(zNear-zFar),0])};return PerspectiveMatrix3D})(away.geom.Matrix3D);utils.PerspectiveMatrix3D=PerspectiveMatrix3D})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(utils){var RequestAnimationFrame=(function(){function RequestAnimationFrame(callback,callbackContext){var _this=this;this._active=false;this._argsArray=new Array();this._getTimer=away.utils.getTimer;this.setCallback(callback,callbackContext);this._rafUpdateFunction=function(){if(_this._active){_this._tick()}};this._argsArray.push(this._dt)}RequestAnimationFrame.prototype.setCallback=function(callback,callbackContext){this._callback=callback;this._callbackContext=callbackContext};RequestAnimationFrame.prototype.start=function(){this._prevTime=this._getTimer();this._active=true;if(window.mozRequestAnimationFrame){window.requestAnimationFrame=window.mozRequestAnimationFrame}else{if(window.webkitRequestAnimationFrame){window.requestAnimationFrame=window.webkitRequestAnimationFrame}else{if(window.oRequestAnimationFrame){window.requestAnimationFrame=window.oRequestAnimationFrame}}}if(window.requestAnimationFrame){window.requestAnimationFrame(this._rafUpdateFunction)}};RequestAnimationFrame.prototype.stop=function(){this._active=false};Object.defineProperty(RequestAnimationFrame.prototype,"active",{get:function(){return this._active},enumerable:true,configurable:true});RequestAnimationFrame.prototype._tick=function(){this._currentTime=this._getTimer();this._dt=this._currentTime-this._prevTime;this._argsArray[0]=this._dt;this._callback.apply(this._callbackContext,this._argsArray);window.requestAnimationFrame(this._rafUpdateFunction);this._prevTime=this._currentTime};return RequestAnimationFrame})();utils.RequestAnimationFrame=RequestAnimationFrame})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){var Debug=(function(){function Debug(){}Debug.breakpoint=function(){away.Debug["break"]()};Debug.throwPIROnKeyWordOnly=function(str,enable){if(typeof enable==="undefined"){enable=true}if(!enable){away.Debug.keyword=null}else{away.Debug.keyword=str}};Debug.throwPIR=function(clss,fnc,msg){Debug.logPIR("PartialImplementationError "+clss,fnc,msg);if(Debug.THROW_ERRORS){if(away.Debug.keyword){var e=clss+fnc+msg;if(e.indexOf(away.Debug.keyword)==-1){return}}throw new away.errors.PartialImplementationError(clss+"."+fnc+": "+msg)}};Debug.logPIR=function(clss,fnc,msg){if(typeof msg==="undefined"){msg=""}if(Debug.LOG_PI_ERRORS){console.log(clss+"."+fnc+": "+msg)}};Debug.log=function(){var args=[];for(var _i=0;_i<(arguments.length-0);_i++){args[_i]=arguments[_i+0]}if(Debug.ENABLE_LOG){console.log.apply(console,arguments)}};Debug.THROW_ERRORS=true;Debug.ENABLE_LOG=true;Debug.LOG_PI_ERRORS=true;Debug.keyword=null;return Debug})();away.Debug=Debug})(away||(away={}));var away;(function(away){(function(base){var SubGeometryBase=(function(){function SubGeometryBase(){this._faceNormalsDirty=true;this._faceTangentsDirty=true;this._indexBuffer=new Array(8);this._indexBufferContext=new Array(8);this._indicesInvalid=new Array(8);this._autoDeriveVertexNormals=true;this._autoDeriveVertexTangents=true;this._autoGenerateUVs=false;this._useFaceWeights=false;this._vertexNormalsDirty=true;this._vertexTangentsDirty=true;this._scaleU=1;this._scaleV=1;this._uvsDirty=true}Object.defineProperty(SubGeometryBase.prototype,"autoGenerateDummyUVs",{get:function(){return this._autoGenerateUVs},set:function(value){this._autoGenerateUVs=value;this._uvsDirty=value},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"autoDeriveVertexNormals",{get:function(){return this._autoDeriveVertexNormals},set:function(value){this._autoDeriveVertexNormals=value;this._vertexNormalsDirty=value},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"useFaceWeights",{get:function(){return this._useFaceWeights},set:function(value){this._useFaceWeights=value;if(this._autoDeriveVertexNormals){this._vertexNormalsDirty=true}if(this._autoDeriveVertexTangents){this._vertexTangentsDirty=true}this._faceNormalsDirty=true},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"numTriangles",{get:function(){return this._numTriangles},enumerable:true,configurable:true});SubGeometryBase.prototype.getIndexBuffer=function(stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(!this._indexBuffer[contextIndex]||this._indexBufferContext[contextIndex]!=context){this._indexBuffer[contextIndex]=context.createIndexBuffer(this._numIndices);this._indexBufferContext[contextIndex]=context;this._indicesInvalid[contextIndex]=true}if(this._indicesInvalid[contextIndex]){this._indexBuffer[contextIndex].uploadFromArray(this._indices,0,this._numIndices);this._indicesInvalid[contextIndex]=false}return this._indexBuffer[contextIndex]};SubGeometryBase.prototype.pUpdateFaceTangents=function(){var i;var index1,index2,index3;var len=this._indices.length;var ui,vi;var v0;var dv1,dv2;var denom;var x0,y0,z0;var dx1,dy1,dz1;var dx2,dy2,dz2;var cx,cy,cz;var vertices=this._vertexData;var uvs=this.UVData;var posStride=this.vertexStride;var posOffset=this.vertexOffset;var texStride=this.UVStride;var texOffset=this.UVOffset;if(this._faceTangents==null){this._faceTangents=new Array(this._indices.length)}while(i<len){index1=this._indices[i];index2=this._indices[i+1];index3=this._indices[i+2];ui=texOffset+index1*texStride+1;v0=uvs[ui];ui=texOffset+index2*texStride+1;dv1=uvs[ui]-v0;ui=texOffset+index3*texStride+1;dv2=uvs[ui]-v0;vi=posOffset+index1*posStride;x0=vertices[vi];y0=vertices[(vi+1)];z0=vertices[(vi+2)];vi=posOffset+index2*posStride;dx1=vertices[(vi)]-x0;dy1=vertices[(vi+1)]-y0;dz1=vertices[(vi+2)]-z0;vi=posOffset+index3*posStride;dx2=vertices[(vi)]-x0;dy2=vertices[(vi+1)]-y0;dz2=vertices[(vi+2)]-z0;cx=dv2*dx1-dv1*dx2;cy=dv2*dy1-dv1*dy2;cz=dv2*dz1-dv1*dz2;denom=1/Math.sqrt(cx*cx+cy*cy+cz*cz);this._faceTangents[i++]=denom*cx;this._faceTangents[i++]=denom*cy;this._faceTangents[i++]=denom*cz}this._faceTangentsDirty=false};SubGeometryBase.prototype.updateFaceNormals=function(){var i,j,k;var index;var len=this._indices.length;var x1,x2,x3;var y1,y2,y3;var z1,z2,z3;var dx1,dy1,dz1;var dx2,dy2,dz2;var cx,cy,cz;var d;var vertices=this._vertexData;var posStride=this.vertexStride;var posOffset=this.vertexOffset;if(this._faceNormals==null){this._faceNormals=new Array(len)}if(this._useFaceWeights){if(this._faceWeights==null){this._faceWeights=new Array(len/3)}}while(i<len){index=posOffset+this._indices[i++]*posStride;x1=vertices[index];y1=vertices[index+1];z1=vertices[index+2];index=posOffset+this._indices[i++]*posStride;x2=vertices[index];y2=vertices[index+1];z2=vertices[index+2];index=posOffset+this._indices[i++]*posStride;x3=vertices[index];y3=vertices[index+1];z3=vertices[index+2];dx1=x3-x1;dy1=y3-y1;dz1=z3-z1;dx2=x2-x1;dy2=y2-y1;dz2=z2-z1;cx=dz1*dy2-dy1*dz2;cy=dx1*dz2-dz1*dx2;cz=dy1*dx2-dx1*dy2;d=Math.sqrt(cx*cx+cy*cy+cz*cz);if(this._useFaceWeights){var w=d*10000;if(w<1){w=1}this._faceWeights[k++]=w}d=1/d;this._faceNormals[j++]=cx*d;this._faceNormals[j++]=cy*d;this._faceNormals[j++]=cz*d}this._faceNormalsDirty=false};SubGeometryBase.prototype.pUpdateVertexNormals=function(target){if(this._faceNormalsDirty){this.updateFaceNormals()}var v1;var f1=0,f2=1,f3=2;var lenV=this._vertexData.length;var normalStride=this.vertexNormalStride;var normalOffset=this.vertexNormalOffset;if(target==null){target=new Array(lenV)}v1=normalOffset;while(v1<lenV){target[v1]=0;target[v1+1]=0;target[v1+2]=0;v1+=normalStride}var i,k;var lenI=this._indices.length;var index;var weight;while(i<lenI){weight=this._useFaceWeights?this._faceWeights[k++]:1;index=normalOffset+this._indices[i++]*normalStride;target[index++]+=this._faceNormals[f1]*weight;target[index++]+=this._faceNormals[f2]*weight;target[index]+=this._faceNormals[f3]*weight;index=normalOffset+this._indices[i++]*normalStride;target[index++]+=this._faceNormals[f1]*weight;target[index++]+=this._faceNormals[f2]*weight;target[index]+=this._faceNormals[f3]*weight;index=normalOffset+this._indices[i++]*normalStride;target[index++]+=this._faceNormals[f1]*weight;target[index++]+=this._faceNormals[f2]*weight;target[index]+=this._faceNormals[f3]*weight;f1+=3;f2+=3;f3+=3}v1=normalOffset;while(v1<lenV){var vx=target[v1];var vy=target[v1+1];var vz=target[v1+2];var d=1/Math.sqrt(vx*vx+vy*vy+vz*vz);target[v1]=vx*d;target[v1+1]=vy*d;target[v1+2]=vz*d;v1+=normalStride}this._vertexNormalsDirty=false;return target};SubGeometryBase.prototype.pUpdateVertexTangents=function(target){if(this._faceTangentsDirty){this.pUpdateFaceTangents()}var i;var lenV=this._vertexData.length;var tangentStride=this.vertexTangentStride;var tangentOffset=this.vertexTangentOffset;if(target==null){target=new Array(lenV)}i=tangentOffset;while(i<lenV){target[i]=0;target[i+1]=0;target[i+2]=0;i+=tangentStride}var k;var lenI=this._indices.length;var index;var weight;var f1=0,f2=1,f3=2;i=0;while(i<lenI){weight=this._useFaceWeights?this._faceWeights[k++]:1;index=tangentOffset+this._indices[i++]*tangentStride;target[index++]+=this._faceTangents[f1]*weight;target[index++]+=this._faceTangents[f2]*weight;target[index]+=this._faceTangents[f3]*weight;index=tangentOffset+this._indices[i++]*tangentStride;target[index++]+=this._faceTangents[f1]*weight;target[index++]+=this._faceTangents[f2]*weight;target[index]+=this._faceTangents[f3]*weight;index=tangentOffset+this._indices[i++]*tangentStride;target[index++]+=this._faceTangents[f1]*weight;target[index++]+=this._faceTangents[f2]*weight;target[index]+=this._faceTangents[f3]*weight;f1+=3;f2+=3;f3+=3}i=tangentOffset;while(i<lenV){var vx=target[i];var vy=target[i+1];var vz=target[i+2];var d=1/Math.sqrt(vx*vx+vy*vy+vz*vz);target[i]=vx*d;target[i+1]=vy*d;target[i+2]=vz*d;i+=tangentStride}this._vertexTangentsDirty=false;return target};SubGeometryBase.prototype.dispose=function(){this.pDisposeIndexBuffers(this._indexBuffer);this._indices=null;this._indexBufferContext=null;this._faceNormals=null;this._faceWeights=null;this._faceTangents=null;this._vertexData=null};Object.defineProperty(SubGeometryBase.prototype,"indexData",{get:function(){return this._indices},enumerable:true,configurable:true});SubGeometryBase.prototype.updateIndexData=function(indices){this._indices=indices;this._numIndices=indices.length;var numTriangles=this._numIndices/3;if(this._numTriangles!=numTriangles){this.pDisposeIndexBuffers(this._indexBuffer)}this._numTriangles=numTriangles;this.pInvalidateBuffers(this._indicesInvalid);this._faceNormalsDirty=true;if(this._autoDeriveVertexNormals){this._vertexNormalsDirty=true}if(this._autoDeriveVertexTangents){this._vertexTangentsDirty=true}};SubGeometryBase.prototype.pDisposeIndexBuffers=function(buffers){for(var i=0;i<8;++i){if(buffers[i]){buffers[i].dispose();buffers[i]=null}}};SubGeometryBase.prototype.pDisposeVertexBuffers=function(buffers){for(var i=0;i<8;++i){if(buffers[i]){buffers[i].dispose();buffers[i]=null}}};Object.defineProperty(SubGeometryBase.prototype,"autoDeriveVertexTangents",{get:function(){return this._autoDeriveVertexTangents},set:function(value){this._autoDeriveVertexTangents=value;this._vertexTangentsDirty=value},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"faceNormals",{get:function(){if(this._faceNormalsDirty){this.updateFaceNormals()}return this._faceNormals},enumerable:true,configurable:true});SubGeometryBase.prototype.pInvalidateBuffers=function(invalid){for(var i=0;i<8;++i){invalid[i]=true}};Object.defineProperty(SubGeometryBase.prototype,"UVStride",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexData",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexPositionData",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexNormalData",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexTangentData",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"UVData",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexStride",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexNormalStride",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexTangentStride",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexOffset",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexNormalOffset",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"vertexTangentOffset",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"UVOffset",{get:function(){throw new away.errors.AbstractMethodError()},enumerable:true,configurable:true});SubGeometryBase.prototype.pInvalidateBounds=function(){if(this._parentGeometry){var me=this;this._parentGeometry.iInvalidateBounds(me)}};Object.defineProperty(SubGeometryBase.prototype,"parentGeometry",{get:function(){return this._parentGeometry},set:function(value){this._parentGeometry=value},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"scaleU",{get:function(){return this._scaleU},enumerable:true,configurable:true});Object.defineProperty(SubGeometryBase.prototype,"scaleV",{get:function(){return this._scaleV},enumerable:true,configurable:true});SubGeometryBase.prototype.scaleUV=function(scaleU,scaleV){if(typeof scaleU==="undefined"){scaleU=1}if(typeof scaleV==="undefined"){scaleV=1}var offset=this.UVOffset;var stride=this.UVStride;var uvs=this.UVData;var len=uvs.length;var ratioU=scaleU/this._scaleU;var ratioV=scaleV/this._scaleV;for(var i=offset;i<len;i+=stride){uvs[i]*=ratioU;uvs[i+1]*=ratioV}this._scaleU=scaleU;this._scaleV=scaleV};SubGeometryBase.prototype.scale=function(scale){var vertices=this.UVData;var len=vertices.length;var offset=this.vertexOffset;var stride=this.vertexStride;for(var i=offset;i<len;i+=stride){vertices[i]*=scale;vertices[i+1]*=scale;vertices[i+2]*=scale}};SubGeometryBase.prototype.applyTransformation=function(transform){var vertices=this._vertexData;var normals=this.vertexNormalData;var tangents=this.vertexTangentData;var posStride=this.vertexStride;var normalStride=this.vertexNormalStride;var tangentStride=this.vertexTangentStride;var posOffset=this.vertexOffset;var normalOffset=this.vertexNormalOffset;var tangentOffset=this.vertexTangentOffset;var len=vertices.length/posStride;var i,i1,i2;var vector=new away.geom.Vector3D();var bakeNormals=normals!=null;var bakeTangents=tangents!=null;var invTranspose;if(bakeNormals||bakeTangents){invTranspose=transform.clone();invTranspose.invert();invTranspose.transpose()}var vi0=posOffset;var ni0=normalOffset;var ti0=tangentOffset;for(i=0;i<len;++i){i1=vi0+1;i2=vi0+2;vector.x=vertices[vi0];vector.y=vertices[i1];vector.z=vertices[i2];vector=transform.transformVector(vector);vertices[vi0]=vector.x;vertices[i1]=vector.y;vertices[i2]=vector.z;vi0+=posStride;if(bakeNormals){i1=ni0+1;i2=ni0+2;vector.x=normals[ni0];vector.y=normals[i1];vector.z=normals[i2];vector=invTranspose.deltaTransformVector(vector);vector.normalize();normals[ni0]=vector.x;normals[i1]=vector.y;normals[i2]=vector.z;ni0+=normalStride}if(bakeTangents){i1=ti0+1;i2=ti0+2;vector.x=tangents[ti0];vector.y=tangents[i1];vector.z=tangents[i2];vector=invTranspose.deltaTransformVector(vector);vector.normalize();tangents[ti0]=vector.x;tangents[i1]=vector.y;tangents[i2]=vector.z;ti0+=tangentStride}}};SubGeometryBase.prototype.pUpdateDummyUVs=function(target){this._uvsDirty=false;var idx,uvIdx;var stride=this.UVStride;var skip=stride-2;var len=this._vertexData.length/this.vertexStride*stride;if(!target){target=new Array()}target.length=len;idx=this.UVOffset;uvIdx=0;while(idx<len){target[idx++]=uvIdx*0.5;target[idx++]=1-(uvIdx&1);idx+=skip;if(++uvIdx==3){uvIdx=0}}return target};return SubGeometryBase})();base.SubGeometryBase=SubGeometryBase})(away.base||(away.base={}));var base=away.base})(away||(away={}));var away;(function(away){(function(events){var GeometryEvent=(function(_super){__extends(GeometryEvent,_super);function GeometryEvent(type,subGeometry){if(typeof subGeometry==="undefined"){subGeometry=null}_super.call(this,type);this._subGeometry=subGeometry}Object.defineProperty(GeometryEvent.prototype,"subGeometry",{get:function(){return this._subGeometry},enumerable:true,configurable:true});GeometryEvent.prototype.clone=function(){return new GeometryEvent(this.type,this._subGeometry)};GeometryEvent.SUB_GEOMETRY_ADDED="SubGeometryAdded";GeometryEvent.SUB_GEOMETRY_REMOVED="SubGeometryRemoved";GeometryEvent.BOUNDS_INVALID="BoundsInvalid";return GeometryEvent})(away.events.Event);events.GeometryEvent=GeometryEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(base){var CompactSubGeometry=(function(_super){__extends(CompactSubGeometry,_super);function CompactSubGeometry(){_super.call(this);this._pVertexDataInvalid=Array(8);this._vertexBuffer=new Array(8);this._bufferContext=new Array(8);this._autoDeriveVertexNormals=false;this._autoDeriveVertexTangents=false}Object.defineProperty(CompactSubGeometry.prototype,"numVertices",{get:function(){return this._pNumVertices},enumerable:true,configurable:true});CompactSubGeometry.prototype.updateData=function(data){if(this._autoDeriveVertexNormals){this._vertexNormalsDirty=true}if(this._autoDeriveVertexTangents){this._vertexTangentsDirty=true}this._faceNormalsDirty=true;this._faceTangentsDirty=true;this._isolatedVertexPositionDataDirty=true;this._vertexData=data;var numVertices=this._vertexData.length/13;if(numVertices!=this._pNumVertices){this.pDisposeVertexBuffers(this._vertexBuffer)}this._pNumVertices=numVertices;if(this._pNumVertices==0){throw new Error("Bad data: geometry can't have zero triangles")}this.pInvalidateBuffers(this._pVertexDataInvalid);this.pInvalidateBounds()};CompactSubGeometry.prototype.activateVertexBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(contextIndex!=this._contextIndex){this.pUpdateActiveBuffer(contextIndex)}if(!this._pActiveBuffer||this._activeContext!=context){this.pCreateBuffer(contextIndex,context)}if(this._pActiveDataInvalid){this.pUploadData(contextIndex)}context.setVertexBufferAt(index,this._pActiveBuffer,0,away.display3D.Context3DVertexBufferFormat.FLOAT_3)};CompactSubGeometry.prototype.activateUVBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(this._uvsDirty&&this._autoGenerateUVs){this._vertexData=this.pUpdateDummyUVs(this._vertexData);this.pInvalidateBuffers(this._pVertexDataInvalid)}if(contextIndex!=this._contextIndex){this.pUpdateActiveBuffer(contextIndex)}if(!this._pActiveBuffer||this._activeContext!=context){this.pCreateBuffer(contextIndex,context)}if(this._pActiveDataInvalid){this.pUploadData(contextIndex)}context.setVertexBufferAt(index,this._pActiveBuffer,9,away.display3D.Context3DVertexBufferFormat.FLOAT_2)};CompactSubGeometry.prototype.activateSecondaryUVBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(contextIndex!=this._contextIndex){this.pUpdateActiveBuffer(contextIndex)}if(!this._pActiveBuffer||this._activeContext!=context){this.pCreateBuffer(contextIndex,context)}if(this._pActiveDataInvalid){this.pUploadData(contextIndex)}context.setVertexBufferAt(index,this._pActiveBuffer,11,away.display3D.Context3DVertexBufferFormat.FLOAT_2)};CompactSubGeometry.prototype.pUploadData=function(contextIndex){this._pActiveBuffer.uploadFromArray(this._vertexData,0,this._pNumVertices);this._pVertexDataInvalid[contextIndex]=this._pActiveDataInvalid=false};CompactSubGeometry.prototype.activateVertexNormalBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(contextIndex!=this._contextIndex){this.pUpdateActiveBuffer(contextIndex)}if(!this._pActiveBuffer||this._activeContext!=context){this.pCreateBuffer(contextIndex,context)}if(this._pActiveDataInvalid){this.pUploadData(contextIndex)}context.setVertexBufferAt(index,this._pActiveBuffer,3,away.display3D.Context3DVertexBufferFormat.FLOAT_3)};CompactSubGeometry.prototype.activateVertexTangentBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(contextIndex!=this._contextIndex){this.pUpdateActiveBuffer(contextIndex)}if(!this._pActiveBuffer||this._activeContext!=context){this.pCreateBuffer(contextIndex,context)}if(this._pActiveDataInvalid){this.pUploadData(contextIndex)}context.setVertexBufferAt(index,this._pActiveBuffer,6,away.display3D.Context3DVertexBufferFormat.FLOAT_3)};CompactSubGeometry.prototype.pCreateBuffer=function(contextIndex,context){this._vertexBuffer[contextIndex]=this._pActiveBuffer=context.createVertexBuffer(this._pNumVertices,13);this._bufferContext[contextIndex]=this._activeContext=context;this._pVertexDataInvalid[contextIndex]=this._pActiveDataInvalid=true};CompactSubGeometry.prototype.pUpdateActiveBuffer=function(contextIndex){this._contextIndex=contextIndex;this._pActiveDataInvalid=this._pVertexDataInvalid[contextIndex];this._pActiveBuffer=this._vertexBuffer[contextIndex];this._activeContext=this._bufferContext[contextIndex]};Object.defineProperty(CompactSubGeometry.prototype,"vertexData",{get:function(){if(this._autoDeriveVertexNormals&&this._vertexNormalsDirty){this._vertexData=this.pUpdateVertexNormals(this._vertexData)}if(this._autoDeriveVertexTangents&&this._vertexTangentsDirty){this._vertexData=this.pUpdateVertexTangents(this._vertexData)}if(this._uvsDirty&&this._autoGenerateUVs){this._vertexData=this.pUpdateDummyUVs(this._vertexData)}return this._vertexData},enumerable:true,configurable:true});CompactSubGeometry.prototype.pUpdateVertexNormals=function(target){this.pInvalidateBuffers(this._pVertexDataInvalid);return _super.prototype.pUpdateVertexNormals.call(this,target)};CompactSubGeometry.prototype.pUpdateVertexTangents=function(target){if(this._vertexNormalsDirty){this._vertexData=this.pUpdateVertexNormals(this._vertexData)}this.pInvalidateBuffers(this._pVertexDataInvalid);return _super.prototype.pUpdateVertexTangents.call(this,target)};Object.defineProperty(CompactSubGeometry.prototype,"vertexNormalData",{get:function(){if(this._autoDeriveVertexNormals&&this._vertexNormalsDirty){this._vertexData=this.pUpdateVertexNormals(this._vertexData)}return this._vertexData},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"vertexTangentData",{get:function(){if(this._autoDeriveVertexTangents&&this._vertexTangentsDirty){this._vertexData=this.pUpdateVertexTangents(this._vertexData)}return this._vertexData},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"UVData",{get:function(){if(this._uvsDirty&&this._autoGenerateUVs){this._vertexData=this.pUpdateDummyUVs(this._vertexData);this.pInvalidateBuffers(this._pVertexDataInvalid)}return this._vertexData},enumerable:true,configurable:true});CompactSubGeometry.prototype.applyTransformation=function(transform){_super.prototype.applyTransformation.call(this,transform);this.pInvalidateBuffers(this._pVertexDataInvalid)};CompactSubGeometry.prototype.scale=function(scale){_super.prototype.scale.call(this,scale);this.pInvalidateBuffers(this._pVertexDataInvalid)};CompactSubGeometry.prototype.clone=function(){var clone=new away.base.CompactSubGeometry();clone._autoDeriveVertexNormals=this._autoDeriveVertexNormals;clone._autoDeriveVertexTangents=this._autoDeriveVertexTangents;clone.updateData(this._vertexData.concat());clone.updateIndexData(this._indices.concat());return clone};CompactSubGeometry.prototype.scaleUV=function(scaleU,scaleV){if(typeof scaleU==="undefined"){scaleU=1}if(typeof scaleV==="undefined"){scaleV=1}_super.prototype.scaleUV.call(this,scaleU,scaleV);this.pInvalidateBuffers(this._pVertexDataInvalid)};Object.defineProperty(CompactSubGeometry.prototype,"vertexStride",{get:function(){return 13},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"vertexNormalStride",{get:function(){return 13},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"vertexTangentStride",{get:function(){return 13},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"UVStride",{get:function(){return 13},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"secondaryUVStride",{get:function(){return 13},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"vertexOffset",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"vertexNormalOffset",{get:function(){return 3},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"vertexTangentOffset",{get:function(){return 6},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"UVOffset",{get:function(){return 9},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"secondaryUVOffset",{get:function(){return 11},enumerable:true,configurable:true});CompactSubGeometry.prototype.dispose=function(){_super.prototype.dispose.call(this);this.pDisposeVertexBuffers(this._vertexBuffer);this._vertexBuffer=null};CompactSubGeometry.prototype.pDisposeVertexBuffers=function(buffers){_super.prototype.pDisposeVertexBuffers.call(this,buffers);this._pActiveBuffer=null};CompactSubGeometry.prototype.pInvalidateBuffers=function(invalid){_super.prototype.pInvalidateBuffers.call(this,invalid);this._pActiveDataInvalid=true};CompactSubGeometry.prototype.cloneWithSeperateBuffers=function(){var clone=new away.base.SubGeometry();clone.updateVertexData(this._isolatedVertexPositionData?this._isolatedVertexPositionData:this._isolatedVertexPositionData=this.stripBuffer(0,3));clone.autoDeriveVertexNormals=this._autoDeriveVertexNormals;clone.autoDeriveVertexTangents=this._autoDeriveVertexTangents;if(!this._autoDeriveVertexNormals){clone.updateVertexNormalData(this.stripBuffer(3,3))}if(!this._autoDeriveVertexTangents){clone.updateVertexTangentData(this.stripBuffer(6,3))}clone.updateUVData(this.stripBuffer(9,2));clone.updateSecondaryUVData(this.stripBuffer(11,2));clone.updateIndexData(this.indexData.concat());return clone};Object.defineProperty(CompactSubGeometry.prototype,"vertexPositionData",{get:function(){if(this._isolatedVertexPositionDataDirty||!this._isolatedVertexPositionData){this._isolatedVertexPositionData=this.stripBuffer(0,3);this._isolatedVertexPositionDataDirty=false}return this._isolatedVertexPositionData},enumerable:true,configurable:true});Object.defineProperty(CompactSubGeometry.prototype,"strippedUVData",{get:function(){return this.stripBuffer(9,2)},enumerable:true,configurable:true});CompactSubGeometry.prototype.stripBuffer=function(offset,numEntries){var data=new Array(this._pNumVertices*numEntries);var i=0;var j=offset;var skip=13-numEntries;for(var v=0;v<this._pNumVertices;++v){for(var k=0;k<numEntries;++k){data[i++]=this._vertexData[j++]}j+=skip}return data};CompactSubGeometry.prototype.fromVectors=function(verts,uvs,normals,tangents){var vertLen=verts.length/3*13;var index=0;var v=0;var n=0;var t=0;var u=0;var data=new Array(vertLen);while(index<vertLen){data[index++]=verts[v++];data[index++]=verts[v++];data[index++]=verts[v++];if(normals&&normals.length){data[index++]=normals[n++];data[index++]=normals[n++];data[index++]=normals[n++]}else{data[index++]=0;data[index++]=0;data[index++]=0}if(tangents&&tangents.length){data[index++]=tangents[t++];data[index++]=tangents[t++];data[index++]=tangents[t++]}else{data[index++]=0;data[index++]=0;data[index++]=0}if(uvs&&uvs.length){data[index++]=uvs[u];data[index++]=uvs[u+1];data[index++]=uvs[u++];data[index++]=uvs[u++]}else{data[index++]=0;data[index++]=0;data[index++]=0;data[index++]=0}}this.autoDeriveVertexNormals=!(normals&&normals.length);this.autoDeriveVertexTangents=!(tangents&&tangents.length);this.autoGenerateDummyUVs=!(uvs&&uvs.length);this.updateData(data)};return CompactSubGeometry})(away.base.SubGeometryBase);base.CompactSubGeometry=CompactSubGeometry})(away.base||(away.base={}));var base=away.base})(away||(away={}));var away;(function(away){(function(base){var SkinnedSubGeometry=(function(_super){__extends(SkinnedSubGeometry,_super);function SkinnedSubGeometry(jointsPerVertex){_super.call(this);this._jointWeightsBuffer=new Array(8);this._jointIndexBuffer=new Array(8);this._jointWeightsInvalid=new Array(8);this._jointIndicesInvalid=new Array(8);this._jointWeightContext=new Array(8);this._jointIndexContext=new Array(8);this._jointsPerVertex=jointsPerVertex;this._bufferFormat="float"+this._jointsPerVertex}Object.defineProperty(SkinnedSubGeometry.prototype,"condensedIndexLookUp",{get:function(){return this._condensedIndexLookUp},enumerable:true,configurable:true});Object.defineProperty(SkinnedSubGeometry.prototype,"numCondensedJoints",{get:function(){return this._numCondensedJoints},enumerable:true,configurable:true});Object.defineProperty(SkinnedSubGeometry.prototype,"animatedData",{get:function(){return this._animatedData||this._vertexData.concat()},enumerable:true,configurable:true});SkinnedSubGeometry.prototype.updateAnimatedData=function(value){this._animatedData=value;this.pInvalidateBuffers(this._pVertexDataInvalid)};SkinnedSubGeometry.prototype.activateJointWeightsBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(this._jointWeightContext[contextIndex]!=context||!this._jointWeightsBuffer[contextIndex]){this._jointWeightsBuffer[contextIndex]=context.createVertexBuffer(this._pNumVertices,this._jointsPerVertex);this._jointWeightContext[contextIndex]=context;this._jointWeightsInvalid[contextIndex]=true}if(this._jointWeightsInvalid[contextIndex]){this._jointWeightsBuffer[contextIndex].uploadFromArray(this._jointWeightsData,0,this._jointWeightsData.length/this._jointsPerVertex);this._jointWeightsInvalid[contextIndex]=false}context.setVertexBufferAt(index,this._jointWeightsBuffer[contextIndex],0,this._bufferFormat)};SkinnedSubGeometry.prototype.activateJointIndexBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(this._jointIndexContext[contextIndex]!=context||!this._jointIndexBuffer[contextIndex]){this._jointIndexBuffer[contextIndex]=context.createVertexBuffer(this._pNumVertices,this._jointsPerVertex);this._jointIndexContext[contextIndex]=context;this._jointIndicesInvalid[contextIndex]=true}if(this._jointIndicesInvalid[contextIndex]){this._jointIndexBuffer[contextIndex].uploadFromArray(this._numCondensedJoints>0?this._condensedJointIndexData:this._jointIndexData,0,this._jointIndexData.length/this._jointsPerVertex);this._jointIndicesInvalid[contextIndex]=false}context.setVertexBufferAt(index,this._jointIndexBuffer[contextIndex],0,this._bufferFormat)};SkinnedSubGeometry.prototype.pUploadData=function(contextIndex){if(this._animatedData){this._pActiveBuffer.uploadFromArray(this._animatedData,0,this._pNumVertices);this._pVertexDataInvalid[contextIndex]=this._pActiveDataInvalid=false}else{_super.prototype.pUploadData.call(this,contextIndex)}};SkinnedSubGeometry.prototype.clone=function(){var clone=new SkinnedSubGeometry(this._jointsPerVertex);clone.updateData(this._vertexData.concat());clone.updateIndexData(this._indices.concat());clone.iUpdateJointIndexData(this._jointIndexData.concat());clone.iUpdateJointWeightsData(this._jointWeightsData.concat());clone._autoDeriveVertexNormals=this._autoDeriveVertexNormals;clone._autoDeriveVertexTangents=this._autoDeriveVertexTangents;clone._numCondensedJoints=this._numCondensedJoints;clone._condensedIndexLookUp=this._condensedIndexLookUp;clone._condensedJointIndexData=this._condensedJointIndexData;return clone};SkinnedSubGeometry.prototype.dispose=function(){_super.prototype.dispose.call(this);this.pDisposeVertexBuffers(this._jointWeightsBuffer);this.pDisposeVertexBuffers(this._jointIndexBuffer)};SkinnedSubGeometry.prototype.iCondenseIndexData=function(){var len=this._jointIndexData.length;var oldIndex;var newIndex=0;var dic=new Object();this._condensedJointIndexData=new Array(len);this._condensedIndexLookUp=new Array();for(var i=0;i<len;++i){oldIndex=this._jointIndexData[i];if(dic[oldIndex]==undefined){dic[oldIndex]=newIndex;this._condensedIndexLookUp[newIndex++]=oldIndex;this._condensedIndexLookUp[newIndex++]=oldIndex+1;this._condensedIndexLookUp[newIndex++]=oldIndex+2}this._condensedJointIndexData[i]=dic[oldIndex]}this._numCondensedJoints=newIndex/3;this.pInvalidateBuffers(this._jointIndicesInvalid)};Object.defineProperty(SkinnedSubGeometry.prototype,"iJointWeightsData",{get:function(){return this._jointWeightsData},enumerable:true,configurable:true});SkinnedSubGeometry.prototype.iUpdateJointWeightsData=function(value){this._numCondensedJoints=0;this._condensedIndexLookUp=null;this._condensedJointIndexData=null;this._jointWeightsData=value;this.pInvalidateBuffers(this._jointWeightsInvalid)};Object.defineProperty(SkinnedSubGeometry.prototype,"iJointIndexData",{get:function(){return this._jointIndexData},enumerable:true,configurable:true});SkinnedSubGeometry.prototype.iUpdateJointIndexData=function(value){this._jointIndexData=value;this.pInvalidateBuffers(this._jointIndicesInvalid)};return SkinnedSubGeometry})(base.CompactSubGeometry);base.SkinnedSubGeometry=SkinnedSubGeometry})(away.base||(away.base={}));var base=away.base})(away||(away={}));var away;(function(away){(function(base){var Geometry=(function(_super){__extends(Geometry,_super);function Geometry(){_super.call(this);this._subGeometries=new Array()}Object.defineProperty(Geometry.prototype,"assetType",{get:function(){return away.library.AssetType.GEOMETRY},enumerable:true,configurable:true});Object.defineProperty(Geometry.prototype,"subGeometries",{get:function(){return this._subGeometries},enumerable:true,configurable:true});Geometry.prototype.getSubGeometries=function(){return this._subGeometries};Geometry.prototype.applyTransformation=function(transform){var len=this._subGeometries.length;for(var i=0;i<len;++i){this._subGeometries[i].applyTransformation(transform)}};Geometry.prototype.addSubGeometry=function(subGeometry){this._subGeometries.push(subGeometry);subGeometry.parentGeometry=this;this.dispatchEvent(new away.events.GeometryEvent(away.events.GeometryEvent.SUB_GEOMETRY_ADDED,subGeometry));this.iInvalidateBounds(subGeometry)};Geometry.prototype.removeSubGeometry=function(subGeometry){this._subGeometries.splice(this._subGeometries.indexOf(subGeometry),1);subGeometry.parentGeometry=null;this.dispatchEvent(new away.events.GeometryEvent(away.events.GeometryEvent.SUB_GEOMETRY_REMOVED,subGeometry));this.iInvalidateBounds(subGeometry)};Geometry.prototype.clone=function(){var clone=new Geometry();var len=this._subGeometries.length;for(var i=0;i<len;++i){clone.addSubGeometry(this._subGeometries[i].clone())}return clone};Geometry.prototype.scale=function(scale){var numSubGeoms=this._subGeometries.length;for(var i=0;i<numSubGeoms;++i){this._subGeometries[i].scale(scale)}};Geometry.prototype.dispose=function(){var numSubGeoms=this._subGeometries.length;for(var i=0;i<numSubGeoms;++i){var subGeom=this._subGeometries[0];this.removeSubGeometry(subGeom);subGeom.dispose()}};Geometry.prototype.scaleUV=function(scaleU,scaleV){if(typeof scaleU==="undefined"){scaleU=1}if(typeof scaleV==="undefined"){scaleV=1}var numSubGeoms=this._subGeometries.length;for(var i=0;i<numSubGeoms;++i){this._subGeometries[i].scaleUV(scaleU,scaleV)}};Geometry.prototype.convertToSeparateBuffers=function(){var subGeom;var numSubGeoms=this._subGeometries.length;var _removableCompactSubGeometries=new Array();for(var i=0;i<numSubGeoms;++i){subGeom=this._subGeometries[i];if(subGeom instanceof away.base.SubGeometry){continue}_removableCompactSubGeometries.push(subGeom);this.addSubGeometry(subGeom.cloneWithSeperateBuffers())}var l=_removableCompactSubGeometries.length;var s;for(var c=0;c<l;c++){s=_removableCompactSubGeometries[c];this.removeSubGeometry(s);s.dispose()}};Geometry.prototype.iValidate=function(){};Geometry.prototype.iInvalidateBounds=function(subGeom){this.dispatchEvent(new away.events.GeometryEvent(away.events.GeometryEvent.BOUNDS_INVALID,subGeom))};return Geometry})(away.library.NamedAssetBase);base.Geometry=Geometry})(away.base||(away.base={}));var base=away.base})(away||(away={}));var away;(function(away){(function(base){var SubGeometry=(function(_super){__extends(SubGeometry,_super);function SubGeometry(){_super.call(this);this._verticesInvalid=new Array(8);this._uvsInvalid=new Array(8);this._secondaryUvsInvalid=new Array(8);this._normalsInvalid=new Array(8);this._tangentsInvalid=new Array(8);this._vertexBuffer=new Array(8);this._uvBuffer=new Array(8);this._secondaryUvBuffer=new Array(8);this._vertexNormalBuffer=new Array(8);this._vertexTangentBuffer=new Array(8);this._vertexBufferContext=new Array(8);this._uvBufferContext=new Array(8);this._secondaryUvBufferContext=new Array(8);this._vertexNormalBufferContext=new Array(8);this._vertexTangentBufferContext=new Array(8)}Object.defineProperty(SubGeometry.prototype,"numVertices",{get:function(){return this._numVertices},enumerable:true,configurable:true});SubGeometry.prototype.activateVertexBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(!this._vertexBuffer[contextIndex]||this._vertexBufferContext[contextIndex]!=context){this._vertexBuffer[contextIndex]=context.createVertexBuffer(this._numVertices,3);this._vertexBufferContext[contextIndex]=context;this._verticesInvalid[contextIndex]=true}if(this._verticesInvalid[contextIndex]){this._vertexBuffer[contextIndex].uploadFromArray(this._vertexData,0,this._numVertices);this._verticesInvalid[contextIndex]=false}context.setVertexBufferAt(index,this._vertexBuffer[contextIndex],0,away.display3D.Context3DVertexBufferFormat.FLOAT_3)};SubGeometry.prototype.activateUVBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(this._autoGenerateUVs&&this._uvsDirty){this._uvs=this.pUpdateDummyUVs(this._uvs)}if(!this._uvBuffer[contextIndex]||this._uvBufferContext[contextIndex]!=context){this._uvBuffer[contextIndex]=context.createVertexBuffer(this._numVertices,2);this._uvBufferContext[contextIndex]=context;this._uvsInvalid[contextIndex]=true}if(this._uvsInvalid[contextIndex]){this._uvBuffer[contextIndex].uploadFromArray(this._uvs,0,this._numVertices);this._uvsInvalid[contextIndex]=false}context.setVertexBufferAt(index,this._uvBuffer[contextIndex],0,away.display3D.Context3DVertexBufferFormat.FLOAT_2)};SubGeometry.prototype.activateSecondaryUVBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(!this._secondaryUvBuffer[contextIndex]||this._secondaryUvBufferContext[contextIndex]!=context){this._secondaryUvBuffer[contextIndex]=context.createVertexBuffer(this._numVertices,2);this._secondaryUvBufferContext[contextIndex]=context;this._secondaryUvsInvalid[contextIndex]=true}if(this._secondaryUvsInvalid[contextIndex]){this._secondaryUvBuffer[contextIndex].uploadFromArray(this._secondaryUvs,0,this._numVertices);this._secondaryUvsInvalid[contextIndex]=false}context.setVertexBufferAt(index,this._secondaryUvBuffer[contextIndex],0,away.display3D.Context3DVertexBufferFormat.FLOAT_2)};SubGeometry.prototype.activateVertexNormalBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(this._autoDeriveVertexNormals&&this._vertexNormalsDirty){this._vertexNormals=this.pUpdateVertexNormals(this._vertexNormals)}if(!this._vertexNormalBuffer[contextIndex]||this._vertexNormalBufferContext[contextIndex]!=context){this._vertexNormalBuffer[contextIndex]=context.createVertexBuffer(this._numVertices,3);this._vertexNormalBufferContext[contextIndex]=context;this._normalsInvalid[contextIndex]=true}if(this._normalsInvalid[contextIndex]){this._vertexNormalBuffer[contextIndex].uploadFromArray(this._vertexNormals,0,this._numVertices);this._normalsInvalid[contextIndex]=false}context.setVertexBufferAt(index,this._vertexNormalBuffer[contextIndex],0,away.display3D.Context3DVertexBufferFormat.FLOAT_3)};SubGeometry.prototype.activateVertexTangentBuffer=function(index,stage3DProxy){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;if(this._vertexTangentsDirty){this._vertexTangents=this.pUpdateVertexTangents(this._vertexTangents)}if(!this._vertexTangentBuffer[contextIndex]||this._vertexTangentBufferContext[contextIndex]!=context){this._vertexTangentBuffer[contextIndex]=context.createVertexBuffer(this._numVertices,3);this._vertexTangentBufferContext[contextIndex]=context;this._tangentsInvalid[contextIndex]=true}if(this._tangentsInvalid[contextIndex]){this._vertexTangentBuffer[contextIndex].uploadFromArray(this._vertexTangents,0,this._numVertices);this._tangentsInvalid[contextIndex]=false}context.setVertexBufferAt(index,this._vertexTangentBuffer[contextIndex],0,away.display3D.Context3DVertexBufferFormat.FLOAT_3)};SubGeometry.prototype.applyTransformation=function(transform){_super.prototype.applyTransformation.call(this,transform);this.pInvalidateBuffers(this._verticesInvalid);this.pInvalidateBuffers(this._normalsInvalid);this.pInvalidateBuffers(this._tangentsInvalid)};SubGeometry.prototype.clone=function(){var clone=new away.base.SubGeometry();clone.updateVertexData(this._vertexData.concat());clone.updateUVData(this._uvs.concat());clone.updateIndexData(this._indices.concat());if(this._secondaryUvs){clone.updateSecondaryUVData(this._secondaryUvs.concat())}if(!this._autoDeriveVertexNormals){clone.updateVertexNormalData(this._vertexNormals.concat())}if(!this._autoDeriveVertexTangents){clone.updateVertexTangentData(this._vertexTangents.concat())}return clone};SubGeometry.prototype.scale=function(scale){_super.prototype.scale.call(this,scale);this.pInvalidateBuffers(this._verticesInvalid)};SubGeometry.prototype.scaleUV=function(scaleU,scaleV){if(typeof scaleU==="undefined"){scaleU=1}if(typeof scaleV==="undefined"){scaleV=1}_super.prototype.scaleUV.call(this,scaleU,scaleV);this.pInvalidateBuffers(this._uvsInvalid)};SubGeometry.prototype.dispose=function(){_super.prototype.dispose.call(this);this.pDisposeAllVertexBuffers();this._vertexBuffer=null;this._vertexNormalBuffer=null;this._uvBuffer=null;this._secondaryUvBuffer=null;this._vertexTangentBuffer=null;this._indexBuffer=null;this._uvs=null;this._secondaryUvs=null;this._vertexNormals=null;this._vertexTangents=null;this._vertexBufferContext=null;this._uvBufferContext=null;this._secondaryUvBufferContext=null;this._vertexNormalBufferContext=null;this._vertexTangentBufferContext=null};SubGeometry.prototype.pDisposeAllVertexBuffers=function(){this.pDisposeVertexBuffers(this._vertexBuffer);this.pDisposeVertexBuffers(this._vertexNormalBuffer);this.pDisposeVertexBuffers(this._uvBuffer);this.pDisposeVertexBuffers(this._secondaryUvBuffer);this.pDisposeVertexBuffers(this._vertexTangentBuffer)};Object.defineProperty(SubGeometry.prototype,"vertexData",{get:function(){return this._vertexData},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"vertexPositionData",{get:function(){return this._vertexData},enumerable:true,configurable:true});SubGeometry.prototype.updateVertexData=function(vertices){if(this._autoDeriveVertexNormals){this._vertexNormalsDirty=true}if(this._autoDeriveVertexTangents){this._vertexTangentsDirty=true}this._faceNormalsDirty=true;this._vertexData=vertices;var numVertices=vertices.length/3;if(numVertices!=this._numVertices){this.pDisposeAllVertexBuffers()}this._numVertices=numVertices;this.pInvalidateBuffers(this._verticesInvalid);this.pInvalidateBounds()};Object.defineProperty(SubGeometry.prototype,"UVData",{get:function(){if(this._uvsDirty&&this._autoGenerateUVs){this._uvs=this.pUpdateDummyUVs(this._uvs)}return this._uvs},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"secondaryUVData",{get:function(){return this._secondaryUvs},enumerable:true,configurable:true});SubGeometry.prototype.updateUVData=function(uvs){if(this._autoDeriveVertexTangents){this._vertexTangentsDirty=true}this._faceTangentsDirty=true;this._uvs=uvs;this.pInvalidateBuffers(this._uvsInvalid)};SubGeometry.prototype.updateSecondaryUVData=function(uvs){this._secondaryUvs=uvs;this.pInvalidateBuffers(this._secondaryUvsInvalid)};Object.defineProperty(SubGeometry.prototype,"vertexNormalData",{get:function(){if(this._autoDeriveVertexNormals&&this._vertexNormalsDirty){this._vertexNormals=this.pUpdateVertexNormals(this._vertexNormals)}return this._vertexNormals},enumerable:true,configurable:true});SubGeometry.prototype.updateVertexNormalData=function(vertexNormals){this._vertexNormalsDirty=false;this._autoDeriveVertexNormals=(vertexNormals==null);this._vertexNormals=vertexNormals;this.pInvalidateBuffers(this._normalsInvalid)};Object.defineProperty(SubGeometry.prototype,"vertexTangentData",{get:function(){if(this._autoDeriveVertexTangents&&this._vertexTangentsDirty){this._vertexTangents=this.pUpdateVertexTangents(this._vertexTangents)}return this._vertexTangents},enumerable:true,configurable:true});SubGeometry.prototype.updateVertexTangentData=function(vertexTangents){this._vertexTangentsDirty=false;this._autoDeriveVertexTangents=(vertexTangents==null);this._vertexTangents=vertexTangents;this.pInvalidateBuffers(this._tangentsInvalid)};SubGeometry.prototype.fromVectors=function(vertices,uvs,normals,tangents){this.updateVertexData(vertices);this.updateUVData(uvs);this.updateVertexNormalData(normals);this.updateVertexTangentData(tangents)};SubGeometry.prototype.pUpdateVertexNormals=function(target){this.pInvalidateBuffers(this._normalsInvalid);return _super.prototype.pUpdateVertexNormals.call(this,target)};SubGeometry.prototype.pUpdateVertexTangents=function(target){if(this._vertexNormalsDirty){this._vertexNormals=this.pUpdateVertexNormals(this._vertexNormals)}this.pInvalidateBuffers(this._tangentsInvalid);return _super.prototype.pUpdateVertexTangents.call(this,target)};SubGeometry.prototype.pUpdateDummyUVs=function(target){this.pInvalidateBuffers(this._uvsInvalid);return _super.prototype.pUpdateDummyUVs.call(this,target)};SubGeometry.prototype.pDisposeForStage3D=function(stage3DProxy){var index=stage3DProxy._iStage3DIndex;if(this._vertexBuffer[index]){this._vertexBuffer[index].dispose();this._vertexBuffer[index]=null}if(this._uvBuffer[index]){this._uvBuffer[index].dispose();this._uvBuffer[index]=null}if(this._secondaryUvBuffer[index]){this._secondaryUvBuffer[index].dispose();this._secondaryUvBuffer[index]=null}if(this._vertexNormalBuffer[index]){this._vertexNormalBuffer[index].dispose();this._vertexNormalBuffer[index]=null}if(this._vertexTangentBuffer[index]){this._vertexTangentBuffer[index].dispose();this._vertexTangentBuffer[index]=null}if(this._indexBuffer[index]){this._indexBuffer[index].dispose();this._indexBuffer[index]=null}};Object.defineProperty(SubGeometry.prototype,"vertexStride",{get:function(){return 3},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"vertexTangentStride",{get:function(){return 3},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"vertexNormalStride",{get:function(){return 3},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"UVStride",{get:function(){return 2},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"secondaryUVStride",{get:function(){return 2},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"vertexOffset",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"vertexNormalOffset",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"vertexTangentOffset",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"UVOffset",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(SubGeometry.prototype,"secondaryUVOffset",{get:function(){return 0},enumerable:true,configurable:true});SubGeometry.prototype.cloneWithSeperateBuffers=function(){var obj=this.clone();return obj};return SubGeometry})(away.base.SubGeometryBase);base.SubGeometry=SubGeometry})(away.base||(away.base={}));var base=away.base})(away||(away={}));var away;(function(away){(function(controllers){var ControllerBase=(function(){function ControllerBase(targetObject){if(typeof targetObject==="undefined"){targetObject=null}this._pAutoUpdate=true;this.targetObject=targetObject}ControllerBase.prototype.pNotifyUpdate=function(){if(this._pTargetObject&&this._pTargetObject.iGetImplicitPartition()&&this._pAutoUpdate){this._pTargetObject.iGetImplicitPartition().iMarkForUpdate(this._pTargetObject)}};Object.defineProperty(ControllerBase.prototype,"targetObject",{get:function(){return this._pTargetObject},set:function(val){if(this._pTargetObject==val){return}if(this._pTargetObject&&this._pAutoUpdate){this._pTargetObject._iController=null}this._pTargetObject=val;if(this._pTargetObject&&this._pAutoUpdate){this._pTargetObject._iController=this}this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(ControllerBase.prototype,"autoUpdate",{get:function(){return this._pAutoUpdate},set:function(val){if(this._pAutoUpdate==val){return}this._pAutoUpdate=val;if(this._pTargetObject){if(this._pTargetObject){this._pTargetObject._iController=this}else{this._pTargetObject._iController=null}}},enumerable:true,configurable:true});ControllerBase.prototype.update=function(interpolate){if(typeof interpolate==="undefined"){interpolate=true}throw new away.errors.AbstractMethodError()};return ControllerBase})();controllers.ControllerBase=ControllerBase})(away.controllers||(away.controllers={}));var controllers=away.controllers})(away||(away={}));var away;(function(away){(function(controllers){var LookAtController=(function(_super){__extends(LookAtController,_super);function LookAtController(targetObject,lookAtObject){if(typeof targetObject==="undefined"){targetObject=null}if(typeof lookAtObject==="undefined"){lookAtObject=null}_super.call(this,targetObject);this._pOrigin=new away.geom.Vector3D(0,0,0);if(lookAtObject){this.lookAtObject=lookAtObject}else{this.lookAtPosition=new away.geom.Vector3D()}}Object.defineProperty(LookAtController.prototype,"lookAtPosition",{get:function(){return this._pLookAtPosition},set:function(val){if(this._pLookAtObject){this._pLookAtObject.removeEventListener(away.events.Object3DEvent.SCENETRANSFORM_CHANGED,this.onLookAtObjectChanged,this);this._pLookAtObject=null}this._pLookAtPosition=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(LookAtController.prototype,"lookAtObject",{get:function(){return this._pLookAtObject},set:function(val){if(this._pLookAtPosition){this._pLookAtPosition=null}if(this._pLookAtObject==val){return}if(this._pLookAtObject){this._pLookAtObject.removeEventListener(away.events.Object3DEvent.SCENETRANSFORM_CHANGED,this.onLookAtObjectChanged,this)}this._pLookAtObject=val;if(this._pLookAtObject){this._pLookAtObject.addEventListener(away.events.Object3DEvent.SCENETRANSFORM_CHANGED,this.onLookAtObjectChanged,this)}this.pNotifyUpdate()},enumerable:true,configurable:true});LookAtController.prototype.update=function(interpolate){if(typeof interpolate==="undefined"){interpolate=true}interpolate=interpolate;if(this._pTargetObject){if(this._pLookAtPosition){this._pTargetObject.lookAt(this._pLookAtPosition)}else{if(this._pLookAtObject){this._pTargetObject.lookAt(this._pLookAtObject.scene?this._pLookAtObject.scenePosition:this._pLookAtObject.position)}}}};LookAtController.prototype.onLookAtObjectChanged=function(event){this.pNotifyUpdate()};return LookAtController})(away.controllers.ControllerBase);controllers.LookAtController=LookAtController})(away.controllers||(away.controllers={}));var controllers=away.controllers})(away||(away={}));var away;(function(away){(function(controllers){var HoverController=(function(_super){__extends(HoverController,_super);function HoverController(targetObject,lookAtObject,panAngle,tiltAngle,distance,minTiltAngle,maxTiltAngle,minPanAngle,maxPanAngle,steps,yFactor,wrapPanAngle){if(typeof targetObject==="undefined"){targetObject=null}if(typeof lookAtObject==="undefined"){lookAtObject=null}if(typeof panAngle==="undefined"){panAngle=0}if(typeof tiltAngle==="undefined"){tiltAngle=90}if(typeof distance==="undefined"){distance=1000}if(typeof minTiltAngle==="undefined"){minTiltAngle=-90}if(typeof maxTiltAngle==="undefined"){maxTiltAngle=90}if(typeof minPanAngle==="undefined"){minPanAngle=NaN}if(typeof maxPanAngle==="undefined"){maxPanAngle=NaN}if(typeof steps==="undefined"){steps=8}if(typeof yFactor==="undefined"){yFactor=2}if(typeof wrapPanAngle==="undefined"){wrapPanAngle=false}_super.call(this,targetObject,lookAtObject);this._iCurrentPanAngle=0;this._iCurrentTiltAngle=90;this._panAngle=0;this._tiltAngle=90;this._distance=1000;this._minPanAngle=-Infinity;this._maxPanAngle=Infinity;this._minTiltAngle=-90;this._maxTiltAngle=90;this._steps=8;this._yFactor=2;this._wrapPanAngle=false;this.distance=distance;this.panAngle=panAngle;this.tiltAngle=tiltAngle;this.minPanAngle=minPanAngle||-Infinity;this.maxPanAngle=maxPanAngle||Infinity;this.minTiltAngle=minTiltAngle;this.maxTiltAngle=maxTiltAngle;this.steps=steps;this.yFactor=yFactor;this.wrapPanAngle=wrapPanAngle;this._iCurrentPanAngle=this._panAngle;this._iCurrentTiltAngle=this._tiltAngle}Object.defineProperty(HoverController.prototype,"steps",{get:function(){return this._steps},set:function(val){val=(val<1)?1:val;if(this._steps==val){return}this._steps=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"panAngle",{get:function(){return this._panAngle},set:function(val){val=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,val));if(this._panAngle==val){return}this._panAngle=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(val){val=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,val));if(this._tiltAngle==val){return}this._tiltAngle=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"distance",{get:function(){return this._distance},set:function(val){if(this._distance==val){return}this._distance=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"minPanAngle",{get:function(){return this._minPanAngle},set:function(val){if(this._minPanAngle==val){return}this._minPanAngle=val;this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle))},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"maxPanAngle",{get:function(){return this._maxPanAngle},set:function(val){if(this._maxPanAngle==val){return}this._maxPanAngle=val;this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle))},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(val){if(this._minTiltAngle==val){return}this._minTiltAngle=val;this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle))},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(val){if(this._maxTiltAngle==val){return}this._maxTiltAngle=val;this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle))},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"yFactor",{get:function(){return this._yFactor},set:function(val){if(this._yFactor==val){return}this._yFactor=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(HoverController.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(val){if(this._wrapPanAngle==val){return}this._wrapPanAngle=val;this.pNotifyUpdate()},enumerable:true,configurable:true});HoverController.prototype.update=function(interpolate){if(typeof interpolate==="undefined"){interpolate=true}if(this._tiltAngle!=this._iCurrentTiltAngle||this._panAngle!=this._iCurrentPanAngle){this.pNotifyUpdate();if(this._wrapPanAngle){if(this._panAngle<0){this._iCurrentPanAngle+=this._panAngle%360+360-this._panAngle;this._panAngle=this._panAngle%360+360}else{this._iCurrentPanAngle+=this._panAngle%360-this._panAngle;this._panAngle=this._panAngle%360}while(this._panAngle-this._iCurrentPanAngle<-180){this._iCurrentPanAngle-=360}while(this._panAngle-this._iCurrentPanAngle>180){this._iCurrentPanAngle+=360}}if(interpolate){this._iCurrentTiltAngle+=(this._tiltAngle-this._iCurrentTiltAngle)/(this.steps+1);this._iCurrentPanAngle+=(this._panAngle-this._iCurrentPanAngle)/(this.steps+1)}else{this._iCurrentPanAngle=this._panAngle;this._iCurrentTiltAngle=this._tiltAngle}if((Math.abs(this.tiltAngle-this._iCurrentTiltAngle)<0.01)&&(Math.abs(this._panAngle-this._iCurrentPanAngle)<0.01)){this._iCurrentTiltAngle=this._tiltAngle;this._iCurrentPanAngle=this._panAngle}}var pos=(this.lookAtObject)?this.lookAtObject.position:(this.lookAtPosition)?this.lookAtPosition:this._pOrigin;this.targetObject.x=pos.x+this.distance*Math.sin(this._iCurrentPanAngle*away.math.MathConsts.DEGREES_TO_RADIANS)*Math.cos(this._iCurrentTiltAngle*away.math.MathConsts.DEGREES_TO_RADIANS);this.targetObject.z=pos.z+this.distance*Math.cos(this._iCurrentPanAngle*away.math.MathConsts.DEGREES_TO_RADIANS)*Math.cos(this._iCurrentTiltAngle*away.math.MathConsts.DEGREES_TO_RADIANS);this.targetObject.y=pos.y+this.distance*Math.sin(this._iCurrentTiltAngle*away.math.MathConsts.DEGREES_TO_RADIANS)*this.yFactor;_super.prototype.update.call(this)};return HoverController})(away.controllers.LookAtController);controllers.HoverController=HoverController})(away.controllers||(away.controllers={}));var controllers=away.controllers})(away||(away={}));var away;(function(away){(function(controllers){var FirstPersonController=(function(_super){__extends(FirstPersonController,_super);function FirstPersonController(targetObject,panAngle,tiltAngle,minTiltAngle,maxTiltAngle,steps,wrapPanAngle){if(typeof targetObject==="undefined"){targetObject=null}if(typeof panAngle==="undefined"){panAngle=0}if(typeof tiltAngle==="undefined"){tiltAngle=90}if(typeof minTiltAngle==="undefined"){minTiltAngle=-90}if(typeof maxTiltAngle==="undefined"){maxTiltAngle=90}if(typeof steps==="undefined"){steps=8}if(typeof wrapPanAngle==="undefined"){wrapPanAngle=false}_super.call(this,targetObject);this._iCurrentPanAngle=0;this._iCurrentTiltAngle=90;this._panAngle=0;this._tiltAngle=90;this._minTiltAngle=-90;this._maxTiltAngle=90;this._steps=8;this._walkIncrement=0;this._strafeIncrement=0;this._wrapPanAngle=false;this.fly=false;this.panAngle=panAngle;this.tiltAngle=tiltAngle;this.minTiltAngle=minTiltAngle;this.maxTiltAngle=maxTiltAngle;this.steps=steps;this.wrapPanAngle=wrapPanAngle;this._iCurrentPanAngle=this._panAngle;this._iCurrentTiltAngle=this._tiltAngle}Object.defineProperty(FirstPersonController.prototype,"steps",{get:function(){return this._steps},set:function(val){val=(val<1)?1:val;if(this._steps==val){return}this._steps=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(FirstPersonController.prototype,"panAngle",{get:function(){return this._panAngle},set:function(val){if(this._panAngle==val){return}this._panAngle=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(FirstPersonController.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(val){val=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,val));if(this._tiltAngle==val){return}this._tiltAngle=val;this.pNotifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(FirstPersonController.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(val){if(this._minTiltAngle==val){return}this._minTiltAngle=val;this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle))},enumerable:true,configurable:true});Object.defineProperty(FirstPersonController.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(val){if(this._maxTiltAngle==val){return}this._maxTiltAngle=val;this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle))},enumerable:true,configurable:true});Object.defineProperty(FirstPersonController.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(val){if(this._wrapPanAngle==val){return}this._wrapPanAngle=val;this.pNotifyUpdate()},enumerable:true,configurable:true});FirstPersonController.prototype.update=function(interpolate){if(typeof interpolate==="undefined"){interpolate=true}if(this._tiltAngle!=this._iCurrentTiltAngle||this._panAngle!=this._iCurrentPanAngle){this.pNotifyUpdate();if(this._wrapPanAngle){if(this._panAngle<0){this._iCurrentPanAngle+=this._panAngle%360+360-this._panAngle;this._panAngle=this._panAngle%360+360}else{this._iCurrentPanAngle+=this._panAngle%360-this._panAngle;this._panAngle=this._panAngle%360}while(this._panAngle-this._iCurrentPanAngle<-180){this._iCurrentPanAngle-=360}while(this._panAngle-this._iCurrentPanAngle>180){this._iCurrentPanAngle+=360}}if(interpolate){this._iCurrentTiltAngle+=(this._tiltAngle-this._iCurrentTiltAngle)/(this.steps+1);this._iCurrentPanAngle+=(this._panAngle-this._iCurrentPanAngle)/(this.steps+1)}else{this._iCurrentTiltAngle=this._tiltAngle;this._iCurrentPanAngle=this._panAngle}if((Math.abs(this.tiltAngle-this._iCurrentTiltAngle)<0.01)&&(Math.abs(this._panAngle-this._iCurrentPanAngle)<0.01)){this._iCurrentTiltAngle=this._tiltAngle;this._iCurrentPanAngle=this._panAngle}}this.targetObject.rotationX=this._iCurrentTiltAngle;this.targetObject.rotationY=this._iCurrentPanAngle;if(this._walkIncrement){if(this.fly){this.targetObject.moveForward(this._walkIncrement)}else{this.targetObject.x+=this._walkIncrement*Math.sin(this._panAngle*away.math.MathConsts.DEGREES_TO_RADIANS);this.targetObject.z+=this._walkIncrement*Math.cos(this._panAngle*away.math.MathConsts.DEGREES_TO_RADIANS)}this._walkIncrement=0}if(this._strafeIncrement){this.targetObject.moveRight(this._strafeIncrement);this._strafeIncrement=0}};FirstPersonController.prototype.incrementWalk=function(val){if(val==0){return}this._walkIncrement+=val;this.pNotifyUpdate()};FirstPersonController.prototype.incrementStrafe=function(val){if(val==0){return}this._strafeIncrement+=val;this.pNotifyUpdate()};return FirstPersonController})(away.controllers.ControllerBase);controllers.FirstPersonController=FirstPersonController})(away.controllers||(away.controllers={}));var controllers=away.controllers})(away||(away={}));var away;(function(away){(function(controllers){var FollowController=(function(_super){__extends(FollowController,_super);function FollowController(targetObject,lookAtObject,tiltAngle,distance){if(typeof targetObject==="undefined"){targetObject=null}if(typeof lookAtObject==="undefined"){lookAtObject=null}if(typeof tiltAngle==="undefined"){tiltAngle=45}if(typeof distance==="undefined"){distance=700}_super.call(this,targetObject,lookAtObject,0,tiltAngle,distance)}FollowController.prototype.update=function(interpolate){if(typeof interpolate==="undefined"){interpolate=true}interpolate=interpolate;if(!this.lookAtObject){return}this.panAngle=this._pLookAtObject.rotationY-180;_super.prototype.update.call(this)};return FollowController})(away.controllers.HoverController);controllers.FollowController=FollowController})(away.controllers||(away.controllers={}));var controllers=away.controllers})(away||(away={}));var away;(function(away){(function(controllers){var SpringController=(function(_super){__extends(SpringController,_super);function SpringController(targetObject,lookAtObject,stiffness,mass,damping){if(typeof targetObject==="undefined"){targetObject=null}if(typeof lookAtObject==="undefined"){lookAtObject=null}if(typeof stiffness==="undefined"){stiffness=1}if(typeof mass==="undefined"){mass=40}if(typeof damping==="undefined"){damping=4}_super.call(this,targetObject,lookAtObject);this.positionOffset=new away.geom.Vector3D(0,500,-1000);this.stiffness=stiffness;this.damping=damping;this.mass=mass;this._velocity=new away.geom.Vector3D();this._dv=new away.geom.Vector3D();this._stretch=new away.geom.Vector3D();this._force=new away.geom.Vector3D();this._acceleration=new away.geom.Vector3D();this._desiredPosition=new away.geom.Vector3D()}SpringController.prototype.update=function(interpolate){if(typeof interpolate==="undefined"){interpolate=true}interpolate=interpolate;var offs;if(!this._pLookAtObject||!this._pTargetObject){return}offs=this._pLookAtObject.transform.deltaTransformVector(this.positionOffset);this._desiredPosition.x=this._pLookAtObject.x+offs.x;this._desiredPosition.y=this._pLookAtObject.y+offs.y;this._desiredPosition.z=this._pLookAtObject.z+offs.z;this._stretch.x=this._pTargetObject.x-this._desiredPosition.x;this._stretch.y=this._pTargetObject.y-this._desiredPosition.y;this._stretch.z=this._pTargetObject.z-this._desiredPosition.z;this._stretch.scaleBy(-this.stiffness);this._dv.copyFrom(this._velocity);this._dv.scaleBy(this.damping);this._force.x=this._stretch.x-this._dv.x;this._force.y=this._stretch.y-this._dv.y;this._force.z=this._stretch.z-this._dv.z;this._acceleration.copyFrom(this._force);this._acceleration.scaleBy(1/this.mass);this._velocity.x+=this._acceleration.x;this._velocity.y+=this._acceleration.y;this._velocity.z+=this._acceleration.z;this._pTargetObject.x+=this._velocity.x;this._pTargetObject.y+=this._velocity.y;this._pTargetObject.z+=this._velocity.z;_super.prototype.update.call(this)};return SpringController})(controllers.LookAtController);controllers.SpringController=SpringController})(away.controllers||(away.controllers={}));var controllers=away.controllers})(away||(away={}));var away;(function(away){(function(lights){var LightBase=(function(_super){__extends(LightBase,_super);function LightBase(){_super.call(this);this._color=16777215;this._colorR=1;this._colorG=1;this._colorB=1;this._ambientColor=16777215;this._ambient=0;this._iAmbientR=0;this._iAmbientG=0;this._iAmbientB=0;this._specular=1;this._iSpecularR=1;this._iSpecularG=1;this._iSpecularB=1;this._diffuse=1;this._iDiffuseR=1;this._iDiffuseG=1;this._iDiffuseB=1;this._castsShadows=false}Object.defineProperty(LightBase.prototype,"castsShadows",{get:function(){return this._castsShadows},set:function(value){if(this._castsShadows==value){return}this._castsShadows=value;if(value){if(this._shadowMapper==null){this._shadowMapper=this.pCreateShadowMapper()}this._shadowMapper.light=this}else{this._shadowMapper.dispose();this._shadowMapper=null}this.dispatchEvent(new away.events.LightEvent(away.events.LightEvent.CASTS_SHADOW_CHANGE))},enumerable:true,configurable:true});LightBase.prototype.pCreateShadowMapper=function(){throw new away.errors.AbstractMethodError()};Object.defineProperty(LightBase.prototype,"specular",{get:function(){return this._specular},set:function(value){if(value<0){value=0}this._specular=value;this.updateSpecular()},enumerable:true,configurable:true});Object.defineProperty(LightBase.prototype,"diffuse",{get:function(){return this._diffuse},set:function(value){if(value<0){value=0}this._diffuse=value;this.updateDiffuse()},enumerable:true,configurable:true});Object.defineProperty(LightBase.prototype,"color",{get:function(){return this._color},set:function(value){this._color=value;this._colorR=((this._color>>16)&255)/255;this._colorG=((this._color>>8)&255)/255;this._colorB=(this._color&255)/255;this.updateDiffuse();this.updateSpecular()},enumerable:true,configurable:true});Object.defineProperty(LightBase.prototype,"ambient",{get:function(){return this._ambient},set:function(value){if(value<0){value=0}else{if(value>1){value=1}}this._ambient=value;this.updateAmbient()},enumerable:true,configurable:true});Object.defineProperty(LightBase.prototype,"ambientColor",{get:function(){return this._ambientColor},set:function(value){this._ambientColor=value;this.updateAmbient()},enumerable:true,configurable:true});LightBase.prototype.updateAmbient=function(){this._iAmbientR=((this._ambientColor>>16)&255)/255*this._ambient;this._iAmbientG=((this._ambientColor>>8)&255)/255*this._ambient;this._iAmbientB=(this._ambientColor&255)/255*this._ambient};LightBase.prototype.iGetObjectProjectionMatrix=function(renderable,target){if(typeof target==="undefined"){target=null}throw new away.errors.AbstractMethodError()};LightBase.prototype.pCreateEntityPartitionNode=function(){return new away.partition.LightNode(this)};Object.defineProperty(LightBase.prototype,"assetType",{get:function(){return away.library.AssetType.LIGHT},enumerable:true,configurable:true});LightBase.prototype.updateSpecular=function(){this._iSpecularR=this._colorR*this._specular;this._iSpecularG=this._colorG*this._specular;this._iSpecularB=this._colorB*this._specular};LightBase.prototype.updateDiffuse=function(){this._iDiffuseR=this._colorR*this._diffuse;this._iDiffuseG=this._colorG*this._diffuse;this._iDiffuseB=this._colorB*this._diffuse};Object.defineProperty(LightBase.prototype,"shadowMapper",{get:function(){return this._shadowMapper},set:function(value){this._shadowMapper=value;this._shadowMapper.light=this},enumerable:true,configurable:true});return LightBase})(away.entities.Entity);lights.LightBase=LightBase})(away.lights||(away.lights={}));var lights=away.lights})(away||(away={}));var away;(function(away){(function(lights){var PointLight=(function(_super){__extends(PointLight,_super);function PointLight(){_super.call(this);this._pRadius=90000;this._pFallOff=100000;this._pFallOffFactor=1/(this._pFallOff*this._pFallOff-this._pRadius*this._pRadius)}PointLight.prototype.pCreateShadowMapper=function(){return new away.lights.CubeMapShadowMapper()};PointLight.prototype.pCreateEntityPartitionNode=function(){return new away.partition.PointLightNode(this)};Object.defineProperty(PointLight.prototype,"radius",{get:function(){return this._pRadius},set:function(value){this._pRadius=value;if(this._pRadius<0){this._pRadius=0}else{if(this._pRadius>this._pFallOff){this._pFallOff=this._pRadius;this.pInvalidateBounds()}}this._pFallOffFactor=1/(this._pFallOff*this._pFallOff-this._pRadius*this._pRadius)},enumerable:true,configurable:true});PointLight.prototype.iFallOffFactor=function(){return this._pFallOffFactor};Object.defineProperty(PointLight.prototype,"fallOff",{get:function(){return this._pFallOff},set:function(value){this._pFallOff=value;if(this._pFallOff<0){this._pFallOff=0}if(this._pFallOff<this._pRadius){this._pRadius=this._pFallOff}this._pFallOffFactor=1/(this._pFallOff*this._pFallOff-this._pRadius*this._pRadius);this.pInvalidateBounds()},enumerable:true,configurable:true});PointLight.prototype.pUpdateBounds=function(){this._pBounds.fromSphere(new away.geom.Vector3D(),this._pFallOff);this._pBoundsInvalid=false};PointLight.prototype.pGetDefaultBoundingVolume=function(){return new away.bounds.BoundingSphere()};PointLight.prototype.iGetObjectProjectionMatrix=function(renderable,target){if(typeof target==="undefined"){target=null}var raw=[];var bounds=renderable.sourceEntity.bounds;var m=new away.geom.Matrix3D();m.copyFrom(renderable.sceneTransform);m.append(this._pParent.inverseSceneTransform);this.lookAt(m.position);m.copyFrom(renderable.sceneTransform);m.append(this.inverseSceneTransform);m.copyColumnTo(3,this._pPos);var v1=m.deltaTransformVector(bounds.min);var v2=m.deltaTransformVector(bounds.max);var z=this._pPos.z;var d1=v1.x*v1.x+v1.y*v1.y+v1.z*v1.z;var d2=v2.x*v2.x+v2.y*v2.y+v2.z*v2.z;var d=Math.sqrt(d1>d2?d1:d2);var zMin;var zMax;zMin=z-d;zMax=z+d;raw[5]=raw[0]=zMin/d;raw[10]=zMax/(zMax-zMin);raw[11]=1;raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[8]=raw[9]=raw[12]=raw[13]=raw[15]=0;raw[14]=-zMin*raw[10];if(!target){target=new away.geom.Matrix3D()}target.copyRawDataFrom(raw);target.prepend(m);return target};return PointLight})(away.lights.LightBase);lights.PointLight=PointLight})(away.lights||(away.lights={}));var lights=away.lights})(away||(away={}));var away;(function(away){(function(lights){var DirectionalLight=(function(_super){__extends(DirectionalLight,_super);function DirectionalLight(xDir,yDir,zDir){if(typeof xDir==="undefined"){xDir=0}if(typeof yDir==="undefined"){yDir=-1}if(typeof zDir==="undefined"){zDir=1}_super.call(this);this.direction=new away.geom.Vector3D(xDir,yDir,zDir);this._sceneDirection=new away.geom.Vector3D()}DirectionalLight.prototype.pCreateEntityPartitionNode=function(){return new away.partition.DirectionalLightNode(this)};Object.defineProperty(DirectionalLight.prototype,"sceneDirection",{get:function(){if(this._pSceneTransformDirty){this.pUpdateSceneTransform()}return this._sceneDirection},enumerable:true,configurable:true});Object.defineProperty(DirectionalLight.prototype,"direction",{get:function(){return this._direction},set:function(value){this._direction=value;if(!this._tmpLookAt){this._tmpLookAt=new away.geom.Vector3D()}this._tmpLookAt.x=this.x+this._direction.x;this._tmpLookAt.y=this.y+this._direction.y;this._tmpLookAt.z=this.z+this._direction.z;this.lookAt(this._tmpLookAt)},enumerable:true,configurable:true});DirectionalLight.prototype.pGetDefaultBoundingVolume=function(){return new away.bounds.NullBounds()};DirectionalLight.prototype.pUpdateBounds=function(){};DirectionalLight.prototype.pUpdateSceneTransform=function(){_super.prototype.pUpdateSceneTransform.call(this);this.sceneTransform.copyColumnTo(2,this._sceneDirection);this._sceneDirection.normalize()};DirectionalLight.prototype.pCreateShadowMapper=function(){return new away.lights.DirectionalShadowMapper()};DirectionalLight.prototype.iGetObjectProjectionMatrix=function(renderable,target){if(typeof target==="undefined"){target=null}var raw=[];var bounds=renderable.sourceEntity.bounds;var m=new away.geom.Matrix3D();m.copyFrom(renderable.sceneTransform);m.append(this.inverseSceneTransform);if(!this._projAABBPoints){this._projAABBPoints=[]}m.transformVectors(bounds.aabbPoints,this._projAABBPoints);var xMin=Infinity,xMax=-Infinity;var yMin=Infinity,yMax=-Infinity;var zMin=Infinity,zMax=-Infinity;var d;for(var i=0;i<24;){d=this._projAABBPoints[i++];if(d<xMin){xMin=d}if(d>xMax){xMax=d}d=this._projAABBPoints[i++];if(d<yMin){yMin=d}if(d>yMax){yMax=d}d=this._projAABBPoints[i++];if(d<zMin){zMin=d}if(d>zMax){zMax=d}}var invXRange=1/(xMax-xMin);var invYRange=1/(yMax-yMin);var invZRange=1/(zMax-zMin);raw[0]=2*invXRange;raw[5]=2*invYRange;raw[10]=invZRange;raw[12]=-(xMax+xMin)*invXRange;raw[13]=-(yMax+yMin)*invYRange;raw[14]=-zMin*invZRange;raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[8]=raw[9]=raw[11]=0;raw[15]=1;if(!target){target=new away.geom.Matrix3D()}target.copyRawDataFrom(raw);target.prepend(m);return target};return DirectionalLight})(away.lights.LightBase);lights.DirectionalLight=DirectionalLight})(away.lights||(away.lights={}));var lights=away.lights})(away||(away={}));var away;(function(away){(function(lights){var LightProbe=(function(_super){__extends(LightProbe,_super);function LightProbe(diffuseMap,specularMap){if(typeof specularMap==="undefined"){specularMap=null}_super.call(this);this._diffuseMap=diffuseMap;this._specularMap=specularMap}LightProbe.prototype.pCreateEntityPartitionNode=function(){return new away.partition.LightProbeNode(this)};Object.defineProperty(LightProbe.prototype,"diffuseMap",{get:function(){return this._diffuseMap},set:function(value){this._diffuseMap=value},enumerable:true,configurable:true});Object.defineProperty(LightProbe.prototype,"specularMap",{get:function(){return this._specularMap},set:function(value){this._specularMap=value},enumerable:true,configurable:true});LightProbe.prototype.pUpdateBounds=function(){this._pBoundsInvalid=false};LightProbe.prototype.pGetDefaultBoundingVolume=function(){return new away.bounds.NullBounds()};LightProbe.prototype.iGetObjectProjectionMatrix=function(renderable,target){if(typeof target==="undefined"){target=null}renderable=renderable;target=target;throw new away.errors.Error("Object projection matrices are not supported for LightProbe objects!");return null};return LightProbe})(away.lights.LightBase);lights.LightProbe=LightProbe})(away.lights||(away.lights={}));var lights=away.lights})(away||(away={}));var away;(function(away){(function(lights){var ShadowMapperBase=(function(){function ShadowMapperBase(){this._pDepthMapSize=2048;this._autoUpdateShadows=true;this._pCasterCollector=this.pCreateCasterCollector()}ShadowMapperBase.prototype.pCreateCasterCollector=function(){return new away.traverse.ShadowCasterCollector()};Object.defineProperty(ShadowMapperBase.prototype,"autoUpdateShadows",{get:function(){return this._autoUpdateShadows},set:function(value){this._autoUpdateShadows=value},enumerable:true,configurable:true});ShadowMapperBase.prototype.updateShadows=function(){this._iShadowsInvalid=true};ShadowMapperBase.prototype.iSetDepthMap=function(depthMap){if(this._depthMap==depthMap){return}if(this._depthMap&&!this._explicitDepthMap){this._depthMap.dispose()}this._depthMap=depthMap;if(this._depthMap){this._explicitDepthMap=true;this._pDepthMapSize=this._depthMap.width}else{this._explicitDepthMap=false}};Object.defineProperty(ShadowMapperBase.prototype,"light",{get:function(){return this._pLight},set:function(value){this._pLight=value},enumerable:true,configurable:true});Object.defineProperty(ShadowMapperBase.prototype,"depthMap",{get:function(){if(!this._depthMap){this._depthMap=this.pCreateDepthTexture()}return this._depthMap},enumerable:true,configurable:true});Object.defineProperty(ShadowMapperBase.prototype,"depthMapSize",{get:function(){return this._pDepthMapSize},set:function(value){if(value==this._pDepthMapSize){return}this._pDepthMapSize=value;if(this._explicitDepthMap){throw Error("Cannot set depth map size for the current renderer.")}else{if(this._depthMap){this._depthMap.dispose();this._depthMap=null}}},enumerable:true,configurable:true});ShadowMapperBase.prototype.dispose=function(){this._pCasterCollector=null;if(this._depthMap&&!this._explicitDepthMap){this._depthMap.dispose()}this._depthMap=null};ShadowMapperBase.prototype.pCreateDepthTexture=function(){return new away.textures.RenderTexture(this._pDepthMapSize,this._pDepthMapSize)};ShadowMapperBase.prototype.iRenderDepthMap=function(stage3DProxy,entityCollector,renderer){this._iShadowsInvalid=false;this.pUpdateDepthProjection(entityCollector.camera);if(!this._depthMap){this._depthMap=this.pCreateDepthTexture()}this.pDrawDepthMap(this._depthMap.getTextureForStage3D(stage3DProxy),entityCollector.scene,renderer)};ShadowMapperBase.prototype.pUpdateDepthProjection=function(viewCamera){throw new away.errors.AbstractMethodError()};ShadowMapperBase.prototype.pDrawDepthMap=function(target,scene,renderer){throw new away.errors.AbstractMethodError()};return ShadowMapperBase})();lights.ShadowMapperBase=ShadowMapperBase})(away.lights||(away.lights={}));var lights=away.lights})(away||(away={}));var away;(function(away){(function(lights){var CubeMapShadowMapper=(function(_super){__extends(CubeMapShadowMapper,_super);function CubeMapShadowMapper(){_super.call(this);this._pDepthMapSize=512;this._needsRender=[];this.initCameras()}CubeMapShadowMapper.prototype.initCameras=function(){this._depthCameras=[];this._lenses=[];this.addCamera(0,90,0);this.addCamera(0,-90,0);this.addCamera(-90,0,0);this.addCamera(90,0,0);this.addCamera(0,0,0);this.addCamera(0,180,0)};CubeMapShadowMapper.prototype.addCamera=function(rotationX,rotationY,rotationZ){var cam=new away.cameras.Camera3D();cam.rotationX=rotationX;cam.rotationY=rotationY;cam.rotationZ=rotationZ;cam.lens.near=0.01;var lens=cam.lens;lens.fieldOfView=90;this._lenses.push(lens);cam.lens.iAspectRatio=1;this._depthCameras.push(cam)};CubeMapShadowMapper.prototype.pCreateDepthTexture=function(){throw new away.errors.PartialImplementationError()};CubeMapShadowMapper.prototype.pUpdateDepthProjection=function(viewCamera){var light=(this._pLight);var maxDistance=light._pFallOff;var pos=this._pLight.scenePosition;for(var i=0;i<6;++i){this._lenses[i].far=maxDistance;this._depthCameras[i].position=pos;this._needsRender[i]=true}};CubeMapShadowMapper.prototype.pDrawDepthMap=function(target,scene,renderer){for(var i=0;i<6;++i){if(this._needsRender[i]){this._pCasterCollector.camera=this._depthCameras[i];this._pCasterCollector.clear();scene.traversePartitions(this._pCasterCollector);renderer.iRender(this._pCasterCollector,target,null,i);this._pCasterCollector.cleanUp()}}};return CubeMapShadowMapper})(away.lights.ShadowMapperBase);lights.CubeMapShadowMapper=CubeMapShadowMapper})(away.lights||(away.lights={}));var lights=away.lights})(away||(away={}));var away;(function(away){(function(lights){var DirectionalShadowMapper=(function(_super){__extends(DirectionalShadowMapper,_super);function DirectionalShadowMapper(){_super.call(this);this._pLightOffset=10000;this._pSnap=64;this._pCullPlanes=[];this._pOverallDepthLens=new away.cameras.FreeMatrixLens();this._pOverallDepthCamera=new away.cameras.Camera3D(this._pOverallDepthLens);this._pLocalFrustum=[];this._pMatrix=new away.geom.Matrix3D()}Object.defineProperty(DirectionalShadowMapper.prototype,"snap",{get:function(){return this._pSnap},set:function(value){this._pSnap=value},enumerable:true,configurable:true});Object.defineProperty(DirectionalShadowMapper.prototype,"lightOffset",{get:function(){return this._pLightOffset},set:function(value){this._pLightOffset=value},enumerable:true,configurable:true});Object.defineProperty(DirectionalShadowMapper.prototype,"iDepthProjection",{get:function(){return this._pOverallDepthCamera.viewProjection},enumerable:true,configurable:true});Object.defineProperty(DirectionalShadowMapper.prototype,"depth",{get:function(){return this._pMaxZ-this._pMinZ},enumerable:true,configurable:true});DirectionalShadowMapper.prototype.pDrawDepthMap=function(target,scene,renderer){this._pCasterCollector.camera=this._pOverallDepthCamera;this._pCasterCollector.cullPlanes=this._pCullPlanes;this._pCasterCollector.clear();scene.traversePartitions(this._pCasterCollector);renderer.iRender(this._pCasterCollector,target);this._pCasterCollector.cleanUp()};DirectionalShadowMapper.prototype.pUpdateCullPlanes=function(viewCamera){var lightFrustumPlanes=this._pOverallDepthCamera.frustumPlanes;var viewFrustumPlanes=viewCamera.frustumPlanes;this._pCullPlanes.length=4;this._pCullPlanes[0]=lightFrustumPlanes[0];this._pCullPlanes[1]=lightFrustumPlanes[1];this._pCullPlanes[2]=lightFrustumPlanes[2];this._pCullPlanes[3]=lightFrustumPlanes[3];var light=this._pLight;var dir=light.sceneDirection;var dirX=dir.x;var dirY=dir.y;var dirZ=dir.z;var j=4;for(var i=0;i<6;++i){var plane=viewFrustumPlanes[i];if(plane.a*dirX+plane.b*dirY+plane.c*dirZ<0){this._pCullPlanes[j++]=plane}}};DirectionalShadowMapper.prototype.pUpdateDepthProjection=function(viewCamera){this.pUpdateProjectionFromFrustumCorners(viewCamera,viewCamera.lens.frustumCorners,this._pMatrix);this._pOverallDepthLens.matrix=this._pMatrix;this.pUpdateCullPlanes(viewCamera)};DirectionalShadowMapper.prototype.pUpdateProjectionFromFrustumCorners=function(viewCamera,corners,matrix){var raw=[];var dir;var x,y,z;var minX,minY;var maxX,maxY;var i;var light=this._pLight;dir=light.sceneDirection;this._pOverallDepthCamera.transform=this._pLight.sceneTransform;x=Math.floor((viewCamera.x-dir.x*this._pLightOffset)/this._pSnap)*this._pSnap;y=Math.floor((viewCamera.y-dir.y*this._pLightOffset)/this._pSnap)*this._pSnap;z=Math.floor((viewCamera.z-dir.z*this._pLightOffset)/this._pSnap)*this._pSnap;this._pOverallDepthCamera.x=x;this._pOverallDepthCamera.y=y;this._pOverallDepthCamera.z=z;this._pMatrix.copyFrom(this._pOverallDepthCamera.inverseSceneTransform);this._pMatrix.prepend(viewCamera.sceneTransform);this._pMatrix.transformVectors(corners,this._pLocalFrustum);minX=maxX=this._pLocalFrustum[0];minY=maxY=this._pLocalFrustum[1];this._pMaxZ=this._pLocalFrustum[2];i=3;while(i<24){x=this._pLocalFrustum[i];y=this._pLocalFrustum[i+1];z=this._pLocalFrustum[i+2];if(x<minX){minX=x}if(x>maxX){maxX=x}if(y<minY){minY=y}if(y>maxY){maxY=y}if(z>this._pMaxZ){this._pMaxZ=z}i+=3}this._pMinZ=1;var w=maxX-minX;var h=maxY-minY;var d=1/(this._pMaxZ-this._pMinZ);if(minX<0){minX-=this._pSnap}if(minY<0){minY-=this._pSnap}minX=Math.floor(minX/this._pSnap)*this._pSnap;minY=Math.floor(minY/this._pSnap)*this._pSnap;var snap2=2*this._pSnap;w=Math.floor(w/snap2+2)*snap2;h=Math.floor(h/snap2+2)*snap2;maxX=minX+w;maxY=minY+h;w=1/w;h=1/h;raw[0]=2*w;raw[5]=2*h;raw[10]=d;raw[12]=-(maxX+minX)*w;raw[13]=-(maxY+minY)*h;raw[14]=-this._pMinZ*d;raw[15]=1;raw[1]=raw[2]=raw[3]=raw[4]=raw[6]=raw[7]=raw[8]=raw[9]=raw[11]=0;matrix.copyRawDataFrom(raw)};return DirectionalShadowMapper})(away.lights.ShadowMapperBase);lights.DirectionalShadowMapper=DirectionalShadowMapper})(away.lights||(away.lights={}));var lights=away.lights})(away||(away={}));var away;(function(away){(function(data){var RenderableListItem=(function(){function RenderableListItem(){}return RenderableListItem})();data.RenderableListItem=RenderableListItem})(away.data||(away.data={}));var data=away.data})(away||(away={}));var away;(function(away){(function(data){var EntityListItem=(function(){function EntityListItem(){}return EntityListItem})();data.EntityListItem=EntityListItem})(away.data||(away.data={}));var data=away.data})(away||(away={}));var away;(function(away){(function(data){var EntityListItemPool=(function(){function EntityListItemPool(){this._index=0;this._poolSize=0;this._pool=[]}EntityListItemPool.prototype.getItem=function(){var item;if(this._index==this._poolSize){item=new away.data.EntityListItem();this._pool[this._index++]=item;++this._poolSize}else{item=this._pool[this._index++]}return item};EntityListItemPool.prototype.freeAll=function(){this._index=0};EntityListItemPool.prototype.dispose=function(){this._pool.length=0};return EntityListItemPool})();data.EntityListItemPool=EntityListItemPool})(away.data||(away.data={}));var data=away.data})(away||(away={}));var away;(function(away){(function(data){var RenderableListItemPool=(function(){function RenderableListItemPool(){this._index=0;this._poolSize=0;this._pool=[]}RenderableListItemPool.prototype.getItem=function(){if(this._index==this._poolSize){var item=new away.data.RenderableListItem();this._pool[this._index++]=item;++this._poolSize;return item}else{return this._pool[this._index++]}};RenderableListItemPool.prototype.freeAll=function(){this._index=0};RenderableListItemPool.prototype.dispose=function(){this._pool.length=0};return RenderableListItemPool})();data.RenderableListItemPool=RenderableListItemPool})(away.data||(away.data={}));var data=away.data})(away||(away={}));var away;(function(away){(function(traverse){var PartitionTraverser=(function(){function PartitionTraverser(){}PartitionTraverser.prototype.enterNode=function(node){node=node;return true};PartitionTraverser.prototype.applySkyBox=function(renderable){throw new away.errors.AbstractMethodError()};PartitionTraverser.prototype.applyRenderable=function(renderable){throw new away.errors.AbstractMethodError()};PartitionTraverser.prototype.applyUnknownLight=function(light){throw new away.errors.AbstractMethodError()};PartitionTraverser.prototype.applyDirectionalLight=function(light){throw new away.errors.AbstractMethodError()};PartitionTraverser.prototype.applyPointLight=function(light){throw new away.errors.AbstractMethodError()};PartitionTraverser.prototype.applyLightProbe=function(light){throw new away.errors.AbstractMethodError()};PartitionTraverser.prototype.applyEntity=function(entity){throw new away.errors.AbstractMethodError()};Object.defineProperty(PartitionTraverser.prototype,"entryPoint",{get:function(){return this._iEntryPoint},enumerable:true,configurable:true});PartitionTraverser._iCollectionMark=0;return PartitionTraverser})();traverse.PartitionTraverser=PartitionTraverser})(away.traverse||(away.traverse={}));var traverse=away.traverse})(away||(away={}));var away;(function(away){(function(traverse){var EntityCollector=(function(_super){__extends(EntityCollector,_super);function EntityCollector(){_super.call(this);this._pNumEntities=0;this._pNumLights=0;this._pNumTriangles=0;this._pNumMouseEnableds=0;this._numDirectionalLights=0;this._numPointLights=0;this._numLightProbes=0;this._numCullPlanes=0;this.init()}EntityCollector.prototype.init=function(){this._pLights=[];this._directionalLights=[];this._pointLights=[];this._lightProbes=[];this._pRenderableListItemPool=new away.data.RenderableListItemPool();this._pEntityListItemPool=new away.data.EntityListItemPool()};Object.defineProperty(EntityCollector.prototype,"camera",{get:function(){return this._pCamera},set:function(value){this._pCamera=value;this._iEntryPoint=this._pCamera.scenePosition;this._pCameraForward=this._pCamera.forwardVector;this._cullPlanes=this._pCamera.frustumPlanes},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"cullPlanes",{get:function(){return this._customCullPlanes},set:function(value){this._customCullPlanes=value},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"numMouseEnableds",{get:function(){return this._pNumMouseEnableds},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"skyBox",{get:function(){return this._pSkyBox},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"opaqueRenderableHead",{get:function(){return this._pOpaqueRenderableHead},set:function(value){this._pOpaqueRenderableHead=value},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"blendedRenderableHead",{get:function(){return this._pBlendedRenderableHead},set:function(value){this._pBlendedRenderableHead=value},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"entityHead",{get:function(){return this._entityHead},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"lights",{get:function(){return this._pLights},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"directionalLights",{get:function(){return this._directionalLights},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"pointLights",{get:function(){return this._pointLights},enumerable:true,configurable:true});Object.defineProperty(EntityCollector.prototype,"lightProbes",{get:function(){return this._lightProbes},enumerable:true,configurable:true});EntityCollector.prototype.clear=function(){this._cullPlanes=this._customCullPlanes?this._customCullPlanes:(this._pCamera?this._pCamera.frustumPlanes:null);this._numCullPlanes=this._cullPlanes?this._cullPlanes.length:0;this._pNumTriangles=this._pNumMouseEnableds=0;this._pBlendedRenderableHead=null;this._pOpaqueRenderableHead=null;this._entityHead=null;this._pRenderableListItemPool.freeAll();this._pEntityListItemPool.freeAll();this._pSkyBox=null;if(this._pNumLights>0){this._pLights.length=this._pNumLights=0}if(this._numDirectionalLights>0){this._directionalLights.length=this._numDirectionalLights=0}if(this._numPointLights>0){this._pointLights.length=this._numPointLights=0}if(this._numLightProbes>0){this._lightProbes.length=this._numLightProbes=0}};EntityCollector.prototype.enterNode=function(node){var enter=away.traverse.PartitionTraverser._iCollectionMark!=node._iCollectionMark&&node.isInFrustum(this._cullPlanes,this._numCullPlanes);node._iCollectionMark=away.traverse.PartitionTraverser._iCollectionMark;return enter};EntityCollector.prototype.applySkyBox=function(renderable){this._pSkyBox=renderable};EntityCollector.prototype.applyRenderable=function(renderable){var material;var entity=renderable.sourceEntity;if(renderable.mouseEnabled){++this._pNumMouseEnableds}this._pNumTriangles+=renderable.numTriangles;material=renderable.material;if(material){var item=this._pRenderableListItemPool.getItem();item.renderable=renderable;item.materialId=material._iUniqueId;item.renderOrderId=material._iRenderOrderId;item.cascaded=false;var dx=this._iEntryPoint.x-entity.x;var dy=this._iEntryPoint.y-entity.y;var dz=this._iEntryPoint.z-entity.z;item.zIndex=dx*this._pCameraForward.x+dy*this._pCameraForward.y+dz*this._pCameraForward.z+entity.zOffset;item.renderSceneTransform=renderable.getRenderSceneTransform(this._pCamera);if(material.requiresBlending){item.next=this._pBlendedRenderableHead;this._pBlendedRenderableHead=item}else{item.next=this._pOpaqueRenderableHead;this._pOpaqueRenderableHead=item}}};EntityCollector.prototype.applyEntity=function(entity){++this._pNumEntities;var item=this._pEntityListItemPool.getItem();item.entity=entity;item.next=this._entityHead;this._entityHead=item};EntityCollector.prototype.applyUnknownLight=function(light){this._pLights[this._pNumLights++]=light};EntityCollector.prototype.applyDirectionalLight=function(light){this._pLights[this._pNumLights++]=light;this._directionalLights[this._numDirectionalLights++]=light};EntityCollector.prototype.applyPointLight=function(light){this._pLights[this._pNumLights++]=light;this._pointLights[this._numPointLights++]=light};EntityCollector.prototype.applyLightProbe=function(light){this._pLights[this._pNumLights++]=light;this._lightProbes[this._numLightProbes++]=light};EntityCollector.prototype.cleanUp=function(){};return EntityCollector})(away.traverse.PartitionTraverser);traverse.EntityCollector=EntityCollector})(away.traverse||(away.traverse={}));var traverse=away.traverse})(away||(away={}));var away;(function(away){(function(traverse){var ShadowCasterCollector=(function(_super){__extends(ShadowCasterCollector,_super);function ShadowCasterCollector(){_super.call(this)}ShadowCasterCollector.prototype.applyRenderable=function(renderable){var material=renderable.material;var entity=renderable.sourceEntity;if(renderable.castsShadows&&material){var item=this._pRenderableListItemPool.getItem();item.renderable=renderable;item.next=this._pOpaqueRenderableHead;item.cascaded=false;var dx=this._iEntryPoint.x-entity.x;var dy=this._iEntryPoint.y-entity.y;var dz=this._iEntryPoint.z-entity.z;item.zIndex=dx*this._pCameraForward.x+dy*this._pCameraForward.y+dz*this._pCameraForward.z;item.renderSceneTransform=renderable.getRenderSceneTransform(this._pCamera);item.renderOrderId=material._iDepthPassId;this._pOpaqueRenderableHead=item}};ShadowCasterCollector.prototype.applyUnknownLight=function(light){};ShadowCasterCollector.prototype.applyDirectionalLight=function(light){};ShadowCasterCollector.prototype.applyPointLight=function(light){};ShadowCasterCollector.prototype.applyLightProbe=function(light){};ShadowCasterCollector.prototype.applySkyBox=function(renderable){};return ShadowCasterCollector})(away.traverse.EntityCollector);traverse.ShadowCasterCollector=ShadowCasterCollector})(away.traverse||(away.traverse={}));var traverse=away.traverse})(away||(away={}));var away;(function(away){(function(traverse){var RaycastCollector=(function(_super){__extends(RaycastCollector,_super);function RaycastCollector(){_super.call(this);this._rayPosition=new away.geom.Vector3D();this._rayDirection=new away.geom.Vector3D()}Object.defineProperty(RaycastCollector.prototype,"rayPosition",{get:function(){return this._rayPosition},set:function(value){this._rayPosition=value},enumerable:true,configurable:true});Object.defineProperty(RaycastCollector.prototype,"rayDirection",{get:function(){return this._rayDirection},set:function(value){this._rayDirection=value},enumerable:true,configurable:true});RaycastCollector.prototype.enterNode=function(node){return node.isIntersectingRay(this._rayPosition,this._rayDirection)};RaycastCollector.prototype.applySkyBox=function(renderable){};RaycastCollector.prototype.applyRenderable=function(renderable){};RaycastCollector.prototype.applyUnknownLight=function(light){};return RaycastCollector})(away.traverse.EntityCollector);traverse.RaycastCollector=RaycastCollector})(away.traverse||(away.traverse={}));var traverse=away.traverse})(away||(away={}));var away;(function(away){(function(partition){var RenderableNode=(function(_super){__extends(RenderableNode,_super);function RenderableNode(renderable){var e=renderable;_super.call(this,e);this._renderable=renderable}RenderableNode.prototype.acceptTraverser=function(traverser){if(traverser.enterNode(this)){_super.prototype.acceptTraverser.call(this,traverser);traverser.applyRenderable(this._renderable)}};return RenderableNode})(partition.EntityNode);partition.RenderableNode=RenderableNode})(away.partition||(away.partition={}));var partition=away.partition})(away||(away={}));var away;(function(away){(function(pick){var ShaderPicker=(function(){function ShaderPicker(){this._onlyMouseEnabled=true;this._interactives=new Array();this._localHitPosition=new away.geom.Vector3D();this._hitUV=new away.geom.Point();this._localHitNormal=new away.geom.Vector3D();this._rayPos=new away.geom.Vector3D();this._rayDir=new away.geom.Vector3D();this._id=new Array(4);this._viewportData=new Array(4);this._boundOffsetScale=new Array(8);this._boundOffsetScale[3]=0;this._boundOffsetScale[7]=1}Object.defineProperty(ShaderPicker.prototype,"onlyMouseEnabled",{get:function(){return this._onlyMouseEnabled},set:function(value){this._onlyMouseEnabled=value},enumerable:true,configurable:true});ShaderPicker.prototype.getViewCollision=function(x,y,view){away.Debug.throwPIR("ShaderPicker","getViewCollision","implement");return null;var collector=view.iEntityCollector;this._stage3DProxy=view.stage3DProxy;if(!this._stage3DProxy){return null}this._context=this._stage3DProxy._iContext3D;this._viewportData[0]=view.width;this._viewportData[1]=view.height;this._viewportData[2]=-(this._projX=2*x/view.width-1);this._viewportData[3]=this._projY=2*y/view.height-1;this._potentialFound=false;this.pDraw(collector,null);this._context.setVertexBufferAt(0,null);if(!this._context||!this._potentialFound){return null}if(!this._bitmapData){this._bitmapData=new away.display.BitmapData(1,1,false,0)}this._context.drawToBitmapData(this._bitmapData);this._hitColor=this._bitmapData.getPixel(0,0);if(!this._hitColor){this._context.present();return null}this._hitRenderable=this._interactives[this._hitColor-1];this._hitEntity=this._hitRenderable.sourceEntity;if(this._onlyMouseEnabled&&(!this._hitEntity._iAncestorsAllowMouseEnabled||!this._hitEntity.mouseEnabled)){return null}var _collisionVO=this._hitEntity.pickingCollisionVO;if(this._hitRenderable.shaderPickingDetails){this.getHitDetails(view.camera);_collisionVO.localPosition=this._localHitPosition;_collisionVO.localNormal=this._localHitNormal;_collisionVO.uv=this._hitUV;_collisionVO.index=this._faceIndex;_collisionVO.subGeometryIndex=this._subGeometryIndex}else{_collisionVO.localPosition=null;_collisionVO.localNormal=null;_collisionVO.uv=null;_collisionVO.index=0;_collisionVO.subGeometryIndex=0}return _collisionVO};ShaderPicker.prototype.getSceneCollision=function(position,direction,scene){return null};ShaderPicker.prototype.pDraw=function(entityCollector,target){var camera=entityCollector.camera;this._context.clear(0,0,0,1);this._stage3DProxy.scissorRect=ShaderPicker.MOUSE_SCISSOR_RECT;this._interactives.length=this._interactiveId=0;if(!this._objectProgram3D){this.initObjectProgram3D()}this._context.setBlendFactors(away.display3D.Context3DBlendFactor.ONE,away.display3D.Context3DBlendFactor.ZERO);this._context.setDepthTest(true,away.display3D.Context3DCompareMode.LESS);this._context.setProgram(this._objectProgram3D);this._context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.VERTEX,4,this._viewportData,1);this.drawRenderables(entityCollector.opaqueRenderableHead,camera);this.drawRenderables(entityCollector.blendedRenderableHead,camera)};ShaderPicker.prototype.drawRenderables=function(item,camera){away.Debug.throwPIR("ShaderPicker","drawRenderables","implement");var matrix=away.math.Matrix3DUtils.CALCULATION_MATRIX;var renderable;var viewProjection=camera.viewProjection;while(item){renderable=item.renderable;if(!renderable.sourceEntity.scene||(!renderable.mouseEnabled&&this._onlyMouseEnabled)){item=item.next;continue}this._potentialFound=true;this._context.setCulling(renderable.material.bothSides?away.display3D.Context3DTriangleFace.NONE:away.display3D.Context3DTriangleFace.BACK);this._interactives[this._interactiveId++]=renderable;this._id[1]=(this._interactiveId>>8)/255;this._id[2]=(this._interactiveId&255)/255;matrix.copyFrom(renderable.getRenderSceneTransform(camera));matrix.append(viewProjection);this._context.setProgramConstantsFromMatrix(away.display3D.Context3DProgramType.VERTEX,0,matrix,true);this._context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.FRAGMENT,0,this._id,1);renderable.activateVertexBuffer(0,this._stage3DProxy);this._context.drawTriangles(renderable.getIndexBuffer(this._stage3DProxy),0,renderable.numTriangles);item=item.next}};ShaderPicker.prototype.updateRay=function(camera){this._rayPos=camera.scenePosition;this._rayDir=camera.getRay(this._projX,this._projY,1);this._rayDir.normalize()};ShaderPicker.prototype.initObjectProgram3D=function(){var vertexCode;var fragmentCode;this._objectProgram3D=this._context.createProgram();vertexCode="m44 vt0, va0, vc0			\nmul vt1.xy, vt0.w, vc4.zw	\nadd vt0.xy, vt0.xy, vt1.xy	\nmul vt0.xy, vt0.xy, vc4.xy	\nmov op, vt0	\n";fragmentCode="mov oc, fc0";away.Debug.throwPIR("ShaderPicker","initTriangleProgram3D","Dependency: initObjectProgram3D")};ShaderPicker.prototype.initTriangleProgram3D=function(){var vertexCode;var fragmentCode;this._triangleProgram3D=this._context.createProgram();vertexCode="add vt0, va0, vc5 			\nmul vt0, vt0, vc6 			\nmov v0, vt0				\nm44 vt0, va0, vc0			\nmul vt1.xy, vt0.w, vc4.zw	\nadd vt0.xy, vt0.xy, vt1.xy	\nmul vt0.xy, vt0.xy, vc4.xy	\nmov op, vt0	\n";fragmentCode="mov oc, v0";var vertCompiler=new aglsl.AGLSLCompiler();var fragCompiler=new aglsl.AGLSLCompiler();var vertString=vertCompiler.compile(away.display3D.Context3DProgramType.VERTEX,vertexCode);var fragString=fragCompiler.compile(away.display3D.Context3DProgramType.FRAGMENT,fragmentCode);this._triangleProgram3D.upload(vertString,fragString)};ShaderPicker.prototype.getHitDetails=function(camera){this.getApproximatePosition(camera);this.getPreciseDetails(camera)};ShaderPicker.prototype.getApproximatePosition=function(camera){var entity=this._hitRenderable.sourceEntity;var col;var scX,scY,scZ;var offsX,offsY,offsZ;var localViewProjection=away.math.Matrix3DUtils.CALCULATION_MATRIX;localViewProjection.copyFrom(this._hitRenderable.getRenderSceneTransform(camera));localViewProjection.append(camera.viewProjection);if(!this._triangleProgram3D){this.initTriangleProgram3D()}this._boundOffsetScale[4]=1/(scX=entity.maxX-entity.minX);this._boundOffsetScale[5]=1/(scY=entity.maxY-entity.minY);this._boundOffsetScale[6]=1/(scZ=entity.maxZ-entity.minZ);this._boundOffsetScale[0]=offsX=-entity.minX;this._boundOffsetScale[1]=offsY=-entity.minY;this._boundOffsetScale[2]=offsZ=-entity.minZ;this._context.setProgram(this._triangleProgram3D);this._context.clear(0,0,0,0,1,0,away.display3D.Context3DClearMask.DEPTH);this._context.setScissorRectangle(ShaderPicker.MOUSE_SCISSOR_RECT);this._context.setProgramConstantsFromMatrix(away.display3D.Context3DProgramType.VERTEX,0,localViewProjection,true);this._context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.VERTEX,5,this._boundOffsetScale,2);this._hitRenderable.activateVertexBuffer(0,this._stage3DProxy);this._context.drawTriangles(this._hitRenderable.getIndexBuffer(this._stage3DProxy),0,this._hitRenderable.numTriangles);this._context.drawToBitmapData(this._bitmapData);col=this._bitmapData.getPixel(0,0);this._localHitPosition.x=((col>>16)&255)*scX/255-offsX;this._localHitPosition.y=((col>>8)&255)*scY/255-offsY;this._localHitPosition.z=(col&255)*scZ/255-offsZ};ShaderPicker.prototype.getPreciseDetails=function(camera){var subMesh=this._hitRenderable;var subGeom=subMesh.subGeometry;var indices=subGeom.indexData;var vertices=subGeom.vertexData;var len=indices.length;var x1,y1,z1;var x2,y2,z2;var x3,y3,z3;var i=0,j=1,k=2;var t1,t2,t3;var v0x,v0y,v0z;var v1x,v1y,v1z;var v2x,v2y,v2z;var dot00,dot01,dot02,dot11,dot12;var s,t,invDenom;var uvs=subGeom.UVData;var normals=subGeom.faceNormals;var x=this._localHitPosition.x,y=this._localHitPosition.y,z=this._localHitPosition.z;var u,v;var ui1,ui2,ui3;var s0x,s0y,s0z;var s1x,s1y,s1z;var nl;var stride=subGeom.vertexStride;var vertexOffset=subGeom.vertexOffset;this.updateRay(camera);while(i<len){t1=vertexOffset+indices[i]*stride;t2=vertexOffset+indices[j]*stride;t3=vertexOffset+indices[k]*stride;x1=vertices[t1];y1=vertices[t1+1];z1=vertices[t1+2];x2=vertices[t2];y2=vertices[t2+1];z2=vertices[t2+2];x3=vertices[t3];y3=vertices[t3+1];z3=vertices[t3+2];if(!((x<x1&&x<x2&&x<x3)||(y<y1&&y<y2&&y<y3)||(z<z1&&z<z2&&z<z3)||(x>x1&&x>x2&&x>x3)||(y>y1&&y>y2&&y>y3)||(z>z1&&z>z2&&z>z3))){v0x=x3-x1;v0y=y3-y1;v0z=z3-z1;v1x=x2-x1;v1y=y2-y1;v1z=z2-z1;v2x=x-x1;v2y=y-y1;v2z=z-z1;dot00=v0x*v0x+v0y*v0y+v0z*v0z;dot01=v0x*v1x+v0y*v1y+v0z*v1z;dot02=v0x*v2x+v0y*v2y+v0z*v2z;dot11=v1x*v1x+v1y*v1y+v1z*v1z;dot12=v1x*v2x+v1y*v2y+v1z*v2z;invDenom=1/(dot00*dot11-dot01*dot01);s=(dot11*dot02-dot01*dot12)*invDenom;t=(dot00*dot12-dot01*dot02)*invDenom;if(s>=0&&t>=0&&(s+t)<=1){this.getPrecisePosition(this._hitRenderable.inverseSceneTransform,normals[i],normals[i+1],normals[i+2],x1,y1,z1);v2x=this._localHitPosition.x-x1;v2y=this._localHitPosition.y-y1;v2z=this._localHitPosition.z-z1;s0x=x2-x1;s0y=y2-y1;s0z=z2-z1;s1x=x3-x1;s1y=y3-y1;s1z=z3-z1;this._localHitNormal.x=s0y*s1z-s0z*s1y;this._localHitNormal.y=s0z*s1x-s0x*s1z;this._localHitNormal.z=s0x*s1y-s0y*s1x;nl=1/Math.sqrt(this._localHitNormal.x*this._localHitNormal.x+this._localHitNormal.y*this._localHitNormal.y+this._localHitNormal.z*this._localHitNormal.z);this._localHitNormal.x*=nl;this._localHitNormal.y*=nl;this._localHitNormal.z*=nl;dot02=v0x*v2x+v0y*v2y+v0z*v2z;dot12=v1x*v2x+v1y*v2y+v1z*v2z;s=(dot11*dot02-dot01*dot12)*invDenom;t=(dot00*dot12-dot01*dot02)*invDenom;ui1=indices[i]<<1;ui2=indices[j]<<1;ui3=indices[k]<<1;u=uvs[ui1];v=uvs[ui1+1];this._hitUV.x=u+t*(uvs[ui2]-u)+s*(uvs[ui3]-u);this._hitUV.y=v+t*(uvs[ui2+1]-v)+s*(uvs[ui3+1]-v);this._faceIndex=i;this._subGeometryIndex=away.utils.GeometryUtils.getMeshSubMeshIndex(subMesh);return}}i+=3;j+=3;k+=3}};ShaderPicker.prototype.getPrecisePosition=function(invSceneTransform,nx,ny,nz,px,py,pz){var rx,ry,rz;var ox,oy,oz;var t;var raw=away.math.Matrix3DUtils.RAW_DATA_CONTAINER;var cx=this._rayPos.x,cy=this._rayPos.y,cz=this._rayPos.z;ox=this._rayDir.x;oy=this._rayDir.y;oz=this._rayDir.z;invSceneTransform.copyRawDataTo(raw);rx=raw[0]*ox+raw[4]*oy+raw[8]*oz;ry=raw[1]*ox+raw[5]*oy+raw[9]*oz;rz=raw[2]*ox+raw[6]*oy+raw[10]*oz;ox=raw[0]*cx+raw[4]*cy+raw[8]*cz+raw[12];oy=raw[1]*cx+raw[5]*cy+raw[9]*cz+raw[13];oz=raw[2]*cx+raw[6]*cy+raw[10]*cz+raw[14];t=((px-ox)*nx+(py-oy)*ny+(pz-oz)*nz)/(rx*nx+ry*ny+rz*nz);this._localHitPosition.x=ox+rx*t;this._localHitPosition.y=oy+ry*t;this._localHitPosition.z=oz+rz*t};ShaderPicker.prototype.dispose=function(){this._bitmapData.dispose();if(this._triangleProgram3D){this._triangleProgram3D.dispose()}if(this._objectProgram3D){this._objectProgram3D.dispose()}this._triangleProgram3D=null;this._objectProgram3D=null;this._bitmapData=null;this._hitRenderable=null;this._hitEntity=null};ShaderPicker.MOUSE_SCISSOR_RECT=new away.geom.Rectangle(0,0,1,1);return ShaderPicker})();pick.ShaderPicker=ShaderPicker})(away.pick||(away.pick={}));var pick=away.pick})(away||(away={}));var away;(function(away){(function(pick){var RaycastPicker=(function(){function RaycastPicker(findClosestCollision){this._raycastCollector=new away.traverse.RaycastCollector();this._ignoredEntities=[];this._onlyMouseEnabled=true;this._numEntities=0;this._findClosestCollision=findClosestCollision;this._entities=new Array()}Object.defineProperty(RaycastPicker.prototype,"onlyMouseEnabled",{get:function(){return this._onlyMouseEnabled},set:function(value){this._onlyMouseEnabled=value},enumerable:true,configurable:true});RaycastPicker.prototype.getViewCollision=function(x,y,view){var collector=view.iEntityCollector;if(collector.numMouseEnableds==0){return null}var rayPosition=view.unproject(x,y,0);var rayDirection=view.unproject(x,y,1);rayDirection=rayDirection.subtract(rayPosition);this._numEntities=0;var node=collector.entityHead;var entity;while(node){entity=node.entity;if(this.isIgnored(entity)){node=node.next;continue}if(entity._iIsVisible&&entity.isIntersectingRay(rayPosition,rayDirection)){this._entities[this._numEntities++]=entity}node=node.next}if(!this._numEntities){return null}return this.getPickingCollisionVO()};RaycastPicker.prototype.getSceneCollision=function(position,direction,scene){this._raycastCollector.clear();this._raycastCollector.rayPosition=position;this._raycastCollector.rayDirection=direction;scene.traversePartitions(this._raycastCollector);this._numEntities=0;var node=this._raycastCollector.entityHead;var entity;while(node){entity=node.entity;if(this.isIgnored(entity)){node=node.next;continue}this._entities[this._numEntities++]=entity;node=node.next}if(!this._numEntities){return null}return this.getPickingCollisionVO()};RaycastPicker.prototype.getEntityCollision=function(position,direction,entities){position=position;direction=direction;this._numEntities=0;var entity;var l=entities.length;for(var c=0;c<l;c++){entity=entities[c];if(entity.isIntersectingRay(position,direction)){this._entities[this._numEntities++]=entity}}return this.getPickingCollisionVO()};RaycastPicker.prototype.setIgnoreList=function(entities){this._ignoredEntities=entities};RaycastPicker.prototype.isIgnored=function(entity){if(this._onlyMouseEnabled&&(!entity._iAncestorsAllowMouseEnabled||!entity.mouseEnabled)){return true}var ignoredEntity;var l=this._ignoredEntities.length;for(var c=0;c<l;c++){ignoredEntity=this._ignoredEntities[c];if(ignoredEntity==entity){return true}}return false};RaycastPicker.prototype.sortOnNearT=function(entity1,entity2){return entity1.pickingCollisionVO.rayEntryDistance>entity2.pickingCollisionVO.rayEntryDistance?1:-1};RaycastPicker.prototype.getPickingCollisionVO=function(){this._entities.length=this._numEntities;this._entities=this._entities.sort(this.sortOnNearT);var shortestCollisionDistance=Number.MAX_VALUE;var bestCollisionVO;var pickingCollisionVO;var entity;var i;for(i=0;i<this._numEntities;++i){entity=this._entities[i];pickingCollisionVO=entity._iPickingCollisionVO;if(entity.pickingCollider){if((bestCollisionVO==null||pickingCollisionVO.rayEntryDistance<bestCollisionVO.rayEntryDistance)&&entity.iCollidesBefore(shortestCollisionDistance,this._findClosestCollision)){shortestCollisionDistance=pickingCollisionVO.rayEntryDistance;bestCollisionVO=pickingCollisionVO;if(!this._findClosestCollision){this.updateLocalPosition(pickingCollisionVO);return pickingCollisionVO}}}else{if(bestCollisionVO==null||pickingCollisionVO.rayEntryDistance<bestCollisionVO.rayEntryDistance){if(!pickingCollisionVO.rayOriginIsInsideBounds){this.updateLocalPosition(pickingCollisionVO);return pickingCollisionVO}}}}return bestCollisionVO};RaycastPicker.prototype.updateLocalPosition=function(pickingCollisionVO){var collisionPos=(pickingCollisionVO.localPosition==null)?new away.geom.Vector3D():pickingCollisionVO.localPosition;var rayDir=pickingCollisionVO.localRayDirection;var rayPos=pickingCollisionVO.localRayPosition;var t=pickingCollisionVO.rayEntryDistance;collisionPos.x=rayPos.x+t*rayDir.x;collisionPos.y=rayPos.y+t*rayDir.y;collisionPos.z=rayPos.z+t*rayDir.z};RaycastPicker.prototype.dispose=function(){};return RaycastPicker})();pick.RaycastPicker=RaycastPicker})(away.pick||(away.pick={}));var pick=away.pick})(away||(away={}));var away;(function(away){(function(pick){var PickingType=(function(){function PickingType(){}PickingType.SHADER=new away.pick.ShaderPicker();PickingType.RAYCAST_FIRST_ENCOUNTERED=new away.pick.RaycastPicker(false);PickingType.RAYCAST_BEST_HIT=new away.pick.RaycastPicker(true);return PickingType})();pick.PickingType=PickingType})(away.pick||(away.pick={}));var pick=away.pick})(away||(away={}));var away;(function(away){(function(primitives){var PrimitiveBase=(function(_super){__extends(PrimitiveBase,_super);function PrimitiveBase(){_super.call(this);this._geomDirty=true;this._uvDirty=true;this._subGeometry=new away.base.CompactSubGeometry();this._subGeometry.autoGenerateDummyUVs=false;this.addSubGeometry(this._subGeometry)}Object.defineProperty(PrimitiveBase.prototype,"subGeometries",{get:function(){if(this._geomDirty){this.updateGeometry()}if(this._uvDirty){this.updateUVs()}return _super.prototype.getSubGeometries.call(this)},enumerable:true,configurable:true});PrimitiveBase.prototype.clone=function(){if(this._geomDirty){this.updateGeometry()}if(this._uvDirty){this.updateUVs()}return _super.prototype.clone.call(this)};PrimitiveBase.prototype.scale=function(scale){if(this._geomDirty){this.updateGeometry()}_super.prototype.scale.call(this,scale)};PrimitiveBase.prototype.scaleUV=function(scaleU,scaleV){if(typeof scaleU==="undefined"){scaleU=1}if(typeof scaleV==="undefined"){scaleV=1}if(this._uvDirty){this.updateUVs()}_super.prototype.scaleUV.call(this,scaleU,scaleV)};PrimitiveBase.prototype.applyTransformation=function(transform){if(this._geomDirty){this.updateGeometry()}_super.prototype.applyTransformation.call(this,transform)};PrimitiveBase.prototype.pBuildGeometry=function(target){throw new away.errors.AbstractMethodError()};PrimitiveBase.prototype.pBuildUVs=function(target){throw new away.errors.AbstractMethodError()};PrimitiveBase.prototype.pInvalidateGeometry=function(){this._geomDirty=true};PrimitiveBase.prototype.pInvalidateUVs=function(){this._uvDirty=true};PrimitiveBase.prototype.updateGeometry=function(){this.pBuildGeometry(this._subGeometry);this._geomDirty=false};PrimitiveBase.prototype.updateUVs=function(){this.pBuildUVs(this._subGeometry);this._uvDirty=false};PrimitiveBase.prototype.iValidate=function(){if(this._geomDirty){this.updateGeometry()}if(this._uvDirty){this.updateUVs()}};return PrimitiveBase})(away.base.Geometry);primitives.PrimitiveBase=PrimitiveBase})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var LineSegment=(function(_super){__extends(LineSegment,_super);function LineSegment(v0,v1,color0,color1,thickness){if(typeof color0==="undefined"){color0=3355443}if(typeof color1==="undefined"){color1=3355443}if(typeof thickness==="undefined"){thickness=1}_super.call(this,v0,v1,null,color0,color1,thickness);this.TYPE="line"}return LineSegment})(away.primitives.Segment);primitives.LineSegment=LineSegment})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var TorusGeometry=(function(_super){__extends(TorusGeometry,_super);function TorusGeometry(radius,tubeRadius,segmentsR,segmentsT,yUp){if(typeof radius==="undefined"){radius=50}if(typeof tubeRadius==="undefined"){tubeRadius=50}if(typeof segmentsR==="undefined"){segmentsR=16}if(typeof segmentsT==="undefined"){segmentsT=8}if(typeof yUp==="undefined"){yUp=true}_super.call(this);this._radius=radius;this._tubeRadius=tubeRadius;this._segmentsR=segmentsR;this._segmentsT=segmentsT;this._yUp=yUp}TorusGeometry.prototype.addVertex=function(px,py,pz,nx,ny,nz,tx,ty,tz){var compVertInd=this._vertexOffset+this._nextVertexIndex*this._vertexStride;this._rawVertexData[compVertInd++]=px;this._rawVertexData[compVertInd++]=py;this._rawVertexData[compVertInd++]=pz;this._rawVertexData[compVertInd++]=nx;this._rawVertexData[compVertInd++]=ny;this._rawVertexData[compVertInd++]=nz;this._rawVertexData[compVertInd++]=tx;this._rawVertexData[compVertInd++]=ty;this._rawVertexData[compVertInd]=tz;this._nextVertexIndex++};TorusGeometry.prototype.addTriangleClockWise=function(cwVertexIndex0,cwVertexIndex1,cwVertexIndex2){this._rawIndices[this._currentIndex++]=cwVertexIndex0;this._rawIndices[this._currentIndex++]=cwVertexIndex1;this._rawIndices[this._currentIndex++]=cwVertexIndex2;this._currentTriangleIndex++};TorusGeometry.prototype.pBuildGeometry=function(target){var i,j;var x,y,z,nx,ny,nz,revolutionAngleR,revolutionAngleT;var numTriangles;this._numVertices=0;this._nextVertexIndex=0;this._currentIndex=0;this._currentTriangleIndex=0;this._vertexStride=target.vertexStride;this._vertexOffset=target.vertexOffset;this._numVertices=(this._segmentsT+1)*(this._segmentsR+1);numTriangles=this._segmentsT*this._segmentsR*2;if(this._numVertices==target.numVertices){this._rawVertexData=target.vertexData;if(target.indexData==null){this._rawIndices=new Array(numTriangles*3)}else{this._rawIndices=target.indexData}}else{var numVertComponents=this._numVertices*this._vertexStride;this._rawVertexData=new Array(numVertComponents);this._rawIndices=new Array(numTriangles*3);this.pInvalidateUVs()}var revolutionAngleDeltaR=2*Math.PI/this._segmentsR;var revolutionAngleDeltaT=2*Math.PI/this._segmentsT;var comp1,comp2;var t1,t2,n1,n2;var startIndex;var a,b,c,d,length;for(j=0;j<=this._segmentsT;++j){startIndex=this._vertexOffset+this._nextVertexIndex*this._vertexStride;for(i=0;i<=this._segmentsR;++i){revolutionAngleR=i*revolutionAngleDeltaR;revolutionAngleT=j*revolutionAngleDeltaT;length=Math.cos(revolutionAngleT);nx=length*Math.cos(revolutionAngleR);ny=length*Math.sin(revolutionAngleR);nz=Math.sin(revolutionAngleT);x=this._radius*Math.cos(revolutionAngleR)+this._tubeRadius*nx;y=this._radius*Math.sin(revolutionAngleR)+this._tubeRadius*ny;z=(j==this._segmentsT)?0:this._tubeRadius*nz;if(this._yUp){n1=-nz;n2=ny;t1=0;t2=(length?nx/length:x/this._radius);comp1=-z;comp2=y}else{n1=ny;n2=nz;t1=(length?nx/length:x/this._radius);t2=0;comp1=y;comp2=z}if(i==this._segmentsR){this.addVertex(x,this._rawVertexData[startIndex+1],this._rawVertexData[startIndex+2],nx,n1,n2,-(length?ny/length:y/this._radius),t1,t2)}else{this.addVertex(x,comp1,comp2,nx,n1,n2,-(length?ny/length:y/this._radius),t1,t2)}if(i>0&&j>0){a=this._nextVertexIndex-1;b=this._nextVertexIndex-2;c=b-this._segmentsR-1;d=a-this._segmentsR-1;this.addTriangleClockWise(a,b,c);this.addTriangleClockWise(a,c,d)}}}target.updateData(this._rawVertexData);target.updateIndexData(this._rawIndices)};TorusGeometry.prototype.pBuildUVs=function(target){var i,j;var data;var stride=target.UVStride;var offset=target.UVOffset;var skip=target.UVStride-2;var numUvs=this._numVertices*stride;if(target.UVData&&numUvs==target.UVData.length){data=target.UVData}else{data=new Array(numUvs);this.pInvalidateGeometry()}var currentUvCompIndex=offset;for(j=0;j<=this._segmentsT;++j){for(i=0;i<=this._segmentsR;++i){data[currentUvCompIndex++]=(i/this._segmentsR)*target.scaleU;data[currentUvCompIndex++]=(j/this._segmentsT)*target.scaleV;currentUvCompIndex+=skip}}target.updateData(data)};Object.defineProperty(TorusGeometry.prototype,"radius",{get:function(){return this._radius},set:function(value){this._radius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(TorusGeometry.prototype,"tubeRadius",{get:function(){return this._tubeRadius},set:function(value){this._tubeRadius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(TorusGeometry.prototype,"segmentsR",{get:function(){return this._segmentsR},set:function(value){this._segmentsR=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(TorusGeometry.prototype,"segmentsT",{get:function(){return this._segmentsT},set:function(value){this._segmentsT=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(TorusGeometry.prototype,"yUp",{get:function(){return this._yUp},set:function(value){this._yUp=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});return TorusGeometry})(away.primitives.PrimitiveBase);primitives.TorusGeometry=TorusGeometry})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var CubeGeometry=(function(_super){__extends(CubeGeometry,_super);function CubeGeometry(width,height,depth,segmentsW,segmentsH,segmentsD,tile6){if(typeof width==="undefined"){width=100}if(typeof height==="undefined"){height=100}if(typeof depth==="undefined"){depth=100}if(typeof segmentsW==="undefined"){segmentsW=1}if(typeof segmentsH==="undefined"){segmentsH=1}if(typeof segmentsD==="undefined"){segmentsD=1}if(typeof tile6==="undefined"){tile6=true}_super.call(this);this._width=width;this._height=height;this._depth=depth;this._segmentsW=segmentsW;this._segmentsH=segmentsH;this._segmentsD=segmentsD;this._tile6=tile6}Object.defineProperty(CubeGeometry.prototype,"width",{get:function(){return this._width},set:function(value){this._width=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CubeGeometry.prototype,"height",{get:function(){return this._height},set:function(value){this._height=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CubeGeometry.prototype,"depth",{get:function(){return this._depth},set:function(value){this._depth=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CubeGeometry.prototype,"tile6",{get:function(){return this._tile6},set:function(value){this._tile6=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CubeGeometry.prototype,"segmentsW",{get:function(){return this._segmentsW},set:function(value){this._segmentsW=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(CubeGeometry.prototype,"segmentsH",{get:function(){return this._segmentsH},set:function(value){this._segmentsH=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(CubeGeometry.prototype,"segmentsD",{get:function(){return this._segmentsD},set:function(value){this._segmentsD=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});CubeGeometry.prototype.pBuildGeometry=function(target){var data;var indices;var tl,tr,bl,br;var i,j,inc=0;var vidx,fidx;var hw,hh,hd;var dw,dh,dd;var outer_pos;var numVerts=((this._segmentsW+1)*(this._segmentsH+1)+(this._segmentsW+1)*(this._segmentsD+1)+(this._segmentsH+1)*(this._segmentsD+1))*2;var stride=target.vertexStride;var skip=stride-9;if(numVerts==target.numVertices){data=target.vertexData;indices=(target.indexData)?target.indexData:new Array((this._segmentsW*this._segmentsH+this._segmentsW*this._segmentsD+this._segmentsH*this._segmentsD)*12)}else{data=new Array(numVerts*stride);indices=new Array((this._segmentsW*this._segmentsH+this._segmentsW*this._segmentsD+this._segmentsH*this._segmentsD)*12);this.pInvalidateUVs()}vidx=target.vertexOffset;fidx=0;hw=this._width/2;hh=this._height/2;hd=this._depth/2;dw=this._width/this._segmentsW;dh=this._height/this._segmentsH;dd=this._depth/this._segmentsD;for(i=0;i<=this._segmentsW;i++){outer_pos=-hw+i*dw;for(j=0;j<=this._segmentsH;j++){data[vidx++]=outer_pos;data[vidx++]=-hh+j*dh;data[vidx++]=-hd;data[vidx++]=0;data[vidx++]=0;data[vidx++]=-1;data[vidx++]=1;data[vidx++]=0;data[vidx++]=0;vidx+=skip;data[vidx++]=outer_pos;data[vidx++]=-hh+j*dh;data[vidx++]=hd;data[vidx++]=0;data[vidx++]=0;data[vidx++]=1;data[vidx++]=-1;data[vidx++]=0;data[vidx++]=0;vidx+=skip;if(i&&j){tl=2*((i-1)*(this._segmentsH+1)+(j-1));tr=2*(i*(this._segmentsH+1)+(j-1));bl=tl+2;br=tr+2;indices[fidx++]=tl;indices[fidx++]=bl;indices[fidx++]=br;indices[fidx++]=tl;indices[fidx++]=br;indices[fidx++]=tr;indices[fidx++]=tr+1;indices[fidx++]=br+1;indices[fidx++]=bl+1;indices[fidx++]=tr+1;indices[fidx++]=bl+1;indices[fidx++]=tl+1}}}inc+=2*(this._segmentsW+1)*(this._segmentsH+1);for(i=0;i<=this._segmentsW;i++){outer_pos=-hw+i*dw;for(j=0;j<=this._segmentsD;j++){data[vidx++]=outer_pos;data[vidx++]=hh;data[vidx++]=-hd+j*dd;data[vidx++]=0;data[vidx++]=1;data[vidx++]=0;data[vidx++]=1;data[vidx++]=0;data[vidx++]=0;vidx+=skip;data[vidx++]=outer_pos;data[vidx++]=-hh;data[vidx++]=-hd+j*dd;data[vidx++]=0;data[vidx++]=-1;data[vidx++]=0;data[vidx++]=1;data[vidx++]=0;data[vidx++]=0;vidx+=skip;if(i&&j){tl=inc+2*((i-1)*(this._segmentsD+1)+(j-1));tr=inc+2*(i*(this._segmentsD+1)+(j-1));bl=tl+2;br=tr+2;indices[fidx++]=tl;indices[fidx++]=bl;indices[fidx++]=br;indices[fidx++]=tl;indices[fidx++]=br;indices[fidx++]=tr;indices[fidx++]=tr+1;indices[fidx++]=br+1;indices[fidx++]=bl+1;indices[fidx++]=tr+1;indices[fidx++]=bl+1;indices[fidx++]=tl+1}}}inc+=2*(this._segmentsW+1)*(this._segmentsD+1);for(i=0;i<=this._segmentsD;i++){outer_pos=hd-i*dd;for(j=0;j<=this._segmentsH;j++){data[vidx++]=-hw;data[vidx++]=-hh+j*dh;data[vidx++]=outer_pos;data[vidx++]=-1;data[vidx++]=0;data[vidx++]=0;data[vidx++]=0;data[vidx++]=0;data[vidx++]=-1;vidx+=skip;data[vidx++]=hw;data[vidx++]=-hh+j*dh;data[vidx++]=outer_pos;data[vidx++]=1;data[vidx++]=0;data[vidx++]=0;data[vidx++]=0;data[vidx++]=0;data[vidx++]=1;vidx+=skip;if(i&&j){tl=inc+2*((i-1)*(this._segmentsH+1)+(j-1));tr=inc+2*(i*(this._segmentsH+1)+(j-1));bl=tl+2;br=tr+2;indices[fidx++]=tl;indices[fidx++]=bl;indices[fidx++]=br;indices[fidx++]=tl;indices[fidx++]=br;indices[fidx++]=tr;indices[fidx++]=tr+1;indices[fidx++]=br+1;indices[fidx++]=bl+1;indices[fidx++]=tr+1;indices[fidx++]=bl+1;indices[fidx++]=tl+1}}}target.updateData(data);target.updateIndexData(indices)};CubeGeometry.prototype.pBuildUVs=function(target){var i,j,uidx;var data;var u_tile_dim,v_tile_dim;var u_tile_step,v_tile_step;var tl0u,tl0v;var tl1u,tl1v;var du,dv;var stride=target.UVStride;var numUvs=((this._segmentsW+1)*(this._segmentsH+1)+(this._segmentsW+1)*(this._segmentsD+1)+(this._segmentsH+1)*(this._segmentsD+1))*2*stride;var skip=stride-2;if(target.UVData&&numUvs==target.UVData.length){data=target.UVData}else{data=new Array(numUvs);this.pInvalidateGeometry()}if(this._tile6){u_tile_dim=u_tile_step=1/3;v_tile_dim=v_tile_step=1/2}else{u_tile_dim=v_tile_dim=1;u_tile_step=v_tile_step=0}uidx=target.UVOffset;tl0u=1*u_tile_step;tl0v=1*v_tile_step;tl1u=2*u_tile_step;tl1v=0*v_tile_step;du=u_tile_dim/this._segmentsW;dv=v_tile_dim/this._segmentsH;for(i=0;i<=this._segmentsW;i++){for(j=0;j<=this._segmentsH;j++){data[uidx++]=(tl0u+i*du)*target.scaleU;data[uidx++]=(tl0v+(v_tile_dim-j*dv))*target.scaleV;uidx+=skip;data[uidx++]=(tl1u+(u_tile_dim-i*du))*target.scaleU;data[uidx++]=(tl1v+(v_tile_dim-j*dv))*target.scaleV;uidx+=skip}}tl0u=1*u_tile_step;tl0v=0*v_tile_step;tl1u=0*u_tile_step;tl1v=0*v_tile_step;du=u_tile_dim/this._segmentsW;dv=v_tile_dim/this._segmentsD;for(i=0;i<=this._segmentsW;i++){for(j=0;j<=this._segmentsD;j++){data[uidx++]=(tl0u+i*du)*target.scaleU;data[uidx++]=(tl0v+(v_tile_dim-j*dv))*target.scaleV;uidx+=skip;data[uidx++]=(tl1u+i*du)*target.scaleU;data[uidx++]=(tl1v+j*dv)*target.scaleV;uidx+=skip}}tl0u=0*u_tile_step;tl0v=1*v_tile_step;tl1u=2*u_tile_step;tl1v=1*v_tile_step;du=u_tile_dim/this._segmentsD;dv=v_tile_dim/this._segmentsH;for(i=0;i<=this._segmentsD;i++){for(j=0;j<=this._segmentsH;j++){data[uidx++]=(tl0u+i*du)*target.scaleU;data[uidx++]=(tl0v+(v_tile_dim-j*dv))*target.scaleV;uidx+=skip;data[uidx++]=(tl1u+(u_tile_dim-i*du))*target.scaleU;data[uidx++]=(tl1v+(v_tile_dim-j*dv))*target.scaleV;uidx+=skip}}target.updateData(data)};return CubeGeometry})(away.primitives.PrimitiveBase);primitives.CubeGeometry=CubeGeometry})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var PlaneGeometry=(function(_super){__extends(PlaneGeometry,_super);function PlaneGeometry(width,height,segmentsW,segmentsH,yUp,doubleSided){if(typeof width==="undefined"){width=100}if(typeof height==="undefined"){height=100}if(typeof segmentsW==="undefined"){segmentsW=1}if(typeof segmentsH==="undefined"){segmentsH=1}if(typeof yUp==="undefined"){yUp=true}if(typeof doubleSided==="undefined"){doubleSided=false}_super.call(this);this._segmentsW=segmentsW;this._segmentsH=segmentsH;this._yUp=yUp;this._width=width;this._height=height;this._doubleSided=doubleSided}Object.defineProperty(PlaneGeometry.prototype,"segmentsW",{get:function(){return this._segmentsW},set:function(value){this._segmentsW=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(PlaneGeometry.prototype,"segmentsH",{get:function(){return this._segmentsH},set:function(value){this._segmentsH=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(PlaneGeometry.prototype,"yUp",{get:function(){return this._yUp},set:function(value){this._yUp=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(PlaneGeometry.prototype,"doubleSided",{get:function(){return this._doubleSided},set:function(value){this._doubleSided=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(PlaneGeometry.prototype,"width",{get:function(){return this._width},set:function(value){this._width=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(PlaneGeometry.prototype,"height",{get:function(){return this._height},set:function(value){this._height=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});PlaneGeometry.prototype.pBuildGeometry=function(target){var data;var indices;var x,y;var numIndices;var base;var tw=this._segmentsW+1;var numVertices=(this._segmentsH+1)*tw;var stride=target.vertexStride;var skip=stride-9;if(this._doubleSided){numVertices*=2}numIndices=this._segmentsH*this._segmentsW*6;if(this._doubleSided){numIndices<<=1}if(numVertices==target.numVertices){data=target.vertexData;if(indices==null){indices=new Array(numIndices)}else{indices=target.indexData}}else{data=new Array(numVertices*stride);indices=new Array(numIndices);this.pInvalidateUVs()}numIndices=0;var index=target.vertexOffset;for(var yi=0;yi<=this._segmentsH;++yi){for(var xi=0;xi<=this._segmentsW;++xi){x=(xi/this._segmentsW-0.5)*this._width;y=(yi/this._segmentsH-0.5)*this._height;data[index++]=x;if(this._yUp){data[index++]=0;data[index++]=y}else{data[index++]=y;data[index++]=0}data[index++]=0;if(this._yUp){data[index++]=1;data[index++]=0}else{data[index++]=0;data[index++]=-1}data[index++]=1;data[index++]=0;data[index++]=0;index+=skip;if(this._doubleSided){for(var i=0;i<3;++i){data[index]=data[index-stride];++index}for(i=0;i<3;++i){data[index]=-data[index-stride];++index}for(i=0;i<3;++i){data[index]=-data[index-stride];++index}index+=skip}if(xi!=this._segmentsW&&yi!=this._segmentsH){base=xi+yi*tw;var mult=this._doubleSided?2:1;indices[numIndices++]=base*mult;indices[numIndices++]=(base+tw)*mult;indices[numIndices++]=(base+tw+1)*mult;indices[numIndices++]=base*mult;indices[numIndices++]=(base+tw+1)*mult;indices[numIndices++]=(base+1)*mult;if(this._doubleSided){indices[numIndices++]=(base+tw+1)*mult+1;indices[numIndices++]=(base+tw)*mult+1;indices[numIndices++]=base*mult+1;indices[numIndices++]=(base+1)*mult+1;indices[numIndices++]=(base+tw+1)*mult+1;indices[numIndices++]=base*mult+1}}}}target.updateData(data);target.updateIndexData(indices)};PlaneGeometry.prototype.pBuildUVs=function(target){var data;var stride=target.UVStride;var numUvs=(this._segmentsH+1)*(this._segmentsW+1)*stride;var skip=stride-2;if(this._doubleSided){numUvs*=2}if(target.UVData&&numUvs==target.UVData.length){data=target.UVData}else{data=new Array(numUvs);this.pInvalidateGeometry()}var index=target.UVOffset;for(var yi=0;yi<=this._segmentsH;++yi){for(var xi=0;xi<=this._segmentsW;++xi){data[index++]=(xi/this._segmentsW)*target.scaleU;data[index++]=(1-yi/this._segmentsH)*target.scaleV;index+=skip;if(this._doubleSided){data[index++]=(xi/this._segmentsW)*target.scaleU;data[index++]=(1-yi/this._segmentsH)*target.scaleV;index+=skip}}}target.updateData(data)};return PlaneGeometry})(away.primitives.PrimitiveBase);primitives.PlaneGeometry=PlaneGeometry})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var CapsuleGeometry=(function(_super){__extends(CapsuleGeometry,_super);function CapsuleGeometry(radius,height,segmentsW,segmentsH,yUp){if(typeof radius==="undefined"){radius=50}if(typeof height==="undefined"){height=100}if(typeof segmentsW==="undefined"){segmentsW=16}if(typeof segmentsH==="undefined"){segmentsH=15}if(typeof yUp==="undefined"){yUp=true}_super.call(this);this._radius=radius;this._height=height;this._segmentsW=segmentsW;this._segmentsH=(segmentsH%2==0)?segmentsH+1:segmentsH;this._yUp=yUp}CapsuleGeometry.prototype.pBuildGeometry=function(target){var data;var indices;var i;var j;var triIndex=0;var numVerts=(this._segmentsH+1)*(this._segmentsW+1);var stride=target.vertexStride;var skip=stride-9;var index=0;var startIndex;var comp1,comp2,t1,t2;if(numVerts==target.numVertices){data=target.vertexData;if(target.indexData){indices=target.indexData}else{indices=new Array((this._segmentsH-1)*this._segmentsW*6)}}else{data=new Array(numVerts*stride);indices=new Array((this._segmentsH-1)*this._segmentsW*6);this.pInvalidateUVs()}for(j=0;j<=this._segmentsH;++j){var horangle=Math.PI*j/this._segmentsH;var z=-this._radius*Math.cos(horangle);var ringradius=this._radius*Math.sin(horangle);startIndex=index;for(i=0;i<=this._segmentsW;++i){var verangle=2*Math.PI*i/this._segmentsW;var x=ringradius*Math.cos(verangle);var offset=j>this._segmentsH/2?this._height/2:-this._height/2;var y=ringradius*Math.sin(verangle);var normLen=1/Math.sqrt(x*x+y*y+z*z);var tanLen=Math.sqrt(y*y+x*x);if(this._yUp){t1=0;t2=tanLen>0.007?x/tanLen:0;comp1=-z;comp2=y}else{t1=tanLen>0.007?x/tanLen:0;t2=0;comp1=y;comp2=z}if(i==this._segmentsW){data[index++]=data[startIndex];data[index++]=data[startIndex+1];data[index++]=data[startIndex+2];data[index++]=(data[startIndex+3]+(x*normLen))*0.5;data[index++]=(data[startIndex+4]+(comp1*normLen))*0.5;data[index++]=(data[startIndex+5]+(comp2*normLen))*0.5;data[index++]=(data[startIndex+6]+(tanLen>0.007?-y/tanLen:1))*0.5;data[index++]=(data[startIndex+7]+t1)*0.5;data[index++]=(data[startIndex+8]+t2)*0.5}else{data[index++]=x;data[index++]=(this._yUp)?comp1-offset:comp1;data[index++]=(this._yUp)?comp2:comp2+offset;data[index++]=x*normLen;data[index++]=comp1*normLen;data[index++]=comp2*normLen;data[index++]=tanLen>0.007?-y/tanLen:1;data[index++]=t1;data[index++]=t2}if(i>0&&j>0){var a=(this._segmentsW+1)*j+i;var b=(this._segmentsW+1)*j+i-1;var c=(this._segmentsW+1)*(j-1)+i-1;var d=(this._segmentsW+1)*(j-1)+i;if(j==this._segmentsH){data[index-9]=data[startIndex];data[index-8]=data[startIndex+1];data[index-7]=data[startIndex+2];indices[triIndex++]=a;indices[triIndex++]=c;indices[triIndex++]=d}else{if(j==1){indices[triIndex++]=a;indices[triIndex++]=b;indices[triIndex++]=c}else{indices[triIndex++]=a;indices[triIndex++]=b;indices[triIndex++]=c;indices[triIndex++]=a;indices[triIndex++]=c;indices[triIndex++]=d}}}index+=skip}}target.updateData(data);target.updateIndexData(indices)};CapsuleGeometry.prototype.pBuildUVs=function(target){var i;var j;var index;var data;var stride=target.UVStride;var UVlen=(this._segmentsH+1)*(this._segmentsW+1)*stride;var skip=stride-2;if(target.UVData&&UVlen==target.UVData.length){data=target.UVData}else{data=new Array(UVlen);this.pInvalidateGeometry()}index=target.UVOffset;for(j=0;j<=this._segmentsH;++j){for(i=0;i<=this._segmentsW;++i){data[index++]=(i/this._segmentsW)*target.scaleU;data[index++]=(j/this._segmentsH)*target.scaleV;index+=skip}}target.updateData(data)};Object.defineProperty(CapsuleGeometry.prototype,"radius",{get:function(){return this._radius},set:function(value){this._radius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CapsuleGeometry.prototype,"height",{get:function(){return this._height},set:function(value){this._height=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CapsuleGeometry.prototype,"segmentsW",{get:function(){return this._segmentsW},set:function(value){this._segmentsW=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(CapsuleGeometry.prototype,"segmentsH",{get:function(){return this._segmentsH},set:function(value){this._segmentsH=(value%2==0)?value+1:value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(CapsuleGeometry.prototype,"yUp",{get:function(){return this._yUp},set:function(value){this._yUp=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});return CapsuleGeometry})(away.primitives.PrimitiveBase);primitives.CapsuleGeometry=CapsuleGeometry})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var CylinderGeometry=(function(_super){__extends(CylinderGeometry,_super);function CylinderGeometry(topRadius,bottomRadius,height,segmentsW,segmentsH,topClosed,bottomClosed,surfaceClosed,yUp){if(typeof topRadius==="undefined"){topRadius=50}if(typeof bottomRadius==="undefined"){bottomRadius=50}if(typeof height==="undefined"){height=100}if(typeof segmentsW==="undefined"){segmentsW=16}if(typeof segmentsH==="undefined"){segmentsH=1}if(typeof topClosed==="undefined"){topClosed=true}if(typeof bottomClosed==="undefined"){bottomClosed=true}if(typeof surfaceClosed==="undefined"){surfaceClosed=true}if(typeof yUp==="undefined"){yUp=true}_super.call(this);this._currentIndex=0;this._numVertices=0;this._topRadius=topRadius;this._pBottomRadius=bottomRadius;this._height=height;this._pSegmentsW=segmentsW;this._pSegmentsH=segmentsH;this._topClosed=topClosed;this._bottomClosed=bottomClosed;this._surfaceClosed=surfaceClosed;this._yUp=yUp}CylinderGeometry.prototype.addVertex=function(px,py,pz,nx,ny,nz,tx,ty,tz){var compVertInd=this._vertexOffset+this._nextVertexIndex*this._stride;this._rawData[compVertInd++]=px;this._rawData[compVertInd++]=py;this._rawData[compVertInd++]=pz;this._rawData[compVertInd++]=nx;this._rawData[compVertInd++]=ny;this._rawData[compVertInd++]=nz;this._rawData[compVertInd++]=tx;this._rawData[compVertInd++]=ty;this._rawData[compVertInd++]=tz;this._nextVertexIndex++};CylinderGeometry.prototype.addTriangleClockWise=function(cwVertexIndex0,cwVertexIndex1,cwVertexIndex2){this._rawIndices[this._currentIndex++]=cwVertexIndex0;this._rawIndices[this._currentIndex++]=cwVertexIndex1;this._rawIndices[this._currentIndex++]=cwVertexIndex2;this._currentTriangleIndex++};CylinderGeometry.prototype.pBuildGeometry=function(target){var i;var j;var x;var y;var z;var radius;var revolutionAngle;var dr;var latNormElev;var latNormBase;var numTriangles=0;var comp1;var comp2;var startIndex=0;var t1;var t2;this._stride=target.vertexStride;this._vertexOffset=target.vertexOffset;this._numVertices=0;this._nextVertexIndex=0;this._currentIndex=0;this._currentTriangleIndex=0;if(this._surfaceClosed){this._numVertices+=(this._pSegmentsH+1)*(this._pSegmentsW+1);numTriangles+=this._pSegmentsH*this._pSegmentsW*2}if(this._topClosed){this._numVertices+=2*(this._pSegmentsW+1);numTriangles+=this._pSegmentsW}if(this._bottomClosed){this._numVertices+=2*(this._pSegmentsW+1);numTriangles+=this._pSegmentsW}if(this._numVertices==target.numVertices){this._rawData=target.vertexData;if(target.indexData){this._rawIndices=target.indexData}else{this._rawIndices=new Array(numTriangles*3)}}else{var numVertComponents=this._numVertices*this._stride;this._rawData=new Array(numVertComponents);this._rawIndices=new Array(numTriangles*3)}var revolutionAngleDelta=2*Math.PI/this._pSegmentsW;if(this._topClosed&&this._topRadius>0){z=-0.5*this._height;for(i=0;i<=this._pSegmentsW;++i){if(this._yUp){t1=1;t2=0;comp1=-z;comp2=0}else{t1=0;t2=-1;comp1=0;comp2=z}this.addVertex(0,comp1,comp2,0,t1,t2,1,0,0);revolutionAngle=i*revolutionAngleDelta;x=this._topRadius*Math.cos(revolutionAngle);y=this._topRadius*Math.sin(revolutionAngle);if(this._yUp){comp1=-z;comp2=y}else{comp1=y;comp2=z}if(i==this._pSegmentsW){this.addVertex(this._rawData[startIndex+this._stride],this._rawData[startIndex+this._stride+1],this._rawData[startIndex+this._stride+2],0,t1,t2,1,0,0)}else{this.addVertex(x,comp1,comp2,0,t1,t2,1,0,0)}if(i>0){this.addTriangleClockWise(this._nextVertexIndex-1,this._nextVertexIndex-3,this._nextVertexIndex-2)}}}if(this._bottomClosed&&this._pBottomRadius>0){z=0.5*this._height;startIndex=this._vertexOffset+this._nextVertexIndex*this._stride;for(i=0;i<=this._pSegmentsW;++i){if(this._yUp){t1=-1;t2=0;comp1=-z;comp2=0}else{t1=0;t2=1;comp1=0;comp2=z}this.addVertex(0,comp1,comp2,0,t1,t2,1,0,0);revolutionAngle=i*revolutionAngleDelta;x=this._pBottomRadius*Math.cos(revolutionAngle);y=this._pBottomRadius*Math.sin(revolutionAngle);if(this._yUp){comp1=-z;comp2=y}else{comp1=y;comp2=z}if(i==this._pSegmentsW){this.addVertex(x,this._rawData[startIndex+1],this._rawData[startIndex+2],0,t1,t2,1,0,0)}else{this.addVertex(x,comp1,comp2,0,t1,t2,1,0,0)}if(i>0){this.addTriangleClockWise(this._nextVertexIndex-2,this._nextVertexIndex-3,this._nextVertexIndex-1)}}}dr=(this._pBottomRadius-this._topRadius);latNormElev=dr/this._height;latNormBase=(latNormElev==0)?1:this._height/dr;if(this._surfaceClosed){var a;var b;var c;var d;var na0,na1,naComp1,naComp2;for(j=0;j<=this._pSegmentsH;++j){radius=this._topRadius-((j/this._pSegmentsH)*(this._topRadius-this._pBottomRadius));z=-(this._height/2)+(j/this._pSegmentsH*this._height);startIndex=this._vertexOffset+this._nextVertexIndex*this._stride;for(i=0;i<=this._pSegmentsW;++i){revolutionAngle=i*revolutionAngleDelta;x=radius*Math.cos(revolutionAngle);y=radius*Math.sin(revolutionAngle);na0=latNormBase*Math.cos(revolutionAngle);na1=latNormBase*Math.sin(revolutionAngle);if(this._yUp){t1=0;t2=-na0;comp1=-z;comp2=y;naComp1=latNormElev;naComp2=na1}else{t1=-na0;t2=0;comp1=y;comp2=z;naComp1=na1;naComp2=latNormElev}if(i==this._pSegmentsW){this.addVertex(this._rawData[startIndex],this._rawData[startIndex+1],this._rawData[startIndex+2],na0,latNormElev,na1,na1,t1,t2)}else{this.addVertex(x,comp1,comp2,na0,naComp1,naComp2,-na1,t1,t2)}if(i>0&&j>0){a=this._nextVertexIndex-1;b=this._nextVertexIndex-2;c=b-this._pSegmentsW-1;d=a-this._pSegmentsW-1;this.addTriangleClockWise(a,b,c);this.addTriangleClockWise(a,c,d)}}}}target.updateData(this._rawData);target.updateIndexData(this._rawIndices)};CylinderGeometry.prototype.pBuildUVs=function(target){var i;var j;var x;var y;var revolutionAngle;var stride=target.UVStride;var skip=stride-2;var UVData;var numUvs=this._numVertices*stride;if(target.UVData&&numUvs==target.UVData.length){UVData=target.UVData}else{UVData=new Array(numUvs);this.pInvalidateGeometry()}var revolutionAngleDelta=2*Math.PI/this._pSegmentsW;var currentUvCompIndex=target.UVOffset;if(this._topClosed){for(i=0;i<=this._pSegmentsW;++i){revolutionAngle=i*revolutionAngleDelta;x=0.5+0.5*-Math.cos(revolutionAngle);y=0.5+0.5*Math.sin(revolutionAngle);UVData[currentUvCompIndex++]=0.5*target.scaleU;UVData[currentUvCompIndex++]=0.5*target.scaleV;currentUvCompIndex+=skip;UVData[currentUvCompIndex++]=x*target.scaleU;UVData[currentUvCompIndex++]=y*target.scaleV;currentUvCompIndex+=skip}}if(this._bottomClosed){for(i=0;i<=this._pSegmentsW;++i){revolutionAngle=i*revolutionAngleDelta;x=0.5+0.5*Math.cos(revolutionAngle);y=0.5+0.5*Math.sin(revolutionAngle);UVData[currentUvCompIndex++]=0.5*target.scaleU;UVData[currentUvCompIndex++]=0.5*target.scaleV;currentUvCompIndex+=skip;UVData[currentUvCompIndex++]=x*target.scaleU;UVData[currentUvCompIndex++]=y*target.scaleV;currentUvCompIndex+=skip}}if(this._surfaceClosed){for(j=0;j<=this._pSegmentsH;++j){for(i=0;i<=this._pSegmentsW;++i){UVData[currentUvCompIndex++]=(i/this._pSegmentsW)*target.scaleU;UVData[currentUvCompIndex++]=(j/this._pSegmentsH)*target.scaleV;currentUvCompIndex+=skip}}}target.updateData(UVData)};Object.defineProperty(CylinderGeometry.prototype,"topRadius",{get:function(){return this._topRadius},set:function(value){this._topRadius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CylinderGeometry.prototype,"bottomRadius",{get:function(){return this._pBottomRadius},set:function(value){this._pBottomRadius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CylinderGeometry.prototype,"height",{get:function(){return this._height},set:function(value){this._height=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CylinderGeometry.prototype,"segmentsW",{get:function(){return this._pSegmentsW},set:function(value){this.setSegmentsW(value)},enumerable:true,configurable:true});CylinderGeometry.prototype.setSegmentsW=function(value){this._pSegmentsW=value;this.pInvalidateGeometry();this.pInvalidateUVs()};Object.defineProperty(CylinderGeometry.prototype,"segmentsH",{get:function(){return this._pSegmentsH},set:function(value){this.setSegmentsH(value)},enumerable:true,configurable:true});CylinderGeometry.prototype.setSegmentsH=function(value){this._pSegmentsH=value;this.pInvalidateGeometry();this.pInvalidateUVs()};Object.defineProperty(CylinderGeometry.prototype,"topClosed",{get:function(){return this._topClosed},set:function(value){this._topClosed=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CylinderGeometry.prototype,"bottomClosed",{get:function(){return this._bottomClosed},set:function(value){this._bottomClosed=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(CylinderGeometry.prototype,"yUp",{get:function(){return this._yUp},set:function(value){this._yUp=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});return CylinderGeometry})(away.primitives.PrimitiveBase);primitives.CylinderGeometry=CylinderGeometry})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var ConeGeometry=(function(_super){__extends(ConeGeometry,_super);function ConeGeometry(radius,height,segmentsW,segmentsH,closed,yUp){if(typeof radius==="undefined"){radius=50}if(typeof height==="undefined"){height=100}if(typeof segmentsW==="undefined"){segmentsW=16}if(typeof segmentsH==="undefined"){segmentsH=1}if(typeof closed==="undefined"){closed=true}if(typeof yUp==="undefined"){yUp=true}_super.call(this,0,radius,height,segmentsW,segmentsH,false,closed,true,yUp)}Object.defineProperty(ConeGeometry.prototype,"radius",{get:function(){return this._pBottomRadius},set:function(value){this._pBottomRadius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});return ConeGeometry})(away.primitives.CylinderGeometry);primitives.ConeGeometry=ConeGeometry})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var RegularPolygonGeometry=(function(_super){__extends(RegularPolygonGeometry,_super);function RegularPolygonGeometry(radius,sides,yUp){if(typeof radius==="undefined"){radius=100}if(typeof sides==="undefined"){sides=16}if(typeof yUp==="undefined"){yUp=true}_super.call(this,radius,0,0,sides,1,true,false,false,yUp)}Object.defineProperty(RegularPolygonGeometry.prototype,"radius",{get:function(){return this._pBottomRadius},set:function(value){this._pBottomRadius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(RegularPolygonGeometry.prototype,"sides",{get:function(){return this._pSegmentsW},set:function(value){this.setSegmentsW(value)},enumerable:true,configurable:true});Object.defineProperty(RegularPolygonGeometry.prototype,"subdivisions",{get:function(){return this._pSegmentsH},set:function(value){this.setSegmentsH(value)},enumerable:true,configurable:true});return RegularPolygonGeometry})(away.primitives.CylinderGeometry);primitives.RegularPolygonGeometry=RegularPolygonGeometry})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(primitives){var SphereGeometry=(function(_super){__extends(SphereGeometry,_super);function SphereGeometry(radius,segmentsW,segmentsH,yUp){if(typeof radius==="undefined"){radius=50}if(typeof segmentsW==="undefined"){segmentsW=16}if(typeof segmentsH==="undefined"){segmentsH=12}if(typeof yUp==="undefined"){yUp=true}_super.call(this);this._radius=radius;this._segmentsW=segmentsW;this._segmentsH=segmentsH;this._yUp=yUp}SphereGeometry.prototype.pBuildGeometry=function(target){var vertices;var indices;var i;var j;var triIndex=0;var numVerts=(this._segmentsH+1)*(this._segmentsW+1);var stride=target.vertexStride;var skip=stride-9;if(numVerts==target.numVertices){vertices=target.vertexData;if(target.indexData){indices=target.indexData}else{indices=new Array((this._segmentsH-1)*this._segmentsW*6)}}else{vertices=new Array(numVerts*stride);indices=new Array((this._segmentsH-1)*this._segmentsW*6);this.pInvalidateGeometry()}var startIndex;var index=target.vertexOffset;var comp1;var comp2;var t1;var t2;for(j=0;j<=this._segmentsH;++j){startIndex=index;var horangle=Math.PI*j/this._segmentsH;var z=-this._radius*Math.cos(horangle);var ringradius=this._radius*Math.sin(horangle);for(i=0;i<=this._segmentsW;++i){var verangle=2*Math.PI*i/this._segmentsW;var x=ringradius*Math.cos(verangle);var y=ringradius*Math.sin(verangle);var normLen=1/Math.sqrt(x*x+y*y+z*z);var tanLen=Math.sqrt(y*y+x*x);if(this._yUp){t1=0;t2=tanLen>0.007?x/tanLen:0;comp1=-z;comp2=y}else{t1=tanLen>0.007?x/tanLen:0;t2=0;comp1=y;comp2=z}if(i==this._segmentsW){vertices[index++]=vertices[startIndex];vertices[index++]=vertices[startIndex+1];vertices[index++]=vertices[startIndex+2];vertices[index++]=vertices[startIndex+3]+(x*normLen)*0.5;vertices[index++]=vertices[startIndex+4]+(comp1*normLen)*0.5;vertices[index++]=vertices[startIndex+5]+(comp2*normLen)*0.5;vertices[index++]=tanLen>0.007?-y/tanLen:1;vertices[index++]=t1;vertices[index++]=t2}else{vertices[index++]=x;vertices[index++]=comp1;vertices[index++]=comp2;vertices[index++]=x*normLen;vertices[index++]=comp1*normLen;vertices[index++]=comp2*normLen;vertices[index++]=tanLen>0.007?-y/tanLen:1;vertices[index++]=t1;vertices[index++]=t2}if(i>0&&j>0){var a=(this._segmentsW+1)*j+i;var b=(this._segmentsW+1)*j+i-1;var c=(this._segmentsW+1)*(j-1)+i-1;var d=(this._segmentsW+1)*(j-1)+i;if(j==this._segmentsH){vertices[index-9]=vertices[startIndex];vertices[index-8]=vertices[startIndex+1];vertices[index-7]=vertices[startIndex+2];indices[triIndex++]=a;indices[triIndex++]=c;indices[triIndex++]=d}else{if(j==1){indices[triIndex++]=a;indices[triIndex++]=b;indices[triIndex++]=c}else{indices[triIndex++]=a;indices[triIndex++]=b;indices[triIndex++]=c;indices[triIndex++]=a;indices[triIndex++]=c;indices[triIndex++]=d}}}index+=skip}}target.updateData(vertices);target.updateIndexData(indices)};SphereGeometry.prototype.pBuildUVs=function(target){var i,j;var stride=target.UVStride;var numUvs=(this._segmentsH+1)*(this._segmentsW+1)*stride;var data;var skip=stride-2;if(target.UVData&&numUvs==target.UVData.length){data=target.UVData}else{data=new Array(numUvs);this.pInvalidateGeometry()}var index=target.UVOffset;for(j=0;j<=this._segmentsH;++j){for(i=0;i<=this._segmentsW;++i){data[index++]=(i/this._segmentsW)*target.scaleU;data[index++]=(j/this._segmentsH)*target.scaleV;index+=skip}}target.updateData(data)};Object.defineProperty(SphereGeometry.prototype,"radius",{get:function(){return this._radius},set:function(value){this._radius=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});Object.defineProperty(SphereGeometry.prototype,"segmentsW",{get:function(){return this._segmentsW},set:function(value){this._segmentsW=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(SphereGeometry.prototype,"segmentsH",{get:function(){return this._segmentsH},set:function(value){this._segmentsH=value;this.pInvalidateGeometry();this.pInvalidateUVs()},enumerable:true,configurable:true});Object.defineProperty(SphereGeometry.prototype,"yUp",{get:function(){return this._yUp},set:function(value){this._yUp=value;this.pInvalidateGeometry()},enumerable:true,configurable:true});return SphereGeometry})(away.primitives.PrimitiveBase);primitives.SphereGeometry=SphereGeometry})(away.primitives||(away.primitives={}));var primitives=away.primitives})(away||(away={}));var away;(function(away){(function(utils){var ColorUtils=(function(){function ColorUtils(){}ColorUtils.float32ColorToARGB=function(float32Color){var a=(float32Color&4278190080)>>>24;var r=(float32Color&16711680)>>>16;var g=(float32Color&65280)>>>8;var b=float32Color&255;var result=[a,r,g,b];return result};ColorUtils.componentToHex=function(c){var hex=c.toString(16);return hex.length==1?"0"+hex:hex};ColorUtils.RGBToHexString=function(argb){return"#"+ColorUtils.componentToHex(argb[1])+ColorUtils.componentToHex(argb[2])+ColorUtils.componentToHex(argb[3])};ColorUtils.ARGBToHexString=function(argb){return"#"+ColorUtils.componentToHex(argb[0])+ColorUtils.componentToHex(argb[1])+ColorUtils.componentToHex(argb[2])+ColorUtils.componentToHex(argb[3])};return ColorUtils})();utils.ColorUtils=ColorUtils})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(geom){var ColorTransform=(function(){function ColorTransform(inRedMultiplier,inGreenMultiplier,inBlueMultiplier,inAlphaMultiplier,inRedOffset,inGreenOffset,inBlueOffset,inAlphaOffset){if(typeof inRedMultiplier==="undefined"){inRedMultiplier=1}if(typeof inGreenMultiplier==="undefined"){inGreenMultiplier=1}if(typeof inBlueMultiplier==="undefined"){inBlueMultiplier=1}if(typeof inAlphaMultiplier==="undefined"){inAlphaMultiplier=1}if(typeof inRedOffset==="undefined"){inRedOffset=0}if(typeof inGreenOffset==="undefined"){inGreenOffset=0}if(typeof inBlueOffset==="undefined"){inBlueOffset=0}if(typeof inAlphaOffset==="undefined"){inAlphaOffset=0}this.redMultiplier=inRedMultiplier;this.greenMultiplier=inGreenMultiplier;this.blueMultiplier=inBlueMultiplier;this.alphaMultiplier=inAlphaMultiplier;this.redOffset=inRedOffset;this.greenOffset=inGreenOffset;this.blueOffset=inBlueOffset;this.alphaOffset=inAlphaOffset}ColorTransform.prototype.concat=function(second){this.redMultiplier+=second.redMultiplier;this.greenMultiplier+=second.greenMultiplier;this.blueMultiplier+=second.blueMultiplier;this.alphaMultiplier+=second.alphaMultiplier};Object.defineProperty(ColorTransform.prototype,"color",{get:function(){return((this.redOffset<<16)|(this.greenOffset<<8)|this.blueOffset)},set:function(value){var argb=away.utils.ColorUtils.float32ColorToARGB(value);this.redOffset=argb[1];this.greenOffset=argb[2];this.blueOffset=argb[3];this.redMultiplier=0;this.greenMultiplier=0;this.blueMultiplier=0},enumerable:true,configurable:true});return ColorTransform})();geom.ColorTransform=ColorTransform})(away.geom||(away.geom={}));var geom=away.geom})(away||(away={}));var away;(function(away){(function(animators){var AnimationNodeBase=(function(_super){__extends(AnimationNodeBase,_super);function AnimationNodeBase(){_super.call(this)}Object.defineProperty(AnimationNodeBase.prototype,"stateClass",{get:function(){return this._stateClass},enumerable:true,configurable:true});AnimationNodeBase.prototype.dispose=function(){};Object.defineProperty(AnimationNodeBase.prototype,"assetType",{get:function(){return away.library.AssetType.ANIMATION_NODE},enumerable:true,configurable:true});return AnimationNodeBase})(away.library.NamedAssetBase);animators.AnimationNodeBase=AnimationNodeBase})(away.animators||(away.animators={}));var animators=away.animators})(away||(away={}));var away;(function(away){(function(utils){var GeometryUtils=(function(){function GeometryUtils(){}GeometryUtils.fromVectors=function(verts,indices,uvs,normals,tangents,weights,jointIndices,triangleOffset){if(typeof triangleOffset==="undefined"){triangleOffset=0}var LIMIT_VERTS=3*65535;var LIMIT_INDICES=15*65535;var subs=new Array();if(uvs&&!uvs.length){uvs=null}if(normals&&!normals.length){normals=null}if(tangents&&!tangents.length){tangents=null}if(weights&&!weights.length){weights=null}if(jointIndices&&!jointIndices.length){jointIndices=null}if((indices.length>=LIMIT_INDICES)||(verts.length>=LIMIT_VERTS)){var i,len,outIndex,j;var splitVerts=new Array();var splitIndices=new Array();var splitUvs=(uvs!=null)?new Array():null;var splitNormals=(normals!=null)?new Array():null;var splitTangents=(tangents!=null)?new Array():null;var splitWeights=(weights!=null)?new Array():null;var splitJointIndices=(jointIndices!=null)?new Array():null;var mappings=new Array(verts.length/3);i=mappings.length;while(i-->0){mappings[i]=-1}var originalIndex;var splitIndex;var o0,o1,o2,s0,s1,s2,su,ou,sv,ov;outIndex=0;len=indices.length;for(i=0;i<len;i+=3){splitIndex=splitVerts.length+6;if(((outIndex+2)>=LIMIT_INDICES)||(splitIndex>=LIMIT_VERTS)){subs.push(GeometryUtils.constructSubGeometry(splitVerts,splitIndices,splitUvs,splitNormals,splitTangents,splitWeights,splitJointIndices,triangleOffset));splitVerts=new Array();splitIndices=new Array();splitUvs=(uvs!=null)?new Array():null;splitNormals=(normals!=null)?new Array():null;splitTangents=(tangents!=null)?new Array():null;splitWeights=(weights!=null)?new Array():null;splitJointIndices=(jointIndices!=null)?new Array():null;splitIndex=0;j=mappings.length;while(j-->0){mappings[j]=-1}outIndex=0}for(j=0;j<3;j++){originalIndex=indices[i+j];if(mappings[originalIndex]>=0){splitIndex=mappings[originalIndex]}else{o0=originalIndex*3+0;o1=originalIndex*3+1;o2=originalIndex*3+2;splitIndex=splitVerts.length/3;s0=splitIndex*3+0;s1=splitIndex*3+1;s2=splitIndex*3+2;splitVerts[s0]=verts[o0];splitVerts[s1]=verts[o1];splitVerts[s2]=verts[o2];if(uvs){su=splitIndex*2+0;sv=splitIndex*2+1;ou=originalIndex*2+0;ov=originalIndex*2+1;splitUvs[su]=uvs[ou];splitUvs[sv]=uvs[ov]}if(normals){splitNormals[s0]=normals[o0];splitNormals[s1]=normals[o1];splitNormals[s2]=normals[o2]}if(tangents){splitTangents[s0]=tangents[o0];splitTangents[s1]=tangents[o1];splitTangents[s2]=tangents[o2]}if(weights){splitWeights[s0]=weights[o0];splitWeights[s1]=weights[o1];splitWeights[s2]=weights[o2]}if(jointIndices){splitJointIndices[s0]=jointIndices[o0];splitJointIndices[s1]=jointIndices[o1];splitJointIndices[s2]=jointIndices[o2]}mappings[originalIndex]=splitIndex}splitIndices[outIndex+j]=splitIndex}outIndex+=3}if(splitVerts.length>0){subs.push(GeometryUtils.constructSubGeometry(splitVerts,splitIndices,splitUvs,splitNormals,splitTangents,splitWeights,splitJointIndices,triangleOffset))}}else{subs.push(GeometryUtils.constructSubGeometry(verts,indices,uvs,normals,tangents,weights,jointIndices,triangleOffset))}return subs};GeometryUtils.constructSubGeometry=function(verts,indices,uvs,normals,tangents,weights,jointIndices,triangleOffset){var sub;if(weights&&jointIndices){away.Debug.throwPIR("GeometryUtils","constructSubGeometry","Dependency: SkinnedSubGeometry")}else{sub=new away.base.CompactSubGeometry()}sub.updateIndexData(indices);sub.fromVectors(verts,uvs,normals,tangents);return sub};GeometryUtils.interleaveBuffers=function(numVertices,vertices,normals,tangents,uvs,suvs){if(typeof vertices==="undefined"){vertices=null}if(typeof normals==="undefined"){normals=null}if(typeof tangents==="undefined"){tangents=null}if(typeof uvs==="undefined"){uvs=null}if(typeof suvs==="undefined"){suvs=null}var i,compIndex,uvCompIndex,interleavedCompIndex;var interleavedBuffer;interleavedBuffer=new Array();for(i=0;i<numVertices;++i){uvCompIndex=i*2;compIndex=i*3;interleavedCompIndex=i*13;interleavedBuffer[interleavedCompIndex]=vertices?vertices[compIndex]:0;interleavedBuffer[interleavedCompIndex+1]=vertices?vertices[compIndex+1]:0;interleavedBuffer[interleavedCompIndex+2]=vertices?vertices[compIndex+2]:0;interleavedBuffer[interleavedCompIndex+3]=normals?normals[compIndex]:0;interleavedBuffer[interleavedCompIndex+4]=normals?normals[compIndex+1]:0;interleavedBuffer[interleavedCompIndex+5]=normals?normals[compIndex+2]:0;interleavedBuffer[interleavedCompIndex+6]=tangents?tangents[compIndex]:0;interleavedBuffer[interleavedCompIndex+7]=tangents?tangents[compIndex+1]:0;interleavedBuffer[interleavedCompIndex+8]=tangents?tangents[compIndex+2]:0;interleavedBuffer[interleavedCompIndex+9]=uvs?uvs[uvCompIndex]:0;interleavedBuffer[interleavedCompIndex+10]=uvs?uvs[uvCompIndex+1]:0;interleavedBuffer[interleavedCompIndex+11]=suvs?suvs[uvCompIndex]:0;interleavedBuffer[interleavedCompIndex+12]=suvs?suvs[uvCompIndex+1]:0}return interleavedBuffer};GeometryUtils.getMeshSubgeometryIndex=function(subGeometry){var index;var subGeometries=subGeometry.parentGeometry.subGeometries;for(var i=0;i<subGeometries.length;++i){if(subGeometries[i]==subGeometry){index=i;break}}return index};GeometryUtils.getMeshSubMeshIndex=function(subMesh){var index;var subMeshes=subMesh.iParentMesh.subMeshes;for(var i=0;i<subMeshes.length;++i){if(subMeshes[i]==subMesh){index=i;break}}return index};return GeometryUtils})();utils.GeometryUtils=GeometryUtils})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(animators){var AnimationStateBase=(function(){function AnimationStateBase(animator,animationNode){this._rootDelta=new away.geom.Vector3D();this._positionDeltaDirty=true;this._animator=animator;this._animationNode=animationNode}Object.defineProperty(AnimationStateBase.prototype,"positionDelta",{get:function(){if(this._positionDeltaDirty){this.pUpdatePositionDelta()}return this._rootDelta},enumerable:true,configurable:true});AnimationStateBase.prototype.offset=function(startTime){this._startTime=startTime;this._positionDeltaDirty=true};AnimationStateBase.prototype.update=function(time){if(this._time==time-this._startTime){return}this.pUpdateTime(time)};AnimationStateBase.prototype.phase=function(value){};AnimationStateBase.prototype.pUpdateTime=function(time){this._time=time-this._startTime;this._positionDeltaDirty=true};AnimationStateBase.prototype.pUpdatePositionDelta=function(){};return AnimationStateBase})();animators.AnimationStateBase=AnimationStateBase})(away.animators||(away.animators={}));var animators=away.animators})(away||(away={}));var away;(function(away){(function(events){var ShadingMethodEvent=(function(_super){__extends(ShadingMethodEvent,_super);function ShadingMethodEvent(type){_super.call(this,type)}ShadingMethodEvent.SHADER_INVALIDATED="ShaderInvalidated";return ShadingMethodEvent})(away.events.Event);events.ShadingMethodEvent=ShadingMethodEvent})(away.events||(away.events={}));var events=away.events})(away||(away={}));var away;(function(away){(function(materials){var MaterialPassBase=(function(_super){__extends(MaterialPassBase,_super);function MaterialPassBase(renderToTexture){if(typeof renderToTexture==="undefined"){renderToTexture=false}_super.call(this);this._iProgram3Ds=new Array(8);this._iProgram3Dids=new Array(-1,-1,-1,-1,-1,-1,-1,-1);this._context3Ds=new Array(8);this._pSmooth=true;this._pRepeat=false;this._pMipmap=true;this._depthCompareMode=away.display3D.Context3DCompareMode.LESS_EQUAL;this._blendFactorSource=away.display3D.Context3DBlendFactor.ONE;this._blendFactorDest=away.display3D.Context3DBlendFactor.ZERO;this._pEnableBlending=false;this._pAnimatableAttributes=new Array("va0");this._pAnimationTargetRegisters=new Array("vt0");this._pShadedTarget="ft0";this._defaultCulling=away.display3D.Context3DTriangleFace.BACK;this._pAlphaPremultiplied=false;this._writeDepth=true;this._renderToTexture=renderToTexture;this._pNumUsedStreams=1;this._pNumUsedVertexConstants=5}Object.defineProperty(MaterialPassBase.prototype,"material",{get:function(){return this._pMaterial},set:function(value){this._pMaterial=value},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"writeDepth",{get:function(){return this._writeDepth},set:function(value){this._writeDepth=value},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"mipmap",{get:function(){return this._pMipmap},set:function(value){this.setMipMap(value)},enumerable:true,configurable:true});MaterialPassBase.prototype.setMipMap=function(value){if(this._pMipmap==value){return}this._pMipmap=value;this.iInvalidateShaderProgram()};Object.defineProperty(MaterialPassBase.prototype,"smooth",{get:function(){return this._pSmooth},set:function(value){if(this._pSmooth==value){return}this._pSmooth=value;this.iInvalidateShaderProgram()},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"repeat",{get:function(){return this._pRepeat},set:function(value){if(this._pRepeat==value){return}this._pRepeat=value;this.iInvalidateShaderProgram()},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"bothSides",{get:function(){return this._pBothSides},set:function(value){this._pBothSides=value},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"depthCompareMode",{get:function(){return this._depthCompareMode},set:function(value){this._depthCompareMode=value},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"animationSet",{get:function(){return this._animationSet},set:function(value){if(this._animationSet==value){return}this._animationSet=value;this.iInvalidateShaderProgram()},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"renderToTexture",{get:function(){return this._renderToTexture},enumerable:true,configurable:true});MaterialPassBase.prototype.dispose=function(){if(this._pLightPicker){this._pLightPicker.removeEventListener(away.events.Event.CHANGE,this.onLightsChange,this)}for(var i=0;i<8;++i){if(this._iProgram3Ds[i]){away.managers.AGALProgram3DCache.getInstanceFromIndex(i).freeProgram3D(this._iProgram3Dids[i]);this._iProgram3Ds[i]=null}}};Object.defineProperty(MaterialPassBase.prototype,"numUsedStreams",{get:function(){return this._pNumUsedStreams},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"numUsedVertexConstants",{get:function(){return this._pNumUsedVertexConstants},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"numUsedVaryings",{get:function(){return this._pNumUsedVaryings},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"numUsedFragmentConstants",{get:function(){return this._pNumUsedFragmentConstants},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"needFragmentAnimation",{get:function(){return this._pNeedFragmentAnimation},enumerable:true,configurable:true});Object.defineProperty(MaterialPassBase.prototype,"needUVAnimation",{get:function(){return this._pNeedUVAnimation},enumerable:true,configurable:true});MaterialPassBase.prototype.iUpdateAnimationState=function(renderable,stage3DProxy,camera){renderable.animator.setRenderState(stage3DProxy,renderable,this._pNumUsedVertexConstants,this._pNumUsedStreams,camera)};MaterialPassBase.prototype.iRender=function(renderable,stage3DProxy,camera,viewProjection){throw new away.errors.AbstractMethodError()};MaterialPassBase.prototype.iGetVertexCode=function(){throw new away.errors.AbstractMethodError()};MaterialPassBase.prototype.iGetFragmentCode=function(fragmentAnimatorCode){throw new away.errors.AbstractMethodError()};MaterialPassBase.prototype.setBlendMode=function(value){switch(value){case away.display.BlendMode.NORMAL:this._blendFactorSource=away.display3D.Context3DBlendFactor.ONE;this._blendFactorDest=away.display3D.Context3DBlendFactor.ZERO;this._pEnableBlending=false;break;case away.display.BlendMode.LAYER:this._blendFactorSource=away.display3D.Context3DBlendFactor.SOURCE_ALPHA;this._blendFactorDest=away.display3D.Context3DBlendFactor.ONE_MINUS_SOURCE_ALPHA;this._pEnableBlending=true;break;case away.display.BlendMode.MULTIPLY:this._blendFactorSource=away.display3D.Context3DBlendFactor.ZERO;this._blendFactorDest=away.display3D.Context3DBlendFactor.SOURCE_COLOR;this._pEnableBlending=true;break;case away.display.BlendMode.ADD:this._blendFactorSource=away.display3D.Context3DBlendFactor.SOURCE_ALPHA;this._blendFactorDest=away.display3D.Context3DBlendFactor.ONE;this._pEnableBlending=true;break;case away.display.BlendMode.ALPHA:this._blendFactorSource=away.display3D.Context3DBlendFactor.ZERO;this._blendFactorDest=away.display3D.Context3DBlendFactor.SOURCE_ALPHA;this._pEnableBlending=true;break;default:throw new away.errors.ArgumentError("Unsupported blend mode!")}};MaterialPassBase.prototype.iActivate=function(stage3DProxy,camera){var contextIndex=stage3DProxy._iStage3DIndex;var context=stage3DProxy._iContext3D;context.setDepthTest((this._writeDepth&&!this._pEnableBlending),this._depthCompareMode);if(this._pEnableBlending){context.setBlendFactors(this._blendFactorSource,this._blendFactorDest)}if(this._context3Ds[contextIndex]!=context||!this._iProgram3Ds[contextIndex]){this._context3Ds[contextIndex]=context;this.iUpdateProgram(stage3DProxy);this.dispatchEvent(new away.events.Event(away.events.Event.CHANGE))}var prevUsed=MaterialPassBase._previousUsedStreams[contextIndex];var i;for(i=this._pNumUsedStreams;i<prevUsed;++i){context.setVertexBufferAt(i,null)}prevUsed=MaterialPassBase._previousUsedTexs[contextIndex];for(i=this._pNumUsedTextures;i<prevUsed;++i){context.setTextureAt(i,null)}if(this._animationSet&&!this._animationSet.usesCPU){this._animationSet.activate(stage3DProxy,this)}context.setProgram(this._iProgram3Ds[contextIndex]);context.setCulling(this._pBothSides?away.display3D.Context3DTriangleFace.NONE:this._defaultCulling);if(this._renderToTexture){this._oldTarget=stage3DProxy.renderTarget;this._oldSurface=stage3DProxy.renderSurfaceSelector;this._oldDepthStencil=stage3DProxy.enableDepthAndStencil;this._oldRect=stage3DProxy.scissorRect}};MaterialPassBase.prototype.iDeactivate=function(stage3DProxy){var index=stage3DProxy._iStage3DIndex;MaterialPassBase._previousUsedStreams[index]=this._pNumUsedStreams;MaterialPassBase._previousUsedTexs[index]=this._pNumUsedTextures;if(this._animationSet&&!this._animationSet.usesCPU){this._animationSet.deactivate(stage3DProxy,this)}if(this._renderToTexture){stage3DProxy.setRenderTarget(this._oldTarget,this._oldDepthStencil,this._oldSurface);stage3DProxy.scissorRect=this._oldRect}stage3DProxy._iContext3D.setDepthTest(true,away.display3D.Context3DCompareMode.LESS_EQUAL)};MaterialPassBase.prototype.iInvalidateShaderProgram=function(updateMaterial){if(typeof updateMaterial==="undefined"){updateMaterial=true}for(var i=0;i<8;++i){this._iProgram3Ds[i]=null}if(this._pMaterial&&updateMaterial){this._pMaterial.iInvalidatePasses(this)}};MaterialPassBase.prototype.iUpdateProgram=function(stage3DProxy){var animatorCode="";var UVAnimatorCode="";var fragmentAnimatorCode="";var vertexCode=this.iGetVertexCode();if(this._animationSet&&!this._animationSet.usesCPU){animatorCode=this._animationSet.getAGALVertexCode(this,this._pAnimatableAttributes,this._pAnimationTargetRegisters,stage3DProxy.profile);if(this._pNeedFragmentAnimation){fragmentAnimatorCode=this._animationSet.getAGALFragmentCode(this,this._pShadedTarget,stage3DProxy.profile)}if(this._pNeedUVAnimation){UVAnimatorCode=this._animationSet.getAGALUVCode(this,this._pUVSource,this._pUVTarget)}this._animationSet.doneAGALCode(this)}else{var len=this._pAnimatableAttributes.length;for(var i=0;i<len;++i){animatorCode+="mov "+this._pAnimationTargetRegisters[i]+", "+this._pAnimatableAttributes[i]+"\n"}if(this._pNeedUVAnimation){UVAnimatorCode="mov "+this._pUVTarget+","+this._pUVSource+"\n"}}vertexCode=animatorCode+UVAnimatorCode+vertexCode;var fragmentCode=this.iGetFragmentCode(fragmentAnimatorCode);away.managers.AGALProgram3DCache.getInstance(stage3DProxy).setProgram3D(this,vertexCode,fragmentCode)};Object.defineProperty(MaterialPassBase.prototype,"lightPicker",{get:function(){return this._pLightPicker},set:function(value){if(this._pLightPicker){this._pLightPicker.removeEventListener(away.events.Event.CHANGE,this.onLightsChange,this)}this._pLightPicker=value;if(this._pLightPicker){this._pLightPicker.addEventListener(away.events.Event.CHANGE,this.onLightsChange,this)}this.pUpdateLights()},enumerable:true,configurable:true});MaterialPassBase.prototype.onLightsChange=function(event){this.pUpdateLights()};MaterialPassBase.prototype.pUpdateLights=function(){};Object.defineProperty(MaterialPassBase.prototype,"alphaPremultiplied",{get:function(){return this._pAlphaPremultiplied},set:function(value){this._pAlphaPremultiplied=value;this.iInvalidateShaderProgram(false)},enumerable:true,configurable:true});MaterialPassBase._previousUsedStreams=new Array(0,0,0,0,0,0,0,0);MaterialPassBase._previousUsedTexs=new Array(0,0,0,0,0,0,0,0);return MaterialPassBase})(away.events.EventDispatcher);materials.MaterialPassBase=MaterialPassBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var CompiledPass=(function(_super){__extends(CompiledPass,_super);function CompiledPass(material){_super.call(this);this._pSpecularLightSources=1;this._pDiffuseLightSources=3;this._pVertexConstantData=new Array();this._pFragmentConstantData=new Array();this._preserveAlpha=true;this._animateUVs=false;this._enableLightFallOff=true;this._forceSeparateMVP=false;this._pMaterial=material;this.init()}Object.defineProperty(CompiledPass.prototype,"enableLightFallOff",{get:function(){return this._enableLightFallOff},set:function(value){if(value!=this._enableLightFallOff){this.iInvalidateShaderProgram(true)}this._enableLightFallOff=value},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"forceSeparateMVP",{get:function(){return this._forceSeparateMVP},set:function(value){this._forceSeparateMVP=value},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"iNumPointLights",{get:function(){return this._pNumPointLights},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"iNumDirectionalLights",{get:function(){return this._pNumDirectionalLights},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"iNumLightProbes",{get:function(){return this._pNumLightProbes},enumerable:true,configurable:true});CompiledPass.prototype.iUpdateProgram=function(stage3DProxy){this.reset(stage3DProxy.profile);_super.prototype.iUpdateProgram.call(this,stage3DProxy)};CompiledPass.prototype.reset=function(profile){this.iInitCompiler(profile);this.pUpdateShaderProperties();this.initConstantData();this.pCleanUp()};CompiledPass.prototype.updateUsedOffsets=function(){this._pNumUsedVertexConstants=this._pCompiler.numUsedVertexConstants;this._pNumUsedFragmentConstants=this._pCompiler.numUsedFragmentConstants;this._pNumUsedStreams=this._pCompiler.numUsedStreams;this._pNumUsedTextures=this._pCompiler.numUsedTextures;this._pNumUsedVaryings=this._pCompiler.numUsedVaryings;this._pNumUsedFragmentConstants=this._pCompiler.numUsedFragmentConstants};CompiledPass.prototype.initConstantData=function(){this._pVertexConstantData.length=this._pNumUsedVertexConstants*4;this._pFragmentConstantData.length=this._pNumUsedFragmentConstants*4;this.pInitCommonsData();if(this._uvTransformIndex>=0){this.pInitUVTransformData()}if(this._pCameraPositionIndex>=0){this._pVertexConstantData[this._pCameraPositionIndex+3]=1}this.pUpdateMethodConstants()};CompiledPass.prototype.iInitCompiler=function(profile){this._pCompiler=this.pCreateCompiler(profile);this._pCompiler.forceSeperateMVP=this._forceSeparateMVP;this._pCompiler.numPointLights=this._pNumPointLights;this._pCompiler.numDirectionalLights=this._pNumDirectionalLights;this._pCompiler.numLightProbes=this._pNumLightProbes;this._pCompiler.methodSetup=this._pMethodSetup;this._pCompiler.diffuseLightSources=this._pDiffuseLightSources;this._pCompiler.specularLightSources=this._pSpecularLightSources;this._pCompiler.setTextureSampling(this._pSmooth,this._pRepeat,this._pMipmap);this._pCompiler.setConstantDataBuffers(this._pVertexConstantData,this._pFragmentConstantData);this._pCompiler.animateUVs=this._animateUVs;this._pCompiler.alphaPremultiplied=this._pAlphaPremultiplied&&this._pEnableBlending;this._pCompiler.preserveAlpha=this._preserveAlpha&&this._pEnableBlending;this._pCompiler.enableLightFallOff=this._enableLightFallOff;this._pCompiler.compile()};CompiledPass.prototype.pCreateCompiler=function(profile){throw new away.errors.AbstractMethodError()};CompiledPass.prototype.pUpdateShaderProperties=function(){this._pAnimatableAttributes=this._pCompiler.animatableAttributes;this._pAnimationTargetRegisters=this._pCompiler.animationTargetRegisters;this._vertexCode=this._pCompiler.vertexCode;this._fragmentLightCode=this._pCompiler.fragmentLightCode;this._framentPostLightCode=this._pCompiler.fragmentPostLightCode;this._pShadedTarget=this._pCompiler.shadedTarget;this._usingSpecularMethod=this._pCompiler.usingSpecularMethod;this._usesNormals=this._pCompiler.usesNormals;this._pNeedUVAnimation=this._pCompiler.needUVAnimation;this._pUVSource=this._pCompiler.UVSource;this._pUVTarget=this._pCompiler.UVTarget;this.pUpdateRegisterIndices();this.updateUsedOffsets()};CompiledPass.prototype.pUpdateRegisterIndices=function(){this._uvBufferIndex=this._pCompiler.uvBufferIndex;this._uvTransformIndex=this._pCompiler.uvTransformIndex;this._secondaryUVBufferIndex=this._pCompiler.secondaryUVBufferIndex;this._normalBufferIndex=this._pCompiler.normalBufferIndex;this._tangentBufferIndex=this._pCompiler.tangentBufferIndex;this._pLightFragmentConstantIndex=this._pCompiler.lightFragmentConstantIndex;this._pCameraPositionIndex=this._pCompiler.cameraPositionIndex;this._commonsDataIndex=this._pCompiler.commonsDataIndex;this._sceneMatrixIndex=this._pCompiler.sceneMatrixIndex;this._sceneNormalMatrixIndex=this._pCompiler.sceneNormalMatrixIndex;this._pProbeWeightsIndex=this._pCompiler.probeWeightsIndex;this._pLightProbeDiffuseIndices=this._pCompiler.lightProbeDiffuseIndices;this._pLightProbeSpecularIndices=this._pCompiler.lightProbeSpecularIndices};Object.defineProperty(CompiledPass.prototype,"preserveAlpha",{get:function(){return this._preserveAlpha},set:function(value){if(this._preserveAlpha==value){return}this._preserveAlpha=value;this.iInvalidateShaderProgram()},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"animateUVs",{get:function(){return this._animateUVs},set:function(value){this._animateUVs=value;if((value&&!this._animateUVs)||(!value&&this._animateUVs)){this.iInvalidateShaderProgram()}},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"mipmap",{set:function(value){if(this._pMipmap==value){return}_super.prototype.setMipMap.call(this,value)},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"normalMap",{get:function(){return this._pMethodSetup._iNormalMethod.normalMap},set:function(value){this._pMethodSetup._iNormalMethod.normalMap=value},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"normalMethod",{get:function(){return this._pMethodSetup.normalMethod},set:function(value){this._pMethodSetup.normalMethod=value},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"ambientMethod",{get:function(){return this._pMethodSetup.ambientMethod},set:function(value){this._pMethodSetup.ambientMethod=value},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"shadowMethod",{get:function(){return this._pMethodSetup.shadowMethod},set:function(value){this._pMethodSetup.shadowMethod=value},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"diffuseMethod",{get:function(){return this._pMethodSetup.diffuseMethod},set:function(value){this._pMethodSetup.diffuseMethod=value},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"specularMethod",{get:function(){return this._pMethodSetup.specularMethod},set:function(value){this._pMethodSetup.specularMethod=value},enumerable:true,configurable:true});CompiledPass.prototype.init=function(){this._pMethodSetup=new away.materials.ShaderMethodSetup();this._pMethodSetup.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this)};CompiledPass.prototype.dispose=function(){_super.prototype.dispose.call(this);this._pMethodSetup.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._pMethodSetup.dispose();this._pMethodSetup=null};CompiledPass.prototype.iInvalidateShaderProgram=function(updateMaterial){if(typeof updateMaterial==="undefined"){updateMaterial=true}var oldPasses=this._iPasses;this._iPasses=new Array();if(this._pMethodSetup){this.pAddPassesFromMethods()}if(!oldPasses||this._iPasses.length!=oldPasses.length){this._iPassesDirty=true;return}for(var i=0;i<this._iPasses.length;++i){if(this._iPasses[i]!=oldPasses[i]){this._iPassesDirty=true;return}}_super.prototype.iInvalidateShaderProgram.call(this,updateMaterial)};CompiledPass.prototype.pAddPassesFromMethods=function(){if(this._pMethodSetup._iNormalMethod&&this._pMethodSetup._iNormalMethod.iHasOutput){this.pAddPasses(this._pMethodSetup._iNormalMethod.passes)}if(this._pMethodSetup._iAmbientMethod){this.pAddPasses(this._pMethodSetup._iAmbientMethod.passes)}if(this._pMethodSetup._iShadowMethod){this.pAddPasses(this._pMethodSetup._iShadowMethod.passes)}if(this._pMethodSetup._iDiffuseMethod){this.pAddPasses(this._pMethodSetup._iDiffuseMethod.passes)}if(this._pMethodSetup._iSpecularMethod){this.pAddPasses(this._pMethodSetup._iSpecularMethod.passes)}};CompiledPass.prototype.pAddPasses=function(passes){if(!passes){return}var len=passes.length;for(var i=0;i<len;++i){passes[i].material=this.material;passes[i].lightPicker=this._pLightPicker;this._iPasses.push(passes[i])}};CompiledPass.prototype.pInitUVTransformData=function(){this._pVertexConstantData[this._uvTransformIndex]=1;this._pVertexConstantData[this._uvTransformIndex+1]=0;this._pVertexConstantData[this._uvTransformIndex+2]=0;this._pVertexConstantData[this._uvTransformIndex+3]=0;this._pVertexConstantData[this._uvTransformIndex+4]=0;this._pVertexConstantData[this._uvTransformIndex+5]=1;this._pVertexConstantData[this._uvTransformIndex+6]=0;this._pVertexConstantData[this._uvTransformIndex+7]=0};CompiledPass.prototype.pInitCommonsData=function(){this._pFragmentConstantData[this._commonsDataIndex]=0.5;this._pFragmentConstantData[this._commonsDataIndex+1]=0;this._pFragmentConstantData[this._commonsDataIndex+2]=1/255;this._pFragmentConstantData[this._commonsDataIndex+3]=1};CompiledPass.prototype.pCleanUp=function(){this._pCompiler.dispose();this._pCompiler=null};CompiledPass.prototype.pUpdateMethodConstants=function(){if(this._pMethodSetup._iNormalMethod){this._pMethodSetup._iNormalMethod.iInitConstants(this._pMethodSetup._iNormalMethodVO)}if(this._pMethodSetup._iDiffuseMethod){this._pMethodSetup._iDiffuseMethod.iInitConstants(this._pMethodSetup._iDiffuseMethodVO)}if(this._pMethodSetup._iAmbientMethod){this._pMethodSetup._iAmbientMethod.iInitConstants(this._pMethodSetup._iAmbientMethodVO)}if(this._usingSpecularMethod){this._pMethodSetup._iSpecularMethod.iInitConstants(this._pMethodSetup._iSpecularMethodVO)}if(this._pMethodSetup._iShadowMethod){this._pMethodSetup._iShadowMethod.iInitConstants(this._pMethodSetup._iShadowMethodVO)}};CompiledPass.prototype.pUpdateLightConstants=function(){};CompiledPass.prototype.pUpdateProbes=function(stage3DProxy){};CompiledPass.prototype.onShaderInvalidated=function(event){this.iInvalidateShaderProgram()};CompiledPass.prototype.iGetVertexCode=function(){return this._vertexCode};CompiledPass.prototype.iGetFragmentCode=function(animatorCode){return this._fragmentLightCode+animatorCode+this._framentPostLightCode};CompiledPass.prototype.iActivate=function(stage3DProxy,camera){_super.prototype.iActivate.call(this,stage3DProxy,camera);if(this._usesNormals){this._pMethodSetup._iNormalMethod.iActivate(this._pMethodSetup._iNormalMethodVO,stage3DProxy)}this._pMethodSetup._iAmbientMethod.iActivate(this._pMethodSetup._iAmbientMethodVO,stage3DProxy);if(this._pMethodSetup._iShadowMethod){this._pMethodSetup._iShadowMethod.iActivate(this._pMethodSetup._iShadowMethodVO,stage3DProxy)}this._pMethodSetup._iDiffuseMethod.iActivate(this._pMethodSetup._iDiffuseMethodVO,stage3DProxy);if(this._usingSpecularMethod){this._pMethodSetup._iSpecularMethod.iActivate(this._pMethodSetup._iSpecularMethodVO,stage3DProxy)}};CompiledPass.prototype.iRender=function(renderable,stage3DProxy,camera,viewProjection){var i;var context=stage3DProxy._iContext3D;if(this._uvBufferIndex>=0){renderable.activateUVBuffer(this._uvBufferIndex,stage3DProxy)}if(this._secondaryUVBufferIndex>=0){renderable.activateSecondaryUVBuffer(this._secondaryUVBufferIndex,stage3DProxy)}if(this._normalBufferIndex>=0){renderable.activateVertexNormalBuffer(this._normalBufferIndex,stage3DProxy)}if(this._tangentBufferIndex>=0){renderable.activateVertexTangentBuffer(this._tangentBufferIndex,stage3DProxy)}if(this._animateUVs){var uvTransform=renderable.uvTransform;if(uvTransform){this._pVertexConstantData[this._uvTransformIndex]=uvTransform.a;this._pVertexConstantData[this._uvTransformIndex+1]=uvTransform.b;this._pVertexConstantData[this._uvTransformIndex+3]=uvTransform.tx;this._pVertexConstantData[this._uvTransformIndex+4]=uvTransform.c;this._pVertexConstantData[this._uvTransformIndex+5]=uvTransform.d;this._pVertexConstantData[this._uvTransformIndex+7]=uvTransform.ty}else{this._pVertexConstantData[this._uvTransformIndex]=1;this._pVertexConstantData[this._uvTransformIndex+1]=0;this._pVertexConstantData[this._uvTransformIndex+3]=0;this._pVertexConstantData[this._uvTransformIndex+4]=0;this._pVertexConstantData[this._uvTransformIndex+5]=1;this._pVertexConstantData[this._uvTransformIndex+7]=0}}this._pAmbientLightR=this._pAmbientLightG=this._pAmbientLightB=0;if(this.pUsesLights()){this.pUpdateLightConstants()}if(this.pUsesProbes()){this.pUpdateProbes(stage3DProxy)}if(this._sceneMatrixIndex>=0){renderable.getRenderSceneTransform(camera).copyRawDataTo(this._pVertexConstantData,this._sceneMatrixIndex,true);viewProjection.copyRawDataTo(this._pVertexConstantData,0,true)}else{var matrix3D=away.math.Matrix3DUtils.CALCULATION_MATRIX;matrix3D.copyFrom(renderable.getRenderSceneTransform(camera));matrix3D.append(viewProjection);matrix3D.copyRawDataTo(this._pVertexConstantData,0,true)}if(this._sceneNormalMatrixIndex>=0){renderable.inverseSceneTransform.copyRawDataTo(this._pVertexConstantData,this._sceneNormalMatrixIndex,false)}if(this._usesNormals){this._pMethodSetup._iNormalMethod.iSetRenderState(this._pMethodSetup._iNormalMethodVO,renderable,stage3DProxy,camera)}var ambientMethod=this._pMethodSetup._iAmbientMethod;ambientMethod._iLightAmbientR=this._pAmbientLightR;ambientMethod._iLightAmbientG=this._pAmbientLightG;ambientMethod._iLightAmbientB=this._pAmbientLightB;ambientMethod.iSetRenderState(this._pMethodSetup._iAmbientMethodVO,renderable,stage3DProxy,camera);if(this._pMethodSetup._iShadowMethod){this._pMethodSetup._iShadowMethod.iSetRenderState(this._pMethodSetup._iShadowMethodVO,renderable,stage3DProxy,camera)}this._pMethodSetup._iDiffuseMethod.iSetRenderState(this._pMethodSetup._iDiffuseMethodVO,renderable,stage3DProxy,camera);if(this._usingSpecularMethod){this._pMethodSetup._iSpecularMethod.iSetRenderState(this._pMethodSetup._iSpecularMethodVO,renderable,stage3DProxy,camera)}if(this._pMethodSetup._iColorTransformMethod){this._pMethodSetup._iColorTransformMethod.iSetRenderState(this._pMethodSetup._iColorTransformMethodVO,renderable,stage3DProxy,camera)}var methods=this._pMethodSetup._iMethods;var len=methods.length;for(i=0;i<len;++i){var aset=methods[i];aset.method.iSetRenderState(aset.data,renderable,stage3DProxy,camera)}context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.VERTEX,0,this._pVertexConstantData,this._pNumUsedVertexConstants);context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.FRAGMENT,0,this._pFragmentConstantData,this._pNumUsedFragmentConstants);renderable.activateVertexBuffer(0,stage3DProxy);context.drawTriangles(renderable.getIndexBuffer(stage3DProxy),0,renderable.numTriangles)};CompiledPass.prototype.pUsesProbes=function(){return this._pNumLightProbes>0&&((this._pDiffuseLightSources|this._pSpecularLightSources)&away.materials.LightSources.PROBES)!=0};CompiledPass.prototype.pUsesLights=function(){return(this._pNumPointLights>0||this._pNumDirectionalLights>0)&&((this._pDiffuseLightSources|this._pSpecularLightSources)&away.materials.LightSources.LIGHTS)!=0};CompiledPass.prototype.iDeactivate=function(stage3DProxy){_super.prototype.iDeactivate.call(this,stage3DProxy);if(this._usesNormals){this._pMethodSetup._iNormalMethod.iDeactivate(this._pMethodSetup._iNormalMethodVO,stage3DProxy)}this._pMethodSetup._iAmbientMethod.iDeactivate(this._pMethodSetup._iAmbientMethodVO,stage3DProxy);if(this._pMethodSetup._iShadowMethod){this._pMethodSetup._iShadowMethod.iDeactivate(this._pMethodSetup._iShadowMethodVO,stage3DProxy)}this._pMethodSetup._iDiffuseMethod.iDeactivate(this._pMethodSetup._iDiffuseMethodVO,stage3DProxy);if(this._usingSpecularMethod){this._pMethodSetup._iSpecularMethod.iDeactivate(this._pMethodSetup._iSpecularMethodVO,stage3DProxy)}};Object.defineProperty(CompiledPass.prototype,"specularLightSources",{get:function(){return this._pSpecularLightSources},set:function(value){this._pSpecularLightSources=value},enumerable:true,configurable:true});Object.defineProperty(CompiledPass.prototype,"diffuseLightSources",{get:function(){return this._pDiffuseLightSources},set:function(value){this._pDiffuseLightSources=value},enumerable:true,configurable:true});return CompiledPass})(away.materials.MaterialPassBase);materials.CompiledPass=CompiledPass})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var SuperShaderPass=(function(_super){__extends(SuperShaderPass,_super);function SuperShaderPass(material){_super.call(this,material);this._includeCasters=true;this._pNeedFragmentAnimation=true}SuperShaderPass.prototype.pCreateCompiler=function(profile){return new away.materials.SuperShaderCompiler(profile)};Object.defineProperty(SuperShaderPass.prototype,"includeCasters",{get:function(){return this._includeCasters},set:function(value){if(this._includeCasters==value){return}this._includeCasters=value;this.iInvalidateShaderProgram()},enumerable:true,configurable:true});Object.defineProperty(SuperShaderPass.prototype,"colorTransform",{get:function(){return this._pMethodSetup._iColorTransformMethod?this._pMethodSetup._iColorTransformMethod.colorTransform:null},set:function(value){if(value){if(this.colorTransformMethod==null){this.colorTransformMethod=new away.materials.ColorTransformMethod()}this._pMethodSetup._iColorTransformMethod.colorTransform=value}else{if(!value){if(this._pMethodSetup._iColorTransformMethod){this.colorTransformMethod=null}this.colorTransformMethod=this._pMethodSetup._iColorTransformMethod=null}}},enumerable:true,configurable:true});Object.defineProperty(SuperShaderPass.prototype,"colorTransformMethod",{get:function(){return this._pMethodSetup._iColorTransformMethod},set:function(value){this._pMethodSetup.iColorTransformMethod=value},enumerable:true,configurable:true});SuperShaderPass.prototype.addMethod=function(method){this._pMethodSetup.addMethod(method)};Object.defineProperty(SuperShaderPass.prototype,"numMethods",{get:function(){return this._pMethodSetup.numMethods},enumerable:true,configurable:true});SuperShaderPass.prototype.hasMethod=function(method){return this._pMethodSetup.hasMethod(method)};SuperShaderPass.prototype.getMethodAt=function(index){return this._pMethodSetup.getMethodAt(index)};SuperShaderPass.prototype.addMethodAt=function(method,index){this._pMethodSetup.addMethodAt(method,index)};SuperShaderPass.prototype.removeMethod=function(method){this._pMethodSetup.removeMethod(method)};SuperShaderPass.prototype.pUpdateLights=function(){if(this._pLightPicker&&!this._ignoreLights){this._pNumPointLights=this._pLightPicker.numPointLights;this._pNumDirectionalLights=this._pLightPicker.numDirectionalLights;this._pNumLightProbes=this._pLightPicker.numLightProbes;if(this._includeCasters){this._pNumPointLights+=this._pLightPicker.numCastingPointLights;this._pNumDirectionalLights+=this._pLightPicker.numCastingDirectionalLights}}else{this._pNumPointLights=0;this._pNumDirectionalLights=0;this._pNumLightProbes=0}this.iInvalidateShaderProgram()};SuperShaderPass.prototype.iActivate=function(stage3DProxy,camera){_super.prototype.iActivate.call(this,stage3DProxy,camera);if(this._pMethodSetup._iColorTransformMethod){this._pMethodSetup._iColorTransformMethod.iActivate(this._pMethodSetup._iColorTransformMethodVO,stage3DProxy)}var methods=this._pMethodSetup._iMethods;var len=methods.length;for(var i=0;i<len;++i){var aset=methods[i];aset.method.iActivate(aset.data,stage3DProxy)}if(this._pCameraPositionIndex>=0){var pos=camera.scenePosition;this._pVertexConstantData[this._pCameraPositionIndex]=pos.x;this._pVertexConstantData[this._pCameraPositionIndex+1]=pos.y;this._pVertexConstantData[this._pCameraPositionIndex+2]=pos.z}};SuperShaderPass.prototype.iDeactivate=function(stage3DProxy){_super.prototype.iDeactivate.call(this,stage3DProxy);if(this._pMethodSetup._iColorTransformMethod){this._pMethodSetup._iColorTransformMethod.iDeactivate(this._pMethodSetup._iColorTransformMethodVO,stage3DProxy)}var aset;var methods=this._pMethodSetup._iMethods;var len=methods.length;for(var i=0;i<len;++i){aset=methods[i];aset.method.iDeactivate(aset.data,stage3DProxy)}};SuperShaderPass.prototype.pAddPassesFromMethods=function(){_super.prototype.pAddPassesFromMethods.call(this);if(this._pMethodSetup._iColorTransformMethod){this.pAddPasses(this._pMethodSetup._iColorTransformMethod.passes)}var methods=this._pMethodSetup._iMethods;for(var i=0;i<methods.length;++i){this.pAddPasses(methods[i].method.passes)}};SuperShaderPass.prototype.usesProbesForSpecular=function(){return this._pNumLightProbes>0&&(this._pSpecularLightSources&away.materials.LightSources.PROBES)!=0};SuperShaderPass.prototype.usesProbesForDiffuse=function(){return this._pNumLightProbes>0&&(this._pDiffuseLightSources&away.materials.LightSources.PROBES)!=0};SuperShaderPass.prototype.pUpdateMethodConstants=function(){_super.prototype.pUpdateMethodConstants.call(this);if(this._pMethodSetup._iColorTransformMethod){this._pMethodSetup._iColorTransformMethod.iInitConstants(this._pMethodSetup._iColorTransformMethodVO)}var methods=this._pMethodSetup._iMethods;var len=methods.length;for(var i=0;i<len;++i){methods[i].method.iInitConstants(methods[i].data)}};SuperShaderPass.prototype.pUpdateLightConstants=function(){var dirLight;var pointLight;var i,k;var len;var dirPos;var total=0;var numLightTypes=this._includeCasters?2:1;k=this._pLightFragmentConstantIndex;for(var cast=0;cast<numLightTypes;++cast){var dirLights=cast?this._pLightPicker.castingDirectionalLights:this._pLightPicker.directionalLights;len=dirLights.length;total+=len;for(i=0;i<len;++i){dirLight=dirLights[i];dirPos=dirLight.sceneDirection;this._pAmbientLightR+=dirLight._iAmbientR;this._pAmbientLightG+=dirLight._iAmbientG;this._pAmbientLightB+=dirLight._iAmbientB;this._pFragmentConstantData[k++]=-dirPos.x;this._pFragmentConstantData[k++]=-dirPos.y;this._pFragmentConstantData[k++]=-dirPos.z;this._pFragmentConstantData[k++]=1;this._pFragmentConstantData[k++]=dirLight._iDiffuseR;this._pFragmentConstantData[k++]=dirLight._iDiffuseG;this._pFragmentConstantData[k++]=dirLight._iDiffuseB;this._pFragmentConstantData[k++]=1;this._pFragmentConstantData[k++]=dirLight._iSpecularR;this._pFragmentConstantData[k++]=dirLight._iSpecularG;this._pFragmentConstantData[k++]=dirLight._iSpecularB;this._pFragmentConstantData[k++]=1}}if(this._pNumDirectionalLights>total){i=k+(this._pNumDirectionalLights-total)*12;while(k<i){this._pFragmentConstantData[k++]=0}}total=0;for(cast=0;cast<numLightTypes;++cast){var pointLights=cast?this._pLightPicker.castingPointLights:this._pLightPicker.pointLights;len=pointLights.length;for(i=0;i<len;++i){pointLight=pointLights[i];dirPos=pointLight.scenePosition;this._pAmbientLightR+=pointLight._iAmbientR;this._pAmbientLightG+=pointLight._iAmbientG;this._pAmbientLightB+=pointLight._iAmbientB;this._pFragmentConstantData[k++]=dirPos.x;this._pFragmentConstantData[k++]=dirPos.y;this._pFragmentConstantData[k++]=dirPos.z;this._pFragmentConstantData[k++]=1;this._pFragmentConstantData[k++]=pointLight._iDiffuseR;this._pFragmentConstantData[k++]=pointLight._iDiffuseG;this._pFragmentConstantData[k++]=pointLight._iDiffuseB;this._pFragmentConstantData[k++]=pointLight._pRadius*pointLight._pRadius;this._pFragmentConstantData[k++]=pointLight._iSpecularR;this._pFragmentConstantData[k++]=pointLight._iSpecularG;this._pFragmentConstantData[k++]=pointLight._iSpecularB;this._pFragmentConstantData[k++]=pointLight._pFallOffFactor}}if(this._pNumPointLights>total){i=k+(total-this._pNumPointLights)*12;for(;k<i;++k){this._pFragmentConstantData[k]=0}}};SuperShaderPass.prototype.pUpdateProbes=function(stage3DProxy){var probe;var lightProbes=this._pLightPicker.lightProbes;var weights=this._pLightPicker.lightProbeWeights;var len=lightProbes.length;var addDiff=this.usesProbesForDiffuse();var addSpec=(this._pMethodSetup._iSpecularMethod&&this.usesProbesForSpecular());var context=stage3DProxy._iContext3D;if(!(addDiff||addSpec)){return}for(var i=0;i<len;++i){probe=lightProbes[i];if(addDiff){context.setTextureAt(this._pLightProbeSpecularIndices[i],probe.diffuseMap.getTextureForStage3D(stage3DProxy))}if(addSpec){context.setTextureAt(this._pLightProbeSpecularIndices[i],probe.specularMap.getTextureForStage3D(stage3DProxy))}}this._pFragmentConstantData[this._pProbeWeightsIndex]=weights[0];this._pFragmentConstantData[this._pProbeWeightsIndex+1]=weights[1];this._pFragmentConstantData[this._pProbeWeightsIndex+2]=weights[2];this._pFragmentConstantData[this._pProbeWeightsIndex+3]=weights[3]};Object.defineProperty(SuperShaderPass.prototype,"iIgnoreLights",{get:function(){return this._ignoreLights},set:function(ignoreLights){this._ignoreLights=ignoreLights},enumerable:true,configurable:true});return SuperShaderPass})(away.materials.CompiledPass);materials.SuperShaderPass=SuperShaderPass})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var DepthMapPass=(function(_super){__extends(DepthMapPass,_super);function DepthMapPass(){_super.call(this);this._alphaThreshold=0;this._data=new Array(1,255,65025,16581375,1/255,1/255,1/255,0,0,0,0,0)}Object.defineProperty(DepthMapPass.prototype,"alphaThreshold",{get:function(){return this._alphaThreshold},set:function(value){if(value<0){value=0}else{if(value>1){value=1}}if(value==this._alphaThreshold){return}if(value==0||this._alphaThreshold==0){this.iInvalidateShaderProgram()}this._alphaThreshold=value;this._data[8]=this._alphaThreshold},enumerable:true,configurable:true});Object.defineProperty(DepthMapPass.prototype,"alphaMask",{get:function(){return this._alphaMask},set:function(value){this._alphaMask=value},enumerable:true,configurable:true});DepthMapPass.prototype.iGetVertexCode=function(){var code="";code="m44 vt1, vt0, vc0		\nmov op, vt1	\n";if(this._alphaThreshold>0){this._pNumUsedTextures=1;this._pNumUsedStreams=2;code+="mov v0, vt1\nmov v1, va1\n"}else{this._pNumUsedTextures=0;this._pNumUsedStreams=1;code+="mov v0, vt1\n"}return code};DepthMapPass.prototype.iGetFragmentCode=function(code){var wrap=this._pRepeat?"wrap":"clamp";var filter;if(this._pSmooth){filter=this._pMipmap?"linear,miplinear":"linear"}else{filter=this._pMipmap?"nearest,mipnearest":"nearest"}var codeF="div ft2, v0, v0.w		\nmul ft0, fc0, ft2.z	\nfrc ft0, ft0			\nmul ft1, ft0.yzww, fc1	\n";if(this._alphaThreshold>0){var format;switch(this._alphaMask.format){case away.display3D.Context3DTextureFormat.COMPRESSED:format="dxt1,";break;case"compressedAlpha":format="dxt5,";break;default:format=""}codeF+="tex ft3, v1, fs0 <2d,"+filter+","+format+wrap+">\nsub ft3.w, ft3.w, fc2.x\nkil ft3.w\n"}codeF+="sub oc, ft0, ft1		\n";return codeF};DepthMapPass.prototype.iRender=function(renderable,stage3DProxy,camera,viewProjection){if(this._alphaThreshold>0){renderable.activateUVBuffer(1,stage3DProxy)}var context=stage3DProxy._iContext3D;var matrix=away.math.Matrix3DUtils.CALCULATION_MATRIX;matrix.copyFrom(renderable.getRenderSceneTransform(camera));matrix.append(viewProjection);context.setProgramConstantsFromMatrix(away.display3D.Context3DProgramType.VERTEX,0,matrix,true);renderable.activateVertexBuffer(0,stage3DProxy);context.drawTriangles(renderable.getIndexBuffer(stage3DProxy),0,renderable.numTriangles)};DepthMapPass.prototype.iActivate=function(stage3DProxy,camera){var context=stage3DProxy._iContext3D;_super.prototype.iActivate.call(this,stage3DProxy,camera);if(this._alphaThreshold>0){context.setTextureAt(0,this._alphaMask.getTextureForStage3D(stage3DProxy));context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.FRAGMENT,0,this._data,3)}else{context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.FRAGMENT,0,this._data,2)}};return DepthMapPass})(away.materials.MaterialPassBase);materials.DepthMapPass=DepthMapPass})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var DistanceMapPass=(function(_super){__extends(DistanceMapPass,_super);function DistanceMapPass(){_super.call(this);this._fragmentData=new Array(1,255,65025,16581375,1/255,1/255,1/255,0,0,0,0,0);this._vertexData=new Array(4);this._vertexData[3]=1;this._pNumUsedVertexConstants=9}Object.defineProperty(DistanceMapPass.prototype,"alphaThreshold",{get:function(){return this._alphaThreshold},set:function(value){if(value<0){value=0}else{if(value>1){value=1}}if(value==this._alphaThreshold){return}if(value==0||this._alphaThreshold==0){this.iInvalidateShaderProgram()}this._alphaThreshold=value;this._fragmentData[8]=this._alphaThreshold},enumerable:true,configurable:true});Object.defineProperty(DistanceMapPass.prototype,"alphaMask",{get:function(){return this._alphaMask},set:function(value){this._alphaMask=value},enumerable:true,configurable:true});DistanceMapPass.prototype.iGetVertexCode=function(){var code;code="m44 op, vt0, vc0		\nm44 vt1, vt0, vc5		\nsub v0, vt1, vc9		\n";if(this._alphaThreshold>0){code+="mov v1, va1\n";this._pNumUsedTextures=1;this._pNumUsedStreams=2}else{this._pNumUsedTextures=0;this._pNumUsedStreams=1}return code};DistanceMapPass.prototype.iGetFragmentCode=function(animationCode){animationCode=animationCode;var code;var wrap=this._pRepeat?"wrap":"clamp";var filter;if(this._pSmooth){filter=this._pMipmap?"linear,miplinear":"linear"}else{filter=this._pMipmap?"nearest,mipnearest":"nearest"}code="dp3 ft2.z, v0.xyz, v0.xyz	\nmul ft0, fc0, ft2.z	\nfrc ft0, ft0			\nmul ft1, ft0.yzww, fc1	\n";if(this._alphaThreshold>0){var format;switch(this._alphaMask.format){case away.display3D.Context3DTextureFormat.COMPRESSED:format="dxt1,";break;case"compressedAlpha":format="dxt5,";break;default:format=""}code+="tex ft3, v1, fs0 <2d,"+filter+","+format+wrap+">\nsub ft3.w, ft3.w, fc2.x\nkil ft3.w\n"}code+="sub oc, ft0, ft1		\n";return code};DistanceMapPass.prototype.iRender=function(renderable,stage3DProxy,camera,viewProjection){var context=stage3DProxy._iContext3D;var pos=camera.scenePosition;this._vertexData[0]=pos.x;this._vertexData[1]=pos.y;this._vertexData[2]=pos.z;this._vertexData[3]=1;var sceneTransform=renderable.getRenderSceneTransform(camera);context.setProgramConstantsFromMatrix(away.display3D.Context3DProgramType.VERTEX,5,sceneTransform,true);context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.VERTEX,9,this._vertexData,1);if(this._alphaThreshold>0){renderable.activateUVBuffer(1,stage3DProxy)}var matrix=away.math.Matrix3DUtils.CALCULATION_MATRIX;matrix.copyFrom(sceneTransform);matrix.append(viewProjection);context.setProgramConstantsFromMatrix(away.display3D.Context3DProgramType.VERTEX,0,matrix,true);renderable.activateVertexBuffer(0,stage3DProxy);context.drawTriangles(renderable.getIndexBuffer(stage3DProxy),0,renderable.numTriangles)};DistanceMapPass.prototype.iActivate=function(stage3DProxy,camera){var context=stage3DProxy._iContext3D;_super.prototype.iActivate.call(this,stage3DProxy,camera);var f=camera.lens.far;f=1/(2*f*f);this._fragmentData[0]=1*f;this._fragmentData[1]=255*f;this._fragmentData[2]=65025*f;this._fragmentData[3]=16581375*f;if(this._alphaThreshold>0){context.setTextureAt(0,this._alphaMask.getTextureForStage3D(stage3DProxy));context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.FRAGMENT,0,this._fragmentData,3)}else{context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.FRAGMENT,0,this._fragmentData,2)}};return DistanceMapPass})(away.materials.MaterialPassBase);materials.DistanceMapPass=DistanceMapPass})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var LightingPass=(function(_super){__extends(LightingPass,_super);function LightingPass(material){_super.call(this,material);this._includeCasters=true;this._inverseSceneMatrix=new Array();this._maxLights=3}Object.defineProperty(LightingPass.prototype,"directionalLightsOffset",{get:function(){return this._directionalLightsOffset},set:function(value){this._directionalLightsOffset=value},enumerable:true,configurable:true});Object.defineProperty(LightingPass.prototype,"pointLightsOffset",{get:function(){return this._pointLightsOffset},set:function(value){this._pointLightsOffset=value},enumerable:true,configurable:true});Object.defineProperty(LightingPass.prototype,"lightProbesOffset",{get:function(){return this._lightProbesOffset},set:function(value){this._lightProbesOffset=value},enumerable:true,configurable:true});LightingPass.prototype.pCreateCompiler=function(profile){this._maxLights=profile=="baselineConstrained"?1:3;return new away.materials.LightingShaderCompiler(profile)};Object.defineProperty(LightingPass.prototype,"includeCasters",{get:function(){return this._includeCasters},set:function(value){if(this._includeCasters==value){return}this._includeCasters=value;this.iInvalidateShaderProgram()},enumerable:true,configurable:true});LightingPass.prototype.pUpdateLights=function(){_super.prototype.pUpdateLights.call(this);var numDirectionalLights;var numPointLights=0;var numLightProbes=0;if(this._pLightPicker){numDirectionalLights=this.calculateNumDirectionalLights(this._pLightPicker.numDirectionalLights);numPointLights=this.calculateNumPointLights(this._pLightPicker.numPointLights);numLightProbes=this.calculateNumProbes(this._pLightPicker.numLightProbes);if(this._includeCasters){numPointLights+=this._pLightPicker.numCastingPointLights;numDirectionalLights+=this._pLightPicker.numCastingDirectionalLights}}else{numDirectionalLights=0;numPointLights=0;numLightProbes=0}if(numPointLights!=this._pNumPointLights||numDirectionalLights!=this._pNumDirectionalLights||numLightProbes!=this._pNumLightProbes){this._pNumPointLights=numPointLights;this._pNumDirectionalLights=numDirectionalLights;this._pNumLightProbes=numLightProbes;this.iInvalidateShaderProgram()}};LightingPass.prototype.calculateNumDirectionalLights=function(numDirectionalLights){return Math.min(numDirectionalLights-this._directionalLightsOffset,this._maxLights)};LightingPass.prototype.calculateNumPointLights=function(numPointLights){var numFree=this._maxLights-this._pNumDirectionalLights;return Math.min(numPointLights-this._pointLightsOffset,numFree)};LightingPass.prototype.calculateNumProbes=function(numLightProbes){var numChannels=0;if((this._pSpecularLightSources&away.materials.LightSources.PROBES)!=0){++numChannels}if((this._pDiffuseLightSources&away.materials.LightSources.PROBES)!=0){++numChannels}return Math.min(numLightProbes-this._lightProbesOffset,(4/numChannels)|0)};LightingPass.prototype.pUpdateShaderProperties=function(){_super.prototype.pUpdateShaderProperties.call(this);var compilerV=this._pCompiler;this._tangentSpace=compilerV.tangentSpace};LightingPass.prototype.pUpdateRegisterIndices=function(){_super.prototype.pUpdateRegisterIndices.call(this);var compilerV=this._pCompiler;this._lightVertexConstantIndex=compilerV.lightVertexConstantIndex};LightingPass.prototype.iRender=function(renderable,stage3DProxy,camera,viewProjection){renderable.inverseSceneTransform.copyRawDataTo(this._inverseSceneMatrix);if(this._tangentSpace&&this._pCameraPositionIndex>=0){var pos=camera.scenePosition;var x=pos.x;var y=pos.y;var z=pos.z;this._pVertexConstantData[this._pCameraPositionIndex]=this._inverseSceneMatrix[0]*x+this._inverseSceneMatrix[4]*y+this._inverseSceneMatrix[8]*z+this._inverseSceneMatrix[12];this._pVertexConstantData[this._pCameraPositionIndex+1]=this._inverseSceneMatrix[1]*x+this._inverseSceneMatrix[5]*y+this._inverseSceneMatrix[9]*z+this._inverseSceneMatrix[13];this._pVertexConstantData[this._pCameraPositionIndex+2]=this._inverseSceneMatrix[2]*x+this._inverseSceneMatrix[6]*y+this._inverseSceneMatrix[10]*z+this._inverseSceneMatrix[14]}_super.prototype.iRender.call(this,renderable,stage3DProxy,camera,viewProjection)};LightingPass.prototype.iActivate=function(stage3DProxy,camera){_super.prototype.iActivate.call(this,stage3DProxy,camera);if(!this._tangentSpace&&this._pCameraPositionIndex>=0){var pos=camera.scenePosition;this._pVertexConstantData[this._pCameraPositionIndex]=pos.x;this._pVertexConstantData[this._pCameraPositionIndex+1]=pos.y;this._pVertexConstantData[this._pCameraPositionIndex+2]=pos.z}};LightingPass.prototype.usesProbesForSpecular=function(){return this._pNumLightProbes>0&&(this._pSpecularLightSources&away.materials.LightSources.PROBES)!=0};LightingPass.prototype.usesProbesForDiffuse=function(){return this._pNumLightProbes>0&&(this._pDiffuseLightSources&away.materials.LightSources.PROBES)!=0};LightingPass.prototype.pUpdateLightConstants=function(){var dirLight;var pointLight;var i=0;var k=0;var len;var dirPos;var total=0;var numLightTypes=this._includeCasters?2:1;var l;var offset;l=this._lightVertexConstantIndex;k=this._pLightFragmentConstantIndex;var cast=0;var dirLights=this._pLightPicker.directionalLights;offset=this._directionalLightsOffset;len=this._pLightPicker.directionalLights.length;if(offset>len){cast=1;offset-=len}for(;cast<numLightTypes;++cast){if(cast){dirLights=this._pLightPicker.castingDirectionalLights}len=dirLights.length;if(len>this._pNumDirectionalLights){len=this._pNumDirectionalLights}for(i=0;i<len;++i){dirLight=dirLights[offset+i];dirPos=dirLight.sceneDirection;this._pAmbientLightR+=dirLight._iAmbientR;this._pAmbientLightG+=dirLight._iAmbientG;this._pAmbientLightB+=dirLight._iAmbientB;if(this._tangentSpace){var x=-dirPos.x;var y=-dirPos.y;var z=-dirPos.z;this._pVertexConstantData[l++]=this._inverseSceneMatrix[0]*x+this._inverseSceneMatrix[4]*y+this._inverseSceneMatrix[8]*z;this._pVertexConstantData[l++]=this._inverseSceneMatrix[1]*x+this._inverseSceneMatrix[5]*y+this._inverseSceneMatrix[9]*z;this._pVertexConstantData[l++]=this._inverseSceneMatrix[2]*x+this._inverseSceneMatrix[6]*y+this._inverseSceneMatrix[10]*z;this._pVertexConstantData[l++]=1}else{this._pFragmentConstantData[k++]=-dirPos.x;this._pFragmentConstantData[k++]=-dirPos.y;this._pFragmentConstantData[k++]=-dirPos.z;this._pFragmentConstantData[k++]=1}this._pFragmentConstantData[k++]=dirLight._iDiffuseR;this._pFragmentConstantData[k++]=dirLight._iDiffuseG;this._pFragmentConstantData[k++]=dirLight._iDiffuseB;this._pFragmentConstantData[k++]=1;this._pFragmentConstantData[k++]=dirLight._iSpecularR;this._pFragmentConstantData[k++]=dirLight._iSpecularG;this._pFragmentConstantData[k++]=dirLight._iSpecularB;this._pFragmentConstantData[k++]=1;if(++total==this._pNumDirectionalLights){i=len;cast=numLightTypes}}}if(this._pNumDirectionalLights>total){i=k+(this._pNumDirectionalLights-total)*12;while(k<i){this._pFragmentConstantData[k++]=0}}total=0;var pointLights=this._pLightPicker.pointLights;offset=this._pointLightsOffset;len=this._pLightPicker.pointLights.length;if(offset>len){cast=1;offset-=len}else{cast=0}for(;cast<numLightTypes;++cast){if(cast){pointLights=this._pLightPicker.castingPointLights}len=pointLights.length;for(i=0;i<len;++i){pointLight=pointLights[offset+i];dirPos=pointLight.scenePosition;this._pAmbientLightR+=pointLight._iAmbientR;this._pAmbientLightG+=pointLight._iAmbientG;this._pAmbientLightB+=pointLight._iAmbientB;if(this._tangentSpace){x=dirPos.x;y=dirPos.y;z=dirPos.z;this._pVertexConstantData[l++]=this._inverseSceneMatrix[0]*x+this._inverseSceneMatrix[4]*y+this._inverseSceneMatrix[8]*z+this._inverseSceneMatrix[12];this._pVertexConstantData[l++]=this._inverseSceneMatrix[1]*x+this._inverseSceneMatrix[5]*y+this._inverseSceneMatrix[9]*z+this._inverseSceneMatrix[13];this._pVertexConstantData[l++]=this._inverseSceneMatrix[2]*x+this._inverseSceneMatrix[6]*y+this._inverseSceneMatrix[10]*z+this._inverseSceneMatrix[14]}else{this._pVertexConstantData[l++]=dirPos.x;this._pVertexConstantData[l++]=dirPos.y;this._pVertexConstantData[l++]=dirPos.z}this._pVertexConstantData[l++]=1;this._pFragmentConstantData[k++]=pointLight._iDiffuseR;this._pFragmentConstantData[k++]=pointLight._iDiffuseG;this._pFragmentConstantData[k++]=pointLight._iDiffuseB;var radius=pointLight._pRadius;this._pFragmentConstantData[k++]=radius*radius;this._pFragmentConstantData[k++]=pointLight._iSpecularR;this._pFragmentConstantData[k++]=pointLight._iSpecularG;this._pFragmentConstantData[k++]=pointLight._iSpecularB;this._pFragmentConstantData[k++]=pointLight._pFallOffFactor;if(++total==this._pNumPointLights){i=len;cast=numLightTypes}}}if(this._pNumPointLights>total){i=k+(total-this._pNumPointLights)*12;for(;k<i;++k){this._pFragmentConstantData[k]=0}}};LightingPass.prototype.pUpdateProbes=function(stage3DProxy){var context=stage3DProxy._iContext3D;var probe;var lightProbes=this._pLightPicker.lightProbes;var weights=this._pLightPicker.lightProbeWeights;var len=lightProbes.length-this._lightProbesOffset;var addDiff=this.usesProbesForDiffuse();var addSpec=(this._pMethodSetup._iSpecularMethod&&this.usesProbesForSpecular());if(!(addDiff||addSpec)){return}if(len>this._pNumLightProbes){len=this._pNumLightProbes}for(var i=0;i<len;++i){probe=lightProbes[this._lightProbesOffset+i];if(addDiff){context.setTextureAt(this._pLightProbeDiffuseIndices[i],probe.diffuseMap.getTextureForStage3D(stage3DProxy))}if(addSpec){context.setTextureAt(this._pLightProbeSpecularIndices[i],probe.specularMap.getTextureForStage3D(stage3DProxy))}}for(i=0;i<len;++i){this._pFragmentConstantData[this._pProbeWeightsIndex+i]=weights[this._lightProbesOffset+i]}};return LightingPass})(away.materials.CompiledPass);materials.LightingPass=LightingPass})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ShadowCasterPass=(function(_super){__extends(ShadowCasterPass,_super);function ShadowCasterPass(material){_super.call(this,material);this._inverseSceneMatrix=new Array()}ShadowCasterPass.prototype.pCreateCompiler=function(profile){return new away.materials.LightingShaderCompiler(profile)};ShadowCasterPass.prototype.pUpdateLights=function(){_super.prototype.pUpdateLights.call(this);var numPointLights=0;var numDirectionalLights=0;if(this._pLightPicker){numPointLights=this._pLightPicker.numCastingPointLights>0?1:0;numDirectionalLights=this._pLightPicker.numCastingDirectionalLights>0?1:0}else{numPointLights=0;numDirectionalLights=0}this._pNumLightProbes=0;if(numPointLights+numDirectionalLights>1){throw new Error("Must have exactly one light!")}if(numPointLights!=this._pNumPointLights||numDirectionalLights!=this._pNumDirectionalLights){this._pNumPointLights=numPointLights;this._pNumDirectionalLights=numDirectionalLights;this.iInvalidateShaderProgram()}};ShadowCasterPass.prototype.pUpdateShaderProperties=function(){_super.prototype.pUpdateShaderProperties.call(this);var c=this._pCompiler;this._tangentSpace=c.tangentSpace};ShadowCasterPass.prototype.pUpdateRegisterIndices=function(){_super.prototype.pUpdateRegisterIndices.call(this);var c=this._pCompiler;this._lightVertexConstantIndex=c.lightVertexConstantIndex};ShadowCasterPass.prototype.iRender=function(renderable,stage3DProxy,camera,viewProjection){renderable.inverseSceneTransform.copyRawDataTo(this._inverseSceneMatrix);if(this._tangentSpace&&this._pCameraPositionIndex>=0){var pos=camera.scenePosition;var x=pos.x;var y=pos.y;var z=pos.z;this._pVertexConstantData[this._pCameraPositionIndex]=this._inverseSceneMatrix[0]*x+this._inverseSceneMatrix[4]*y+this._inverseSceneMatrix[8]*z+this._inverseSceneMatrix[12];this._pVertexConstantData[this._pCameraPositionIndex+1]=this._inverseSceneMatrix[1]*x+this._inverseSceneMatrix[5]*y+this._inverseSceneMatrix[9]*z+this._inverseSceneMatrix[13];this._pVertexConstantData[this._pCameraPositionIndex+2]=this._inverseSceneMatrix[2]*x+this._inverseSceneMatrix[6]*y+this._inverseSceneMatrix[10]*z+this._inverseSceneMatrix[14]}_super.prototype.iRender.call(this,renderable,stage3DProxy,camera,viewProjection)};ShadowCasterPass.prototype.iActivate=function(stage3DProxy,camera){_super.prototype.iActivate.call(this,stage3DProxy,camera);if(!this._tangentSpace&&this._pCameraPositionIndex>=0){var pos=camera.scenePosition;this._pVertexConstantData[this._pCameraPositionIndex]=pos.x;this._pVertexConstantData[this._pCameraPositionIndex+1]=pos.y;this._pVertexConstantData[this._pCameraPositionIndex+2]=pos.z}};ShadowCasterPass.prototype.pUpdateLightConstants=function(){var dirLight;var pointLight;var k=0;var l=0;var dirPos;l=this._lightVertexConstantIndex;k=this._pLightFragmentConstantIndex;if(this._pNumDirectionalLights>0){dirLight=this._pLightPicker.castingDirectionalLights[0];dirPos=dirLight.sceneDirection;this._pAmbientLightR+=dirLight._iAmbientR;this._pAmbientLightG+=dirLight._iAmbientG;this._pAmbientLightB+=dirLight._iAmbientB;if(this._tangentSpace){var x=-dirPos.x;var y=-dirPos.y;var z=-dirPos.z;this._pVertexConstantData[l++]=this._inverseSceneMatrix[0]*x+this._inverseSceneMatrix[4]*y+this._inverseSceneMatrix[8]*z;this._pVertexConstantData[l++]=this._inverseSceneMatrix[1]*x+this._inverseSceneMatrix[5]*y+this._inverseSceneMatrix[9]*z;this._pVertexConstantData[l++]=this._inverseSceneMatrix[2]*x+this._inverseSceneMatrix[6]*y+this._inverseSceneMatrix[10]*z;this._pVertexConstantData[l++]=1}else{this._pFragmentConstantData[k++]=-dirPos.x;this._pFragmentConstantData[k++]=-dirPos.y;this._pFragmentConstantData[k++]=-dirPos.z;this._pFragmentConstantData[k++]=1}this._pFragmentConstantData[k++]=dirLight._iDiffuseR;this._pFragmentConstantData[k++]=dirLight._iDiffuseG;this._pFragmentConstantData[k++]=dirLight._iDiffuseB;this._pFragmentConstantData[k++]=1;this._pFragmentConstantData[k++]=dirLight._iSpecularR;this._pFragmentConstantData[k++]=dirLight._iSpecularG;this._pFragmentConstantData[k++]=dirLight._iSpecularB;this._pFragmentConstantData[k++]=1;return}if(this._pNumPointLights>0){pointLight=this._pLightPicker.castingPointLights[0];dirPos=pointLight.scenePosition;this._pAmbientLightR+=pointLight._iAmbientR;this._pAmbientLightG+=pointLight._iAmbientG;this._pAmbientLightB+=pointLight._iAmbientB;if(this._tangentSpace){x=dirPos.x;y=dirPos.y;z=dirPos.z;this._pVertexConstantData[l++]=this._inverseSceneMatrix[0]*x+this._inverseSceneMatrix[4]*y+this._inverseSceneMatrix[8]*z+this._inverseSceneMatrix[12];this._pVertexConstantData[l++]=this._inverseSceneMatrix[1]*x+this._inverseSceneMatrix[5]*y+this._inverseSceneMatrix[9]*z+this._inverseSceneMatrix[13];this._pVertexConstantData[l++]=this._inverseSceneMatrix[2]*x+this._inverseSceneMatrix[6]*y+this._inverseSceneMatrix[10]*z+this._inverseSceneMatrix[14]}else{this._pVertexConstantData[l++]=dirPos.x;this._pVertexConstantData[l++]=dirPos.y;this._pVertexConstantData[l++]=dirPos.z}this._pVertexConstantData[l++]=1;this._pFragmentConstantData[k++]=pointLight._iDiffuseR;this._pFragmentConstantData[k++]=pointLight._iDiffuseG;this._pFragmentConstantData[k++]=pointLight._iDiffuseB;this._pFragmentConstantData[k++]=pointLight._pRadius*pointLight._pRadius;this._pFragmentConstantData[k++]=pointLight._iSpecularR;this._pFragmentConstantData[k++]=pointLight._iSpecularG;this._pFragmentConstantData[k++]=pointLight._iSpecularB;this._pFragmentConstantData[k++]=pointLight._pFallOffFactor}};ShadowCasterPass.prototype.pUsesProbes=function(){return false};ShadowCasterPass.prototype.pUsesLights=function(){return true};ShadowCasterPass.prototype.pUpdateProbes=function(stage3DProxy){};return ShadowCasterPass})(away.materials.CompiledPass);materials.ShadowCasterPass=ShadowCasterPass})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var SegmentPass=(function(_super){__extends(SegmentPass,_super);function SegmentPass(thickness){_super.call(this);this._constants=new Array(4);this._calcMatrix=new away.geom.Matrix3D();this._thickness=thickness;this._constants[1]=1/255}SegmentPass.prototype.iGetVertexCode=function(){return"m44 vt0, va0, vc8			\nm44 vt1, va1, vc8			\nsub vt2, vt1, vt0 			\nslt vt5.x, vt0.z, vc7.z			\nsub vt5.y, vc5.x, vt5.x			\nadd vt4.x, vt0.z, vc7.z			\nsub vt4.y, vt0.z, vt1.z			\nseq vt4.z, vt4.y vc6.x			\nadd vt4.y, vt4.y, vt4.z			\ndiv vt4.z, vt4.x, vt4.y			\nmul vt4.xyz, vt4.zzz, vt2.xyz	\nadd vt3.xyz, vt0.xyz, vt4.xyz	\nmov vt3.w, vc5.x			\nmul vt0, vt0, vt5.yyyy			\nmul vt3, vt3, vt5.xxxx			\nadd vt0, vt0, vt3				\nsub vt2, vt1, vt0 			\nnrm vt2.xyz, vt2.xyz			\nnrm vt5.xyz, vt0.xyz			\nmov vt5.w, vc5.x				\ncrs vt3.xyz, vt2, vt5			\nnrm vt3.xyz, vt3.xyz			\nmul vt3.xyz, vt3.xyz, va2.xxx	\nmov vt3.w, vc5.x			\ndp3 vt4.x, vt0, vc6			\nmul vt4.x, vt4.x, vc7.x			\nmul vt3.xyz, vt3.xyz, vt4.xxx	\nadd vt0.xyz, vt0.xyz, vt3.xyz	\nm44 op, vt0, vc0			\nmov v0, va3				\n"};SegmentPass.prototype.iGetFragmentCode=function(animationCode){return"mov oc, v0\n"};SegmentPass.prototype.iRender=function(renderable,stage3DProxy,camera,viewProjection){var context=stage3DProxy._iContext3D;this._calcMatrix.copyFrom(renderable.sourceEntity.sceneTransform);this._calcMatrix.append(camera.inverseSceneTransform);var ss=renderable;var subSetCount=ss.iSubSetCount;if(ss.hasData){for(var i=0;i<subSetCount;++i){renderable.activateVertexBuffer(i,stage3DProxy);context.setProgramConstantsFromMatrix(away.display3D.Context3DProgramType.VERTEX,8,this._calcMatrix,true);context.drawTriangles(renderable.getIndexBuffer(stage3DProxy),0,renderable.numTriangles)}}};SegmentPass.prototype.iActivate=function(stage3DProxy,camera){var context=stage3DProxy._iContext3D;_super.prototype.iActivate.call(this,stage3DProxy,camera);if(stage3DProxy.scissorRect){this._constants[0]=this._thickness/Math.min(stage3DProxy.scissorRect.width,stage3DProxy.scissorRect.height)}else{this._constants[0]=this._thickness/Math.min(stage3DProxy.width,stage3DProxy.height)}this._constants[2]=camera.lens.near;context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.VERTEX,5,SegmentPass.pONE_VECTOR);context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.VERTEX,6,SegmentPass.pFRONT_VECTOR);context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.VERTEX,7,this._constants);context.setProgramConstantsFromMatrix(away.display3D.Context3DProgramType.VERTEX,0,camera.lens.matrix,true)};SegmentPass.prototype.pDeactivate=function(stage3DProxy){var context=stage3DProxy._iContext3D;context.setVertexBufferAt(0,null);context.setVertexBufferAt(1,null);context.setVertexBufferAt(2,null);context.setVertexBufferAt(3,null)};SegmentPass.pONE_VECTOR=Array(1,1,1,1);SegmentPass.pFRONT_VECTOR=Array(0,0,-1,0);return SegmentPass})(materials.MaterialPassBase);materials.SegmentPass=SegmentPass})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var SkyBoxPass=(function(_super){__extends(SkyBoxPass,_super);function SkyBoxPass(){_super.call(this);this.mipmap=false;this._pNumUsedTextures=1;this._vertexData=new Array(0,0,0,0,1,1,1,1)}Object.defineProperty(SkyBoxPass.prototype,"cubeTexture",{get:function(){return this._cubeTexture},set:function(value){this._cubeTexture=value},enumerable:true,configurable:true});SkyBoxPass.prototype.iGetVertexCode=function(){return"mul vt0, va0, vc5		\nadd vt0, vt0, vc4		\nm44 op, vt0, vc0		\nmov v0, va0\n"};SkyBoxPass.prototype.iGetFragmentCode=function(animationCode){var format;switch(this._cubeTexture.format){case away.display3D.Context3DTextureFormat.COMPRESSED:format="dxt1,";break;case"compressedAlpha":format="dxt5,";break;default:format=""}var mip=",mipnone";if(this._cubeTexture.hasMipMaps){mip=",miplinear"}return"tex ft0, v0, fs0 <cube,"+format+"linear,clamp"+mip+">	\nmov oc, ft0							\n"};SkyBoxPass.prototype.iRender=function(renderable,stage3DProxy,camera,viewProjection){var context=stage3DProxy._iContext3D;var pos=camera.scenePosition;this._vertexData[0]=pos.x;this._vertexData[1]=pos.y;this._vertexData[2]=pos.z;this._vertexData[4]=this._vertexData[5]=this._vertexData[6]=camera.lens.far/Math.sqrt(3);context.setProgramConstantsFromMatrix(away.display3D.Context3DProgramType.VERTEX,0,viewProjection,true);context.setProgramConstantsFromArray(away.display3D.Context3DProgramType.VERTEX,4,this._vertexData,2);renderable.activateVertexBuffer(0,stage3DProxy);context.drawTriangles(renderable.getIndexBuffer(stage3DProxy),0,renderable.numTriangles)};SkyBoxPass.prototype.iActivate=function(stage3DProxy,camera){_super.prototype.iActivate.call(this,stage3DProxy,camera);var context=stage3DProxy._iContext3D;context.setDepthTest(false,away.display3D.Context3DCompareMode.LESS);context.setTextureAt(0,this._cubeTexture.getTextureForStage3D(stage3DProxy))};return SkyBoxPass})(away.materials.MaterialPassBase);materials.SkyBoxPass=SkyBoxPass})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var SinglePassMaterialBase=(function(_super){__extends(SinglePassMaterialBase,_super);function SinglePassMaterialBase(){_super.call(this);this.pAddPass(this._pScreenPass=new away.materials.SuperShaderPass(this))}Object.defineProperty(SinglePassMaterialBase.prototype,"enableLightFallOff",{get:function(){return this._pScreenPass.enableLightFallOff},set:function(value){this._pScreenPass.enableLightFallOff=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"alphaThreshold",{get:function(){return this._pScreenPass.diffuseMethod.alphaThreshold},set:function(value){this._pScreenPass.diffuseMethod.alphaThreshold=value;this._pDepthPass.alphaThreshold=value;this._pDistancePass.alphaThreshold=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"blendMode",{set:function(value){_super.prototype.setBlendMode.call(this,value);this._pScreenPass.setBlendMode((this._pBlendMode==away.display.BlendMode.NORMAL)&&this.requiresBlending?away.display.BlendMode.LAYER:this._pBlendMode)},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"depthCompareMode",{set:function(value){this._pDepthCompareMode=value;this._pScreenPass.depthCompareMode=value},enumerable:true,configurable:true});SinglePassMaterialBase.prototype.iActivateForDepth=function(stage3DProxy,camera,distanceBased){if(typeof distanceBased==="undefined"){distanceBased=false}if(distanceBased){this._pDistancePass.alphaMask=this._pScreenPass.diffuseMethod.texture}else{this._pDepthPass.alphaMask=this._pScreenPass.diffuseMethod.texture}_super.prototype.iActivateForDepth.call(this,stage3DProxy,camera,distanceBased)};Object.defineProperty(SinglePassMaterialBase.prototype,"specularLightSources",{get:function(){return this._pScreenPass.specularLightSources},set:function(value){this._pScreenPass.specularLightSources=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"diffuseLightSources",{get:function(){return this._pScreenPass.diffuseLightSources},set:function(value){this._pScreenPass.diffuseLightSources=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"requiresBlending",{get:function(){return this.getRequiresBlending()},enumerable:true,configurable:true});SinglePassMaterialBase.prototype.getRequiresBlending=function(){return _super.prototype.getRequiresBlending.call(this)||this._alphaBlending||(this._pScreenPass.colorTransform&&this._pScreenPass.colorTransform.alphaMultiplier<1)};Object.defineProperty(SinglePassMaterialBase.prototype,"colorTransform",{get:function(){return this._pScreenPass.colorTransform},set:function(value){this.setColorTransform(value)},enumerable:true,configurable:true});SinglePassMaterialBase.prototype.setColorTransform=function(value){this._pScreenPass.colorTransform=value};Object.defineProperty(SinglePassMaterialBase.prototype,"ambientMethod",{get:function(){return this._pScreenPass.ambientMethod},set:function(value){this._pScreenPass.ambientMethod=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"shadowMethod",{get:function(){return this._pScreenPass.shadowMethod},set:function(value){this._pScreenPass.shadowMethod=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"diffuseMethod",{get:function(){return this._pScreenPass.diffuseMethod},set:function(value){this._pScreenPass.diffuseMethod=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"normalMethod",{get:function(){return this._pScreenPass.normalMethod},set:function(value){this._pScreenPass.normalMethod=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"specularMethod",{get:function(){return this._pScreenPass.specularMethod},set:function(value){this._pScreenPass.specularMethod=value},enumerable:true,configurable:true});SinglePassMaterialBase.prototype.addMethod=function(method){this._pScreenPass.addMethod(method)};Object.defineProperty(SinglePassMaterialBase.prototype,"numMethods",{get:function(){return this._pScreenPass.numMethods},enumerable:true,configurable:true});SinglePassMaterialBase.prototype.hasMethod=function(method){return this._pScreenPass.hasMethod(method)};SinglePassMaterialBase.prototype.getMethodAt=function(index){return this._pScreenPass.getMethodAt(index)};SinglePassMaterialBase.prototype.addMethodAt=function(method,index){this._pScreenPass.addMethodAt(method,index)};SinglePassMaterialBase.prototype.removeMethod=function(method){this._pScreenPass.removeMethod(method)};Object.defineProperty(SinglePassMaterialBase.prototype,"mipmap",{set:function(value){if(this._pMipmap==value){return}this.setMipMap(value)},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"normalMap",{get:function(){return this._pScreenPass.normalMap},set:function(value){this._pScreenPass.normalMap=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"specularMap",{get:function(){return this._pScreenPass.specularMethod.texture},set:function(value){if(this._pScreenPass.specularMethod){this._pScreenPass.specularMethod.texture=value}else{throw new away.errors.Error("No specular method was set to assign the specularGlossMap to")}},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"gloss",{get:function(){return this._pScreenPass.specularMethod?this._pScreenPass.specularMethod.gloss:0},set:function(value){if(this._pScreenPass.specularMethod){this._pScreenPass.specularMethod.gloss=value}},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"ambient",{get:function(){return this._pScreenPass.ambientMethod.ambient},set:function(value){this._pScreenPass.ambientMethod.ambient=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"specular",{get:function(){return this._pScreenPass.specularMethod?this._pScreenPass.specularMethod.specular:0},set:function(value){if(this._pScreenPass.specularMethod){this._pScreenPass.specularMethod.specular=value}},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"ambientColor",{get:function(){return this._pScreenPass.ambientMethod.ambientColor},set:function(value){this._pScreenPass.ambientMethod.ambientColor=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"specularColor",{get:function(){return this._pScreenPass.specularMethod.specularColor},set:function(value){this._pScreenPass.specularMethod.specularColor=value},enumerable:true,configurable:true});Object.defineProperty(SinglePassMaterialBase.prototype,"alphaBlending",{get:function(){return this._alphaBlending},set:function(value){this._alphaBlending=value;this._pScreenPass.setBlendMode(this.getBlendMode()==away.display.BlendMode.NORMAL&&this.requiresBlending?away.display.BlendMode.LAYER:this.getBlendMode());this._pScreenPass.preserveAlpha=this.requiresBlending},enumerable:true,configurable:true});SinglePassMaterialBase.prototype.iUpdateMaterial=function(context){if(this._pScreenPass._iPassesDirty){this.pClearPasses();if(this._pScreenPass._iPasses){var len=this._pScreenPass._iPasses.length;for(var i=0;i<len;++i){this.pAddPass(this._pScreenPass._iPasses[i])}}this.pAddPass(this._pScreenPass);this._pScreenPass._iPassesDirty=false}};Object.defineProperty(SinglePassMaterialBase.prototype,"lightPicker",{set:function(value){_super.prototype.setLightPicker.call(this,value);this._pScreenPass.lightPicker=value},enumerable:true,configurable:true});return SinglePassMaterialBase})(away.materials.MaterialBase);materials.SinglePassMaterialBase=SinglePassMaterialBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var MultiPassMaterialBase=(function(_super){__extends(MultiPassMaterialBase,_super);function MultiPassMaterialBase(){_super.call(this);this._alphaThreshold=0;this._specularLightSources=1;this._diffuseLightSources=3;this._ambientMethod=new away.materials.BasicAmbientMethod();this._diffuseMethod=new away.materials.BasicDiffuseMethod();this._normalMethod=new away.materials.BasicNormalMethod();this._specularMethod=new away.materials.BasicSpecularMethod();this._screenPassesInvalid=true;this._enableLightFallOff=true}Object.defineProperty(MultiPassMaterialBase.prototype,"enableLightFallOff",{get:function(){return this._enableLightFallOff},set:function(value){if(this._enableLightFallOff!=value){this.pInvalidateScreenPasses()}this._enableLightFallOff=value},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"alphaThreshold",{get:function(){return this._alphaThreshold},set:function(value){this._alphaThreshold=value;this._diffuseMethod.alphaThreshold=value;this._pDepthPass.alphaThreshold=value;this._pDistancePass.alphaThreshold=value},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"depthCompareMode",{set:function(value){_super.prototype.setDepthCompareMode.call(this,value);this.pInvalidateScreenPasses()},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"blendMode",{set:function(value){_super.prototype.setBlendMode.call(this,value);this.pInvalidateScreenPasses()},enumerable:true,configurable:true});MultiPassMaterialBase.prototype.iActivateForDepth=function(stage3DProxy,camera,distanceBased){if(typeof distanceBased==="undefined"){distanceBased=false}if(distanceBased){this._pDistancePass.alphaMask=this._diffuseMethod.texture}else{this._pDepthPass.alphaMask=this._diffuseMethod.texture}_super.prototype.iActivateForDepth.call(this,stage3DProxy,camera,distanceBased)};Object.defineProperty(MultiPassMaterialBase.prototype,"specularLightSources",{get:function(){return this._specularLightSources},set:function(value){this._specularLightSources=value},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"diffuseLightSources",{get:function(){return this._diffuseLightSources},set:function(value){this._diffuseLightSources=value},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"lightPicker",{set:function(value){if(this._pLightPicker){this._pLightPicker.removeEventListener(away.events.Event.CHANGE,this.onLightsChange,this)}_super.prototype.setLightPicker.call(this,value);if(this._pLightPicker){this._pLightPicker.addEventListener(away.events.Event.CHANGE,this.onLightsChange,this)}this.pInvalidateScreenPasses()},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"requiresBlending",{get:function(){return false},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"ambientMethod",{get:function(){return this._ambientMethod},set:function(value){value.copyFrom(this._ambientMethod);this._ambientMethod=value;this.pInvalidateScreenPasses()},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"shadowMethod",{get:function(){return this._shadowMethod},set:function(value){if(value&&this._shadowMethod){value.copyFrom(this._shadowMethod)}this._shadowMethod=value;this.pInvalidateScreenPasses()},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"diffuseMethod",{get:function(){return this._diffuseMethod},set:function(value){value.copyFrom(this._diffuseMethod);this._diffuseMethod=value;this.pInvalidateScreenPasses()},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"specularMethod",{get:function(){return this._specularMethod},set:function(value){if(value&&this._specularMethod){value.copyFrom(this._specularMethod)}this._specularMethod=value;this.pInvalidateScreenPasses()},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"normalMethod",{get:function(){return this._normalMethod},set:function(value){value.copyFrom(this._normalMethod);this._normalMethod=value;this.pInvalidateScreenPasses()},enumerable:true,configurable:true});MultiPassMaterialBase.prototype.addMethod=function(method){if(this._pEffectsPass==null){this._pEffectsPass=new away.materials.SuperShaderPass(this)}this._pEffectsPass.addMethod(method);this.pInvalidateScreenPasses()};Object.defineProperty(MultiPassMaterialBase.prototype,"numMethods",{get:function(){return this._pEffectsPass?this._pEffectsPass.numMethods:0},enumerable:true,configurable:true});MultiPassMaterialBase.prototype.hasMethod=function(method){return this._pEffectsPass?this._pEffectsPass.hasMethod(method):false};MultiPassMaterialBase.prototype.getMethodAt=function(index){return this._pEffectsPass.getMethodAt(index)};MultiPassMaterialBase.prototype.addMethodAt=function(method,index){if(this._pEffectsPass==null){this._pEffectsPass=new away.materials.SuperShaderPass(this)}this._pEffectsPass.addMethodAt(method,index);this.pInvalidateScreenPasses()};MultiPassMaterialBase.prototype.removeMethod=function(method){if(this._pEffectsPass){return}this._pEffectsPass.removeMethod(method);if(this._pEffectsPass.numMethods==0){this.pInvalidateScreenPasses()}};Object.defineProperty(MultiPassMaterialBase.prototype,"mipmap",{set:function(value){if(this._pMipmap==value){return}_super.prototype.setMipMap.call(this,value)},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"normalMap",{get:function(){return this._normalMethod.normalMap},set:function(value){this._normalMethod.normalMap=value},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"specularMap",{get:function(){return this._specularMethod.texture},set:function(value){if(this._specularMethod){this._specularMethod.texture=value}else{throw new Error("No specular method was set to assign the specularGlossMap to")}},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"gloss",{get:function(){return this._specularMethod?this._specularMethod.gloss:0},set:function(value){if(this._specularMethod){this._specularMethod.gloss=value}},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"ambient",{get:function(){return this._ambientMethod.ambient},set:function(value){this._ambientMethod.ambient=value},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"specular",{get:function(){return this._specularMethod?this._specularMethod.specular:0},set:function(value){if(this._specularMethod){this._specularMethod.specular=value}},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"ambientColor",{get:function(){return this._ambientMethod.ambientColor},set:function(value){this._ambientMethod.ambientColor=value},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"specularColor",{get:function(){return this._specularMethod.specularColor},set:function(value){this._specularMethod.specularColor=value},enumerable:true,configurable:true});MultiPassMaterialBase.prototype.iUpdateMaterial=function(context){var passesInvalid;if(this._screenPassesInvalid){this.pUpdateScreenPasses();passesInvalid=true}if(passesInvalid||this.isAnyScreenPassInvalid()){this.pClearPasses();this.addChildPassesFor(this._casterLightPass);if(this._nonCasterLightPasses){for(var i=0;i<this._nonCasterLightPasses.length;++i){this.addChildPassesFor(this._nonCasterLightPasses[i])}}this.addChildPassesFor(this._pEffectsPass);this.addScreenPass(this._casterLightPass);if(this._nonCasterLightPasses){for(i=0;i<this._nonCasterLightPasses.length;++i){this.addScreenPass(this._nonCasterLightPasses[i])}}this.addScreenPass(this._pEffectsPass)}};MultiPassMaterialBase.prototype.addScreenPass=function(pass){if(pass){this.pAddPass(pass);pass._iPassesDirty=false}};MultiPassMaterialBase.prototype.isAnyScreenPassInvalid=function(){if((this._casterLightPass&&this._casterLightPass._iPassesDirty)||(this._pEffectsPass&&this._pEffectsPass._iPassesDirty)){return true}if(this._nonCasterLightPasses){for(var i=0;i<this._nonCasterLightPasses.length;++i){if(this._nonCasterLightPasses[i]._iPassesDirty){return true}}}return false};MultiPassMaterialBase.prototype.addChildPassesFor=function(pass){if(!pass){return}if(pass._iPasses){var len=pass._iPasses.length;for(var i=0;i<len;++i){this.pAddPass(pass._iPasses[i])}}};MultiPassMaterialBase.prototype.iActivatePass=function(index,stage3DProxy,camera){if(index==0){stage3DProxy._iContext3D.setBlendFactors(away.display3D.Context3DBlendFactor.ONE,away.display3D.Context3DBlendFactor.ZERO)}_super.prototype.iActivatePass.call(this,index,stage3DProxy,camera)};MultiPassMaterialBase.prototype.iDeactivate=function(stage3DProxy){_super.prototype.iDeactivate.call(this,stage3DProxy);stage3DProxy._iContext3D.setBlendFactors(away.display3D.Context3DBlendFactor.ONE,away.display3D.Context3DBlendFactor.ZERO)};MultiPassMaterialBase.prototype.pUpdateScreenPasses=function(){this.initPasses();this.setBlendAndCompareModes();this._screenPassesInvalid=false};MultiPassMaterialBase.prototype.initPasses=function(){if(this.numLights==0||this.numMethods>0){this.initEffectsPass()}else{if(this._pEffectsPass&&this.numMethods==0){this.removeEffectsPass()}}if(this._shadowMethod){this.initCasterLightPass()}else{this.removeCasterLightPass()}if(this.numNonCasters>0){this.initNonCasterLightPasses()}else{this.removeNonCasterLightPasses()}};MultiPassMaterialBase.prototype.setBlendAndCompareModes=function(){var forceSeparateMVP=(this._casterLightPass||this._pEffectsPass);if(this._casterLightPass){this._casterLightPass.setBlendMode(away.display.BlendMode.NORMAL);this._casterLightPass.depthCompareMode=this._pDepthCompareMode;this._casterLightPass.forceSeparateMVP=forceSeparateMVP}if(this._nonCasterLightPasses){var firstAdditiveIndex=0;if(!this._casterLightPass){this._nonCasterLightPasses[0].forceSeparateMVP=forceSeparateMVP;this._nonCasterLightPasses[0].setBlendMode(away.display.BlendMode.NORMAL);this._nonCasterLightPasses[0].depthCompareMode=this._pDepthCompareMode;firstAdditiveIndex=1}for(var i=firstAdditiveIndex;i<this._nonCasterLightPasses.length;++i){this._nonCasterLightPasses[i].forceSeparateMVP=forceSeparateMVP;this._nonCasterLightPasses[i].setBlendMode(away.display.BlendMode.ADD);this._nonCasterLightPasses[i].depthCompareMode=away.display3D.Context3DCompareMode.LESS_EQUAL}}if(this._casterLightPass||this._nonCasterLightPasses){if(this._pEffectsPass){this._pEffectsPass.iIgnoreLights=true;this._pEffectsPass.depthCompareMode=away.display3D.Context3DCompareMode.LESS_EQUAL;this._pEffectsPass.setBlendMode(away.display.BlendMode.LAYER);this._pEffectsPass.forceSeparateMVP=forceSeparateMVP}}else{if(this._pEffectsPass){this._pEffectsPass.iIgnoreLights=false;this._pEffectsPass.depthCompareMode=this._pDepthCompareMode;this.depthCompareMode;this._pEffectsPass.setBlendMode(away.display.BlendMode.NORMAL);this._pEffectsPass.forceSeparateMVP=false}}};MultiPassMaterialBase.prototype.initCasterLightPass=function(){if(this._casterLightPass==null){this._casterLightPass=new away.materials.ShadowCasterPass(this)}this._casterLightPass.diffuseMethod=null;this._casterLightPass.ambientMethod=null;this._casterLightPass.normalMethod=null;this._casterLightPass.specularMethod=null;this._casterLightPass.shadowMethod=null;this._casterLightPass.enableLightFallOff=this._enableLightFallOff;this._casterLightPass.lightPicker=new away.materials.StaticLightPicker([this._shadowMethod.castingLight]);this._casterLightPass.shadowMethod=this._shadowMethod;this._casterLightPass.diffuseMethod=this._diffuseMethod;this._casterLightPass.ambientMethod=this._ambientMethod;this._casterLightPass.normalMethod=this._normalMethod;this._casterLightPass.specularMethod=this._specularMethod;this._casterLightPass.diffuseLightSources=this._diffuseLightSources;this._casterLightPass.specularLightSources=this._specularLightSources};MultiPassMaterialBase.prototype.removeCasterLightPass=function(){if(!this._casterLightPass){return}this._casterLightPass.dispose();this.pRemovePass(this._casterLightPass);this._casterLightPass=null};MultiPassMaterialBase.prototype.initNonCasterLightPasses=function(){this.removeNonCasterLightPasses();var pass;var numDirLights=this._pLightPicker.numDirectionalLights;var numPointLights=this._pLightPicker.numPointLights;var numLightProbes=this._pLightPicker.numLightProbes;var dirLightOffset=0;var pointLightOffset=0;var probeOffset=0;if(!this._casterLightPass){numDirLights+=this._pLightPicker.numCastingDirectionalLights;numPointLights+=this._pLightPicker.numCastingPointLights}this._nonCasterLightPasses=new Array();while(dirLightOffset<numDirLights||pointLightOffset<numPointLights||probeOffset<numLightProbes){pass=new materials.LightingPass(this);pass.enableLightFallOff=this._enableLightFallOff;pass.includeCasters=this._shadowMethod==null;pass.directionalLightsOffset=dirLightOffset;pass.pointLightsOffset=pointLightOffset;pass.lightProbesOffset=probeOffset;pass.diffuseMethod=null;pass.ambientMethod=null;pass.normalMethod=null;pass.specularMethod=null;pass.lightPicker=this._pLightPicker;pass.diffuseMethod=this._diffuseMethod;pass.ambientMethod=this._ambientMethod;pass.normalMethod=this._normalMethod;pass.specularMethod=this._specularMethod;pass.diffuseLightSources=this._diffuseLightSources;pass.specularLightSources=this._specularLightSources;this._nonCasterLightPasses.push(pass);dirLightOffset+=pass.iNumDirectionalLights;pointLightOffset+=pass.iNumPointLights;probeOffset+=pass.iNumLightProbes}};MultiPassMaterialBase.prototype.removeNonCasterLightPasses=function(){if(!this._nonCasterLightPasses){return}for(var i=0;i<this._nonCasterLightPasses.length;++i){this.pRemovePass(this._nonCasterLightPasses[i]);this._nonCasterLightPasses[i].dispose()}this._nonCasterLightPasses=null};MultiPassMaterialBase.prototype.removeEffectsPass=function(){if(this._pEffectsPass.diffuseMethod!=this._diffuseMethod){this._pEffectsPass.diffuseMethod.dispose()}this.pRemovePass(this._pEffectsPass);this._pEffectsPass.dispose();this._pEffectsPass=null};MultiPassMaterialBase.prototype.initEffectsPass=function(){if(this._pEffectsPass==null){this._pEffectsPass=new away.materials.SuperShaderPass(this)}this._pEffectsPass.enableLightFallOff=this._enableLightFallOff;if(this.numLights==0){this._pEffectsPass.diffuseMethod=null;this._pEffectsPass.diffuseMethod=this._diffuseMethod}else{this._pEffectsPass.diffuseMethod=null;this._pEffectsPass.diffuseMethod=new away.materials.BasicDiffuseMethod();this._pEffectsPass.diffuseMethod.diffuseColor=0;this._pEffectsPass.diffuseMethod.diffuseAlpha=0}this._pEffectsPass.preserveAlpha=false;this._pEffectsPass.normalMethod=null;this._pEffectsPass.normalMethod=this._normalMethod;return this._pEffectsPass};Object.defineProperty(MultiPassMaterialBase.prototype,"numLights",{get:function(){return this._pLightPicker?this._pLightPicker.numLightProbes+this._pLightPicker.numDirectionalLights+this._pLightPicker.numPointLights+this._pLightPicker.numCastingDirectionalLights+this._pLightPicker.numCastingPointLights:0},enumerable:true,configurable:true});Object.defineProperty(MultiPassMaterialBase.prototype,"numNonCasters",{get:function(){return this._pLightPicker?this._pLightPicker.numLightProbes+this._pLightPicker.numDirectionalLights+this._pLightPicker.numPointLights:0},enumerable:true,configurable:true});MultiPassMaterialBase.prototype.pInvalidateScreenPasses=function(){this._screenPassesInvalid=true};MultiPassMaterialBase.prototype.onLightsChange=function(event){this.pInvalidateScreenPasses()};return MultiPassMaterialBase})(away.materials.MaterialBase);materials.MultiPassMaterialBase=MultiPassMaterialBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var TextureMultiPassMaterial=(function(_super){__extends(TextureMultiPassMaterial,_super);function TextureMultiPassMaterial(texture,smooth,repeat,mipmap){if(typeof texture==="undefined"){texture=null}if(typeof smooth==="undefined"){smooth=true}if(typeof repeat==="undefined"){repeat=false}if(typeof mipmap==="undefined"){mipmap=true}_super.call(this);this._animateUVs=false;this.texture=texture;this.smooth=smooth;this.repeat=repeat;this.mipmap=mipmap}Object.defineProperty(TextureMultiPassMaterial.prototype,"animateUVs",{get:function(){return this._animateUVs},set:function(value){this._animateUVs=value},enumerable:true,configurable:true});Object.defineProperty(TextureMultiPassMaterial.prototype,"texture",{get:function(){return this.diffuseMethod.texture},set:function(value){this.diffuseMethod.texture=value},enumerable:true,configurable:true});Object.defineProperty(TextureMultiPassMaterial.prototype,"ambientTexture",{get:function(){return this.ambientMethod.texture},set:function(value){this.ambientMethod.texture=value;this.diffuseMethod.iUseAmbientTexture=(value!=null)},enumerable:true,configurable:true});TextureMultiPassMaterial.prototype.pUpdateScreenPasses=function(){_super.prototype.pUpdateScreenPasses.call(this);if(this._pEffectsPass){this._pEffectsPass.animateUVs=this._animateUVs}};return TextureMultiPassMaterial})(away.materials.MultiPassMaterialBase);materials.TextureMultiPassMaterial=TextureMultiPassMaterial})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ColorMultiPassMaterial=(function(_super){__extends(ColorMultiPassMaterial,_super);function ColorMultiPassMaterial(color){if(typeof color==="undefined"){color=13421772}_super.call(this);this.color=color}Object.defineProperty(ColorMultiPassMaterial.prototype,"color",{get:function(){return this.diffuseMethod.diffuseColor},set:function(value){this.diffuseMethod.diffuseColor=value},enumerable:true,configurable:true});return ColorMultiPassMaterial})(away.materials.MultiPassMaterialBase);materials.ColorMultiPassMaterial=ColorMultiPassMaterial})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var MethodVO=(function(){function MethodVO(){this.useLightFallOff=true}MethodVO.prototype.reset=function(){this.texturesIndex=-1;this.vertexConstantsIndex=-1;this.fragmentConstantsIndex=-1;this.useMipmapping=true;this.useSmoothTextures=true;this.repeatTextures=false;this.needsProjection=false;this.needsView=false;this.needsNormals=false;this.needsTangents=false;this.needsUV=false;this.needsSecondaryUV=false;this.needsGlobalVertexPos=false;this.needsGlobalFragmentPos=false;this.numLights=0;this.useLightFallOff=true};return MethodVO})();materials.MethodVO=MethodVO})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ShadingMethodBase=(function(_super){__extends(ShadingMethodBase,_super);function ShadingMethodBase(){_super.call(this)}ShadingMethodBase.prototype.iInitVO=function(vo){};ShadingMethodBase.prototype.iInitConstants=function(vo){};Object.defineProperty(ShadingMethodBase.prototype,"iSharedRegisters",{get:function(){return this._sharedRegisters},set:function(value){this._sharedRegisters=value},enumerable:true,configurable:true});Object.defineProperty(ShadingMethodBase.prototype,"passes",{get:function(){return this._passes},enumerable:true,configurable:true});ShadingMethodBase.prototype.dispose=function(){};ShadingMethodBase.prototype.iCreateMethodVO=function(){return new away.materials.MethodVO()};ShadingMethodBase.prototype.iReset=function(){this.iCleanCompilationData()};ShadingMethodBase.prototype.iCleanCompilationData=function(){};ShadingMethodBase.prototype.iGetVertexCode=function(vo,regCache){return""};ShadingMethodBase.prototype.iActivate=function(vo,stage3DProxy){};ShadingMethodBase.prototype.iSetRenderState=function(vo,renderable,stage3DProxy,camera){};ShadingMethodBase.prototype.iDeactivate=function(vo,stage3DProxy){};ShadingMethodBase.prototype.pGetTex2DSampleCode=function(vo,targetReg,inputReg,texture,uvReg,forceWrap){if(typeof uvReg==="undefined"){uvReg=null}if(typeof forceWrap==="undefined"){forceWrap=null}var wrap=forceWrap||(vo.repeatTextures?"wrap":"clamp");var filter;var format=this.getFormatStringForTexture(texture);var enableMipMaps=vo.useMipmapping&&texture.hasMipMaps;if(vo.useSmoothTextures){filter=enableMipMaps?"linear,miplinear":"linear"}else{filter=enableMipMaps?"nearest,mipnearest":"nearest"}if(uvReg==null){uvReg=this._sharedRegisters.uvVarying}return"tex "+targetReg.toString()+", "+uvReg.toString()+", "+inputReg.toString()+" <2d,"+filter+","+format+wrap+">\n"};ShadingMethodBase.prototype.pGetTexCubeSampleCode=function(vo,targetReg,inputReg,texture,uvReg){var filter;var format=this.getFormatStringForTexture(texture);var enableMipMaps=vo.useMipmapping&&texture.hasMipMaps;if(vo.useSmoothTextures){filter=enableMipMaps?"linear,miplinear":"linear"}else{filter=enableMipMaps?"nearest,mipnearest":"nearest"}return"tex "+targetReg.toString()+", "+uvReg.toString()+", "+inputReg.toString()+" <cube,"+format+filter+">\n"};ShadingMethodBase.prototype.getFormatStringForTexture=function(texture){switch(texture.format){case away.display3D.Context3DTextureFormat.COMPRESSED:return"dxt1,";break;case"compressedAlpha":return"dxt5,";break;default:return""}};ShadingMethodBase.prototype.iInvalidateShaderProgram=function(){this.dispatchEvent(new away.events.ShadingMethodEvent(away.events.ShadingMethodEvent.SHADER_INVALIDATED))};ShadingMethodBase.prototype.copyFrom=function(method){};return ShadingMethodBase})(away.library.NamedAssetBase);materials.ShadingMethodBase=ShadingMethodBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var EffectMethodBase=(function(_super){__extends(EffectMethodBase,_super);function EffectMethodBase(){_super.call(this)}Object.defineProperty(EffectMethodBase.prototype,"assetType",{get:function(){return away.library.AssetType.EFFECTS_METHOD},enumerable:true,configurable:true});EffectMethodBase.prototype.iGetFragmentCode=function(vo,regCache,targetReg){throw new away.errors.AbstractMethodError();return""};return EffectMethodBase})(away.materials.ShadingMethodBase);materials.EffectMethodBase=EffectMethodBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var MethodVOSet=(function(){function MethodVOSet(method){this.method=method;this.data=method.iCreateMethodVO()}return MethodVOSet})();materials.MethodVOSet=MethodVOSet})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ShaderMethodSetup=(function(_super){__extends(ShaderMethodSetup,_super);function ShaderMethodSetup(){_super.call(this);this._iMethods=new Array();this._iNormalMethod=new away.materials.BasicNormalMethod();this._iAmbientMethod=new away.materials.BasicAmbientMethod();this._iDiffuseMethod=new away.materials.BasicDiffuseMethod();this._iSpecularMethod=new away.materials.BasicSpecularMethod();this._iNormalMethod.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iDiffuseMethod.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iSpecularMethod.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iAmbientMethod.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iNormalMethodVO=this._iNormalMethod.iCreateMethodVO();this._iAmbientMethodVO=this._iAmbientMethod.iCreateMethodVO();this._iDiffuseMethodVO=this._iDiffuseMethod.iCreateMethodVO();this._iSpecularMethodVO=this._iSpecularMethod.iCreateMethodVO()}ShaderMethodSetup.prototype.onShaderInvalidated=function(event){this.invalidateShaderProgram()};ShaderMethodSetup.prototype.invalidateShaderProgram=function(){this.dispatchEvent(new away.events.ShadingMethodEvent(away.events.ShadingMethodEvent.SHADER_INVALIDATED))};Object.defineProperty(ShaderMethodSetup.prototype,"normalMethod",{get:function(){return this._iNormalMethod},set:function(value){if(this._iNormalMethod){this._iNormalMethod.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this)}if(value){if(this._iNormalMethod){value.copyFrom(this._iNormalMethod)}this._iNormalMethodVO=value.iCreateMethodVO();value.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this)}this._iNormalMethod=value;if(value){this.invalidateShaderProgram()}},enumerable:true,configurable:true});Object.defineProperty(ShaderMethodSetup.prototype,"ambientMethod",{get:function(){return this._iAmbientMethod},set:function(value){if(this._iAmbientMethod){this._iAmbientMethod.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this)}if(value){if(this._iAmbientMethod){value.copyFrom(this._iAmbientMethod)}value.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iAmbientMethodVO=value.iCreateMethodVO()}this._iAmbientMethod=value;if(value){this.invalidateShaderProgram()}},enumerable:true,configurable:true});Object.defineProperty(ShaderMethodSetup.prototype,"shadowMethod",{get:function(){return this._iShadowMethod},set:function(value){if(this._iShadowMethod){this._iShadowMethod.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this)}this._iShadowMethod=value;if(this._iShadowMethod){this._iShadowMethod.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iShadowMethodVO=this._iShadowMethod.iCreateMethodVO()}else{this._iShadowMethodVO=null}this.invalidateShaderProgram()},enumerable:true,configurable:true});Object.defineProperty(ShaderMethodSetup.prototype,"diffuseMethod",{get:function(){return this._iDiffuseMethod},set:function(value){if(this._iDiffuseMethod){this._iDiffuseMethod.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this)}if(value){if(this._iDiffuseMethod){value.copyFrom(this._iDiffuseMethod)}value.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iDiffuseMethodVO=value.iCreateMethodVO()}this._iDiffuseMethod=value;if(value){this.invalidateShaderProgram()}},enumerable:true,configurable:true});Object.defineProperty(ShaderMethodSetup.prototype,"specularMethod",{get:function(){return this._iSpecularMethod},set:function(value){if(this._iSpecularMethod){this._iSpecularMethod.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);if(value){value.copyFrom(this._iSpecularMethod)}}this._iSpecularMethod=value;if(this._iSpecularMethod){this._iSpecularMethod.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iSpecularMethodVO=this._iSpecularMethod.iCreateMethodVO()}else{this._iSpecularMethodVO=null}this.invalidateShaderProgram()},enumerable:true,configurable:true});Object.defineProperty(ShaderMethodSetup.prototype,"iColorTransformMethod",{get:function(){return this._iColorTransformMethod},set:function(value){if(this._iColorTransformMethod==value){return}if(this._iColorTransformMethod){this._iColorTransformMethod.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this)}if(!this._iColorTransformMethod||!value){this.invalidateShaderProgram()}this._iColorTransformMethod=value;if(this._iColorTransformMethod){this._iColorTransformMethod.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this._iColorTransformMethodVO=this._iColorTransformMethod.iCreateMethodVO()}else{this._iColorTransformMethodVO=null}},enumerable:true,configurable:true});ShaderMethodSetup.prototype.dispose=function(){this.clearListeners(this._iNormalMethod);this.clearListeners(this._iDiffuseMethod);this.clearListeners(this._iShadowMethod);this.clearListeners(this._iAmbientMethod);this.clearListeners(this._iSpecularMethod);for(var i=0;i<this._iMethods.length;++i){this.clearListeners(this._iMethods[i].method)}this._iMethods=null};ShaderMethodSetup.prototype.clearListeners=function(method){if(method){method.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this)}};ShaderMethodSetup.prototype.addMethod=function(method){this._iMethods.push(new away.materials.MethodVOSet(method));method.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this.invalidateShaderProgram()};ShaderMethodSetup.prototype.hasMethod=function(method){return this.getMethodSetForMethod(method)!=null};ShaderMethodSetup.prototype.addMethodAt=function(method,index){this._iMethods.splice(index,0,new away.materials.MethodVOSet(method));method.addEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this.invalidateShaderProgram()};ShaderMethodSetup.prototype.getMethodAt=function(index){if(index>this._iMethods.length-1){return null}return this._iMethods[index].method};Object.defineProperty(ShaderMethodSetup.prototype,"numMethods",{get:function(){return this._iMethods.length},enumerable:true,configurable:true});ShaderMethodSetup.prototype.removeMethod=function(method){var methodSet=this.getMethodSetForMethod(method);if(methodSet!=null){var index=this._iMethods.indexOf(methodSet);this._iMethods.splice(index,1);method.removeEventListener(away.events.ShadingMethodEvent.SHADER_INVALIDATED,this.onShaderInvalidated,this);this.invalidateShaderProgram()}};ShaderMethodSetup.prototype.getMethodSetForMethod=function(method){var len=this._iMethods.length;for(var i=0;i<len;++i){if(this._iMethods[i].method==method){return this._iMethods[i]}}return null};return ShaderMethodSetup})(away.events.EventDispatcher);materials.ShaderMethodSetup=ShaderMethodSetup})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var LightingMethodBase=(function(_super){__extends(LightingMethodBase,_super);function LightingMethodBase(){_super.call(this)}LightingMethodBase.prototype.iGetFragmentPreLightingCode=function(vo,regCache){return""};LightingMethodBase.prototype.iGetFragmentCodePerLight=function(vo,lightDirReg,lightColReg,regCache){return""};LightingMethodBase.prototype.iGetFragmentCodePerProbe=function(vo,cubeMapReg,weightRegister,regCache){return""};LightingMethodBase.prototype.iGetFragmentPostLightingCode=function(vo,regCache,targetReg){return""};return LightingMethodBase})(away.materials.ShadingMethodBase);materials.LightingMethodBase=LightingMethodBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ShadowMapMethodBase=(function(_super){__extends(ShadowMapMethodBase,_super);function ShadowMapMethodBase(castingLight){_super.call(this);this._epsilon=0.02;this._alpha=1;this._castingLight=castingLight;castingLight.castsShadows=true;this._shadowMapper=castingLight.shadowMapper}Object.defineProperty(ShadowMapMethodBase.prototype,"assetType",{get:function(){return away.library.AssetType.SHADOW_MAP_METHOD},enumerable:true,configurable:true});Object.defineProperty(ShadowMapMethodBase.prototype,"alpha",{get:function(){return this._alpha},set:function(value){this._alpha=value},enumerable:true,configurable:true});Object.defineProperty(ShadowMapMethodBase.prototype,"castingLight",{get:function(){return this._castingLight},enumerable:true,configurable:true});Object.defineProperty(ShadowMapMethodBase.prototype,"epsilon",{get:function(){return this._epsilon},set:function(value){this._epsilon=value},enumerable:true,configurable:true});ShadowMapMethodBase.prototype.iGetFragmentCode=function(vo,regCache,targetReg){throw new away.errors.AbstractMethodError();return null};return ShadowMapMethodBase})(away.materials.ShadingMethodBase);materials.ShadowMapMethodBase=ShadowMapMethodBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var TextureMaterial=(function(_super){__extends(TextureMaterial,_super);function TextureMaterial(texture,smooth,repeat,mipmap){if(typeof texture==="undefined"){texture=null}if(typeof smooth==="undefined"){smooth=true}if(typeof repeat==="undefined"){repeat=false}if(typeof mipmap==="undefined"){mipmap=true}_super.call(this);this.texture=texture;this.smooth=smooth;this.repeat=repeat;this.mipmap=mipmap}Object.defineProperty(TextureMaterial.prototype,"animateUVs",{get:function(){return this._pScreenPass.animateUVs},set:function(value){this._pScreenPass.animateUVs=value},enumerable:true,configurable:true});Object.defineProperty(TextureMaterial.prototype,"alpha",{get:function(){return this._pScreenPass.colorTransform?this._pScreenPass.colorTransform.alphaMultiplier:1},set:function(value){if(value>1){value=1}else{if(value<0){value=0}}if(this.colorTransform==null){this.colorTransform=new away.geom.ColorTransform()}this.colorTransform.alphaMultiplier=value;this._pScreenPass.preserveAlpha=this.getRequiresBlending();this._pScreenPass.setBlendMode(this.getBlendMode()==away.display.BlendMode.NORMAL&&this.getRequiresBlending()?away.display.BlendMode.LAYER:this.getBlendMode())},enumerable:true,configurable:true});Object.defineProperty(TextureMaterial.prototype,"texture",{get:function(){return this._pScreenPass.diffuseMethod.texture},set:function(value){this._pScreenPass.diffuseMethod.texture=value},enumerable:true,configurable:true});Object.defineProperty(TextureMaterial.prototype,"ambientTexture",{get:function(){return this._pScreenPass.ambientMethod.texture},set:function(value){this._pScreenPass.ambientMethod.texture=value;this._pScreenPass.diffuseMethod.iUseAmbientTexture=!(value==null)},enumerable:true,configurable:true});return TextureMaterial})(away.materials.SinglePassMaterialBase);materials.TextureMaterial=TextureMaterial})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var LightPickerBase=(function(_super){__extends(LightPickerBase,_super);function LightPickerBase(){_super.call(this);this._pNumPointLights=0;this._pNumDirectionalLights=0;this._pNumCastingPointLights=0;this._pNumCastingDirectionalLights=0;this._pNumLightProbes=0}LightPickerBase.prototype.dispose=function(){};Object.defineProperty(LightPickerBase.prototype,"assetType",{get:function(){return away.library.AssetType.LIGHT_PICKER},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"numDirectionalLights",{get:function(){return this._pNumDirectionalLights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"numPointLights",{get:function(){return this._pNumPointLights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"numCastingDirectionalLights",{get:function(){return this._pNumCastingDirectionalLights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"numCastingPointLights",{get:function(){return this._pNumCastingPointLights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"numLightProbes",{get:function(){return this._pNumLightProbes},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"pointLights",{get:function(){return this._pPointLights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"directionalLights",{get:function(){return this._pDirectionalLights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"castingPointLights",{get:function(){return this._pCastingPointLights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"castingDirectionalLights",{get:function(){return this._pCastingDirectionalLights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"lightProbes",{get:function(){return this._pLightProbes},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"lightProbeWeights",{get:function(){return this._pLightProbeWeights},enumerable:true,configurable:true});Object.defineProperty(LightPickerBase.prototype,"allPickedLights",{get:function(){return this._pAllPickedLights},enumerable:true,configurable:true});LightPickerBase.prototype.collectLights=function(renderable,entityCollector){this.updateProbeWeights(renderable)};LightPickerBase.prototype.updateProbeWeights=function(renderable){var objectPos=renderable.sourceEntity.scenePosition;var lightPos;var rx=objectPos.x,ry=objectPos.y,rz=objectPos.z;var dx,dy,dz;var w,total=0;var i;for(i=0;i<this._pNumLightProbes;++i){lightPos=this._pLightProbes[i].scenePosition;dx=rx-lightPos.x;dy=ry-lightPos.y;dz=rz-lightPos.z;w=dx*dx+dy*dy+dz*dz;w=w>0.00001?1/w:50000000;this._pLightProbeWeights[i]=w;total+=w}total=1/total;for(i=0;i<this._pNumLightProbes;++i){this._pLightProbeWeights[i]*=total}};return LightPickerBase})(away.library.NamedAssetBase);materials.LightPickerBase=LightPickerBase})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var StaticLightPicker=(function(_super){__extends(StaticLightPicker,_super);function StaticLightPicker(lights){_super.call(this);this.lights=lights}Object.defineProperty(StaticLightPicker.prototype,"lights",{get:function(){return this._lights},set:function(value){var numPointLights=0;var numDirectionalLights=0;var numCastingPointLights=0;var numCastingDirectionalLights=0;var numLightProbes=0;var light;if(this._lights){this.clearListeners()}this._lights=value;this._pAllPickedLights=value;this._pPointLights=new Array();this._pCastingPointLights=new Array();this._pDirectionalLights=new Array();this._pCastingDirectionalLights=new Array();this._pLightProbes=new Array();var len=value.length;for(var i=0;i<len;++i){light=value[i];light.addEventListener(away.events.LightEvent.CASTS_SHADOW_CHANGE,this.onCastShadowChange,this);if(light instanceof away.lights.PointLight){if(light.castsShadows){this._pCastingPointLights[numCastingPointLights++]=light}else{this._pPointLights[numPointLights++]=light}}else{if(light instanceof away.lights.DirectionalLight){if(light.castsShadows){this._pCastingDirectionalLights[numCastingDirectionalLights++]=light}else{this._pDirectionalLights[numDirectionalLights++]=light}}else{if(light instanceof away.lights.LightProbe){this._pLightProbes[numLightProbes++]=light}}}}if(this._pNumDirectionalLights==numDirectionalLights&&this._pNumPointLights==numPointLights&&this._pNumLightProbes==numLightProbes&&this._pNumCastingPointLights==numCastingPointLights&&this._pNumCastingDirectionalLights==numCastingDirectionalLights){return}this._pNumDirectionalLights=numDirectionalLights;this._pNumCastingDirectionalLights=numCastingDirectionalLights;this._pNumPointLights=numPointLights;this._pNumCastingPointLights=numCastingPointLights;this._pNumLightProbes=numLightProbes;this._pLightProbeWeights=new Array(Math.ceil(numLightProbes/4)*4);this.dispatchEvent(new away.events.Event(away.events.Event.CHANGE))},enumerable:true,configurable:true});StaticLightPicker.prototype.clearListeners=function(){var len=this._lights.length;for(var i=0;i<len;++i){this._lights[i].removeEventListener(away.events.LightEvent.CASTS_SHADOW_CHANGE,this.onCastShadowChange,this)}};StaticLightPicker.prototype.onCastShadowChange=function(event){var light=event.target;if(light instanceof away.lights.PointLight){var pl=light;this.updatePointCasting(pl)}else{if(light instanceof away.lights.DirectionalLight){var dl=light;this.updateDirectionalCasting(dl)}}this.dispatchEvent(new away.events.Event(away.events.Event.CHANGE))};StaticLightPicker.prototype.updateDirectionalCasting=function(light){var dl=light;if(light.castsShadows){--this._pNumDirectionalLights;++this._pNumCastingDirectionalLights;this._pDirectionalLights.splice(this._pDirectionalLights.indexOf(dl),1);this._pCastingDirectionalLights.push(light)}else{++this._pNumDirectionalLights;--this._pNumCastingDirectionalLights;this._pCastingDirectionalLights.splice(this._pCastingDirectionalLights.indexOf(dl),1);this._pDirectionalLights.push(light)}};StaticLightPicker.prototype.updatePointCasting=function(light){var pl=light;if(light.castsShadows){--this._pNumPointLights;++this._pNumCastingPointLights;this._pPointLights.splice(this._pPointLights.indexOf(pl),1);this._pCastingPointLights.push(light)}else{++this._pNumPointLights;--this._pNumCastingPointLights;this._pCastingPointLights.splice(this._pCastingPointLights.indexOf(pl),1);this._pPointLights.push(light)}};return StaticLightPicker})(materials.LightPickerBase);materials.StaticLightPicker=StaticLightPicker})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ShaderRegisterCache=(function(){function ShaderRegisterCache(profile){this._numUsedVertexConstants=0;this._numUsedFragmentConstants=0;this._numUsedStreams=0;this._numUsedTextures=0;this._numUsedVaryings=0;this._profile=profile}ShaderRegisterCache.prototype.reset=function(){this._fragmentTempCache=new materials.RegisterPool("ft",8,false);this._vertexTempCache=new materials.RegisterPool("vt",8,false);this._varyingCache=new materials.RegisterPool("v",8);this._textureCache=new materials.RegisterPool("fs",8);this._vertexAttributesCache=new materials.RegisterPool("va",8);this._fragmentConstantsCache=new materials.RegisterPool("fc",28);this._vertexConstantsCache=new materials.RegisterPool("vc",128);this._fragmentOutputRegister=new materials.ShaderRegisterElement("oc",-1);this._vertexOutputRegister=new materials.ShaderRegisterElement("op",-1);this._numUsedVertexConstants=0;this._numUsedStreams=0;this._numUsedTextures=0;this._numUsedVaryings=0;this._numUsedFragmentConstants=0;var i;for(i=0;i<this._vertexAttributesOffset;++i){this.getFreeVertexAttribute()}for(i=0;i<this._vertexConstantOffset;++i){this.getFreeVertexConstant()}for(i=0;i<this._varyingsOffset;++i){this.getFreeVarying()}for(i=0;i<this._fragmentConstantOffset;++i){this.getFreeFragmentConstant()}};ShaderRegisterCache.prototype.dispose=function(){this._fragmentTempCache.dispose();this._vertexTempCache.dispose();this._varyingCache.dispose();this._fragmentConstantsCache.dispose();this._vertexAttributesCache.dispose();this._fragmentTempCache=null;this._vertexTempCache=null;this._varyingCache=null;this._fragmentConstantsCache=null;this._vertexAttributesCache=null;this._fragmentOutputRegister=null;this._vertexOutputRegister=null};ShaderRegisterCache.prototype.addFragmentTempUsages=function(register,usageCount){this._fragmentTempCache.addUsage(register,usageCount)};ShaderRegisterCache.prototype.removeFragmentTempUsage=function(register){this._fragmentTempCache.removeUsage(register)};ShaderRegisterCache.prototype.addVertexTempUsages=function(register,usageCount){this._vertexTempCache.addUsage(register,usageCount)};ShaderRegisterCache.prototype.removeVertexTempUsage=function(register){this._vertexTempCache.removeUsage(register)};ShaderRegisterCache.prototype.getFreeFragmentVectorTemp=function(){return this._fragmentTempCache.requestFreeVectorReg()};ShaderRegisterCache.prototype.getFreeFragmentSingleTemp=function(){return this._fragmentTempCache.requestFreeRegComponent()};ShaderRegisterCache.prototype.getFreeVarying=function(){++this._numUsedVaryings;return this._varyingCache.requestFreeVectorReg()};ShaderRegisterCache.prototype.getFreeFragmentConstant=function(){++this._numUsedFragmentConstants;return this._fragmentConstantsCache.requestFreeVectorReg()};ShaderRegisterCache.prototype.getFreeVertexConstant=function(){++this._numUsedVertexConstants;return this._vertexConstantsCache.requestFreeVectorReg()};ShaderRegisterCache.prototype.getFreeVertexVectorTemp=function(){return this._vertexTempCache.requestFreeVectorReg()};ShaderRegisterCache.prototype.getFreeVertexSingleTemp=function(){return this._vertexTempCache.requestFreeRegComponent()};ShaderRegisterCache.prototype.getFreeVertexAttribute=function(){++this._numUsedStreams;return this._vertexAttributesCache.requestFreeVectorReg()};ShaderRegisterCache.prototype.getFreeTextureReg=function(){++this._numUsedTextures;return this._textureCache.requestFreeVectorReg()};Object.defineProperty(ShaderRegisterCache.prototype,"vertexConstantOffset",{get:function(){return this._vertexConstantOffset},set:function(vertexConstantOffset){this._vertexConstantOffset=vertexConstantOffset},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"vertexAttributesOffset",{get:function(){return this._vertexAttributesOffset},set:function(value){this._vertexAttributesOffset=value},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"varyingsOffset",{get:function(){return this._varyingsOffset},set:function(value){this._varyingsOffset=value},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"fragmentConstantOffset",{get:function(){return this._fragmentConstantOffset},set:function(value){this._fragmentConstantOffset=value},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"fragmentOutputRegister",{get:function(){return this._fragmentOutputRegister},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"numUsedVertexConstants",{get:function(){return this._numUsedVertexConstants},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"numUsedFragmentConstants",{get:function(){return this._numUsedFragmentConstants},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"numUsedStreams",{get:function(){return this._numUsedStreams},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"numUsedTextures",{get:function(){return this._numUsedTextures},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterCache.prototype,"numUsedVaryings",{get:function(){return this._numUsedVaryings},enumerable:true,configurable:true});return ShaderRegisterCache})();materials.ShaderRegisterCache=ShaderRegisterCache})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ShaderRegisterElement=(function(){function ShaderRegisterElement(regName,index,component){if(typeof component==="undefined"){component=-1}this._component=component;this._regName=regName;this._index=index;this._toStr=this._regName;if(this._index>=0){this._toStr+=this._index}if(component>-1){this._toStr+="."+ShaderRegisterElement.COMPONENTS[component]}}ShaderRegisterElement.prototype.toString=function(){return this._toStr};Object.defineProperty(ShaderRegisterElement.prototype,"regName",{get:function(){return this._regName},enumerable:true,configurable:true});Object.defineProperty(ShaderRegisterElement.prototype,"index",{get:function(){return this._index},enumerable:true,configurable:true});ShaderRegisterElement.COMPONENTS=["x","y","z","w"];return ShaderRegisterElement})();materials.ShaderRegisterElement=ShaderRegisterElement})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ShaderRegisterData=(function(){function ShaderRegisterData(){}return ShaderRegisterData})();materials.ShaderRegisterData=ShaderRegisterData})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var MethodDependencyCounter=(function(){function MethodDependencyCounter(){this._usesGlobalPosFragment=false}MethodDependencyCounter.prototype.reset=function(){this._projectionDependencies=0;this._normalDependencies=0;this._viewDirDependencies=0;this._uvDependencies=0;this._secondaryUVDependencies=0;this._globalPosDependencies=0;this._tangentDependencies=0;this._usesGlobalPosFragment=false};MethodDependencyCounter.prototype.setPositionedLights=function(numPointLights,lightSourceMask){this._numPointLights=numPointLights;this._lightSourceMask=lightSourceMask};MethodDependencyCounter.prototype.includeMethodVO=function(methodVO){if(methodVO.needsProjection){++this._projectionDependencies}if(methodVO.needsGlobalVertexPos){++this._globalPosDependencies;if(methodVO.needsGlobalFragmentPos){this._usesGlobalPosFragment=true}}else{if(methodVO.needsGlobalFragmentPos){++this._globalPosDependencies;this._usesGlobalPosFragment=true}}if(methodVO.needsNormals){++this._normalDependencies}if(methodVO.needsTangents){++this._tangentDependencies}if(methodVO.needsView){++this._viewDirDependencies}if(methodVO.needsUV){++this._uvDependencies}if(methodVO.needsSecondaryUV){++this._secondaryUVDependencies}};Object.defineProperty(MethodDependencyCounter.prototype,"tangentDependencies",{get:function(){return this._tangentDependencies},enumerable:true,configurable:true});Object.defineProperty(MethodDependencyCounter.prototype,"usesGlobalPosFragment",{get:function(){return this._usesGlobalPosFragment},enumerable:true,configurable:true});Object.defineProperty(MethodDependencyCounter.prototype,"projectionDependencies",{get:function(){return this._projectionDependencies},enumerable:true,configurable:true});Object.defineProperty(MethodDependencyCounter.prototype,"normalDependencies",{get:function(){return this._normalDependencies},enumerable:true,configurable:true});Object.defineProperty(MethodDependencyCounter.prototype,"viewDirDependencies",{get:function(){return this._viewDirDependencies},enumerable:true,configurable:true});Object.defineProperty(MethodDependencyCounter.prototype,"uvDependencies",{get:function(){return this._uvDependencies},enumerable:true,configurable:true});Object.defineProperty(MethodDependencyCounter.prototype,"secondaryUVDependencies",{get:function(){return this._secondaryUVDependencies},enumerable:true,configurable:true});Object.defineProperty(MethodDependencyCounter.prototype,"globalPosDependencies",{get:function(){return this._globalPosDependencies},enumerable:true,configurable:true});MethodDependencyCounter.prototype.addWorldSpaceDependencies=function(fragmentLights){if(this._viewDirDependencies>0){++this._globalPosDependencies}if(this._numPointLights>0&&(this._lightSourceMask&away.materials.LightSources.LIGHTS)){++this._globalPosDependencies;if(fragmentLights){this._usesGlobalPosFragment=true}}};return MethodDependencyCounter})();materials.MethodDependencyCounter=MethodDependencyCounter})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var RegisterPool=(function(){function RegisterPool(regName,regCount,persistent){if(typeof persistent==="undefined"){persistent=true}this._regName=regName;this._regCount=regCount;this._persistent=persistent;this.initRegisters(regName,regCount)}RegisterPool.prototype.requestFreeVectorReg=function(){for(var i=0;i<this._regCount;++i){if(!this.isRegisterUsed(i)){if(this._persistent){this._usedVectorCount[i]++}return this._vectorRegisters[i]}}throw new Error("Register overflow!")};RegisterPool.prototype.requestFreeRegComponent=function(){for(var i=0;i<this._regCount;++i){if(this._usedVectorCount[i]>0){continue}for(var j=0;j<4;++j){if(this._usedSingleCount[j][i]==0){if(this._persistent){this._usedSingleCount[j][i]++}return this._registerComponents[j][i]}}}throw new Error("Register overflow!")};RegisterPool.prototype.addUsage=function(register,usageCount){if(register._component>-1){this._usedSingleCount[register._component][register.index]+=usageCount}else{this._usedVectorCount[register.index]+=usageCount}};RegisterPool.prototype.removeUsage=function(register){if(register._component>-1){if(--this._usedSingleCount[register._component][register.index]<0){throw new Error("More usages removed than exist!")}}else{if(--this._usedVectorCount[register.index]<0){throw new Error("More usages removed than exist!")}}};RegisterPool.prototype.dispose=function(){this._vectorRegisters=null;this._registerComponents=null;this._usedSingleCount=null;this._usedVectorCount=null};RegisterPool.prototype.hasRegisteredRegs=function(){for(var i=0;i<this._regCount;++i){if(this.isRegisterUsed(i)){return true}}return false};RegisterPool.prototype.initRegisters=function(regName,regCount){var hash=RegisterPool._initPool(regName,regCount);this._vectorRegisters=RegisterPool._regPool[hash];this._registerComponents=RegisterPool._regCompsPool[hash];this._usedVectorCount=this._initArray(Array(regCount),0);this._usedSingleCount=new Array(4);this._usedSingleCount[0]=this._initArray(new Array(regCount),0);this._usedSingleCount[1]=this._initArray(new Array(regCount),0);this._usedSingleCount[2]=this._initArray(new Array(regCount),0);this._usedSingleCount[3]=this._initArray(new Array(regCount),0)};RegisterPool._initPool=function(regName,regCount){var hash=regName+regCount;if(RegisterPool._regPool[hash]!=undefined){return hash}var vectorRegisters=new Array(regCount);RegisterPool._regPool[hash]=vectorRegisters;var registerComponents=[[],[],[],[]];RegisterPool._regCompsPool[hash]=registerComponents;for(var i=0;i<regCount;++i){vectorRegisters[i]=new away.materials.ShaderRegisterElement(regName,i);for(var j=0;j<4;++j){registerComponents[j][i]=new away.materials.ShaderRegisterElement(regName,i,j)}}return hash};RegisterPool.prototype.isRegisterUsed=function(index){if(this._usedVectorCount[index]>0){return true}for(var i=0;i<4;++i){if(this._usedSingleCount[i][index]>0){return true}}return false};RegisterPool.prototype._initArray=function(a,val){var l=a.length;for(var c=0;c<l;c++){a[c]=val}return a};RegisterPool._regPool=new Object();RegisterPool._regCompsPool=new Object();return RegisterPool})();materials.RegisterPool=RegisterPool})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ShaderCompiler=(function(){function ShaderCompiler(profile){this._preserveAlpha=true;this._pVertexCode="";this._pFragmentCode="";this._commonsDataIndex=-1;this._uvBufferIndex=-1;this._uvTransformIndex=-1;this._secondaryUVBufferIndex=-1;this._pNormalBufferIndex=-1;this._pTangentBufferIndex=-1;this._pLightFragmentConstantIndex=-1;this._sceneMatrixIndex=-1;this._pSceneNormalMatrixIndex=-1;this._pCameraPositionIndex=-1;this._pProbeWeightsIndex=-1;this._pSharedRegisters=new away.materials.ShaderRegisterData();this._pDependencyCounter=new away.materials.MethodDependencyCounter();this._pProfile=profile;this.initRegisterCache(profile)}Object.defineProperty(ShaderCompiler.prototype,"enableLightFallOff",{get:function(){return this._pEnableLightFallOff},set:function(value){this._pEnableLightFallOff=value},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"needUVAnimation",{get:function(){return this._needUVAnimation},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"UVTarget",{get:function(){return this._UVTarget},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"UVSource",{get:function(){return this._UVSource},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"forceSeperateMVP",{get:function(){return this._forceSeperateMVP},set:function(value){this._forceSeperateMVP=value},enumerable:true,configurable:true});ShaderCompiler.prototype.initRegisterCache=function(profile){this._pRegisterCache=new away.materials.ShaderRegisterCache(profile);this._pRegisterCache.vertexAttributesOffset=1;this._pRegisterCache.reset()};Object.defineProperty(ShaderCompiler.prototype,"animateUVs",{get:function(){return this._animateUVs},set:function(value){this._animateUVs=value},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"alphaPremultiplied",{get:function(){return this._pAlphaPremultiplied},set:function(value){this._pAlphaPremultiplied=value},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"preserveAlpha",{get:function(){return this._preserveAlpha},set:function(value){this._preserveAlpha=value},enumerable:true,configurable:true});ShaderCompiler.prototype.setTextureSampling=function(smooth,repeat,mipmap){this._smooth=smooth;this._repeat=repeat;this._mipmap=mipmap};ShaderCompiler.prototype.setConstantDataBuffers=function(vertexConstantData,fragmentConstantData){this._vertexConstantData=vertexConstantData;this._fragmentConstantData=fragmentConstantData};Object.defineProperty(ShaderCompiler.prototype,"methodSetup",{get:function(){return this._pMethodSetup},set:function(value){this._pMethodSetup=value},enumerable:true,configurable:true});ShaderCompiler.prototype.compile=function(){this.pInitRegisterIndices();this.pInitLightData();this._pAnimatableAttributes=new Array("va0");this._pAnimationTargetRegisters=new Array("vt0");this._pVertexCode="";this._pFragmentCode="";this._pSharedRegisters.localPosition=this._pRegisterCache.getFreeVertexVectorTemp();this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.localPosition,1);this.createCommons();this.pCalculateDependencies();this.updateMethodRegisters();for(var i=0;i<4;++i){this._pRegisterCache.getFreeVertexConstant()}this.pCreateNormalRegisters();if(this._pDependencyCounter.globalPosDependencies>0||this._forceSeperateMVP){this.pCompileGlobalPositionCode()}this.compileProjectionCode();this.pCompileMethodsCode();this.compileFragmentOutput();this._fragmentPostLightCode=this.fragmentCode};ShaderCompiler.prototype.pCreateNormalRegisters=function(){};ShaderCompiler.prototype.pCompileMethodsCode=function(){if(this._pDependencyCounter.uvDependencies>0){this.compileUVCode()}if(this._pDependencyCounter.secondaryUVDependencies>0){this.compileSecondaryUVCode()}if(this._pDependencyCounter.normalDependencies>0){this.pCompileNormalCode()}if(this._pDependencyCounter.viewDirDependencies>0){this.pCompileViewDirCode()}this.pCompileLightingCode();this._fragmentLightCode=this._pFragmentCode;this._pFragmentCode="";this.pCompileMethods()};ShaderCompiler.prototype.pCompileLightingCode=function(){};ShaderCompiler.prototype.pCompileViewDirCode=function(){};ShaderCompiler.prototype.pCompileNormalCode=function(){};ShaderCompiler.prototype.compileUVCode=function(){var uvAttributeReg=this._pRegisterCache.getFreeVertexAttribute();this._uvBufferIndex=uvAttributeReg.index;var varying=this._pRegisterCache.getFreeVarying();this._pSharedRegisters.uvVarying=varying;if(this.animateUVs){var uvTransform1=this._pRegisterCache.getFreeVertexConstant();var uvTransform2=this._pRegisterCache.getFreeVertexConstant();this._uvTransformIndex=uvTransform1.index*4;this._pVertexCode+="dp4 "+varying.toString()+".x, "+uvAttributeReg.toString()+", "+uvTransform1.toString()+"\ndp4 "+varying.toString()+".y, "+uvAttributeReg.toString()+", "+uvTransform2.toString()+"\nmov "+varying.toString()+".zw, "+uvAttributeReg.toString()+".zw \n"}else{this._uvTransformIndex=-1;this._needUVAnimation=true;this._UVTarget=varying.toString();this._UVSource=uvAttributeReg.toString()}};ShaderCompiler.prototype.compileSecondaryUVCode=function(){var uvAttributeReg=this._pRegisterCache.getFreeVertexAttribute();this._secondaryUVBufferIndex=uvAttributeReg.index;this._pSharedRegisters.secondaryUVVarying=this._pRegisterCache.getFreeVarying();this._pVertexCode+="mov "+this._pSharedRegisters.secondaryUVVarying.toString()+", "+uvAttributeReg.toString()+"\n"};ShaderCompiler.prototype.pCompileGlobalPositionCode=function(){this._pSharedRegisters.globalPositionVertex=this._pRegisterCache.getFreeVertexVectorTemp();this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.globalPositionVertex,this._pDependencyCounter.globalPosDependencies);var positionMatrixReg=this._pRegisterCache.getFreeVertexConstant();this._pRegisterCache.getFreeVertexConstant();this._pRegisterCache.getFreeVertexConstant();this._pRegisterCache.getFreeVertexConstant();this._sceneMatrixIndex=positionMatrixReg.index*4;this._pVertexCode+="m44 "+this._pSharedRegisters.globalPositionVertex.toString()+", "+this._pSharedRegisters.localPosition.toString()+", "+positionMatrixReg.toString()+"\n";if(this._pDependencyCounter.usesGlobalPosFragment){this._pSharedRegisters.globalPositionVarying=this._pRegisterCache.getFreeVarying();this._pVertexCode+="mov "+this._pSharedRegisters.globalPositionVarying.toString()+", "+this._pSharedRegisters.globalPositionVertex.toString()+"\n"}};ShaderCompiler.prototype.compileProjectionCode=function(){var pos=this._pDependencyCounter.globalPosDependencies>0||this._forceSeperateMVP?this._pSharedRegisters.globalPositionVertex.toString():this._pAnimationTargetRegisters[0];var code;if(this._pDependencyCounter.projectionDependencies>0){this._pSharedRegisters.projectionFragment=this._pRegisterCache.getFreeVarying();code="m44 vt5, "+pos+", vc0		\nmov "+this._pSharedRegisters.projectionFragment.toString()+", vt5\nmov op, vt5\n"}else{code="m44 op, "+pos+", vc0		\n"}this._pVertexCode+=code};ShaderCompiler.prototype.compileFragmentOutput=function(){this._pFragmentCode+="mov "+this._pRegisterCache.fragmentOutputRegister.toString()+", "+this._pSharedRegisters.shadedTarget.toString()+"\n";this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.shadedTarget)};ShaderCompiler.prototype.pInitRegisterIndices=function(){this._commonsDataIndex=-1;this._pCameraPositionIndex=-1;this._uvBufferIndex=-1;this._uvTransformIndex=-1;this._secondaryUVBufferIndex=-1;this._pNormalBufferIndex=-1;this._pTangentBufferIndex=-1;this._pLightFragmentConstantIndex=-1;this._sceneMatrixIndex=-1;this._pSceneNormalMatrixIndex=-1;this._pProbeWeightsIndex=-1};ShaderCompiler.prototype.pInitLightData=function(){this._pNumLights=this._pNumPointLights+this._pNumDirectionalLights;this._pNumProbeRegisters=Math.ceil(this._pNumLightProbes/4);if(this._pMethodSetup._iSpecularMethod){this._combinedLightSources=this._specularLightSources|this._diffuseLightSources}else{this._combinedLightSources=this._diffuseLightSources}this._usingSpecularMethod=Boolean(this._pMethodSetup._iSpecularMethod&&(this.pUsesLightsForSpecular()||this.pUsesProbesForSpecular()))};ShaderCompiler.prototype.createCommons=function(){this._pSharedRegisters.commons=this._pRegisterCache.getFreeFragmentConstant();this._commonsDataIndex=this._pSharedRegisters.commons.index*4};ShaderCompiler.prototype.pCalculateDependencies=function(){this._pDependencyCounter.reset();var methods=this._pMethodSetup._iMethods;var len;this.setupAndCountMethodDependencies(this._pMethodSetup._iDiffuseMethod,this._pMethodSetup._iDiffuseMethodVO);if(this._pMethodSetup._iShadowMethod){this.setupAndCountMethodDependencies(this._pMethodSetup._iShadowMethod,this._pMethodSetup._iShadowMethodVO)}this.setupAndCountMethodDependencies(this._pMethodSetup._iAmbientMethod,this._pMethodSetup._iAmbientMethodVO);if(this._usingSpecularMethod){this.setupAndCountMethodDependencies(this._pMethodSetup._iSpecularMethod,this._pMethodSetup._iSpecularMethodVO)}if(this._pMethodSetup._iColorTransformMethod){this.setupAndCountMethodDependencies(this._pMethodSetup._iColorTransformMethod,this._pMethodSetup._iColorTransformMethodVO)}len=methods.length;for(var i=0;i<len;++i){this.setupAndCountMethodDependencies(methods[i].method,methods[i].data)}if(this.usesNormals){this.setupAndCountMethodDependencies(this._pMethodSetup._iNormalMethod,this._pMethodSetup._iNormalMethodVO)}this._pDependencyCounter.setPositionedLights(this._pNumPointLights,this._combinedLightSources)};ShaderCompiler.prototype.setupAndCountMethodDependencies=function(method,methodVO){this.setupMethod(method,methodVO);this._pDependencyCounter.includeMethodVO(methodVO)};ShaderCompiler.prototype.setupMethod=function(method,methodVO){method.iReset();methodVO.reset();methodVO.vertexData=this._vertexConstantData;methodVO.fragmentData=this._fragmentConstantData;methodVO.useSmoothTextures=this._smooth;methodVO.repeatTextures=this._repeat;methodVO.useMipmapping=this._mipmap;methodVO.useLightFallOff=this._pEnableLightFallOff&&this._pProfile!="baselineConstrained";methodVO.numLights=this._pNumLights+this._pNumLightProbes;method.iInitVO(methodVO)};Object.defineProperty(ShaderCompiler.prototype,"commonsDataIndex",{get:function(){return this._commonsDataIndex},enumerable:true,configurable:true});ShaderCompiler.prototype.updateMethodRegisters=function(){this._pMethodSetup._iNormalMethod.iSharedRegisters=this._pSharedRegisters;this._pMethodSetup._iDiffuseMethod.iSharedRegisters=this._pSharedRegisters;if(this._pMethodSetup._iShadowMethod){this._pMethodSetup._iShadowMethod.iSharedRegisters=this._pSharedRegisters}this._pMethodSetup._iAmbientMethod.iSharedRegisters=this._pSharedRegisters;if(this._pMethodSetup._iSpecularMethod){this._pMethodSetup._iSpecularMethod.iSharedRegisters=this._pSharedRegisters}if(this._pMethodSetup._iColorTransformMethod){this._pMethodSetup._iColorTransformMethod.iSharedRegisters=this._pSharedRegisters}var methods=this._pMethodSetup._iMethods;var len=methods.length;for(var i=0;i<len;++i){methods[i].method.iSharedRegisters=this._pSharedRegisters}};Object.defineProperty(ShaderCompiler.prototype,"numUsedVertexConstants",{get:function(){return this._pRegisterCache.numUsedVertexConstants},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"numUsedFragmentConstants",{get:function(){return this._pRegisterCache.numUsedFragmentConstants},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"numUsedStreams",{get:function(){return this._pRegisterCache.numUsedStreams},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"numUsedTextures",{get:function(){return this._pRegisterCache.numUsedTextures},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"numUsedVaryings",{get:function(){return this._pRegisterCache.numUsedVaryings},enumerable:true,configurable:true});ShaderCompiler.prototype.pUsesLightsForSpecular=function(){return this._pNumLights>0&&(this._specularLightSources&away.materials.LightSources.LIGHTS)!=0};ShaderCompiler.prototype.pUsesLightsForDiffuse=function(){return this._pNumLights>0&&(this._diffuseLightSources&away.materials.LightSources.LIGHTS)!=0};ShaderCompiler.prototype.dispose=function(){this.cleanUpMethods();this._pRegisterCache.dispose();this._pRegisterCache=null;this._pSharedRegisters=null};ShaderCompiler.prototype.cleanUpMethods=function(){if(this._pMethodSetup._iNormalMethod){this._pMethodSetup._iNormalMethod.iCleanCompilationData()}if(this._pMethodSetup._iDiffuseMethod){this._pMethodSetup._iDiffuseMethod.iCleanCompilationData()}if(this._pMethodSetup._iAmbientMethod){this._pMethodSetup._iAmbientMethod.iCleanCompilationData()}if(this._pMethodSetup._iSpecularMethod){this._pMethodSetup._iSpecularMethod.iCleanCompilationData()}if(this._pMethodSetup._iShadowMethod){this._pMethodSetup._iShadowMethod.iCleanCompilationData()}if(this._pMethodSetup._iColorTransformMethod){this._pMethodSetup._iColorTransformMethod.iCleanCompilationData()}var methods=this._pMethodSetup._iMethods;var len=methods.length;for(var i=0;i<len;++i){methods[i].method.iCleanCompilationData()}};Object.defineProperty(ShaderCompiler.prototype,"specularLightSources",{get:function(){return this._specularLightSources},set:function(value){this._specularLightSources=value},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"diffuseLightSources",{get:function(){return this._diffuseLightSources},set:function(value){this._diffuseLightSources=value},enumerable:true,configurable:true});ShaderCompiler.prototype.pUsesProbesForSpecular=function(){return this._pNumLightProbes>0&&(this._specularLightSources&away.materials.LightSources.PROBES)!=0};ShaderCompiler.prototype.pUsesProbesForDiffuse=function(){return this._pNumLightProbes>0&&(this._diffuseLightSources&away.materials.LightSources.PROBES)!=0};ShaderCompiler.prototype.pUsesProbes=function(){return this._pNumLightProbes>0&&((this._diffuseLightSources|this._specularLightSources)&away.materials.LightSources.PROBES)!=0};Object.defineProperty(ShaderCompiler.prototype,"uvBufferIndex",{get:function(){return this._uvBufferIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"uvTransformIndex",{get:function(){return this._uvTransformIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"secondaryUVBufferIndex",{get:function(){return this._secondaryUVBufferIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"normalBufferIndex",{get:function(){return this._pNormalBufferIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"tangentBufferIndex",{get:function(){return this._pTangentBufferIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"lightFragmentConstantIndex",{get:function(){return this._pLightFragmentConstantIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"cameraPositionIndex",{get:function(){return this._pCameraPositionIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"sceneMatrixIndex",{get:function(){return this._sceneMatrixIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"sceneNormalMatrixIndex",{get:function(){return this._pSceneNormalMatrixIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"probeWeightsIndex",{get:function(){return this._pProbeWeightsIndex},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"vertexCode",{get:function(){return this._pVertexCode},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"fragmentCode",{get:function(){return this._pFragmentCode},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"fragmentLightCode",{get:function(){return this._fragmentLightCode},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"fragmentPostLightCode",{get:function(){return this._fragmentPostLightCode},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"shadedTarget",{get:function(){return this._pSharedRegisters.shadedTarget.toString()},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"numPointLights",{get:function(){return this._pNumPointLights},set:function(numPointLights){this._pNumPointLights=numPointLights},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"numDirectionalLights",{get:function(){return this._pNumDirectionalLights},set:function(value){this._pNumDirectionalLights=value},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"numLightProbes",{get:function(){return this._pNumLightProbes},set:function(value){this._pNumLightProbes=value},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"usingSpecularMethod",{get:function(){return this._usingSpecularMethod},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"animatableAttributes",{get:function(){return this._pAnimatableAttributes},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"animationTargetRegisters",{get:function(){return this._pAnimationTargetRegisters},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"usesNormals",{get:function(){return this._pDependencyCounter.normalDependencies>0&&this._pMethodSetup._iNormalMethod.iHasOutput},enumerable:true,configurable:true});ShaderCompiler.prototype.pUsesLights=function(){return this._pNumLights>0&&(this._combinedLightSources&away.materials.LightSources.LIGHTS)!=0};ShaderCompiler.prototype.pCompileMethods=function(){var methods=this._pMethodSetup._iMethods;var numMethods=methods.length;var method;var data;var alphaReg;if(this._preserveAlpha){alphaReg=this._pRegisterCache.getFreeFragmentSingleTemp();this._pRegisterCache.addFragmentTempUsages(alphaReg,1);this._pFragmentCode+="mov "+alphaReg.toString()+", "+this._pSharedRegisters.shadedTarget.toString()+".w\n"}for(var i=0;i<numMethods;++i){method=methods[i].method;data=methods[i].data;this._pVertexCode+=method.iGetVertexCode(data,this._pRegisterCache);if(data.needsGlobalVertexPos||data.needsGlobalFragmentPos){this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.globalPositionVertex)}this._pFragmentCode+=method.iGetFragmentCode(data,this._pRegisterCache,this._pSharedRegisters.shadedTarget);if(data.needsNormals){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.normalFragment)}if(data.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}}if(this._preserveAlpha){this._pFragmentCode+="mov "+this._pSharedRegisters.shadedTarget.toString()+".w, "+alphaReg.toString()+"\n";this._pRegisterCache.removeFragmentTempUsage(alphaReg)}if(this._pMethodSetup._iColorTransformMethod){this._pVertexCode+=this._pMethodSetup._iColorTransformMethod.iGetVertexCode(this._pMethodSetup._iColorTransformMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iColorTransformMethod.iGetFragmentCode(this._pMethodSetup._iColorTransformMethodVO,this._pRegisterCache,this._pSharedRegisters.shadedTarget)}};Object.defineProperty(ShaderCompiler.prototype,"lightProbeDiffuseIndices",{get:function(){return this._pLightProbeDiffuseIndices},enumerable:true,configurable:true});Object.defineProperty(ShaderCompiler.prototype,"lightProbeSpecularIndices",{get:function(){return this._pLightProbeSpecularIndices},enumerable:true,configurable:true});return ShaderCompiler})();materials.ShaderCompiler=ShaderCompiler})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var SuperShaderCompiler=(function(_super){__extends(SuperShaderCompiler,_super);function SuperShaderCompiler(profile){_super.call(this,profile)}SuperShaderCompiler.prototype.pInitLightData=function(){_super.prototype.pInitLightData.call(this);this._pointLightRegisters=new Array(this._pNumPointLights*3);this._dirLightRegisters=new Array(this._pNumDirectionalLights*3)};SuperShaderCompiler.prototype.pCalculateDependencies=function(){_super.prototype.pCalculateDependencies.call(this);this._pDependencyCounter.addWorldSpaceDependencies(true)};SuperShaderCompiler.prototype.pCompileNormalCode=function(){var normalMatrix=new Array(3);this._pSharedRegisters.normalFragment=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.normalFragment,this._pDependencyCounter.normalDependencies);if(this._pMethodSetup._iNormalMethod.iHasOutput&&!this._pMethodSetup._iNormalMethod.iTangentSpace){this._pVertexCode+=this._pMethodSetup._iNormalMethod.iGetVertexCode(this._pMethodSetup._iNormalMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iNormalMethod.iGetFragmentCode(this._pMethodSetup._iNormalMethodVO,this._pRegisterCache,this._pSharedRegisters.normalFragment);return}this._pSharedRegisters.normalVarying=this._pRegisterCache.getFreeVarying();normalMatrix[0]=this._pRegisterCache.getFreeVertexConstant();normalMatrix[1]=this._pRegisterCache.getFreeVertexConstant();normalMatrix[2]=this._pRegisterCache.getFreeVertexConstant();this._pRegisterCache.getFreeVertexConstant();this._pSceneNormalMatrixIndex=normalMatrix[0].index*4;if(this._pMethodSetup._iNormalMethod.iHasOutput){this.compileTangentVertexCode(normalMatrix);this.compileTangentNormalMapFragmentCode()}else{this._pVertexCode+="m33 "+this._pSharedRegisters.normalVarying.toString()+".xyz, "+this._pSharedRegisters.animatedNormal.toString()+", "+normalMatrix[0].toString()+"\nmov "+this._pSharedRegisters.normalVarying.toString()+".w, "+this._pSharedRegisters.animatedNormal.toString()+".w	\n";this._pFragmentCode+="nrm "+this._pSharedRegisters.normalFragment.toString()+".xyz, "+this._pSharedRegisters.normalVarying.toString()+"\nmov "+this._pSharedRegisters.normalFragment.toString()+".w, "+this._pSharedRegisters.normalVarying.toString()+".w		\n";if(this._pDependencyCounter.tangentDependencies>0){this._pSharedRegisters.tangentInput=this._pRegisterCache.getFreeVertexAttribute();this._pTangentBufferIndex=this._pSharedRegisters.tangentInput.index;this._pSharedRegisters.tangentVarying=this._pRegisterCache.getFreeVarying();this._pVertexCode+="mov "+this._pSharedRegisters.tangentVarying.toString()+", "+this._pSharedRegisters.tangentInput.toString()+"\n"}}this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.animatedNormal)};SuperShaderCompiler.prototype.pCreateNormalRegisters=function(){if(this._pDependencyCounter.normalDependencies>0){this._pSharedRegisters.normalInput=this._pRegisterCache.getFreeVertexAttribute();this._pNormalBufferIndex=this._pSharedRegisters.normalInput.index;this._pSharedRegisters.animatedNormal=this._pRegisterCache.getFreeVertexVectorTemp();this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.animatedNormal,1);this._pAnimatableAttributes.push(this._pSharedRegisters.normalInput.toString());this._pAnimationTargetRegisters.push(this._pSharedRegisters.animatedNormal.toString())}if(this._pMethodSetup._iNormalMethod.iHasOutput){this._pSharedRegisters.tangentInput=this._pRegisterCache.getFreeVertexAttribute();this._pTangentBufferIndex=this._pSharedRegisters.tangentInput.index;this._pSharedRegisters.animatedTangent=this._pRegisterCache.getFreeVertexVectorTemp();this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.animatedTangent,1);this._pAnimatableAttributes.push(this._pSharedRegisters.tangentInput.toString());this._pAnimationTargetRegisters.push(this._pSharedRegisters.animatedTangent.toString())}};SuperShaderCompiler.prototype.compileTangentVertexCode=function(matrix){this._pSharedRegisters.tangentVarying=this._pRegisterCache.getFreeVarying();this._pSharedRegisters.bitangentVarying=this._pRegisterCache.getFreeVarying();this._pVertexCode+="m33 "+this._pSharedRegisters.animatedNormal.toString()+".xyz, "+this._pSharedRegisters.animatedNormal.toString()+", "+matrix[0].toString()+"\nnrm "+this._pSharedRegisters.animatedNormal.toString()+".xyz, "+this._pSharedRegisters.animatedNormal.toString()+"\n";this._pVertexCode+="m33 "+this._pSharedRegisters.animatedTangent.toString()+".xyz, "+this._pSharedRegisters.animatedTangent.toString()+", "+matrix[0].toString()+"\nnrm "+this._pSharedRegisters.animatedTangent.toString()+".xyz, "+this._pSharedRegisters.animatedTangent.toString()+"\n";var bitanTemp=this._pRegisterCache.getFreeVertexVectorTemp();this._pVertexCode+="mov "+this._pSharedRegisters.tangentVarying.toString()+".x, "+this._pSharedRegisters.animatedTangent.toString()+".x  \nmov "+this._pSharedRegisters.tangentVarying.toString()+".z, "+this._pSharedRegisters.animatedNormal.toString()+".x  \nmov "+this._pSharedRegisters.tangentVarying.toString()+".w, "+this._pSharedRegisters.normalInput.toString()+".w  \nmov "+this._pSharedRegisters.bitangentVarying.toString()+".x, "+this._pSharedRegisters.animatedTangent.toString()+".y  \nmov "+this._pSharedRegisters.bitangentVarying.toString()+".z, "+this._pSharedRegisters.animatedNormal.toString()+".y  \nmov "+this._pSharedRegisters.bitangentVarying.toString()+".w, "+this._pSharedRegisters.normalInput.toString()+".w  \nmov "+this._pSharedRegisters.normalVarying.toString()+".x, "+this._pSharedRegisters.animatedTangent.toString()+".z  \nmov "+this._pSharedRegisters.normalVarying.toString()+".z, "+this._pSharedRegisters.animatedNormal.toString()+".z  \nmov "+this._pSharedRegisters.normalVarying.toString()+".w, "+this._pSharedRegisters.normalInput.toString()+".w  \ncrs "+bitanTemp.toString()+".xyz, "+this._pSharedRegisters.animatedNormal.toString()+", "+this._pSharedRegisters.animatedTangent.toString()+"\nmov "+this._pSharedRegisters.tangentVarying.toString()+".y, "+bitanTemp.toString()+".x    \nmov "+this._pSharedRegisters.bitangentVarying.toString()+".y, "+bitanTemp.toString()+".y  \nmov "+this._pSharedRegisters.normalVarying.toString()+".y, "+bitanTemp.toString()+".z    \n";this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.animatedTangent)};SuperShaderCompiler.prototype.compileTangentNormalMapFragmentCode=function(){var t;var b;var n;t=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(t,1);b=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(b,1);n=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(n,1);this._pFragmentCode+="nrm "+t.toString()+".xyz, "+this._pSharedRegisters.tangentVarying.toString()+"\nmov "+t.toString()+".w, "+this._pSharedRegisters.tangentVarying.toString()+".w	\nnrm "+b.toString()+".xyz, "+this._pSharedRegisters.bitangentVarying.toString()+"\nnrm "+n.toString()+".xyz, "+this._pSharedRegisters.normalVarying.toString()+"\n";var temp=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(temp,1);this._pFragmentCode+=this._pMethodSetup._iNormalMethod.iGetFragmentCode(this._pMethodSetup._iNormalMethodVO,this._pRegisterCache,temp)+"m33 "+this._pSharedRegisters.normalFragment.toString()+".xyz, "+temp.toString()+", "+t.toString()+"	\nmov "+this._pSharedRegisters.normalFragment.toString()+".w,   "+this._pSharedRegisters.normalVarying.toString()+".w			\n";this._pRegisterCache.removeFragmentTempUsage(temp);if(this._pMethodSetup._iNormalMethodVO.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}if(this._pMethodSetup._iNormalMethodVO.needsGlobalVertexPos||this._pMethodSetup._iNormalMethodVO.needsGlobalFragmentPos){this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.globalPositionVertex)}this._pRegisterCache.removeFragmentTempUsage(b);this._pRegisterCache.removeFragmentTempUsage(t);this._pRegisterCache.removeFragmentTempUsage(n)};SuperShaderCompiler.prototype.pCompileViewDirCode=function(){var cameraPositionReg=this._pRegisterCache.getFreeVertexConstant();this._pSharedRegisters.viewDirVarying=this._pRegisterCache.getFreeVarying();this._pSharedRegisters.viewDirFragment=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.viewDirFragment,this._pDependencyCounter.viewDirDependencies);this._pCameraPositionIndex=cameraPositionReg.index*4;this._pVertexCode+="sub "+this._pSharedRegisters.viewDirVarying.toString()+", "+cameraPositionReg.toString()+", "+this._pSharedRegisters.globalPositionVertex.toString()+"\n";this._pFragmentCode+="nrm "+this._pSharedRegisters.viewDirFragment.toString()+".xyz, "+this._pSharedRegisters.viewDirVarying.toString()+"\nmov "+this._pSharedRegisters.viewDirFragment.toString()+".w,   "+this._pSharedRegisters.viewDirVarying.toString()+".w 		\n";this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.globalPositionVertex)};SuperShaderCompiler.prototype.pCompileLightingCode=function(){var shadowReg;this._pSharedRegisters.shadedTarget=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.shadedTarget,1);this._pVertexCode+=this._pMethodSetup._iDiffuseMethod.iGetVertexCode(this._pMethodSetup._iDiffuseMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentPreLightingCode(this._pMethodSetup._iDiffuseMethodVO,this._pRegisterCache);if(this._usingSpecularMethod){this._pVertexCode+=this._pMethodSetup._iSpecularMethod.iGetVertexCode(this._pMethodSetup._iSpecularMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentPreLightingCode(this._pMethodSetup._iSpecularMethodVO,this._pRegisterCache)}if(this.pUsesLights()){this.initLightRegisters();this.compileDirectionalLightCode();this.compilePointLightCode()}if(this.pUsesProbes()){this.compileLightProbeCode()}this._pVertexCode+=this._pMethodSetup._iAmbientMethod.iGetVertexCode(this._pMethodSetup._iAmbientMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iAmbientMethod.iGetFragmentCode(this._pMethodSetup._iAmbientMethodVO,this._pRegisterCache,this._pSharedRegisters.shadedTarget);if(this._pMethodSetup._iAmbientMethodVO.needsNormals){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.normalFragment)}if(this._pMethodSetup._iAmbientMethodVO.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}if(this._pMethodSetup._iShadowMethod){this._pVertexCode+=this._pMethodSetup._iShadowMethod.iGetVertexCode(this._pMethodSetup._iShadowMethodVO,this._pRegisterCache);if(this._pDependencyCounter.normalDependencies==0){shadowReg=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(shadowReg,1)}else{shadowReg=this._pSharedRegisters.normalFragment}this._pMethodSetup._iDiffuseMethod.iShadowRegister=shadowReg;this._pFragmentCode+=this._pMethodSetup._iShadowMethod.iGetFragmentCode(this._pMethodSetup._iShadowMethodVO,this._pRegisterCache,shadowReg)}this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentPostLightingCode(this._pMethodSetup._iDiffuseMethodVO,this._pRegisterCache,this._pSharedRegisters.shadedTarget);if(this._pAlphaPremultiplied){this._pFragmentCode+="add "+this._pSharedRegisters.shadedTarget.toString()+".w, "+this._pSharedRegisters.shadedTarget.toString()+".w, "+this._pSharedRegisters.commons.toString()+".z\ndiv "+this._pSharedRegisters.shadedTarget.toString()+".xyz, "+this._pSharedRegisters.shadedTarget.toString()+", "+this._pSharedRegisters.shadedTarget.toString()+".w\nsub "+this._pSharedRegisters.shadedTarget.toString()+".w, "+this._pSharedRegisters.shadedTarget.toString()+".w, "+this._pSharedRegisters.commons.toString()+".z\nsat "+this._pSharedRegisters.shadedTarget.toString()+".xyz, "+this._pSharedRegisters.shadedTarget.toString()+"\n"}if(this._pMethodSetup._iDiffuseMethodVO.needsNormals){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.normalFragment)}if(this._pMethodSetup._iDiffuseMethodVO.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}if(this._usingSpecularMethod){this._pMethodSetup._iSpecularMethod.iShadowRegister=shadowReg;this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentPostLightingCode(this._pMethodSetup._iSpecularMethodVO,this._pRegisterCache,this._pSharedRegisters.shadedTarget);if(this._pMethodSetup._iSpecularMethodVO.needsNormals){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.normalFragment)}if(this._pMethodSetup._iSpecularMethodVO.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}}};SuperShaderCompiler.prototype.initLightRegisters=function(){var i,len;len=this._dirLightRegisters.length;for(i=0;i<len;++i){this._dirLightRegisters[i]=this._pRegisterCache.getFreeFragmentConstant();if(this._pLightFragmentConstantIndex==-1){this._pLightFragmentConstantIndex=this._dirLightRegisters[i].index*4}}len=this._pointLightRegisters.length;for(i=0;i<len;++i){this._pointLightRegisters[i]=this._pRegisterCache.getFreeFragmentConstant();if(this._pLightFragmentConstantIndex==-1){this._pLightFragmentConstantIndex=this._pointLightRegisters[i].index*4}}};SuperShaderCompiler.prototype.compileDirectionalLightCode=function(){var diffuseColorReg;var specularColorReg;var lightDirReg;var regIndex=0;var addSpec=this._usingSpecularMethod&&this.pUsesLightsForSpecular();var addDiff=this.pUsesLightsForDiffuse();if(!(addSpec||addDiff)){return}for(var i=0;i<this._pNumDirectionalLights;++i){lightDirReg=this._dirLightRegisters[regIndex++];diffuseColorReg=this._dirLightRegisters[regIndex++];specularColorReg=this._dirLightRegisters[regIndex++];if(addDiff){this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentCodePerLight(this._pMethodSetup._iDiffuseMethodVO,lightDirReg,diffuseColorReg,this._pRegisterCache)}if(addSpec){this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentCodePerLight(this._pMethodSetup._iSpecularMethodVO,lightDirReg,specularColorReg,this._pRegisterCache)}}};SuperShaderCompiler.prototype.compilePointLightCode=function(){var diffuseColorReg;var specularColorReg;var lightPosReg;var lightDirReg;var regIndex=0;var addSpec=this._usingSpecularMethod&&this.pUsesLightsForSpecular();var addDiff=this.pUsesLightsForDiffuse();if(!(addSpec||addDiff)){return}for(var i=0;i<this._pNumPointLights;++i){lightPosReg=this._pointLightRegisters[regIndex++];diffuseColorReg=this._pointLightRegisters[regIndex++];specularColorReg=this._pointLightRegisters[regIndex++];lightDirReg=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(lightDirReg,1);this._pFragmentCode+="sub "+lightDirReg.toString()+", "+lightPosReg.toString()+", "+this._pSharedRegisters.globalPositionVarying.toString()+"\ndp3 "+lightDirReg.toString()+".w, "+lightDirReg.toString()+", "+lightDirReg.toString()+"\nsub "+lightDirReg.toString()+".w, "+lightDirReg.toString()+".w, "+diffuseColorReg.toString()+".w\nmul "+lightDirReg.toString()+".w, "+lightDirReg.toString()+".w, "+specularColorReg.toString()+".w\nsat "+lightDirReg.toString()+".w, "+lightDirReg.toString()+".w\nsub "+lightDirReg.toString()+".w, "+lightPosReg.toString()+".w, "+lightDirReg.toString()+".w\nnrm "+lightDirReg.toString()+".xyz, "+lightDirReg.toString()+"\n";if(this._pLightFragmentConstantIndex==-1){this._pLightFragmentConstantIndex=lightPosReg.index*4}if(addDiff){this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentCodePerLight(this._pMethodSetup._iDiffuseMethodVO,lightDirReg,diffuseColorReg,this._pRegisterCache)}if(addSpec){this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentCodePerLight(this._pMethodSetup._iSpecularMethodVO,lightDirReg,specularColorReg,this._pRegisterCache)}this._pRegisterCache.removeFragmentTempUsage(lightDirReg)}};SuperShaderCompiler.prototype.compileLightProbeCode=function(){var weightReg;var weightComponents=[".x",".y",".z",".w"];var weightRegisters=new Array();var i;var texReg;var addSpec=this._usingSpecularMethod&&this.pUsesProbesForSpecular();var addDiff=this.pUsesProbesForDiffuse();if(!(addSpec||addDiff)){return}if(addDiff){this._pLightProbeDiffuseIndices=new Array()}if(addSpec){this._pLightProbeSpecularIndices=new Array()}for(i=0;i<this._pNumProbeRegisters;++i){weightRegisters[i]=this._pRegisterCache.getFreeFragmentConstant();if(i==0){this._pProbeWeightsIndex=weightRegisters[i].index*4}}for(i=0;i<this._pNumLightProbes;++i){weightReg=weightRegisters[Math.floor(i/4)].toString()+weightComponents[i%4];if(addDiff){texReg=this._pRegisterCache.getFreeTextureReg();this._pLightProbeDiffuseIndices[i]=texReg.index;this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentCodePerProbe(this._pMethodSetup._iDiffuseMethodVO,texReg,weightReg,this._pRegisterCache)}if(addSpec){texReg=this._pRegisterCache.getFreeTextureReg();this._pLightProbeSpecularIndices[i]=texReg.index;this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentCodePerProbe(this._pMethodSetup._iSpecularMethodVO,texReg,weightReg,this._pRegisterCache)}}};return SuperShaderCompiler})(away.materials.ShaderCompiler);materials.SuperShaderCompiler=SuperShaderCompiler})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var LightSources=(function(){function LightSources(){}LightSources.LIGHTS=1;LightSources.PROBES=2;LightSources.ALL=3;return LightSources})();materials.LightSources=LightSources})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var BasicAmbientMethod=(function(_super){__extends(BasicAmbientMethod,_super);function BasicAmbientMethod(){_super.call(this);this._useTexture=false;this._ambientColor=16777215;this._ambientR=0;this._ambientG=0;this._ambientB=0;this._ambient=1;this._iLightAmbientR=0;this._iLightAmbientG=0;this._iLightAmbientB=0}BasicAmbientMethod.prototype.iInitVO=function(vo){vo.needsUV=this._useTexture};BasicAmbientMethod.prototype.iInitConstants=function(vo){vo.fragmentData[vo.fragmentConstantsIndex+3]=1};Object.defineProperty(BasicAmbientMethod.prototype,"ambient",{get:function(){return this._ambient},set:function(value){this._ambient=value},enumerable:true,configurable:true});Object.defineProperty(BasicAmbientMethod.prototype,"ambientColor",{get:function(){return this._ambientColor},set:function(value){this._ambientColor=value},enumerable:true,configurable:true});Object.defineProperty(BasicAmbientMethod.prototype,"texture",{get:function(){return this._texture},set:function(value){away.Debug.throwPIR("BasicAmbientMethod","set texture","TRICKY - Odd boolean assignment - needs testing");var b=(value!=null);if(b!=this._useTexture||(value&&this._texture&&(value.hasMipMaps!=this._texture.hasMipMaps||value.format!=this._texture.format))){this.iInvalidateShaderProgram()}this._useTexture=b;this._texture=value},enumerable:true,configurable:true});BasicAmbientMethod.prototype.copyFrom=function(method){away.Debug.throwPIR("BasicAmbientMethod","copyFrom","TRICKY - Odd case assignment - needs testing");var m=method;var b=m;var diff=b;this.ambient=diff.ambient;this.ambientColor=diff.ambientColor};BasicAmbientMethod.prototype.iCleanCompilationData=function(){_super.prototype.iCleanCompilationData.call(this);this._ambientInputRegister=null};BasicAmbientMethod.prototype.iGetFragmentCode=function(vo,regCache,targetReg){var code="";if(this._useTexture){this._ambientInputRegister=regCache.getFreeTextureReg();vo.texturesIndex=this._ambientInputRegister.index;code+=this.pGetTex2DSampleCode(vo,targetReg,this._ambientInputRegister,this._texture)+"div "+targetReg.toString()+".xyz, "+targetReg.toString()+".xyz, "+targetReg.toString()+".w\n"}else{this._ambientInputRegister=regCache.getFreeFragmentConstant();vo.fragmentConstantsIndex=this._ambientInputRegister.index*4;code+="mov "+targetReg.toString()+", "+this._ambientInputRegister.toString()+"\n"}return code};BasicAmbientMethod.prototype.iActivate=function(vo,stage3DProxy){if(this._useTexture){stage3DProxy._iContext3D.setTextureAt(vo.texturesIndex,this._texture.getTextureForStage3D(stage3DProxy))}};BasicAmbientMethod.prototype.updateAmbient=function(){this._ambientR=((this._ambientColor>>16)&255)/255*this._ambient*this._iLightAmbientR;this._ambientG=((this._ambientColor>>8)&255)/255*this._ambient*this._iLightAmbientG;this._ambientB=(this.ambientColor&255)/255*this._ambient*this._iLightAmbientB};BasicAmbientMethod.prototype.iSetRenderState=function(vo,renderable,stage3DProxy,camera){this.updateAmbient();if(!this._useTexture){var index=vo.fragmentConstantsIndex;var data=vo.fragmentData;data[index]=this._ambientR;data[index+1]=this._ambientG;data[index+2]=this._ambientB}};return BasicAmbientMethod})(away.materials.ShadingMethodBase);materials.BasicAmbientMethod=BasicAmbientMethod})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var BasicDiffuseMethod=(function(_super){__extends(BasicDiffuseMethod,_super);function BasicDiffuseMethod(){_super.call(this);this._diffuseColor=16777215;this._diffuseR=1;this._diffuseG=1;this._diffuseB=1;this._diffuseA=1;this._alphaThreshold=0}Object.defineProperty(BasicDiffuseMethod.prototype,"iUseAmbientTexture",{get:function(){return this._useAmbientTexture},set:function(value){if(this._useAmbientTexture==value){return}this._useAmbientTexture=value;this.iInvalidateShaderProgram()},enumerable:true,configurable:true});BasicDiffuseMethod.prototype.iInitVO=function(vo){vo.needsUV=this._useTexture;vo.needsNormals=vo.numLights>0};BasicDiffuseMethod.prototype.generateMip=function(stage3DProxy){if(this._useTexture){this._texture.getTextureForStage3D(stage3DProxy)}};Object.defineProperty(BasicDiffuseMethod.prototype,"diffuseAlpha",{get:function(){return this._diffuseA},set:function(value){this._diffuseA=value},enumerable:true,configurable:true});Object.defineProperty(BasicDiffuseMethod.prototype,"diffuseColor",{get:function(){return this._diffuseColor},set:function(diffuseColor){this._diffuseColor=diffuseColor;this.updateDiffuse()},enumerable:true,configurable:true});Object.defineProperty(BasicDiffuseMethod.prototype,"texture",{get:function(){return this._texture},set:function(value){away.Debug.throwPIR("BasicDiffuseMethod","set texture","TRICKY - Odd boolean assignment - needs testing");var b=(value!=null);if(b!=this._useTexture||(value&&this._texture&&(value.hasMipMaps!=this._texture.hasMipMaps||value.format!=this._texture.format))){this.iInvalidateShaderProgram()}this._useTexture=b;this._texture=value},enumerable:true,configurable:true});Object.defineProperty(BasicDiffuseMethod.prototype,"alphaThreshold",{get:function(){return this._alphaThreshold},set:function(value){if(value<0){value=0}else{if(value>1){value=1}}if(value==this._alphaThreshold){return}if(value==0||this._alphaThreshold==0){this.iInvalidateShaderProgram()}this._alphaThreshold=value},enumerable:true,configurable:true});BasicDiffuseMethod.prototype.dispose=function(){this._texture=null};BasicDiffuseMethod.prototype.copyFrom=function(method){var m=method;var diff=m;this.alphaThreshold=diff.alphaThreshold;this.texture=diff.texture;this.iUseAmbientTexture=diff.iUseAmbientTexture;this.diffuseAlpha=diff.diffuseAlpha;this.diffuseColor=diff.diffuseColor};BasicDiffuseMethod.prototype.iCleanCompilationData=function(){_super.prototype.iCleanCompilationData.call(this);this._shadowRegister=null;this._totalLightColorReg=null;this._diffuseInputRegister=null};BasicDiffuseMethod.prototype.iGetFragmentPreLightingCode=function(vo,regCache){var code="";this._isFirstLight=true;if(vo.numLights>0){this._totalLightColorReg=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(this._totalLightColorReg,1)}return code};BasicDiffuseMethod.prototype.iGetFragmentCodePerLight=function(vo,lightDirReg,lightColReg,regCache){var code="";var t;if(this._isFirstLight){t=this._totalLightColorReg}else{t=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(t,1)}code+="dp3 "+t+".x, "+lightDirReg.toString()+", "+this._sharedRegisters.normalFragment.toString()+"\nmax "+t.toString()+".w, "+t.toString()+".x, "+this._sharedRegisters.commons.toString()+".y\n";if(vo.useLightFallOff){code+="mul "+t.toString()+".w, "+t.toString()+".w, "+lightDirReg.toString()+".w\n"}if(this._iModulateMethod!=null){code+=this._iModulateMethod(vo,t,regCache,this._sharedRegisters)}code+="mul "+t.toString()+", "+t.toString()+".w, "+lightColReg.toString()+"\n";if(!this._isFirstLight){code+="add "+this._totalLightColorReg.toString()+".xyz, "+this._totalLightColorReg.toString()+", "+t.toString()+"\n";regCache.removeFragmentTempUsage(t)}this._isFirstLight=false;return code};BasicDiffuseMethod.prototype.iGetFragmentCodePerProbe=function(vo,cubeMapReg,weightRegister,regCache){var code="";var t;if(this._isFirstLight){t=this._totalLightColorReg}else{t=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(t,1)}code+="tex "+t.toString()+", "+this._sharedRegisters.normalFragment.toString()+", "+cubeMapReg.toString()+" <cube,linear,miplinear>\nmul "+t.toString()+".xyz, "+t.toString()+".xyz, "+weightRegister+"\n";if(this._iModulateMethod!=null){code+=this._iModulateMethod(vo,t,regCache,this._sharedRegisters)}if(!this._isFirstLight){code+="add "+this._totalLightColorReg+".xyz, "+this._totalLightColorReg+", "+t.toString()+"\n";regCache.removeFragmentTempUsage(t)}this._isFirstLight=false;return code};BasicDiffuseMethod.prototype.iGetFragmentPostLightingCode=function(vo,regCache,targetReg){var code="";var albedo;var cutOffReg;if(vo.numLights>0){if(this._shadowRegister){code+=this.pApplyShadow(vo,regCache)}albedo=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(albedo,1)}else{albedo=targetReg}if(this._useTexture){this._diffuseInputRegister=regCache.getFreeTextureReg();vo.texturesIndex=this._diffuseInputRegister.index;code+=this.pGetTex2DSampleCode(vo,albedo,this._diffuseInputRegister,this._texture);if(this._alphaThreshold>0){cutOffReg=regCache.getFreeFragmentConstant();vo.fragmentConstantsIndex=cutOffReg.index*4;code+="sub "+albedo.toString()+".w, "+albedo.toString()+".w, "+cutOffReg.toString()+".x\nkil "+albedo.toString()+".w\nadd "+albedo.toString()+".w, "+albedo.toString()+".w, "+cutOffReg.toString()+".x\n"}}else{this._diffuseInputRegister=regCache.getFreeFragmentConstant();vo.fragmentConstantsIndex=this._diffuseInputRegister.index*4;code+="mov "+albedo.toString()+", "+this._diffuseInputRegister.toString()+"\n"}if(vo.numLights==0){return code}code+="sat "+this._totalLightColorReg.toString()+", "+this._totalLightColorReg.toString()+"\n";if(this._useAmbientTexture){code+="mul "+albedo.toString()+".xyz, "+albedo.toString()+", "+this._totalLightColorReg.toString()+"\nmul "+this._totalLightColorReg.toString()+".xyz, "+targetReg.toString()+", "+this._totalLightColorReg.toString()+"\nsub "+targetReg.toString()+".xyz, "+targetReg.toString()+", "+this._totalLightColorReg.toString()+"\nadd "+targetReg.toString()+".xyz, "+albedo.toString()+", "+targetReg.toString()+"\n"}else{code+="add "+targetReg.toString()+".xyz, "+this._totalLightColorReg.toString()+", "+targetReg.toString()+"\n";if(this._useTexture){code+="mul "+targetReg.toString()+".xyz, "+albedo.toString()+", "+targetReg.toString()+"\nmov "+targetReg+".w, "+albedo+".w\n"}else{code+="mul "+targetReg.toString()+".xyz, "+this._diffuseInputRegister.toString()+", "+targetReg.toString()+"\nmov "+targetReg.toString()+".w, "+this._diffuseInputRegister.toString()+".w\n"}}regCache.removeFragmentTempUsage(this._totalLightColorReg);regCache.removeFragmentTempUsage(albedo);return code};BasicDiffuseMethod.prototype.pApplyShadow=function(vo,regCache){return"mul "+this._totalLightColorReg.toString()+".xyz, "+this._totalLightColorReg.toString()+", "+this._shadowRegister.toString()+".w\n"};BasicDiffuseMethod.prototype.iActivate=function(vo,stage3DProxy){if(this._useTexture){stage3DProxy._iContext3D.setTextureAt(vo.texturesIndex,this._texture.getTextureForStage3D(stage3DProxy));if(this._alphaThreshold>0){vo.fragmentData[vo.fragmentConstantsIndex]=this._alphaThreshold}}else{var index=vo.fragmentConstantsIndex;var data=vo.fragmentData;data[index]=this._diffuseR;data[index+1]=this._diffuseG;data[index+2]=this._diffuseB;data[index+3]=this._diffuseA}};BasicDiffuseMethod.prototype.updateDiffuse=function(){this._diffuseR=((this._diffuseColor>>16)&255)/255;this._diffuseG=((this._diffuseColor>>8)&255)/255;this._diffuseB=(this._diffuseColor&255)/255};Object.defineProperty(BasicDiffuseMethod.prototype,"iShadowRegister",{set:function(value){this._shadowRegister=value},enumerable:true,configurable:true});return BasicDiffuseMethod})(away.materials.LightingMethodBase);materials.BasicDiffuseMethod=BasicDiffuseMethod})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var BasicNormalMethod=(function(_super){__extends(BasicNormalMethod,_super);function BasicNormalMethod(){_super.call(this)}BasicNormalMethod.prototype.iInitVO=function(vo){if(this._texture){vo.needsUV=true}else{vo.needsUV=false}};Object.defineProperty(BasicNormalMethod.prototype,"iTangentSpace",{get:function(){return true},enumerable:true,configurable:true});Object.defineProperty(BasicNormalMethod.prototype,"iHasOutput",{get:function(){return this._useTexture},enumerable:true,configurable:true});BasicNormalMethod.prototype.copyFrom=function(method){var s=method;var bnm=method;this.normalMap=bnm.normalMap};Object.defineProperty(BasicNormalMethod.prototype,"normalMap",{get:function(){return this._texture},set:function(value){var b=(value!=null);if(b!=this._useTexture||(value&&this._texture&&(value.hasMipMaps!=this._texture.hasMipMaps||value.format!=this._texture.format))){this.iInvalidateShaderProgram()}this._useTexture=Boolean(value);this._texture=value},enumerable:true,configurable:true});BasicNormalMethod.prototype.iCleanCompilationData=function(){_super.prototype.iCleanCompilationData.call(this);this._normalTextureRegister=null};BasicNormalMethod.prototype.dispose=function(){if(this._texture){this._texture=null}};BasicNormalMethod.prototype.iActivate=function(vo,stage3DProxy){if(vo.texturesIndex>=0){stage3DProxy._iContext3D.setTextureAt(vo.texturesIndex,this._texture.getTextureForStage3D(stage3DProxy))}};BasicNormalMethod.prototype.iGetFragmentCode=function(vo,regCache,targetReg){this._normalTextureRegister=regCache.getFreeTextureReg();vo.texturesIndex=this._normalTextureRegister.index;return this.pGetTex2DSampleCode(vo,targetReg,this._normalTextureRegister,this._texture)+"sub "+targetReg.toString()+".xyz, "+targetReg.toString()+".xyz, "+this._sharedRegisters.commons.toString()+".xxx	\nnrm "+targetReg.toString()+".xyz, "+targetReg.toString()+".xyz							\n"};return BasicNormalMethod})(away.materials.ShadingMethodBase);materials.BasicNormalMethod=BasicNormalMethod})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var BasicSpecularMethod=(function(_super){__extends(BasicSpecularMethod,_super);function BasicSpecularMethod(){_super.call(this);this._gloss=50;this._specular=1;this._specularColor=16777215;this._iSpecularR=1;this._iSpecularG=1;this._iSpecularB=1}BasicSpecularMethod.prototype.iInitVO=function(vo){vo.needsUV=this._useTexture;vo.needsNormals=vo.numLights>0;vo.needsView=vo.numLights>0};Object.defineProperty(BasicSpecularMethod.prototype,"gloss",{get:function(){return this._gloss},set:function(value){this._gloss=value},enumerable:true,configurable:true});Object.defineProperty(BasicSpecularMethod.prototype,"specular",{get:function(){return this._specular},set:function(value){if(value==this._specular){return}this._specular=value;this.updateSpecular()},enumerable:true,configurable:true});Object.defineProperty(BasicSpecularMethod.prototype,"specularColor",{get:function(){return this._specularColor},set:function(value){if(this._specularColor==value){return}if(this._specularColor==0||value==0){this.iInvalidateShaderProgram()}this._specularColor=value;this.updateSpecular()},enumerable:true,configurable:true});Object.defineProperty(BasicSpecularMethod.prototype,"texture",{get:function(){return this._texture},set:function(value){var b=(value!=null);if(b!=this._useTexture||(value&&this._texture&&(value.hasMipMaps!=this._texture.hasMipMaps||value.format!=this._texture.format))){this.iInvalidateShaderProgram()}this._useTexture=b;this._texture=value},enumerable:true,configurable:true});BasicSpecularMethod.prototype.copyFrom=function(method){var m=method;var bsm=method;var spec=bsm;this.texture=spec.texture;this.specular=spec.specular;this.specularColor=spec.specularColor;this.gloss=spec.gloss};BasicSpecularMethod.prototype.iCleanCompilationData=function(){_super.prototype.iCleanCompilationData.call(this);this._shadowRegister=null;this._totalLightColorReg=null;this._specularTextureRegister=null;this._specularTexData=null;this._specularDataRegister=null};BasicSpecularMethod.prototype.iGetFragmentPreLightingCode=function(vo,regCache){var code="";this._isFirstLight=true;if(vo.numLights>0){this._specularDataRegister=regCache.getFreeFragmentConstant();vo.fragmentConstantsIndex=this._specularDataRegister.index*4;if(this._useTexture){this._specularTexData=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(this._specularTexData,1);this._specularTextureRegister=regCache.getFreeTextureReg();vo.texturesIndex=this._specularTextureRegister.index;code=this.pGetTex2DSampleCode(vo,this._specularTexData,this._specularTextureRegister,this._texture)}else{this._specularTextureRegister=null}this._totalLightColorReg=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(this._totalLightColorReg,1)}return code};BasicSpecularMethod.prototype.iGetFragmentCodePerLight=function(vo,lightDirReg,lightColReg,regCache){var code="";var t;if(this._isFirstLight){t=this._totalLightColorReg}else{t=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(t,1)}var viewDirReg=this._sharedRegisters.viewDirFragment;var normalReg=this._sharedRegisters.normalFragment;code+="add "+t.toString()+", "+lightDirReg.toString()+", "+viewDirReg.toString()+"\nnrm "+t.toString()+".xyz, "+t.toString()+"\ndp3 "+t.toString()+".w, "+normalReg.toString()+", "+t.toString()+"\nsat "+t.toString()+".w, "+t.toString()+".w\n";if(this._useTexture){code+="mul "+this._specularTexData.toString()+".w, "+this._specularTexData.toString()+".y, "+this._specularDataRegister.toString()+".w\npow "+t+".w, "+t+".w, "+this._specularTexData.toString()+".w\n"}else{code+="pow "+t.toString()+".w, "+t.toString()+".w, "+this._specularDataRegister.toString()+".w\n"}if(vo.useLightFallOff){code+="mul "+t.toString()+".w, "+t.toString()+".w, "+lightDirReg.toString()+".w\n"}if(this._iModulateMethod!=null){code+=this._iModulateMethod(vo,t,regCache,this._sharedRegisters)}code+="mul "+t.toString()+".xyz, "+lightColReg.toString()+", "+t.toString()+".w\n";if(!this._isFirstLight){code+="add "+this._totalLightColorReg.toString()+".xyz, "+this._totalLightColorReg.toString()+", "+t.toString()+"\n";regCache.removeFragmentTempUsage(t)}this._isFirstLight=false;return code};BasicSpecularMethod.prototype.iGetFragmentCodePerProbe=function(vo,cubeMapReg,weightRegister,regCache){var code="";var t;if(this._isFirstLight){t=this._totalLightColorReg}else{t=regCache.getFreeFragmentVectorTemp();regCache.addFragmentTempUsages(t,1)}var normalReg=this._sharedRegisters.normalFragment;var viewDirReg=this._sharedRegisters.viewDirFragment;code+="dp3 "+t.toString()+".w, "+normalReg.toString()+", "+viewDirReg.toString()+"\nadd "+t.toString()+".w, "+t.toString()+".w, "+t.toString()+".w\nmul "+t.toString()+", "+t.toString()+".w, "+normalReg.toString()+"\nsub "+t.toString()+", "+t.toString()+", "+viewDirReg.toString()+"\ntex "+t.toString()+", "+t.toString()+", "+cubeMapReg.toString()+" <cube,"+(vo.useSmoothTextures?"linear":"nearest")+",miplinear>\nmul "+t.toString()+".xyz, "+t.toString()+", "+weightRegister.toString()+"\n";if(this._iModulateMethod!=null){code+=this._iModulateMethod(vo,t,regCache,this._sharedRegisters)}if(!this._isFirstLight){code+="add "+this._totalLightColorReg.toString()+".xyz, "+this._totalLightColorReg.toString()+", "+t.toString()+"\n";regCache.removeFragmentTempUsage(t)}this._isFirstLight=false;return code};BasicSpecularMethod.prototype.iGetFragmentPostLightingCode=function(vo,regCache,targetReg){var code="";if(vo.numLights==0){return code}if(this._shadowRegister){code+="mul "+this._totalLightColorReg.toString()+".xyz, "+this._totalLightColorReg.toString()+", "+this._shadowRegister.toString()+".w\n"}if(this._useTexture){code+="mul "+this._totalLightColorReg.toString()+".xyz, "+this._totalLightColorReg.toString()+", "+this._specularTexData.toString()+".x\n";regCache.removeFragmentTempUsage(this._specularTexData)}code+="mul "+this._totalLightColorReg.toString()+".xyz, "+this._totalLightColorReg.toString()+", "+this._specularDataRegister.toString()+"\nadd "+targetReg.toString()+".xyz, "+targetReg.toString()+", "+this._totalLightColorReg.toString()+"\n";regCache.removeFragmentTempUsage(this._totalLightColorReg);return code};BasicSpecularMethod.prototype.iActivate=function(vo,stage3DProxy){if(vo.numLights==0){return}if(this._useTexture){stage3DProxy._iContext3D.setTextureAt(vo.texturesIndex,this._texture.getTextureForStage3D(stage3DProxy))}var index=vo.fragmentConstantsIndex;var data=vo.fragmentData;data[index]=this._iSpecularR;data[index+1]=this._iSpecularG;data[index+2]=this._iSpecularB;data[index+3]=this._gloss};BasicSpecularMethod.prototype.updateSpecular=function(){this._iSpecularR=((this._specularColor>>16)&255)/255*this._specular;this._iSpecularG=((this._specularColor>>8)&255)/255*this._specular;this._iSpecularB=(this._specularColor&255)/255*this._specular};Object.defineProperty(BasicSpecularMethod.prototype,"iShadowRegister",{set:function(shadowReg){this._shadowRegister=shadowReg},enumerable:true,configurable:true});return BasicSpecularMethod})(away.materials.LightingMethodBase);materials.BasicSpecularMethod=BasicSpecularMethod})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ColorTransformMethod=(function(_super){__extends(ColorTransformMethod,_super);function ColorTransformMethod(){_super.call(this)}Object.defineProperty(ColorTransformMethod.prototype,"colorTransform",{get:function(){return this._colorTransform},set:function(value){this._colorTransform=value},enumerable:true,configurable:true});ColorTransformMethod.prototype.iGetFragmentCode=function(vo,regCache,targetReg){var code="";var colorMultReg=regCache.getFreeFragmentConstant();var colorOffsReg=regCache.getFreeFragmentConstant();vo.fragmentConstantsIndex=colorMultReg.index*4;code+="mul "+targetReg.toString()+", "+targetReg.toString()+", "+colorMultReg.toString()+"\nadd "+targetReg.toString()+", "+targetReg.toString()+", "+colorOffsReg.toString()+"\n";return code};ColorTransformMethod.prototype.iActivate=function(vo,stage3DProxy){var inv=1/255;var index=vo.fragmentConstantsIndex;var data=vo.fragmentData;data[index]=this._colorTransform.redMultiplier;data[index+1]=this._colorTransform.greenMultiplier;data[index+2]=this._colorTransform.blueMultiplier;data[index+3]=this._colorTransform.alphaMultiplier;data[index+4]=this._colorTransform.redOffset*inv;data[index+5]=this._colorTransform.greenOffset*inv;data[index+6]=this._colorTransform.blueOffset*inv;data[index+7]=this._colorTransform.alphaOffset*inv};return ColorTransformMethod})(away.materials.EffectMethodBase);materials.ColorTransformMethod=ColorTransformMethod})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var ColorMaterial=(function(_super){__extends(ColorMaterial,_super);function ColorMaterial(color,alpha){if(typeof color==="undefined"){color=13421772}if(typeof alpha==="undefined"){alpha=1}_super.call(this);this._diffuseAlpha=1;this.color=color;this.alpha=alpha}Object.defineProperty(ColorMaterial.prototype,"alpha",{get:function(){return this._pScreenPass.diffuseMethod.diffuseAlpha},set:function(value){if(value>1){value=1}else{if(value<0){value=0}}this._pScreenPass.diffuseMethod.diffuseAlpha=this._diffuseAlpha=value;this._pScreenPass.preserveAlpha=this.requiresBlending;this._pScreenPass.setBlendMode(this.getBlendMode()==away.display.BlendMode.NORMAL&&this.requiresBlending?away.display.BlendMode.LAYER:this.getBlendMode())},enumerable:true,configurable:true});Object.defineProperty(ColorMaterial.prototype,"color",{get:function(){return this._pScreenPass.diffuseMethod.diffuseColor},set:function(value){this._pScreenPass.diffuseMethod.diffuseColor=value},enumerable:true,configurable:true});Object.defineProperty(ColorMaterial.prototype,"requiresBlending",{get:function(){return _super.prototype.getRequiresBlending.call(this)||this._diffuseAlpha<1},enumerable:true,configurable:true});return ColorMaterial})(away.materials.SinglePassMaterialBase);materials.ColorMaterial=ColorMaterial})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var DefaultMaterialManager=(function(){function DefaultMaterialManager(){}DefaultMaterialManager.getDefaultMaterial=function(renderable){if(typeof renderable==="undefined"){renderable=null}if(!DefaultMaterialManager._defaultTexture){DefaultMaterialManager.createDefaultTexture()}if(!DefaultMaterialManager._defaultMaterial){DefaultMaterialManager.createDefaultMaterial()}return DefaultMaterialManager._defaultMaterial};DefaultMaterialManager.getDefaultTexture=function(renderable){if(typeof renderable==="undefined"){renderable=null}if(!DefaultMaterialManager._defaultTexture){DefaultMaterialManager.createDefaultTexture()}return DefaultMaterialManager._defaultTexture};DefaultMaterialManager.createDefaultTexture=function(){DefaultMaterialManager._defaultTextureBitmapData=new away.display.BitmapData(8,8,false,0);var i,j;for(i=0;i<8;i++){for(j=0;j<8;j++){if((j&1)^(i&1)){DefaultMaterialManager._defaultTextureBitmapData.setPixel(i,j,16777215)}}}DefaultMaterialManager._defaultTexture=new away.textures.BitmapTexture(DefaultMaterialManager._defaultTextureBitmapData,false);DefaultMaterialManager._defaultTexture.name="defaultTexture"};DefaultMaterialManager.createDefaultMaterial=function(){DefaultMaterialManager._defaultMaterial=new away.materials.TextureMaterial(DefaultMaterialManager._defaultTexture);DefaultMaterialManager._defaultMaterial.mipmap=false;DefaultMaterialManager._defaultMaterial.smooth=false;DefaultMaterialManager._defaultMaterial.name="defaultMaterial"};return DefaultMaterialManager})();materials.DefaultMaterialManager=DefaultMaterialManager})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var LightingShaderCompiler=(function(_super){__extends(LightingShaderCompiler,_super);function LightingShaderCompiler(profile){_super.call(this,profile)}Object.defineProperty(LightingShaderCompiler.prototype,"lightVertexConstantIndex",{get:function(){return this._lightVertexConstantIndex},enumerable:true,configurable:true});LightingShaderCompiler.prototype.pInitRegisterIndices=function(){_super.prototype.pInitRegisterIndices.call(this);this._lightVertexConstantIndex=-1};LightingShaderCompiler.prototype.pCreateNormalRegisters=function(){if(this.tangentSpace){this._pSharedRegisters.animatedTangent=this._pRegisterCache.getFreeVertexVectorTemp();this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.animatedTangent,1);this._pSharedRegisters.bitangent=this._pRegisterCache.getFreeVertexVectorTemp();this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.bitangent,1);this._pSharedRegisters.tangentInput=this._pRegisterCache.getFreeVertexAttribute();this._pTangentBufferIndex=this._pSharedRegisters.tangentInput.index;this._pAnimatableAttributes.push(this._pSharedRegisters.tangentInput.toString());this._pAnimationTargetRegisters.push(this._pSharedRegisters.animatedTangent.toString())}this._pSharedRegisters.normalInput=this._pRegisterCache.getFreeVertexAttribute();this._pNormalBufferIndex=this._pSharedRegisters.normalInput.index;this._pSharedRegisters.animatedNormal=this._pRegisterCache.getFreeVertexVectorTemp();this._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.animatedNormal,1);this._pAnimatableAttributes.push(this._pSharedRegisters.normalInput.toString());this._pAnimationTargetRegisters.push(this._pSharedRegisters.animatedNormal.toString())};Object.defineProperty(LightingShaderCompiler.prototype,"tangentSpace",{get:function(){return this._pNumLightProbes==0&&this._pMethodSetup._iNormalMethod.iHasOutput&&this._pMethodSetup._iNormalMethod.iTangentSpace},enumerable:true,configurable:true});LightingShaderCompiler.prototype.pInitLightData=function(){_super.prototype.pInitLightData.call(this);this._pointLightVertexConstants=new Array(this._pNumPointLights);this._pointLightFragmentConstants=new Array(this._pNumPointLights*2);if(this.tangentSpace){this._dirLightVertexConstants=new Array(this._pNumDirectionalLights);this._dirLightFragmentConstants=new Array(this._pNumDirectionalLights*2)}else{this._dirLightFragmentConstants=new Array(this._pNumDirectionalLights*3)}};LightingShaderCompiler.prototype.pCalculateDependencies=function(){_super.prototype.pCalculateDependencies.call(this);if(!this.tangentSpace){this._pDependencyCounter.addWorldSpaceDependencies(false)}};LightingShaderCompiler.prototype.pCompileNormalCode=function(){this._pSharedRegisters.normalFragment=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.normalFragment,this._pDependencyCounter.normalDependencies);if(this._pMethodSetup._iNormalMethod.iHasOutput&&!this._pMethodSetup._iNormalMethod.iTangentSpace){this._pVertexCode+=this._pMethodSetup._iNormalMethod.iGetVertexCode(this._pMethodSetup._iNormalMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iNormalMethod.iGetFragmentCode(this._pMethodSetup._iNormalMethodVO,this._pRegisterCache,this._pSharedRegisters.normalFragment);return}if(this.tangentSpace){this.compileTangentSpaceNormalMapCode()}else{var normalMatrix=new Array(3);normalMatrix[0]=this._pRegisterCache.getFreeVertexConstant();normalMatrix[1]=this._pRegisterCache.getFreeVertexConstant();normalMatrix[2]=this._pRegisterCache.getFreeVertexConstant();this._pRegisterCache.getFreeVertexConstant();this._pSceneNormalMatrixIndex=normalMatrix[0].index*4;this._pSharedRegisters.normalVarying=this._pRegisterCache.getFreeVarying();this._pVertexCode+="m33 "+this._pSharedRegisters.normalVarying+".xyz, "+this._pSharedRegisters.animatedNormal+", "+normalMatrix[0]+"\nmov "+this._pSharedRegisters.normalVarying+".w, "+this._pSharedRegisters.animatedNormal+".w	\n";this._pFragmentCode+="nrm "+this._pSharedRegisters.normalFragment+".xyz, "+this._pSharedRegisters.normalVarying+"\nmov "+this._pSharedRegisters.normalFragment+".w, "+this._pSharedRegisters.normalVarying+".w		\n"}if(this._pDependencyCounter.tangentDependencies>0){this._pSharedRegisters.tangentInput=this._pRegisterCache.getFreeVertexAttribute();this._pTangentBufferIndex=this._pSharedRegisters.tangentInput.index;this._pSharedRegisters.tangentVarying=this._pRegisterCache.getFreeVarying()}};LightingShaderCompiler.prototype.compileTangentSpaceNormalMapCode=function(){this._pVertexCode+="nrm "+this._pSharedRegisters.animatedNormal+".xyz, "+this._pSharedRegisters.animatedNormal+"\nnrm "+this._pSharedRegisters.animatedTangent+".xyz, "+this._pSharedRegisters.animatedTangent+"\n";this._pVertexCode+="crs "+this._pSharedRegisters.bitangent+".xyz, "+this._pSharedRegisters.animatedNormal+", "+this._pSharedRegisters.animatedTangent+"\n";this._pFragmentCode+=this._pMethodSetup._iNormalMethod.iGetFragmentCode(this._pMethodSetup._iNormalMethodVO,this._pRegisterCache,this._pSharedRegisters.normalFragment);if(this._pMethodSetup._iNormalMethodVO.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}if(this._pMethodSetup._iNormalMethodVO.needsGlobalFragmentPos||this._pMethodSetup._iNormalMethodVO.needsGlobalVertexPos){this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.globalPositionVertex)}};LightingShaderCompiler.prototype.pCompileViewDirCode=function(){var cameraPositionReg=this._pRegisterCache.getFreeVertexConstant();this._pSharedRegisters.viewDirVarying=this._pRegisterCache.getFreeVarying();this._pSharedRegisters.viewDirFragment=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.viewDirFragment,this._pDependencyCounter.viewDirDependencies);this._pCameraPositionIndex=cameraPositionReg.index*4;if(this.tangentSpace){var temp=this._pRegisterCache.getFreeVertexVectorTemp();this._pVertexCode+="sub "+temp+", "+cameraPositionReg+", "+this._pSharedRegisters.localPosition+"\nm33 "+this._pSharedRegisters.viewDirVarying+".xyz, "+temp+", "+this._pSharedRegisters.animatedTangent+"\nmov "+this._pSharedRegisters.viewDirVarying+".w, "+this._pSharedRegisters.localPosition+".w\n"}else{this._pVertexCode+="sub "+this._pSharedRegisters.viewDirVarying+", "+cameraPositionReg+", "+this._pSharedRegisters.globalPositionVertex+"\n";this._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.globalPositionVertex)}this._pFragmentCode+="nrm "+this._pSharedRegisters.viewDirFragment+".xyz, "+this._pSharedRegisters.viewDirVarying+"\nmov "+this._pSharedRegisters.viewDirFragment+".w,   "+this._pSharedRegisters.viewDirVarying+".w 		\n"};LightingShaderCompiler.prototype.pCompileLightingCode=function(){if(this._pMethodSetup._iShadowMethod){this.compileShadowCode()}this._pMethodSetup._iDiffuseMethod.iShadowRegister=this._shadowRegister;this._pSharedRegisters.shadedTarget=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.shadedTarget,1);this._pVertexCode+=this._pMethodSetup._iDiffuseMethod.iGetVertexCode(this._pMethodSetup._iDiffuseMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentPreLightingCode(this._pMethodSetup._iDiffuseMethodVO,this._pRegisterCache);if(this._usingSpecularMethod){this._pVertexCode+=this._pMethodSetup._iSpecularMethod.iGetVertexCode(this._pMethodSetup._iSpecularMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentPreLightingCode(this._pMethodSetup._iSpecularMethodVO,this._pRegisterCache)}if(this.pUsesLights()){this.initLightRegisters();this.compileDirectionalLightCode();this.compilePointLightCode()}if(this.pUsesProbes()){this.compileLightProbeCode()}this._pVertexCode+=this._pMethodSetup._iAmbientMethod.iGetVertexCode(this._pMethodSetup._iAmbientMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iAmbientMethod.iGetFragmentCode(this._pMethodSetup._iAmbientMethodVO,this._pRegisterCache,this._pSharedRegisters.shadedTarget);if(this._pMethodSetup._iAmbientMethodVO.needsNormals){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.normalFragment)}if(this._pMethodSetup._iAmbientMethodVO.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentPostLightingCode(this._pMethodSetup._iDiffuseMethodVO,this._pRegisterCache,this._pSharedRegisters.shadedTarget);if(this._pAlphaPremultiplied){this._pFragmentCode+="add "+this._pSharedRegisters.shadedTarget+".w, "+this._pSharedRegisters.shadedTarget+".w, "+this._pSharedRegisters.commons+".z\ndiv "+this._pSharedRegisters.shadedTarget+".xyz, "+this._pSharedRegisters.shadedTarget+", "+this._pSharedRegisters.shadedTarget+".w\nsub "+this._pSharedRegisters.shadedTarget+".w, "+this._pSharedRegisters.shadedTarget+".w, "+this._pSharedRegisters.commons+".z\nsat "+this._pSharedRegisters.shadedTarget+".xyz, "+this._pSharedRegisters.shadedTarget+"\n"}if(this._pMethodSetup._iDiffuseMethodVO.needsNormals){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.normalFragment)}if(this._pMethodSetup._iDiffuseMethodVO.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}if(this._usingSpecularMethod){this._pMethodSetup._iSpecularMethod.iShadowRegister=this._shadowRegister;this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentPostLightingCode(this._pMethodSetup._iSpecularMethodVO,this._pRegisterCache,this._pSharedRegisters.shadedTarget);if(this._pMethodSetup._iSpecularMethodVO.needsNormals){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.normalFragment)}if(this._pMethodSetup._iSpecularMethodVO.needsView){this._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.viewDirFragment)}}if(this._pMethodSetup._iShadowMethod){this._pRegisterCache.removeFragmentTempUsage(this._shadowRegister)}};LightingShaderCompiler.prototype.compileShadowCode=function(){if(this._pSharedRegisters.normalFragment){this._shadowRegister=this._pSharedRegisters.normalFragment}else{this._shadowRegister=this._pRegisterCache.getFreeFragmentVectorTemp()}this._pRegisterCache.addFragmentTempUsages(this._shadowRegister,1);this._pVertexCode+=this._pMethodSetup._iShadowMethod.iGetVertexCode(this._pMethodSetup._iShadowMethodVO,this._pRegisterCache);this._pFragmentCode+=this._pMethodSetup._iShadowMethod.iGetFragmentCode(this._pMethodSetup._iShadowMethodVO,this._pRegisterCache,this._shadowRegister)};LightingShaderCompiler.prototype.initLightRegisters=function(){var i,len;if(this._dirLightVertexConstants){len=this._dirLightVertexConstants.length;for(i=0;i<len;++i){this._dirLightVertexConstants[i]=this._pRegisterCache.getFreeVertexConstant();if(this._lightVertexConstantIndex==-1){this._lightVertexConstantIndex=this._dirLightVertexConstants[i].index*4}}}len=this._pointLightVertexConstants.length;for(i=0;i<len;++i){this._pointLightVertexConstants[i]=this._pRegisterCache.getFreeVertexConstant();if(this._lightVertexConstantIndex==-1){this._lightVertexConstantIndex=this._pointLightVertexConstants[i].index*4}}len=this._dirLightFragmentConstants.length;for(i=0;i<len;++i){this._dirLightFragmentConstants[i]=this._pRegisterCache.getFreeFragmentConstant();if(this._pLightFragmentConstantIndex==-1){this._pLightFragmentConstantIndex=this._dirLightFragmentConstants[i].index*4}}len=this._pointLightFragmentConstants.length;for(i=0;i<len;++i){this._pointLightFragmentConstants[i]=this._pRegisterCache.getFreeFragmentConstant();if(this._pLightFragmentConstantIndex==-1){this._pLightFragmentConstantIndex=this._pointLightFragmentConstants[i].index*4}}};LightingShaderCompiler.prototype.compileDirectionalLightCode=function(){var diffuseColorReg;var specularColorReg;var lightDirReg;var vertexRegIndex=0;var fragmentRegIndex=0;var addSpec=this._usingSpecularMethod&&this.pUsesLightsForSpecular();var addDiff=this.pUsesLightsForDiffuse();if(!(addSpec||addDiff)){return}for(var i=0;i<this._pNumDirectionalLights;++i){if(this.tangentSpace){lightDirReg=this._dirLightVertexConstants[vertexRegIndex++];var lightVarying=this._pRegisterCache.getFreeVarying();this._pVertexCode+="m33 "+lightVarying+".xyz, "+lightDirReg+", "+this._pSharedRegisters.animatedTangent+"\nmov "+lightVarying+".w, "+lightDirReg+".w\n";lightDirReg=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addVertexTempUsages(lightDirReg,1);this._pFragmentCode+="nrm "+lightDirReg+".xyz, "+lightVarying+"\n";this._pFragmentCode+="mov "+lightDirReg+".w, "+lightVarying+".w\n"}else{lightDirReg=this._dirLightFragmentConstants[fragmentRegIndex++]}diffuseColorReg=this._dirLightFragmentConstants[fragmentRegIndex++];specularColorReg=this._dirLightFragmentConstants[fragmentRegIndex++];if(addDiff){this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentCodePerLight(this._pMethodSetup._iDiffuseMethodVO,lightDirReg,diffuseColorReg,this._pRegisterCache)}if(addSpec){this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentCodePerLight(this._pMethodSetup._iSpecularMethodVO,lightDirReg,specularColorReg,this._pRegisterCache)}if(this.tangentSpace){this._pRegisterCache.removeVertexTempUsage(lightDirReg)}}};LightingShaderCompiler.prototype.compilePointLightCode=function(){var diffuseColorReg;var specularColorReg;var lightPosReg;var lightDirReg;var vertexRegIndex=0;var fragmentRegIndex=0;var addSpec=this._usingSpecularMethod&&this.pUsesLightsForSpecular();var addDiff=this.pUsesLightsForDiffuse();if(!(addSpec||addDiff)){return}for(var i=0;i<this._pNumPointLights;++i){lightPosReg=this._pointLightVertexConstants[vertexRegIndex++];diffuseColorReg=this._pointLightFragmentConstants[fragmentRegIndex++];specularColorReg=this._pointLightFragmentConstants[fragmentRegIndex++];lightDirReg=this._pRegisterCache.getFreeFragmentVectorTemp();this._pRegisterCache.addFragmentTempUsages(lightDirReg,1);var lightVarying=this._pRegisterCache.getFreeVarying();if(this.tangentSpace){var temp=this._pRegisterCache.getFreeVertexVectorTemp();this._pVertexCode+="sub "+temp+", "+lightPosReg+", "+this._pSharedRegisters.localPosition+"\nm33 "+lightVarying+".xyz, "+temp+", "+this._pSharedRegisters.animatedTangent+"\nmov "+lightVarying+".w, "+this._pSharedRegisters.localPosition+".w\n"}else{this._pVertexCode+="sub "+lightVarying+", "+lightPosReg+", "+this._pSharedRegisters.globalPositionVertex+"\n"}if(this._pEnableLightFallOff&&this._pProfile!="baselineConstrained"){this._pFragmentCode+="dp3 "+lightDirReg+".w, "+lightVarying+", "+lightVarying+"\nsub "+lightDirReg+".w, "+lightDirReg+".w, "+diffuseColorReg+".w\nmul "+lightDirReg+".w, "+lightDirReg+".w, "+specularColorReg+".w\nsat "+lightDirReg+".w, "+lightDirReg+".w\nsub "+lightDirReg+".w, "+this._pSharedRegisters.commons+".w, "+lightDirReg+".w\nnrm "+lightDirReg+".xyz, "+lightVarying+"\n"}else{this._pFragmentCode+="nrm "+lightDirReg+".xyz, "+lightVarying+"\nmov "+lightDirReg+".w, "+lightVarying+".w\n"}if(this._pLightFragmentConstantIndex==-1){this._pLightFragmentConstantIndex=lightPosReg.index*4}if(addDiff){this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentCodePerLight(this._pMethodSetup._iDiffuseMethodVO,lightDirReg,diffuseColorReg,this._pRegisterCache)}if(addSpec){this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentCodePerLight(this._pMethodSetup._iSpecularMethodVO,lightDirReg,specularColorReg,this._pRegisterCache)}this._pRegisterCache.removeFragmentTempUsage(lightDirReg)}};LightingShaderCompiler.prototype.compileLightProbeCode=function(){var weightReg;var weightComponents=[".x",".y",".z",".w"];var weightRegisters=new Array();var i;var texReg;var addSpec=this._usingSpecularMethod&&this.pUsesProbesForSpecular();var addDiff=this.pUsesProbesForDiffuse();if(!(addSpec||addDiff)){return}if(addDiff){this._pLightProbeDiffuseIndices=new Array()}if(addSpec){this._pLightProbeSpecularIndices=new Array()}for(i=0;i<this._pNumProbeRegisters;++i){weightRegisters[i]=this._pRegisterCache.getFreeFragmentConstant();if(i==0){this._pProbeWeightsIndex=weightRegisters[i].index*4}}for(i=0;i<this._pNumLightProbes;++i){weightReg=weightRegisters[Math.floor(i/4)].toString()+weightComponents[i%4];if(addDiff){texReg=this._pRegisterCache.getFreeTextureReg();this._pLightProbeDiffuseIndices[i]=texReg.index;this._pFragmentCode+=this._pMethodSetup._iDiffuseMethod.iGetFragmentCodePerProbe(this._pMethodSetup._iDiffuseMethodVO,texReg,weightReg,this._pRegisterCache)}if(addSpec){texReg=this._pRegisterCache.getFreeTextureReg();this._pLightProbeSpecularIndices[i]=texReg.index;this._pFragmentCode+=this._pMethodSetup._iSpecularMethod.iGetFragmentCodePerProbe(this._pMethodSetup._iSpecularMethodVO,texReg,weightReg,this._pRegisterCache)}}};return LightingShaderCompiler})(away.materials.ShaderCompiler);materials.LightingShaderCompiler=LightingShaderCompiler})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var SegmentMaterial=(function(_super){__extends(SegmentMaterial,_super);function SegmentMaterial(thickness){if(typeof thickness==="undefined"){thickness=1.25}_super.call(this);this.bothSides=true;this.pAddPass(this._screenPass=new away.materials.SegmentPass(thickness));this._screenPass.material=this}return SegmentMaterial})(away.materials.MaterialBase);materials.SegmentMaterial=SegmentMaterial})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(materials){var SkyBoxMaterial=(function(_super){__extends(SkyBoxMaterial,_super);function SkyBoxMaterial(cubeMap){_super.call(this);this._cubeMap=cubeMap;this.pAddPass(this._skyboxPass=new away.materials.SkyBoxPass());this._skyboxPass.cubeTexture=this._cubeMap}Object.defineProperty(SkyBoxMaterial.prototype,"cubeMap",{get:function(){return this._cubeMap},set:function(value){if(value&&this._cubeMap&&(value.hasMipMaps!=this._cubeMap.hasMipMaps||value.format!=this._cubeMap.format)){this.iInvalidatePasses(null)}this._cubeMap=value;this._skyboxPass.cubeTexture=this._cubeMap},enumerable:true,configurable:true});return SkyBoxMaterial})(away.materials.MaterialBase);materials.SkyBoxMaterial=SkyBoxMaterial})(away.materials||(away.materials={}));var materials=away.materials})(away||(away={}));var away;(function(away){(function(render){var RenderBase=(function(){function RenderBase(renderToTexture){if(typeof renderToTexture==="undefined"){renderToTexture=false}this._pBackgroundR=0;this._pBackgroundG=0;this._pBackgroundB=0;this._pBackgroundAlpha=1;this._pShareContext=false;this._pTextureRatioX=1;this._pTextureRatioY=1;this._clearOnRender=true;this._pRttViewProjectionMatrix=new away.geom.Matrix3D();this._pRenderableSorter=new away.sort.RenderableMergeSort();this._pRenderToTexture=renderToTexture}RenderBase.prototype.iCreateEntityCollector=function(){return new away.traverse.EntityCollector()};Object.defineProperty(RenderBase.prototype,"iViewWidth",{get:function(){return this._pViewWidth},set:function(value){this._pViewWidth=value},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iViewHeight",{get:function(){return this._pViewHeight},set:function(value){this._pViewHeight=value},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iRenderToTexture",{get:function(){return this._pRenderToTexture},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"renderableSorter",{get:function(){return this._pRenderableSorter},set:function(value){this._pRenderableSorter=value},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iClearOnRender",{get:function(){return this._clearOnRender},set:function(value){this._clearOnRender=value},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iBackgroundR",{get:function(){return this._pBackgroundR},set:function(value){this._pBackgroundR=value},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iBackgroundG",{get:function(){return this._pBackgroundG},set:function(value){this._pBackgroundG=value},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iBackgroundB",{get:function(){return this._pBackgroundB},set:function(value){this._pBackgroundB=value},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iStage3DProxy",{get:function(){return this._pStage3DProxy},set:function(value){if(value==this._pStage3DProxy){return}if(!value){if(this._pStage3DProxy){this._pStage3DProxy.removeEventListener(away.events.Stage3DEvent.CONTEXT3D_CREATED,this.onContextUpdate,this);this._pStage3DProxy.removeEventListener(away.events.Stage3DEvent.CONTEXT3D_RECREATED,this.onContextUpdate,this)}this._pStage3DProxy=null;this._pContext=null;return}this._pStage3DProxy=value;this._pStage3DProxy.addEventListener(away.events.Stage3DEvent.CONTEXT3D_CREATED,this.onContextUpdate,this);this._pStage3DProxy.addEventListener(away.events.Stage3DEvent.CONTEXT3D_RECREATED,this.onContextUpdate,this);if(value.context3D){this._pContext=value.context3D}},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iShareContext",{get:function(){return this._pShareContext},set:function(value){this._pShareContext=value},enumerable:true,configurable:true});RenderBase.prototype.iDispose=function(){this._pStage3DProxy=null};RenderBase.prototype.iRender=function(entityCollector,target,scissorRect,surfaceSelector){if(typeof target==="undefined"){target=null}if(typeof scissorRect==="undefined"){scissorRect=null}if(typeof surfaceSelector==="undefined"){surfaceSelector=0}if(!this._pStage3DProxy||!this._pContext){return}this._pRttViewProjectionMatrix.copyFrom(entityCollector.camera.viewProjection);this._pRttViewProjectionMatrix.appendScale(this._pTextureRatioX,this._pTextureRatioY,1);this.pExecuteRender(entityCollector,target,scissorRect,surfaceSelector);for(var i=0;i<8;++i){this._pContext.setVertexBufferAt(i,null);this._pContext.setTextureAt(i,null)}};RenderBase.prototype.pExecuteRender=function(entityCollector,target,scissorRect,surfaceSelector){if(typeof target==="undefined"){target=null}if(typeof scissorRect==="undefined"){scissorRect=null}if(typeof surfaceSelector==="undefined"){surfaceSelector=0}this._pRenderTarget=target;this._pRenderTargetSurface=surfaceSelector;if(this._pRenderableSorter){this._pRenderableSorter.sort(entityCollector)}if(this._pRenderToTexture){this.pExecuteRenderToTexturePass(entityCollector)}this._pStage3DProxy.setRenderTarget(target,true,surfaceSelector);if((target||!this._pShareContext)&&this._clearOnRender){this._pContext.clear(this._pBackgroundR,this._pBackgroundG,this._pBackgroundB,this._pBackgroundAlpha,1,0)}this._pContext.setDepthTest(false,away.display3D.Context3DCompareMode.ALWAYS);this._pStage3DProxy.scissorRect=scissorRect;this.pDraw(entityCollector,target);this._pContext.setDepthTest(false,away.display3D.Context3DCompareMode.LESS_EQUAL);if(!this._pShareContext){if(this._snapshotRequired&&this._snapshotBitmapData){this._pContext.drawToBitmapData(this._snapshotBitmapData);this._snapshotRequired=false}}this._pStage3DProxy.scissorRect=null};RenderBase.prototype.queueSnapshot=function(bmd){this._snapshotRequired=true;this._snapshotBitmapData=bmd};RenderBase.prototype.pExecuteRenderToTexturePass=function(entityCollector){throw new away.errors.AbstractMethodError()};RenderBase.prototype.pDraw=function(entityCollector,target){throw new away.errors.AbstractMethodError()};RenderBase.prototype.onContextUpdate=function(event){this._pContext=this._pStage3DProxy.context3D};Object.defineProperty(RenderBase.prototype,"iBackgroundAlpha",{get:function(){return this._pBackgroundAlpha},set:function(value){this._pBackgroundAlpha=value},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"iBackground",{get:function(){return this._background},enumerable:true,configurable:true});Object.defineProperty(RenderBase.prototype,"antiAlias",{get:function(){return this._pAntiAlias},enumerable:true,configurable:true});return RenderBase})();render.RenderBase=RenderBase})(away.render||(away.render={}));var render=away.render})(away||(away={}));var away;(function(away){(function(sort){var RenderableMergeSort=(function(){function RenderableMergeSort(){}RenderableMergeSort.prototype.sort=function(collector){collector.opaqueRenderableHead=this.mergeSortByMaterial(collector.opaqueRenderableHead);collector.blendedRenderableHead=this.mergeSortByDepth(collector.blendedRenderableHead)};RenderableMergeSort.prototype.mergeSortByDepth=function(head){var headB;var fast,slow;if(!head||!head.next){return head}slow=head;fast=head.next;while(fast){fast=fast.next;if(fast){slow=slow.next;fast=fast.next}}headB=slow.next;slow.next=null;head=this.mergeSortByDepth(head);headB=this.mergeSortByDepth(headB);var result;var curr;var l;if(!head){return headB}if(!headB){return head}while(head&&headB){if(head.zIndex<headB.zIndex){l=head;head=head.next}else{l=headB;headB=headB.next}if(!result){result=l}else{curr.next=l}curr=l}if(head){curr.next=head}else{if(headB){curr.next=headB}}return result};RenderableMergeSort.prototype.mergeSortByMaterial=function(head){var headB;var fast,slow;if(!head||!head.next){return head}slow=head;fast=head.next;while(fast){fast=fast.next;if(fast){slow=slow.next;fast=fast.next}}headB=slow.next;slow.next=null;head=this.mergeSortByMaterial(head);headB=this.mergeSortByMaterial(headB);var result;var curr;var l;var cmp;if(!head){return headB}if(!headB){return head}while(head&&headB&&head!=null&&headB!=null){var aid=head.renderOrderId;var bid=headB.renderOrderId;if(aid==bid){var ma=head.materialId;var mb=headB.materialId;if(ma==mb){if(head.zIndex<headB.zIndex){cmp=1}else{cmp=-1}}else{if(ma>mb){cmp=1}else{cmp=-1}}}else{if(aid>bid){cmp=1}else{cmp=-1}}if(cmp<0){l=head;head=head.next}else{l=headB;headB=headB.next}if(!result){result=l;curr=l}else{curr.next=l;curr=l}}if(head){curr.next=head}else{if(headB){curr.next=headB}}return result};return RenderableMergeSort})();sort.RenderableMergeSort=RenderableMergeSort})(away.sort||(away.sort={}));var sort=away.sort})(away||(away={}));var away;(function(away){(function(render){var RendererBase=(function(){function RendererBase(renderToTexture){if(typeof renderToTexture==="undefined"){renderToTexture=false}this._backgroundR=0;this._backgroundG=0;this._backgroundB=0;this._backgroundAlpha=1;this._shareContext=false;this._textureRatioX=1;this._textureRatioY=1;this._clearOnRender=true;this._pRttViewProjectionMatrix=new away.geom.Matrix3D();this._pRenderableSorter=new away.sort.RenderableMergeSort();this._renderToTexture=renderToTexture}RendererBase.prototype.iCreateEntityCollector=function(){return new away.traverse.EntityCollector()};Object.defineProperty(RendererBase.prototype,"iViewWidth",{get:function(){return this._viewWidth},set:function(value){this._viewWidth=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iViewHeight",{get:function(){return this._viewHeight},set:function(value){this._viewHeight=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iRenderToTexture",{get:function(){return this._renderToTexture},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"renderableSorter",{get:function(){return this._pRenderableSorter},set:function(value){this._pRenderableSorter=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iClearOnRender",{get:function(){return this._clearOnRender},set:function(value){this._clearOnRender=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iBackgroundR",{get:function(){return this._backgroundR},set:function(value){this._backgroundR=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iBackgroundG",{get:function(){return this._backgroundG},set:function(value){this._backgroundG=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iBackgroundB",{get:function(){return this._backgroundB},set:function(value){this._backgroundB=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iStage3DProxy",{get:function(){return this._pStage3DProxy},set:function(value){this.iSetStage3DProxy(value)},enumerable:true,configurable:true});RendererBase.prototype.iSetStage3DProxy=function(value){if(value==this._pStage3DProxy){return}if(!value){if(this._pStage3DProxy){this._pStage3DProxy.removeEventListener(away.events.Stage3DEvent.CONTEXT3D_CREATED,this.onContextUpdate,this);this._pStage3DProxy.removeEventListener(away.events.Stage3DEvent.CONTEXT3D_RECREATED,this.onContextUpdate,this)}this._pStage3DProxy=null;this._pContext=null;return}this._pStage3DProxy=value;this._pStage3DProxy.addEventListener(away.events.Stage3DEvent.CONTEXT3D_CREATED,this.onContextUpdate,this);this._pStage3DProxy.addEventListener(away.events.Stage3DEvent.CONTEXT3D_RECREATED,this.onContextUpdate,this);if(value.context3D){this._pContext=value.context3D}};Object.defineProperty(RendererBase.prototype,"iShareContext",{get:function(){return this._shareContext},set:function(value){this._shareContext=value},enumerable:true,configurable:true});RendererBase.prototype.iDispose=function(){this._pStage3DProxy=null};RendererBase.prototype.iRender=function(entityCollector,target,scissorRect,surfaceSelector){if(typeof target==="undefined"){target=null}if(typeof scissorRect==="undefined"){scissorRect=null}if(typeof surfaceSelector==="undefined"){surfaceSelector=0}if(!this._pStage3DProxy||!this._pContext){return}this._pRttViewProjectionMatrix.copyFrom(entityCollector.camera.viewProjection);this._pRttViewProjectionMatrix.appendScale(this._textureRatioX,this._textureRatioY,1);this.pExecuteRender(entityCollector,target,scissorRect,surfaceSelector);for(var i=0;i<8;++i){this._pContext.setVertexBufferAt(i,null);this._pContext.setTextureAt(i,null)}};RendererBase.prototype.pExecuteRender=function(entityCollector,target,scissorRect,surfaceSelector){if(typeof target==="undefined"){target=null}if(typeof scissorRect==="undefined"){scissorRect=null}if(typeof surfaceSelector==="undefined"){surfaceSelector=0}this._pRenderTarget=target;this._pRenderTargetSurface=surfaceSelector;if(this._pRenderableSorter){this._pRenderableSorter.sort(entityCollector)}if(this._renderToTexture){this.pExecuteRenderToTexturePass(entityCollector)}this._pStage3DProxy.setRenderTarget(target,true,surfaceSelector);if((target||!this._shareContext)&&this._clearOnRender){this._pContext.clear(this._backgroundR,this._backgroundG,this._backgroundB,this._backgroundAlpha,1,0)}this._pContext.setDepthTest(false,away.display3D.Context3DCompareMode.ALWAYS);this._pStage3DProxy.scissorRect=scissorRect;this.pDraw(entityCollector,target);this._pContext.setDepthTest(false,away.display3D.Context3DCompareMode.LESS_EQUAL);if(!this._shareContext){if(this._snapshotRequired&&this._snapshotBitmapData){this._pContext.drawToBitmapData(this._snapshotBitmapData);this._snapshotRequired=false}}this._pStage3DProxy.scissorRect=null};RendererBase.prototype.queueSnapshot=function(bmd){this._snapshotRequired=true;this._snapshotBitmapData=bmd};RendererBase.prototype.pExecuteRenderToTexturePass=function(entityCollector){throw new away.errors.AbstractMethodError()};RendererBase.prototype.pDraw=function(entityCollector,target){throw new away.errors.AbstractMethodError()};RendererBase.prototype.onContextUpdate=function(event){this._pContext=this._pStage3DProxy.context3D};Object.defineProperty(RendererBase.prototype,"iBackgroundAlpha",{get:function(){return this._backgroundAlpha},set:function(value){this._backgroundAlpha=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"antiAlias",{get:function(){return this._antiAlias},set:function(antiAlias){this._antiAlias=antiAlias},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iTextureRatioX",{get:function(){return this._textureRatioX},set:function(value){this._textureRatioX=value},enumerable:true,configurable:true});Object.defineProperty(RendererBase.prototype,"iTextureRatioY",{get:function(){return this._textureRatioY},set:function(value){this._textureRatioY=value},enumerable:true,configurable:true});return RendererBase})();render.RendererBase=RendererBase})(away.render||(away.render={}));var render=away.render})(away||(away={}));var away;(function(away){(function(render){var DepthRenderer=(function(_super){__extends(DepthRenderer,_super);function DepthRenderer(renderBlended,distanceBased){if(typeof renderBlended==="undefined"){renderBlended=false}if(typeof distanceBased==="undefined"){distanceBased=false}_super.call(this);this._renderBlended=renderBlended;this._distanceBased=distanceBased;this.iBackgroundR=1;this.iBackgroundG=1;this.iBackgroundB=1}Object.defineProperty(DepthRenderer.prototype,"disableColor",{get:function(){return this._disableColor},set:function(value){this._disableColor=value},enumerable:true,configurable:true});Object.defineProperty(DepthRenderer.prototype,"iBackgroundR",{set:function(value){},enumerable:true,configurable:true});Object.defineProperty(DepthRenderer.prototype,"iBackgroundG",{set:function(value){},enumerable:true,configurable:true});Object.defineProperty(DepthRenderer.prototype,"iBackgroundB",{set:function(value){},enumerable:true,configurable:true});DepthRenderer.prototype.iRenderCascades=function(entityCollector,target,numCascades,scissorRects,cameras){this._pRenderTarget=target;this._pRenderTargetSurface=0;this._pRenderableSorter.sort(entityCollector);this._pStage3DProxy.setRenderTarget(target,true,0);this._pContext.clear(1,1,1,1,1,0);this._pContext.setBlendFactors(away.display3D.Context3DBlendFactor.ONE,away.display3D.Context3DBlendFactor.ZERO);this._pContext.setDepthTest(true,away.display3D.Context3DCompareMode.LESS);var head=entityCollector.opaqueRenderableHead;var first=true;for(var i=numCascades-1;i>=0;--i){this._pStage3DProxy.scissorRect=scissorRects[i];this.drawCascadeRenderables(head,cameras[i],first?null:cameras[i].frustumPlanes);first=false}if(this._activeMaterial){this._activeMaterial.iDeactivateForDepth(this._pStage3DProxy)}this._activeMaterial=null;this._pContext.setDepthTest(false,away.display3D.Context3DCompareMode.LESS_EQUAL);this._pStage3DProxy.scissorRect=null};DepthRenderer.prototype.drawCascadeRenderables=function(item,camera,cullPlanes){var material;while(item){if(item.cascaded){item=item.next;continue}var renderable=item.renderable;var entity=renderable.sourceEntity;if(!cullPlanes||entity.worldBounds.isInFrustum(cullPlanes,4)){material=renderable.material;if(this._activeMaterial!=material){if(this._activeMaterial){this._activeMaterial.iDeactivateForDepth(this._pStage3DProxy)}this._activeMaterial=material;this._activeMaterial.iActivateForDepth(this._pStage3DProxy,camera,false)}this._activeMaterial.iRenderDepth(renderable,this._pStage3DProxy,camera,camera.viewProjection)}else{item.cascaded=true}item=item.next}};DepthRenderer.prototype.pDraw=function(entityCollector,target){this._pContext.setBlendFactors(away.display3D.Context3DBlendFactor.ONE,away.display3D.Context3DBlendFactor.ZERO);this._pContext.setDepthTest(true,away.display3D.Context3DCompareMode.LESS);this.drawRenderables(entityCollector.opaqueRenderableHead,entityCollector);if(this._disableColor){this._pContext.setColorMask(false,false,false,false)}if(this._renderBlended){this.drawRenderables(entityCollector.blendedRenderableHead,entityCollector)}if(this._activeMaterial){this._activeMaterial.iDeactivateForDepth(this._pStage3DProxy)}if(this._disableColor){this._pContext.setColorMask(true,true,true,true)}this._activeMaterial=null};DepthRenderer.prototype.drawRenderables=function(item,entityCollector){var camera=entityCollector.camera;var item2;while(item){this._activeMaterial=item.renderable.material;if(this._disableColor&&this._activeMaterial.iHasDepthAlphaThreshold()){item2=item;do{item2=item2.next}while(item2&&item2.renderable.material==this._activeMaterial)}else{this._activeMaterial.iActivateForDepth(this._pStage3DProxy,camera,this._distanceBased);item2=item;do{this._activeMaterial.iRenderDepth(item2.renderable,this._pStage3DProxy,camera,this._pRttViewProjectionMatrix);item2=item2.next}while(item2&&item2.renderable.material==this._activeMaterial);this._activeMaterial.iDeactivateForDepth(this._pStage3DProxy)}item=item2}};return DepthRenderer})(away.render.RendererBase);render.DepthRenderer=DepthRenderer})(away.render||(away.render={}));var render=away.render})(away||(away={}));var away;(function(away){(function(render){var DefaultRenderer=(function(_super){__extends(DefaultRenderer,_super);function DefaultRenderer(){_super.call(this);this._skyboxProjection=new away.geom.Matrix3D();this._pDepthRenderer=new away.render.DepthRenderer();this._pDistanceRenderer=new away.render.DepthRenderer(false,true)}Object.defineProperty(DefaultRenderer.prototype,"iStage3DProxy",{set:function(value){_super.prototype.iSetStage3DProxy.call(this,value);this._pDistanceRenderer.iStage3DProxy=this._pDepthRenderer.iStage3DProxy=value},enumerable:true,configurable:true});DefaultRenderer.prototype.pExecuteRender=function(entityCollector,target,scissorRect,surfaceSelector){if(typeof target==="undefined"){target=null}if(typeof scissorRect==="undefined"){scissorRect=null}if(typeof surfaceSelector==="undefined"){surfaceSelector=0}this.updateLights(entityCollector);if(target){this.drawRenderables(entityCollector.opaqueRenderableHead,entityCollector,DefaultRenderer.RTT_PASSES);this.drawRenderables(entityCollector.blendedRenderableHead,entityCollector,DefaultRenderer.RTT_PASSES)}_super.prototype.pExecuteRender.call(this,entityCollector,target,scissorRect,surfaceSelector)};DefaultRenderer.prototype.updateLights=function(entityCollector){var dirLights=entityCollector.directionalLights;var pointLights=entityCollector.pointLights;var len,i;var light;var shadowMapper;len=dirLights.length;for(i=0;i<len;++i){light=dirLights[i];shadowMapper=light.shadowMapper;if(light.castsShadows&&(shadowMapper.autoUpdateShadows||shadowMapper._iShadowsInvalid)){shadowMapper.iRenderDepthMap(this._pStage3DProxy,entityCollector,this._pDepthRenderer)}}len=pointLights.length;for(i=0;i<len;++i){light=pointLights[i];shadowMapper=light.shadowMapper;if(light.castsShadows&&(shadowMapper.autoUpdateShadows||shadowMapper._iShadowsInvalid)){shadowMapper.iRenderDepthMap(this._pStage3DProxy,entityCollector,this._pDistanceRenderer)}}};DefaultRenderer.prototype.pDraw=function(entityCollector,target){this._pContext.setBlendFactors(away.display3D.Context3DBlendFactor.ONE,away.display3D.Context3DBlendFactor.ZERO);if(entityCollector.skyBox){if(this._activeMaterial){this._activeMaterial.iDeactivate(this._pStage3DProxy)}this._activeMaterial=null;this._pContext.setDepthTest(false,away.display3D.Context3DCompareMode.ALWAYS);this.drawSkyBox(entityCollector)}this._pContext.setDepthTest(true,away.display3D.Context3DCompareMode.LESS_EQUAL);var which=target?DefaultRenderer.SCREEN_PASSES:DefaultRenderer.ALL_PASSES;this.drawRenderables(entityCollector.opaqueRenderableHead,entityCollector,which);this.drawRenderables(entityCollector.blendedRenderableHead,entityCollector,which);this._pContext.setDepthTest(false,away.display3D.Context3DCompareMode.LESS_EQUAL);if(this._activeMaterial){this._activeMaterial.iDeactivate(this._pStage3DProxy)}this._activeMaterial=null};DefaultRenderer.prototype.drawSkyBox=function(entityCollector){var skyBox=entityCollector.skyBox;var material=skyBox.material;var camera=entityCollector.camera;this.updateSkyBoxProjection(camera);material.iActivatePass(0,this._pStage3DProxy,camera);material.iRenderPass(0,skyBox,this._pStage3DProxy,entityCollector,this._skyboxProjection);material.iDeactivatePass(0,this._pStage3DProxy)};DefaultRenderer.prototype.updateSkyBoxProjection=function(camera){var near=new away.geom.Vector3D();this._skyboxProjection.copyFrom(this._pRttViewProjectionMatrix);this._skyboxProjection.copyRowTo(2,near);var camPos=camera.scenePosition;var cx=near.x;var cy=near.y;var cz=near.z;var cw=-(near.x*camPos.x+near.y*camPos.y+near.z*camPos.z+Math.sqrt(cx*cx+cy*cy+cz*cz));var signX=cx>=0?1:-1;var signY=cy>=0?1:-1;var p=new away.geom.Vector3D(signX,signY,1,1);var inverse=this._skyboxProjection.clone();inverse.invert();var q=inverse.transformVector(p);this._skyboxProjection.copyRowTo(3,p);var a=(q.x*p.x+q.y*p.y+q.z*p.z+q.w*p.w)/(cx*q.x+cy*q.y+cz*q.z+cw*q.w);this._skyboxProjection.copyRowFrom(2,new away.geom.Vector3D(cx*a,cy*a,cz*a,cw*a))};DefaultRenderer.prototype.drawRenderables=function(item,entityCollector,which){var numPasses;var j;var camera=entityCollector.camera;var item2;while(item){this._activeMaterial=item.renderable.material;this._activeMaterial.iUpdateMaterial(this._pContext);numPasses=this._activeMaterial._iNumPasses;j=0;do{item2=item;var rttMask=this._activeMaterial.iPassRendersToTexture(j)?1:2;if((rttMask&which)!=0){this._activeMaterial.iActivatePass(j,this._pStage3DProxy,camera);do{this._activeMaterial.iRenderPass(j,item2.renderable,this._pStage3DProxy,entityCollector,this._pRttViewProjectionMatrix);item2=item2.next}while(item2&&item2.renderable.material==this._activeMaterial);this._activeMaterial.iDeactivatePass(j,this._pStage3DProxy)}else{do{item2=item2.next}while(item2&&item2.renderable.material==this._activeMaterial)}}while(++j<numPasses);item=item2}};DefaultRenderer.prototype.iDispose=function(){_super.prototype.iDispose.call(this);this._pDepthRenderer.iDispose();this._pDistanceRenderer.iDispose();this._pDepthRenderer=null;this._pDistanceRenderer=null};DefaultRenderer.RTT_PASSES=1;DefaultRenderer.SCREEN_PASSES=2;DefaultRenderer.ALL_PASSES=3;return DefaultRenderer})(away.render.RendererBase);render.DefaultRenderer=DefaultRenderer})(away.render||(away.render={}));var render=away.render})(away||(away={}));var away;(function(away){(function(filters){var Filter3DTaskBase=(function(){function Filter3DTaskBase(requireDepthRender){if(typeof requireDepthRender==="undefined"){requireDepthRender=false}this._scaledTextureWidth=-1;this._scaledTextureHeight=-1;this._textureWidth=-1;this._textureHeight=-1;this._textureDimensionsInvalid=true;this._program3DInvalid=true;this._textureScale=0;this._requireDepthRender=requireDepthRender}Object.defineProperty(Filter3DTaskBase.prototype,"textureScale",{get:function(){return this._textureScale},set:function(value){if(this._textureScale==value){return}this._textureScale=value;this._scaledTextureWidth=this._textureWidth>>this._textureScale;this._scaledTextureHeight=this._textureHeight>>this._textureScale;this._textureDimensionsInvalid=true},enumerable:true,configurable:true});Object.defineProperty(Filter3DTaskBase.prototype,"target",{get:function(){return this._target},set:function(value){this._target=value},enumerable:true,configurable:true});Object.defineProperty(Filter3DTaskBase.prototype,"textureWidth",{get:function(){return this._textureWidth},set:function(value){if(this._textureWidth==value){return}this._textureWidth=value;this._scaledTextureWidth=this._textureWidth>>this._textureScale;this._textureDimensionsInvalid=true},enumerable:true,configurable:true});Object.defineProperty(Filter3DTaskBase.prototype,"textureHeight",{get:function(){return this._textureHeight},set:function(value){if(this._textureHeight==value){return}this._textureHeight=value;this._scaledTextureHeight=this._textureHeight>>this._textureScale;this._textureDimensionsInvalid=true},enumerable:true,configurable:true});Filter3DTaskBase.prototype.getMainInputTexture=function(stage){if(this._textureDimensionsInvalid){this.pUpdateTextures(stage)}return this._mainInputTexture};Filter3DTaskBase.prototype.dispose=function(){if(this._mainInputTexture){this._mainInputTexture.dispose()}if(this._program3D){this._program3D.dispose()}};Filter3DTaskBase.prototype.pInvalidateProgram3D=function(){this._program3DInvalid=true};Filter3DTaskBase.prototype.pUpdateProgram3D=function(stage){if(this._program3D){this._program3D.dispose()}this._program3D=stage._iContext3D.createProgram();var vertCompiler=new aglsl.AGLSLCompiler();var fragCompiler=new aglsl.AGLSLCompiler();var vertString=vertCompiler.compile(away.display3D.Context3DProgramType.VERTEX,this.pGetVertexCode());var fragString=fragCompiler.compile(away.display3D.Context3DProgramType.FRAGMENT,this.pGetFragmentCode());this._program3D.upload(vertString,fragString);this._program3DInvalid=false};Filter3DTaskBase.prototype.pGetVertexCode=function(){return"mov op, va0\nmov v0, va1\n"};Filter3DTaskBase.prototype.pGetFragmentCode=function(){throw new away.errors.AbstractMethodError();return null};Filter3DTaskBase.prototype.pUpdateTextures=function(stage){if(this._mainInputTexture){this._mainInputTexture.dispose()}this._mainInputTexture=stage._iContext3D.createTexture(this._scaledTextureWidth,this._scaledTextureHeight,away.display3D.Context3DTextureFormat.BGRA,true);this._textureDimensionsInvalid=false};Filter3DTaskBase.prototype.getProgram3D=function(stage3DProxy){if(this._program3DInvalid){this.pUpdateProgram3D(stage3DProxy)}return this._program3D};Filter3DTaskBase.prototype.activate=function(stage3DProxy,camera,depthTexture){};Filter3DTaskBase.prototype.deactivate=function(stage3DProxy){};Object.defineProperty(Filter3DTaskBase.prototype,"requireDepthRender",{get:function(){return this._requireDepthRender},enumerable:true,configurable:true});return Filter3DTaskBase})();filters.Filter3DTaskBase=Filter3DTaskBase})(away.filters||(away.filters={}));var filters=away.filters})(away||(away={}));var away;(function(away){(function(managers){var RTTBufferManager=(function(_super){__extends(RTTBufferManager,_super);function RTTBufferManager(se,stage3DProxy){_super.call(this);this._viewWidth=-1;this._viewHeight=-1;this._textureWidth=-1;this._textureHeight=-1;this._buffersInvalid=true;if(!se){throw new Error("No cheating the multiton!")}this._renderToTextureRect=new away.geom.Rectangle();this._stage3DProxy=stage3DProxy}RTTBufferManager.getInstance=function(stage3DProxy){if(!stage3DProxy){throw new Error("stage3DProxy key cannot be null!")}if(RTTBufferManager._instances==null){RTTBufferManager._instances=new Array()}var rttBufferManager=RTTBufferManager.getRTTBufferManagerFromStage3DProxy(stage3DProxy);if(rttBufferManager==null){rttBufferManager=new away.managers.RTTBufferManager(new SingletonEnforcer(),stage3DProxy);var vo=new RTTBufferManagerVO();vo.stage3dProxy=stage3DProxy;vo.rttbfm=rttBufferManager;RTTBufferManager._instances.push(vo)}return rttBufferManager};RTTBufferManager.getRTTBufferManagerFromStage3DProxy=function(stage3DProxy){var l=RTTBufferManager._instances.length;var r;for(var c=0;c<l;c++){r=RTTBufferManager._instances[c];if(r.stage3dProxy===stage3DProxy){return r.rttbfm}}return null};RTTBufferManager.deleteRTTBufferManager=function(stage3DProxy){var l=RTTBufferManager._instances.length;var r;for(var c=0;c<l;c++){r=RTTBufferManager._instances[c];if(r.stage3dProxy===stage3DProxy){RTTBufferManager._instances.splice(c,1);return}}};Object.defineProperty(RTTBufferManager.prototype,"textureRatioX",{get:function(){if(this._buffersInvalid){this.updateRTTBuffers()}return this._textureRatioX},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"textureRatioY",{get:function(){if(this._buffersInvalid){this.updateRTTBuffers()}return this._textureRatioY},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"viewWidth",{get:function(){return this._viewWidth},set:function(value){if(value==this._viewWidth){return}this._viewWidth=value;this._buffersInvalid=true;this._textureWidth=away.utils.TextureUtils.getBestPowerOf2(this._viewWidth);if(this._textureWidth>this._viewWidth){this._renderToTextureRect.x=Math.floor((this._textureWidth-this._viewWidth)*0.5);this._renderToTextureRect.width=this._viewWidth}else{this._renderToTextureRect.x=0;this._renderToTextureRect.width=this._textureWidth}this.dispatchEvent(new away.events.Event(away.events.Event.RESIZE))},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"viewHeight",{get:function(){return this._viewHeight},set:function(value){if(value==this._viewHeight){return}this._viewHeight=value;this._buffersInvalid=true;this._textureHeight=away.utils.TextureUtils.getBestPowerOf2(this._viewHeight);if(this._textureHeight>this._viewHeight){this._renderToTextureRect.y=Math.floor((this._textureHeight-this._viewHeight)*0.5);this._renderToTextureRect.height=this._viewHeight}else{this._renderToTextureRect.y=0;this._renderToTextureRect.height=this._textureHeight}this.dispatchEvent(new away.events.Event(away.events.Event.RESIZE))},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"renderToTextureVertexBuffer",{get:function(){if(this._buffersInvalid){this.updateRTTBuffers()}return this._renderToTextureVertexBuffer},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"renderToScreenVertexBuffer",{get:function(){if(this._buffersInvalid){this.updateRTTBuffers()}return this._renderToScreenVertexBuffer},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"indexBuffer",{get:function(){return this._indexBuffer},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"renderToTextureRect",{get:function(){if(this._buffersInvalid){this.updateRTTBuffers()}return this._renderToTextureRect},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"textureWidth",{get:function(){return this._textureWidth},enumerable:true,configurable:true});Object.defineProperty(RTTBufferManager.prototype,"textureHeight",{get:function(){return this._textureHeight},enumerable:true,configurable:true});RTTBufferManager.prototype.dispose=function(){RTTBufferManager.deleteRTTBufferManager(this._stage3DProxy);if(this._indexBuffer){this._indexBuffer.dispose();this._renderToScreenVertexBuffer.dispose();this._renderToTextureVertexBuffer.dispose();this._renderToScreenVertexBuffer=null;this._renderToTextureVertexBuffer=null;this._indexBuffer=null}};RTTBufferManager.prototype.updateRTTBuffers=function(){var context=this._stage3DProxy._iContext3D;var textureVerts;var screenVerts;var x;var y;if(this._renderToTextureVertexBuffer==null){this._renderToTextureVertexBuffer=context.createVertexBuffer(4,5)}if(this._renderToScreenVertexBuffer==null){this._renderToScreenVertexBuffer=context.createVertexBuffer(4,5)}if(!this._indexBuffer){this._indexBuffer=context.createIndexBuffer(6);this._indexBuffer.uploadFromArray([2,1,0,3,2,0],0,6)}this._textureRatioX=x=Math.min(this._viewWidth/this._textureWidth,1);this._textureRatioY=y=Math.min(this._viewHeight/this._textureHeight,1);var u1=(1-x)*0.5;var u2=(x+1)*0.5;var v1=(y+1)*0.5;var v2=(1-y)*0.5;textureVerts=[-x,-y,u1,v1,0,x,-y,u2,v1,1,x,y,u2,v2,2,-x,y,u1,v2,3];screenVerts=[-1,-1,u1,v1,0,1,-1,u2,v1,1,1,1,u2,v2,2,-1,1,u1,v2,3];this._renderToTextureVertexBuffer.uploadFromArray(textureVerts,0,4);this._renderToScreenVertexBuffer.uploadFromArray(screenVerts,0,4);this._buffersInvalid=false};return RTTBufferManager})(away.events.EventDispatcher);managers.RTTBufferManager=RTTBufferManager})(away.managers||(away.managers={}));var managers=away.managers})(away||(away={}));var RTTBufferManagerVO=(function(){function RTTBufferManagerVO(){}return RTTBufferManagerVO})();var SingletonEnforcer=(function(){function SingletonEnforcer(){}return SingletonEnforcer})();var away;(function(away){(function(filters){var Filter3DBase=(function(){function Filter3DBase(){this._tasks=new Array()}Object.defineProperty(Filter3DBase.prototype,"requireDepthRender",{get:function(){return this._requireDepthRender},enumerable:true,configurable:true});Filter3DBase.prototype.pAddTask=function(filter){this._tasks.push(filter);if(this._requireDepthRender==null){this._requireDepthRender=filter.requireDepthRender}};Object.defineProperty(Filter3DBase.prototype,"tasks",{get:function(){return this._tasks},enumerable:true,configurable:true});Filter3DBase.prototype.getMainInputTexture=function(stage3DProxy){return this._tasks[0].getMainInputTexture(stage3DProxy)};Object.defineProperty(Filter3DBase.prototype,"textureWidth",{get:function(){return this._textureWidth},set:function(value){this._textureWidth=value;for(var i=0;i<this._tasks.length;++i){this._tasks[i].textureWidth=value}},enumerable:true,configurable:true});Object.defineProperty(Filter3DBase.prototype,"textureHeight",{get:function(){return this._textureHeight},set:function(value){this._textureHeight=value;for(var i=0;i<this._tasks.length;++i){this._tasks[i].textureHeight=value}},enumerable:true,configurable:true});Filter3DBase.prototype.setRenderTargets=function(mainTarget,stage3DProxy){this._tasks[this._tasks.length-1].target=mainTarget};Filter3DBase.prototype.dispose=function(){for(var i=0;i<this._tasks.length;++i){this._tasks[i].dispose()}};Filter3DBase.prototype.update=function(stage,camera){};return Filter3DBase})();filters.Filter3DBase=Filter3DBase})(away.filters||(away.filters={}));var filters=away.filters})(away||(away={}));var away;(function(away){(function(render){var Filter3DRenderer=(function(){function Filter3DRenderer(stage3DProxy){this._filterSizesInvalid=true;this._stage3DProxy=stage3DProxy;this._rttManager=away.managers.RTTBufferManager.getInstance(stage3DProxy);this._rttManager.addEventListener(away.events.Event.RESIZE,this.onRTTResize,this)}Filter3DRenderer.prototype.onRTTResize=function(event){this._filterSizesInvalid=true};Object.defineProperty(Filter3DRenderer.prototype,"requireDepthRender",{get:function(){return this._requireDepthRender},enumerable:true,configurable:true});Filter3DRenderer.prototype.getMainInputTexture=function(stage3DProxy){if(this._filterTasksInvalid){this.updateFilterTasks(stage3DProxy)}return this._mainInputTexture};Object.defineProperty(Filter3DRenderer.prototype,"filters",{get:function(){return this._filters},set:function(value){this._filters=value;this._filterTasksInvalid=true;this._requireDepthRender=false;if(!this._filters){return}for(var i=0;i<this._filters.length;++i){var s=this._filters[i];var b=(s.requireDepthRender==null)?false:s.requireDepthRender;this._requireDepthRender=this._requireDepthRender||b}this._filterSizesInvalid=true},enumerable:true,configurable:true});Filter3DRenderer.prototype.updateFilterTasks=function(stage3DProxy){var len;if(this._filterSizesInvalid){this.updateFilterSizes()}if(!this._filters){this._tasks=null;return}this._tasks=new Array();len=this._filters.length-1;var filter;for(var i=0;i<=len;++i){filter=this._filters[i];filter.setRenderTargets(i==len?null:this._filters[i+1].getMainInputTexture(stage3DProxy),stage3DProxy);this._tasks=this._tasks.concat(filter.tasks)}this._mainInputTexture=this._filters[0].getMainInputTexture(stage3DProxy)};Filter3DRenderer.prototype.render=function(stage3DProxy,camera3D,depthTexture){var len;var i;var task;var context=stage3DProxy._iContext3D;var indexBuffer=this._rttManager.indexBuffer;var vertexBuffer=this._rttManager.renderToTextureVertexBuffer;if(!this._filters){return}if(this._filterSizesInvalid){this.updateFilterSizes()}if(this._filterTasksInvalid){this.updateFilterTasks(stage3DProxy)}len=this._filters.length;for(i=0;i<len;++i){this._filters[i].update(stage3DProxy,camera3D)}len=this._tasks.length;if(len>1){context.setVertexBufferAt(0,vertexBuffer,0,away.display3D.Context3DVertexBufferFormat.FLOAT_2);context.setVertexBufferAt(1,vertexBuffer,2,away.display3D.Context3DVertexBufferFormat.FLOAT_2)}for(i=0;i<len;++i){task=this._tasks[i];stage3DProxy.setRenderTarget(task.target);if(!task.target){stage3DProxy.scissorRect=null;vertexBuffer=this._rttManager.renderToScreenVertexBuffer;context.setVertexBufferAt(0,vertexBuffer,0,away.display3D.Context3DVertexBufferFormat.FLOAT_2);context.setVertexBufferAt(1,vertexBuffer,2,away.display3D.Context3DVertexBufferFormat.FLOAT_2)}context.setTextureAt(0,task.getMainInputTexture(stage3DProxy));context.setProgram(task.getProgram3D(stage3DProxy));context.clear(0,0,0,0);task.activate(stage3DProxy,camera3D,depthTexture);context.setBlendFactors(away.display3D.Context3DBlendFactor.ONE,away.display3D.Context3DBlendFactor.ZERO);context.drawTriangles(indexBuffer,0,2);task.deactivate(stage3DProxy)}context.setTextureAt(0,null);context.setVertexBufferAt(0,null);context.setVertexBufferAt(1,null)};Filter3DRenderer.prototype.updateFilterSizes=function(){for(var i=0;i<this._filters.length;++i){this._filters[i].textureWidth=this._rttManager.textureWidth;this._filters[i].textureHeight=this._rttManager.textureHeight}this._filterSizesInvalid=true};Filter3DRenderer.prototype.dispose=function(){this._rttManager.removeEventListener(away.events.Event.RESIZE,this.onRTTResize,this);this._rttManager=null;this._stage3DProxy=null};return Filter3DRenderer})();render.Filter3DRenderer=Filter3DRenderer})(away.render||(away.render={}));var render=away.render})(away||(away={}));var away;(function(away){(function(utils){var ByteArrayBase=(function(){function ByteArrayBase(){this.position=0;this.length=0;this._mode="";this.Base64Key="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"}ByteArrayBase.prototype.writeByte=function(b){throw"Virtual method"};ByteArrayBase.prototype.readByte=function(){throw"Virtual method"};ByteArrayBase.prototype.writeUnsignedByte=function(b){throw"Virtual method"};ByteArrayBase.prototype.readUnsignedByte=function(){throw"Virtual method"};ByteArrayBase.prototype.writeUnsignedShort=function(b){throw"Virtual method"};ByteArrayBase.prototype.readUnsignedShort=function(){throw"Virtual method"};ByteArrayBase.prototype.writeUnsignedInt=function(b){throw"Virtual method"};ByteArrayBase.prototype.readUnsignedInt=function(){throw"Virtual method"};ByteArrayBase.prototype.writeFloat=function(b){throw"Virtual method"};ByteArrayBase.prototype.toFloatBits=function(x){throw"Virtual method"};ByteArrayBase.prototype.readFloat=function(b){throw"Virtual method"};ByteArrayBase.prototype.fromFloatBits=function(x){throw"Virtual method"};ByteArrayBase.prototype.toString=function(){return"[ByteArray] ( "+this._mode+" ) position="+this.position+" length="+this.length};ByteArrayBase.prototype.compareEqual=function(other,count){if(count==undefined||count>this.length-this.position){count=this.length-this.position}if(count>other.length-other.position){count=other.length-other.position}var co0=count;var r=true;while(r&&count>=4){count-=4;if(this.readUnsignedInt()!=other.readUnsignedInt()){r=false}}while(r&&count>=1){count--;if(this.readUnsignedByte()!=other.readUnsignedByte()){r=false}}var c0;this.position-=(c0-count);other.position-=(c0-count);return r};ByteArrayBase.prototype.writeBase64String=function(s){for(var i=0;i<s.length;i++){var v=s.charAt(i)}};ByteArrayBase.prototype.dumpToConsole=function(){var oldpos=this.position;this.position=0;var nstep=8;function asHexString(x,digits){var lut=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];var sh="";for(var d=0;d<digits;d++){sh=lut[(x>>(d<<2))&15]+sh}return sh}for(var i=0;i<this.length;i+=nstep){var s=asHexString(i,4)+":";for(var j=0;j<nstep&&i+j<this.length;j++){s+=" "+asHexString(this.readUnsignedByte(),2)}console.log(s)}this.position=oldpos};ByteArrayBase.prototype.internalGetBase64String=function(count,getUnsignedByteFunc,self){var r="";var b0,b1,b2,enc1,enc2,enc3,enc4;var base64Key=this.Base64Key;while(count>=3){b0=getUnsignedByteFunc.apply(self);b1=getUnsignedByteFunc.apply(self);b2=getUnsignedByteFunc.apply(self);enc1=b0>>2;enc2=((b0&3)<<4)|(b1>>4);enc3=((b1&15)<<2)|(b2>>6);enc4=b2&63;r+=base64Key.charAt(enc1)+base64Key.charAt(enc2)+base64Key.charAt(enc3)+base64Key.charAt(enc4);count-=3}if(count==2){b0=getUnsignedByteFunc.apply(self);b1=getUnsignedByteFunc.apply(self);enc1=b0>>2;enc2=((b0&3)<<4)|(b1>>4);enc3=((b1&15)<<2);r+=base64Key.charAt(enc1)+base64Key.charAt(enc2)+base64Key.charAt(enc3)+"="}else{if(count==1){b0=getUnsignedByteFunc.apply(self);enc1=b0>>2;enc2=((b0&3)<<4);r+=base64Key.charAt(enc1)+base64Key.charAt(enc2)+"=="}}return r};return ByteArrayBase})();utils.ByteArrayBase=ByteArrayBase})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(utils){var ByteArray=(function(_super){__extends(ByteArray,_super);function ByteArray(){_super.call(this);this.maxlength=0;this._mode="Typed array";this.maxlength=4;this.arraybytes=new ArrayBuffer(this.maxlength);this.unalignedarraybytestemp=new ArrayBuffer(16)}ByteArray.prototype.ensureWriteableSpace=function(n){this.ensureSpace(n+this.position)};ByteArray.prototype.ensureSpace=function(n){if(n>this.maxlength){var newmaxlength=(n+255)&(~255);var newarraybuffer=new ArrayBuffer(newmaxlength);var view=new Uint8Array(this.arraybytes,0,this.length);var newview=new Uint8Array(newarraybuffer,0,this.length);newview.set(view);this.arraybytes=newarraybuffer;this.maxlength=newmaxlength}};ByteArray.prototype.writeByte=function(b){this.ensureWriteableSpace(1);var view=new Int8Array(this.arraybytes);view[this.position++]=(~~b);if(this.position>this.length){this.length=this.position}};ByteArray.prototype.readByte=function(){if(this.position>=this.length){throw"ByteArray out of bounds read. Positon="+this.position+", Length="+this.length}var view=new Int8Array(this.arraybytes);return view[this.position++]};ByteArray.prototype.writeUnsignedByte=function(b){this.ensureWriteableSpace(1);var view=new Uint8Array(this.arraybytes);view[this.position++]=(~~b)&255;if(this.position>this.length){this.length=this.position}};ByteArray.prototype.readUnsignedByte=function(){if(this.position>=this.length){throw"ByteArray out of bounds read. Positon="+this.position+", Length="+this.length}var view=new Uint8Array(this.arraybytes);return view[this.position++]};ByteArray.prototype.writeUnsignedShort=function(b){this.ensureWriteableSpace(2);if((this.position&1)==0){var view=new Uint16Array(this.arraybytes);view[this.position>>1]=(~~b)&65535}else{var view=new Uint16Array(this.unalignedarraybytestemp,0,1);view[0]=(~~b)&65535;var view2=new Uint8Array(this.arraybytes,this.position,2);var view3=new Uint8Array(this.unalignedarraybytestemp,0,2);view2.set(view3)}this.position+=2;if(this.position>this.length){this.length=this.position}};ByteArray.prototype.readUnsignedShort=function(){if(this.position>this.length+2){throw"ByteArray out of bounds read. Positon="+this.position+", Length="+this.length}if((this.position&1)==0){var view=new Uint16Array(this.arraybytes);var pa=this.position>>1;this.position+=2;return view[pa]}else{var view=new Uint16Array(this.unalignedarraybytestemp,0,1);var view2=new Uint8Array(this.arraybytes,this.position,2);var view3=new Uint8Array(this.unalignedarraybytestemp,0,2);view3.set(view2);this.position+=2;return view[0]}};ByteArray.prototype.writeUnsignedInt=function(b){this.ensureWriteableSpace(4);if((this.position&3)==0){var view=new Uint32Array(this.arraybytes);view[this.position>>2]=(~~b)&4294967295}else{var view=new Uint32Array(this.unalignedarraybytestemp,0,1);view[0]=(~~b)&4294967295;var view2=new Uint8Array(this.arraybytes,this.position,4);var view3=new Uint8Array(this.unalignedarraybytestemp,0,4);view2.set(view3)}this.position+=4;if(this.position>this.length){this.length=this.position}};ByteArray.prototype.readUnsignedInt=function(){if(this.position>this.length+4){throw"ByteArray out of bounds read. Positon="+this.position+", Length="+this.length}if((this.position&3)==0){var view=new Uint32Array(this.arraybytes);var pa=this.position>>2;this.position+=4;return view[pa]}else{var view=new Uint32Array(this.unalignedarraybytestemp,0,1);var view2=new Uint8Array(this.arraybytes,this.position,4);var view3=new Uint8Array(this.unalignedarraybytestemp,0,4);view3.set(view2);this.position+=4;return view[0]}};ByteArray.prototype.writeFloat=function(b){this.ensureWriteableSpace(4);if((this.position&3)==0){var view=new Float32Array(this.arraybytes);view[this.position>>2]=b}else{var view=new Float32Array(this.unalignedarraybytestemp,0,1);view[0]=b;var view2=new Uint8Array(this.arraybytes,this.position,4);var view3=new Uint8Array(this.unalignedarraybytestemp,0,4);view2.set(view3)}this.position+=4;if(this.position>this.length){this.length=this.position}};ByteArray.prototype.readFloat=function(){if(this.position>this.length+4){throw"ByteArray out of bounds read. Positon="+this.position+", Length="+this.length}if((this.position&3)==0){var view=new Float32Array(this.arraybytes);var pa=this.position>>2;this.position+=4;return view[pa]}else{var view=new Float32Array(this.unalignedarraybytestemp,0,1);var view2=new Uint8Array(this.arraybytes,this.position,4);var view3=new Uint8Array(this.unalignedarraybytestemp,0,4);view3.set(view2);this.position+=4;return view[0]}};return ByteArray})(utils.ByteArrayBase);utils.ByteArray=ByteArray})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var away;(function(away){(function(utils){var ByteArrayBuffer=(function(_super){__extends(ByteArrayBuffer,_super);function ByteArrayBuffer(){_super.call(this);this._bytes=[];this._mode="Array"}ByteArrayBuffer.prototype.writeByte=function(b){var bi=~~b;this._bytes[this.position++]=bi;if(this.position>this.length){this.length=this.position}};ByteArrayBuffer.prototype.readByte=function(){if(this.position>=this.length){throw"ByteArray out of bounds read. Position="+this.position+", Length="+this.length}return this._bytes[this.position++]};ByteArrayBuffer.prototype.writeUnsignedByte=function(b){var bi=~~b;this._bytes[this.position++]=bi&255;if(this.position>this.length){this.length=this.position}};ByteArrayBuffer.prototype.readUnsignedByte=function(){if(this.position>=this.length){throw"ByteArray out of bounds read. Position="+this.position+", Length="+this.length}return this._bytes[this.position++]};ByteArrayBuffer.prototype.writeUnsignedShort=function(b){var bi=~~b;this._bytes[this.position++]=bi&255;this._bytes[this.position++]=(bi>>8)&255;if(this.position>this.length){this.length=this.position}};ByteArrayBuffer.prototype.readUnsignedShort=function(){if(this.position+2>this.length){throw"ByteArray out of bounds read. Position="+this.position+", Length="+this.length}var r=this._bytes[this.position]|(this._bytes[this.position+1]<<8);this.position+=2;return r};ByteArrayBuffer.prototype.writeUnsignedInt=function(b){var bi=~~b;this._bytes[this.position++]=bi&255;this._bytes[this.position++]=(bi>>>8)&255;this._bytes[this.position++]=(bi>>>16)&255;this._bytes[this.position++]=(bi>>>24)&255;if(this.position>this.length){this.length=this.position}};ByteArrayBuffer.prototype.readUnsignedInt=function(){if(this.position+4>this.length){throw"ByteArray out of bounds read. Position="+this.position+", Length="+this.length}var r=this._bytes[this.position]|(this._bytes[this.position+1]<<8)|(this._bytes[this.position+2]<<16)|(this._bytes[this.position+3]<<24);this.position+=4;return r>>>0};ByteArrayBuffer.prototype.writeFloat=function(b){this.writeUnsignedInt(this.toFloatBits(Number(b)))};ByteArrayBuffer.prototype.toFloatBits=function(x){if(x==0){return 0}var sign=0;if(x<0){x=-x;sign=1}else{sign=0}var exponent=Math.log(x)/Math.log(2);exponent=Math.floor(exponent);x=x*Math.pow(2,23-exponent);var mantissa=Math.floor(x)-8388608;exponent=exponent+127;return((sign<<31)>>>0)|(exponent<<23)|mantissa};ByteArrayBuffer.prototype.readFloat=function(b){return this.fromFloatBits(this.readUnsignedInt())};ByteArrayBuffer.prototype.fromFloatBits=function(x){if(x==0){return 0}var exponent=(x>>>23)&255;var mantissa=(x&8388607)|8388608;var y=Math.pow(2,(exponent-127)-23)*mantissa;if(x>>>31!=0){y=-y}return y};return ByteArrayBuffer})(utils.ByteArrayBase);utils.ByteArrayBuffer=ByteArrayBuffer})(away.utils||(away.utils={}));var utils=away.utils})(away||(away={}));var aglsl;(function(aglsl){var Sampler=(function(){function Sampler(){this.lodbias=0;this.dim=0;this.readmode=0;this.special=0;this.wrap=0;this.mipmap=0;this.filter=0}return Sampler})();aglsl.Sampler=Sampler})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var Token=(function(){function Token(){this.dest=new aglsl.Destination();this.opcode=0;this.a=new aglsl.Destination();this.b=new aglsl.Destination()}return Token})();aglsl.Token=Token})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var Header=(function(){function Header(){this.progid=0;this.version=0;this.type=""}return Header})();aglsl.Header=Header})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var OpLUT=(function(){function OpLUT(s,flags,dest,a,b,matrixwidth,matrixheight,ndwm,scaler,dm,lod){this.s=s;this.flags=flags;this.dest=dest;this.a=a;this.b=b;this.matrixwidth=matrixwidth;this.matrixheight=matrixheight;this.ndwm=ndwm;this.scalar=scaler;this.dm=dm;this.lod=lod}return OpLUT})();aglsl.OpLUT=OpLUT})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var Description=(function(){function Description(){this.regread=[[],[],[],[],[],[],[]];this.regwrite=[[],[],[],[],[],[],[]];this.hasindirect=false;this.writedepth=false;this.hasmatrix=false;this.samplers=[];this.tokens=[];this.header=new aglsl.Header()}return Description})();aglsl.Description=Description})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var Destination=(function(){function Destination(){this.mask=0;this.regnum=0;this.regtype=0;this.dim=0}return Destination})();aglsl.Destination=Destination})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var Context3D=(function(){function Context3D(){this.enableErrorChecking=false;this.resources=[];this.driverInfo="Call getter function instead"}Context3D.maxvertexconstants=128;Context3D.maxfragconstants=28;Context3D.maxtemp=8;Context3D.maxstreams=8;Context3D.maxtextures=8;Context3D.defaultsampler=new aglsl.Sampler();return Context3D})();aglsl.Context3D=Context3D})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var Mapping=(function(){function Mapping(){}Mapping.agal2glsllut=[new aglsl.OpLUT("%dest = %cast(%a);\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a + %b);\n",0,true,true,true,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a - %b);\n",0,true,true,true,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a * %b);\n",0,true,true,true,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a / %b);\n",0,true,true,true,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(1.0) / %a;\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(min(%a,%b));\n",0,true,true,true,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(min(%a,%b));\n",0,true,true,true,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(fract(%a));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(sqrt(abs(%a)));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(inversesqrt(abs(%a)));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(pow(abs(%a),%b));\n",0,true,true,true,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(log2(abs(%a)));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(exp2(%a));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(normalize(%a));\n",0,true,true,false,null,null,true,null,null,null),new aglsl.OpLUT("%dest = %cast(sin(%a));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(cos(%a));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(cross(vec3(%a),vec3(%b)));\n",0,true,true,true,null,null,true,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec3(%a),vec3(%b)));\n",0,true,true,true,null,null,true,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",0,true,true,true,null,null,true,null,null,null),new aglsl.OpLUT("%dest = %cast(abs(%a));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a * -1.0);\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(clamp(%a,0.0,1.0));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec3(%a),vec3(%b)));\n",null,true,true,true,3,3,true,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",null,true,true,true,4,4,true,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",null,true,true,true,4,3,true,null,null,null),new aglsl.OpLUT("%dest = %cast(dFdx(%a));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(dFdx(%a));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("if (float(%a)==float(%b)) {;\n",0,false,true,true,null,null,null,true,null,null),new aglsl.OpLUT("if (float(%a)!=float(%b)) {;\n",0,false,true,true,null,null,null,true,null,null),new aglsl.OpLUT("if (float(%a)>=float(%b)) {;\n",0,false,true,true,null,null,null,true,null,null),new aglsl.OpLUT("if (float(%a)<float(%b)) {;\n",0,false,true,true,null,null,null,true,null,null),new aglsl.OpLUT("} else {;\n",0,false,false,false,null,null,null,null,null,null),new aglsl.OpLUT("};\n",0,false,false,false,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,false,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,false,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,false,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(texture%texdimLod(%b,%texsize(%a)).%dm);\n",null,true,true,true,null,null,null,null,true,null),new aglsl.OpLUT("if ( float(%a)<0.0 ) discard;\n",null,false,true,false,null,null,null,true,null,null),new aglsl.OpLUT("%dest = %cast(texture%texdim(%b,%texsize(%a)%lod).%dm);\n",null,true,true,true,null,null,true,null,true,true),new aglsl.OpLUT("%dest = %cast(greaterThanEqual(%a,%b).%dm);\n",0,true,true,true,null,null,true,null,true,null),new aglsl.OpLUT("%dest = %cast(lessThan(%a,%b).%dm);\n",0,true,true,true,null,null,true,null,true,null),new aglsl.OpLUT("%dest = %cast(sign(%a));\n",0,true,true,false,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(equal(%a,%b).%dm);\n",0,true,true,false,null,null,true,null,true,null),new aglsl.OpLUT("%dest = %cast(notEqual(%a,%b).%dm);\n",0,true,true,true,null,null,true,null,true,null)];return Mapping})();aglsl.Mapping=Mapping})(aglsl||(aglsl={}));var aglsl;(function(aglsl){(function(assembler){var Opcode=(function(){function Opcode(dest,aformat,asize,bformat,bsize,opcode,simple,horizontal,fragonly,matrix){this.a=new aglsl.assembler.FS();this.b=new aglsl.assembler.FS();this.flags=new aglsl.assembler.Flags();this.dest=dest;this.a.format=aformat;this.a.size=asize;this.b.format=bformat;this.b.size=bsize;this.opcode=opcode;this.flags.simple=simple;this.flags.horizontal=horizontal;this.flags.fragonly=fragonly;this.flags.matrix=matrix}return Opcode})();assembler.Opcode=Opcode;var FS=(function(){function FS(){}return FS})();assembler.FS=FS;var Flags=(function(){function Flags(){}return Flags})();assembler.Flags=Flags})(aglsl.assembler||(aglsl.assembler={}));var assembler=aglsl.assembler})(aglsl||(aglsl={}));var aglsl;(function(aglsl){(function(assembler){var OpcodeMap=(function(){function OpcodeMap(){}Object.defineProperty(OpcodeMap,"map",{get:function(){if(!OpcodeMap._map){OpcodeMap._map=new Array();OpcodeMap._map.mov=new aglsl.assembler.Opcode("vector","vector",4,"none",0,0,true,null,null,null);OpcodeMap._map.add=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,1,true,null,null,null);OpcodeMap._map.sub=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,2,true,null,null,null);OpcodeMap._map.mul=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,3,true,null,null,null);OpcodeMap._map.div=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,4,true,null,null,null);OpcodeMap._map.rcp=new aglsl.assembler.Opcode("vector","vector",4,"none",0,5,true,null,null,null);OpcodeMap._map.min=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,6,true,null,null,null);OpcodeMap._map.max=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,7,true,null,null,null);OpcodeMap._map.frc=new aglsl.assembler.Opcode("vector","vector",4,"none",0,8,true,null,null,null);OpcodeMap._map.sqt=new aglsl.assembler.Opcode("vector","vector",4,"none",0,9,true,null,null,null);OpcodeMap._map.rsq=new aglsl.assembler.Opcode("vector","vector",4,"none",0,10,true,null,null,null);OpcodeMap._map.pow=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,11,true,null,null,null);OpcodeMap._map.log=new aglsl.assembler.Opcode("vector","vector",4,"none",0,12,true,null,null,null);OpcodeMap._map.exp=new aglsl.assembler.Opcode("vector","vector",4,"none",0,13,true,null,null,null);OpcodeMap._map.nrm=new aglsl.assembler.Opcode("vector","vector",4,"none",0,14,true,null,null,null);OpcodeMap._map.sin=new aglsl.assembler.Opcode("vector","vector",4,"none",0,15,true,null,null,null);OpcodeMap._map.cos=new aglsl.assembler.Opcode("vector","vector",4,"none",0,16,true,null,null,null);OpcodeMap._map.crs=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,17,true,true,null,null);OpcodeMap._map.dp3=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,18,true,true,null,null);OpcodeMap._map.dp4=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,19,true,true,null,null);OpcodeMap._map.abs=new aglsl.assembler.Opcode("vector","vector",4,"none",0,20,true,null,null,null);OpcodeMap._map.neg=new aglsl.assembler.Opcode("vector","vector",4,"none",0,21,true,null,null,null);OpcodeMap._map.sat=new aglsl.assembler.Opcode("vector","vector",4,"none",0,22,true,null,null,null);OpcodeMap._map.ted=new aglsl.assembler.Opcode("vector","vector",4,"sampler",1,38,true,null,true,null);OpcodeMap._map.kil=new aglsl.assembler.Opcode("none","scalar",1,"none",0,39,true,null,true,null);OpcodeMap._map.tex=new aglsl.assembler.Opcode("vector","vector",4,"sampler",1,40,true,null,true,null);OpcodeMap._map.m33=new aglsl.assembler.Opcode("vector","matrix",3,"vector",3,23,true,null,null,true);OpcodeMap._map.m44=new aglsl.assembler.Opcode("vector","matrix",4,"vector",4,24,true,null,null,true);OpcodeMap._map.m43=new aglsl.assembler.Opcode("vector","matrix",3,"vector",4,25,true,null,null,true);OpcodeMap._map.sge=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,41,true,null,null,null);OpcodeMap._map.slt=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,42,true,null,null,null);OpcodeMap._map.sgn=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,43,true,null,null,null);OpcodeMap._map.seq=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,44,true,null,null,null);OpcodeMap._map.sne=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,45,true,null,null,null)}return OpcodeMap._map},enumerable:true,configurable:true});return OpcodeMap})();assembler.OpcodeMap=OpcodeMap})(aglsl.assembler||(aglsl.assembler={}));var assembler=aglsl.assembler})(aglsl||(aglsl={}));var aglsl;(function(aglsl){(function(assembler){var Part=(function(){function Part(name,version){if(typeof name==="undefined"){name=null}if(typeof version==="undefined"){version=null}this.name="";this.version=0;this.name=name;this.version=version;this.data=new away.utils.ByteArray()}return Part})();assembler.Part=Part})(aglsl.assembler||(aglsl.assembler={}));var assembler=aglsl.assembler})(aglsl||(aglsl={}));var aglsl;(function(aglsl){(function(assembler){var Reg=(function(){function Reg(code,desc){this.code=code;this.desc=desc}return Reg})();assembler.Reg=Reg;var RegMap=(function(){function RegMap(){}Object.defineProperty(RegMap,"map",{get:function(){if(!RegMap._map){RegMap._map=new Array();RegMap._map.va=new aglsl.assembler.Reg(0,"vertex attribute");RegMap._map.fc=new aglsl.assembler.Reg(1,"fragment constant");RegMap._map.vc=new aglsl.assembler.Reg(1,"vertex constant");RegMap._map.ft=new aglsl.assembler.Reg(2,"fragment temporary");RegMap._map.vt=new aglsl.assembler.Reg(2,"vertex temporary");RegMap._map.vo=new aglsl.assembler.Reg(3,"vertex output");RegMap._map.op=new aglsl.assembler.Reg(3,"vertex output");RegMap._map.fd=new aglsl.assembler.Reg(3,"fragment depth output");RegMap._map.fo=new aglsl.assembler.Reg(3,"fragment output");RegMap._map.oc=new aglsl.assembler.Reg(3,"fragment output");RegMap._map.v=new aglsl.assembler.Reg(4,"varying");RegMap._map.vi=new aglsl.assembler.Reg(4,"varying output");RegMap._map.fi=new aglsl.assembler.Reg(4,"varying input");RegMap._map.fs=new aglsl.assembler.Reg(5,"sampler")}return RegMap._map},enumerable:true,configurable:true});return RegMap})();assembler.RegMap=RegMap})(aglsl.assembler||(aglsl.assembler={}));var assembler=aglsl.assembler})(aglsl||(aglsl={}));var aglsl;(function(aglsl){(function(assembler){var Sampler=(function(){function Sampler(shift,mask,value){this.shift=shift;this.mask=mask;this.value=value}return Sampler})();assembler.Sampler=Sampler;var SamplerMap=(function(){function SamplerMap(){}Object.defineProperty(SamplerMap,"map",{get:function(){if(!SamplerMap._map){SamplerMap._map=new Array();SamplerMap._map.rgba=new aglsl.assembler.Sampler(8,15,0);SamplerMap._map.rg=new aglsl.assembler.Sampler(8,15,5);SamplerMap._map.r=new aglsl.assembler.Sampler(8,15,4);SamplerMap._map.compressed=new aglsl.assembler.Sampler(8,15,1);SamplerMap._map.compressed_alpha=new aglsl.assembler.Sampler(8,15,2);SamplerMap._map.dxt1=new aglsl.assembler.Sampler(8,15,1);SamplerMap._map.dxt5=new aglsl.assembler.Sampler(8,15,2);SamplerMap._map["2d"]=new aglsl.assembler.Sampler(12,15,0);SamplerMap._map.cube=new aglsl.assembler.Sampler(12,15,1);SamplerMap._map["3d"]=new aglsl.assembler.Sampler(12,15,2);SamplerMap._map.centroid=new aglsl.assembler.Sampler(16,1,1);SamplerMap._map.ignoresampler=new aglsl.assembler.Sampler(16,4,4);SamplerMap._map.clamp=new aglsl.assembler.Sampler(20,15,0);SamplerMap._map.repeat=new aglsl.assembler.Sampler(20,15,1);SamplerMap._map.wrap=new aglsl.assembler.Sampler(20,15,1);SamplerMap._map.nomip=new aglsl.assembler.Sampler(24,15,0);SamplerMap._map.mipnone=new aglsl.assembler.Sampler(24,15,0);SamplerMap._map.mipnearest=new aglsl.assembler.Sampler(24,15,1);SamplerMap._map.miplinear=new aglsl.assembler.Sampler(24,15,2);SamplerMap._map.nearest=new aglsl.assembler.Sampler(28,15,0);SamplerMap._map.linear=new aglsl.assembler.Sampler(28,15,1)}return SamplerMap._map},enumerable:true,configurable:true});return SamplerMap})();assembler.SamplerMap=SamplerMap})(aglsl.assembler||(aglsl.assembler={}));var assembler=aglsl.assembler})(aglsl||(aglsl={}));var aglsl;(function(aglsl){(function(assembler){var AGALMiniAssembler=(function(){function AGALMiniAssembler(){this.r={};this.cur=new aglsl.assembler.Part()}AGALMiniAssembler.prototype.assemble=function(source,ext_part,ext_version){if(typeof ext_part==="undefined"){ext_part=null}if(typeof ext_version==="undefined"){ext_version=null}if(!ext_version){ext_version=1}if(ext_part){this.addHeader(ext_part,ext_version)}var lines=source.replace(/[\f\n\r\v]+/g,"\n").split("\n");for(var i in lines){this.processLine(lines[i],i)}return this.r};AGALMiniAssembler.prototype.processLine=function(line,linenr){var startcomment=line.search("//");if(startcomment!=-1){line=line.slice(0,startcomment)}line=line.replace(/^\s+|\s+$/g,"");if(!(line.length>0)){return}var optsi=line.search(/<.*>/g);var opts=null;if(optsi!=-1){opts=line.slice(optsi).match(/([\w\.\-\+]+)/gi);line=line.slice(0,optsi)}var tokens=line.match(/([\w\.\+\[\]]+)/gi);if(!tokens||tokens.length<1){if(line.length>=3){console.log("Warning: bad line "+linenr+": "+line)}return}switch(tokens[0]){case"part":this.addHeader(tokens[1],Number(tokens[2]));break;case"endpart":if(!this.cur){throw"Unexpected endpart"}this.cur.data.position=0;this.cur=null;return;default:if(!this.cur){console.log("Warning: bad line "+linenr+": "+line+" (Outside of any part definition)");return}if(this.cur.name=="comment"){return}var op=assembler.OpcodeMap.map[tokens[0]];if(!op){throw"Bad opcode "+tokens[0]+" "+linenr+": "+line}this.emitOpcode(this.cur,op.opcode);var ti=1;if(op.dest&&op.dest!="none"){if(!this.emitDest(this.cur,tokens[ti++],op.dest)){throw"Bad destination register "+tokens[ti-1]+" "+linenr+": "+line}}else{this.emitZeroDword(this.cur)}if(op.a&&op.a.format!="none"){if(!this.emitSource(this.cur,tokens[ti++],op.a)){throw"Bad source register "+tokens[ti-1]+" "+linenr+": "+line}}else{this.emitZeroQword(this.cur)}if(op.b&&op.b.format!="none"){if(op.b.format=="sampler"){if(!this.emitSampler(this.cur,tokens[ti++],op.b,opts)){throw"Bad sampler register "+tokens[ti-1]+" "+linenr+": "+line}}else{if(!this.emitSource(this.cur,tokens[ti++],op.b)){throw"Bad source register "+tokens[ti-1]+" "+linenr+": "+line}}}else{this.emitZeroQword(this.cur)}break}};AGALMiniAssembler.prototype.emitHeader=function(pr){pr.data.writeUnsignedByte(160);pr.data.writeUnsignedInt(pr.version);if(pr.version>=16){pr.data.writeUnsignedByte(0)}pr.data.writeUnsignedByte(161);switch(pr.name){case"fragment":pr.data.writeUnsignedByte(1);break;case"vertex":pr.data.writeUnsignedByte(0);break;case"cpu":pr.data.writeUnsignedByte(2);break;default:pr.data.writeUnsignedByte(255);break}};AGALMiniAssembler.prototype.emitOpcode=function(pr,opcode){pr.data.writeUnsignedInt(opcode)};AGALMiniAssembler.prototype.emitZeroDword=function(pr){pr.data.writeUnsignedInt(0)};AGALMiniAssembler.prototype.emitZeroQword=function(pr){pr.data.writeUnsignedInt(0);pr.data.writeUnsignedInt(0)};AGALMiniAssembler.prototype.emitDest=function(pr,token,opdest){var reg=token.match(/([fov]?[tpocidavs])(\d*)(\.[xyzw]{1,4})?/i);if(!assembler.RegMap.map[reg[1]]){return false}var em={num:reg[2]?reg[2]:0,code:assembler.RegMap.map[reg[1]].code,mask:this.stringToMask(reg[3])};pr.data.writeUnsignedShort(em.num);pr.data.writeUnsignedByte(em.mask);pr.data.writeUnsignedByte(em.code);return true};AGALMiniAssembler.prototype.stringToMask=function(s){if(!s){return 15}var r=0;if(s.indexOf("x")!=-1){r|=1}if(s.indexOf("y")!=-1){r|=2}if(s.indexOf("z")!=-1){r|=4}if(s.indexOf("w")!=-1){r|=8}return r};AGALMiniAssembler.prototype.stringToSwizzle=function(s){if(!s){return 228}var chartoindex={x:0,y:1,z:2,w:3};var sw=0;if(s.charAt(0)!="."){throw"Missing . for swizzle"}if(s.length>1){sw|=chartoindex[s.charAt(1)]}if(s.length>2){sw|=chartoindex[s.charAt(2)]<<2}else{sw|=(sw&3)<<2}if(s.length>3){sw|=chartoindex[s.charAt(3)]<<4}else{sw|=(sw&(3<<2))<<2}if(s.length>4){sw|=chartoindex[s.charAt(4)]<<6}else{sw|=(sw&(3<<4))<<2}return sw};AGALMiniAssembler.prototype.emitSampler=function(pr,token,opsrc,opts){var reg=token.match(/fs(\d*)/i);if(!reg||!reg[1]){return false}pr.data.writeUnsignedShort(reg[1]);pr.data.writeUnsignedByte(0);pr.data.writeUnsignedByte(0);var samplerbits=5;var sampleroptset=0;for(var i=0;i<opts.length;i++){var o=assembler.SamplerMap.map[opts[i].toLowerCase()];if(o){if(((sampleroptset>>o.shift)&o.mask)!=0){console.log("Warning, duplicate sampler option")}sampleroptset|=o.mask<<o.shift;samplerbits&=~(o.mask<<o.shift);samplerbits|=o.value<<o.shift}else{console.log("Warning, unknown sampler option: ",opts[i])}}pr.data.writeUnsignedInt(samplerbits);return true};AGALMiniAssembler.prototype.emitSource=function(pr,token,opsrc){var indexed=token.match(/vc\[(v[tcai])(\d+)\.([xyzw])([\+\-]\d+)?\](\.[xyzw]{1,4})?/i);var reg;if(indexed){if(!assembler.RegMap.map[indexed[1]]){return false}var selindex={x:0,y:1,z:2,w:3};var em={num:indexed[2]|0,code:assembler.RegMap.map[indexed[1]].code,swizzle:this.stringToSwizzle(indexed[5]),select:selindex[indexed[3]],offset:indexed[4]|0};pr.data.writeUnsignedShort(em.num);pr.data.writeByte(em.offset);pr.data.writeUnsignedByte(em.swizzle);pr.data.writeUnsignedByte(1);pr.data.writeUnsignedByte(em.code);pr.data.writeUnsignedByte(em.select);pr.data.writeUnsignedByte(1<<7)}else{reg=token.match(/([fov]?[tpocidavs])(\d*)(\.[xyzw]{1,4})?/i);if(!assembler.RegMap.map[reg[1]]){return false}var em={num:reg[2]|0,code:assembler.RegMap.map[reg[1]].code,swizzle:this.stringToSwizzle(reg[3])};pr.data.writeUnsignedShort(em.num);pr.data.writeUnsignedByte(0);pr.data.writeUnsignedByte(em.swizzle);pr.data.writeUnsignedByte(em.code);pr.data.writeUnsignedByte(0);pr.data.writeUnsignedByte(0);pr.data.writeUnsignedByte(0)}return true};AGALMiniAssembler.prototype.addHeader=function(partname,version){if(!version){version=1}if(this.r[partname]==undefined){this.r[partname]=new aglsl.assembler.Part(partname,version);this.emitHeader(this.r[partname])}else{if(this.r[partname].version!=version){throw"Multiple versions for part "+partname}}this.cur=this.r[partname]};return AGALMiniAssembler})();assembler.AGALMiniAssembler=AGALMiniAssembler})(aglsl.assembler||(aglsl.assembler={}));var assembler=aglsl.assembler})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var AGALTokenizer=(function(){function AGALTokenizer(){}AGALTokenizer.prototype.decribeAGALByteArray=function(bytes){var header=new aglsl.Header();if(bytes.readUnsignedByte()!=160){throw"Bad AGAL: Missing 0xa0 magic byte."}header.version=bytes.readUnsignedInt();if(header.version>=16){bytes.readUnsignedByte();header.version>>=1}if(bytes.readUnsignedByte()!=161){throw"Bad AGAL: Missing 0xa1 magic byte."}header.progid=bytes.readUnsignedByte();switch(header.progid){case 1:header.type="fragment";break;case 0:header.type="vertex";break;case 2:header.type="cpu";break;default:header.type="";break}var desc=new aglsl.Description();var tokens=[];while(bytes.position<bytes.length){var token=new aglsl.Token();token.opcode=bytes.readUnsignedInt();var lutentry=aglsl.Mapping.agal2glsllut[token.opcode];if(!lutentry){throw"Opcode not valid or not implemented yet: "+token.opcode}if(lutentry.matrixheight){desc.hasmatrix=true}if(lutentry.dest){token.dest.regnum=bytes.readUnsignedShort();token.dest.mask=bytes.readUnsignedByte();token.dest.regtype=bytes.readUnsignedByte();desc.regwrite[token.dest.regtype][token.dest.regnum]|=token.dest.mask}else{token.dest=null;bytes.readUnsignedInt()}if(lutentry.a){this.readReg(token.a,1,desc,bytes)}else{token.a=null;bytes.readUnsignedInt();bytes.readUnsignedInt()}if(lutentry.b){this.readReg(token.b,lutentry.matrixheight|0,desc,bytes)}else{token.b=null;bytes.readUnsignedInt();bytes.readUnsignedInt()}tokens.push(token)}desc.header=header;desc.tokens=tokens;return desc};AGALTokenizer.prototype.readReg=function(s,mh,desc,bytes){s.regnum=bytes.readUnsignedShort();s.indexoffset=bytes.readByte();s.swizzle=bytes.readUnsignedByte();s.regtype=bytes.readUnsignedByte();desc.regread[s.regtype][s.regnum]=15;if(s.regtype==5){s.lodbiad=s.indexoffset;s.indexoffset=undefined;s.swizzle=undefined;s.readmode=bytes.readUnsignedByte();s.dim=s.readmode>>4;s.readmode&=15;s.special=bytes.readUnsignedByte();s.wrap=s.special>>4;s.special&=15;s.mipmap=bytes.readUnsignedByte();s.filter=s.mipmap>>4;s.mipmap&=15;desc.samplers[s.regnum]=s}else{s.indexregtype=bytes.readUnsignedByte();s.indexselect=bytes.readUnsignedByte();s.indirectflag=bytes.readUnsignedByte()}if(s.indirectflag){desc.hasindirect=true}if(!s.indirectflag&&mh){for(var mhi=0;mhi<mh;mhi++){desc.regread[s.regtype][s.regnum+mhi]=desc.regread[s.regtype][s.regnum]}}};return AGALTokenizer})();aglsl.AGALTokenizer=AGALTokenizer})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var AGLSLParser=(function(){function AGLSLParser(){}AGLSLParser.prototype.parse=function(desc){var header="";var body="";header+="precision mediump float;\n";var tag=desc.header.type[0];if(desc.header.type=="vertex"){header+="uniform float yflip;\n"}if(!desc.hasindirect){for(var i=0;i<desc.regread[1].length;i++){if(desc.regread[1][i]){header+="uniform vec4 "+tag+"c"+i+";\n"}}}else{header+="uniform vec4 "+tag+"carrr["+aglsl.Context3D.maxvertexconstants+"];\n"}for(var i=0;i<desc.regread[2].length||i<desc.regwrite[2].length;i++){if(desc.regread[2][i]||desc.regwrite[2][i]){header+="vec4 "+tag+"t"+i+";\n"}}for(var i=0;i<desc.regread[0].length;i++){if(desc.regread[0][i]){header+="attribute vec4 va"+i+";\n"}}for(var i=0;i<desc.regread[4].length||i<desc.regwrite[4].length;i++){if(desc.regread[4][i]||desc.regwrite[4][i]){header+="varying vec4 vi"+i+";\n"}}var samptype=["2D","Cube","3D",""];for(var i=0;i<desc.samplers.length;i++){if(desc.samplers[i]){header+="uniform sampler"+samptype[desc.samplers[i].dim&3]+" fs"+i+";\n"}}if(desc.header.type=="vertex"){header+="vec4 outpos;\n"}if(desc.writedepth){header+="vec4 tmp_FragDepth;\n"}body+="void main() {\n";for(var i=0;i<desc.tokens.length;i++){var lutentry=aglsl.Mapping.agal2glsllut[desc.tokens[i].opcode];if(!lutentry){throw"Opcode not valid or not implemented yet: "}var sublines=lutentry.matrixheight||1;for(var sl=0;sl<sublines;sl++){var line="  "+lutentry.s;if(desc.tokens[i].dest){if(lutentry.matrixheight){if(((desc.tokens[i].dest.mask>>sl)&1)!=1){continue}var destregstring=this.regtostring(desc.tokens[i].dest.regtype,desc.tokens[i].dest.regnum,desc,tag);var destcaststring="float";var destmaskstring=["x","y","z","w"][sl];destregstring+="."+destmaskstring}else{var destregstring=this.regtostring(desc.tokens[i].dest.regtype,desc.tokens[i].dest.regnum,desc,tag);var destcaststring;var destmaskstring;if(desc.tokens[i].dest.mask!=15){var ndest=0;destmaskstring="";if(desc.tokens[i].dest.mask&1){ndest++;destmaskstring+="x"}if(desc.tokens[i].dest.mask&2){ndest++;destmaskstring+="y"}if(desc.tokens[i].dest.mask&4){ndest++;destmaskstring+="z"}if(desc.tokens[i].dest.mask&8){ndest++;destmaskstring+="w"}destregstring+="."+destmaskstring;switch(ndest){case 1:destcaststring="float";break;case 2:destcaststring="vec2";break;case 3:destcaststring="vec3";break;default:throw"Unexpected destination mask"}}else{destcaststring="vec4";destmaskstring="xyzw"}}line=line.replace("%dest",destregstring);line=line.replace("%cast",destcaststring);line=line.replace("%dm",destmaskstring)}var dwm=15;if(!lutentry.ndwm&&lutentry.dest&&desc.tokens[i].dest){dwm=desc.tokens[i].dest.mask}if(desc.tokens[i].a){line=line.replace("%a",this.sourcetostring(desc.tokens[i].a,0,dwm,lutentry.scalar,desc,tag))}if(desc.tokens[i].b){line=line.replace("%b",this.sourcetostring(desc.tokens[i].b,sl,dwm,lutentry.scalar,desc,tag));if(desc.tokens[i].b.regtype==5){var texdim=["2D","Cube","3D"][desc.tokens[i].b.dim];var texsize=["vec2","vec3","vec3"][desc.tokens[i].b.dim];line=line.replace("%texdim",texdim);line=line.replace("%texsize",texsize);var texlod="";line=line.replace("%lod",texlod)}}body+=line}}if(desc.header.type=="vertex"){body+="  gl_Position = vec4(outpos.x, yflip*outpos.y, outpos.z*2.0 - outpos.w, outpos.w);\n"}if(desc.writedepth){body+="  gl_FragDepth = clamp(tmp_FragDepth,0.0,1.0);\n"}body+="}\n";return header+body};AGLSLParser.prototype.regtostring=function(regtype,regnum,desc,tag){switch(regtype){case 0:return"va"+regnum;case 1:if(desc.hasindirect&&desc.header.type=="vertex"){return"vcarrr["+regnum+"]"}else{return tag+"c"+regnum}case 2:return tag+"t"+regnum;case 3:return desc.header.type=="vertex"?"outpos":"gl_FragColor";case 4:return"vi"+regnum;case 5:return"fs"+regnum;case 6:return"tmp_FragDepth";default:throw"Unknown register type"}};AGLSLParser.prototype.sourcetostring=function(s,subline,dwm,isscalar,desc,tag){var swiz=["x","y","z","w"];var r;if(s.indirectflag){r="vcarrr[int("+this.regtostring(s.indexregtype,s.regnum,desc,tag)+"."+swiz[s.indexselect]+")";var realofs=subline+s.indexoffset;if(realofs<0){r+=realofs.toString()}if(realofs>0){r+="+"+realofs.toString()}r+="]"}else{r=this.regtostring(s.regtype,s.regnum+subline,desc,tag)}if(s.regtype==5){return r}if(isscalar){return r+"."+swiz[(s.swizzle>>0)&3]}if(s.swizzle==228&&dwm==15){return r}r+=".";if(dwm&1){r+=swiz[(s.swizzle>>0)&3]}if(dwm&2){r+=swiz[(s.swizzle>>2)&3]}if(dwm&4){r+=swiz[(s.swizzle>>4)&3]}if(dwm&8){r+=swiz[(s.swizzle>>6)&3]}return r};return AGLSLParser})();aglsl.AGLSLParser=AGLSLParser})(aglsl||(aglsl={}));var aglsl;(function(aglsl){var AGLSLCompiler=(function(){function AGLSLCompiler(){}AGLSLCompiler.prototype.compile=function(programType,source){var agalMiniAssembler=new aglsl.assembler.AGALMiniAssembler();var tokenizer=new aglsl.AGALTokenizer();var data;var concatSource;switch(programType){case"vertex":concatSource="part vertex 1\n"+source+"endpart";agalMiniAssembler.assemble(concatSource);data=agalMiniAssembler.r.vertex.data;break;case"fragment":concatSource="part fragment 1\n"+source+"endpart";agalMiniAssembler.assemble(concatSource);data=agalMiniAssembler.r.fragment.data;break;default:throw"Unknown Context3DProgramType"}var description=tokenizer.decribeAGALByteArray(data);var parser=new aglsl.AGLSLParser();this.glsl=parser.parse(description);return this.glsl};return AGLSLCompiler})();aglsl.AGLSLCompiler=AGLSLCompiler})(aglsl||(aglsl={}));var demos;(function(demos){(function(cubes){var CubeDemo=(function(){function CubeDemo(){away.Debug.THROW_ERRORS=false;this._view=new away.containers.View3D();this._view.backgroundColor=0;this._view.camera.x=130;this._view.camera.y=0;this._view.camera.z=0;this._cameraAxis=new away.geom.Vector3D(0,0,1);this._view.camera.lens=new away.cameras.PerspectiveLens(120);this._cube=new away.primitives.CubeGeometry(20,20,20);this._torus=new away.primitives.TorusGeometry(150,80,32,16,true);this.loadResources()}CubeDemo.prototype.loadResources=function(){var urlRequest=new away.net.URLRequest("130909wall_big.png");var imgLoader=new away.net.IMGLoader();imgLoader.addEventListener(away.events.Event.COMPLETE,this.imageCompleteHandler,this);imgLoader.load(urlRequest)};CubeDemo.prototype.imageCompleteHandler=function(e){var imageLoader=e.target;this._image=imageLoader.image;var ts=new away.textures.HTMLImageElementTexture(this._image,false);var matTx=new away.materials.TextureMaterial(ts,true,true,false);matTx.blendMode=away.display.BlendMode.ADD;matTx.bothSides=true;this._mesh=new away.entities.Mesh(this._torus,matTx);this._mesh2=new away.entities.Mesh(this._cube,matTx);this._mesh2.x=130;this._mesh2.z=40;this._view.scene.addChild(this._mesh);this._view.scene.addChild(this._mesh2);this._raf=new away.utils.RequestAnimationFrame(this.render,this);this._raf.start();this.resize(null)};CubeDemo.prototype.render=function(dt){if(typeof dt==="undefined"){dt=null}this._view.camera.rotate(this._cameraAxis,1);this._mesh.rotationY+=1;this._mesh2.rotationX+=0.4;this._mesh2.rotationY+=0.4;this._view.render()};CubeDemo.prototype.resize=function(e){this._view.y=0;this._view.x=0;this._view.width=window.innerWidth;this._view.height=window.innerHeight;console.log(this._view.width,this._view.height);this._view.render()};return CubeDemo})();cubes.CubeDemo=CubeDemo})(demos.cubes||(demos.cubes={}));var cubes=demos.cubes})(demos||(demos={}));var test;window.onload=function(){test=new demos.cubes.CubeDemo()};window.onresize=function(e){if(test){test.resize(e)}};